# åŠ¨æ€ç«¯å£åˆ†é…ç³»ç»Ÿ

## æ¦‚è¿°

åŠ¨æ€ç«¯å£åˆ†é…ç³»ç»Ÿæ˜¯ axi-deploy é¡¹ç›®çš„ä¸€ä¸ªæ–°åŠŸèƒ½ï¼Œç”¨äºåœ¨æœåŠ¡å™¨ä¸Šè‡ªåŠ¨æ£€æŸ¥å’Œåˆ†é…å¯ç”¨ç«¯å£ï¼Œé¿å…ç«¯å£å†²çªé—®é¢˜ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½
- **è‡ªåŠ¨ç«¯å£æ£€æµ‹**: å®æ—¶æ£€æŸ¥ç«¯å£å ç”¨æƒ…å†µ
- **æ™ºèƒ½ç«¯å£åˆ†é…**: åœ¨æŒ‡å®šèŒƒå›´å†…è‡ªåŠ¨åˆ†é…å¯ç”¨ç«¯å£
- **ç«¯å£å†²çªé¿å…**: ç¡®ä¿æ¯ä¸ªé¡¹ç›®ä½¿ç”¨å”¯ä¸€ç«¯å£
- **é…ç½®æŒä¹…åŒ–**: å°†ç«¯å£åˆ†é…ä¿¡æ¯ä¿å­˜åˆ°æœåŠ¡å™¨é…ç½®æ–‡ä»¶

### ğŸ”§ ç®¡ç†åŠŸèƒ½
- **ç«¯å£çŠ¶æ€ç›‘æ§**: æŸ¥çœ‹æ‰€æœ‰ç«¯å£çš„ä½¿ç”¨æƒ…å†µ
- **æ‰‹åŠ¨ç«¯å£ç®¡ç†**: æ”¯æŒæ‰‹åŠ¨åˆ†é…å’Œé‡Šæ”¾ç«¯å£
- **é…ç½®æ¸…ç†**: è‡ªåŠ¨æ¸…ç†æ— æ•ˆçš„ç«¯å£åˆ†é…
- **é˜²ç«å¢™æ£€æŸ¥**: éªŒè¯ç«¯å£æ˜¯å¦åœ¨é˜²ç«å¢™ä¸­å¼€æ”¾

## ç³»ç»Ÿæ¶æ„

### å·¥ä½œæµé›†æˆ
```
main-deployment.yml
â”œâ”€â”€ dynamic-port-allocation.yml (æ–°å¢)
â”œâ”€â”€ deploy-project.yml
â”œâ”€â”€ configure-nginx.yml
â”œâ”€â”€ start-service.yml
â””â”€â”€ test-website.yml
```

### ç«¯å£åˆ†é…æµç¨‹
1. **éªŒè¯é˜¶æ®µ**: æ£€æŸ¥è¾“å…¥å‚æ•°å’ŒæœåŠ¡å™¨è¿æ¥
2. **ç«¯å£æ£€æµ‹**: æ‰«æç«¯å£èŒƒå›´ï¼Œæ£€æŸ¥å ç”¨æƒ…å†µ
3. **ç«¯å£åˆ†é…**: é€‰æ‹©æœ€å°å¯ç”¨ç«¯å£è¿›è¡Œåˆ†é…
4. **é…ç½®æ›´æ–°**: æ›´æ–°æœåŠ¡å™¨ä¸Šçš„ç«¯å£é…ç½®æ–‡ä»¶
5. **æœåŠ¡å¯åŠ¨**: ä½¿ç”¨åˆ†é…çš„ç«¯å£å¯åŠ¨æœåŠ¡

## é…ç½®æ–‡ä»¶

### æœåŠ¡å™¨ç«¯å£é…ç½®
ä½ç½®: `/srv/port-config.yml`

```yaml
# åŠ¨æ€ç«¯å£é…ç½®
# è‡ªåŠ¨ç”Ÿæˆå’Œç»´æŠ¤
# æœ€åæ›´æ–°: 2024-01-15 10:30:00

projects:
  axi-star-cloud:
    port: 8080
    description: "è‡ªåŠ¨åˆ†é… - 2024-01-15 10:30:00"
    allocated_at: "2024-01-15T10:30:00+08:00"
    
  axi-project-dashboard:
    port: 8090
    description: "è‡ªåŠ¨åˆ†é… - 2024-01-15 10:35:00"
    allocated_at: "2024-01-15T10:35:00+08:00"
```

## ä½¿ç”¨æ–¹æ³•

### 1. è‡ªåŠ¨éƒ¨ç½²ï¼ˆæ¨èï¼‰

åœ¨éƒ¨ç½²åç«¯é¡¹ç›®æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¿›è¡Œç«¯å£åˆ†é…ï¼š

```yaml
# åœ¨ main-deployment.yml ä¸­è‡ªåŠ¨è°ƒç”¨
dynamic-port-allocation:
  needs: [parse-secrets, validate-artifact, parse-deploy-config]
  if: ${{ inputs.deploy_type == 'backend' }}
  uses: ./.github/workflows/dynamic-port-allocation.yml
  with:
    project: ${{ inputs.project }}
    server_host: ${{ needs.parse-secrets.outputs.server_host }}
    # ... å…¶ä»–å‚æ•°
```

### 2. æ‰‹åŠ¨ç®¡ç†

ä½¿ç”¨ç«¯å£ç®¡ç†è„šæœ¬è¿›è¡Œæ‰‹åŠ¨æ“ä½œï¼š

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
sudo ./scripts/manage-ports.sh

# å¸¸ç”¨å‘½ä»¤
./scripts/manage-ports.sh list          # åˆ—å‡ºæ‰€æœ‰ç«¯å£
./scripts/manage-ports.sh allocate my-project  # åˆ†é…ç«¯å£
./scripts/manage-ports.sh release my-project   # é‡Šæ”¾ç«¯å£
./scripts/manage-ports.sh check 8080    # æ£€æŸ¥ç«¯å£
./scripts/manage-ports.sh status        # æ˜¾ç¤ºçŠ¶æ€
```

## ç«¯å£ç®¡ç†è„šæœ¬

### å®‰è£…
```bash
# å°†è„šæœ¬å¤åˆ¶åˆ°æœåŠ¡å™¨
scp axi-deploy/scripts/manage-ports.sh user@server:/tmp/
ssh user@server "sudo mv /tmp/manage-ports.sh /usr/local/bin/ && sudo chmod +x /usr/local/bin/manage-ports.sh"
```

### å‘½ä»¤è¯´æ˜

| å‘½ä»¤ | å‚æ•° | è¯´æ˜ |
|------|------|------|
| `list` | æ—  | åˆ—å‡ºæ‰€æœ‰å·²åˆ†é…çš„ç«¯å£ |
| `check` | `<port>` | æ£€æŸ¥æŒ‡å®šç«¯å£æ˜¯å¦å¯ç”¨ |
| `allocate` | `<project>` | ä¸ºé¡¹ç›®åˆ†é…ç«¯å£ |
| `release` | `<project>` | é‡Šæ”¾é¡¹ç›®ç«¯å£ |
| `find` | `<project>` | æŸ¥æ‰¾é¡¹ç›®å½“å‰ç«¯å£ |
| `status` | æ—  | æ˜¾ç¤ºç«¯å£ä½¿ç”¨çŠ¶æ€ |
| `cleanup` | æ—  | æ¸…ç†æ— æ•ˆçš„ç«¯å£åˆ†é… |
| `help` | æ—  | æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ |

### ä½¿ç”¨ç¤ºä¾‹

```bash
# æŸ¥çœ‹å½“å‰ç«¯å£åˆ†é…
manage-ports.sh list

# ä¸ºæ–°é¡¹ç›®åˆ†é…ç«¯å£
manage-ports.sh allocate my-new-project

# æ£€æŸ¥ç‰¹å®šç«¯å£
manage-ports.sh check 8080

# é‡Šæ”¾é¡¹ç›®ç«¯å£
manage-ports.sh release old-project

# æŸ¥çœ‹ç«¯å£çŠ¶æ€
manage-ports.sh status
```

## ç«¯å£åˆ†é…ç­–ç•¥

### åˆ†é…ä¼˜å…ˆçº§
1. **é¦–é€‰ç«¯å£**: å¦‚æœæŒ‡å®šäº†é¦–é€‰ç«¯å£ä¸”å¯ç”¨ï¼Œä¼˜å…ˆä½¿ç”¨
2. **æœ€å°å¯ç”¨ç«¯å£**: åœ¨ç«¯å£èŒƒå›´å†…é€‰æ‹©æœ€å°çš„å¯ç”¨ç«¯å£
3. **é»˜è®¤ç«¯å£**: å¦‚æœéƒ½ä¸å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤ç«¯å£ 8080

### ç«¯å£èŒƒå›´
- **èµ·å§‹ç«¯å£**: 8080
- **ç»“æŸç«¯å£**: 10000
- **å¯ç”¨ç«¯å£æ•°**: 9,921 ä¸ª

### å†²çªå¤„ç†
- è‡ªåŠ¨æ£€æµ‹ç«¯å£å ç”¨
- è·³è¿‡å·²è¢«å ç”¨çš„ç«¯å£
- è®°å½•åˆ†é…å†å²ï¼Œé¿å…é‡å¤åˆ†é…

## é›†æˆè¯´æ˜

### ä¸ç°æœ‰ç³»ç»Ÿçš„å…¼å®¹æ€§

1. **å‘åå…¼å®¹**: ä¿æŒä¸ç°æœ‰é™æ€ç«¯å£é…ç½®çš„å…¼å®¹æ€§
2. **ä¼˜å…ˆçº§æœºåˆ¶**: åŠ¨æ€åˆ†é…ç«¯å£ > é™æ€é…ç½®ç«¯å£ > é»˜è®¤ç«¯å£
3. **é…ç½®è¿ç§»**: æ”¯æŒä»é™æ€é…ç½®è¿ç§»åˆ°åŠ¨æ€é…ç½®

### å·¥ä½œæµä¿®æ”¹

#### main-deployment.yml
```yaml
# æ–°å¢åŠ¨æ€ç«¯å£åˆ†é…æ­¥éª¤
dynamic-port-allocation:
  needs: [parse-secrets, validate-artifact, parse-deploy-config]
  if: ${{ inputs.deploy_type == 'backend' }}
  uses: ./.github/workflows/dynamic-port-allocation.yml
  with:
    project: ${{ inputs.project }}
    # ... å…¶ä»–å‚æ•°

# ä¿®æ”¹åç»­æ­¥éª¤ä¾èµ–
deploy-project:
  needs: [parse-secrets, validate-artifact, parse-deploy-config, dynamic-port-allocation]
  # ...

start-service:
  needs: [parse-secrets, deploy-project, configure-nginx, parse-deploy-config, dynamic-port-allocation]
  # ...
```

#### start-service.yml
```yaml
# ä¿®æ”¹ç«¯å£è·å–é€»è¾‘
service_port: ${{ needs.dynamic-port-allocation.outputs.allocated_port || needs.parse-deploy-config.outputs.service_port || '' }}
```

## ç›‘æ§å’Œç»´æŠ¤

### æ—¥å¿—è®°å½•
- ç«¯å£åˆ†é…æ“ä½œè®°å½•åœ¨ GitHub Actions æ—¥å¿—ä¸­
- æœåŠ¡å™¨ç«¯æ“ä½œè®°å½•åœ¨ç³»ç»Ÿæ—¥å¿—ä¸­
- é…ç½®æ–‡ä»¶å˜æ›´è®°å½•åœ¨ `/srv/port-config.yml` ä¸­

### å®šæœŸç»´æŠ¤
```bash
# æ¸…ç†æ— æ•ˆç«¯å£åˆ†é…
manage-ports.sh cleanup

# æ£€æŸ¥ç«¯å£çŠ¶æ€
manage-ports.sh status

# å¤‡ä»½ç«¯å£é…ç½®
sudo cp /srv/port-config.yml /srv/port-config.yml.backup
```

### æ•…éšœæ’é™¤

#### å¸¸è§é—®é¢˜

1. **ç«¯å£åˆ†é…å¤±è´¥**
   ```bash
   # æ£€æŸ¥ç«¯å£èŒƒå›´
   manage-ports.sh status
   
   # æ¸…ç†æ— æ•ˆåˆ†é…
   manage-ports.sh cleanup
   ```

2. **é…ç½®æ–‡ä»¶æŸå**
   ```bash
   # æ¢å¤å¤‡ä»½
   sudo cp /srv/port-config.yml.backup /srv/port-config.yml
   
   # é‡æ–°åˆå§‹åŒ–
   sudo rm /srv/port-config.yml
   manage-ports.sh allocate project-name
   ```

3. **é˜²ç«å¢™é—®é¢˜**
   ```bash
   # æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€
   sudo firewall-cmd --list-ports
   
   # å¼€æ”¾ç«¯å£èŒƒå›´
   sudo firewall-cmd --permanent --add-port=8080-10000/tcp
   sudo firewall-cmd --reload
   ```

## æœ€ä½³å®è·µ

### 1. ç«¯å£ç®¡ç†
- å®šæœŸæ¸…ç†æ— æ•ˆçš„ç«¯å£åˆ†é…
- ç›‘æ§ç«¯å£ä½¿ç”¨æƒ…å†µ
- å¤‡ä»½ç«¯å£é…ç½®æ–‡ä»¶

### 2. éƒ¨ç½²ç­–ç•¥
- ä¼˜å…ˆä½¿ç”¨åŠ¨æ€ç«¯å£åˆ†é…
- ä¸ºé‡è¦é¡¹ç›®ä¿ç•™ç‰¹å®šç«¯å£
- è®°å½•ç«¯å£åˆ†é…å†å²

### 3. å®‰å…¨è€ƒè™‘
- å®šæœŸæ£€æŸ¥ç«¯å£å®‰å…¨æ€§
- é™åˆ¶ç«¯å£è®¿é—®æƒé™
- ç›‘æ§å¼‚å¸¸ç«¯å£ä½¿ç”¨

## æ›´æ–°æ—¥å¿—

### v1.0.0 (2024-01-15)
- âœ… å®ç°åŠ¨æ€ç«¯å£åˆ†é…åŠŸèƒ½
- âœ… é›†æˆåˆ°ä¸»éƒ¨ç½²å·¥ä½œæµ
- âœ… æ·»åŠ ç«¯å£ç®¡ç†è„šæœ¬
- âœ… æ”¯æŒç«¯å£å†²çªæ£€æµ‹
- âœ… å®ç°é…ç½®æŒä¹…åŒ–

### è®¡åˆ’åŠŸèƒ½
- ğŸ”„ ç«¯å£ä½¿ç”¨ç»Ÿè®¡å’Œåˆ†æ
- ğŸ”„ ç«¯å£åˆ†é…ç­–ç•¥ä¼˜åŒ–
- ğŸ”„ å¤šæœåŠ¡å™¨ç«¯å£åŒæ­¥
- ğŸ”„ ç«¯å£å¥åº·æ£€æŸ¥

## æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
1. [GitHub Actions æ—¥å¿—](https://github.com/MoseLu/axi-deploy/actions)
2. [æœåŠ¡å™¨ç«¯å£ç®¡ç†è„šæœ¬](./scripts/manage-ports.sh)
3. [å·¥ä½œæµé…ç½®æ–‡ä»¶](./.github/workflows/)

## ğŸ“Š å·¥ä½œæµç»Ÿè®¡

### æ–°å¢å·¥ä½œæµ
- **dynamic-port-allocation.yml**: åŠ¨æ€ç«¯å£åˆ†é…å·¥ä½œæµ
  - å¤§å°: çº¦ 8KB
  - åŠŸèƒ½: è‡ªåŠ¨ç«¯å£æ£€æµ‹å’Œåˆ†é…
  - é›†æˆ: ä¸»éƒ¨ç½²æµç¨‹

### æ›´æ–°å·¥ä½œæµ
- **main-deployment.yml**: é›†æˆåŠ¨æ€ç«¯å£åˆ†é…
- **start-service.yml**: æ”¯æŒåŠ¨æ€ç«¯å£é…ç½®

### æ–°å¢å·¥å…·
- **manage-ports.sh**: ç«¯å£ç®¡ç†è„šæœ¬
  - å¤§å°: çº¦ 15KB
  - åŠŸèƒ½: æ‰‹åŠ¨ç«¯å£ç®¡ç†
  - ä½ç½®: `scripts/manage-ports.sh`

### æ€»å·¥ä½œæµæ•°é‡
- **æ›´æ–°å‰**: 17ä¸ªå·¥ä½œæµ
- **æ›´æ–°å**: 18ä¸ªå·¥ä½œæµ (+1)
- **æ–°å¢åŠŸèƒ½**: åŠ¨æ€ç«¯å£åˆ†é…ç³»ç»Ÿ

---

*æœ€åæ›´æ–°: 2024-01-15*
