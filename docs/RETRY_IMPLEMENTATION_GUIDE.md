# axi-deploy é‡è¯•æœºåˆ¶å®æ–½æŒ‡å—

## ğŸ¯ å®æ–½æ¦‚è¿°

æœ¬æŒ‡å—è¯¦ç»†è¯´æ˜å¦‚ä½•åœ¨ç°æœ‰çš„ axi-deploy å·¥ä½œæµä¸­å®æ–½é‡è¯•æœºåˆ¶ï¼Œè§£å†³ timeout i/o é—®é¢˜ï¼Œæé«˜éƒ¨ç½²çš„ç¨³å®šæ€§å’ŒæˆåŠŸç‡ã€‚

## ğŸ“‹ å®æ–½æ¸…å•

### âœ… å·²å®Œæˆçš„å·¥ä½œ

1. **é—®é¢˜åˆ†æ** - è¯†åˆ«å¹¶åˆ†æäº†timeout i/oé—®é¢˜çš„æ ¹æœ¬åŸå› 
2. **è§£å†³æ–¹æ¡ˆè®¾è®¡** - è®¾è®¡äº†ç»¼åˆçš„é‡è¯•æœºåˆ¶æ¶æ„
3. **å¢å¼ºå·¥ä½œæµå®ç°** - åˆ›å»ºäº†å¸¦é‡è¯•æœºåˆ¶çš„å·¥ä½œæµæ¨¡æ¿
4. **ç›‘æ§ç³»ç»Ÿ** - å¼€å‘äº†å®Œæ•´çš„ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿ

### ğŸš€ å¾…å®æ–½çš„æ­¥éª¤

1. **éƒ¨ç½²å¢å¼ºå·¥ä½œæµ**
2. **é…ç½®é‡è¯•å‚æ•°**
3. **å¯ç”¨ç›‘æ§ç³»ç»Ÿ**
4. **æµ‹è¯•å’ŒéªŒè¯**

## ğŸ“‚ æ–‡ä»¶ç»“æ„

```
axi-deploy/
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ TIMEOUT_RETRY_ENHANCEMENT_GUIDE.md     # è¯¦ç»†å¢å¼ºæŒ‡å—
â”‚   â”œâ”€â”€ RETRY_IMPLEMENTATION_GUIDE.md          # æœ¬å®æ–½æŒ‡å—
â”‚   â””â”€â”€ UPLOAD_RETRY_FIX.md                    # ç°æœ‰ä¸Šä¼ é‡è¯•æ–‡æ¡£
â”œâ”€â”€ examples/
â”‚   â””â”€â”€ (å¢å¼ºå·¥ä½œæµæ¨¡æ¿å·²ç§»é™¤ï¼ŒåŠŸèƒ½å·²é›†æˆåˆ°ä¸»å·¥ä½œæµä¸­)
â””â”€â”€ .github/workflows/                          # å®é™…å·¥ä½œæµç›®å½•
    â”œâ”€â”€ main-deployment.yml                     # ä¸»éƒ¨ç½²å·¥ä½œæµ
    â”œâ”€â”€ validate-artifact.yml                   # éœ€è¦å¢å¼º
    â”œâ”€â”€ deploy-project.yml                      # éœ€è¦å¢å¼º
    â””â”€â”€ test-website.yml                        # éœ€è¦å¢å¼º
```

## ğŸ”§ å®æ–½æ­¥éª¤

### æ­¥éª¤1: å¤‡ä»½ç°æœ‰å·¥ä½œæµ

åœ¨å¼€å§‹ä¿®æ”¹ä¹‹å‰ï¼Œå¤‡ä»½ç°æœ‰çš„å·¥ä½œæµæ–‡ä»¶ï¼š

```bash
# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p .github/workflows/backup

# å¤‡ä»½ç°æœ‰å·¥ä½œæµ
cp .github/workflows/*.yml .github/workflows/backup/
```

### æ­¥éª¤2: æ·»åŠ é‡è¯•ä¾èµ–

åœ¨å·¥ä½œæµä¸­æ·»åŠ  `nick-fields/retry` action ä¾èµ–ã€‚è¿™æ˜¯æ¨èçš„é‡è¯•è§£å†³æ–¹æ¡ˆã€‚

### æ­¥éª¤3: é‡è¯•æœºåˆ¶å·²é›†æˆ

é‡è¯•æœºåˆ¶å·²ç»é›†æˆåˆ°ç°æœ‰çš„ä¸»å·¥ä½œæµä¸­ï¼Œæ— éœ€å•ç‹¬çš„å¢å¼ºå·¥ä½œæµã€‚

**å·²é›†æˆçš„å…³é”®æ”¹è¿›ï¼š**

1. **é‡è¯•æœºåˆ¶**: ä¸»å·¥ä½œæµä¸­å·²ä½¿ç”¨ `nick-fields/retry@v3` å®ç°è‡ªåŠ¨é‡è¯•
2. **è¶…æ—¶æ§åˆ¶**: å¯é…ç½®çš„è¶…æ—¶æ—¶é—´
3. **è¯¦ç»†æ—¥å¿—**: æ¯æ¬¡é‡è¯•éƒ½æœ‰è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
4. **é”™è¯¯å¤„ç†**: æ™ºèƒ½çš„é”™è¯¯åˆ†ç±»å’Œå¤„ç†
5. **éªŒè¯å¢å¼º**: æ›´å…¨é¢çš„æ„å»ºäº§ç‰©éªŒè¯

**ç°æœ‰å·¥ä½œæµæ”¹è¿›ï¼š**

- **validate-artifact.yml**: å·²é›†æˆé‡è¯•æœºåˆ¶
- **deploy-project.yml**: å·²é›†æˆä¸Šä¼ é‡è¯•ã€SSHé‡è¯•å’Œéƒ¨ç½²éªŒè¯
- **test-website.yml**: å·²é›†æˆç½‘ç«™æµ‹è¯•é‡è¯•å’Œè¯¦ç»†è¯Šæ–­
- **main-deployment.yml**: ç»Ÿä¸€åè°ƒæ‰€æœ‰é‡è¯•æœºåˆ¶

**ä¸»è¦åŠŸèƒ½ï¼š**

1. **ä¸Šä¼ é‡è¯•**: æ–‡ä»¶ä¸Šä¼ å¤±è´¥è‡ªåŠ¨é‡è¯•
2. **SSHé‡è¯•**: SSHè¿æ¥å’Œå‘½ä»¤æ‰§è¡Œé‡è¯•
3. **éƒ¨ç½²éªŒè¯**: éƒ¨ç½²å®Œæˆåçš„éªŒè¯æœºåˆ¶
4. **å¤±è´¥æ¢å¤**: éƒ¨ç½²å¤±è´¥æ—¶çš„è‡ªåŠ¨å›æ»š
5. **æƒé™ç®¡ç†**: æ­£ç¡®çš„æ–‡ä»¶æƒé™è®¾ç½®
6. **ç½‘ç«™æµ‹è¯•é‡è¯•**: HTTP/HTTPSè®¿é—®é‡è¯•
7. **æœåŠ¡å™¨æ£€æŸ¥**: åç«¯æœåŠ¡çŠ¶æ€æ£€æŸ¥
8. **æ€§èƒ½æµ‹è¯•**: å“åº”æ—¶é—´å’Œå¯ç”¨æ€§æµ‹è¯•
4. **å‘Šè­¦é€šçŸ¥**: è‡ªåŠ¨å‘é€å‘Šè­¦é€šçŸ¥
5. **æŠ¥å‘Šç”Ÿæˆ**: ç”Ÿæˆè¯¦ç»†çš„ç›‘æ§æŠ¥å‘Š

### æ­¥éª¤7: æ›´æ–°ä¸»éƒ¨ç½²å·¥ä½œæµ

åœ¨ `main-deployment.yml` ä¸­æ·»åŠ é‡è¯•ç›¸å…³çš„è¾“å…¥å‚æ•°ï¼š

```yaml
name: ä¸»éƒ¨ç½²å·¥ä½œæµ

on:
  workflow_call:
    inputs:
      # ... ç°æœ‰å‚æ•° ...
      
      # æ–°å¢é‡è¯•é…ç½®å‚æ•°
      retry_enabled:
        required: false
        type: boolean
        default: true
        description: 'æ˜¯å¦å¯ç”¨é‡è¯•æœºåˆ¶'
      
      max_retry_attempts:
        required: false
        type: number
        default: 5
        description: 'æœ€å¤§é‡è¯•æ¬¡æ•°'
      
      retry_timeout_minutes:
        required: false
        type: number
        default: 15
        description: 'é‡è¯•è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰'

jobs:
  validate:
    uses: ./.github/workflows/validate-artifact.yml
    with:
      project: ${{ inputs.project }}
      source_repo: ${{ inputs.source_repo }}
      run_id: ${{ inputs.run_id }}
      deploy_center_pat: ${{ inputs.deploy_center_pat }}
      retry_enabled: ${{ inputs.retry_enabled }}
      max_retry_attempts: ${{ inputs.max_retry_attempts }}
      retry_timeout_minutes: ${{ inputs.retry_timeout_minutes }}

  deploy:
    needs: validate
    if: ${{ needs.validate.outputs.artifact_available == 'true' }}
    uses: ./.github/workflows/deploy-project.yml
    with:
      # ... å‚æ•°ä¼ é€’ ...
      retry_enabled: ${{ inputs.retry_enabled }}
      max_retry_attempts: ${{ inputs.max_retry_attempts }}
      upload_timeout_minutes: ${{ inputs.retry_timeout_minutes }}

  test:
    needs: deploy
    if: ${{ inputs.test_url != '' && needs.deploy.outputs.deploy_success == 'true' }}
    uses: ./.github/workflows/test-website.yml
    with:
      # ... å‚æ•°ä¼ é€’ ...
      retry_enabled: ${{ inputs.retry_enabled }}
      max_retry_attempts: ${{ inputs.max_retry_attempts }}
      test_timeout_minutes: ${{ inputs.retry_timeout_minutes }}
```

## âš™ï¸ é…ç½®å‚æ•°

### é‡è¯•é…ç½®å‚æ•°è¯´æ˜

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `retry_enabled` | boolean | true | æ˜¯å¦å¯ç”¨é‡è¯•æœºåˆ¶ |
| `max_retry_attempts` | number | 5 | æœ€å¤§é‡è¯•æ¬¡æ•° |
| `retry_timeout_minutes` | number | 15 | å•æ¬¡æ“ä½œè¶…æ—¶æ—¶é—´ |
| `upload_timeout_minutes` | number | 20 | æ–‡ä»¶ä¸Šä¼ è¶…æ—¶æ—¶é—´ |
| `deploy_timeout_minutes` | number | 15 | éƒ¨ç½²æ“ä½œè¶…æ—¶æ—¶é—´ |
| `test_timeout_minutes` | number | 15 | ç½‘ç«™æµ‹è¯•è¶…æ—¶æ—¶é—´ |
| `startup_wait_seconds` | number | 60 | æœåŠ¡å¯åŠ¨ç­‰å¾…æ—¶é—´ |

### ç¯å¢ƒç‰¹å®šé…ç½®

#### ç”Ÿäº§ç¯å¢ƒé…ç½®
```yaml
# ç”Ÿäº§ç¯å¢ƒ - ä¿å®ˆç­–ç•¥
retry_enabled: true
max_retry_attempts: 3
retry_timeout_minutes: 10
upload_timeout_minutes: 15
```

#### æµ‹è¯•ç¯å¢ƒé…ç½®
```yaml
# æµ‹è¯•ç¯å¢ƒ - æ¿€è¿›ç­–ç•¥
retry_enabled: true
max_retry_attempts: 5
retry_timeout_minutes: 20
upload_timeout_minutes: 25
```

## ğŸ§ª æµ‹è¯•å’ŒéªŒè¯

### åŠŸèƒ½æµ‹è¯•

1. **é‡è¯•æœºåˆ¶æµ‹è¯•**
   ```bash
   # æ‰‹åŠ¨è§¦å‘éƒ¨ç½²ï¼Œè§‚å¯Ÿé‡è¯•è¡Œä¸º
   gh workflow run main-deployment.yml \
     -f project=test-project \
     -f retry_enabled=true \
     -f max_retry_attempts=3
   ```

2. **è¶…æ—¶æµ‹è¯•**
   ```bash
   # æµ‹è¯•è¶…æ—¶å¤„ç†
   gh workflow run main-deployment.yml \
     -f retry_timeout_minutes=2  # è®¾ç½®è¾ƒçŸ­è¶…æ—¶æ—¶é—´
   ```

3. **ç›‘æ§æµ‹è¯•**
   ```bash
   # è§¦å‘ç›‘æ§æ£€æŸ¥
   gh workflow run deployment-monitoring.yml \
     -f check_type=all \
     -f notification_enabled=true
   ```

### éªŒè¯æ¸…å•

- [ ] é‡è¯•æœºåˆ¶æ­£å¸¸å·¥ä½œ
- [ ] è¶…æ—¶é…ç½®ç”Ÿæ•ˆ
- [ ] é”™è¯¯æ—¥å¿—è¯¦ç»†æ¸…æ™°
- [ ] ç›‘æ§æ•°æ®æ­£ç¡®æ”¶é›†
- [ ] å‘Šè­¦é€šçŸ¥æ­£å¸¸å‘é€
- [ ] éƒ¨ç½²æˆåŠŸç‡æœ‰æå‡

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### ç›‘æ§æŒ‡æ ‡

1. **éƒ¨ç½²æˆåŠŸç‡**
   - ç›®æ ‡ï¼šâ‰¥95%
   - å‘Šè­¦é˜ˆå€¼ï¼š<80%

2. **å¹³å‡éƒ¨ç½²æ—¶é—´**
   - ç›®æ ‡ï¼šâ‰¤20åˆ†é’Ÿ
   - å‘Šè­¦é˜ˆå€¼ï¼š>30åˆ†é’Ÿ

3. **é‡è¯•æˆåŠŸç‡**
   - ç›®æ ‡ï¼šâ‰¥80%
   - ç›‘æ§é‡è¯•æ•ˆæœ

4. **é”™è¯¯ç±»å‹åˆ†æ**
   - ç½‘ç»œé”™è¯¯
   - è¶…æ—¶é”™è¯¯
   - é…ç½®é”™è¯¯

### å®šæœŸç»´æŠ¤

1. **æ¯å‘¨æ£€æŸ¥**
   - æŸ¥çœ‹ç›‘æ§æŠ¥å‘Š
   - åˆ†æéƒ¨ç½²è¶‹åŠ¿
   - ä¼˜åŒ–é‡è¯•å‚æ•°

2. **æ¯æœˆå›é¡¾**
   - è¯„ä¼°é‡è¯•æ•ˆæœ
   - æ›´æ–°é…ç½®å‚æ•°
   - æ”¹è¿›å·¥ä½œæµ

3. **å­£åº¦ä¼˜åŒ–**
   - åˆ†æé•¿æœŸè¶‹åŠ¿
   - å‡çº§ä¾èµ–ç‰ˆæœ¬
   - æ·»åŠ æ–°åŠŸèƒ½

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **é‡è¯•æ¬¡æ•°è¿‡å¤š**
   ```yaml
   # è§£å†³æ–¹æ¡ˆï¼šé™ä½é‡è¯•æ¬¡æ•°
   max_retry_attempts: 3
   ```

2. **è¶…æ—¶æ—¶é—´ä¸è¶³**
   ```yaml
   # è§£å†³æ–¹æ¡ˆï¼šå¢åŠ è¶…æ—¶æ—¶é—´
   retry_timeout_minutes: 20
   ```

3. **GitHub Tokenæƒé™ä¸è¶³**
   ```bash
   # æ£€æŸ¥tokenæƒé™
   gh auth status
   ```

4. **SSHè¿æ¥é—®é¢˜**
   ```yaml
   # å¢åŠ SSHé‡è¯•é…ç½®
   ssh_timeout: 30
   ssh_retry_attempts: 3
   ```

### è°ƒè¯•æ–¹æ³•

1. **æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**
   ```bash
   gh run view <run-id> --log
   ```

2. **æ£€æŸ¥é‡è¯•ç»Ÿè®¡**
   ```bash
   gh workflow run deployment-monitoring.yml -f check_type=retry_metrics
   ```

3. **æ‰‹åŠ¨æµ‹è¯•è¿æ¥**
   ```bash
   # æµ‹è¯•SSHè¿æ¥
   ssh -o ConnectTimeout=30 user@server "echo 'test'"
   
   # æµ‹è¯•ç½‘ç«™è®¿é—®
   curl -v --connect-timeout 30 --max-time 60 "https://example.com"
   ```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### ä¼˜åŒ–å»ºè®®

1. **ç½‘ç»œä¼˜åŒ–**
   - ä½¿ç”¨CDNåŠ é€Ÿ
   - é€‰æ‹©å°±è¿‘çš„æœåŠ¡å™¨
   - ä¼˜åŒ–ç½‘ç»œé…ç½®

2. **æ–‡ä»¶ä¼˜åŒ–**
   - å‹ç¼©æ„å»ºäº§ç‰©
   - åˆ é™¤ä¸å¿…è¦æ–‡ä»¶
   - ä½¿ç”¨å¢é‡éƒ¨ç½²

3. **å¹¶å‘ä¼˜åŒ–**
   - å¹¶è¡Œæ‰§è¡Œéä¾èµ–æ­¥éª¤
   - ä¼˜åŒ–å·¥ä½œæµé¡ºåº
   - å‡å°‘ç­‰å¾…æ—¶é—´

4. **ç¼“å­˜ä¼˜åŒ–**
   - ç¼“å­˜ä¾èµ–é¡¹
   - ç¼“å­˜æ„å»ºäº§ç‰©
   - åˆ©ç”¨GitHub Actionsç¼“å­˜

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [TIMEOUT_RETRY_ENHANCEMENT_GUIDE.md](./TIMEOUT_RETRY_ENHANCEMENT_GUIDE.md) - è¯¦ç»†çš„æŠ€æœ¯å®ç°æŒ‡å—
- [UPLOAD_RETRY_FIX.md](./UPLOAD_RETRY_FIX.md) - ç°æœ‰çš„ä¸Šä¼ é‡è¯•æœºåˆ¶
- [GitHub Actions Retry Documentation](https://github.com/nick-fields/retry) - é‡è¯•actionæ–‡æ¡£

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨å®æ–½è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–æ”¯æŒï¼š

1. **æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—** - è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œè°ƒè¯•æ•°æ®
2. **æ£€æŸ¥ç›‘æ§æŠ¥å‘Š** - è‡ªåŠ¨ç”Ÿæˆçš„ç›‘æ§åˆ†æ
3. **æäº¤GitHub Issue** - æè¿°å…·ä½“é—®é¢˜å’Œç¯å¢ƒä¿¡æ¯
4. **æŸ¥çœ‹ç›¸å…³æ–‡æ¡£** - å‚è€ƒæŠ€æœ¯æ–‡æ¡£å’Œæœ€ä½³å®è·µ

## ğŸ‰ æ€»ç»“

é€šè¿‡å®æ–½è¿™å¥—é‡è¯•æœºåˆ¶å¢å¼ºæ–¹æ¡ˆï¼Œaxi-deployå·¥ä½œæµå°†å…·å¤‡ï¼š

âœ… **å¼ºå¤§çš„å®¹é”™èƒ½åŠ›** - è‡ªåŠ¨å¤„ç†ç½‘ç»œé—®é¢˜å’Œä¸´æ—¶æ•…éšœ
âœ… **æ™ºèƒ½çš„é‡è¯•ç­–ç•¥** - æ ¹æ®ä¸åŒæ“ä½œç±»å‹ä¼˜åŒ–é‡è¯•å‚æ•°
âœ… **å®Œå–„çš„ç›‘æ§ä½“ç³»** - å®æ—¶ç›‘æ§éƒ¨ç½²çŠ¶æ€å’ŒæˆåŠŸç‡
âœ… **å¿«é€Ÿçš„æ•…éšœæ¢å¤** - è‡ªåŠ¨å›æ»šå’Œæ¢å¤æœºåˆ¶
âœ… **è¯¦ç»†çš„é”™è¯¯è¯Šæ–­** - ä¾¿äºé—®é¢˜å®šä½å’Œè§£å†³

é¢„æœŸæ•ˆæœï¼š
- **éƒ¨ç½²æˆåŠŸç‡æå‡**: ä»85%æå‡åˆ°95%+
- **æ•…éšœæ¢å¤æ—¶é—´å‡å°‘**: ä»20-30åˆ†é’Ÿé™ä½åˆ°5-10åˆ†é’Ÿ
- **è¿ç»´æ•ˆç‡æå‡**: 95%çš„ç½‘ç»œé—®é¢˜è‡ªåŠ¨æ¢å¤

è¿™å°†æ˜¾è‘—æ”¹å–„ axi-deploy çš„ç¨³å®šæ€§å’Œå¯é æ€§ï¼Œè§£å†³ timeout i/o é—®é¢˜ï¼Œä¸ºç”¨æˆ·æä¾›æ›´å¥½çš„éƒ¨ç½²ä½“éªŒã€‚
