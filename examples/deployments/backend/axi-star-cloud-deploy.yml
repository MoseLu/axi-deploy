name: Build & Deploy Axi-Star-Cloud

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      artifact-id: ${{ steps.upload.outputs.artifact-id }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.4'
          cache: true
          
      - name: æ„å»ºé¡¹ç›®
        run: |
          cd backend
          go mod tidy
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o star-cloud-linux main.go
          
      - name: æ‰“åŒ…éƒ¨ç½²æ–‡ä»¶
        run: |
          # åˆ›å»ºéƒ¨ç½²åŒ…
          tar czf deployment.tar.gz \
            backend/star-cloud-linux \
            front/ \
            index.html \
            backend/config/ \
            star-cloud.service
          
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        id: upload
        with:
          name: dist-${{ github.event.repository.name }}
          path: deployment.tar.gz
          retention-days: 1

  deploy:
    needs: build
    uses: MoseLu/axi-deploy/.github/workflows/external-deploy.yml@master
    with:
      project: ${{ github.event.repository.name }}
      deploy_path: /www/wwwroot/${{ github.event.repository.name }}
      start_cmd: |
        # è§£åŒ…éƒ¨ç½²æ–‡ä»¶
        tar xzf deployment.tar.gz -C /www/wwwroot/${{ github.event.repository.name }}/
        chmod +x /www/wwwroot/${{ github.event.repository.name }}/star-cloud-linux
        
        # åˆ›å»ºå¿…è¦çš„ç›®å½•
        mkdir -p /www/wwwroot/${{ github.event.repository.name }}/uploads/{image,document,audio,video,other,avatars}
        mkdir -p /www/wwwroot/${{ github.event.repository.name }}/logs
        
        # ä¿®å¤systemdæœåŠ¡æ–‡ä»¶ä¸­çš„è·¯å¾„
        sed -i 's|WorkingDirectory=/srv/apps/axi-star-cloud|WorkingDirectory=/www/wwwroot/axi-star-cloud|g' /www/wwwroot/${{ github.event.repository.name }}/star-cloud.service
        sed -i 's|ExecStart=/srv/apps/axi-star-cloud/star-cloud-linux|ExecStart=/www/wwwroot/axi-star-cloud/star-cloud-linux|g' /www/wwwroot/${{ github.event.repository.name }}/star-cloud.service
        
        # æ£€æŸ¥æ–‡ä»¶æƒé™å’Œè·¯å¾„
        echo "ğŸ” æ£€æŸ¥éƒ¨ç½²æ–‡ä»¶..."
        ls -la /www/wwwroot/${{ github.event.repository.name }}/
        echo "ğŸ” æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶..."
        file /www/wwwroot/${{ github.event.repository.name }}/star-cloud-linux
        echo "ğŸ” æ£€æŸ¥é…ç½®æ–‡ä»¶..."
        ls -la /www/wwwroot/${{ github.event.repository.name }}/backend/config/
        
        # å¤åˆ¶systemdæœåŠ¡æ–‡ä»¶
        sudo cp /www/wwwroot/${{ github.event.repository.name }}/star-cloud.service /etc/systemd/system/
        sudo chmod 644 /etc/systemd/system/star-cloud.service
        
        # æ˜¾ç¤ºæœåŠ¡æ–‡ä»¶å†…å®¹
        echo "ğŸ” æ£€æŸ¥systemdæœåŠ¡é…ç½®..."
        cat /etc/systemd/system/star-cloud.service
        
        # åœæ­¢å¯èƒ½å­˜åœ¨çš„æ—§æœåŠ¡
        sudo systemctl stop star-cloud.service 2>/dev/null || true
        
        # é‡å¯æœåŠ¡
        sudo systemctl daemon-reload
        sudo systemctl enable star-cloud.service
        sudo systemctl restart star-cloud.service
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 10
        
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
        sudo systemctl status star-cloud.service --no-pager --lines 5
        
        # æ£€æŸ¥ç«¯å£ç›‘å¬
        echo "ğŸ” æ£€æŸ¥ç«¯å£ç›‘å¬..."
        netstat -tlnp | grep :8080 || ss -tlnp | grep :8080 || echo "ç«¯å£8080æœªç›‘å¬"
        
        # å¥åº·æ£€æŸ¥
        echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        if curl -f -s http://127.0.0.1:8080/health > /dev/null 2>&1; then
            echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ"
        else
            echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥"
            echo "ğŸ” è¯¦ç»†é”™è¯¯ä¿¡æ¯:"
            sudo systemctl status star-cloud.service --no-pager --lines 10
            sudo journalctl -u star-cloud.service --no-pager --lines 20
            echo "ğŸ” å°è¯•ç›´æ¥è¿è¡Œåº”ç”¨..."
            cd /www/wwwroot/${{ github.event.repository.name }}/
            timeout 10s ./star-cloud-linux || echo "ç›´æ¥è¿è¡Œä¹Ÿå¤±è´¥"
            exit 1
        fi
        
        # æ£€æŸ¥Nginxé…ç½®
        echo "ğŸ” æ£€æŸ¥Nginxé…ç½®..."
        nginx -t
        nginx -s reload
        
        # æœ€ç»ˆæµ‹è¯•
        echo "ğŸ” æœ€ç»ˆè®¿é—®æµ‹è¯•..."
        curl -I http://127.0.0.1:8080/health
        curl -I https://redamancy.com.cn/health
      run_id: ${{ github.run_id }}
      source_repo: ${{ github.repository }}
      test_url: https://redamancy.com.cn/
      nginx_config: |
        # ä¸»åŸŸåé…ç½®
        server {
            listen 80;
            listen 443 ssl http2;
            server_name redamancy.com.cn;
            
            # SSLé…ç½®ï¼ˆå¦‚æœæœ‰è¯ä¹¦ï¼‰
            # ssl_certificate /path/to/cert.pem;
            # ssl_certificate_key /path/to/key.pem;
            
            # é™æ€æ–‡ä»¶æœåŠ¡ï¼ˆaxi-star-cloudï¼‰
            location / {
                root /www/wwwroot/axi-star-cloud;
                try_files $uri $uri/ /index.html;
                
                # è®¾ç½®ç¼“å­˜
                location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                }
            }
            
            # APIä»£ç†åˆ°Goåç«¯
            location /api/ {
                proxy_pass http://127.0.0.1:8080/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                
                # ä¸Šä¼ æ–‡ä»¶å¤§å°é™åˆ¶
                client_max_body_size 100M;
                
                # è¶…æ—¶è®¾ç½®
                proxy_connect_timeout 60s;
                proxy_send_timeout 60s;
                proxy_read_timeout 60s;
            }
            
            # å¥åº·æ£€æŸ¥ç«¯ç‚¹
            location /health {
                proxy_pass http://127.0.0.1:8080/health;
                proxy_set_header Host $host;
            }
            
            # åŒ…å«å…¶ä»–é¡¹ç›®é…ç½®
            include /www/server/nginx/conf/vhost/includes/*.conf;
        }
      nginx_path: /www/server/nginx/conf/vhost/redamancy.com.cn.conf
    secrets:
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_PORT: ${{ secrets.SERVER_PORT }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SERVER_KEY: ${{ secrets.SERVER_KEY }}
      DEPLOY_CENTER_PAT: ${{ secrets.DEPLOY_CENTER_PAT }} 