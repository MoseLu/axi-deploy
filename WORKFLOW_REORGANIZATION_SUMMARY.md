# 工作流重组总结

## 重组目标

将原有的多工作流同时触发模式改为自动化分步骤触发模式，每次部署都会自动触发初始化工作流，提高部署的可控性和安全性。

## 变更内容

### 删除的工作流
- `axi-star-cloud_deploy.yml` - 特定项目工作流
- `axi-docs_deploy.yml` - 特定项目工作流

### 新增的工作流
- `server_init.yml` - 服务器初始化工作流（支持自动触发）
- `universal_deploy.yml` - 通用部署工作流（自动包含初始化）

### 保留的工作流
- `central_deploy_handler.yml` - 中央部署处理器
- `central_external_deploy.yml` - 外部部署处理器
- `repository_dispatch_handler.yml` - 仓库分发处理器（已更新）

## 新的自动化部署流程

### 步骤1: 自动服务器初始化
- 每次部署前自动执行
- 检查并修复服务器环境
- 验证Nginx配置和证书状态
- 确保目录结构和权限正确

### 步骤2: 项目部署
- 下载构建产物
- 上传到服务器
- 根据项目类型执行部署
- 配置Nginx路由（如果提供）
- 执行启动命令（后端项目）
- 测试网站可访问性

## 初始化工作流的触发方式

### 1. 自动触发
- 每次部署前自动调用
- 确保环境状态一致
- 无需手动干预

### 2. 手动触发
- **灾后自愈**: 检测并修复缺失的目录、配置文件
- **配置变更管理**: 支持声明式配置更新
- **强制重建**: 设置 `force_rebuild: true` 重新生成配置

### 3. 定时触发
- 每周一凌晨2点自动健康巡检
- 检查证书软链、Nginx配置、防火墙状态
- 发现问题时CI会标红提醒

## 优势

### 1. 自动化
- 每次部署自动初始化，无需手动干预
- 减少人为错误，提高部署成功率
- 确保环境状态一致性

### 2. 可控性
- 分步骤执行，可以独立控制每个环节
- 出现问题可以精确定位到具体步骤
- 支持手动干预和调试

### 3. 安全性
- 初始化步骤自动执行，减少误操作风险
- 部署步骤可以重复执行，支持回滚
- 参数验证更严格

### 4. 通用性
- 支持任意项目的部署
- 统一的部署流程和配置
- 减少重复代码

### 5. 可维护性
- 工作流结构更清晰
- 代码复用性更高
- 文档更完善

### 6. 灾后自愈能力
- 自动检测并修复缺失的目录和配置文件
- 定期健康巡检，及时发现问题
- 支持配置变更的声明式管理

## 使用指南

### 首次部署
1. 运行 `universal_deploy.yml` 部署项目
2. 系统会自动执行初始化，然后部署项目

### 更新部署
1. 直接运行 `universal_deploy.yml` 部署项目
2. 指定新的构建运行ID
3. 系统会自动检查并修复环境，然后部署

### 灾后自愈
1. 如果服务器环境出现问题（目录被删、配置丢失等）
2. 手动触发 `server_init.yml` 工作流
3. 系统会自动检测并修复缺失的部分

### 配置变更管理
1. 修改环境常量（如 client_max_body_size）
2. 手动触发 `server_init.yml` 工作流，设置 `force_rebuild: true`
3. 系统会重新生成配置文件

### 环境重置
1. 运行 `server_init.yml` 重新初始化服务器
2. 按需部署项目

## 参数说明

### 服务器初始化参数
- `domain`: 域名 (默认: redamancy.com.cn)
- `run_user`: 运行用户 (默认: deploy)
- `apps_root`: 二进制根目录 (默认: /srv/apps)
- `static_root`: 静态文件根目录 (默认: /srv/static)
- `nginx_conf_dir`: Nginx片段目录
- `cert_src`: 证书源目录
- `cert_dst`: 证书使用目录
- `force_rebuild`: 强制重建配置 (默认: false)

### 通用部署参数
- `project`: 项目名称 (必需)
- `source_repo`: 源仓库 (必需)
- `run_id`: 构建运行ID (必需)
- `deploy_type`: 部署类型 (static/backend)
- `nginx_config`: Nginx配置 (可选)
- `test_url`: 测试URL (可选)
- `start_cmd`: 启动命令 (可选)
- `skip_init`: 跳过服务器初始化 (默认: false)

## 注意事项

1. **自动化部署**: 每次部署都会自动初始化，无需手动干预
2. **参数验证**: 确保所有必需参数正确填写
3. **构建产物**: 确保源项目已成功构建
4. **权限检查**: 确保服务器密钥和权限配置正确
5. **日志监控**: 关注工作流执行日志
6. **健康巡检**: 定期检查自动健康巡检结果

## 后续优化

1. 添加自动化测试
2. 增加部署回滚功能
3. 优化错误处理和通知机制
4. 添加部署状态监控
5. 支持批量部署功能
6. 增强健康巡检功能
7. 添加更多灾后自愈场景 