name: Test Start Service Retry Mechanism

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æµ‹è¯•ç±»å‹'
        required: true
        default: 'success'
        type: choice
        options:
          - success
          - directory_not_found
          - ssh_timeout
          - service_failure

jobs:
  test-start-service-retry:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: æµ‹è¯•å¯åŠ¨æœåŠ¡é‡è¯•æœºåˆ¶
        uses: ./.github/workflows/retry-center.yml
        with:
          step_name: "æµ‹è¯•å¯åŠ¨æœåŠ¡"
          command: |
            echo "ğŸ§ª æµ‹è¯•å¯åŠ¨æœåŠ¡é‡è¯•æœºåˆ¶..."
            echo "æµ‹è¯•ç±»å‹: ${{ github.event.inputs.test_type }}"
            
            # æ¨¡æ‹Ÿä¸åŒçš„æµ‹è¯•åœºæ™¯
            if [ "${{ github.event.inputs.test_type }}" = "directory_not_found" ]; then
              echo "ğŸ“ æ¨¡æ‹Ÿç›®å½•ä¸å­˜åœ¨åœºæ™¯..."
              cd /nonexistent/directory
              echo "âŒ ç›®å½•ä¸å­˜åœ¨æµ‹è¯•å®Œæˆ"
            elif [ "${{ github.event.inputs.test_type }}" = "ssh_timeout" ]; then
              echo "â° æ¨¡æ‹ŸSSHè¶…æ—¶åœºæ™¯..."
              # å°è¯•è¿æ¥ä¸€ä¸ªä¸å­˜åœ¨çš„æœåŠ¡å™¨
              ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no user@invalid-host.com "echo test" || true
              echo "âŒ SSHè¶…æ—¶æµ‹è¯•å®Œæˆ"
            elif [ "${{ github.event.inputs.test_type }}" = "service_failure" ]; then
              echo "ğŸ”Œ æ¨¡æ‹ŸæœåŠ¡å¯åŠ¨å¤±è´¥åœºæ™¯..."
              # å°è¯•æ‰§è¡Œä¸€ä¸ªä¸å­˜åœ¨çš„å‘½ä»¤
              nonexistent_command || true
              echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥æµ‹è¯•å®Œæˆ"
            else
              echo "âœ… æ¨¡æ‹ŸæˆåŠŸåœºæ™¯..."
              echo "å¯åŠ¨æœåŠ¡æµ‹è¯•æˆåŠŸ"
            fi
          max_retries: 3
          retry_delay: 5
          timeout_minutes: 10
          retry_strategy: "exponential"
          continue_on_error: true
          notify_on_failure: false
          step_type: "network"
          
      - name: æ˜¾ç¤ºæµ‹è¯•ç»“æœ
        run: |
          echo "ğŸ§ª å¯åŠ¨æœåŠ¡é‡è¯•æœºåˆ¶æµ‹è¯•å®Œæˆ"
          echo "æµ‹è¯•ç±»å‹: ${{ github.event.inputs.test_type }}"
          echo "æˆåŠŸçŠ¶æ€: ${{ needs.test-start-service-retry.outputs.success }}"
          echo "é‡è¯•æ¬¡æ•°: ${{ needs.test-start-service-retry.outputs.attempts }}"
          echo "æ‰§è¡Œæ—¶é—´: ${{ needs.test-start-service-retry.outputs.execution_time }}ç§’"
          if [ "${{ needs.test-start-service-retry.outputs.success }}" = "false" ]; then
            echo "é”™è¯¯ä¿¡æ¯: ${{ needs.test-start-service-retry.outputs.error_message }}"
          fi
