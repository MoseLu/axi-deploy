name: Main Deployment

description: "主部署工作流 - 整个部署流程的入口点"

on:
  workflow_dispatch:
    inputs:
      project:
        description: '项目名称'
        required: true
        type: string
      source_repo:
        description: '源仓库 (格式: owner/repo)'
        required: true
        type: string
      run_id:
        description: '构建运行ID'
        required: true
        type: string
      deploy_type:
        description: '部署类型'
        required: true
        default: 'static'
        type: choice
        options:
          - static
          - backend
      nginx_config:
        description: 'Nginx配置（可选）'
        required: false
        type: string
      test_url:
        description: '测试URL（可选）'
        required: false
        type: string
      start_cmd:
        description: '启动命令（后端项目）'
        required: false
        type: string

jobs:
  deployment-orchestrator:
    uses: ./.github/workflows/deployment-orchestrator.yml
    with:
      project: ${{ inputs.project }}
      source_repo: ${{ inputs.source_repo }}
      run_id: ${{ inputs.run_id }}
      deploy_type: ${{ inputs.deploy_type }}
      nginx_config: ${{ inputs.nginx_config }}
      test_url: ${{ inputs.test_url }}
      start_cmd: ${{ inputs.start_cmd }}
      # 固定服务器环境参数
      domain: 'redamancy.com.cn'
      apps_root: '/srv/apps'
      static_root: '/srv/static'
      backup_root: '/srv/backups'
      run_user: 'deploy'
      nginx_conf_dir: '/www/server/nginx/conf/conf.d/redamancy'
      backend_port: '8080'
      service_name: 'star-cloud'
