name: Main Deployment

description: "ä¸»éƒ¨ç½²å·¥ä½œæµ - æ•´ä¸ªéƒ¨ç½²æµç¨‹çš„å…¥å£ç‚¹"

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'é¡¹ç›®åç§°'
        required: true
        type: string
      source_repo:
        description: 'æºä»“åº“ (æ ¼å¼: owner/repo)'
        required: true
        type: string
      run_id:
        description: 'æ„å»ºè¿è¡ŒID'
        required: true
        type: string
      deploy_type:
        description: 'éƒ¨ç½²ç±»å‹'
        required: true
        default: 'static'
        type: choice
        options:
          - static
          - backend
      nginx_config:
        description: 'Nginxé…ç½®ï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      start_cmd:
        description: 'å¯åŠ¨å‘½ä»¤ï¼ˆåç«¯é¡¹ç›®ï¼‰'
        required: false
        type: string
      server_host:
        description: 'æœåŠ¡å™¨åœ°å€'
        required: true
        type: string
      server_user:
        description: 'æœåŠ¡å™¨ç”¨æˆ·'
        required: true
        type: string
      server_key:
        description: 'æœåŠ¡å™¨å¯†é’¥'
        required: true
        type: string
      server_port:
        description: 'æœåŠ¡å™¨ç«¯å£'
        required: true
        type: string

jobs:
  download-artifact:
    runs-on: ubuntu-latest
    outputs:
      artifact_path: ${{ steps.set-outputs.outputs.artifact_path }}
      artifact_size: ${{ steps.set-outputs.outputs.artifact_size }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        id: download
        uses: dawidd6/action-download-artifact@v2
        with:
          name: dist-${{ inputs.project }}
          path: ./dist
          repo: ${{ inputs.source_repo }}
          workflow: ${{ inputs.project }}_deploy.yml
          run_id: ${{ inputs.run_id }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: éªŒè¯æ„å»ºäº§ç‰©
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºäº§ç‰©..."
          
          if [ ! -d "./dist" ]; then
            echo "âŒ æ„å»ºäº§ç‰©ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "ğŸ“ æ„å»ºäº§ç‰©ç›®å½•å†…å®¹:"
          ls -la ./dist/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
          FILE_COUNT=$(find ./dist -type f | wc -l)
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "âŒ æ„å»ºäº§ç‰©ç›®å½•ä¸ºç©º"
            exit 1
          fi
          
          echo "âœ… æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡"
          echo "ğŸ“Š æ–‡ä»¶æ•°é‡: $FILE_COUNT"

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          echo "artifact_path=./dist" >> $GITHUB_OUTPUT
          echo "artifact_size=$(du -sb ./dist | cut -f1)" >> $GITHUB_OUTPUT
          echo "âœ… è¾“å‡ºå·²è®¾ç½®"

  upload-files:
    needs: download-artifact
    runs-on: ubuntu-latest
    outputs:
      upload_success: ${{ steps.set-outputs.outputs.upload_success }}
      temp_dir: ${{ steps.set-outputs.outputs.temp_dir }}
    
    steps:
      - name: åˆ›å»ºä¸´æ—¶ç›®å½•å¹¶ä¸Šä¼ æ–‡ä»¶
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ğŸ“¤ ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨..."
            
            PROJECT="${{ inputs.project }}"
            RUN_USER="deploy"
            
            # åˆ›å»ºä¸´æ—¶ç›®å½•
            TEMP_DIR="/tmp/deploy-$PROJECT"
            echo "ğŸ“ åˆ›å»ºä¸´æ—¶ç›®å½•: $TEMP_DIR"
            sudo mkdir -p "$TEMP_DIR"
            sudo chown $RUN_USER:$RUN_USER "$TEMP_DIR"
            
            echo "âœ… ä¸´æ—¶ç›®å½•å·²åˆ›å»º: $TEMP_DIR"
            echo "temp_dir=$TEMP_DIR" >> $GITHUB_ENV

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          source: "${{ needs.download-artifact.outputs.artifact_path }}/*"
          target: "/tmp/deploy-${{ inputs.project }}/"

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          echo "upload_success=true" >> $GITHUB_OUTPUT
          echo "temp_dir=/tmp/deploy-${{ inputs.project }}" >> $GITHUB_OUTPUT
          echo "âœ… ä¸Šä¼ å®Œæˆ"

  deploy-project:
    needs: upload-files
    runs-on: ubuntu-latest
    outputs:
      deploy_success: ${{ steps.set-outputs.outputs.deploy_success }}
      deploy_path: ${{ steps.set-outputs.outputs.deploy_path }}
    
    steps:
      - name: éƒ¨ç½²é¡¹ç›®
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ğŸš€ éƒ¨ç½²é¡¹ç›®..."
            
            PROJECT="${{ inputs.project }}"
            DEPLOY_TYPE="${{ inputs.deploy_type }}"
            RUN_USER="deploy"
            APPS_ROOT="/srv/apps"
            STATIC_ROOT="/srv/static"
            BACKUP_ROOT="/srv/backups"
            TEMP_DIR="${{ needs.upload-files.outputs.temp_dir }}"
            
            # ç¡®å®šéƒ¨ç½²è·¯å¾„
            if [ "$DEPLOY_TYPE" = "backend" ]; then
              DEPLOY_PATH="$APPS_ROOT/$PROJECT"
            else
              DEPLOY_PATH="$STATIC_ROOT/$PROJECT"
            fi
            
            echo "ğŸ“ éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"
            
            # å¤‡ä»½ç°æœ‰éƒ¨ç½²
            if [ -d "$DEPLOY_PATH" ]; then
              echo "ğŸ“‹ å¤‡ä»½ç°æœ‰éƒ¨ç½²..."
              BACKUP_PATH="$BACKUP_ROOT/$PROJECT/backup-$(date +%Y%m%d_%H%M%S)"
              sudo mkdir -p "$BACKUP_PATH"
              sudo cp -r "$DEPLOY_PATH" "$BACKUP_PATH/"
              echo "âœ… å¤‡ä»½å®Œæˆ: $BACKUP_PATH"
            fi
            
            # éƒ¨ç½²æ–°æ–‡ä»¶
            echo "ğŸ“¦ éƒ¨ç½²æ–°æ–‡ä»¶..."
            sudo mkdir -p "$(dirname $DEPLOY_PATH)"
            sudo rm -rf "$DEPLOY_PATH"
            sudo mv "$TEMP_DIR" "$DEPLOY_PATH"
            sudo chown -R $RUN_USER:$RUN_USER "$DEPLOY_PATH"
            
            echo "âœ… éƒ¨ç½²å®Œæˆ"
            echo "deploy_path=$DEPLOY_PATH" >> $GITHUB_ENV

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          echo "deploy_success=true" >> $GITHUB_OUTPUT
          echo "deploy_path=${{ env.deploy_path }}" >> $GITHUB_OUTPUT
          echo "âœ… éƒ¨ç½²å®Œæˆ"

  configure-nginx:
    needs: deploy-project
    if: ${{ inputs.nginx_config != '' }}
    runs-on: ubuntu-latest
    outputs:
      config_success: ${{ steps.set-outputs.outputs.config_success }}
    
    steps:
      - name: é…ç½®Nginx
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ğŸ”§ é…ç½®Nginx..."
            
            PROJECT="${{ inputs.project }}"
            NGINX_CONFIG='${{ inputs.nginx_config }}'
            NGINX_CONF_DIR="/www/server/nginx/conf/conf.d/redamancy"
            BACKEND_PORT="8080"
            SERVICE_NAME="star-cloud"
            
            # ç”Ÿæˆé¡¹ç›®è·¯ç”±é…ç½®
            ROUTE_CONF="$NGINX_CONF_DIR/route-$PROJECT.conf"
            
            # å¤‡ä»½æ—§é…ç½®
            if [ -f "$ROUTE_CONF" ]; then
              BACKUP_FILE="$NGINX_CONF_DIR/backups/route-$PROJECT.conf.backup.$(date +%Y%m%d_%H%M%S)"
              sudo mkdir -p "$(dirname $BACKUP_FILE)"
              sudo cp "$ROUTE_CONF" "$BACKUP_FILE"
              sudo rm -f "$ROUTE_CONF"
            fi
            
            # å†™å…¥æ–°é…ç½®
            echo "$NGINX_CONFIG" | sudo tee "$ROUTE_CONF"
            
            # æ£€æŸ¥é…ç½®è¯­æ³•
            if sudo nginx -t; then
              sudo systemctl reload nginx
              echo "âœ… Nginxé…ç½®å®Œæˆ"
            else
              echo "âŒ Nginxé…ç½®è¯­æ³•é”™è¯¯"
              exit 1
            fi

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          echo "config_success=true" >> $GITHUB_OUTPUT
          echo "âœ… é…ç½®å®Œæˆ"

  start-service:
    needs: [deploy-project, configure-nginx]
    if: ${{ inputs.start_cmd != '' && inputs.deploy_type == 'backend' }}
    runs-on: ubuntu-latest
    outputs:
      start_success: ${{ steps.set-outputs.outputs.start_success }}
    
    steps:
      - name: å¯åŠ¨æœåŠ¡
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
            
            PROJECT="${{ inputs.project }}"
            START_CMD="${{ inputs.start_cmd }}"
            APPS_ROOT="/srv/apps"
            
            # åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
            cd "$APPS_ROOT/$PROJECT"
            
            # æ‰§è¡Œå¯åŠ¨å‘½ä»¤
            echo "ğŸ“‹ æ‰§è¡Œå¯åŠ¨å‘½ä»¤: $START_CMD"
            $START_CMD
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 5
            
            echo "âœ… æœåŠ¡å¯åŠ¨å®Œæˆ"

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          echo "start_success=true" >> $GITHUB_OUTPUT
          echo "âœ… å¯åŠ¨å®Œæˆ"



  deployment-summary:
    needs: [download-artifact, upload-files, deploy-project, configure-nginx, start-service]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: éƒ¨ç½²å®Œæˆæ€»ç»“
        run: |
          echo "ğŸ‰ éƒ¨ç½²æµç¨‹å®Œæˆ"
          echo "=========================================="
          echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯:"
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- éƒ¨ç½²ç±»å‹: ${{ inputs.deploy_type }}"
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- æ„å»ºID: ${{ inputs.run_id }}"
          echo ""
          echo "ğŸ“Š æ‰§è¡ŒçŠ¶æ€:"
          echo "- ä¸‹è½½æ„å»ºäº§ç‰©: ${{ needs.download-artifact.result }}"
          echo "- ä¸Šä¼ æ–‡ä»¶: ${{ needs.upload-files.result }}"
          echo "- éƒ¨ç½²é¡¹ç›®: ${{ needs.deploy-project.result }}"
          echo "- é…ç½®Nginx: ${{ needs.configure-nginx.result || 'skipped' }}"
          echo "- å¯åŠ¨æœåŠ¡: ${{ needs.start-service.result || 'skipped' }}"
          echo ""
          echo "ğŸ”— è®¿é—®ä¿¡æ¯:"
          echo "- åŸŸå: redamancy.com.cn"
          echo "- é¡¹ç›®è·¯å¾„: ${{ needs.deploy-project.outputs.deploy_path }}"
          echo "=========================================="