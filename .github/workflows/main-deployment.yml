name: Main Deployment

description: "ä¸»éƒ¨ç½²å·¥ä½œæµ - æ•´ä¸ªéƒ¨ç½²æµç¨‹çš„å…¥å£ç‚¹"

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'é¡¹ç›®åç§°'
        required: true
        type: string
      source_repo:
        description: 'æºä»“åº“ (æ ¼å¼: owner/repo)'
        required: true
        type: string
      run_id:
        description: 'æ„å»ºè¿è¡ŒID'
        required: true
        type: string
      deploy_type:
        description: 'éƒ¨ç½²ç±»å‹'
        required: true
        default: 'static'
        type: choice
        options:
          - static
          - backend
      nginx_config:
        description: 'Nginxé…ç½®ï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      test_url:
        description: 'æµ‹è¯•URLï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      start_cmd:
        description: 'å¯åŠ¨å‘½ä»¤ï¼ˆåç«¯é¡¹ç›®ï¼‰'
        required: false
        type: string
      deploy_secrets:
        description: 'éƒ¨ç½²å¯†é’¥ (JSONæ ¼å¼æˆ–base64ç¼–ç çš„JSON: {"SERVER_HOST":"host","SERVER_PORT":"port","SERVER_USER":"user","SERVER_KEY":"key","DEPLOY_CENTER_PAT":"pat"})'
        required: true
        type: string
      skip_init:
        description: 'è·³è¿‡æœåŠ¡å™¨åˆå§‹åŒ–æ­¥éª¤'
        required: false
        type: boolean
        default: false

jobs:
  # æ­¥éª¤1: è§£æéƒ¨ç½²å¯†é’¥
  parse-secrets:
    runs-on: ubuntu-latest
    outputs:
      server_host: ${{ steps.parse-secrets.outputs.server_host }}
      server_port: ${{ steps.parse-secrets.outputs.server_port }}
      server_user: ${{ steps.parse-secrets.outputs.server_user }}
      server_key: ${{ steps.parse-secrets.outputs.server_key }}
      deploy_center_pat: ${{ steps.parse-secrets.outputs.deploy_center_pat }}
    
    steps:
      - name: è§£æéƒ¨ç½²å¯†é’¥
        id: parse-secrets
        run: |
          echo "ğŸ” è§£æéƒ¨ç½²å¯†é’¥..."
          
          # ä»è¾“å…¥å‚æ•°è·å–éƒ¨ç½²å¯†é’¥
          DEPLOY_SECRETS='${{ inputs.deploy_secrets }}'
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºbase64ç¼–ç 
          if echo "$DEPLOY_SECRETS" | base64 -d &>/dev/null; then
            echo "ğŸ“¦ æ£€æµ‹åˆ°base64ç¼–ç çš„éƒ¨ç½²å¯†é’¥ï¼Œæ­£åœ¨è§£ç ..."
            DEPLOY_SECRETS=$(echo "$DEPLOY_SECRETS" | base64 -d)
          fi
          
          # ä½¿ç”¨jqè§£æJSONé…ç½®
          SERVER_HOST=$(echo "$DEPLOY_SECRETS" | jq -r '.SERVER_HOST')
          SERVER_PORT=$(echo "$DEPLOY_SECRETS" | jq -r '.SERVER_PORT')
          SERVER_USER=$(echo "$DEPLOY_SECRETS" | jq -r '.SERVER_USER')
          SERVER_KEY=$(echo "$DEPLOY_SECRETS" | jq -r '.SERVER_KEY')
          DEPLOY_CENTER_PAT=$(echo "$DEPLOY_SECRETS" | jq -r '.DEPLOY_CENTER_PAT')
          
          # éªŒè¯å¿…éœ€å‚æ•°
          if [ "$SERVER_HOST" = "null" ] || [ -z "$SERVER_HOST" ]; then
            echo "ğŸš¨ ç¼ºå°‘å¿…éœ€çš„SERVER_HOSTå‚æ•°"
            exit 1
          fi
          if [ "$SERVER_PORT" = "null" ] || [ -z "$SERVER_PORT" ]; then
            echo "ğŸš¨ ç¼ºå°‘å¿…éœ€çš„SERVER_PORTå‚æ•°"
            exit 1
          fi
          if [ "$SERVER_USER" = "null" ] || [ -z "$SERVER_USER" ]; then
            echo "ğŸš¨ ç¼ºå°‘å¿…éœ€çš„SERVER_USERå‚æ•°"
            exit 1
          fi
          if [ "$SERVER_KEY" = "null" ] || [ -z "$SERVER_KEY" ]; then
            echo "ğŸš¨ ç¼ºå°‘å¿…éœ€çš„SERVER_KEYå‚æ•°"
            exit 1
          fi
          if [ "$DEPLOY_CENTER_PAT" = "null" ] || [ -z "$DEPLOY_CENTER_PAT" ]; then
            echo "ğŸš¨ ç¼ºå°‘å¿…éœ€çš„DEPLOY_CENTER_PATå‚æ•°"
            exit 1
          fi
          
          # è®¾ç½®è¾“å‡º - å¯¹äºåŒ…å«æ¢è¡Œç¬¦çš„SERVER_KEYï¼Œä½¿ç”¨å¤šè¡Œè¾“å‡ºè¯­æ³•
          echo "server_host=$SERVER_HOST" >> $GITHUB_OUTPUT
          echo "server_port=$SERVER_PORT" >> $GITHUB_OUTPUT
          echo "server_user=$SERVER_USER" >> $GITHUB_OUTPUT
          echo "deploy_center_pat=$DEPLOY_CENTER_PAT" >> $GITHUB_OUTPUT
          
          # å¯¹äºåŒ…å«æ¢è¡Œç¬¦çš„SERVER_KEYï¼Œä½¿ç”¨å¤šè¡Œè¾“å‡ºè¯­æ³•
          {
            echo 'server_key<<EOF' >> $GITHUB_OUTPUT
            echo "$SERVER_KEY" >> $GITHUB_OUTPUT
            echo 'EOF' >> $GITHUB_OUTPUT
          }
          
          echo "âœ… éƒ¨ç½²å¯†é’¥è§£æå®Œæˆ"
          echo "ğŸ“‹ æœåŠ¡å™¨ä¿¡æ¯:"
          echo "- ä¸»æœº: $SERVER_HOST"
          echo "- ç«¯å£: $SERVER_PORT"
          echo "- ç”¨æˆ·: $SERVER_USER"

  # æ­¥éª¤2: æœåŠ¡å™¨åˆå§‹åŒ–ï¼ˆå¯é€‰ï¼Œä½¿ç”¨å¯å¤ç”¨å·¥ä½œæµï¼‰
  server-init:
    needs: [parse-secrets]
    if: ${{ inputs.skip_init != 'true' }}
    uses: MoseLu/axi-deploy/.github/workflows/server-init.yml@main
    with:
      server_host: ${{ needs.parse-secrets.outputs.server_host }}
      server_user: ${{ needs.parse-secrets.outputs.server_user }}
      server_key: ${{ needs.parse-secrets.outputs.server_key }}
      server_port: ${{ needs.parse-secrets.outputs.server_port }}

  # æ­¥éª¤3: ä¸‹è½½å¹¶éªŒè¯æ„å»ºäº§ç‰©ï¼ˆä½¿ç”¨å¯å¤ç”¨å·¥ä½œæµï¼‰
  download-artifact:
    needs: [parse-secrets]
    uses: MoseLu/axi-deploy/.github/workflows/download-artifact.yml@main
    with:
      project: ${{ inputs.project }}
      source_repo: ${{ inputs.source_repo }}
      run_id: ${{ inputs.run_id }}
      github_token: ${{ needs.parse-secrets.outputs.deploy_center_pat }}

  # æ­¥éª¤4: å¤‡ä»½ç°æœ‰éƒ¨ç½²
  backup-deployment:
    needs: [parse-secrets, download-artifact]
    runs-on: ubuntu-latest
    steps:
      - name: å¤‡ä»½ç°æœ‰éƒ¨ç½²
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.parse-secrets.outputs.server_host }}
          username: ${{ needs.parse-secrets.outputs.server_user }}
          key: ${{ needs.parse-secrets.outputs.server_key }}
          port: ${{ needs.parse-secrets.outputs.server_port }}
          script: |
            echo "ğŸ“‹ å¤‡ä»½ç°æœ‰éƒ¨ç½²..."
            
            PROJECT="${{ inputs.project }}"
            DEPLOY_TYPE="${{ inputs.deploy_type }}"
            DEPLOY_PATH="/srv/${{ inputs.deploy_type == 'backend' && 'apps' || 'static' }}/$PROJECT"
            
            # åˆ›å»ºé¡¹ç›®ä¸“ç”¨å¤‡ä»½ç›®å½•
            if [[ "$DEPLOY_TYPE" == "backend" ]]; then
              BACKUP_ROOT="/srv/backups/apps"
            else
              BACKUP_ROOT="/srv/backups/static"
            fi
            PROJECT_BACKUP_DIR="$BACKUP_ROOT/$PROJECT"
            echo "ğŸ“ åˆ›å»ºé¡¹ç›®å¤‡ä»½ç›®å½•: $PROJECT_BACKUP_DIR"
            sudo mkdir -p "$PROJECT_BACKUP_DIR"
            sudo chmod 755 "$PROJECT_BACKUP_DIR"
            
            # å¤‡ä»½ç°æœ‰éƒ¨ç½²ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -d "$DEPLOY_PATH" ]; then
              echo "ğŸ“‹ å¤‡ä»½ç°æœ‰éƒ¨ç½²ç›®å½•: $DEPLOY_PATH"
              BACKUP_NAME="$PROJECT_BACKUP_DIR/$PROJECT.backup.$(date +%Y%m%d_%H%M%S)"
              sudo cp -r $DEPLOY_PATH $BACKUP_NAME
              echo "âœ… ç°æœ‰éƒ¨ç½²ç›®å½•å·²å¤‡ä»½åˆ°: $BACKUP_NAME"
              
              # æ¸…ç†æ—§çš„å¤‡ä»½æ–‡ä»¶ï¼Œåªä¿ç•™æœ€è¿‘2ä¸ª
              echo "ğŸ§¹ æ¸…ç†æ—§çš„å¤‡ä»½æ–‡ä»¶..."
              BACKUP_FILES=$(ls -t "$PROJECT_BACKUP_DIR"/$PROJECT.backup.* 2>/dev/null | tail -n +3)
              if [ -n "$BACKUP_FILES" ]; then
                echo "ğŸ—‘ï¸ åˆ é™¤æ—§çš„å¤‡ä»½æ–‡ä»¶:"
                echo "$BACKUP_FILES" | xargs -r sudo rm -rf
                echo "âœ… æ—§å¤‡ä»½æ–‡ä»¶å·²æ¸…ç†ï¼Œä¿ç•™æœ€è¿‘2ä¸ªå¤‡ä»½"
              else
                echo "ğŸ“‹ æ²¡æœ‰éœ€è¦æ¸…ç†çš„æ—§å¤‡ä»½æ–‡ä»¶"
              fi
            else
              echo "ğŸ“‹ éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨ï¼Œæ— éœ€å¤‡ä»½: $DEPLOY_PATH"
            fi

  # æ­¥éª¤5: éƒ¨ç½²é¡¹ç›®
  deploy-project:
    needs: [parse-secrets, download-artifact, backup-deployment]
    uses: MoseLu/axi-deploy/.github/workflows/deploy-project.yml@main
    with:
      project: ${{ inputs.project }}
      deploy_type: ${{ inputs.deploy_type }}
      server_host: ${{ needs.parse-secrets.outputs.server_host }}
      server_user: ${{ needs.parse-secrets.outputs.server_user }}
      server_key: ${{ needs.parse-secrets.outputs.server_key }}
      server_port: ${{ needs.parse-secrets.outputs.server_port }}

  # æ­¥éª¤6: é…ç½®Nginxï¼ˆå¯é€‰ï¼‰
  configure-nginx:
    needs: [deploy-project]
    if: ${{ inputs.nginx_config != '' }}
    uses: MoseLu/axi-deploy/.github/workflows/configure-nginx.yml@main
    with:
      project: ${{ inputs.project }}
      server_host: ${{ needs.parse-secrets.outputs.server_host }}
      server_user: ${{ needs.parse-secrets.outputs.server_user }}
      server_key: ${{ needs.parse-secrets.outputs.server_key }}
      server_port: ${{ needs.parse-secrets.outputs.server_port }}
      deploy_type: ${{ inputs.deploy_type }}
      nginx_config: ${{ inputs.nginx_config }}

  # æ­¥éª¤7: å¯åŠ¨æœåŠ¡ï¼ˆå¯é€‰ï¼Œä»…åç«¯é¡¹ç›®ï¼‰
  start-service:
    needs: [deploy-project]
    if: ${{ inputs.start_cmd != '' && inputs.deploy_type == 'backend' }}
    uses: MoseLu/axi-deploy/.github/workflows/start-service.yml@main
    with:
      project: ${{ inputs.project }}
      start_cmd: ${{ inputs.start_cmd }}
      deploy_type: ${{ inputs.deploy_type }}
      server_host: ${{ needs.parse-secrets.outputs.server_host }}
      server_user: ${{ needs.parse-secrets.outputs.server_user }}
      server_key: ${{ needs.parse-secrets.outputs.server_key }}
      server_port: ${{ needs.parse-secrets.outputs.server_port }}

  # æ­¥éª¤8: æµ‹è¯•ç½‘ç«™ï¼ˆå¯é€‰ï¼‰
  test-website:
    needs: [deploy-project, configure-nginx, start-service]
    if: ${{ inputs.test_url != '' }}
    uses: MoseLu/axi-deploy/.github/workflows/test-website.yml@main
    with:
      project: ${{ inputs.project }}
      test_url: ${{ inputs.test_url }}
      deploy_type: ${{ inputs.deploy_type }}
      server_host: ${{ needs.parse-secrets.outputs.server_host }}
      server_user: ${{ needs.parse-secrets.outputs.server_user }}
      server_key: ${{ needs.parse-secrets.outputs.server_key }}
      server_port: ${{ needs.parse-secrets.outputs.server_port }}

  # æ­¥éª¤9: éƒ¨ç½²å®Œæˆæ€»ç»“
  deployment-summary:
    needs: [parse-secrets, server-init, download-artifact, backup-deployment, deploy-project, configure-nginx, start-service, test-website]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: éƒ¨ç½²å®Œæˆæ€»ç»“
        run: |
          echo "ğŸ‰ éƒ¨ç½²æµç¨‹å®Œæˆ"
          echo "=========================================="
          echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯:"
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- éƒ¨ç½²ç±»å‹: ${{ inputs.deploy_type }}"
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- æ„å»ºID: ${{ inputs.run_id }}"
          echo ""
          echo "ğŸ“Š æ‰§è¡ŒçŠ¶æ€:"
          echo "- è§£æå¯†é’¥: ${{ needs.parse-secrets.result }}"
          echo "- æœåŠ¡å™¨åˆå§‹åŒ–: ${{ needs.server-init.result || 'skipped' }}"
          echo "- ä¸‹è½½æ„å»ºäº§ç‰©: ${{ needs.download-artifact.result }}"
          echo "- å¤‡ä»½éƒ¨ç½²: ${{ needs.backup-deployment.result }}"
          echo "- éƒ¨ç½²é¡¹ç›®: ${{ needs.deploy-project.result }}"
          echo "- é…ç½®Nginx: ${{ needs.configure-nginx.result || 'skipped' }}"
          echo "- å¯åŠ¨æœåŠ¡: ${{ needs.start-service.result || 'skipped' }}"
          echo "- æµ‹è¯•ç½‘ç«™: ${{ needs.test-website.result || 'skipped' }}"
          echo ""
          echo "ğŸ”— è®¿é—®ä¿¡æ¯:"
          echo "- åŸŸå: redamancy.com.cn"
          if [ "${{ needs.deploy-project.outputs.deploy_path }}" != "" ]; then
            echo "- é¡¹ç›®è·¯å¾„: ${{ needs.deploy-project.outputs.deploy_path }}"
          fi
          if [ "${{ inputs.test_url }}" != "" ]; then
            echo "- æµ‹è¯•URL: ${{ inputs.test_url }}"
          fi
          echo ""
          echo "ğŸ“ éƒ¨ç½²å®Œæˆé€šçŸ¥:"
          echo "âœ… é¡¹ç›® ${{ inputs.project }} å·²æˆåŠŸéƒ¨ç½²åˆ°æœåŠ¡å™¨"
          if [ "${{ inputs.test_url }}" != "" ]; then
            echo "ğŸŒ å¯é€šè¿‡ ${{ inputs.test_url }} è®¿é—®"
          fi
          echo "=========================================="