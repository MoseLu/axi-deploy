name: Main Deployment

description: "ä¸»éƒ¨ç½²å·¥ä½œæµ - æ•´ä¸ªéƒ¨ç½²æµç¨‹çš„å…¥å£ç‚¹"

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'é¡¹ç›®åç§°'
        required: true
        type: string
      source_repo:
        description: 'æºä»“åº“ (æ ¼å¼: owner/repo)'
        required: true
        type: string
      run_id:
        description: 'æ„å»ºè¿è¡ŒID'
        required: true
        type: string
      deploy_type:
        description: 'éƒ¨ç½²ç±»å‹'
        required: true
        default: 'static'
        type: choice
        options:
          - static
          - backend
      nginx_config:
        description: 'Nginxé…ç½®ï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      test_url:
        description: 'æµ‹è¯•URLï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      start_cmd:
        description: 'å¯åŠ¨å‘½ä»¤ï¼ˆåç«¯é¡¹ç›®ï¼‰'
        required: false
        type: string
      backend_port:
        description: 'åç«¯æœåŠ¡ç«¯å£'
        required: false
        type: string
        default: '8080'
      service_name:
        description: 'æœåŠ¡åç§°'
        required: false
        type: string
        default: 'star-cloud'

jobs:
  download-artifact:
    uses: ./.github/workflows/download-artifact.yml
    with:
      project: ${{ inputs.project }}
      source_repo: ${{ inputs.source_repo }}
      run_id: ${{ inputs.run_id }}
      github_token: ${{ secrets.GITHUB_TOKEN }}

  upload-files:
    needs: download-artifact
    uses: ./.github/workflows/upload-files.yml
    with:
      project: ${{ inputs.project }}
      server_host: ${{ vars.SERVER_HOST }}
      server_user: ${{ vars.SERVER_USER }}
      server_key: ${{ secrets.SERVER_KEY }}
      server_port: ${{ vars.SERVER_PORT }}
      artifact_path: ${{ needs.download-artifact.outputs.artifact_path }}
      run_user: 'deploy'

  deploy-project:
    needs: upload-files
    uses: ./.github/workflows/deploy-project.yml
    with:
      project: ${{ inputs.project }}
      deploy_type: ${{ inputs.deploy_type }}
      server_host: ${{ vars.SERVER_HOST }}
      server_user: ${{ vars.SERVER_USER }}
      server_key: ${{ secrets.SERVER_KEY }}
      server_port: ${{ vars.SERVER_PORT }}
      apps_root: '/srv/apps'
      static_root: '/srv/static'
      backup_root: '/srv/backups'
      run_user: 'deploy'

  configure-nginx:
    needs: deploy-project
    if: ${{ inputs.nginx_config != '' }}
    uses: ./.github/workflows/configure-nginx.yml
    with:
      project: ${{ inputs.project }}
      nginx_config: ${{ inputs.nginx_config }}
      server_host: ${{ vars.SERVER_HOST }}
      server_user: ${{ vars.SERVER_USER }}
      server_key: ${{ secrets.SERVER_KEY }}
      server_port: ${{ vars.SERVER_PORT }}
      domain: 'redamancy.com.cn'
      nginx_conf_dir: '/www/server/nginx/conf/conf.d/redamancy'
      apps_root: '/srv/apps'
      static_root: '/srv/static'
      backend_port: ${{ inputs.backend_port }}
      service_name: ${{ inputs.service_name }}

  start-service:
    needs: [deploy-project, configure-nginx]
    if: ${{ inputs.start_cmd != '' && inputs.deploy_type == 'backend' }}
    uses: ./.github/workflows/start-service.yml
    with:
      project: ${{ inputs.project }}
      start_cmd: ${{ inputs.start_cmd }}
      deploy_type: ${{ inputs.deploy_type }}
      server_host: ${{ vars.SERVER_HOST }}
      server_user: ${{ vars.SERVER_USER }}
      server_key: ${{ secrets.SERVER_KEY }}
      server_port: ${{ vars.SERVER_PORT }}
      apps_root: '/srv/apps'

  test-website:
    needs: [deploy-project, configure-nginx, start-service]
    if: ${{ inputs.test_url != '' }}
    uses: ./.github/workflows/test-website.yml
    with:
      project: ${{ inputs.project }}
      test_url: ${{ inputs.test_url }}
      deploy_type: ${{ inputs.deploy_type }}
      server_host: ${{ vars.SERVER_HOST }}
      server_user: ${{ vars.SERVER_USER }}
      server_key: ${{ secrets.SERVER_KEY }}
      server_port: ${{ vars.SERVER_PORT }}
      apps_root: '/srv/apps'
      static_root: '/srv/static'
      nginx_conf_dir: '/www/server/nginx/conf/conf.d/redamancy'

  deployment-summary:
    needs: [download-artifact, upload-files, deploy-project, configure-nginx, start-service, test-website]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: éƒ¨ç½²å®Œæˆæ€»ç»“
        run: |
          echo "ğŸ‰ éƒ¨ç½²æµç¨‹å®Œæˆ"
          echo "=========================================="
          echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯:"
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- éƒ¨ç½²ç±»å‹: ${{ inputs.deploy_type }}"
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- æ„å»ºID: ${{ inputs.run_id }}"
          echo ""
          echo "ğŸ“Š æ‰§è¡ŒçŠ¶æ€:"
          echo "- ä¸‹è½½æ„å»ºäº§ç‰©: ${{ needs.download-artifact.result }}"
          echo "- ä¸Šä¼ æ–‡ä»¶: ${{ needs.upload-files.result }}"
          echo "- éƒ¨ç½²é¡¹ç›®: ${{ needs.deploy-project.result }}"
          echo "- é…ç½®Nginx: ${{ needs.configure-nginx.result || 'skipped' }}"
          echo "- å¯åŠ¨æœåŠ¡: ${{ needs.start-service.result || 'skipped' }}"
          echo "- ç½‘ç«™æµ‹è¯•: ${{ needs.test-website.result || 'skipped' }}"
          echo ""
          echo "ğŸ”— è®¿é—®ä¿¡æ¯:"
          echo "- åŸŸå: redamancy.com.cn"
          echo "- é¡¹ç›®è·¯å¾„: /srv/apps/${{ inputs.project }}"
          if [ "${{ inputs.test_url }}" != "" ]; then
            echo "- æµ‹è¯•URL: ${{ inputs.test_url }}"
          fi
          echo "=========================================="