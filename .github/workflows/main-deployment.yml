name: Main Deployment

description: "ä¸»éƒ¨ç½²å·¥ä½œæµ - æ•´ä¸ªéƒ¨ç½²æµç¨‹çš„å…¥å£ç‚¹"

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'é¡¹ç›®åç§°'
        required: true
        type: string
      source_repo:
        description: 'æºä»“åº“ (æ ¼å¼: owner/repo)'
        required: true
        type: string
      run_id:
        description: 'æ„å»ºè¿è¡ŒID'
        required: true
        type: string
      deploy_type:
        description: 'éƒ¨ç½²ç±»å‹'
        required: true
        default: 'static'
        type: choice
        options:
          - static
          - backend
      nginx_config:
        description: 'Nginxé…ç½®ï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      start_cmd:
        description: 'å¯åŠ¨å‘½ä»¤ï¼ˆåç«¯é¡¹ç›®ï¼‰'
        required: false
        type: string
      server_host:
        description: 'æœåŠ¡å™¨åœ°å€'
        required: true
        type: string
      server_user:
        description: 'æœåŠ¡å™¨ç”¨æˆ·'
        required: true
        type: string
      server_key:
        description: 'æœåŠ¡å™¨å¯†é’¥'
        required: true
        type: string
      server_port:
        description: 'æœåŠ¡å™¨ç«¯å£'
        required: true
        type: string

jobs:
  download-artifact:
    runs-on: ubuntu-latest
    outputs:
      artifact_path: ${{ steps.set-outputs.outputs.artifact_path }}
      artifact_size: ${{ steps.set-outputs.outputs.artifact_size }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        id: download
        uses: dawidd6/action-download-artifact@v2
        with:
          name: dist-${{ inputs.project }}
          path: ./
          repo: ${{ inputs.source_repo }}
          workflow: ${{ inputs.project }}_deploy.yml
          run_id: ${{ inputs.run_id }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: éªŒè¯æ„å»ºäº§ç‰©
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºäº§ç‰©..."
          
          # æ£€æŸ¥å¯èƒ½çš„æ„å»ºäº§ç‰©ç›®å½•
          if [ -d "./dist" ]; then
            ARTIFACT_DIR="./dist"
          elif [ -d "./dist-${{ inputs.project }}" ]; then
            ARTIFACT_DIR="./dist-${{ inputs.project }}"
          elif [ -d "./docs/.vitepress/dist" ]; then
            ARTIFACT_DIR="./docs/.vitepress/dist"
          else
            # æ„å»ºäº§ç‰©ç›´æ¥åœ¨å½“å‰ç›®å½•
            ARTIFACT_DIR="."
            echo "ğŸ“ æ„å»ºäº§ç‰©ç›´æ¥åœ¨å½“å‰ç›®å½•"
          fi
          
          echo "ğŸ“ æ„å»ºäº§ç‰©ç›®å½•: $ARTIFACT_DIR"
          echo "ğŸ“ æ„å»ºäº§ç‰©ç›®å½•å†…å®¹:"
          ls -la "$ARTIFACT_DIR/"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
          FILE_COUNT=$(find "$ARTIFACT_DIR" -type f | wc -l)
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "âŒ æ„å»ºäº§ç‰©ç›®å½•ä¸ºç©º"
            exit 1
          fi
          
          echo "âœ… æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡"
          echo "ğŸ“Š æ–‡ä»¶æ•°é‡: $FILE_COUNT"

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          # ç¡®å®šæ„å»ºäº§ç‰©è·¯å¾„
          if [ -d "./dist" ]; then
            ARTIFACT_PATH="./dist"
          elif [ -d "./dist-${{ inputs.project }}" ]; then
            ARTIFACT_PATH="./dist-${{ inputs.project }}"
          elif [ -d "./docs/.vitepress/dist" ]; then
            ARTIFACT_PATH="./docs/.vitepress/dist"
          else
            # æ„å»ºäº§ç‰©ç›´æ¥åœ¨å½“å‰ç›®å½•
            ARTIFACT_PATH="."
          fi
          
          echo "artifact_path=$ARTIFACT_PATH" >> $GITHUB_OUTPUT
          echo "artifact_size=$(du -sb $ARTIFACT_PATH | cut -f1)" >> $GITHUB_OUTPUT
          echo "âœ… è¾“å‡ºå·²è®¾ç½®"
          echo "æ„å»ºäº§ç‰©è·¯å¾„: $ARTIFACT_PATH"

  deploy-project:
    needs: download-artifact
    runs-on: ubuntu-latest
    outputs:
      deploy_success: ${{ steps.set-outputs.outputs.deploy_success }}
      deploy_path: ${{ steps.set-outputs.outputs.deploy_path }}
    
    steps:
      - name: è°ƒè¯•æ„å»ºäº§ç‰©è·¯å¾„
        run: |
          echo "ğŸ” è°ƒè¯•æ„å»ºäº§ç‰©è·¯å¾„..."
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "æ„å»ºäº§ç‰©è·¯å¾„: ${{ needs.download-artifact.outputs.artifact_path }}"
          echo "æ„å»ºäº§ç‰©å¤§å°: ${{ needs.download-artifact.outputs.artifact_size }}"
          
          echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
          ls -la ./
          
          echo "ğŸ“ æ„å»ºäº§ç‰©ç›®å½•å†…å®¹:"
          if [ -d "${{ needs.download-artifact.outputs.artifact_path }}" ]; then
            ls -la "${{ needs.download-artifact.outputs.artifact_path }}/"
            echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
            find "${{ needs.download-artifact.outputs.artifact_path }}" -type f | wc -l
            echo "ğŸ“ å‰10ä¸ªæ–‡ä»¶:"
            find "${{ needs.download-artifact.outputs.artifact_path }}" -type f | head -10
          else
            echo "âŒ æ„å»ºäº§ç‰©ç›®å½•ä¸å­˜åœ¨: ${{ needs.download-artifact.outputs.artifact_path }}"
          fi
          
          echo "ğŸ” æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„æ„å»ºäº§ç‰©ç›®å½•:"
          for dir in ./dist* ./docs* ./*; do
            if [ -d "$dir" ]; then
              echo "ğŸ“ å‘ç°ç›®å½•: $dir"
              ls -la "$dir/" | head -5
            fi
          done

      - name: ç›´æ¥éƒ¨ç½²åˆ°ç›®æ ‡ç›®å½•
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          source: "${{ github.workspace }}/${{ needs.download-artifact.outputs.artifact_path }}/*"
          target: "/srv/${{ inputs.deploy_type == 'backend' && 'apps' || 'static' }}/${{ inputs.project }}/"

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          echo "deploy_success=true" >> $GITHUB_OUTPUT
          echo "deploy_path=/srv/${{ inputs.deploy_type == 'backend' && 'apps' || 'static' }}/${{ inputs.project }}" >> $GITHUB_OUTPUT
          echo "âœ… éƒ¨ç½²å®Œæˆ"

  configure-nginx:
    needs: deploy-project
    uses: ./.github/workflows/configure-nginx.yml
    with:
      project: ${{ inputs.project }}
      nginx_config: ${{ inputs.nginx_config }}
      server_host: ${{ inputs.server_host }}
      server_user: ${{ inputs.server_user }}
      server_key: ${{ inputs.server_key }}
      server_port: ${{ inputs.server_port }}
      deploy_type: ${{ inputs.deploy_type }}

  start-service:
    needs: [deploy-project]
    if: ${{ inputs.start_cmd != '' && inputs.deploy_type == 'backend' }}
    runs-on: ubuntu-latest
    outputs:
      start_success: ${{ steps.set-outputs.outputs.start_success }}
    
    steps:
      - name: å¯åŠ¨æœåŠ¡
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
            
            PROJECT="${{ inputs.project }}"
            START_CMD="${{ inputs.start_cmd }}"
            APPS_ROOT="/srv/apps"
            
            # åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
            cd "$APPS_ROOT/$PROJECT"
            
            # æ‰§è¡Œå¯åŠ¨å‘½ä»¤
            echo "ğŸ“‹ æ‰§è¡Œå¯åŠ¨å‘½ä»¤: $START_CMD"
            $START_CMD
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 5
            
            echo "âœ… æœåŠ¡å¯åŠ¨å®Œæˆ"

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          echo "start_success=true" >> $GITHUB_OUTPUT
          echo "âœ… å¯åŠ¨å®Œæˆ"

  test-website:
    needs: [deploy-project, configure-nginx, start-service]
    if: always()
    runs-on: ubuntu-latest
    outputs:
      test_success: ${{ steps.set-outputs.outputs.test_success }}
    
    steps:
      - name: æµ‹è¯•ç½‘ç«™å¯è®¿é—®æ€§
        run: |
          echo "ğŸ” æµ‹è¯•ç½‘ç«™å¯è®¿é—®æ€§..."
          
          # ç­‰å¾…ä¸€æ®µæ—¶é—´è®©æœåŠ¡å®Œå…¨å¯åŠ¨
          sleep 10
          
          # æµ‹è¯•ç½‘ç«™å¯è®¿é—®æ€§
          HTTP_STATUS=$(curl -f -s -o /dev/null -w "%{http_code}" https://redamancy.com.cn/docs/ 2>/dev/null || echo "000")
          echo "ğŸ“‹ HTTPçŠ¶æ€ç : $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "301" ] || [ "$HTTP_STATUS" = "302" ]; then
            echo "âœ… ç½‘ç«™å¯æ­£å¸¸è®¿é—®"
          else
            echo "âŒ ç½‘ç«™æ— æ³•è®¿é—®ï¼ŒHTTPçŠ¶æ€ç : $HTTP_STATUS"
            echo "ğŸš¨ å·¥ä½œæµé”™è¯¯ï¼šç½‘ç«™è¿”å› $HTTP_STATUS çŠ¶æ€ç ï¼Œè¿™è¡¨ç¤ºé…ç½®æœ‰é—®é¢˜"
            echo "å¯èƒ½çš„åŸå› :"
            echo "1. Nginxé…ç½®é”™è¯¯"
            echo "2. æ–‡ä»¶æƒé™é—®é¢˜"
            echo "3. è·¯å¾„ä¸å­˜åœ¨"
            echo "4. SSLè¯ä¹¦é—®é¢˜"
            exit 1
          fi

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          echo "test_success=true" >> $GITHUB_OUTPUT
          echo "âœ… æµ‹è¯•å®Œæˆ"

  deployment-summary:
    needs: [download-artifact, deploy-project, configure-nginx, start-service, test-website]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: éƒ¨ç½²å®Œæˆæ€»ç»“
        run: |
          echo "ğŸ‰ éƒ¨ç½²æµç¨‹å®Œæˆ"
          echo "=========================================="
          echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯:"
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- éƒ¨ç½²ç±»å‹: ${{ inputs.deploy_type }}"
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- æ„å»ºID: ${{ inputs.run_id }}"
          echo ""
          echo "ğŸ“Š æ‰§è¡ŒçŠ¶æ€:"
          echo "- ä¸‹è½½æ„å»ºäº§ç‰©: ${{ needs.download-artifact.result }}"
          echo "- éƒ¨ç½²é¡¹ç›®: ${{ needs.deploy-project.result }}"
          echo "- é…ç½®Nginx: ${{ needs.configure-nginx.result || 'skipped' }}"
          echo "- å¯åŠ¨æœåŠ¡: ${{ needs.start-service.result || 'skipped' }}"
          echo "- æµ‹è¯•ç½‘ç«™: ${{ needs.test-website.result || 'skipped' }}"
          echo ""
          echo "ğŸ”— è®¿é—®ä¿¡æ¯:"
          echo "- åŸŸå: redamancy.com.cn"
          echo "- é¡¹ç›®è·¯å¾„: ${{ needs.deploy-project.outputs.deploy_path }}"
          echo "- è®¿é—®URL: https://redamancy.com.cn/docs/"
          echo ""
          echo "ğŸ“ éƒ¨ç½²å®Œæˆé€šçŸ¥:"
          echo "âœ… é¡¹ç›® ${{ inputs.project }} å·²æˆåŠŸéƒ¨ç½²åˆ°æœåŠ¡å™¨"
          echo "ğŸŒ å¯é€šè¿‡ https://redamancy.com.cn/docs/ è®¿é—®"
          echo "=========================================="