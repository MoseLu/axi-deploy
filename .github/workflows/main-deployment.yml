name: Main Deployment

description: "主部署工作流 - 整个部署流程的入口点"

on:
  workflow_dispatch:
    inputs:
      project:
        description: '项目名称'
        required: true
        type: string
      source_repo:
        description: '源仓库 (格式: owner/repo)'
        required: true
        type: string
      run_id:
        description: '构建运行ID'
        required: true
        type: string
      deploy_type:
        description: '部署类型'
        required: true
        default: 'static'
        type: choice
        options:
          - static
          - backend
      nginx_config:
        description: 'Nginx配置（可选）'
        required: false
        type: string
      start_cmd:
        description: '启动命令（后端项目）'
        required: false
        type: string
      server_host:
        description: '服务器地址'
        required: true
        type: string
      server_user:
        description: '服务器用户'
        required: true
        type: string
      server_key:
        description: '服务器密钥'
        required: true
        type: string
      server_port:
        description: '服务器端口'
        required: true
        type: string

jobs:
  download-artifact:
    runs-on: ubuntu-latest
    outputs:
      artifact_path: ${{ steps.set-outputs.outputs.artifact_path }}
      artifact_size: ${{ steps.set-outputs.outputs.artifact_size }}
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 下载构建产物
        id: download
        uses: dawidd6/action-download-artifact@v2
        with:
          name: dist-${{ inputs.project }}
          path: ./
          repo: ${{ inputs.source_repo }}
          workflow: ${{ inputs.project }}_deploy.yml
          run_id: ${{ inputs.run_id }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: 验证构建产物
        run: |
          echo "🔍 验证构建产物..."
          
          # 检查可能的构建产物目录
          if [ -d "./dist" ]; then
            ARTIFACT_DIR="./dist"
          elif [ -d "./dist-${{ inputs.project }}" ]; then
            ARTIFACT_DIR="./dist-${{ inputs.project }}"
          elif [ -d "./docs/.vitepress/dist" ]; then
            ARTIFACT_DIR="./docs/.vitepress/dist"
          else
            # 构建产物直接在当前目录
            ARTIFACT_DIR="."
            echo "📁 构建产物直接在当前目录"
          fi
          
          echo "📁 构建产物目录: $ARTIFACT_DIR"
          echo "📁 构建产物目录内容:"
          ls -la "$ARTIFACT_DIR/"
          
          # 检查是否有文件
          FILE_COUNT=$(find "$ARTIFACT_DIR" -type f | wc -l)
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "❌ 构建产物目录为空"
            exit 1
          fi
          
          echo "✅ 构建产物验证通过"
          echo "📊 文件数量: $FILE_COUNT"

      - name: 设置输出
        id: set-outputs
        run: |
          # 确定构建产物路径
          if [ -d "./dist" ]; then
            ARTIFACT_PATH="./dist"
          elif [ -d "./dist-${{ inputs.project }}" ]; then
            ARTIFACT_PATH="./dist-${{ inputs.project }}"
          elif [ -d "./docs/.vitepress/dist" ]; then
            ARTIFACT_PATH="./docs/.vitepress/dist"
          else
            # 构建产物直接在当前目录
            ARTIFACT_PATH="."
          fi
          
          echo "artifact_path=$ARTIFACT_PATH" >> $GITHUB_OUTPUT
          echo "artifact_size=$(du -sb $ARTIFACT_PATH | cut -f1)" >> $GITHUB_OUTPUT
          echo "✅ 输出已设置"
          echo "构建产物路径: $ARTIFACT_PATH"

  deploy-project:
    needs: download-artifact
    runs-on: ubuntu-latest
    outputs:
      deploy_success: ${{ steps.set-outputs.outputs.deploy_success }}
      deploy_path: ${{ steps.set-outputs.outputs.deploy_path }}
    
    steps:
      - name: 调试构建产物路径
        run: |
          echo "🔍 调试构建产物路径..."
          echo "当前工作目录: $(pwd)"
          echo "构建产物路径: ${{ needs.download-artifact.outputs.artifact_path }}"
          echo "构建产物大小: ${{ needs.download-artifact.outputs.artifact_size }}"
          
          echo "📁 当前目录内容:"
          ls -la ./
          
          echo "📁 构建产物目录内容:"
          if [ -d "${{ needs.download-artifact.outputs.artifact_path }}" ]; then
            ls -la "${{ needs.download-artifact.outputs.artifact_path }}/"
            echo "📊 文件统计:"
            find "${{ needs.download-artifact.outputs.artifact_path }}" -type f | wc -l
            echo "📁 前10个文件:"
            find "${{ needs.download-artifact.outputs.artifact_path }}" -type f | head -10
          else
            echo "❌ 构建产物目录不存在: ${{ needs.download-artifact.outputs.artifact_path }}"
          fi
          
          echo "🔍 检查所有可能的构建产物目录:"
          for dir in ./dist* ./docs* ./*; do
            if [ -d "$dir" ]; then
              echo "📁 发现目录: $dir"
              ls -la "$dir/" | head -5
            fi
          done

      - name: 直接部署到目标目录
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          source: "${{ github.workspace }}/${{ needs.download-artifact.outputs.artifact_path }}/*"
          target: "/srv/${{ inputs.deploy_type == 'backend' && 'apps' || 'static' }}/${{ inputs.project }}/"

      - name: 设置输出
        id: set-outputs
        run: |
          echo "deploy_success=true" >> $GITHUB_OUTPUT
          echo "deploy_path=/srv/${{ inputs.deploy_type == 'backend' && 'apps' || 'static' }}/${{ inputs.project }}" >> $GITHUB_OUTPUT
          echo "✅ 部署完成"

  configure-nginx:
    needs: deploy-project
    uses: ./.github/workflows/configure-nginx.yml
    with:
      project: ${{ inputs.project }}
      nginx_config: ${{ inputs.nginx_config }}
      server_host: ${{ inputs.server_host }}
      server_user: ${{ inputs.server_user }}
      server_key: ${{ inputs.server_key }}
      server_port: ${{ inputs.server_port }}
      deploy_type: ${{ inputs.deploy_type }}

  start-service:
    needs: [deploy-project]
    if: ${{ inputs.start_cmd != '' && inputs.deploy_type == 'backend' }}
    runs-on: ubuntu-latest
    outputs:
      start_success: ${{ steps.set-outputs.outputs.start_success }}
    
    steps:
      - name: 启动服务
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "🚀 启动服务..."
            
            PROJECT="${{ inputs.project }}"
            START_CMD="${{ inputs.start_cmd }}"
            APPS_ROOT="/srv/apps"
            
            # 切换到项目目录
            cd "$APPS_ROOT/$PROJECT"
            
            # 执行启动命令
            echo "📋 执行启动命令: $START_CMD"
            $START_CMD
            
            # 等待服务启动
            sleep 5
            
            echo "✅ 服务启动完成"

      - name: 设置输出
        id: set-outputs
        run: |
          echo "start_success=true" >> $GITHUB_OUTPUT
          echo "✅ 启动完成"

  test-website:
    needs: [deploy-project, configure-nginx, start-service]
    if: always()
    runs-on: ubuntu-latest
    outputs:
      test_success: ${{ steps.set-outputs.outputs.test_success }}
    
    steps:
      - name: 测试网站可访问性
        run: |
          echo "🔍 测试网站可访问性..."
          
          # 等待一段时间让服务完全启动
          sleep 10
          
          # 测试网站可访问性
          HTTP_STATUS=$(curl -f -s -o /dev/null -w "%{http_code}" https://redamancy.com.cn/docs/ 2>/dev/null || echo "000")
          echo "📋 HTTP状态码: $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "301" ] || [ "$HTTP_STATUS" = "302" ]; then
            echo "✅ 网站可正常访问"
          else
            echo "❌ 网站无法访问，HTTP状态码: $HTTP_STATUS"
            echo "🚨 工作流错误：网站返回 $HTTP_STATUS 状态码，这表示配置有问题"
            echo "可能的原因:"
            echo "1. Nginx配置错误"
            echo "2. 文件权限问题"
            echo "3. 路径不存在"
            echo "4. SSL证书问题"
            exit 1
          fi

      - name: 设置输出
        id: set-outputs
        run: |
          echo "test_success=true" >> $GITHUB_OUTPUT
          echo "✅ 测试完成"

  deployment-summary:
    needs: [download-artifact, deploy-project, configure-nginx, start-service, test-website]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: 部署完成总结
        run: |
          echo "🎉 部署流程完成"
          echo "=========================================="
          echo "📋 部署信息:"
          echo "- 项目: ${{ inputs.project }}"
          echo "- 部署类型: ${{ inputs.deploy_type }}"
          echo "- 源仓库: ${{ inputs.source_repo }}"
          echo "- 构建ID: ${{ inputs.run_id }}"
          echo ""
          echo "📊 执行状态:"
          echo "- 下载构建产物: ${{ needs.download-artifact.result }}"
          echo "- 部署项目: ${{ needs.deploy-project.result }}"
          echo "- 配置Nginx: ${{ needs.configure-nginx.result || 'skipped' }}"
          echo "- 启动服务: ${{ needs.start-service.result || 'skipped' }}"
          echo "- 测试网站: ${{ needs.test-website.result || 'skipped' }}"
          echo ""
          echo "🔗 访问信息:"
          echo "- 域名: redamancy.com.cn"
          echo "- 项目路径: ${{ needs.deploy-project.outputs.deploy_path }}"
          echo "- 访问URL: https://redamancy.com.cn/docs/"
          echo ""
          echo "📝 部署完成通知:"
          echo "✅ 项目 ${{ inputs.project }} 已成功部署到服务器"
          echo "🌐 可通过 https://redamancy.com.cn/docs/ 访问"
          echo "=========================================="