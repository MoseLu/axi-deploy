name: Main Deployment

description: "主部署工作流 - 整个部署流程的入口点"

on:
  workflow_dispatch:
    inputs:
      project:
        description: '项目名称'
        required: true
        type: string
      source_repo:
        description: '源仓库 (格式: owner/repo)'
        required: true
        type: string
      run_id:
        description: '构建运行ID'
        required: true
        type: string
      deploy_type:
        description: '部署类型'
        required: true
        default: 'static'
        type: choice
        options:
          - static
          - backend
      nginx_config:
        description: 'Nginx配置（可选）'
        required: false
        type: string
      test_url:
        description: '测试URL（可选）'
        required: false
        type: string
      start_cmd:
        description: '启动命令（后端项目）'
        required: false
        type: string
      deploy_secrets:
        description: '部署密钥 (JSON格式或base64编码的JSON: {"SERVER_HOST":"host","SERVER_PORT":"port","SERVER_USER":"user","SERVER_KEY":"key","DEPLOY_CENTER_PAT":"pat"})，DEPLOY_CENTER_PAT可选，默认使用内置Token'
        required: true
        type: string
      skip_init:
        description: '跳过服务器初始化步骤'
        required: false
        type: boolean
        default: false

jobs:
  # 步骤1: 验证构建产物可用性
  validate-artifact:
    uses: MoseLu/axi-deploy/.github/workflows/validate-artifact.yml@master
    with:
      project: ${{ inputs.project }}
      source_repo: ${{ inputs.source_repo }}
      deploy_secrets: ${{ inputs.deploy_secrets }}

  # 步骤2: 解析部署密钥
  parse-secrets:
    needs: [validate-artifact]
    uses: MoseLu/axi-deploy/.github/workflows/parse-secrets.yml@master
    with:
      deploy_secrets: ${{ inputs.deploy_secrets }}

  # 步骤3: 服务器初始化（可选，使用可复用工作流）
  server-init:
    needs: [parse-secrets, validate-artifact]
    if: ${{ inputs.skip_init != 'true' }}
    uses: MoseLu/axi-deploy/.github/workflows/server-init.yml@master
    with:
      server_host: ${{ needs.parse-secrets.outputs.server_host }}
      server_user: ${{ needs.parse-secrets.outputs.server_user }}
      server_key: ${{ needs.parse-secrets.outputs.server_key }}
      server_port: ${{ needs.parse-secrets.outputs.server_port }}

  # 步骤4: 部署项目
  deploy-project:
    needs: [parse-secrets, validate-artifact]
    uses: MoseLu/axi-deploy/.github/workflows/deploy-project.yml@master
    with:
      project: ${{ inputs.project }}
      source_repo: ${{ inputs.source_repo }}
      run_id: ${{ needs.validate-artifact.outputs.run_id }}
      deploy_type: ${{ inputs.deploy_type }}
      server_host: ${{ needs.parse-secrets.outputs.server_host }}
      server_user: ${{ needs.parse-secrets.outputs.server_user }}
      server_key: ${{ needs.parse-secrets.outputs.server_key }}
      server_port: ${{ needs.parse-secrets.outputs.server_port }}
      deploy_center_pat: ${{ needs.parse-secrets.outputs.deploy_center_pat || '' }}

  # 步骤5: 配置Nginx（可选）
  configure-nginx:
    needs: [parse-secrets, deploy-project]
    if: ${{ inputs.nginx_config != '' }}
    uses: MoseLu/axi-deploy/.github/workflows/configure-nginx.yml@master
    with:
      project: ${{ inputs.project }}
      server_host: ${{ needs.parse-secrets.outputs.server_host }}
      server_user: ${{ needs.parse-secrets.outputs.server_user }}
      server_key: ${{ needs.parse-secrets.outputs.server_key }}
      server_port: ${{ needs.parse-secrets.outputs.server_port }}
      deploy_type: ${{ inputs.deploy_type }}
      nginx_config: ${{ inputs.nginx_config }}

  # 步骤6: 启动服务（可选，仅后端项目）
  start-service:
    needs: [parse-secrets, deploy-project, configure-nginx]
    if: ${{ inputs.start_cmd != '' && inputs.deploy_type == 'backend' }}
    uses: MoseLu/axi-deploy/.github/workflows/start-service.yml@master
    with:
      project: ${{ inputs.project }}
      start_cmd: ${{ inputs.start_cmd }}
      deploy_type: ${{ inputs.deploy_type }}
      server_host: ${{ needs.parse-secrets.outputs.server_host }}
      server_user: ${{ needs.parse-secrets.outputs.server_user }}
      server_key: ${{ needs.parse-secrets.outputs.server_key }}
      server_port: ${{ needs.parse-secrets.outputs.server_port }}

  # 步骤7: 测试网站 - 静态项目（可选）
  test-website-static:
    needs: [parse-secrets, deploy-project, configure-nginx]
    if: ${{ inputs.test_url != '' && inputs.deploy_type == 'static' }}
    uses: MoseLu/axi-deploy/.github/workflows/test-website.yml@master
    with:
      project: ${{ inputs.project }}
      test_url: ${{ inputs.test_url }}
      deploy_type: ${{ inputs.deploy_type }}
      server_host: ${{ needs.parse-secrets.outputs.server_host }}
      server_user: ${{ needs.parse-secrets.outputs.server_user }}
      server_key: ${{ needs.parse-secrets.outputs.server_key }}
      server_port: ${{ needs.parse-secrets.outputs.server_port }}
      apps_root: "/srv/apps"
      static_root: "/srv/static"
      nginx_conf_dir: "/www/server/nginx/conf/conf.d/redamancy"

  # 步骤8: 测试网站 - 后端项目（可选）
  test-website-backend:
    needs: [parse-secrets, deploy-project, configure-nginx, start-service]
    if: ${{ inputs.test_url != '' && inputs.deploy_type == 'backend' }}
    uses: MoseLu/axi-deploy/.github/workflows/test-website.yml@master
    with:
      project: ${{ inputs.project }}
      test_url: ${{ inputs.test_url }}
      deploy_type: ${{ inputs.deploy_type }}
      server_host: ${{ needs.parse-secrets.outputs.server_host }}
      server_user: ${{ needs.parse-secrets.outputs.server_user }}
      server_key: ${{ needs.parse-secrets.outputs.server_key }}
      server_port: ${{ needs.parse-secrets.outputs.server_port }}
      apps_root: "/srv/apps"
      static_root: "/srv/static"
      nginx_conf_dir: "/www/server/nginx/conf/conf.d/redamancy"

  # 步骤9: 部署完成总结
  deployment-summary:
    needs: [parse-secrets, server-init, validate-artifact, deploy-project, configure-nginx, start-service, test-website-static, test-website-backend]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: 部署完成总结
        run: |
          echo "🎉 部署流程完成"
          echo "=========================================="
          echo "📋 部署信息:"
          echo "- 项目: ${{ inputs.project }}"
          echo "- 部署类型: ${{ inputs.deploy_type }}"
          echo "- 源仓库: ${{ inputs.source_repo }}"
          echo "- 构建ID: ${{ inputs.run_id }}"
          echo ""
          echo "📊 执行状态:"
          echo "- 解析密钥: ${{ needs.parse-secrets.result }}"
          echo "- 服务器初始化: ${{ needs.server-init.result || 'skipped' }}"
          echo "- 验证构建产物: ${{ needs.validate-artifact.result }}"
          echo "- 部署项目: ${{ needs.deploy-project.result }}"
          echo "- 配置Nginx: ${{ needs.configure-nginx.result || 'skipped' }}"
          echo "- 启动服务: ${{ needs.start-service.result || 'skipped' }}"
          echo "- 测试网站(静态): ${{ needs.test-website-static.result || 'skipped' }}"
          echo "- 测试网站(后端): ${{ needs.test-website-backend.result || 'skipped' }}"
          echo ""
          echo "🔗 访问信息:"
          echo "- 域名: redamancy.com.cn"
          if [ "${{ needs.deploy-project.outputs.deploy_path }}" != "" ]; then
            echo "- 项目路径: ${{ needs.deploy-project.outputs.deploy_path }}"
          fi
          if [ "${{ inputs.test_url }}" != "" ]; then
            echo "- 测试URL: ${{ inputs.test_url }}"
          fi
          echo ""
          echo "📝 部署完成通知:"
          echo "✅ 项目 ${{ inputs.project }} 已成功部署到服务器"
          if [ "${{ inputs.test_url }}" != "" ]; then
            echo "🌐 可通过 ${{ inputs.test_url }} 访问"
          fi
          echo "=========================================="