name: Main Deployment

description: "ä¸»éƒ¨ç½²å·¥ä½œæµ - æ•´ä¸ªéƒ¨ç½²æµç¨‹çš„å…¥å£ç‚¹"

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'é¡¹ç›®åç§°'
        required: true
        type: string
      source_repo:
        description: 'æºä»“åº“ (æ ¼å¼: owner/repo)'
        required: true
        type: string
      run_id:
        description: 'æ„å»ºè¿è¡ŒID'
        required: true
        type: string
      deploy_type:
        description: 'éƒ¨ç½²ç±»å‹'
        required: true
        default: 'static'
        type: choice
        options:
          - static
          - backend
      nginx_config:
        description: 'Nginxé…ç½®ï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      test_url:
        description: 'æµ‹è¯•URLï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      start_cmd:
        description: 'å¯åŠ¨å‘½ä»¤ï¼ˆåç«¯é¡¹ç›®ï¼‰'
        required: false
        type: string
      server_host:
        description: 'æœåŠ¡å™¨ä¸»æœºåœ°å€'
        required: true
        type: string
      server_port:
        description: 'æœåŠ¡å™¨ç«¯å£'
        required: true
        type: string
      server_user:
        description: 'æœåŠ¡å™¨ç”¨æˆ·å'
        required: true
        type: string
      server_key:
        description: 'æœåŠ¡å™¨SSHå¯†é’¥'
        required: true
        type: string
      deploy_center_pat:
        description: 'GitHub Tokenï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨å†…ç½®Tokenï¼‰'
        required: false
        type: string
      skip_init:
        description: 'è·³è¿‡æœåŠ¡å™¨åˆå§‹åŒ–æ­¥éª¤'
        required: false
        type: boolean
        default: false

jobs:
  # æ­¥éª¤1: éªŒè¯æ„å»ºäº§ç‰©å¯ç”¨æ€§
  validate-artifact:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      packages: read
    outputs:
      artifact_available: ${{ steps.check-artifact.outputs.available }}
      artifact_info: ${{ steps.check-artifact.outputs.info }}
      run_id: ${{ steps.check-artifact.outputs.run_id }}
    
    steps:
      - name: éªŒè¯æ„å»ºäº§ç‰©å¯ç”¨æ€§
        id: check-artifact
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºäº§ç‰©å¯ç”¨æ€§..."
          echo "é¡¹ç›®åç§°: ${{ inputs.project }}"
          echo "æºä»“åº“: ${{ inputs.source_repo }}"
          echo "æœŸæœ›çš„æ„å»ºäº§ç‰©åç§°: dist-${{ inputs.project }}"
          echo ""
          
          # ç¡®å®šä½¿ç”¨çš„GitHub Token
          if [ -n "${{ inputs.deploy_center_pat }}" ] && [ "${{ inputs.deploy_center_pat }}" != "null" ]; then
            GITHUB_TOKEN="${{ inputs.deploy_center_pat }}"
            echo "âœ… ä½¿ç”¨å¤–éƒ¨æä¾›çš„GitHub Token"
          else
            GITHUB_TOKEN="${{ github.token }}"
            echo "âœ… ä½¿ç”¨å†…ç½®GITHUB_TOKEN"
          fi
          
          echo "ğŸ“‹ è·å–æœ€è¿‘ä¸€æ¬¡æˆåŠŸçš„æ„å»ºäº§ç‰©..."
          
          # è·å–æœ€è¿‘ä¸€æ¬¡æˆåŠŸçš„workflow run
          RUNS_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ inputs.source_repo }}/actions/runs?per_page=10" 2>/dev/null || echo "APIè°ƒç”¨å¤±è´¥")
          
          echo "ğŸ” APIå“åº”è°ƒè¯•ä¿¡æ¯:"
          echo "å“åº”é•¿åº¦: $(echo "$RUNS_RESPONSE" | wc -c)"
          echo "å“åº”å‰200å­—ç¬¦:"
          echo "$RUNS_RESPONSE" | head -c 200
          echo ""
          
          # æ£€æŸ¥APIå“åº”æ˜¯å¦åŒ…å«é”™è¯¯
          if echo "$RUNS_RESPONSE" | grep -q '"message"'; then
            ERROR_MSG=$(echo "$RUNS_RESPONSE" | jq -r '.message // empty' 2>/dev/null)
            if [ -n "$ERROR_MSG" ]; then
              echo "âŒ APIè°ƒç”¨å¤±è´¥:"
              echo "$ERROR_MSG"
              echo "available=false" >> $GITHUB_OUTPUT
              echo "info=APIè°ƒç”¨å¤±è´¥" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi
          
          echo "ğŸ“Š æœ€è¿‘çš„æ„å»ºè®°å½•:"
          if echo "$RUNS_RESPONSE" | jq -e '.workflow_runs' >/dev/null 2>&1; then
            echo "$RUNS_RESPONSE" | jq -r '.workflow_runs[] | "ID: \(.id), çŠ¶æ€: \(.status), ç»“è®º: \(.conclusion), æ—¶é—´: \(.created_at)"' 2>/dev/null || echo "æ— æ³•è§£ææ„å»ºè®°å½•"
          else
            echo "æ— æ³•è§£ææ„å»ºè®°å½•å“åº”"
            echo "å“åº”å†…å®¹: $RUNS_RESPONSE"
          fi
          
          # è·å–æœ€è¿‘ä¸€æ¬¡æˆåŠŸçš„run ID
          if echo "$RUNS_RESPONSE" | jq -e '.workflow_runs' >/dev/null 2>&1; then
            LATEST_RUN_ID=$(echo "$RUNS_RESPONSE" | jq -r '.workflow_runs[] | select(.conclusion == "success") | .id' 2>/dev/null | head -1)
          else
            LATEST_RUN_ID=""
          fi
          
          if [ "$LATEST_RUN_ID" = "null" ] || [ -z "$LATEST_RUN_ID" ]; then
            echo "âŒ æœªæ‰¾åˆ°æˆåŠŸçš„æ„å»ºè®°å½•"
            echo "ğŸ” è°ƒè¯•ä¿¡æ¯:"
            echo "- Tokené•¿åº¦: $(echo "$GITHUB_TOKEN" | wc -c)"
            echo "- Tokenå‰10å­—ç¬¦: ${GITHUB_TOKEN:0:10}..."
            echo "- æºä»“åº“: ${{ inputs.source_repo }}"
            echo "- API URL: https://api.github.com/repos/${{ inputs.source_repo }}/actions/runs?per_page=10"
            echo ""
            echo "ğŸ”§ å¯èƒ½çš„åŸå› :"
            echo "1. GitHub Tokenæƒé™ä¸è¶³"
            echo "2. æºä»“åº“æ²¡æœ‰æˆåŠŸçš„æ„å»ºè®°å½•"
            echo "3. APIè°ƒç”¨å¤±è´¥"
            echo "4. ç½‘ç»œè¿æ¥é—®é¢˜"
            echo ""
            echo "ğŸ” å»ºè®®æ£€æŸ¥:"
            echo "1. è®¿é—® https://github.com/${{ inputs.source_repo }}/actions"
            echo "2. ç¡®è®¤æœ‰æˆåŠŸçš„æ„å»ºè®°å½•"
            echo "3. æ£€æŸ¥Tokenæƒé™"
            echo "available=false" >> $GITHUB_OUTPUT
            echo "info=æœªæ‰¾åˆ°æˆåŠŸçš„æ„å»ºè®°å½•" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ°æœ€è¿‘çš„æˆåŠŸæ„å»ºï¼Œè¿è¡ŒID: $LATEST_RUN_ID"
          echo "ğŸ” æ„å»ºæ—¶é—´ä¿¡æ¯:"
          echo "$RUNS_RESPONSE" | jq -r '.workflow_runs[] | select(.id == '$LATEST_RUN_ID') | "åˆ›å»ºæ—¶é—´: \(.created_at), æ›´æ–°æ—¶é—´: \(.updated_at)"' 2>/dev/null || echo "æ— æ³•è·å–æ—¶é—´ä¿¡æ¯"
          
          # æ£€æŸ¥è¯¥runçš„æ„å»ºäº§ç‰©
          ARTIFACTS_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ inputs.source_repo }}/actions/runs/$LATEST_RUN_ID/artifacts" 2>/dev/null || echo "APIè°ƒç”¨å¤±è´¥")
          
          echo "ğŸ“¦ æ„å»ºäº§ç‰©åˆ—è¡¨:"
          if echo "$ARTIFACTS_RESPONSE" | jq -e '.artifacts' >/dev/null 2>&1; then
            echo "$ARTIFACTS_RESPONSE" | jq -r '.artifacts[] | "åç§°: \(.name), å¤§å°: \(.size_in_bytes) bytes"' 2>/dev/null || echo "æ— æ³•è§£ææ„å»ºäº§ç‰©"
          else
            echo "æ— æ³•è§£ææ„å»ºäº§ç‰©å“åº”"
            echo "å“åº”å†…å®¹: $ARTIFACTS_RESPONSE"
          fi
          
          # æ£€æŸ¥æ˜¯å¦åŒ…å«ç›®æ ‡æ„å»ºäº§ç‰©
          if echo "$ARTIFACTS_RESPONSE" | grep -q "dist-${{ inputs.project }}"; then
            echo "âœ… æ‰¾åˆ°æ„å»ºäº§ç‰©: dist-${{ inputs.project }}"
            echo "available=true" >> $GITHUB_OUTPUT
            echo "info=æ„å»ºäº§ç‰©å¯ç”¨" >> $GITHUB_OUTPUT
            echo "run_id=$LATEST_RUN_ID" >> $GITHUB_OUTPUT
          else
            echo "âŒ æœªæ‰¾åˆ°æ„å»ºäº§ç‰©: dist-${{ inputs.project }}"
            echo "ğŸ” å¯ç”¨çš„æ„å»ºäº§ç‰©:"
            if echo "$ARTIFACTS_RESPONSE" | jq -e '.artifacts' >/dev/null 2>&1; then
              echo "$ARTIFACTS_RESPONSE" | jq -r '.artifacts[].name' 2>/dev/null || echo "æ— æ³•è§£ææ„å»ºäº§ç‰©åç§°"
            else
              echo "$ARTIFACTS_RESPONSE" | grep -o '"name":"[^"]*"' | head -10 || echo "æ— æ³•è§£ææ„å»ºäº§ç‰©"
            fi
            echo "available=false" >> $GITHUB_OUTPUT
            echo "info=æ„å»ºäº§ç‰©ä¸å¯ç”¨" >> $GITHUB_OUTPUT
            echo ""
            echo "ğŸš¨ æ„å»ºäº§ç‰©éªŒè¯å¤±è´¥ï¼Œç»ˆæ­¢éƒ¨ç½²"
            echo "ğŸ”§ è§£å†³æ–¹æ¡ˆ:"
            echo "1. é‡æ–°è§¦å‘æºä»“åº“çš„æ„å»ºå·¥ä½œæµ"
            echo "2. æ£€æŸ¥æ„å»ºäº§ç‰©åç§°æ˜¯å¦æ­£ç¡®"
            echo "3. ç¡®è®¤æ„å»ºæ˜¯å¦æˆåŠŸå®Œæˆ"
            exit 1
          fi



  # æ­¥éª¤2: æœåŠ¡å™¨åˆå§‹åŒ–ï¼ˆå¯é€‰ï¼Œä½¿ç”¨å¯å¤ç”¨å·¥ä½œæµï¼‰
  server-init:
    needs: [validate-artifact]
    if: ${{ inputs.skip_init != 'true' }}
    uses: MoseLu/axi-deploy/.github/workflows/server-init.yml@master
    with:
      server_host: ${{ inputs.server_host }}
      server_user: ${{ inputs.server_user }}
      server_key: ${{ inputs.server_key }}
      server_port: ${{ inputs.server_port }}

  # æ­¥éª¤3: éƒ¨ç½²é¡¹ç›®
  deploy-project:
    needs: [validate-artifact]
    uses: MoseLu/axi-deploy/.github/workflows/deploy-project.yml@master
    with:
      project: ${{ inputs.project }}
      source_repo: ${{ inputs.source_repo }}
      run_id: ${{ needs.validate-artifact.outputs.run_id }}
      deploy_type: ${{ inputs.deploy_type }}
      server_host: ${{ inputs.server_host }}
      server_user: ${{ inputs.server_user }}
      server_key: ${{ inputs.server_key }}
      server_port: ${{ inputs.server_port }}
      deploy_center_pat: ${{ inputs.deploy_center_pat || '' }}

  # æ­¥éª¤4: é…ç½®Nginxï¼ˆå¯é€‰ï¼‰
  configure-nginx:
    needs: [deploy-project]
    if: ${{ inputs.nginx_config != '' }}
    uses: MoseLu/axi-deploy/.github/workflows/configure-nginx.yml@master
    with:
      project: ${{ inputs.project }}
      server_host: ${{ inputs.server_host }}
      server_user: ${{ inputs.server_user }}
      server_key: ${{ inputs.server_key }}
      server_port: ${{ inputs.server_port }}
      deploy_type: ${{ inputs.deploy_type }}
      nginx_config: ${{ inputs.nginx_config }}

  # æ­¥éª¤5: å¯åŠ¨æœåŠ¡ï¼ˆå¯é€‰ï¼Œä»…åç«¯é¡¹ç›®ï¼‰
  start-service:
    needs: [deploy-project]
    if: ${{ inputs.start_cmd != '' && inputs.deploy_type == 'backend' }}
    uses: MoseLu/axi-deploy/.github/workflows/start-service.yml@master
    with:
      project: ${{ inputs.project }}
      start_cmd: ${{ inputs.start_cmd }}
      deploy_type: ${{ inputs.deploy_type }}
      server_host: ${{ inputs.server_host }}
      server_user: ${{ inputs.server_user }}
      server_key: ${{ inputs.server_key }}
      server_port: ${{ inputs.server_port }}

  # æ­¥éª¤6: æµ‹è¯•ç½‘ç«™ï¼ˆå¯é€‰ï¼‰
  test-website:
    needs: [deploy-project, configure-nginx, start-service]
    if: ${{ inputs.test_url != '' }}
    uses: MoseLu/axi-deploy/.github/workflows/test-website.yml@master
    with:
      project: ${{ inputs.project }}
      test_url: ${{ inputs.test_url }}
      deploy_type: ${{ inputs.deploy_type }}
      server_host: ${{ inputs.server_host }}
      server_user: ${{ inputs.server_user }}
      server_key: ${{ inputs.server_key }}
      server_port: ${{ inputs.server_port }}

  # æ­¥éª¤7: éƒ¨ç½²å®Œæˆæ€»ç»“
  deployment-summary:
    needs: [server-init, validate-artifact, deploy-project, configure-nginx, start-service, test-website]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: éƒ¨ç½²å®Œæˆæ€»ç»“
        run: |
          echo "ğŸ‰ éƒ¨ç½²æµç¨‹å®Œæˆ"
          echo "=========================================="
          echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯:"
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- éƒ¨ç½²ç±»å‹: ${{ inputs.deploy_type }}"
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- æ„å»ºID: ${{ inputs.run_id }}"
          echo ""
          echo "ğŸ“Š æ‰§è¡ŒçŠ¶æ€:"
          echo "- æœåŠ¡å™¨åˆå§‹åŒ–: ${{ needs.server-init.result || 'skipped' }}"
          echo "- éªŒè¯æ„å»ºäº§ç‰©: ${{ needs.validate-artifact.result }}"
          echo "- éƒ¨ç½²é¡¹ç›®: ${{ needs.deploy-project.result }}"
          echo "- é…ç½®Nginx: ${{ needs.configure-nginx.result || 'skipped' }}"
          echo "- å¯åŠ¨æœåŠ¡: ${{ needs.start-service.result || 'skipped' }}"
          echo "- æµ‹è¯•ç½‘ç«™: ${{ needs.test-website.result || 'skipped' }}"
          echo ""
          echo "ğŸ”— è®¿é—®ä¿¡æ¯:"
          echo "- åŸŸå: redamancy.com.cn"
          if [ "${{ needs.deploy-project.outputs.deploy_path }}" != "" ]; then
            echo "- é¡¹ç›®è·¯å¾„: ${{ needs.deploy-project.outputs.deploy_path }}"
          fi
          if [ "${{ inputs.test_url }}" != "" ]; then
            echo "- æµ‹è¯•URL: ${{ inputs.test_url }}"
          fi
          echo ""
          echo "ğŸ“ éƒ¨ç½²å®Œæˆé€šçŸ¥:"
          echo "âœ… é¡¹ç›® ${{ inputs.project }} å·²æˆåŠŸéƒ¨ç½²åˆ°æœåŠ¡å™¨"
          if [ "${{ inputs.test_url }}" != "" ]; then
            echo "ğŸŒ å¯é€šè¿‡ ${{ inputs.test_url }} è®¿é—®"
          fi
          echo "=========================================="