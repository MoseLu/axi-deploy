name: Main Deployment

description: "ä¸»éƒ¨ç½²å·¥ä½œæµ - æ•´ä¸ªéƒ¨ç½²æµç¨‹çš„å…¥å£ç‚¹"



on:
  workflow_dispatch:
    inputs:
      project:
        description: 'é¡¹ç›®åç§°'
        required: true
        type: string
      source_repo:
        description: 'æºä»“åº“ (æ ¼å¼: owner/repo)'
        required: true
        type: string
      run_id:
        description: 'æ„å»ºè¿è¡ŒID'
        required: true
        type: string
      deploy_type:
        description: 'éƒ¨ç½²ç±»å‹'
        required: true
        default: 'static'
        type: choice
        options:
          - static
          - backend
      deploy_secrets:
        description: 'éƒ¨ç½²å¯†é’¥ (JSONæ ¼å¼æˆ–base64ç¼–ç çš„JSON: {"SERVER_HOST":"host","SERVER_PORT":"port","SERVER_USER":"user","SERVER_KEY":"key","DEPLOY_CENTER_PAT":"pat"})ï¼ŒDEPLOY_CENTER_PATå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨å†…ç½®Token'
        required: true
        type: string
      deploy_config:
        description: 'éƒ¨ç½²é…ç½® (base64ç¼–ç çš„JSON: {"nginx_config":"...","test_url":"...","start_cmd":"...","service_port":"...","mysql_config":"...","skip_init":false})'
        required: false
        type: string

jobs:
  # æ­¥éª¤1: éªŒè¯æ„å»ºäº§ç‰©å¯ç”¨æ€§
  validate-artifact:
    uses: MoseLu/axi-deploy/.github/workflows/validate-artifact.yml@master
    with:
      # é¡¹ç›®åç§°
      project: ${{ inputs.project }}
      # æºä»“åº“ (æ ¼å¼: owner/repo)
      source_repo: ${{ inputs.source_repo }}
      # éƒ¨ç½²å¯†é’¥ (JSONæ ¼å¼æˆ–base64ç¼–ç çš„JSON)
      deploy_secrets: ${{ inputs.deploy_secrets }}

  # æ­¥éª¤2: è§£æéƒ¨ç½²å¯†é’¥
  parse-secrets:
    needs: [validate-artifact]
    uses: MoseLu/axi-deploy/.github/workflows/parse-secrets.yml@master
    with:
      # éƒ¨ç½²å¯†é’¥ (JSONæ ¼å¼æˆ–base64ç¼–ç çš„JSON)
      deploy_secrets: ${{ inputs.deploy_secrets }}

  # æ­¥éª¤2.5: è§£æéƒ¨ç½²é…ç½®
  parse-deploy-config:
    needs: [validate-artifact]
    runs-on: ubuntu-latest
    outputs:
      nginx_config: ${{ steps.parse-config.outputs.nginx_config }}
      test_url: ${{ steps.parse-config.outputs.test_url }}
      start_cmd: ${{ steps.parse-config.outputs.start_cmd }}
      service_port: ${{ steps.parse-config.outputs.service_port }}
      mysql_config: ${{ steps.parse-config.outputs.mysql_config }}
      skip_init: ${{ steps.parse-config.outputs.skip_init }}
    steps:
      - name: è§£æéƒ¨ç½²é…ç½®
        id: parse-config
        run: |
          if [ -n "${{ inputs.deploy_config }}" ]; then
            echo "ğŸ” è§£æéƒ¨ç½²é…ç½®..."
            DEPLOY_CONFIG_JSON=$(echo "${{ inputs.deploy_config }}" | base64 -d)
            echo "ğŸ“„ éƒ¨ç½²é…ç½®: $DEPLOY_CONFIG_JSON"
            
            # æå–å„ä¸ªå‚æ•°
            NGINX_CONFIG=$(echo "$DEPLOY_CONFIG_JSON" | jq -r '.nginx_config // ""')
            TEST_URL=$(echo "$DEPLOY_CONFIG_JSON" | jq -r '.test_url // ""')
            START_CMD=$(echo "$DEPLOY_CONFIG_JSON" | jq -r '.start_cmd // ""')
            SERVICE_PORT=$(echo "$DEPLOY_CONFIG_JSON" | jq -r '.service_port // ""')
            MYSQL_CONFIG=$(echo "$DEPLOY_CONFIG_JSON" | jq -r '.mysql_config // ""')
            SKIP_INIT=$(echo "$DEPLOY_CONFIG_JSON" | jq -r '.skip_init // false')
            
            # å°† Nginx é…ç½®è½¬æ¢ä¸º base64 ç¼–ç ï¼Œé¿å…å¤šè¡Œæ–‡æœ¬é—®é¢˜
            if [ -n "$NGINX_CONFIG" ]; then
              NGINX_CONFIG_B64=$(echo "$NGINX_CONFIG" | base64 -w 0)
            else
              NGINX_CONFIG_B64=""
            fi
            
            echo "nginx_config=$NGINX_CONFIG_B64" >> $GITHUB_OUTPUT
            echo "test_url=$TEST_URL" >> $GITHUB_OUTPUT
            echo "start_cmd=$START_CMD" >> $GITHUB_OUTPUT
            echo "service_port=$SERVICE_PORT" >> $GITHUB_OUTPUT
            echo "mysql_config=$MYSQL_CONFIG" >> $GITHUB_OUTPUT
            echo "skip_init=$SKIP_INIT" >> $GITHUB_OUTPUT
            
            echo "âœ… éƒ¨ç½²é…ç½®è§£æå®Œæˆ"
          else
            echo "ğŸ“‹ æœªæä¾›éƒ¨ç½²é…ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼"
            echo "nginx_config=" >> $GITHUB_OUTPUT
            echo "test_url=" >> $GITHUB_OUTPUT
            echo "start_cmd=" >> $GITHUB_OUTPUT
            echo "service_port=" >> $GITHUB_OUTPUT
            echo "mysql_config=" >> $GITHUB_OUTPUT
            echo "skip_init=false" >> $GITHUB_OUTPUT
          fi

  # æ­¥éª¤3: æœåŠ¡å™¨åˆå§‹åŒ–ï¼ˆå¯é€‰ï¼Œä½¿ç”¨å¯å¤ç”¨å·¥ä½œæµï¼‰
  server-init:
    needs: [parse-secrets, validate-artifact, parse-deploy-config]
    if: ${{ needs.parse-deploy-config.outputs.skip_init != 'true' }}
    uses: MoseLu/axi-deploy/.github/workflows/server-init.yml@master
    with:
      # æœåŠ¡å™¨é…ç½®
      server_host: ${{ needs.parse-secrets.outputs.server_host }}
      server_user: ${{ needs.parse-secrets.outputs.server_user }}
      server_key: ${{ needs.parse-secrets.outputs.server_key }}
      server_port: ${{ needs.parse-secrets.outputs.server_port }}


  # æ­¥éª¤4: åŠ¨æ€ç«¯å£åˆ†é…ï¼ˆä»…åç«¯é¡¹ç›®ï¼‰
  dynamic-port-allocation:
    needs: [parse-secrets, validate-artifact, parse-deploy-config]
    if: ${{ inputs.deploy_type == 'backend' }}
    uses: ./.github/workflows/dynamic-port-allocation.yml
    with:
      # é¡¹ç›®åç§°
      project: ${{ inputs.project }}
      # æœåŠ¡å™¨é…ç½®
      server_host: ${{ needs.parse-secrets.outputs.server_host }}
      server_user: ${{ needs.parse-secrets.outputs.server_user }}
      server_key: ${{ needs.parse-secrets.outputs.server_key }}
      server_port: ${{ needs.parse-secrets.outputs.server_port }}
      # ç«¯å£èŒƒå›´
      port_range_start: "8080"
      port_range_end: "10000"
      # é¦–é€‰ç«¯å£ï¼ˆä»é…ç½®ä¸­è·å–ï¼‰
      preferred_port: ${{ needs.parse-deploy-config.outputs.service_port || '' }}

  # æ­¥éª¤5: éƒ¨ç½²é¡¹ç›®
  deploy-project:
    needs: [parse-secrets, validate-artifact, parse-deploy-config, dynamic-port-allocation]
    uses: MoseLu/axi-deploy/.github/workflows/deploy-project.yml@master
    with:
      # é¡¹ç›®åç§°
      project: ${{ inputs.project }}
      # æºä»“åº“ (æ ¼å¼: owner/repo)
      source_repo: ${{ inputs.source_repo }}
      # æ„å»ºè¿è¡ŒID
      run_id: ${{ needs.validate-artifact.outputs.run_id }}
      # éƒ¨ç½²ç±»å‹ (backend/static)
      deploy_type: ${{ inputs.deploy_type }}
      # æœåŠ¡å™¨é…ç½®
      server_host: ${{ needs.parse-secrets.outputs.server_host }}
      server_user: ${{ needs.parse-secrets.outputs.server_user }}
      server_key: ${{ needs.parse-secrets.outputs.server_key }}
      server_port: ${{ needs.parse-secrets.outputs.server_port }}
      # GitHub Token (å¯é€‰)
      deploy_center_pat: ${{ needs.parse-secrets.outputs.deploy_center_pat || '' }}
      # MySQL é…ç½®ï¼ˆå¯é€‰ï¼‰
      mysql_config: ${{ needs.parse-deploy-config.outputs.mysql_config || '' }}

  # æ­¥éª¤5: é…ç½®Nginxï¼ˆå¯é€‰ï¼‰
  configure-nginx:
    needs: [parse-secrets, deploy-project, parse-deploy-config]
    if: ${{ needs.parse-deploy-config.outputs.nginx_config != '' }}
    uses: MoseLu/axi-deploy/.github/workflows/configure-nginx.yml@master
    with:
      # é¡¹ç›®åç§°
      project: ${{ inputs.project }}
      # æœåŠ¡å™¨é…ç½®
      server_host: ${{ needs.parse-secrets.outputs.server_host }}
      server_user: ${{ needs.parse-secrets.outputs.server_user }}
      server_key: ${{ needs.parse-secrets.outputs.server_key }}
      server_port: ${{ needs.parse-secrets.outputs.server_port }}
      # éƒ¨ç½²ç±»å‹
      deploy_type: ${{ inputs.deploy_type }}
      # Nginxé…ç½®
      nginx_config: ${{ needs.parse-deploy-config.outputs.nginx_config }}

  # æ­¥éª¤6: å¯åŠ¨æœåŠ¡ï¼ˆå¯é€‰ï¼Œä»…åç«¯é¡¹ç›®ï¼‰
  start-service:
    needs: [parse-secrets, deploy-project, configure-nginx, parse-deploy-config, dynamic-port-allocation]
    if: ${{ needs.parse-deploy-config.outputs.start_cmd != '' && inputs.deploy_type == 'backend' }}
    uses: MoseLu/axi-deploy/.github/workflows/start-service.yml@master
    with:
      # é¡¹ç›®åç§°
      project: ${{ inputs.project }}
      # å¯åŠ¨å‘½ä»¤
      start_cmd: ${{ needs.parse-deploy-config.outputs.start_cmd }}
      # éƒ¨ç½²ç±»å‹
      deploy_type: ${{ inputs.deploy_type }}
      # æœåŠ¡ç«¯å£ï¼ˆä¼˜å…ˆä½¿ç”¨åŠ¨æ€åˆ†é…çš„ç«¯å£ï¼‰
      service_port: ${{ needs.dynamic-port-allocation.outputs.allocated_port || needs.parse-deploy-config.outputs.service_port || '' }}
      # æœåŠ¡å™¨é…ç½®
      server_host: ${{ needs.parse-secrets.outputs.server_host }}
      server_user: ${{ needs.parse-secrets.outputs.server_user }}
      server_key: ${{ needs.parse-secrets.outputs.server_key }}
      server_port: ${{ needs.parse-secrets.outputs.server_port }}

  # æ­¥éª¤7: æµ‹è¯•ç½‘ç«™ - é™æ€é¡¹ç›®ï¼ˆå¯é€‰ï¼‰
  test-website-static:
    needs: [parse-secrets, deploy-project, configure-nginx, parse-deploy-config]
    if: ${{ needs.parse-deploy-config.outputs.test_url != '' && inputs.deploy_type == 'static' }}
    uses: MoseLu/axi-deploy/.github/workflows/test-website.yml@master
    with:
      # é¡¹ç›®åç§°
      project: ${{ inputs.project }}
      # æµ‹è¯•URL
      test_url: ${{ needs.parse-deploy-config.outputs.test_url }}
      # éƒ¨ç½²ç±»å‹
      deploy_type: ${{ inputs.deploy_type }}
      # æœåŠ¡å™¨é…ç½®
      server_host: ${{ needs.parse-secrets.outputs.server_host }}
      server_user: ${{ needs.parse-secrets.outputs.server_user }}
      server_key: ${{ needs.parse-secrets.outputs.server_key }}
      server_port: ${{ needs.parse-secrets.outputs.server_port }}
      # éƒ¨ç½²è·¯å¾„é…ç½®
      apps_root: "/srv/apps"
      static_root: "/srv/static"
      nginx_conf_dir: "/www/server/nginx/conf/conf.d/redamancy"

  # æ­¥éª¤8: æµ‹è¯•ç½‘ç«™ - åç«¯é¡¹ç›®ï¼ˆå¯é€‰ï¼‰
  test-website-backend:
    needs: [parse-secrets, deploy-project, configure-nginx, start-service, parse-deploy-config]
    if: ${{ needs.parse-deploy-config.outputs.test_url != '' && inputs.deploy_type == 'backend' }}
    uses: MoseLu/axi-deploy/.github/workflows/test-website.yml@master
    with:
      # é¡¹ç›®åç§°
      project: ${{ inputs.project }}
      # æµ‹è¯•URL
      test_url: ${{ needs.parse-deploy-config.outputs.test_url }}
      # éƒ¨ç½²ç±»å‹
      deploy_type: ${{ inputs.deploy_type }}
      # æœåŠ¡å™¨é…ç½®
      server_host: ${{ needs.parse-secrets.outputs.server_host }}
      server_user: ${{ needs.parse-secrets.outputs.server_user }}
      server_key: ${{ needs.parse-secrets.outputs.server_key }}
      server_port: ${{ needs.parse-secrets.outputs.server_port }}
      # éƒ¨ç½²è·¯å¾„é…ç½®
      apps_root: "/srv/apps"
      static_root: "/srv/static"
      nginx_conf_dir: "/www/server/nginx/conf/conf.d/redamancy"

  # æ­¥éª¤9: éƒ¨ç½²å®Œæˆæ€»ç»“
  deployment-summary:
    needs: [parse-secrets, server-init, validate-artifact, deploy-project, configure-nginx, start-service, test-website-static, test-website-backend, parse-deploy-config]
    if: always()
    uses: MoseLu/axi-deploy/.github/workflows/deployment-summary.yml@master
    with:
      # é¡¹ç›®ä¿¡æ¯
      project: ${{ inputs.project }}
      deploy_type: ${{ inputs.deploy_type }}
      source_repo: ${{ inputs.source_repo }}
      run_id: ${{ inputs.run_id }}
      # æµ‹è¯•ä¿¡æ¯
      test_url: ${{ needs.parse-deploy-config.outputs.test_url }}
      # éƒ¨ç½²è·¯å¾„
      deploy_path: ${{ needs.deploy-project.outputs.deploy_path || '' }}
      # å„æ­¥éª¤æ‰§è¡Œç»“æœ
      parse_secrets_result: ${{ needs.parse-secrets.result }}
      server_init_result: ${{ needs.server-init.result || '' }}
      validate_artifact_result: ${{ needs.validate-artifact.result }}
      deploy_project_result: ${{ needs.deploy-project.result }}
      configure_nginx_result: ${{ needs.configure-nginx.result || '' }}
      start_service_result: ${{ needs.start-service.result || '' }}
      test_website_static_result: ${{ needs.test-website-static.result || '' }}
      test_website_backend_result: ${{ needs.test-website-backend.result || '' }}