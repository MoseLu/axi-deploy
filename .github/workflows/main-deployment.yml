name: Main Deployment

description: "ä¸»éƒ¨ç½²å·¥ä½œæµ - æ•´ä¸ªéƒ¨ç½²æµç¨‹çš„å…¥å£ç‚¹"

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'é¡¹ç›®åç§°'
        required: true
        type: string
      source_repo:
        description: 'æºä»“åº“ (æ ¼å¼: owner/repo)'
        required: true
        type: string
      run_id:
        description: 'æ„å»ºè¿è¡ŒID'
        required: true
        type: string
      deploy_type:
        description: 'éƒ¨ç½²ç±»å‹'
        required: true
        default: 'static'
        type: choice
        options:
          - static
          - backend
      nginx_config:
        description: 'Nginxé…ç½®ï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      start_cmd:
        description: 'å¯åŠ¨å‘½ä»¤ï¼ˆåç«¯é¡¹ç›®ï¼‰'
        required: false
        type: string
      server_host:
        description: 'æœåŠ¡å™¨åœ°å€'
        required: true
        type: string
      server_user:
        description: 'æœåŠ¡å™¨ç”¨æˆ·'
        required: true
        type: string
      server_key:
        description: 'æœåŠ¡å™¨å¯†é’¥'
        required: true
        type: string
      server_port:
        description: 'æœåŠ¡å™¨ç«¯å£'
        required: true
        type: string

jobs:
  download-artifact:
    runs-on: ubuntu-latest
    outputs:
      artifact_path: ${{ steps.set-outputs.outputs.artifact_path }}
      artifact_size: ${{ steps.set-outputs.outputs.artifact_size }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        id: download
        uses: dawidd6/action-download-artifact@v2
        with:
          name: dist-${{ inputs.project }}
          path: ./
          repo: ${{ inputs.source_repo }}
          workflow: ${{ inputs.project }}_deploy.yml
          run_id: ${{ inputs.run_id }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: éªŒè¯æ„å»ºäº§ç‰©
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºäº§ç‰©..."
          
          # æ£€æŸ¥å¯èƒ½çš„æ„å»ºäº§ç‰©ç›®å½•
          if [ -d "./dist" ]; then
            ARTIFACT_DIR="./dist"
          elif [ -d "./dist-${{ inputs.project }}" ]; then
            ARTIFACT_DIR="./dist-${{ inputs.project }}"
          elif [ -d "./docs/.vitepress/dist" ]; then
            ARTIFACT_DIR="./docs/.vitepress/dist"
          else
            # æ„å»ºäº§ç‰©ç›´æ¥åœ¨å½“å‰ç›®å½•
            ARTIFACT_DIR="."
            echo "ğŸ“ æ„å»ºäº§ç‰©ç›´æ¥åœ¨å½“å‰ç›®å½•"
          fi
          
          echo "ğŸ“ æ„å»ºäº§ç‰©ç›®å½•: $ARTIFACT_DIR"
          echo "ğŸ“ æ„å»ºäº§ç‰©ç›®å½•å†…å®¹:"
          ls -la "$ARTIFACT_DIR/"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
          FILE_COUNT=$(find "$ARTIFACT_DIR" -type f | wc -l)
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "âŒ æ„å»ºäº§ç‰©ç›®å½•ä¸ºç©º"
            exit 1
          fi
          
          echo "âœ… æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡"
          echo "ğŸ“Š æ–‡ä»¶æ•°é‡: $FILE_COUNT"

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          # ç¡®å®šæ„å»ºäº§ç‰©è·¯å¾„
          if [ -d "./dist" ]; then
            ARTIFACT_PATH="./dist"
          elif [ -d "./dist-${{ inputs.project }}" ]; then
            ARTIFACT_PATH="./dist-${{ inputs.project }}"
          elif [ -d "./docs/.vitepress/dist" ]; then
            ARTIFACT_PATH="./docs/.vitepress/dist"
          else
            # æ„å»ºäº§ç‰©ç›´æ¥åœ¨å½“å‰ç›®å½•
            ARTIFACT_PATH="."
          fi
          
          echo "artifact_path=$ARTIFACT_PATH" >> $GITHUB_OUTPUT
          echo "artifact_size=$(du -sb $ARTIFACT_PATH | cut -f1)" >> $GITHUB_OUTPUT
          echo "âœ… è¾“å‡ºå·²è®¾ç½®"
          echo "æ„å»ºäº§ç‰©è·¯å¾„: $ARTIFACT_PATH"

  upload-files:
    needs: download-artifact
    runs-on: ubuntu-latest
    outputs:
      upload_success: ${{ steps.set-outputs.outputs.upload_success }}
      temp_dir: ${{ steps.set-outputs.outputs.temp_dir }}
    
    steps:
      - name: åˆ›å»ºä¸´æ—¶ç›®å½•
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ğŸ“ åˆ›å»ºä¸´æ—¶ç›®å½•..."
            
            PROJECT="${{ inputs.project }}"
            RUN_USER="deploy"
            
            # åˆ›å»ºä¸´æ—¶ç›®å½•
            TEMP_DIR="/tmp/deploy-$PROJECT"
            echo "ğŸ“ åˆ›å»ºä¸´æ—¶ç›®å½•: $TEMP_DIR"
            sudo mkdir -p "$TEMP_DIR"
            sudo chown $RUN_USER:$RUN_USER "$TEMP_DIR"
            
            echo "âœ… ä¸´æ—¶ç›®å½•å·²åˆ›å»º: $TEMP_DIR"

      - name: è°ƒè¯•æ„å»ºäº§ç‰©è·¯å¾„
        run: |
          echo "ğŸ” è°ƒè¯•æ„å»ºäº§ç‰©è·¯å¾„..."
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "æ„å»ºäº§ç‰©è·¯å¾„: ${{ needs.download-artifact.outputs.artifact_path }}"
          echo "æ„å»ºäº§ç‰©å¤§å°: ${{ needs.download-artifact.outputs.artifact_size }}"
          
          echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
          ls -la ./
          
          echo "ğŸ“ æ„å»ºäº§ç‰©ç›®å½•å†…å®¹:"
          if [ -d "${{ needs.download-artifact.outputs.artifact_path }}" ]; then
            ls -la "${{ needs.download-artifact.outputs.artifact_path }}/"
            echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
            find "${{ needs.download-artifact.outputs.artifact_path }}" -type f | wc -l
          else
            echo "âŒ æ„å»ºäº§ç‰©ç›®å½•ä¸å­˜åœ¨: ${{ needs.download-artifact.outputs.artifact_path }}"
          fi

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          source: "${{ github.workspace }}/${{ needs.download-artifact.outputs.artifact_path }}/*"
          target: "/tmp/deploy-${{ inputs.project }}/"

      - name: éªŒè¯ä¸Šä¼ ç»“æœ
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ğŸ” éªŒè¯ä¸Šä¼ ç»“æœ..."
            
            PROJECT="${{ inputs.project }}"
            TEMP_DIR="/tmp/deploy-$PROJECT"
            
            if [ -d "$TEMP_DIR" ]; then
              echo "âœ… ä¸´æ—¶ç›®å½•å­˜åœ¨: $TEMP_DIR"
              echo "ğŸ“ ä¸´æ—¶ç›®å½•å†…å®¹:"
              ls -la "$TEMP_DIR/"
              
              # æ£€æŸ¥æ–‡ä»¶æ•°é‡
              FILE_COUNT=$(find "$TEMP_DIR" -type f | wc -l)
              echo "ğŸ“Š æ–‡ä»¶æ•°é‡: $FILE_COUNT"
              
              if [ "$FILE_COUNT" -gt 0 ]; then
                echo "âœ… æ–‡ä»¶ä¸Šä¼ éªŒè¯é€šè¿‡"
              else
                echo "âŒ ä¸´æ—¶ç›®å½•ä¸ºç©ºï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å‹ç¼©æ–‡ä»¶..."
                
                # æŸ¥æ‰¾å‹ç¼©æ–‡ä»¶
                ZIP_FILES=$(find "$TEMP_DIR" -name "*.zip" -type f)
                TAR_FILES=$(find "$TEMP_DIR" -name "*.tar.gz" -o -name "*.tgz" -type f)
                TAR_FILES_2=$(find "$TEMP_DIR" -name "*.tar" -type f)
                
                if [ -n "$ZIP_FILES" ] || [ -n "$TAR_FILES" ] || [ -n "$TAR_FILES_2" ]; then
                  echo "ğŸ“¦ å‘ç°å‹ç¼©æ–‡ä»¶ï¼Œéœ€è¦è§£å‹"
                  echo "ZIPæ–‡ä»¶: $ZIP_FILES"
                  echo "TARæ–‡ä»¶: $TAR_FILES $TAR_FILES_2"
                else
                  echo "âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ–‡ä»¶æˆ–å‹ç¼©æ–‡ä»¶"
                  exit 1
                fi
              fi
            else
              echo "âŒ ä¸´æ—¶ç›®å½•ä¸å­˜åœ¨: $TEMP_DIR"
              echo "ğŸ“ /tmp ç›®å½•å†…å®¹:"
              ls -la /tmp/ | grep "$PROJECT" || echo "æ²¡æœ‰æ‰¾åˆ°é¡¹ç›®ç›¸å…³ç›®å½•"
              exit 1
            fi

      - name: è§£å‹æ„å»ºäº§ç‰©
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ğŸ“¦ è§£å‹æ„å»ºäº§ç‰©..."
            
            PROJECT="${{ inputs.project }}"
            TEMP_DIR="/tmp/deploy-$PROJECT"
            
            echo "ğŸ“ æ£€æŸ¥ä¸´æ—¶ç›®å½•å†…å®¹..."
            ls -la "$TEMP_DIR/"
            
            # æŸ¥æ‰¾å‹ç¼©æ–‡ä»¶å¹¶è§£å‹
            cd "$TEMP_DIR"
            
            # æŸ¥æ‰¾zipæ–‡ä»¶
            ZIP_FILES=$(find . -name "*.zip" -type f)
            if [ -n "$ZIP_FILES" ]; then
              echo "ğŸ“¦ å‘ç°zipæ–‡ä»¶ï¼Œæ­£åœ¨è§£å‹..."
              for zip_file in $ZIP_FILES; do
                echo "ğŸ“¦ è§£å‹: $zip_file"
                unzip -o "$zip_file" -d .
                rm -f "$zip_file"
              done
            fi
            
            # æŸ¥æ‰¾tar.gzæ–‡ä»¶
            TAR_FILES=$(find . -name "*.tar.gz" -o -name "*.tgz" -type f)
            if [ -n "$TAR_FILES" ]; then
              echo "ğŸ“¦ å‘ç°tar.gzæ–‡ä»¶ï¼Œæ­£åœ¨è§£å‹..."
              for tar_file in $TAR_FILES; do
                echo "ğŸ“¦ è§£å‹: $tar_file"
                tar -xzf "$tar_file"
                rm -f "$tar_file"
              done
            fi
            
            # æŸ¥æ‰¾taræ–‡ä»¶
            TAR_FILES=$(find . -name "*.tar" -type f)
            if [ -n "$TAR_FILES" ]; then
              echo "ğŸ“¦ å‘ç°taræ–‡ä»¶ï¼Œæ­£åœ¨è§£å‹..."
              for tar_file in $TAR_FILES; do
                echo "ğŸ“¦ è§£å‹: $tar_file"
                tar -xf "$tar_file"
                rm -f "$tar_file"
              done
            fi
            
            echo "ğŸ“ è§£å‹åçš„ç›®å½•å†…å®¹:"
            ls -la "$TEMP_DIR/"
            
            echo "âœ… è§£å‹å®Œæˆ"

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          echo "upload_success=true" >> $GITHUB_OUTPUT
          echo "temp_dir=/tmp/deploy-${{ inputs.project }}" >> $GITHUB_OUTPUT
          echo "âœ… ä¸Šä¼ å®Œæˆ"

  deploy-project:
    needs: upload-files
    runs-on: ubuntu-latest
    outputs:
      deploy_success: ${{ steps.set-outputs.outputs.deploy_success }}
      deploy_path: ${{ steps.set-outputs.outputs.deploy_path }}
    
    steps:
      - name: éƒ¨ç½²é¡¹ç›®
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ğŸš€ éƒ¨ç½²é¡¹ç›®..."
            
            PROJECT="${{ inputs.project }}"
            DEPLOY_TYPE="${{ inputs.deploy_type }}"
            RUN_USER="deploy"
            APPS_ROOT="/srv/apps"
            STATIC_ROOT="/srv/static"
            BACKUP_ROOT="/srv/backups"
            TEMP_DIR="/tmp/deploy-$PROJECT"
            
            # ç¡®å®šéƒ¨ç½²è·¯å¾„
            if [ "$DEPLOY_TYPE" = "backend" ]; then
              DEPLOY_PATH="$APPS_ROOT/$PROJECT"
            else
              DEPLOY_PATH="$STATIC_ROOT/$PROJECT"
            fi
            
            echo "ğŸ“ éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"
            
            # å¤‡ä»½ç°æœ‰éƒ¨ç½²
            if [ -d "$DEPLOY_PATH" ]; then
              echo "ğŸ“‹ å¤‡ä»½ç°æœ‰éƒ¨ç½²..."
              
              # åˆ›å»ºé¡¹ç›®ä¸“ç”¨å¤‡ä»½ç›®å½•
              PROJECT_BACKUP_DIR="$BACKUP_ROOT/$PROJECT"
              echo "ğŸ“ åˆ›å»ºé¡¹ç›®å¤‡ä»½ç›®å½•: $PROJECT_BACKUP_DIR"
              sudo mkdir -p "$PROJECT_BACKUP_DIR"
              sudo chmod 755 "$PROJECT_BACKUP_DIR"
              
              # å¤‡ä»½ç°æœ‰éƒ¨ç½²
              BACKUP_FILE="$PROJECT_BACKUP_DIR/backup-$(date +%Y%m%d_%H%M%S)"
              sudo cp -r "$DEPLOY_PATH" "$BACKUP_FILE"
              echo "âœ… ç°æœ‰éƒ¨ç½²å·²å¤‡ä»½åˆ°: $BACKUP_FILE"
              
              # æ¸…ç†æ—§çš„å¤‡ä»½æ–‡ä»¶ï¼Œåªä¿ç•™æœ€è¿‘2ä¸ª
              echo "ğŸ§¹ æ¸…ç†æ—§çš„å¤‡ä»½æ–‡ä»¶..."
              BACKUP_FILES=$(ls -t "$PROJECT_BACKUP_DIR"/backup-* 2>/dev/null | tail -n +3)
              if [ -n "$BACKUP_FILES" ]; then
                echo "ğŸ—‘ï¸ åˆ é™¤æ—§çš„å¤‡ä»½æ–‡ä»¶:"
                echo "$BACKUP_FILES" | xargs -r sudo rm -rf
                echo "âœ… æ—§å¤‡ä»½æ–‡ä»¶å·²æ¸…ç†ï¼Œä¿ç•™æœ€è¿‘2ä¸ªå¤‡ä»½"
              else
                echo "ğŸ“‹ æ²¡æœ‰éœ€è¦æ¸…ç†çš„æ—§å¤‡ä»½æ–‡ä»¶"
              fi
            else
              echo "ğŸ“‹ æ²¡æœ‰æ‰¾åˆ°ç°æœ‰éƒ¨ç½²: $DEPLOY_PATH"
            fi
            
            # éƒ¨ç½²æ–°æ–‡ä»¶
            echo "ğŸ“¦ éƒ¨ç½²æ–°æ–‡ä»¶..."
            sudo mkdir -p "$(dirname $DEPLOY_PATH)"
            sudo rm -rf "$DEPLOY_PATH"
            
            # æ£€æŸ¥ä¸´æ—¶ç›®å½•çš„å†…å®¹ç»“æ„
            echo "ğŸ“ æ£€æŸ¥ä¸´æ—¶ç›®å½•å†…å®¹ç»“æ„..."
            ls -la "$TEMP_DIR/"
            
            # æŸ¥æ‰¾å®é™…çš„æ„å»ºäº§ç‰©æ–‡ä»¶
            if [ -d "$TEMP_DIR/github" ]; then
              echo "ğŸ“ å‘ç°githubå­ç›®å½•ï¼Œæ£€æŸ¥å…¶å†…å®¹..."
              ls -la "$TEMP_DIR/github/"
              
              if [ -d "$TEMP_DIR/github/workspace" ]; then
                echo "ğŸ“ å‘ç°workspaceå­ç›®å½•ï¼Œæ£€æŸ¥å…¶å†…å®¹..."
                ls -la "$TEMP_DIR/github/workspace/"
                
                # åœ¨workspaceä¸­æŸ¥æ‰¾æ„å»ºäº§ç‰©
                if [ -d "$TEMP_DIR/github/workspace/dist" ]; then
                  echo "ğŸ“ å‘ç°distç›®å½•ï¼Œè¿™æ˜¯æ„å»ºäº§ç‰©"
                  sudo mv "$TEMP_DIR/github/workspace/dist" "$DEPLOY_PATH"
                elif [ -d "$TEMP_DIR/github/workspace/docs/.vitepress/dist" ]; then
                  echo "ğŸ“ å‘ç°docs/.vitepress/distç›®å½•ï¼Œè¿™æ˜¯æ„å»ºäº§ç‰©"
                  sudo mv "$TEMP_DIR/github/workspace/docs/.vitepress/dist" "$DEPLOY_PATH"
                else
                  echo "ğŸ“ æ²¡æœ‰æ‰¾åˆ°æ„å»ºäº§ç‰©ç›®å½•ï¼Œä½¿ç”¨æ•´ä¸ªworkspace"
                  sudo mv "$TEMP_DIR/github/workspace" "$DEPLOY_PATH"
                fi
              else
                echo "ğŸ“ æ²¡æœ‰workspaceå­ç›®å½•ï¼Œæ£€æŸ¥githubç›®å½•å†…å®¹..."
                if [ -d "$TEMP_DIR/github/dist" ]; then
                  echo "ğŸ“ å‘ç°distç›®å½•ï¼Œè¿™æ˜¯æ„å»ºäº§ç‰©"
                  sudo mv "$TEMP_DIR/github/dist" "$DEPLOY_PATH"
                elif [ -d "$TEMP_DIR/github/docs/.vitepress/dist" ]; then
                  echo "ğŸ“ å‘ç°docs/.vitepress/distç›®å½•ï¼Œè¿™æ˜¯æ„å»ºäº§ç‰©"
                  sudo mv "$TEMP_DIR/github/docs/.vitepress/dist" "$DEPLOY_PATH"
                else
                  echo "ğŸ“ æ²¡æœ‰æ‰¾åˆ°æ„å»ºäº§ç‰©ç›®å½•ï¼Œä½¿ç”¨æ•´ä¸ªgithubç›®å½•"
                  sudo mv "$TEMP_DIR/github" "$DEPLOY_PATH"
                fi
              fi
            else
              echo "ğŸ“ æ²¡æœ‰githubå­ç›®å½•ï¼Œæ£€æŸ¥ä¸´æ—¶ç›®å½•å†…å®¹..."
              if [ -d "$TEMP_DIR/dist" ]; then
                echo "ğŸ“ å‘ç°distç›®å½•ï¼Œè¿™æ˜¯æ„å»ºäº§ç‰©"
                sudo mv "$TEMP_DIR/dist" "$DEPLOY_PATH"
              elif [ -d "$TEMP_DIR/docs/.vitepress/dist" ]; then
                echo "ğŸ“ å‘ç°docs/.vitepress/distç›®å½•ï¼Œè¿™æ˜¯æ„å»ºäº§ç‰©"
                sudo mv "$TEMP_DIR/docs/.vitepress/dist" "$DEPLOY_PATH"
              else
                echo "ğŸ“ æ²¡æœ‰æ‰¾åˆ°æ„å»ºäº§ç‰©ç›®å½•ï¼Œä½¿ç”¨æ•´ä¸ªä¸´æ—¶ç›®å½•"
                sudo mv "$TEMP_DIR" "$DEPLOY_PATH"
              fi
            fi
            
            sudo chown -R $RUN_USER:$RUN_USER "$DEPLOY_PATH"
            
            echo "âœ… éƒ¨ç½²å®Œæˆ"

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          echo "deploy_success=true" >> $GITHUB_OUTPUT
          echo "deploy_path=/srv/${{ inputs.deploy_type == 'backend' && 'apps' || 'static' }}/${{ inputs.project }}" >> $GITHUB_OUTPUT
          echo "âœ… éƒ¨ç½²å®Œæˆ"

  configure-nginx:
    needs: deploy-project
    uses: ./.github/workflows/configure-nginx.yml
    with:
      project: ${{ inputs.project }}
      nginx_config: ${{ inputs.nginx_config }}
      server_host: ${{ inputs.server_host }}
      server_user: ${{ inputs.server_user }}
      server_key: ${{ inputs.server_key }}
      server_port: ${{ inputs.server_port }}
      deploy_type: ${{ inputs.deploy_type }}

  start-service:
    needs: [deploy-project]
    if: ${{ inputs.start_cmd != '' && inputs.deploy_type == 'backend' }}
    runs-on: ubuntu-latest
    outputs:
      start_success: ${{ steps.set-outputs.outputs.start_success }}
    
    steps:
      - name: å¯åŠ¨æœåŠ¡
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
            
            PROJECT="${{ inputs.project }}"
            START_CMD="${{ inputs.start_cmd }}"
            APPS_ROOT="/srv/apps"
            
            # åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
            cd "$APPS_ROOT/$PROJECT"
            
            # æ‰§è¡Œå¯åŠ¨å‘½ä»¤
            echo "ğŸ“‹ æ‰§è¡Œå¯åŠ¨å‘½ä»¤: $START_CMD"
            $START_CMD
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 5
            
            echo "âœ… æœåŠ¡å¯åŠ¨å®Œæˆ"

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          echo "start_success=true" >> $GITHUB_OUTPUT
          echo "âœ… å¯åŠ¨å®Œæˆ"

  test-website:
    needs: [deploy-project, configure-nginx, start-service]
    if: always()
    runs-on: ubuntu-latest
    outputs:
      test_success: ${{ steps.set-outputs.outputs.test_success }}
    
    steps:
      - name: æµ‹è¯•ç½‘ç«™å¯è®¿é—®æ€§
        run: |
          echo "ğŸ” æµ‹è¯•ç½‘ç«™å¯è®¿é—®æ€§..."
          
          # ç­‰å¾…ä¸€æ®µæ—¶é—´è®©æœåŠ¡å®Œå…¨å¯åŠ¨
          sleep 10
          
          # æµ‹è¯•ç½‘ç«™å¯è®¿é—®æ€§
          HTTP_STATUS=$(curl -f -s -o /dev/null -w "%{http_code}" https://redamancy.com.cn/docs/ 2>/dev/null || echo "000")
          echo "ğŸ“‹ HTTPçŠ¶æ€ç : $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "301" ] || [ "$HTTP_STATUS" = "302" ]; then
            echo "âœ… ç½‘ç«™å¯æ­£å¸¸è®¿é—®"
          else
            echo "âŒ ç½‘ç«™æ— æ³•è®¿é—®ï¼ŒHTTPçŠ¶æ€ç : $HTTP_STATUS"
            echo "ğŸš¨ å·¥ä½œæµé”™è¯¯ï¼šç½‘ç«™è¿”å› $HTTP_STATUS çŠ¶æ€ç ï¼Œè¿™è¡¨ç¤ºé…ç½®æœ‰é—®é¢˜"
            echo "å¯èƒ½çš„åŸå› :"
            echo "1. Nginxé…ç½®é”™è¯¯"
            echo "2. æ–‡ä»¶æƒé™é—®é¢˜"
            echo "3. è·¯å¾„ä¸å­˜åœ¨"
            echo "4. SSLè¯ä¹¦é—®é¢˜"
            exit 1
          fi

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          echo "test_success=true" >> $GITHUB_OUTPUT
          echo "âœ… æµ‹è¯•å®Œæˆ"



  deployment-summary:
    needs: [download-artifact, upload-files, deploy-project, configure-nginx, start-service, test-website]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: éƒ¨ç½²å®Œæˆæ€»ç»“
        run: |
          echo "ğŸ‰ éƒ¨ç½²æµç¨‹å®Œæˆ"
          echo "=========================================="
          echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯:"
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- éƒ¨ç½²ç±»å‹: ${{ inputs.deploy_type }}"
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- æ„å»ºID: ${{ inputs.run_id }}"
          echo ""
          echo "ğŸ“Š æ‰§è¡ŒçŠ¶æ€:"
          echo "- ä¸‹è½½æ„å»ºäº§ç‰©: ${{ needs.download-artifact.result }}"
          echo "- ä¸Šä¼ æ–‡ä»¶: ${{ needs.upload-files.result }}"
          echo "- éƒ¨ç½²é¡¹ç›®: ${{ needs.deploy-project.result }}"
          echo "- é…ç½®Nginx: ${{ needs.configure-nginx.result || 'skipped' }}"
          echo "- å¯åŠ¨æœåŠ¡: ${{ needs.start-service.result || 'skipped' }}"
          echo "- æµ‹è¯•ç½‘ç«™: ${{ needs.test-website.result || 'skipped' }}"
          echo ""
          echo "ğŸ”— è®¿é—®ä¿¡æ¯:"
          echo "- åŸŸå: redamancy.com.cn"
          echo "- é¡¹ç›®è·¯å¾„: ${{ needs.deploy-project.outputs.deploy_path }}"
          echo "- è®¿é—®URL: https://redamancy.com.cn/docs/"
          echo ""
          echo "ğŸ“ éƒ¨ç½²å®Œæˆé€šçŸ¥:"
          echo "âœ… é¡¹ç›® ${{ inputs.project }} å·²æˆåŠŸéƒ¨ç½²åˆ°æœåŠ¡å™¨"
          echo "ğŸŒ å¯é€šè¿‡ https://redamancy.com.cn/docs/ è®¿é—®"
          echo "=========================================="