name: Main Deployment

description: "ä¸»éƒ¨ç½²å·¥ä½œæµ - æ•´ä¸ªéƒ¨ç½²æµç¨‹çš„å…¥å£ç‚¹"

on:
  # ä¿ç•™æ‰‹åŠ¨è§¦å‘åŠŸèƒ½
  workflow_dispatch:
    inputs:
      project:
        description: 'é¡¹ç›®åç§°'
        required: true
        type: string
      source_repo:
        description: 'æºä»“åº“ (æ ¼å¼: owner/repo)'
        required: true
        type: string
      run_id:
        description: 'æ„å»ºè¿è¡ŒID'
        required: true
        type: string
      deploy_type:
        description: 'éƒ¨ç½²ç±»å‹'
        required: true
        default: 'static'
        type: choice
        options:
          - static
          - backend
      nginx_config:
        description: 'Nginxé…ç½®ï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      test_url:
        description: 'æµ‹è¯•URLï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      start_cmd:
        description: 'å¯åŠ¨å‘½ä»¤ï¼ˆåç«¯é¡¹ç›®ï¼‰'
        required: false
        type: string
      deploy_secrets:
        description: 'éƒ¨ç½²å¯†é’¥ (JSONæ ¼å¼æˆ–base64ç¼–ç çš„JSON: {"SERVER_HOST":"host","SERVER_PORT":"port","SERVER_USER":"user","SERVER_KEY":"key","DEPLOY_CENTER_PAT":"pat"})'
        required: true
        type: string
      skip_init:
        description: 'è·³è¿‡æœåŠ¡å™¨åˆå§‹åŒ–æ­¥éª¤'
        required: false
        type: boolean
        default: false

jobs:
  # æ­¥éª¤1: æœåŠ¡å™¨åˆå§‹åŒ–ï¼ˆå¯é€‰ï¼‰
  server-init:
    runs-on: ubuntu-latest
    if: ${{ inputs.skip_init != 'true' }}
    steps:
      - name: æœåŠ¡å™¨åˆå§‹åŒ–
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸš€ å¼€å§‹æœåŠ¡å™¨åˆå§‹åŒ–..."
            
            # è·å–è¾“å…¥å‚æ•°
            DOMAIN="redamancy.com.cn"
            RUN_USER="deploy"
            APPS_ROOT="/srv/apps"
            STATIC_ROOT="/srv/static"
            NGINX_CONF_DIR="/www/server/nginx/conf/conf.d/redamancy"
            CERT_SRC="/www/server/panel/vhost/cert/redamancy.com.cn"
            CERT_DST="/www/server/nginx/ssl/redamancy"
            
            echo "ğŸ“‹ åˆå§‹åŒ–é…ç½®:"
            echo "- åŸŸå: $DOMAIN"
            echo "- è¿è¡Œç”¨æˆ·: $RUN_USER"
            echo "- åº”ç”¨ç›®å½•: $APPS_ROOT"
            echo "- é™æ€ç›®å½•: $STATIC_ROOT"
            echo "- Nginxé…ç½®: $NGINX_CONF_DIR"
            echo "- è¯ä¹¦æº: $CERT_SRC"
            echo "- è¯ä¹¦ç›®æ ‡: $CERT_DST"
            
            # 0. å‰ç½®æ£€æŸ¥
            echo "ğŸ” å‰ç½®æ£€æŸ¥..."
            if ! command -v nginx &> /dev/null; then
              echo "âŒ Nginxæœªå®‰è£…ï¼Œæ— æ³•ç»§ç»­åˆå§‹åŒ–"
              exit 1
            fi
            echo "âœ… Nginxå·²å®‰è£…: $(nginx -v)"
            
            # 1. åˆ›å»ºä¸šåŠ¡è¿è¡Œç”¨æˆ·ï¼ˆç¾åè‡ªæ„ˆï¼‰
            echo "ğŸ‘¤ æ£€æŸ¥ä¸šåŠ¡è¿è¡Œç”¨æˆ·..."
            if ! id "$RUN_USER" &>/dev/null; then
              echo "ğŸ†• åˆ›å»ºç”¨æˆ· $RUN_USER..."
              sudo useradd -m -s /bin/bash $RUN_USER
              echo "âœ… ç”¨æˆ· $RUN_USER åˆ›å»ºå®Œæˆ"
            else
              echo "âœ… ç”¨æˆ· $RUN_USER å·²å­˜åœ¨"
            fi
            
            # 2. åˆ›å»ºæ‰€éœ€ç›®å½•ï¼ˆç¾åè‡ªæ„ˆï¼‰
            echo "ğŸ“ æ£€æŸ¥å¹¶åˆ›å»ºç›®å½•..."
            sudo mkdir -p $APPS_ROOT $STATIC_ROOT $NGINX_CONF_DIR $CERT_DST
            sudo chown $RUN_USER:$RUN_USER $APPS_ROOT $STATIC_ROOT
            sudo chmod 755 $NGINX_CONF_DIR $CERT_DST
            echo "âœ… ç›®å½•ç»“æ„æ£€æŸ¥å®Œæˆ"
            
            # 3. è½¯é“¾å®å¡”è¯ä¹¦ï¼ˆå¥åº·å·¡æ£€ï¼‰
            echo "ğŸ”— æ£€æŸ¥è¯ä¹¦è½¯é“¾..."
            if [ ! -d "$CERT_SRC" ]; then
              echo "âŒ è¯ä¹¦æºç›®å½•ä¸å­˜åœ¨: $CERT_SRC"
              echo "è¯·ç¡®ä¿å®å¡”é¢æ¿å·²ä¸ºåŸŸå $DOMAIN é…ç½®SSLè¯ä¹¦"
              exit 1
            fi
            
            # æ£€æŸ¥å¹¶é‡æ–°åˆ›å»ºè½¯é“¾
            if [ -f "$CERT_SRC/fullchain.pem" ]; then
              sudo ln -sf $CERT_SRC/fullchain.pem $CERT_DST/fullchain.pem
              echo "âœ… è½¯é“¾ fullchain.pem å®Œæˆ"
            else
              echo "âŒ è¯ä¹¦æ–‡ä»¶ä¸å­˜åœ¨: $CERT_SRC/fullchain.pem"
              exit 1
            fi
            
            if [ -f "$CERT_SRC/privkey.pem" ]; then
              sudo ln -sf $CERT_SRC/privkey.pem $CERT_DST/privkey.pem
              echo "âœ… è½¯é“¾ privkey.pem å®Œæˆ"
            else
              echo "âŒ ç§é’¥æ–‡ä»¶ä¸å­˜åœ¨: $CERT_SRC/privkey.pem"
              exit 1
            fi
            
            # 4. å†™å…¥/æ›´æ–°ä¸»é…ç½®ï¼ˆé…ç½®å˜æ›´ï¼‰
            echo "ğŸ“ æ›´æ–°ä¸»é…ç½®æ–‡ä»¶..."
            MAIN_CONF="$NGINX_CONF_DIR/00-main.conf"
            
            # åˆ›å»ºä¸»é…ç½®æ–‡ä»¶å¤‡ä»½ç›®å½•
            MAIN_BACKUP_DIR="$NGINX_CONF_DIR/backups/main"
            echo "ğŸ“ åˆ›å»ºä¸»é…ç½®æ–‡ä»¶å¤‡ä»½ç›®å½•: $MAIN_BACKUP_DIR"
            sudo mkdir -p "$MAIN_BACKUP_DIR"
            sudo chmod 755 "$MAIN_BACKUP_DIR"
            
            # å¤‡ä»½ç°æœ‰ä¸»é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -f "$MAIN_CONF" ]; then
              echo "ğŸ“‹ å¤‡ä»½ç°æœ‰ä¸»é…ç½®æ–‡ä»¶: $MAIN_CONF"
              MAIN_BACKUP_FILE="$MAIN_BACKUP_DIR/00-main.conf.backup.$(date +%Y%m%d_%H%M%S)"
              sudo cp "$MAIN_CONF" "$MAIN_BACKUP_FILE"
              echo "âœ… ä¸»é…ç½®æ–‡ä»¶å·²å¤‡ä»½åˆ°: $MAIN_BACKUP_FILE"
            else
              echo "ğŸ“‹ ä¸»é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶"
            fi
            
            # æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°ç”Ÿæˆé…ç½®
            if [ ! -f "$MAIN_CONF" ] || [ "$(grep -c 'location ~ \^/\(?!docs|api|health|uploads|static|\$\)' $MAIN_CONF 2>/dev/null || echo 0)" -gt 0 ]; then
              echo "ğŸ”„ é‡æ–°ç”Ÿæˆä¸»é…ç½®æ–‡ä»¶..."
              sudo tee $MAIN_CONF <<'EOF'
            server {
                listen 443 ssl;
                server_name redamancy.com.cn;
                http2 on;
            
                ssl_certificate     /www/server/nginx/ssl/redamancy/fullchain.pem;
                ssl_certificate_key /www/server/nginx/ssl/redamancy/privkey.pem;
            
                client_max_body_size 100m;
            
                # è¿™é‡Œè‡ªåŠ¨åŠ è½½ route-*.confï¼ˆé¡¹ç›®è·¯ç”±ï¼‰â€”â€”ä¸»é…ç½®æ°¸è¿œä¸ç”¨å†æ”¹
                include /www/server/nginx/conf/conf.d/redamancy/route-*.conf;
            }
            
            server {
                listen 80;
                server_name redamancy.com.cn;
                
                # HTTPåˆ°HTTPSé‡å®šå‘
                return 301 https://$host$request_uri;
            }
            EOF
              echo "âœ… ä¸»é…ç½®æ–‡ä»¶å·²æ›´æ–°"
            else
              echo "âœ… ä¸»é…ç½®æ–‡ä»¶æ— éœ€æ›´æ–°"
            fi
            
            # 5. æ£€æŸ¥å¹¶é‡è½½Nginxï¼ˆå¥åº·å·¡æ£€ï¼‰
            echo "ğŸ”„ æ£€æŸ¥Nginxé…ç½®..."
            if sudo nginx -t; then
              echo "âœ… Nginxé…ç½®è¯­æ³•æ£€æŸ¥é€šè¿‡"
            else
              echo "âŒ Nginxé…ç½®è¯­æ³•é”™è¯¯"
              echo "é…ç½®é”™è¯¯è¯¦æƒ…:"
              sudo nginx -t 2>&1
              exit 1
            fi
            
            echo "ğŸ”„ å°è¯•é‡è½½Nginx..."
            if pgrep nginx > /dev/null; then
              echo "âœ… Nginxè¿›ç¨‹æ­£åœ¨è¿è¡Œï¼Œå°è¯•é‡è½½..."
              if sudo systemctl reload nginx; then
                echo "âœ… Nginxçƒ­åŠ è½½å®Œæˆ"
              else
                echo "âŒ Nginxé‡è½½å¤±è´¥ï¼Œå°è¯•é‡å¯..."
                if sudo systemctl restart nginx; then
                  echo "âœ… Nginxé‡å¯æˆåŠŸ"
                else
                  echo "âŒ Nginxé‡å¯å¤±è´¥"
                  exit 1
                fi
              fi
            else
              echo "âš ï¸  Nginxè¿›ç¨‹æœªè¿è¡Œï¼Œå°è¯•å¯åŠ¨..."
              if sudo systemctl start nginx; then
                echo "âœ… Nginxå¯åŠ¨æˆåŠŸ"
              else
                echo "âŒ Nginxå¯åŠ¨å¤±è´¥"
                exit 1
              fi
            fi
            
            echo "âœ… æœåŠ¡å™¨åˆå§‹åŒ–å®Œæˆï¼"

  download-artifact:
    runs-on: ubuntu-latest
    needs: [server-init]
    if: always()
    outputs:
      artifact_path: ${{ steps.set-outputs.outputs.artifact_path }}
      artifact_size: ${{ steps.set-outputs.outputs.artifact_size }}
      artifact_name: ${{ steps.set-project-info.outputs.artifact_name }}
      project: ${{ steps.set-project-info.outputs.project }}
      source_repo: ${{ steps.set-project-info.outputs.source_repo }}
      run_id: ${{ steps.set-project-info.outputs.run_id }}
      server_host: ${{ steps.parse-secrets.outputs.server_host }}
      server_user: ${{ steps.parse-secrets.outputs.server_user }}
      server_key: ${{ steps.parse-secrets.outputs.server_key }}
      server_port: ${{ steps.parse-secrets.outputs.server_port }}
      deploy_center_pat: ${{ steps.parse-secrets.outputs.deploy_center_pat }}
    
    steps:
      - name: è§£æéƒ¨ç½²å¯†é’¥
        id: parse-secrets
        run: |
          echo "ğŸ” è§£æéƒ¨ç½²å¯†é’¥..."
          
          # ä»è¾“å…¥å‚æ•°è·å–éƒ¨ç½²å¯†é’¥
          DEPLOY_SECRETS='${{ inputs.deploy_secrets }}'
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºbase64ç¼–ç 
          if echo "$DEPLOY_SECRETS" | base64 -d &>/dev/null; then
            echo "ğŸ“¦ æ£€æµ‹åˆ°base64ç¼–ç çš„éƒ¨ç½²å¯†é’¥ï¼Œæ­£åœ¨è§£ç ..."
            DEPLOY_SECRETS=$(echo "$DEPLOY_SECRETS" | base64 -d)
          fi
          
          # ä½¿ç”¨jqè§£æJSONé…ç½®
          SERVER_HOST=$(echo "$DEPLOY_SECRETS" | jq -r '.SERVER_HOST')
          SERVER_PORT=$(echo "$DEPLOY_SECRETS" | jq -r '.SERVER_PORT')
          SERVER_USER=$(echo "$DEPLOY_SECRETS" | jq -r '.SERVER_USER')
          SERVER_KEY=$(echo "$DEPLOY_SECRETS" | jq -r '.SERVER_KEY')
          DEPLOY_CENTER_PAT=$(echo "$DEPLOY_SECRETS" | jq -r '.DEPLOY_CENTER_PAT')
          
          # éªŒè¯å¿…éœ€å‚æ•°
          if [ "$SERVER_HOST" = "null" ] || [ -z "$SERVER_HOST" ]; then
            echo "ğŸš¨ ç¼ºå°‘å¿…éœ€çš„SERVER_HOSTå‚æ•°"
            exit 1
          fi
          if [ "$SERVER_PORT" = "null" ] || [ -z "$SERVER_PORT" ]; then
            echo "ğŸš¨ ç¼ºå°‘å¿…éœ€çš„SERVER_PORTå‚æ•°"
            exit 1
          fi
          if [ "$SERVER_USER" = "null" ] || [ -z "$SERVER_USER" ]; then
            echo "ğŸš¨ ç¼ºå°‘å¿…éœ€çš„SERVER_USERå‚æ•°"
            exit 1
          fi
          if [ "$SERVER_KEY" = "null" ] || [ -z "$SERVER_KEY" ]; then
            echo "ğŸš¨ ç¼ºå°‘å¿…éœ€çš„SERVER_KEYå‚æ•°"
            exit 1
          fi
          if [ "$DEPLOY_CENTER_PAT" = "null" ] || [ -z "$DEPLOY_CENTER_PAT" ]; then
            echo "ğŸš¨ ç¼ºå°‘å¿…éœ€çš„DEPLOY_CENTER_PATå‚æ•°"
            exit 1
          fi
          
          # è®¾ç½®è¾“å‡º - å¯¹äºåŒ…å«æ¢è¡Œç¬¦çš„SERVER_KEYï¼Œä½¿ç”¨å¤šè¡Œè¾“å‡ºè¯­æ³•
          echo "server_host=$SERVER_HOST" >> $GITHUB_OUTPUT
          echo "server_port=$SERVER_PORT" >> $GITHUB_OUTPUT
          echo "server_user=$SERVER_USER" >> $GITHUB_OUTPUT
          echo "deploy_center_pat=$DEPLOY_CENTER_PAT" >> $GITHUB_OUTPUT
          
          # å¯¹äºåŒ…å«æ¢è¡Œç¬¦çš„SERVER_KEYï¼Œä½¿ç”¨å¤šè¡Œè¾“å‡ºè¯­æ³•
          {
            echo 'server_key<<EOF' >> $GITHUB_OUTPUT
            echo "$SERVER_KEY" >> $GITHUB_OUTPUT
            echo 'EOF' >> $GITHUB_OUTPUT
          }
          
          echo "âœ… éƒ¨ç½²å¯†é’¥è§£æå®Œæˆ"
          echo "ğŸ“‹ æœåŠ¡å™¨ä¿¡æ¯:"
          echo "- ä¸»æœº: $SERVER_HOST"
          echo "- ç«¯å£: $SERVER_PORT"
          echo "- ç”¨æˆ·: $SERVER_USER"

      - name: è®¾ç½®é¡¹ç›®ä¿¡æ¯
        id: set-project-info
        run: |
          echo "ğŸ”§ è®¾ç½®é¡¹ç›®ä¿¡æ¯..."
          
          # ä»è¾“å…¥å‚æ•°è·å–é¡¹ç›®ä¿¡æ¯
          PROJECT="${{ inputs.project }}"
          SOURCE_REPO="${{ inputs.source_repo }}"
          RUN_ID="${{ inputs.run_id }}"
          echo "ğŸ“‹ ä»workflow_dispatchè¾“å…¥è·å–é¡¹ç›®ä¿¡æ¯:"
          echo "  é¡¹ç›®åç§°: $PROJECT"
          echo "  æºä»“åº“: $SOURCE_REPO"
          echo "  è¿è¡ŒID: $RUN_ID"
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "project=$PROJECT" >> $GITHUB_OUTPUT
          echo "source_repo=$SOURCE_REPO" >> $GITHUB_OUTPUT
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          
          # æ ¹æ®é¡¹ç›®åç§°ç¡®å®šartifactåç§°
          ARTIFACT_NAME="dist-$PROJECT"
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          
          echo "âœ… é¡¹ç›®ä¿¡æ¯è®¾ç½®å®Œæˆ"

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.set-project-info.outputs.artifact_name }}
          path: ./
          github-token: ${{ steps.parse-secrets.outputs.deploy_center_pat }}
          repository: ${{ inputs.source_repo }}
          run-id: ${{ inputs.run_id }}

      - name: æ£€æŸ¥ä¸‹è½½ç»“æœ
        run: |
          echo "ğŸ” æ£€æŸ¥ä¸‹è½½ç»“æœ..."
          echo "ä¸‹è½½é€€å‡ºç : $?"
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la ./
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ„å»ºäº§ç‰©æ–‡ä»¶
          if [ -d "./dist-${{ steps.set-project-info.outputs.project }}" ]; then
            echo "âœ… dist-${{ steps.set-project-info.outputs.project }} ç›®å½•å­˜åœ¨"
            echo "dist-${{ steps.set-project-info.outputs.project }} ç›®å½•å†…å®¹:"
            ls -la "./dist-${{ steps.set-project-info.outputs.project }}/"
            echo "ğŸ“Š æ–‡ä»¶æ•°é‡:"
            find "./dist-${{ steps.set-project-info.outputs.project }}" -type f | wc -l
            echo "ğŸ“ å‰10ä¸ªæ–‡ä»¶:"
            find "./dist-${{ steps.set-project-info.outputs.project }}" -type f | head -10
          elif [ -f "./dist-${{ steps.set-project-info.outputs.project }}.zip" ]; then
            echo "âœ… æ‰¾åˆ°æ„å»ºäº§ç‰©å‹ç¼©åŒ…"
            echo "ğŸ“¦ å‹ç¼©åŒ…å¤§å°:"
            ls -lh "./dist-${{ steps.set-project-info.outputs.project }}.zip"
            echo "ğŸ”§ è§£å‹æ„å»ºäº§ç‰©..."
            unzip -q "./dist-${{ steps.set-project-info.outputs.project }}.zip"
            echo "ğŸ“ è§£å‹åå†…å®¹:"
            ls -la ./
          elif [ -f "./index.html" ]; then
            echo "âœ… æ‰¾åˆ°æ„å»ºäº§ç‰©ï¼ˆç›´æ¥åœ¨å½“å‰ç›®å½•ï¼‰"
            echo "ğŸ“ æ„å»ºäº§ç‰©å†…å®¹:"
            ls -la ./
            echo "ğŸ“Š æ–‡ä»¶æ•°é‡:"
            find . -type f -maxdepth 1 | wc -l
            echo "ğŸ“ å‰10ä¸ªæ–‡ä»¶:"
            find . -type f -maxdepth 1 | head -10
          else
            echo "âŒ æœªæ‰¾åˆ°æ„å»ºäº§ç‰©"
            echo "ğŸ” æ‰€æœ‰æ–‡ä»¶:"
            find . -type f -maxdepth 1
            echo "ğŸ” æ‰€æœ‰ç›®å½•:"
            find . -type d -maxdepth 2
            echo "ğŸš¨ å·¥ä½œæµé”™è¯¯ï¼šæœªæ‰¾åˆ°æ„å»ºäº§ç‰©ï¼Œç»ˆæ­¢éƒ¨ç½²"
            exit 1
          fi

      - name: éªŒè¯æ„å»ºäº§ç‰©å®Œæ•´æ€§
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºäº§ç‰©å®Œæ•´æ€§..."
          
          # ç­‰å¾…ä¸€ä¸‹ç¡®ä¿æ–‡ä»¶å®Œå…¨ä¸‹è½½
          sleep 2
          
          # æ£€æŸ¥å¯èƒ½çš„æ„å»ºäº§ç‰©ç›®å½•
          if [ -d "./dist-${{ steps.set-project-info.outputs.project }}" ]; then
            ARTIFACT_DIR="./dist-${{ steps.set-project-info.outputs.project }}"
            echo "ğŸ“ æ‰¾åˆ° dist-${{ steps.set-project-info.outputs.project }} ç›®å½•"
          elif [ -d "./dist" ]; then
            ARTIFACT_DIR="./dist"
            echo "ğŸ“ æ‰¾åˆ° dist ç›®å½•"
          elif [ -d "./docs/.vitepress/dist" ]; then
            ARTIFACT_DIR="./docs/.vitepress/dist"
            echo "ğŸ“ æ‰¾åˆ° docs/.vitepress/dist ç›®å½•"
          elif [ -d "./.vitepress/dist" ]; then
            ARTIFACT_DIR="./.vitepress/dist"
            echo "ğŸ“ æ‰¾åˆ° .vitepress/dist ç›®å½•"
          elif [ -f "./index.html" ]; then
            # æ„å»ºäº§ç‰©ç›´æ¥åœ¨å½“å‰ç›®å½•
            ARTIFACT_DIR="."
            echo "ğŸ“ æ„å»ºäº§ç‰©ç›´æ¥åœ¨å½“å‰ç›®å½•"
          else
            echo "âŒ æœªæ‰¾åˆ°æ„å»ºäº§ç‰©ç›®å½•"
            echo "ğŸ” å½“å‰ç›®å½•å†…å®¹:"
            ls -la ./
            echo "ğŸ” æ‰€æœ‰å­ç›®å½•:"
            find . -type d -maxdepth 2
            echo "ğŸ” æ‰€æœ‰æ–‡ä»¶:"
            find . -type f -maxdepth 2
            exit 1
          fi
          
          echo "ğŸ“ æ„å»ºäº§ç‰©ç›®å½•: $ARTIFACT_DIR"
          echo "ğŸ“ æ„å»ºäº§ç‰©ç›®å½•å†…å®¹:"
          ls -la "$ARTIFACT_DIR/"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
          FILE_COUNT=$(find "$ARTIFACT_DIR" -type f | wc -l)
          echo "ğŸ“Š æ–‡ä»¶æ•°é‡: $FILE_COUNT"
          
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "âŒ æ„å»ºäº§ç‰©ç›®å½•ä¸ºç©º"
            echo "ğŸ” è°ƒè¯•ä¿¡æ¯:"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -la ./
            echo "æ‰€æœ‰å­ç›®å½•:"
            find . -type d -maxdepth 2
            echo "æ‰€æœ‰æ–‡ä»¶:"
            find . -type f -maxdepth 2
            echo "ğŸš¨ å·¥ä½œæµé”™è¯¯ï¼šæ„å»ºäº§ç‰©è§£å‹åä¸ºç©ºï¼Œç«‹å³ç»ˆæ­¢éƒ¨ç½²"
            echo "å¯èƒ½çš„åŸå› :"
            echo "1. æ„å»ºäº§ç‰©ä¸‹è½½å¤±è´¥"
            echo "2. æ„å»ºäº§ç‰©è§£å‹å¤±è´¥"
            echo "3. æ„å»ºäº§ç‰©æœ¬èº«ä¸ºç©º"
            echo "4. æ–‡ä»¶æƒé™é—®é¢˜"
            exit 1
          fi
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "$ARTIFACT_DIR/index.html" ]; then
            echo "âœ… æ‰¾åˆ° index.html æ–‡ä»¶"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° index.html æ–‡ä»¶"
            echo "ğŸ“ æ„å»ºäº§ç‰©ä¸­çš„æ–‡ä»¶:"
            find "$ARTIFACT_DIR" -type f | head -20
          fi
          
          echo "âœ… æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡"
          echo "ğŸ“Š æ–‡ä»¶æ•°é‡: $FILE_COUNT"

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          echo "ğŸ” ç¡®å®šæ„å»ºäº§ç‰©è·¯å¾„..."
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la ./
          
          # ç¡®å®šæ„å»ºäº§ç‰©è·¯å¾„
          if [ -d "./dist-${{ steps.set-project-info.outputs.project }}" ]; then
            ARTIFACT_PATH="./dist-${{ steps.set-project-info.outputs.project }}"
            echo "ğŸ“ æ‰¾åˆ° dist-${{ steps.set-project-info.outputs.project }} ç›®å½•"
          elif [ -d "./dist" ]; then
            ARTIFACT_PATH="./dist"
            echo "ğŸ“ æ‰¾åˆ° dist ç›®å½•"
          elif [ -d "./docs/.vitepress/dist" ]; then
            ARTIFACT_PATH="./docs/.vitepress/dist"
            echo "ğŸ“ æ‰¾åˆ° docs/.vitepress/dist ç›®å½•"
          elif [ -f "./index.html" ]; then
            # æ„å»ºäº§ç‰©ç›´æ¥åœ¨å½“å‰ç›®å½•
            ARTIFACT_PATH="."
            echo "ğŸ“ æ„å»ºäº§ç‰©ç›´æ¥åœ¨å½“å‰ç›®å½•"
          else
            echo "âŒ æœªæ‰¾åˆ°æ„å»ºäº§ç‰©è·¯å¾„"
            echo "ğŸ” å½“å‰ç›®å½•å†…å®¹:"
            ls -la ./
            echo "ğŸ” æ‰€æœ‰å­ç›®å½•:"
            find . -type d -maxdepth 2
            echo "ğŸ” æ‰€æœ‰æ–‡ä»¶:"
            find . -type f -maxdepth 2
            exit 1
          fi
          
          echo "ğŸ“ æœ€ç»ˆæ„å»ºäº§ç‰©è·¯å¾„: $ARTIFACT_PATH"
          echo "ğŸ“ æ„å»ºäº§ç‰©å†…å®¹:"
          ls -la "$ARTIFACT_PATH/"
          
          # æœ€ç»ˆéªŒè¯ï¼šç¡®ä¿æ„å»ºäº§ç‰©ä¸ä¸ºç©º
          FINAL_FILE_COUNT=$(find "$ARTIFACT_PATH" -type f | wc -l)
          if [ "$FINAL_FILE_COUNT" -eq 0 ]; then
            echo "ğŸš¨ æœ€ç»ˆéªŒè¯å¤±è´¥ï¼šæ„å»ºäº§ç‰©ä¸ºç©º"
            exit 1
          fi
          
          echo "artifact_path=$ARTIFACT_PATH" >> $GITHUB_OUTPUT
          echo "artifact_size=$(du -sb $ARTIFACT_PATH | cut -f1)" >> $GITHUB_OUTPUT
          echo "âœ… è¾“å‡ºå·²è®¾ç½®"
          echo "æ„å»ºäº§ç‰©è·¯å¾„: $ARTIFACT_PATH"
          echo "æ„å»ºäº§ç‰©å¤§å°: $(du -sh $ARTIFACT_PATH | cut -f1)"

  deploy-project:
    needs: [download-artifact]
    runs-on: ubuntu-latest
    outputs:
      deploy_success: ${{ steps.set-outputs.outputs.deploy_success }}
      deploy_path: ${{ steps.set-outputs.outputs.deploy_path }}
    
    steps:
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.download-artifact.outputs.artifact_name }}
          path: ./
          github-token: ${{ needs.download-artifact.outputs.deploy_center_pat }}

      - name: éªŒè¯æ„å»ºäº§ç‰©è·¯å¾„
        id: validate-artifact
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºäº§ç‰©è·¯å¾„..."
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "æ„å»ºäº§ç‰©è·¯å¾„: ${{ needs.download-artifact.outputs.artifact_path }}"
          echo "æ„å»ºäº§ç‰©å¤§å°: ${{ needs.download-artifact.outputs.artifact_size }}"
          
          # ç¡®å®šæ„å»ºäº§ç‰©è·¯å¾„
          if [ -d "./dist-${{ needs.download-artifact.outputs.project }}" ]; then
            ARTIFACT_PATH="./dist-${{ needs.download-artifact.outputs.project }}"
            echo "ğŸ“ æ‰¾åˆ° dist-${{ needs.download-artifact.outputs.project }} ç›®å½•"
          elif [ -d "./dist" ]; then
            ARTIFACT_PATH="./dist"
            echo "ğŸ“ æ‰¾åˆ° dist ç›®å½•"
          elif [ -d "./docs/.vitepress/dist" ]; then
            ARTIFACT_PATH="./docs/.vitepress/dist"
            echo "ğŸ“ æ‰¾åˆ° docs/.vitepress/dist ç›®å½•"
          elif [ -f "./index.html" ]; then
            # æ„å»ºäº§ç‰©ç›´æ¥åœ¨å½“å‰ç›®å½•
            ARTIFACT_PATH="."
            echo "ğŸ“ æ„å»ºäº§ç‰©ç›´æ¥åœ¨å½“å‰ç›®å½•"
          else
            echo "âŒ æœªæ‰¾åˆ°æ„å»ºäº§ç‰©è·¯å¾„"
            echo "ğŸ” å½“å‰ç›®å½•å†…å®¹:"
            ls -la ./
            echo "ğŸ” æ‰€æœ‰å­ç›®å½•:"
            find . -type d -maxdepth 2
            echo "ğŸ” æ‰€æœ‰æ–‡ä»¶:"
            find . -type f -maxdepth 2
            exit 1
          fi
          
          if [ -z "$ARTIFACT_PATH" ]; then
            echo "ğŸš¨ æ„å»ºäº§ç‰©è·¯å¾„ä¸ºç©ºï¼Œç»ˆæ­¢éƒ¨ç½²"
            exit 1
          fi
          
          if [ ! -d "$ARTIFACT_PATH" ] && [ ! -f "$ARTIFACT_PATH/index.html" ]; then
            echo "ğŸš¨ æ„å»ºäº§ç‰©ç›®å½•ä¸å­˜åœ¨: $ARTIFACT_PATH"
            exit 1
          fi
          
          echo "ğŸ“ æ„å»ºäº§ç‰©ç›®å½•å†…å®¹:"
          ls -la "$ARTIFACT_PATH/"
          
          # éªŒè¯æ–‡ä»¶æ•°é‡
          FILE_COUNT=$(find "$ARTIFACT_PATH" -type f | wc -l)
          echo "ğŸ“Š æ–‡ä»¶æ•°é‡: $FILE_COUNT"
          
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "ğŸš¨ æ„å»ºäº§ç‰©ç›®å½•ä¸ºç©ºï¼Œç»ˆæ­¢éƒ¨ç½²"
            exit 1
          fi
          
          echo "âœ… æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡"
          echo "ğŸ“ æœ€ç»ˆæ„å»ºäº§ç‰©è·¯å¾„: $ARTIFACT_PATH"
          
          # è®¾ç½®è¾“å‡º
          echo "artifact_path=$ARTIFACT_PATH" >> $GITHUB_OUTPUT

      - name: å¤‡ä»½ç°æœ‰éƒ¨ç½²
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.download-artifact.outputs.server_host }}
          username: ${{ needs.download-artifact.outputs.server_user }}
          key: ${{ needs.download-artifact.outputs.server_key }}
          port: ${{ needs.download-artifact.outputs.server_port }}
          script: |
            echo "ğŸ“‹ å¤‡ä»½ç°æœ‰éƒ¨ç½²..."
            
            PROJECT="${{ needs.download-artifact.outputs.project }}"
            DEPLOY_TYPE="${{ inputs.deploy_type }}"
            DEPLOY_PATH="/srv/${{ inputs.deploy_type == 'backend' && 'apps' || 'static' }}/$PROJECT"
            
            # åˆ›å»ºé¡¹ç›®ä¸“ç”¨å¤‡ä»½ç›®å½•
            if [[ "$DEPLOY_TYPE" == "backend" ]]; then
              BACKUP_ROOT="/srv/backups/apps"
            else
              BACKUP_ROOT="/srv/backups/static"
            fi
            PROJECT_BACKUP_DIR="$BACKUP_ROOT/$PROJECT"
            echo "ğŸ“ åˆ›å»ºé¡¹ç›®å¤‡ä»½ç›®å½•: $PROJECT_BACKUP_DIR"
            sudo mkdir -p "$PROJECT_BACKUP_DIR"
            sudo chmod 755 "$PROJECT_BACKUP_DIR"
            
            # å¤‡ä»½ç°æœ‰éƒ¨ç½²ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -d "$DEPLOY_PATH" ]; then
              echo "ğŸ“‹ å¤‡ä»½ç°æœ‰éƒ¨ç½²ç›®å½•: $DEPLOY_PATH"
              BACKUP_NAME="$PROJECT_BACKUP_DIR/$PROJECT.backup.$(date +%Y%m%d_%H%M%S)"
              sudo cp -r $DEPLOY_PATH $BACKUP_NAME
              echo "âœ… ç°æœ‰éƒ¨ç½²ç›®å½•å·²å¤‡ä»½åˆ°: $BACKUP_NAME"
              
              # æ¸…ç†æ—§çš„å¤‡ä»½æ–‡ä»¶ï¼Œåªä¿ç•™æœ€è¿‘2ä¸ª
              echo "ğŸ§¹ æ¸…ç†æ—§çš„å¤‡ä»½æ–‡ä»¶..."
              BACKUP_FILES=$(ls -t "$PROJECT_BACKUP_DIR"/$PROJECT.backup.* 2>/dev/null | tail -n +3)
              if [ -n "$BACKUP_FILES" ]; then
                echo "ğŸ—‘ï¸ åˆ é™¤æ—§çš„å¤‡ä»½æ–‡ä»¶:"
                echo "$BACKUP_FILES" | xargs -r sudo rm -rf
                echo "âœ… æ—§å¤‡ä»½æ–‡ä»¶å·²æ¸…ç†ï¼Œä¿ç•™æœ€è¿‘2ä¸ªå¤‡ä»½"
              else
                echo "ğŸ“‹ æ²¡æœ‰éœ€è¦æ¸…ç†çš„æ—§å¤‡ä»½æ–‡ä»¶"
              fi
            else
              echo "ğŸ“‹ éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨ï¼Œæ— éœ€å¤‡ä»½: $DEPLOY_PATH"
            fi

      - name: ç›´æ¥éƒ¨ç½²åˆ°ç›®æ ‡ç›®å½•
        uses: appleboy/scp-action@v0.1.7
        with:
          host:     ${{ needs.download-artifact.outputs.server_host }}
          username: ${{ needs.download-artifact.outputs.server_user }}
          key:      ${{ needs.download-artifact.outputs.server_key }}
          port:     ${{ needs.download-artifact.outputs.server_port }}
          source:   "${{ needs.download-artifact.outputs.artifact_path }}"
          target:   "/srv/${{ inputs.deploy_type == 'backend' && 'apps' || 'static' }}/${{ needs.download-artifact.outputs.project }}"
          strip_components: 0

      - name: éªŒè¯éƒ¨ç½²ç»“æœ
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.download-artifact.outputs.server_host }}
          username: ${{ needs.download-artifact.outputs.server_user }}
          key: ${{ needs.download-artifact.outputs.server_key }}
          port: ${{ needs.download-artifact.outputs.server_port }}
          script: |
            echo "ğŸ” éªŒè¯éƒ¨ç½²ç»“æœ..."
            
            PROJECT="${{ needs.download-artifact.outputs.project }}"
            DEPLOY_TYPE="${{ inputs.deploy_type }}"
            DEPLOY_PATH="/srv/${{ inputs.deploy_type == 'backend' && 'apps' || 'static' }}/$PROJECT"
            
            echo "ğŸ“ æ£€æŸ¥éƒ¨ç½²ç›®å½•: $DEPLOY_PATH"
            
            if [ ! -d "$DEPLOY_PATH" ]; then
              echo "ğŸš¨ éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨: $DEPLOY_PATH"
              exit 1
            fi
            
            echo "ğŸ“ éƒ¨ç½²ç›®å½•å†…å®¹:"
            ls -la "$DEPLOY_PATH/"
            
            # æ£€æŸ¥æ–‡ä»¶æ•°é‡
            FILE_COUNT=$(find "$DEPLOY_PATH" -type f | wc -l)
            echo "ğŸ“Š æ–‡ä»¶æ•°é‡: $FILE_COUNT"
            
            if [ "$FILE_COUNT" -eq 0 ]; then
              echo "ğŸš¨ éƒ¨ç½²ç›®å½•ä¸ºç©ºï¼Œéƒ¨ç½²å¤±è´¥"
              echo "ğŸ” è°ƒè¯•ä¿¡æ¯:"
              echo "éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"
              echo "ç›®å½•æ˜¯å¦å­˜åœ¨: $(test -d "$DEPLOY_PATH" && echo 'æ˜¯' || echo 'å¦')"
              echo "ç›®å½•æƒé™: $(ls -ld "$DEPLOY_PATH" 2>/dev/null || echo 'æ— æ³•è·å–æƒé™')"
              exit 1
            fi
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ index.html æ–‡ä»¶
            if [ -f "$DEPLOY_PATH/index.html" ]; then
              echo "âœ… æ‰¾åˆ° index.html æ–‡ä»¶"
              echo "ğŸ“„ index.html å†…å®¹é¢„è§ˆ:"
              head -10 "$DEPLOY_PATH/index.html"
            else
              echo "âš ï¸ æœªæ‰¾åˆ° index.html æ–‡ä»¶"
              echo "ğŸ” æ£€æŸ¥æ‰€æœ‰æ–‡ä»¶:"
              find "$DEPLOY_PATH" -type f | head -10
            fi
            
            echo "âœ… éƒ¨ç½²éªŒè¯é€šè¿‡"

      - name: æ•´ç†éƒ¨ç½²ç›®å½•ç»“æ„
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.download-artifact.outputs.server_host }}
          username: ${{ needs.download-artifact.outputs.server_user }}
          key: ${{ needs.download-artifact.outputs.server_key }}
          port: ${{ needs.download-artifact.outputs.server_port }}
          script: |
            echo "ğŸ“ æ•´ç†éƒ¨ç½²ç›®å½•ç»“æ„..."
            
            PROJECT="${{ needs.download-artifact.outputs.project }}"
            DEPLOY_TYPE="${{ inputs.deploy_type }}"
            DEPLOY_PATH="/srv/${{ inputs.deploy_type == 'backend' && 'apps' || 'static' }}/$PROJECT"
            
            echo "ğŸ“ æ£€æŸ¥éƒ¨ç½²ç›®å½•: $DEPLOY_PATH"
            ls -la "$DEPLOY_PATH/"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ index.html æ–‡ä»¶
            if [ -f "$DEPLOY_PATH/index.html" ]; then
              echo "âœ… æ‰¾åˆ° index.html æ–‡ä»¶"
              echo "ğŸ“„ index.html å†…å®¹é¢„è§ˆ:"
              head -10 "$DEPLOY_PATH/index.html"
            else
              echo "âŒ æœªæ‰¾åˆ° index.html æ–‡ä»¶"
              echo "ğŸ” æ£€æŸ¥æ‰€æœ‰æ–‡ä»¶:"
              find "$DEPLOY_PATH" -type f | head -10
            fi
            
            # å¦‚æœå­˜åœ¨åµŒå¥—çš„github/workspaceç›®å½•ï¼Œéœ€è¦ç§»åŠ¨æ–‡ä»¶
            if [ -d "$DEPLOY_PATH/github/workspace" ]; then
              echo "ğŸ“ å‘ç°åµŒå¥—ç›®å½•ç»“æ„ï¼Œæ­£åœ¨æ•´ç†..."
              
              # åˆ›å»ºä¸´æ—¶ç›®å½•
              TEMP_DIR="/tmp/deploy-$PROJECT-temp"
              sudo mkdir -p "$TEMP_DIR"
              
              # ç§»åŠ¨æ‰€æœ‰æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
              sudo mv "$DEPLOY_PATH/github/workspace"/* "$TEMP_DIR/" 2>/dev/null || true
              
              # åˆ é™¤åŸå§‹ç›®å½•
              sudo rm -rf "$DEPLOY_PATH"
              
              # é‡æ–°åˆ›å»ºéƒ¨ç½²ç›®å½•
              sudo mkdir -p "$DEPLOY_PATH"
              
              # ç§»åŠ¨æ–‡ä»¶åˆ°æ­£ç¡®ä½ç½®
              sudo mv "$TEMP_DIR"/* "$DEPLOY_PATH/" 2>/dev/null || true
              
              # æ¸…ç†ä¸´æ—¶ç›®å½•
              sudo rm -rf "$TEMP_DIR"
              
              echo "âœ… ç›®å½•ç»“æ„æ•´ç†å®Œæˆ"
            elif [ -d "$DEPLOY_PATH/github" ]; then
              echo "ğŸ“ å‘ç°githubç›®å½•ï¼Œæ­£åœ¨æ•´ç†..."
              
              # åˆ›å»ºä¸´æ—¶ç›®å½•
              TEMP_DIR="/tmp/deploy-$PROJECT-temp"
              sudo mkdir -p "$TEMP_DIR"
              
              # ç§»åŠ¨æ‰€æœ‰æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
              sudo mv "$DEPLOY_PATH/github"/* "$TEMP_DIR/" 2>/dev/null || true
              
              # åˆ é™¤åŸå§‹ç›®å½•
              sudo rm -rf "$DEPLOY_PATH"
              
              # é‡æ–°åˆ›å»ºéƒ¨ç½²ç›®å½•
              sudo mkdir -p "$DEPLOY_PATH"
              
              # ç§»åŠ¨æ–‡ä»¶åˆ°æ­£ç¡®ä½ç½®
              sudo mv "$TEMP_DIR"/* "$DEPLOY_PATH/" 2>/dev/null || true
              
              # æ¸…ç†ä¸´æ—¶ç›®å½•
              sudo rm -rf "$TEMP_DIR"
              
              echo "âœ… ç›®å½•ç»“æ„æ•´ç†å®Œæˆ"
            else
              echo "âœ… ç›®å½•ç»“æ„æ­£å¸¸ï¼Œæ— éœ€æ•´ç†"
            fi
            
            echo "ğŸ“ æœ€ç»ˆéƒ¨ç½²ç›®å½•å†…å®¹:"
            ls -la "$DEPLOY_PATH/"
            
            # æœ€ç»ˆéªŒè¯ï¼šç¡®ä¿æ•´ç†åçš„ç›®å½•ä¸ä¸ºç©º
            FINAL_FILE_COUNT=$(find "$DEPLOY_PATH" -type f | wc -l)
            if [ "$FINAL_FILE_COUNT" -eq 0 ]; then
              echo "ğŸš¨ æ•´ç†åéƒ¨ç½²ç›®å½•ä¸ºç©ºï¼Œéƒ¨ç½²å¤±è´¥"
              exit 1
            fi
            
            echo "âœ… ç›®å½•æ•´ç†å®Œæˆï¼Œæ–‡ä»¶æ•°é‡: $FINAL_FILE_COUNT"
            
            # è®¾ç½®æ­£ç¡®çš„æƒé™
            sudo chown -R deploy:deploy "$DEPLOY_PATH"
            sudo chmod -R 755 "$DEPLOY_PATH"

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          echo "deploy_success=true" >> $GITHUB_OUTPUT
          echo "deploy_path=/srv/${{ inputs.deploy_type == 'backend' && 'apps' || 'static' }}/${{ needs.download-artifact.outputs.project }}" >> $GITHUB_OUTPUT
          echo "âœ… éƒ¨ç½²å®Œæˆ"

  configure-nginx:
    needs: [deploy-project]
    if: ${{ inputs.nginx_config != '' }}
    uses: MoseLu/axi-deploy/.github/workflows/configure-nginx.yml@master
    with:
      project: ${{ needs.download-artifact.outputs.project }}
      server_host: ${{ needs.download-artifact.outputs.server_host }}
      server_user: ${{ needs.download-artifact.outputs.server_user }}
      server_key: ${{ needs.download-artifact.outputs.server_key }}
      server_port: ${{ needs.download-artifact.outputs.server_port }}
      deploy_type: ${{ inputs.deploy_type }}
      nginx_config: ${{ inputs.nginx_config }}

  start-service:
    needs: [deploy-project]
    if: ${{ inputs.start_cmd != '' && inputs.deploy_type == 'backend' }}
    runs-on: ubuntu-latest
    outputs:
      start_success: ${{ steps.set-outputs.outputs.start_success }}
    
    steps:
      - name: å¯åŠ¨æœåŠ¡
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.download-artifact.outputs.server_host }}
          username: ${{ needs.download-artifact.outputs.server_user }}
          key: ${{ needs.download-artifact.outputs.server_key }}
          port: ${{ needs.download-artifact.outputs.server_port }}
          script: |
            echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
            
            PROJECT="${{ needs.download-artifact.outputs.project }}"
            START_CMD="${{ inputs.start_cmd }}"
            APPS_ROOT="/srv/apps"
            
            # åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
            cd "$APPS_ROOT/$PROJECT"
            
            # éªŒè¯é¡¹ç›®ç›®å½•æ˜¯å¦å­˜åœ¨
            if [ ! -d "$APPS_ROOT/$PROJECT" ]; then
              echo "ğŸš¨ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $APPS_ROOT/$PROJECT"
              exit 1
            fi
            
            # éªŒè¯é¡¹ç›®ç›®å½•ä¸ä¸ºç©º
            FILE_COUNT=$(find "$APPS_ROOT/$PROJECT" -type f | wc -l)
            if [ "$FILE_COUNT" -eq 0 ]; then
              echo "ğŸš¨ é¡¹ç›®ç›®å½•ä¸ºç©º: $APPS_ROOT/$PROJECT"
              exit 1
            fi
            
            echo "âœ… é¡¹ç›®ç›®å½•éªŒè¯é€šè¿‡ï¼Œæ–‡ä»¶æ•°é‡: $FILE_COUNT"
            
            # æ‰§è¡Œå¯åŠ¨å‘½ä»¤
            echo "ğŸ“‹ æ‰§è¡Œå¯åŠ¨å‘½ä»¤: $START_CMD"
            $START_CMD
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 5
            
            echo "âœ… æœåŠ¡å¯åŠ¨å®Œæˆ"

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          echo "start_success=true" >> $GITHUB_OUTPUT
          echo "âœ… å¯åŠ¨å®Œæˆ"

  test-website:
    needs: [deploy-project, configure-nginx, start-service]
    if: ${{ inputs.test_url != '' }}
    runs-on: ubuntu-latest
    outputs:
      test_success: ${{ steps.set-outputs.outputs.test_success }}
    
    steps:
      - name: æµ‹è¯•ç½‘ç«™å¯è®¿é—®æ€§
        run: |
          echo "ğŸ” æµ‹è¯•ç½‘ç«™å¯è®¿é—®æ€§..."
          echo "æµ‹è¯•URL: ${{ inputs.test_url }}"
          
          # ç­‰å¾…ä¸€æ®µæ—¶é—´è®©æœåŠ¡å®Œå…¨å¯åŠ¨
          sleep 10
          
          # æµ‹è¯•ç½‘ç«™å¯è®¿é—®æ€§
          HTTP_STATUS=$(curl -f -s -o /dev/null -w "%{http_code}" "${{ inputs.test_url }}" 2>/dev/null || echo "000")
          echo "ğŸ“‹ HTTPçŠ¶æ€ç : $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "301" ] || [ "$HTTP_STATUS" = "302" ]; then
            echo "âœ… ç½‘ç«™å¯æ­£å¸¸è®¿é—®"
          else
            echo "âŒ ç½‘ç«™æ— æ³•è®¿é—®ï¼ŒHTTPçŠ¶æ€ç : $HTTP_STATUS"
            echo "ğŸš¨ å·¥ä½œæµé”™è¯¯ï¼šç½‘ç«™è¿”å› $HTTP_STATUS çŠ¶æ€ç ï¼Œè¿™è¡¨ç¤ºé…ç½®æœ‰é—®é¢˜"
            echo "å¯èƒ½çš„åŸå› :"
            echo "1. Nginxé…ç½®é”™è¯¯"
            echo "2. æ–‡ä»¶æƒé™é—®é¢˜"
            echo "3. è·¯å¾„ä¸å­˜åœ¨"
            echo "4. SSLè¯ä¹¦é—®é¢˜"
            exit 1
          fi

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          echo "test_success=true" >> $GITHUB_OUTPUT
          echo "âœ… æµ‹è¯•å®Œæˆ"

  deployment-summary:
    needs: [download-artifact, deploy-project, configure-nginx, start-service, test-website]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: éƒ¨ç½²å®Œæˆæ€»ç»“
        run: |
          echo "ğŸ‰ éƒ¨ç½²æµç¨‹å®Œæˆ"
          echo "=========================================="
          echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯:"
          echo "- é¡¹ç›®: ${{ needs.download-artifact.outputs.project }}"
          echo "- éƒ¨ç½²ç±»å‹: ${{ inputs.deploy_type }}"
          echo "- æºä»“åº“: ${{ needs.download-artifact.outputs.source_repo }}"
          echo "- æ„å»ºID: ${{ needs.download-artifact.outputs.run_id }}"
          echo ""
          echo "ğŸ“Š æ‰§è¡ŒçŠ¶æ€:"
          echo "- ä¸‹è½½æ„å»ºäº§ç‰©: ${{ needs.download-artifact.result }}"
          echo "- éƒ¨ç½²é¡¹ç›®: ${{ needs.deploy-project.result }}"
          echo "- é…ç½®Nginx: ${{ needs.configure-nginx.result || 'skipped' }}"
          echo "- å¯åŠ¨æœåŠ¡: ${{ needs.start-service.result || 'skipped' }}"
          echo "- æµ‹è¯•ç½‘ç«™: ${{ needs.test-website.result || 'skipped' }}"
          echo ""
          echo "ğŸ”— è®¿é—®ä¿¡æ¯:"
          echo "- åŸŸå: redamancy.com.cn"
          echo "- é¡¹ç›®è·¯å¾„: ${{ needs.deploy-project.outputs.deploy_path }}"
          if [ "${{ inputs.test_url }}" != "" ]; then
            echo "- æµ‹è¯•URL: ${{ inputs.test_url }}"
          fi
          echo ""
          echo "ğŸ“ éƒ¨ç½²å®Œæˆé€šçŸ¥:"
          echo "âœ… é¡¹ç›® ${{ needs.download-artifact.outputs.project }} å·²æˆåŠŸéƒ¨ç½²åˆ°æœåŠ¡å™¨"
          if [ "${{ inputs.test_url }}" != "" ]; then
            echo "ğŸŒ å¯é€šè¿‡ ${{ inputs.test_url }} è®¿é—®"
          fi
          echo "=========================================="