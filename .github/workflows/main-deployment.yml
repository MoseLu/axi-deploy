name: Main Deployment

description: "主部署工作流 - 整个部署流程的入口点"

on:
  workflow_dispatch:
    inputs:
      project:
        description: '项目名称'
        required: true
        type: string
      source_repo:
        description: '源仓库 (格式: owner/repo)'
        required: true
        type: string
      run_id:
        description: '构建运行ID'
        required: true
        type: string
      deploy_type:
        description: '部署类型'
        required: true
        default: 'static'
        type: choice
        options:
          - static
          - backend
      nginx_config:
        description: 'Nginx配置（可选）'
        required: false
        type: string
      test_url:
        description: '测试URL（可选）'
        required: false
        type: string
      start_cmd:
        description: '启动命令（后端项目）'
        required: false
        type: string
      domain:
        description: '域名'
        required: false
        default: 'redamancy.com.cn'
        type: string
      apps_root:
        description: '应用目录路径'
        required: false
        default: '/srv/apps'
        type: string
      static_root:
        description: '静态文件目录路径'
        required: false
        default: '/srv/static'
        type: string
      backup_root:
        description: '备份根目录'
        required: false
        default: '/srv/backups'
        type: string
      run_user:
        description: '运行用户'
        required: false
        default: 'deploy'
        type: string
      nginx_conf_dir:
        description: 'Nginx配置目录'
        required: false
        default: '/www/server/nginx/conf/conf.d/redamancy'
        type: string
      backend_port:
        description: '后端服务端口'
        required: false
        default: '8080'
        type: string
      service_name:
        description: '服务名称'
        required: false
        default: 'star-cloud'
        type: string

jobs:
  deployment-orchestrator:
    uses: ./.github/workflows/deployment-orchestrator.yml
    with:
      project: ${{ inputs.project }}
      source_repo: ${{ inputs.source_repo }}
      run_id: ${{ inputs.run_id }}
      deploy_type: ${{ inputs.deploy_type }}
      nginx_config: ${{ inputs.nginx_config }}
      test_url: ${{ inputs.test_url }}
      start_cmd: ${{ inputs.start_cmd }}
      domain: ${{ inputs.domain }}
      apps_root: ${{ inputs.apps_root }}
      static_root: ${{ inputs.static_root }}
      backup_root: ${{ inputs.backup_root }}
      run_user: ${{ inputs.run_user }}
      nginx_conf_dir: ${{ inputs.nginx_conf_dir }}
      backend_port: ${{ inputs.backend_port }}
      service_name: ${{ inputs.service_name }}
