name: Dynamic Port Allocation

description: "åŠ¨æ€ç«¯å£åˆ†é… - åœ¨æœåŠ¡å™¨ä¸Šæ£€æŸ¥ç«¯å£å ç”¨å¹¶è‡ªåŠ¨åˆ†é…å¯ç”¨ç«¯å£"

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
        description: "é¡¹ç›®åç§°"
      server_host:
        required: true
        type: string
        description: "æœåŠ¡å™¨åœ°å€"
      server_user:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç”¨æˆ·"
      server_key:
        required: true
        type: string
        description: "æœåŠ¡å™¨å¯†é’¥"
      server_port:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç«¯å£"
      port_range_start:
        required: false
        type: string
        description: "ç«¯å£èŒƒå›´èµ·å§‹"
        default: "8080"
      port_range_end:
        required: false
        type: string
        description: "ç«¯å£èŒƒå›´ç»“æŸ"
        default: "10000"
      preferred_port:
        required: false
        type: string
        description: "é¦–é€‰ç«¯å£ï¼ˆå¦‚æœå¯ç”¨ï¼‰"
        default: ""
      force_reallocate:
        required: false
        type: boolean
        description: "å¼ºåˆ¶é‡æ–°åˆ†é…ç«¯å£"
        default: false
    outputs:
      allocated_port:
        description: "åˆ†é…çš„ç«¯å£"
        value: ${{ jobs.allocate.outputs.allocated_port }}
      allocation_success:
        description: "åˆ†é…æ˜¯å¦æˆåŠŸ"
        value: ${{ jobs.allocate.outputs.allocation_success }}
      port_config_updated:
        description: "ç«¯å£é…ç½®æ˜¯å¦å·²æ›´æ–°"
        value: ${{ jobs.allocate.outputs.port_config_updated }}

jobs:
  allocate:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      allocated_port: ${{ steps.set-outputs.outputs.allocated_port }}
      allocation_success: ${{ steps.set-outputs.outputs.allocation_success }}
      port_config_updated: ${{ steps.set-outputs.outputs.port_config_updated }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: éªŒè¯è¾“å…¥å‚æ•°
        run: |
          echo "ğŸ” éªŒè¯è¾“å…¥å‚æ•°..."
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- æœåŠ¡å™¨: ${{ inputs.server_host }}:${{ inputs.server_port }}"
          echo "- ç«¯å£èŒƒå›´: ${{ inputs.port_range_start }}-${{ inputs.port_range_end }}"
          echo "- é¦–é€‰ç«¯å£: ${{ inputs.preferred_port || 'æ— ' }}"
          echo "- å¼ºåˆ¶é‡æ–°åˆ†é…: ${{ inputs.force_reallocate }}"
          
          # éªŒè¯ç«¯å£èŒƒå›´
          if [ "${{ inputs.port_range_start }}" -gt "${{ inputs.port_range_end }}" ]; then
            echo "ğŸš¨ ç«¯å£èŒƒå›´é”™è¯¯ï¼šèµ·å§‹ç«¯å£å¤§äºç»“æŸç«¯å£"
            exit 1
          fi
          
          echo "âœ… è¾“å…¥å‚æ•°éªŒè¯é€šè¿‡"

      - name: åˆ›å»ºSSHå¯†é’¥
        run: |
          echo "${{ inputs.server_key }}" > /tmp/ssh_key
          chmod 600 /tmp/ssh_key

      - name: åŠ¨æ€ç«¯å£åˆ†é…
        id: port-allocation
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ğŸ” å¼€å§‹åŠ¨æ€ç«¯å£åˆ†é…..."
            
            PROJECT_NAME="${{ inputs.project }}"
            PORT_START="${{ inputs.port_range_start }}"
            PORT_END="${{ inputs.port_range_end }}"
            PREFERRED_PORT="${{ inputs.preferred_port }}"
            FORCE_REALLOCATE="${{ inputs.force_reallocate }}"
            
                         # æ£€æŸ¥ç«¯å£å ç”¨å‡½æ•°
             check_port_available() {
               local port=$1
               # æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«ç›‘å¬
               if netstat -tlnp 2>/dev/null | grep -q ":$port "; then
                 return 1  # ç«¯å£è¢«å ç”¨
               fi
               # æ£€æŸ¥ç«¯å£æ˜¯å¦åœ¨é˜²ç«å¢™ä¸­å¼€æ”¾ï¼ˆé™é»˜æ£€æŸ¥ï¼Œä¸è¾“å‡ºä¿¡æ¯ï¼‰
               if command -v firewall-cmd >/dev/null 2>&1; then
                 if ! firewall-cmd --list-ports 2>/dev/null | grep -q "$port"; then
                   return 1
                 fi
               fi
               return 0  # ç«¯å£å¯ç”¨
             }
            
                         # æŸ¥æ‰¾å¯ç”¨ç«¯å£å‡½æ•°
             find_available_port() {
               local start_port=$1
               local end_port=$2
               local preferred_port=$3
               
               echo "ğŸ” åœ¨ç«¯å£èŒƒå›´ $start_port-$end_port ä¸­æŸ¥æ‰¾å¯ç”¨ç«¯å£..." >&2
               
               # å¦‚æœæŒ‡å®šäº†é¦–é€‰ç«¯å£ï¼Œå…ˆæ£€æŸ¥
               if [ -n "$preferred_port" ] && [ "$preferred_port" -ge "$start_port" ] && [ "$preferred_port" -le "$end_port" ]; then
                 echo "ğŸ¯ æ£€æŸ¥é¦–é€‰ç«¯å£: $preferred_port" >&2
                 if check_port_available "$preferred_port"; then
                   echo "âœ… é¦–é€‰ç«¯å£ $preferred_port å¯ç”¨" >&2
                   echo "$preferred_port"
                   return 0
                 else
                   echo "âŒ é¦–é€‰ç«¯å£ $preferred_port ä¸å¯ç”¨" >&2
                 fi
               fi
               
               # ä»èµ·å§‹ç«¯å£å¼€å§‹æŸ¥æ‰¾
               for port in $(seq "$start_port" "$end_port"); do
                 if check_port_available "$port"; then
                   echo "âœ… æ‰¾åˆ°å¯ç”¨ç«¯å£: $port" >&2
                   echo "$port"
                   return 0
                 fi
               done
               
               echo "âŒ åœ¨ç«¯å£èŒƒå›´ $start_port-$end_port ä¸­æœªæ‰¾åˆ°å¯ç”¨ç«¯å£" >&2
               return 1
             }
            
                         # æ›´æ–°ç«¯å£é…ç½®æ–‡ä»¶å‡½æ•°
             update_port_config() {
               local project=$1
               local port=$2
               local config_file="/srv/port-config.yml"
               
               echo "ğŸ“ æ›´æ–°ç«¯å£é…ç½®æ–‡ä»¶: $config_file"
               
               # åˆ›å»ºé…ç½®ç›®å½•
               sudo mkdir -p "$(dirname "$config_file")"
               
               # å¦‚æœé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºåŸºç¡€ç»“æ„
               if [ ! -f "$config_file" ]; then
                 echo "# åŠ¨æ€ç«¯å£é…ç½®" | sudo tee "$config_file" > /dev/null
                 echo "# è‡ªåŠ¨ç”Ÿæˆå’Œç»´æŠ¤" | sudo tee -a "$config_file" > /dev/null
                 echo "# æœ€åæ›´æ–°: $(date)" | sudo tee -a "$config_file" > /dev/null
                 echo "" | sudo tee -a "$config_file" > /dev/null
                 echo "projects:" | sudo tee -a "$config_file" > /dev/null
               fi
               
               # æ£€æŸ¥é¡¹ç›®æ˜¯å¦å·²å­˜åœ¨
               if grep -q "^  $project:" "$config_file"; then
                 echo "ğŸ”„ æ›´æ–°ç°æœ‰é¡¹ç›®ç«¯å£é…ç½®"
                 # æ›´æ–°ç°æœ‰é¡¹ç›®çš„ç«¯å£
                 sudo sed -i "/^  $project:/,/^  [^ ]/ { /^    port:/ s/:.*/: $port/ }" "$config_file"
               else
                 echo "â• æ·»åŠ æ–°é¡¹ç›®ç«¯å£é…ç½®"
                 # åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ æ–°é¡¹ç›®
                 echo "" | sudo tee -a "$config_file" > /dev/null
                 echo "  $project:" | sudo tee -a "$config_file" > /dev/null
                 echo "    port: $port" | sudo tee -a "$config_file" > /dev/null
                 echo "    description: \"è‡ªåŠ¨åˆ†é… - $(date)\"" | sudo tee -a "$config_file" > /dev/null
                 echo "    allocated_at: \"$(date -Iseconds)\"" | sudo tee -a "$config_file" > /dev/null
               fi
               
               echo "âœ… ç«¯å£é…ç½®æ–‡ä»¶å·²æ›´æ–°"
             }
             
             # æ›´æ–°åº”ç”¨ç¨‹åºé…ç½®æ–‡ä»¶å‡½æ•°
             update_app_config() {
               local project=$1
               local port=$2
               
               echo "ğŸ”§ æ›´æ–°åº”ç”¨ç¨‹åºé…ç½®æ–‡ä»¶..."
               
               # æŸ¥æ‰¾é¡¹ç›®ç›®å½•
               local project_dir="/srv/apps/$project"
               if [ ! -d "$project_dir" ]; then
                 echo "âš ï¸ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $project_dir"
                 return 0
               fi
               
               echo "ğŸ“ é¡¹ç›®ç›®å½•: $project_dir"
               
               # é’ˆå¯¹ä¸åŒé¡¹ç›®ç±»å‹çš„é…ç½®æ–‡ä»¶æ›´æ–°
               case "$project" in
                 "axi-star-cloud")
                   # æ›´æ–° Go é¡¹ç›®çš„é…ç½®æ–‡ä»¶
                   local config_file="$project_dir/backend/config/config-prod.yaml"
                   if [ -f "$config_file" ]; then
                     echo "ğŸ“ æ›´æ–° Go é…ç½®æ–‡ä»¶: $config_file"
                     # å¤‡ä»½åŸé…ç½®æ–‡ä»¶
                     sudo cp "$config_file" "$config_file.backup.$(date +%Y%m%d_%H%M%S)"
                     # æ›´æ–°ç«¯å£
                     sudo sed -i "s/port: '8080'/port: '$port'/" "$config_file"
                     echo "âœ… Go é…ç½®æ–‡ä»¶å·²æ›´æ–°: 8080 -> $port"
                   else
                     echo "âš ï¸ Go é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $config_file"
                   fi
                   
                   # æ›´æ–°å¼€å‘ç¯å¢ƒé…ç½®æ–‡ä»¶
                   local dev_config_file="$project_dir/backend/config/config.yaml"
                   if [ -f "$dev_config_file" ]; then
                     echo "ğŸ“ æ›´æ–°å¼€å‘ç¯å¢ƒé…ç½®æ–‡ä»¶: $dev_config_file"
                     sudo sed -i "s/port: '8080'/port: '$port'/" "$dev_config_file"
                     echo "âœ… å¼€å‘ç¯å¢ƒé…ç½®æ–‡ä»¶å·²æ›´æ–°: 8080 -> $port"
                   fi
                   ;;
                 "axi-project-dashboard")
                   # æ›´æ–° Node.js é¡¹ç›®çš„é…ç½®æ–‡ä»¶
                   local ecosystem_file="$project_dir/ecosystem.config.js"
                   if [ -f "$ecosystem_file" ]; then
                     echo "ğŸ“ æ›´æ–° PM2 é…ç½®æ–‡ä»¶: $ecosystem_file"
                     # å¤‡ä»½åŸé…ç½®æ–‡ä»¶
                     sudo cp "$ecosystem_file" "$ecosystem_file.backup.$(date +%Y%m%d_%H%M%S)"
                     # æ›´æ–°ç«¯å£
                     sudo sed -i "s/port: 8090/port: $port/" "$ecosystem_file"
                     echo "âœ… PM2 é…ç½®æ–‡ä»¶å·²æ›´æ–°: 8090 -> $port"
                   else
                     echo "âš ï¸ PM2 é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $ecosystem_file"
                   fi
                   
                   # æ›´æ–° package.json ä¸­çš„ç«¯å£ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                   local package_file="$project_dir/package.json"
                   if [ -f "$package_file" ]; then
                     echo "ğŸ“ æ›´æ–° package.json ç«¯å£é…ç½®"
                     sudo sed -i "s/\"PORT\": \"8090\"/\"PORT\": \"$port\"/" "$package_file"
                     echo "âœ… package.json å·²æ›´æ–°: 8090 -> $port"
                   fi
                   ;;
                 *)
                   echo "âš ï¸ æœªçŸ¥é¡¹ç›®ç±»å‹: $projectï¼Œè·³è¿‡é…ç½®æ–‡ä»¶æ›´æ–°"
                   ;;
               esac
               
               echo "âœ… åº”ç”¨ç¨‹åºé…ç½®æ–‡ä»¶æ›´æ–°å®Œæˆ"
             }
            
            # ä¸»é€»è¾‘
            echo "ğŸ“‹ é¡¹ç›®ä¿¡æ¯:"
            echo "- é¡¹ç›®åç§°: $PROJECT_NAME"
            echo "- ç«¯å£èŒƒå›´: $PORT_START-$PORT_END"
            echo "- é¦–é€‰ç«¯å£: ${PREFERRED_PORT:-'æ— '}"
            echo "- å¼ºåˆ¶é‡æ–°åˆ†é…: $FORCE_REALLOCATE"
            
            # æŸ¥æ‰¾å¯ç”¨ç«¯å£
            ALLOCATED_PORT=$(find_available_port "$PORT_START" "$PORT_END" "$PREFERRED_PORT")
            
                         if [ $? -eq 0 ]; then
               echo "ğŸ‰ ç«¯å£åˆ†é…æˆåŠŸ: $ALLOCATED_PORT"
               
               # æ›´æ–°ç«¯å£é…ç½®æ–‡ä»¶
               update_port_config "$PROJECT_NAME" "$ALLOCATED_PORT"
               
               # æ›´æ–°åº”ç”¨ç¨‹åºé…ç½®æ–‡ä»¶
               update_app_config "$PROJECT_NAME" "$ALLOCATED_PORT"
               
               # è¾“å‡ºç»“æœåˆ°ä¸´æ—¶æ–‡ä»¶ï¼Œä¾›åç»­æ­¥éª¤è¯»å–
               echo "$ALLOCATED_PORT" > /tmp/allocated_port.txt
               echo "true" > /tmp/allocation_success.txt
               echo "true" > /tmp/port_config_updated.txt
              
              # æ˜¾ç¤ºå½“å‰ç«¯å£ä½¿ç”¨æƒ…å†µ
              echo "ğŸ“Š å½“å‰ç«¯å£ä½¿ç”¨æƒ…å†µ:"
              netstat -tlnp 2>/dev/null | grep -E ":(808[0-9]|809[0-9]|81[0-9][0-9]|82[0-9][0-9]|83[0-9][0-9]|84[0-9][0-9]|85[0-9][0-9]|86[0-9][0-9]|87[0-9][0-9]|88[0-9][0-9]|89[0-9][0-9]|9[0-9][0-9][0-9]) " | head -10
              
            else
              echo "âŒ ç«¯å£åˆ†é…å¤±è´¥"
              echo "" > /tmp/allocated_port.txt
              echo "false" > /tmp/allocation_success.txt
              echo "false" > /tmp/port_config_updated.txt
              exit 1
            fi

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          # ä»æœåŠ¡å™¨è¯»å–ç«¯å£åˆ†é…ç»“æœ
          ALLOCATED_PORT=$(ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i /tmp/ssh_key -p ${{ inputs.server_port }} ${{ inputs.server_user }}@${{ inputs.server_host }} "cat /tmp/allocated_port.txt 2>/dev/null || echo ''")
          ALLOCATION_SUCCESS=$(ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i /tmp/ssh_key -p ${{ inputs.server_port }} ${{ inputs.server_user }}@${{ inputs.server_host }} "cat /tmp/allocation_success.txt 2>/dev/null || echo 'false'")
          PORT_CONFIG_UPDATED=$(ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i /tmp/ssh_key -p ${{ inputs.server_port }} ${{ inputs.server_user }}@${{ inputs.server_host }} "cat /tmp/port_config_updated.txt 2>/dev/null || echo 'false'")
          
          echo "ğŸ“‹ ç«¯å£åˆ†é…ç»“æœ:"
          echo "- åˆ†é…ç«¯å£: $ALLOCATED_PORT"
          echo "- åˆ†é…æˆåŠŸ: $ALLOCATION_SUCCESS"
          echo "- é…ç½®æ›´æ–°: $PORT_CONFIG_UPDATED"
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "allocated_port=$ALLOCATED_PORT" >> $GITHUB_OUTPUT
          echo "allocation_success=$ALLOCATION_SUCCESS" >> $GITHUB_OUTPUT
          echo "port_config_updated=$PORT_CONFIG_UPDATED" >> $GITHUB_OUTPUT

      - name: æ˜¾ç¤ºåˆ†é…ç»“æœ
        run: |
          echo "ğŸ‰ åŠ¨æ€ç«¯å£åˆ†é…å®Œæˆ"
          echo "=========================================="
          echo "ğŸ“‹ åˆ†é…ä¿¡æ¯:"
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- åˆ†é…ç«¯å£: ${{ steps.set-outputs.outputs.allocated_port }}"
          echo "- åˆ†é…çŠ¶æ€: ${{ steps.set-outputs.outputs.allocation_success }}"
          echo "- é…ç½®æ›´æ–°: ${{ steps.set-outputs.outputs.port_config_updated }}"
          echo ""
          echo "ğŸ“ ä½¿ç”¨è¯´æ˜:"
          echo "1. åˆ†é…çš„ç«¯å£å·²è‡ªåŠ¨æ›´æ–°åˆ°æœåŠ¡å™¨çš„ /srv/port-config.yml"
          echo "2. åç»­éƒ¨ç½²å°†è‡ªåŠ¨ä½¿ç”¨æ­¤ç«¯å£"
          echo "3. å¦‚éœ€é‡æ–°åˆ†é…ï¼Œè¯·è®¾ç½® force_reallocate=true"
