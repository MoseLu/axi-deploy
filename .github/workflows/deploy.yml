name: Deploy Any Project

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'é¡¹ç›®æ ‡è¯†'
        required: true
        type: string
      lang:
        description: 'é¡¹ç›®è¯­è¨€'
        required: true
        type: string
      artifact_id:
        description: 'æž„å»ºäº§ç‰©ID'
        required: true
        type: string
      deploy_path:
        description: 'æœåŠ¡å™¨éƒ¨ç½²è·¯å¾„'
        required: true
        type: string
      start_cmd:
        description: 'å¯åŠ¨/é‡å¯å‘½ä»¤'
        required: true
        type: string
      caller_repo:
        description: 'è°ƒç”¨æ–¹ä»“åº“'
        required: true
        type: string
      caller_branch:
        description: 'è°ƒç”¨æ–¹åˆ†æ”¯'
        required: true
        type: string
      caller_commit:
        description: 'è°ƒç”¨æ–¹æäº¤'
        required: true
        type: string
      artifact_url:
        description: 'æž„å»ºäº§ç‰©ä¸‹è½½URL'
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
        run: |
          echo "ðŸš€ å¼€å§‹éƒ¨ç½²é¡¹ç›®"
          echo "é¡¹ç›®: ${{ github.event.inputs.project }}"
          echo "è¯­è¨€: ${{ github.event.inputs.lang }}"
          echo "è°ƒç”¨æ–¹: ${{ github.event.inputs.caller_repo }}"
          echo "åˆ†æ”¯: ${{ github.event.inputs.caller_branch }}"
          echo "æäº¤: ${{ github.event.inputs.caller_commit }}"
          echo "éƒ¨ç½²è·¯å¾„: ${{ github.event.inputs.deploy_path }}"
          echo "å¯åŠ¨å‘½ä»¤: ${{ github.event.inputs.start_cmd }}"
          echo "éƒ¨ç½²æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
      
      - name: ä¸‹è½½æž„å»ºäº§ç‰©
        if: github.event.inputs.artifact_url != ''
        run: |
          echo "ðŸ“¥ ä»ŽURLä¸‹è½½æž„å»ºäº§ç‰©..."
          curl -L -o artifact.zip "${{ github.event.inputs.artifact_url }}"
          unzip artifact.zip -d ./dist/
          rm artifact.zip
      
      - name: ä¸‹è½½æž„å»ºäº§ç‰© (GitHub Actions)
        if: github.event.inputs.artifact_url == ''
        uses: actions/download-artifact@v4
        with:
          name: dist-${{ github.event.inputs.project }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.inputs.artifact_id }}
      
      - name: è®¾ç½®SSHçŽ¯å¢ƒ
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # é…ç½®SSHé€‰é¡¹
          cat > ~/.ssh/config << EOF
          Host ${{ secrets.SERVER_HOST }}
            HostName ${{ secrets.SERVER_HOST }}
            Port ${{ secrets.SERVER_PORT }}
            User ${{ secrets.SERVER_USER }}
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF
          chmod 600 ~/.ssh/config
      
      - name: æµ‹è¯•SSHè¿žæŽ¥
        run: |
          echo "ðŸ” æµ‹è¯•SSHè¿žæŽ¥..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo 'âœ… SSHè¿žæŽ¥æµ‹è¯•æˆåŠŸ'"
      
      - name: åˆ›å»ºè¿œç¨‹ç›®å½•
        run: |
          echo "ðŸ“ åˆ›å»ºè¿œç¨‹ç›®å½•: ${{ github.event.inputs.deploy_path }}"
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "mkdir -p ${{ github.event.inputs.deploy_path }}"
      
      - name: ä¼ è¾“æ–‡ä»¶
        run: |
          echo "ðŸ“¤ å¼€å§‹ä¼ è¾“æ–‡ä»¶..."
          echo "æºè·¯å¾„: ./"
          echo "ç›®æ ‡è·¯å¾„: ${{ github.event.inputs.deploy_path }}"
          
          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }}" \
            "./" \
            "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ github.event.inputs.deploy_path }}/"
          
          echo "âœ… æ–‡ä»¶ä¼ è¾“å®Œæˆ"
      
      - name: æ‰§è¡Œå¯åŠ¨å‘½ä»¤
        run: |
          echo "âš™ï¸ æ‰§è¡Œå¯åŠ¨å‘½ä»¤..."
          echo "å‘½ä»¤: ${{ github.event.inputs.start_cmd }}"
          
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e
          ${{ github.event.inputs.start_cmd }}
          EOF
          
          echo "âœ… å¯åŠ¨å‘½ä»¤æ‰§è¡Œå®Œæˆ"
      
      - name: éªŒè¯éƒ¨ç½²
        run: |
          echo "ðŸ” éªŒè¯éƒ¨ç½²ç»“æžœ..."
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "ls -la ${{ github.event.inputs.deploy_path }}"
      
      - name: éƒ¨ç½²å®Œæˆ
        run: |
          echo "ðŸŽ‰ éƒ¨ç½²å®Œæˆ!"
          echo "é¡¹ç›®: ${{ github.event.inputs.project }}"
          echo "éƒ¨ç½²æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ç›®æ ‡è·¯å¾„: ${{ github.event.inputs.deploy_path }}"
      
      - name: æ¸…ç†SSHå¯†é’¥
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
          rm -f ~/.ssh/known_hosts
          echo "ðŸ§¹ SSHå¯†é’¥å·²æ¸…ç†" 