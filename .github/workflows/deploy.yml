name: External Deploy Dispatcher

on:
  workflow_dispatch:
    inputs:
      project:        { required: true, type: string }  # é¡¹ç›®åï¼Œå¦‚ axi-docs
      lang:           { required: true, type: string }  # è¯­è¨€ç±»å‹å¤‡ç”¨
      artifact_id:    { required: true, type: string }  # ä¸šåŠ¡ä»“åº“ run_id
      deploy_path:    { required: true, type: string }  # æœåŠ¡å™¨éƒ¨ç½²ç›®å½•
      start_cmd:      { required: true, type: string }  # éƒ¨ç½²åæ‰§è¡Œçš„å‘½ä»¤
      caller_info:    { required: false, type: string }
      run_id:         { required: false, type: string }

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. ä¸‹è½½å¯¹åº”ä¸šåŠ¡ä»“åº“çš„ artifact
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-${{ inputs.project }}
          github-token: ${{ secrets.DEPLOY_CENTER_PAT  }}  # å¿…é¡»æ˜¯ PATï¼Œå·²å­˜ Secrets
          run-id: ${{ inputs.artifact_id }}
          path: ./build

      # 2. å®‰è£… SSH key
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # 3. ä¸Šä¼ åˆ°æœåŠ¡å™¨
      - name: Deploy via rsync
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.SERVER_PORT }}" \
            ./build/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ inputs.deploy_path }}

      # 4. è¿œç¨‹æ‰§è¡Œå¯åŠ¨/é‡å¯å‘½ä»¤
      - name: Execute start command
        run: |
          ssh -i ~/.ssh/deploy_key \
            -p ${{ secrets.SERVER_PORT }} \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "${{ inputs.start_cmd }}"

      # 5. æ‰“å°ä¿¡æ¯
      - name: Deployment summary
        run: |
          echo "âœ… ${{ inputs.project }} éƒ¨ç½²å®Œæˆ"
          echo "ğŸ“¦ äº§ç‰©æ¥æºä»“åº“ run_id: ${{ inputs.artifact_id }}"
          echo "ğŸ—‚ éƒ¨ç½²è·¯å¾„: ${{ inputs.deploy_path }}"