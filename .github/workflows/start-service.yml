name: Start Service

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
        description: "é¡¹ç›®åç§°"
      start_cmd:
        required: false
        type: string
        description: "å¯åŠ¨å‘½ä»¤"
        default: ""
      deploy_type:
        required: true
        type: string
        description: "éƒ¨ç½²ç±»å‹ (backend/static)"
        default: "static"
      server_host:
        required: true
        type: string
        description: "æœåŠ¡å™¨åœ°å€"
      server_user:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç”¨æˆ·"
      server_key:
        required: true
        type: string
        description: "æœåŠ¡å™¨å¯†é’¥"
      server_port:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç«¯å£"
      apps_root:
        required: false
        type: string
        description: "åº”ç”¨ç›®å½•è·¯å¾„"
        default: "/srv/apps"
      service_port:
        required: false
        type: string
        description: "æœåŠ¡ç«¯å£ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä»é…ç½®æ–‡ä»¶è·å–ï¼‰"
        default: ""
    outputs:
      start_success:
        description: "å¯åŠ¨æ˜¯å¦æˆåŠŸ"
        value: ${{ jobs.start.outputs.start_success }}

jobs:
  start:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # å¯åŠ¨æœåŠ¡è¶…æ—¶æ—¶é—´
    outputs:
      start_success: ${{ steps.set-outputs.outputs.start_success }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: éªŒè¯è¾“å…¥å‚æ•°
        run: |
          echo "ğŸ” éªŒè¯è¾“å…¥å‚æ•°..."
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- éƒ¨ç½²ç±»å‹: ${{ inputs.deploy_type }}"
          echo "- å¯åŠ¨å‘½ä»¤: ${{ inputs.start_cmd }}"
          echo "- æœåŠ¡å™¨: ${{ inputs.server_host }}:${{ inputs.server_port }}"
          echo "- ç”¨æˆ·: ${{ inputs.server_user }}"
          
          if [ "${{ inputs.deploy_type }}" != "backend" ]; then
            echo "âš ï¸ éåç«¯é¡¹ç›®ï¼Œè·³è¿‡å¯åŠ¨å‘½ä»¤"
            echo "start_success=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ -z "${{ inputs.start_cmd }}" ]; then
            echo "âš ï¸ æœªæä¾›å¯åŠ¨å‘½ä»¤ï¼Œè·³è¿‡å¯åŠ¨æ­¥éª¤"
            echo "start_success=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… è¾“å…¥å‚æ•°éªŒè¯é€šè¿‡"

      - name: ä½¿ç”¨é‡è¯•ä¸­å¿ƒå¯åŠ¨æœåŠ¡
        id: retry-start
        run: |
          # é‡è¯•ä¸­å¿ƒæ ¸å¿ƒé€»è¾‘
          MAX_RETRIES=3
          RETRY_DELAY=10
          TIMEOUT_MINUTES=15
          STRATEGY="exponential"
          STEP_NAME="å¯åŠ¨æœåŠ¡"
          CONTINUE_ON_ERROR=false
          NOTIFY_ON_FAILURE=true
          STEP_TYPE="backend_service"
          
          # åŠ¨æ€è·å–é¡¹ç›®ç«¯å£
          PROJECT_NAME="${{ inputs.project }}"
          echo "ğŸ” è·å–é¡¹ç›®ç«¯å£é…ç½®..."
          
          # æ–¹æ³•1: ä¼˜å…ˆä»æœåŠ¡å™¨åŠ¨æ€ç«¯å£é…ç½®æ–‡ä»¶è·å–ç«¯å£ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
          if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i /tmp/ssh_key -p ${{ inputs.server_port }} ${{ inputs.server_user }}@${{ inputs.server_host }} '[ -f "/srv/port-config.yml" ]' 2>/dev/null; then
            SERVICE_PORT=$(ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i /tmp/ssh_key -p ${{ inputs.server_port }} ${{ inputs.server_user }}@${{ inputs.server_host }} "grep -A 1 '^  $PROJECT_NAME:' /srv/port-config.yml | grep 'port:' | awk '{print \$2}'" 2>/dev/null)
            if [ -n "$SERVICE_PORT" ]; then
              echo "âœ… ä»æœåŠ¡å™¨åŠ¨æ€ç«¯å£é…ç½®è·å–ç«¯å£: $SERVICE_PORT"
            else
              echo "âš ï¸  é¡¹ç›® '$PROJECT_NAME' åœ¨æœåŠ¡å™¨ç«¯å£é…ç½®ä¸­æœªæ‰¾åˆ°ï¼Œå°è¯•å…¶ä»–æ–¹æ³•"
            fi
          fi
          
          # æ–¹æ³•2: å¦‚æœæœåŠ¡å™¨é…ç½®ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œä»è¾“å…¥å‚æ•°è·å–ç«¯å£
          if [ -z "$SERVICE_PORT" ] && [ ! -z "${{ inputs.service_port }}" ]; then
            SERVICE_PORT="${{ inputs.service_port }}"
            echo "âœ… ä»è¾“å…¥å‚æ•°è·å–ç«¯å£: $SERVICE_PORT"
          # æ–¹æ³•3: ä»æœ¬åœ°ç«¯å£é…ç½®æ–‡ä»¶è·å–ç«¯å£
          elif [ -f "port-config.yml" ]; then
            SERVICE_PORT=$(grep -A 1 "^  $PROJECT_NAME:" port-config.yml | grep "port:" | awk '{print $2}')
            if [ -z "$SERVICE_PORT" ]; then
              echo "âš ï¸  é¡¹ç›® '$PROJECT_NAME' åœ¨æœ¬åœ°ç«¯å£é…ç½®ä¸­æœªæ‰¾åˆ°ï¼Œä½¿ç”¨é»˜è®¤ç«¯å£8080"
              SERVICE_PORT="8080"
            else
              echo "âœ… ä»æœ¬åœ°é…ç½®æ–‡ä»¶è·å–ç«¯å£: $SERVICE_PORT"
            fi
          # æ–¹æ³•4: ä½¿ç”¨é»˜è®¤ç«¯å£
          else
            echo "âš ï¸  ç«¯å£é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤ç«¯å£8080"
            SERVICE_PORT="8080"
          fi
          
          # æœåŠ¡éªŒè¯é…ç½®
          SERVICE_VALIDATION=true
          HEALTH_ENDPOINT="/health"
          VALIDATION_TIMEOUT=30
          
          # åˆå§‹åŒ–å˜é‡
          ATTEMPTS=0
          SUCCESS=false
          ERROR_MESSAGE=""
          START_TIME=$(date +%s)
          
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œå¯åŠ¨æœåŠ¡é‡è¯•é€»è¾‘"
          echo "æ­¥éª¤åç§°: $STEP_NAME"
          echo "æœ€å¤§é‡è¯•æ¬¡æ•°: $MAX_RETRIES"
          echo "é‡è¯•é—´éš”: $RETRY_DELAYç§’"
          echo "è¶…æ—¶æ—¶é—´: $TIMEOUT_MINUTESåˆ†é’Ÿ"
          echo "é‡è¯•ç­–ç•¥: $STRATEGY"
          echo "æ­¥éª¤ç±»å‹: $STEP_TYPE"
          echo "æœåŠ¡éªŒè¯: $SERVICE_VALIDATION"
          echo "æœåŠ¡ç«¯å£: $SERVICE_PORT"
          echo "å¥åº·æ£€æŸ¥ç«¯ç‚¹: $HEALTH_ENDPOINT"
          
          # é‡è¯•é€»è¾‘
          while [ $ATTEMPTS -le $MAX_RETRIES ]; do
            ATTEMPTS=$((ATTEMPTS + 1))
            echo ""
            echo "ğŸ”„ ç¬¬ $ATTEMPTS æ¬¡å°è¯•å¯åŠ¨æœåŠ¡..."
            
            # è®¾ç½®è¶…æ—¶
            TIMEOUT_CMD="timeout ${TIMEOUT_MINUTES}m"
            
            # æ‰§è¡Œå¯åŠ¨æœåŠ¡å‘½ä»¤
            if $TIMEOUT_CMD bash -c "
              # åˆ›å»ºSSHå¯†é’¥æ–‡ä»¶
              echo '${{ inputs.server_key }}' > /tmp/ssh_key
              chmod 600 /tmp/ssh_key
              
              # ç›´æ¥é€šè¿‡SSHæ‰§è¡Œè¯Šæ–­å’Œå¯åŠ¨å‘½ä»¤
              ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -i /tmp/ssh_key -p ${{ inputs.server_port }} ${{ inputs.server_user }}@${{ inputs.server_host }} '
                set -e
                
                echo \"ğŸš€ æ‰§è¡Œå¯åŠ¨å‘½ä»¤...\"
                echo \"- é¡¹ç›®: ${{ inputs.project }}\"
                echo \"- å¯åŠ¨å‘½ä»¤: ${{ inputs.start_cmd }}\"
                
                # åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
                cd ${{ inputs.apps_root }}/${{ inputs.project }}
                echo \"ğŸ“ å½“å‰ç›®å½•: \$(pwd)\"
                
                # éªŒè¯é¡¹ç›®ç›®å½•æ˜¯å¦å­˜åœ¨
                if [ ! -d \"${{ inputs.apps_root }}/${{ inputs.project }}\" ]; then
                  echo \"ğŸš¨ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: ${{ inputs.apps_root }}/${{ inputs.project }}\"
                  exit 1
                fi
                
                # éªŒè¯é¡¹ç›®ç›®å½•ä¸ä¸ºç©º
                FILE_COUNT=\$(find \"${{ inputs.apps_root }}/${{ inputs.project }}\" -type f | wc -l)
                if [ \"\$FILE_COUNT\" -eq 0 ]; then
                  echo \"ğŸš¨ é¡¹ç›®ç›®å½•ä¸ºç©º: ${{ inputs.apps_root }}/${{ inputs.project }}\"
                  exit 1
                fi
                
                echo \"âœ… é¡¹ç›®ç›®å½•éªŒè¯é€šè¿‡ï¼Œæ–‡ä»¶æ•°é‡: \$FILE_COUNT\"
                
                # è¯¦ç»†è¯Šæ–­ä¿¡æ¯
                echo \"ğŸ” è¯Šæ–­ä¿¡æ¯:\"
                echo \"- å½“å‰ç›®å½•: \$(pwd)\"
                echo \"- æ–‡ä»¶åˆ—è¡¨:\"
                ls -la
                echo \"- backend ç›®å½•å†…å®¹:\"
                ls -la backend/ || echo \"backend ç›®å½•ä¸å­˜åœ¨\"
                echo \"- æ£€æŸ¥å¯åŠ¨è„šæœ¬:\"
                if [ -f \"backend/index.js\" ]; then
                  echo \"âœ… backend/index.js å­˜åœ¨\"
                  ls -la backend/index.js
                  echo \"- æ–‡ä»¶å†…å®¹å‰10è¡Œ:\"
                  head -10 backend/index.js
                else
                  echo \"âŒ backend/index.js ä¸å­˜åœ¨\"
                fi
                echo \"- æ£€æŸ¥ä¾èµ–:\"
                if [ -d \"node_modules\" ]; then
                  echo \"âœ… node_modules å­˜åœ¨\"
                  ls -la node_modules/express/ || echo \"âŒ express ä¾èµ–ä¸å­˜åœ¨\"
                else
                  echo \"âŒ node_modules ä¸å­˜åœ¨\"
                fi
                echo \"- æ£€æŸ¥ ecosystem.config.js:\"
                if [ -f \"ecosystem.config.js\" ]; then
                  cat ecosystem.config.js
                else
                  echo \"âŒ ecosystem.config.js ä¸å­˜åœ¨\"
                fi
                echo \"- æ£€æŸ¥ PM2 æ˜¯å¦å®‰è£…:\"
                if command -v pm2 &> /dev/null; then
                  echo \"âœ… PM2 å·²å®‰è£…: \$(pm2 --version)\"
                else
                  echo \"âŒ PM2 æœªå®‰è£…\"
                fi
                echo \"- æ£€æŸ¥ç«¯å£å ç”¨:\"
                netstat -tlnp | grep :8090 || echo \"ç«¯å£8090æœªè¢«å ç”¨\"
                
                # æ£€æŸ¥å¯åŠ¨å‘½ä»¤æ˜¯å¦å­˜åœ¨
                START_CMD=\"${{ inputs.start_cmd }}\"
                CMD_NAME=\$(echo \"\$START_CMD\" | awk \"{print \\\$1}\")
                
                # æ£€æŸ¥æ˜¯å¦æœ‰ start-simple.sh è„šæœ¬ï¼ˆä¼˜å…ˆä½¿ç”¨ç®€åŒ–ç‰ˆï¼‰
                if [ -f \"start-simple.sh\" ]; then
                  echo \"ğŸ“‹ å‘ç° start-simple.sh è„šæœ¬ï¼Œä½¿ç”¨ç®€åŒ–å¯åŠ¨è„šæœ¬...\"
                  
                  # ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
                  chmod +x start-simple.sh
                  
                  # æ£€æŸ¥ç›®å½•ç»“æ„ï¼Œç¡®ä¿åœ¨æ­£ç¡®çš„ç›®å½•ä¸­æ‰§è¡Œ
                  echo \"ğŸ” æ£€æŸ¥å½“å‰ç›®å½•ç»“æ„...\"
                  echo \"ğŸ“ å½“å‰ç›®å½•: \$(pwd)\"
                  echo \"ğŸ“ å½“å‰ç›®å½•å†…å®¹:\"
                  ls -la
                  
                  # æ£€æŸ¥æ˜¯å¦å­˜åœ¨ package.json æ–‡ä»¶
                  if [ ! -f \"package.json\" ]; then
                    echo \"âš ï¸ package.json ä¸å­˜åœ¨ï¼Œå°è¯•ä¿®å¤ç›®å½•ç»“æ„...\"
                    
                    # æŸ¥æ‰¾ package.json æ–‡ä»¶
                    PACKAGE_JSON_PATH=\$(find . -name \"package.json\" -type f 2>/dev/null | head -1)
                    
                    if [ -n \"\$PACKAGE_JSON_PATH\" ]; then
                      echo \"ğŸ”§ æ‰¾åˆ° package.json æ–‡ä»¶: \$PACKAGE_JSON_PATH\"
                      
                      # è·å– package.json æ‰€åœ¨çš„ç›®å½•
                      PACKAGE_DIR=\$(dirname \"\$PACKAGE_JSON_PATH\")
                      
                      if [ \"\$PACKAGE_DIR\" != \".\" ]; then
                        echo \"ğŸ“ ç§»åŠ¨ \$PACKAGE_DIR ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åˆ°å½“å‰ç›®å½•...\"
                        
                        # ç§»åŠ¨ package.json æ‰€åœ¨ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åˆ°å½“å‰ç›®å½•
                        mv \"\$PACKAGE_DIR\"/* . 2>/dev/null || true
                        mv \"\$PACKAGE_DIR\"/.* . 2>/dev/null || true
                        
                        # åˆ é™¤ç©ºçš„ç›®å½•
                        rmdir \"\$PACKAGE_DIR\" 2>/dev/null || true
                        
                        echo \"âœ… ç›®å½•ç»“æ„ä¿®å¤å®Œæˆ\"
                        echo \"ğŸ“ ä¿®å¤åçš„ç›®å½•å†…å®¹:\"
                        ls -la
                      fi
                    else
                      echo \"âŒ æœªæ‰¾åˆ° package.json æ–‡ä»¶ï¼Œæ— æ³•ç»§ç»­\"
                      exit 1
                    fi
                  else
                    echo \"âœ… package.json æ–‡ä»¶å­˜åœ¨\"
                  fi
                  
                  # è®¾ç½®ç¯å¢ƒå˜é‡
                  export SERVICE_PORT=\"$SERVICE_PORT\"
                  echo \"ğŸ”§ è®¾ç½®ç¯å¢ƒå˜é‡ SERVICE_PORT=$SERVICE_PORT\"
                  
                  # æ‰§è¡Œç®€åŒ–å¯åŠ¨è„šæœ¬
                  echo \"ğŸ“‹ æ‰§è¡Œç®€åŒ–å¯åŠ¨è„šæœ¬: ./start-simple.sh\"
                  SERVICE_PORT=\"$SERVICE_PORT\" ./start-simple.sh
                  
                  echo \"âœ… ç®€åŒ–å¯åŠ¨è„šæœ¬æ‰§è¡Œå®Œæˆ\"
                # æ£€æŸ¥æ˜¯å¦æœ‰ start.sh è„šæœ¬ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰
                elif [ -f \"start.sh\" ]; then
                  echo \"ğŸ“‹ å‘ç° start.sh è„šæœ¬ï¼Œä½¿ç”¨å¯åŠ¨è„šæœ¬...\"
                  
                  # ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
                  chmod +x start.sh
                  
                  # æ£€æŸ¥ç›®å½•ç»“æ„ï¼Œç¡®ä¿åœ¨æ­£ç¡®çš„ç›®å½•ä¸­æ‰§è¡Œ
                  echo \"ğŸ” æ£€æŸ¥å½“å‰ç›®å½•ç»“æ„...\"
                  echo \"ğŸ“ å½“å‰ç›®å½•: \$(pwd)\"
                  echo \"ğŸ“ å½“å‰ç›®å½•å†…å®¹:\"
                  ls -la
                  
                  # æ£€æŸ¥æ˜¯å¦å­˜åœ¨ package.json æ–‡ä»¶
                  if [ ! -f \"package.json\" ]; then
                    echo \"âš ï¸ package.json ä¸å­˜åœ¨ï¼Œå°è¯•ä¿®å¤ç›®å½•ç»“æ„...\"
                    
                    # æŸ¥æ‰¾ package.json æ–‡ä»¶
                    PACKAGE_JSON_PATH=\$(find . -name \"package.json\" -type f 2>/dev/null | head -1)
                    
                    if [ -n \"\$PACKAGE_JSON_PATH\" ]; then
                      echo \"ğŸ”§ æ‰¾åˆ° package.json æ–‡ä»¶: \$PACKAGE_JSON_PATH\"
                      
                      # è·å– package.json æ‰€åœ¨çš„ç›®å½•
                      PACKAGE_DIR=\$(dirname \"\$PACKAGE_JSON_PATH\")
                      
                      if [ \"\$PACKAGE_DIR\" != \".\" ]; then
                        echo \"ğŸ“ ç§»åŠ¨ \$PACKAGE_DIR ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åˆ°å½“å‰ç›®å½•...\"
                        
                        # ç§»åŠ¨ package.json æ‰€åœ¨ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åˆ°å½“å‰ç›®å½•
                        mv \"\$PACKAGE_DIR\"/* . 2>/dev/null || true
                        mv \"\$PACKAGE_DIR\"/.* . 2>/dev/null || true
                        
                        # åˆ é™¤ç©ºçš„ç›®å½•
                        rmdir \"\$PACKAGE_DIR\" 2>/dev/null || true
                        
                        echo \"âœ… ç›®å½•ç»“æ„ä¿®å¤å®Œæˆ\"
                        echo \"ğŸ“ ä¿®å¤åçš„ç›®å½•å†…å®¹:\"
                        ls -la
                      fi
                    else
                      echo \"âŒ æœªæ‰¾åˆ° package.json æ–‡ä»¶ï¼Œæ— æ³•ç»§ç»­\"
                      exit 1
                    fi
                  else
                    echo \"âœ… package.json æ–‡ä»¶å­˜åœ¨\"
                  fi
                  
                  # æ‰§è¡Œå¯åŠ¨è„šæœ¬
                  echo \"ğŸ“‹ æ‰§è¡Œå¯åŠ¨è„šæœ¬: ./start.sh\"
                  ./start.sh
                  
                  echo \"âœ… å¯åŠ¨è„šæœ¬æ‰§è¡Œå®Œæˆ\"
                # æ£€æŸ¥æ˜¯å¦æœ‰ ecosystem.config.js æ–‡ä»¶ï¼ˆPM2 é¡¹ç›®ï¼‰
                elif [ -f \"ecosystem.config.js\" ]; then
                  echo \"ğŸ“‹ å‘ç° PM2 é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨ PM2 å¯åŠ¨...\"
                  
                  # æ£€æŸ¥ PM2 æ˜¯å¦å®‰è£…
                  if ! command -v pm2 &> /dev/null; then
                    echo \"ğŸš¨ PM2 æœªå®‰è£…ï¼Œå°è¯•å®‰è£…...\"
                    npm install -g pm2 || echo \"PM2 å®‰è£…å¤±è´¥\"
                  fi
                  
                  # æ£€æŸ¥å¹¶å®‰è£…ä¾èµ–
                  if [ ! -d \"node_modules\" ]; then
                    echo \"ğŸ“¦ node_modules ä¸å­˜åœ¨ï¼Œå®‰è£…ä¾èµ–...\"
                    if command -v pnpm &> /dev/null; then
                      echo \"ğŸ“¦ ä½¿ç”¨ pnpm å®‰è£…ä¾èµ–...\"
                      pnpm install --prod --no-frozen-lockfile || echo \"pnpm å®‰è£…å¤±è´¥ï¼Œå°è¯• npm\"
                    fi
                    if [ ! -d \"node_modules\" ] && command -v npm &> /dev/null; then
                      echo \"ğŸ“¦ ä½¿ç”¨ npm å®‰è£…ä¾èµ–...\"
                      npm install --production || echo \"npm å®‰è£…å¤±è´¥\"
                    fi
                  else
                    echo \"âœ… node_modules å·²å­˜åœ¨\"
                  fi
                  
                  # åœæ­¢ç°æœ‰è¿›ç¨‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                  pm2 stop dashboard-backend 2>/dev/null || echo \"æ²¡æœ‰ç°æœ‰è¿›ç¨‹éœ€è¦åœæ­¢\"
                  pm2 delete dashboard-backend 2>/dev/null || echo \"æ²¡æœ‰ç°æœ‰è¿›ç¨‹éœ€è¦åˆ é™¤\"
                  
                  # ä½¿ç”¨ PM2 å¯åŠ¨
                  echo \"ğŸ“‹ ä½¿ç”¨ PM2 å¯åŠ¨æœåŠ¡...\"
                  pm2 start ecosystem.config.js
                  
                  # æ£€æŸ¥å¯åŠ¨ç»“æœ
                  echo \"ğŸ“‹ æ£€æŸ¥ PM2 çŠ¶æ€...\"
                  pm2 status
                  echo \"ğŸ“‹ æ£€æŸ¥ PM2 æ—¥å¿—...\"
                  pm2 logs dashboard-backend --lines 10 --nostream || echo \"æ— æ³•è·å–æ—¥å¿—\"
                  
                  # ä¿å­˜ PM2 é…ç½®
                  pm2 save
                  
                  echo \"âœ… PM2 å¯åŠ¨å‘½ä»¤æ‰§è¡Œå®Œæˆ\"
                else
                  # ä¼ ç»Ÿå¯åŠ¨æ–¹å¼
                  if ! command -v \"\$CMD_NAME\" &> /dev/null; then
                    echo \"âš ï¸ å¯åŠ¨å‘½ä»¤ä¸å­˜åœ¨: \$CMD_NAME\"
                    echo \"ğŸ” å°è¯•æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶...\"
                    which \"\$CMD_NAME\" || echo \"æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶\"
                  fi
                  
                  # æ‰§è¡Œå¯åŠ¨å‘½ä»¤
                  echo \"ğŸ“‹ æ‰§è¡Œå¯åŠ¨å‘½ä»¤: \$START_CMD\"
                  \$START_CMD &
                fi
                
                echo \"âœ… å¯åŠ¨å‘½ä»¤æ‰§è¡Œå®Œæˆ\"
              '
            "; then
              echo "âœ… å‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼"
              
              # å¦‚æœå¯ç”¨äº†æœåŠ¡éªŒè¯ï¼Œè¿›è¡ŒæœåŠ¡éªŒè¯
              if [ "$SERVICE_VALIDATION" = "true" ] && [ -n "$SERVICE_PORT" ]; then
                echo "ğŸ” å¼€å§‹æœåŠ¡éªŒè¯..."
                echo "- æœåŠ¡ç«¯å£: $SERVICE_PORT"
                echo "- å¥åº·æ£€æŸ¥ç«¯ç‚¹: $HEALTH_ENDPOINT"
                echo "- éªŒè¯è¶…æ—¶: $VALIDATION_TIMEOUTç§’"
                
                # ç­‰å¾…æœåŠ¡å¯åŠ¨
                echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
                sleep 10
                
                # éªŒè¯æœåŠ¡æ˜¯å¦å“åº”
                VALIDATION_SUCCESS=false
                VALIDATION_ATTEMPTS=0
                MAX_VALIDATION_ATTEMPTS=6
                VALIDATION_TIMEOUT=60  # éªŒè¯è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
                VALIDATION_START_TIME=$(date +%s)
                
                while [ $VALIDATION_ATTEMPTS -lt $MAX_VALIDATION_ATTEMPTS ]; do
                  VALIDATION_ATTEMPTS=$((VALIDATION_ATTEMPTS + 1))
                  echo "ğŸ” éªŒè¯å°è¯• $VALIDATION_ATTEMPTS/$MAX_VALIDATION_ATTEMPTS..."
                  
                  # æ£€æŸ¥éªŒè¯è¶…æ—¶
                  CURRENT_TIME=$(date +%s)
                  ELAPSED_TIME=$((CURRENT_TIME - VALIDATION_START_TIME))
                  if [ $ELAPSED_TIME -gt $VALIDATION_TIMEOUT ]; then
                    echo "â° éªŒè¯è¶…æ—¶ï¼ˆ${VALIDATION_TIMEOUT}ç§’ï¼‰ï¼Œåœæ­¢éªŒè¯"
                    break
                  fi
                  
                  # åˆ›å»ºSSHå¯†é’¥æ–‡ä»¶ç”¨äºéªŒè¯
                  echo '${{ inputs.server_key }}' > /tmp/ssh_key_validation
                  chmod 600 /tmp/ssh_key_validation
                  
                  # åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡ŒéªŒè¯
                  VALIDATION_RESULT=$(ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i /tmp/ssh_key_validation -p ${{ inputs.server_port }} ${{ inputs.server_user }}@${{ inputs.server_host }} "
                    # æ£€æŸ¥ç«¯å£æ˜¯å¦ç›‘å¬
                    if netstat -tlnp 2>/dev/null | grep -q ':$SERVICE_PORT'; then
                      echo 'PORT_LISTENING'
                      
                      # æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹
                      HEALTH_RESPONSE=\$(curl -s -o /dev/null -w '%{http_code}' 'http://localhost:$SERVICE_PORT$HEALTH_ENDPOINT' --connect-timeout 5 --max-time 10 2>/dev/null || echo 'connection_failed')
                      
                      if [ \"\$HEALTH_RESPONSE\" = \"200\" ]; then
                        echo 'HEALTH_SUCCESS:\$HEALTH_RESPONSE'
                      else
                        echo 'HEALTH_FAILED:\$HEALTH_RESPONSE'
                      fi
                    else
                      echo 'PORT_NOT_LISTENING'
                    fi
                  " 2>/dev/null || echo "SSH_FAILED")
                  
                  # è§£æéªŒè¯ç»“æœ
                  if echo "$VALIDATION_RESULT" | grep -q "PORT_LISTENING"; then
                    echo "âœ… ç«¯å£ $SERVICE_PORT æ­£åœ¨ç›‘å¬"
                    
                    if echo "$VALIDATION_RESULT" | grep -q "HEALTH_SUCCESS"; then
                      HEALTH_CODE=$(echo "$VALIDATION_RESULT" | grep "HEALTH_SUCCESS" | cut -d':' -f2)
                      echo "âœ… å¥åº·æ£€æŸ¥æˆåŠŸ - çŠ¶æ€ç : $HEALTH_CODE"
                      VALIDATION_SUCCESS=true
                      break
                    else
                      HEALTH_CODE=$(echo "$VALIDATION_RESULT" | grep "HEALTH_FAILED" | cut -d':' -f2)
                      echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ - å“åº”: $HEALTH_CODE"
                    fi
                  else
                    echo "âŒ ç«¯å£ $SERVICE_PORT æœªç›‘å¬"
                  fi
                  
                  # å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡éªŒè¯ï¼Œç­‰å¾…åé‡è¯•éªŒè¯ï¼ˆä¸é‡å¯æœåŠ¡ï¼‰
                  if [ $VALIDATION_ATTEMPTS -lt $MAX_VALIDATION_ATTEMPTS ]; then
                    echo "â³ ç­‰å¾… 5 ç§’åé‡è¯•éªŒè¯..."
                    sleep 5
                  fi
                done
                
                if [ "$VALIDATION_SUCCESS" = "true" ]; then
                  echo "âœ… æœåŠ¡éªŒè¯æˆåŠŸï¼"
                  SUCCESS=true
                  break
                else
                  echo "âŒ æœåŠ¡éªŒè¯å¤±è´¥"
                  ERROR_MESSAGE="æœåŠ¡å¯åŠ¨æˆåŠŸä½†éªŒè¯å¤±è´¥ - ç«¯å£:$SERVICE_PORT, å¥åº·æ£€æŸ¥:$HEALTH_ENDPOINT"
                  SUCCESS=false
                fi
              else
                # æ²¡æœ‰å¯ç”¨æœåŠ¡éªŒè¯ï¼Œç›´æ¥è®¤ä¸ºæˆåŠŸ
                SUCCESS=true
                break
              fi
            else
              EXIT_CODE=$?
              if [ $EXIT_CODE -eq 124 ]; then
                ERROR_MESSAGE="å¯åŠ¨æœåŠ¡è¶…æ—¶ï¼ˆ${TIMEOUT_MINUTES}åˆ†é’Ÿï¼‰"
                # è¶…æ—¶å¯ä»¥é‡è¯•
                RETRYABLE=true
              else
                ERROR_MESSAGE="å¯åŠ¨æœåŠ¡å¤±è´¥ï¼Œé€€å‡ºç : $EXIT_CODE"
                # å…¶ä»–é”™è¯¯ä¸é‡è¯•ï¼Œå› ä¸ºå¯èƒ½æ˜¯é…ç½®é—®é¢˜
                RETRYABLE=false
              fi
              
              echo "âŒ å¯åŠ¨æœåŠ¡å¤±è´¥: $ERROR_MESSAGE"
              
              # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é‡è¯•æœºä¼šä¸”é”™è¯¯å¯é‡è¯•
              if [ $ATTEMPTS -le $MAX_RETRIES ] && [ "$RETRYABLE" = "true" ]; then
                # è®¡ç®—é‡è¯•å»¶è¿Ÿ
                if [ "$STRATEGY" = "exponential" ]; then
                  DELAY=$((RETRY_DELAY * (2 ** (ATTEMPTS - 1))))
                elif [ "$STRATEGY" = "adaptive" ]; then
                  DELAY=$((RETRY_DELAY + ATTEMPTS * 2))
                else
                  DELAY=$RETRY_DELAY
                fi
                
                echo "â³ ç­‰å¾… $DELAY ç§’åé‡è¯•..."
                sleep $DELAY
              else
                echo "ğŸ’¥ é”™è¯¯ä¸å¯é‡è¯•æˆ–å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œåœæ­¢é‡è¯•"
                break
              fi
            fi
          done
          
          # è®¡ç®—æ‰§è¡Œæ—¶é—´
          END_TIME=$(date +%s)
          EXECUTION_TIME=$((END_TIME - START_TIME))
          
          # è®¾ç½®è¾“å‡º
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "attempts=$ATTEMPTS" >> $GITHUB_OUTPUT
          echo "execution_time=$EXECUTION_TIME" >> $GITHUB_OUTPUT
          echo "error_message=$ERROR_MESSAGE" >> $GITHUB_OUTPUT
          
          # æœ€ç»ˆç»“æœ
          if [ "$SUCCESS" = "true" ]; then
            echo "ğŸ‰ å¯åŠ¨æœåŠ¡é‡è¯•é€»è¾‘æ‰§è¡Œå®Œæˆ - æˆåŠŸ"
          else
            echo "ğŸ’¥ å¯åŠ¨æœåŠ¡é‡è¯•é€»è¾‘æ‰§è¡Œå®Œæˆ - å¤±è´¥"
            if [ "$CONTINUE_ON_ERROR" = "false" ]; then
              exit 1
            fi
          fi

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          # æ£€æŸ¥é‡è¯•ä¸­å¿ƒçš„ç»“æœ
          if [ "${{ steps.retry-start.outputs.success }}" = "true" ]; then
            echo "start_success=true" >> $GITHUB_OUTPUT
            echo "âœ… å¯åŠ¨æœåŠ¡æˆåŠŸ"
            echo "é‡è¯•æ¬¡æ•°: ${{ steps.retry-start.outputs.attempts }}"
            echo "æ‰§è¡Œæ—¶é—´: ${{ steps.retry-start.outputs.execution_time }}ç§’"
          else
            echo "start_success=false" >> $GITHUB_OUTPUT
            echo "âŒ å¯åŠ¨æœåŠ¡å¤±è´¥"
            echo "é”™è¯¯ä¿¡æ¯: ${{ steps.retry-start.outputs.error_message }}"
            echo "é‡è¯•æ¬¡æ•°: ${{ steps.retry-start.outputs.attempts }}"
            echo "æ‰§è¡Œæ—¶é—´: ${{ steps.retry-start.outputs.execution_time }}ç§’"
            exit 1
          fi
