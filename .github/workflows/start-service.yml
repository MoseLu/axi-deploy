name: Start Service

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
        description: "é¡¹ç›®åç§°"
      start_cmd:
        required: false
        type: string
        description: "å¯åŠ¨å‘½ä»¤"
        default: ""
      deploy_type:
        required: true
        type: string
        description: "éƒ¨ç½²ç±»å‹ (backend/static)"
        default: "static"
      server_host:
        required: true
        type: string
        description: "æœåŠ¡å™¨åœ°å€"
      server_user:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç”¨æˆ·"
      server_key:
        required: true
        type: string
        description: "æœåŠ¡å™¨å¯†é’¥"
      server_port:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç«¯å£"
      apps_root:
        required: false
        type: string
        description: "åº”ç”¨ç›®å½•è·¯å¾„"
        default: "/srv/apps"
    outputs:
      start_success:
        description: "å¯åŠ¨æ˜¯å¦æˆåŠŸ"
        value: ${{ jobs.start.outputs.start_success }}

jobs:
  start:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # å¯åŠ¨æœåŠ¡è¶…æ—¶æ—¶é—´
    outputs:
      start_success: ${{ steps.set-outputs.outputs.start_success }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: éªŒè¯è¾“å…¥å‚æ•°
        run: |
          echo "ğŸ” éªŒè¯è¾“å…¥å‚æ•°..."
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- éƒ¨ç½²ç±»å‹: ${{ inputs.deploy_type }}"
          echo "- å¯åŠ¨å‘½ä»¤: ${{ inputs.start_cmd }}"
          echo "- æœåŠ¡å™¨: ${{ inputs.server_host }}:${{ inputs.server_port }}"
          echo "- ç”¨æˆ·: ${{ inputs.server_user }}"
          
          if [ "${{ inputs.deploy_type }}" != "backend" ]; then
            echo "âš ï¸ éåç«¯é¡¹ç›®ï¼Œè·³è¿‡å¯åŠ¨å‘½ä»¤"
            echo "start_success=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ -z "${{ inputs.start_cmd }}" ]; then
            echo "âš ï¸ æœªæä¾›å¯åŠ¨å‘½ä»¤ï¼Œè·³è¿‡å¯åŠ¨æ­¥éª¤"
            echo "start_success=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… è¾“å…¥å‚æ•°éªŒè¯é€šè¿‡"

      - name: ä½¿ç”¨é‡è¯•ä¸­å¿ƒå¯åŠ¨æœåŠ¡
        id: retry-start
        uses: ./.github/workflows/retry-center.yml
        with:
          step_name: "å¯åŠ¨æœåŠ¡"
          command: |
            # åˆ›å»ºSSHå¯†é’¥æ–‡ä»¶
            echo '${{ inputs.server_key }}' > /tmp/ssh_key
            chmod 600 /tmp/ssh_key
            
            # åˆ›å»ºå¯åŠ¨è„šæœ¬
            cat > /tmp/start_service_script.sh << 'EOF'
            #!/bin/bash
            set -e
            
            echo 'ğŸš€ æ‰§è¡Œå¯åŠ¨å‘½ä»¤...'
            echo '- é¡¹ç›®: ${{ inputs.project }}'
            echo '- å¯åŠ¨å‘½ä»¤: ${{ inputs.start_cmd }}'
            
            # åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
            cd ${{ inputs.apps_root }}/${{ inputs.project }}
            echo 'ğŸ“ å½“å‰ç›®å½•: $(pwd)'
            
            # éªŒè¯é¡¹ç›®ç›®å½•æ˜¯å¦å­˜åœ¨
            if [ ! -d '${{ inputs.apps_root }}/${{ inputs.project }}' ]; then
              echo 'ğŸš¨ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: ${{ inputs.apps_root }}/${{ inputs.project }}'
              exit 1
            fi
            
            # éªŒè¯é¡¹ç›®ç›®å½•ä¸ä¸ºç©º
            FILE_COUNT=$(find '${{ inputs.apps_root }}/${{ inputs.project }}' -type f | wc -l)
            if [ "$FILE_COUNT" -eq 0 ]; then
              echo 'ğŸš¨ é¡¹ç›®ç›®å½•ä¸ºç©º: ${{ inputs.apps_root }}/${{ inputs.project }}'
              exit 1
            fi
            
            echo 'âœ… é¡¹ç›®ç›®å½•éªŒè¯é€šè¿‡ï¼Œæ–‡ä»¶æ•°é‡: $FILE_COUNT'
            
            # æ£€æŸ¥å¯åŠ¨å‘½ä»¤æ˜¯å¦å­˜åœ¨
            START_CMD='${{ inputs.start_cmd }}'
            CMD_NAME=$(echo "$START_CMD" | awk '{print $1}')
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ ecosystem.config.js æ–‡ä»¶ï¼ˆPM2 é¡¹ç›®ï¼‰
            if [ -f 'ecosystem.config.js' ]; then
              echo 'ğŸ“‹ å‘ç° PM2 é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨ PM2 å¯åŠ¨...'
              
              # æ£€æŸ¥ PM2 æ˜¯å¦å®‰è£…
              if ! command -v pm2 &> /dev/null; then
                echo 'ğŸš¨ PM2 æœªå®‰è£…ï¼Œå°è¯•å®‰è£…...'
                npm install -g pm2 || echo 'PM2 å®‰è£…å¤±è´¥'
              fi
              
              # åœæ­¢ç°æœ‰è¿›ç¨‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
              pm2 stop dashboard-backend 2>/dev/null || echo 'æ²¡æœ‰ç°æœ‰è¿›ç¨‹éœ€è¦åœæ­¢'
              pm2 delete dashboard-backend 2>/dev/null || echo 'æ²¡æœ‰ç°æœ‰è¿›ç¨‹éœ€è¦åˆ é™¤'
              
              # ä½¿ç”¨ PM2 å¯åŠ¨
              echo 'ğŸ“‹ ä½¿ç”¨ PM2 å¯åŠ¨æœåŠ¡...'
              pm2 start ecosystem.config.js
              
              # ä¿å­˜ PM2 é…ç½®
              pm2 save
              
              echo 'âœ… PM2 å¯åŠ¨å‘½ä»¤æ‰§è¡Œå®Œæˆ'
            else
              # ä¼ ç»Ÿå¯åŠ¨æ–¹å¼
              if ! command -v "$CMD_NAME" &> /dev/null; then
                echo 'âš ï¸ å¯åŠ¨å‘½ä»¤ä¸å­˜åœ¨: $CMD_NAME'
                echo 'ğŸ” å°è¯•æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶...'
                which "$CMD_NAME" || echo 'æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶'
              fi
              
              # æ‰§è¡Œå¯åŠ¨å‘½ä»¤
              echo 'ğŸ“‹ æ‰§è¡Œå¯åŠ¨å‘½ä»¤: $START_CMD'
              $START_CMD &
            fi
            
            echo 'âœ… å¯åŠ¨å‘½ä»¤æ‰§è¡Œå®Œæˆ'
            EOF
            
            # ä½¿ç”¨SSHæ‰§è¡Œå¯åŠ¨è„šæœ¬
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -i /tmp/ssh_key -p ${{ inputs.server_port }} ${{ inputs.server_user }}@${{ inputs.server_host }} 'bash -s' < /tmp/start_service_script.sh
          max_retries: 3
          retry_delay: 10
          timeout_minutes: 15
          retry_strategy: "exponential"
          step_type: "backend_service"
          continue_on_error: false
          notify_on_failure: true
          # å¯ç”¨æœåŠ¡éªŒè¯
          service_validation: true
          service_port: "8090"
          health_endpoint: "/health"
          validation_timeout: 30

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          # æ£€æŸ¥é‡è¯•ä¸­å¿ƒçš„ç»“æœ
          if [ "${{ steps.retry-start.outputs.success }}" = "true" ]; then
            echo "start_success=true" >> $GITHUB_OUTPUT
            echo "âœ… å¯åŠ¨æœåŠ¡æˆåŠŸ"
          else
            echo "start_success=false" >> $GITHUB_OUTPUT
            echo "âŒ å¯åŠ¨æœåŠ¡å¤±è´¥"
            echo "é”™è¯¯ä¿¡æ¯: ${{ steps.retry-start.outputs.error_message }}"
            exit 1
          fi
