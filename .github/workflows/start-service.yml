name: Start Service

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
        description: "é¡¹ç›®åç§°"
      start_cmd:
        required: false
        type: string
        description: "å¯åŠ¨å‘½ä»¤"
        default: ""
      deploy_type:
        required: true
        type: string
        description: "éƒ¨ç½²ç±»å‹ (backend/static)"
        default: "static"
      server_host:
        required: true
        type: string
        description: "æœåŠ¡å™¨åœ°å€"
      server_user:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç”¨æˆ·"
      server_key:
        required: true
        type: string
        description: "æœåŠ¡å™¨å¯†é’¥"
      server_port:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç«¯å£"
      apps_root:
        required: false
        type: string
        description: "åº”ç”¨ç›®å½•è·¯å¾„"
        default: "/srv/apps"
    outputs:
      start_success:
        description: "å¯åŠ¨æ˜¯å¦æˆåŠŸ"
        value: ${{ jobs.start.outputs.start_success }}

jobs:
  start:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # å¯åŠ¨æœåŠ¡è¶…æ—¶æ—¶é—´
    outputs:
      start_success: ${{ steps.set-outputs.outputs.start_success }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: éªŒè¯è¾“å…¥å‚æ•°
        run: |
          echo "ğŸ” éªŒè¯è¾“å…¥å‚æ•°..."
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- éƒ¨ç½²ç±»å‹: ${{ inputs.deploy_type }}"
          echo "- å¯åŠ¨å‘½ä»¤: ${{ inputs.start_cmd }}"
          echo "- æœåŠ¡å™¨: ${{ inputs.server_host }}:${{ inputs.server_port }}"
          echo "- ç”¨æˆ·: ${{ inputs.server_user }}"
          
          if [ "${{ inputs.deploy_type }}" != "backend" ]; then
            echo "âš ï¸ éåç«¯é¡¹ç›®ï¼Œè·³è¿‡å¯åŠ¨å‘½ä»¤"
            echo "start_success=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ -z "${{ inputs.start_cmd }}" ]; then
            echo "âš ï¸ æœªæä¾›å¯åŠ¨å‘½ä»¤ï¼Œè·³è¿‡å¯åŠ¨æ­¥éª¤"
            echo "start_success=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… è¾“å…¥å‚æ•°éªŒè¯é€šè¿‡"

      - name: ä½¿ç”¨é‡è¯•æœºåˆ¶å¯åŠ¨æœåŠ¡
        id: start-service
        run: |
          # é‡è¯•ä¸­å¿ƒæ ¸å¿ƒé€»è¾‘
          MAX_RETRIES=3
          RETRY_DELAY=10
          TIMEOUT_MINUTES=15
          STRATEGY="exponential"
          STEP_NAME="å¯åŠ¨æœåŠ¡"
          CONTINUE_ON_ERROR=false
          NOTIFY_ON_FAILURE=true
          STEP_TYPE="network"
          
          # åˆå§‹åŒ–å˜é‡
          ATTEMPTS=0
          SUCCESS=false
          ERROR_MESSAGE=""
          START_TIME=$(date +%s)
          
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œå¯åŠ¨æœåŠ¡é‡è¯•é€»è¾‘"
          echo "æ­¥éª¤åç§°: $STEP_NAME"
          echo "æœ€å¤§é‡è¯•æ¬¡æ•°: $MAX_RETRIES"
          echo "é‡è¯•é—´éš”: $RETRY_DELAYç§’"
          echo "è¶…æ—¶æ—¶é—´: $TIMEOUT_MINUTESåˆ†é’Ÿ"
          echo "é‡è¯•ç­–ç•¥: $STRATEGY"
          echo "æ­¥éª¤ç±»å‹: $STEP_TYPE"
          
          # é‡è¯•é€»è¾‘
          while [ $ATTEMPTS -le $MAX_RETRIES ]; do
            ATTEMPTS=$((ATTEMPTS + 1))
            echo ""
            echo "ğŸ”„ ç¬¬ $ATTEMPTS æ¬¡å°è¯•å¯åŠ¨æœåŠ¡..."
            
            # è®¾ç½®è¶…æ—¶
            TIMEOUT_CMD="timeout ${TIMEOUT_MINUTES}m"
            
            # æ‰§è¡Œå¯åŠ¨æœåŠ¡å‘½ä»¤
            if $TIMEOUT_CMD bash -c "
              # åˆ›å»ºSSHå¯†é’¥æ–‡ä»¶
              echo '${{ inputs.server_key }}' > /tmp/ssh_key
              chmod 600 /tmp/ssh_key
              
              # åˆ›å»ºå¯åŠ¨è„šæœ¬
              cat > /tmp/start_service_script.sh << 'EOF'
              #!/bin/bash
              set -e
              
              echo 'ğŸš€ æ‰§è¡Œå¯åŠ¨å‘½ä»¤...'
              echo '- é¡¹ç›®: ${{ inputs.project }}'
              echo '- å¯åŠ¨å‘½ä»¤: ${{ inputs.start_cmd }}'
              
              # åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
              cd ${{ inputs.apps_root }}/${{ inputs.project }}
              echo 'ğŸ“ å½“å‰ç›®å½•: \$(pwd)'
              
              # éªŒè¯é¡¹ç›®ç›®å½•æ˜¯å¦å­˜åœ¨
              if [ ! -d '${{ inputs.apps_root }}/${{ inputs.project }}' ]; then
                echo 'ğŸš¨ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: ${{ inputs.apps_root }}/${{ inputs.project }}'
                exit 1
              fi
              
              # éªŒè¯é¡¹ç›®ç›®å½•ä¸ä¸ºç©º
              FILE_COUNT=\$(find '${{ inputs.apps_root }}/${{ inputs.project }}' -type f | wc -l)
              if [ \"\$FILE_COUNT\" -eq 0 ]; then
                echo 'ğŸš¨ é¡¹ç›®ç›®å½•ä¸ºç©º: ${{ inputs.apps_root }}/${{ inputs.project }}'
                exit 1
              fi
              
              echo 'âœ… é¡¹ç›®ç›®å½•éªŒè¯é€šè¿‡ï¼Œæ–‡ä»¶æ•°é‡: \$FILE_COUNT'
              
              # æ£€æŸ¥å¯åŠ¨å‘½ä»¤æ˜¯å¦å­˜åœ¨
              START_CMD='${{ inputs.start_cmd }}'
              CMD_NAME=\$(echo \"\$START_CMD\" | awk '{print \$1}')
              
              # æ£€æŸ¥æ˜¯å¦æœ‰ ecosystem.config.js æ–‡ä»¶ï¼ˆPM2 é¡¹ç›®ï¼‰
              if [ -f 'ecosystem.config.js' ]; then
                echo 'ğŸ“‹ å‘ç° PM2 é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨ PM2 å¯åŠ¨...'
                
                # æ£€æŸ¥ PM2 æ˜¯å¦å®‰è£…
                if ! command -v pm2 &> /dev/null; then
                  echo 'ğŸš¨ PM2 æœªå®‰è£…ï¼Œå°è¯•å®‰è£…...'
                  npm install -g pm2 || echo 'PM2 å®‰è£…å¤±è´¥'
                fi
                
                # åœæ­¢ç°æœ‰è¿›ç¨‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                pm2 stop dashboard-backend 2>/dev/null || echo 'æ²¡æœ‰ç°æœ‰è¿›ç¨‹éœ€è¦åœæ­¢'
                pm2 delete dashboard-backend 2>/dev/null || echo 'æ²¡æœ‰ç°æœ‰è¿›ç¨‹éœ€è¦åˆ é™¤'
                
                # ä½¿ç”¨ PM2 å¯åŠ¨
                echo 'ğŸ“‹ ä½¿ç”¨ PM2 å¯åŠ¨æœåŠ¡...'
                pm2 start ecosystem.config.js
                
                # ä¿å­˜ PM2 é…ç½®
                pm2 save
                
                echo 'âœ… PM2 å¯åŠ¨å‘½ä»¤æ‰§è¡Œå®Œæˆ'
                START_PID=\$(pm2 pid dashboard-backend 2>/dev/null || echo '0')
              else
                # ä¼ ç»Ÿå¯åŠ¨æ–¹å¼
                if ! command -v \"\$CMD_NAME\" &> /dev/null; then
                  echo 'âš ï¸ å¯åŠ¨å‘½ä»¤ä¸å­˜åœ¨: \$CMD_NAME'
                  echo 'ğŸ” å°è¯•æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶...'
                  which \"\$CMD_NAME\" || echo 'æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶'
                fi
                
                # æ‰§è¡Œå¯åŠ¨å‘½ä»¤
                echo 'ğŸ“‹ æ‰§è¡Œå¯åŠ¨å‘½ä»¤: \$START_CMD'
                \$START_CMD &
                START_PID=\$!
              fi
              
              # ç­‰å¾…æœåŠ¡å¯åŠ¨
              echo 'â³ ç­‰å¾…æœåŠ¡å¯åŠ¨...'
              sleep 5
              
              # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿˜åœ¨è¿è¡Œ
              if kill -0 \$START_PID 2>/dev/null; then
                echo 'âœ… å¯åŠ¨å‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼Œè¿›ç¨‹ID: \$START_PID'
              else
                echo 'âš ï¸ å¯åŠ¨å‘½ä»¤å¯èƒ½å·²ç»“æŸï¼Œæ£€æŸ¥æœåŠ¡çŠ¶æ€...'
              fi
              
              # æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼ˆå¦‚æœå¯èƒ½ï¼‰
              echo 'ğŸ“‹ æ£€æŸ¥æœåŠ¡çŠ¶æ€...'
              if command -v systemctl &> /dev/null; then
                SERVICE_NAME='${{ inputs.project }}'
                if systemctl is-active --quiet \$SERVICE_NAME; then
                  echo 'âœ… æœåŠ¡ \$SERVICE_NAME æ­£åœ¨è¿è¡Œ'
                else
                  echo 'âš ï¸ æœåŠ¡ \$SERVICE_NAME æœªè¿è¡Œæˆ–æ— æ³•æ£€æŸ¥'
                  # å°è¯•æ£€æŸ¥è¿›ç¨‹
                  if pgrep -f '${{ inputs.project }}' > /dev/null; then
                    echo 'âœ… æ‰¾åˆ°ç›¸å…³è¿›ç¨‹:'
                    pgrep -f '${{ inputs.project }}' | head -5
                  else
                    echo 'âš ï¸ æœªæ‰¾åˆ°ç›¸å…³è¿›ç¨‹'
                  fi
                fi
              else
                echo 'âš ï¸ æ— æ³•æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼ˆsystemctlä¸å¯ç”¨ï¼‰'
                # å°è¯•æ£€æŸ¥è¿›ç¨‹
                if pgrep -f '${{ inputs.project }}' > /dev/null; then
                  echo 'âœ… æ‰¾åˆ°ç›¸å…³è¿›ç¨‹:'
                  pgrep -f '${{ inputs.project }}' | head -5
                else
                  echo 'âš ï¸ æœªæ‰¾åˆ°ç›¸å…³è¿›ç¨‹'
                fi
              fi
              
              # æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼ˆå¦‚æœæ˜¯åç«¯æœåŠ¡ï¼‰
              if command -v netstat &> /dev/null; then
                echo 'ğŸ” æ£€æŸ¥ç«¯å£å ç”¨æƒ…å†µ...'
                netstat -tlnp | grep -E ':(8080|3000|8000|5000)' | head -5 || echo 'æœªæ‰¾åˆ°ç›¸å…³ç«¯å£'
              fi
              
              echo 'âœ… å¯åŠ¨å‘½ä»¤æ‰§è¡Œå®Œæˆ'
              
              # æœåŠ¡å¯åŠ¨éªŒè¯
              echo 'ğŸ” å¼€å§‹æœåŠ¡å¯åŠ¨éªŒè¯...'
              
              # ç­‰å¾…æ›´é•¿æ—¶é—´ç¡®ä¿æœåŠ¡å®Œå…¨å¯åŠ¨
              echo 'â³ ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨...'
              sleep 10
              
              # æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
              echo 'ğŸ¥ æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€...'
              if command -v curl &> /dev/null; then
                # å°è¯•è®¿é—®å¥åº·æ£€æŸ¥ç«¯ç‚¹
                for port in 8080 3000 8000 5000; do
                  if curl -f -s http://localhost:\$port/health > /dev/null 2>&1; then
                    echo 'âœ… æœåŠ¡åœ¨ç«¯å£ \$port ä¸Šå“åº”å¥åº·æ£€æŸ¥'
                    break
                  elif curl -f -s http://localhost:\$port/ > /dev/null 2>&1; then
                    echo 'âœ… æœåŠ¡åœ¨ç«¯å£ \$port ä¸Šå“åº”'
                    break
                  fi
                done
              fi
              
              # æœ€ç»ˆçŠ¶æ€æ£€æŸ¥
              if pgrep -f '${{ inputs.project }}' > /dev/null || pm2 list | grep -q '${{ inputs.project }}'; then
                echo 'âœ… æœåŠ¡å¯åŠ¨æˆåŠŸï¼'
              else
                echo 'âš ï¸ æœåŠ¡å¯èƒ½æœªæ­£å¸¸å¯åŠ¨ï¼Œä½†å¯åŠ¨å‘½ä»¤æ‰§è¡Œå®Œæˆ'
              fi
              
              echo 'âœ… å¯åŠ¨æœåŠ¡å®Œæˆï¼'
              EOF
              
              # ä½¿ç”¨SSHæ‰§è¡Œå¯åŠ¨è„šæœ¬
              ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -i /tmp/ssh_key -p ${{ inputs.server_port }} ${{ inputs.server_user }}@${{ inputs.server_host }} 'bash -s' < /tmp/start_service_script.sh
            "; then
              SUCCESS=true
              echo "âœ… å¯åŠ¨æœåŠ¡æˆåŠŸï¼"
              break
            else
              EXIT_CODE=$?
              if [ $EXIT_CODE -eq 124 ]; then
                ERROR_MESSAGE="å¯åŠ¨æœåŠ¡è¶…æ—¶ï¼ˆ${TIMEOUT_MINUTES}åˆ†é’Ÿï¼‰"
              else
                ERROR_MESSAGE="å¯åŠ¨æœåŠ¡å¤±è´¥ï¼Œé€€å‡ºç : $EXIT_CODE"
              fi
              
              echo "âŒ å¯åŠ¨æœåŠ¡å¤±è´¥: $ERROR_MESSAGE"
              
              # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é‡è¯•æœºä¼š
              if [ $ATTEMPTS -le $MAX_RETRIES ]; then
                # è®¡ç®—é‡è¯•å»¶è¿Ÿ
                if [ "$STRATEGY" = "exponential" ]; then
                  DELAY=$((RETRY_DELAY * (2 ** (ATTEMPTS - 1))))
                elif [ "$STRATEGY" = "adaptive" ]; then
                  DELAY=$((RETRY_DELAY + ATTEMPTS * 2))
                else
                  DELAY=$RETRY_DELAY
                fi
                
                echo "â³ ç­‰å¾… $DELAY ç§’åé‡è¯•..."
                sleep $DELAY
              fi
            fi
          done
          
          # è®¡ç®—æ‰§è¡Œæ—¶é—´
          END_TIME=$(date +%s)
          EXECUTION_TIME=$((END_TIME - START_TIME))
          
          # è®¾ç½®è¾“å‡º
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "attempts=$ATTEMPTS" >> $GITHUB_OUTPUT
          echo "execution_time=$EXECUTION_TIME" >> $GITHUB_OUTPUT
          echo "error_message=$ERROR_MESSAGE" >> $GITHUB_OUTPUT
          
          # æœ€ç»ˆç»“æœ
          if [ "$SUCCESS" = "true" ]; then
            echo "ğŸ‰ å¯åŠ¨æœåŠ¡é‡è¯•é€»è¾‘æ‰§è¡Œå®Œæˆ - æˆåŠŸ"
          else
            echo "ğŸ’¥ å¯åŠ¨æœåŠ¡é‡è¯•é€»è¾‘æ‰§è¡Œå®Œæˆ - å¤±è´¥"
            if [ "$CONTINUE_ON_ERROR" = "false" ]; then
              exit 1
            fi
          fi

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          echo "start_success=true" >> $GITHUB_OUTPUT
          echo "âœ… å¯åŠ¨æœåŠ¡å®Œæˆ"
