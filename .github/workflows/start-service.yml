name: Start Service

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
        description: "é¡¹ç›®åç§°"
      start_cmd:
        required: false
        type: string
        description: "å¯åŠ¨å‘½ä»¤"
        default: ""
      deploy_type:
        required: true
        type: string
        description: "éƒ¨ç½²ç±»åž‹ (backend/static)"
        default: "static"
      server_host:
        required: true
        type: string
        description: "æœåŠ¡å™¨åœ°å€"
      server_user:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç”¨æˆ·"
      server_key:
        required: true
        type: string
        description: "æœåŠ¡å™¨å¯†é’¥"
      server_port:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç«¯å£"
      apps_root:
        required: false
        type: string
        description: "åº”ç”¨ç›®å½•è·¯å¾„"
        default: "/srv/apps"
    outputs:
      start_success:
        description: "å¯åŠ¨æ˜¯å¦æˆåŠŸ"
        value: ${{ jobs.start.outputs.start_success }}

jobs:
  start:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # å¯åŠ¨æœåŠ¡è¶…æ—¶æ—¶é—´
    outputs:
      start_success: ${{ steps.set-outputs.outputs.start_success }}
    
    steps:
      - name: éªŒè¯è¾“å…¥å‚æ•°
        run: |
          echo "ðŸ” éªŒè¯è¾“å…¥å‚æ•°..."
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- éƒ¨ç½²ç±»åž‹: ${{ inputs.deploy_type }}"
          echo "- å¯åŠ¨å‘½ä»¤: ${{ inputs.start_cmd }}"
          
          if [ "${{ inputs.deploy_type }}" != "backend" ]; then
            echo "âš ï¸ éžåŽç«¯é¡¹ç›®ï¼Œè·³è¿‡å¯åŠ¨å‘½ä»¤"
            echo "start_success=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ -z "${{ inputs.start_cmd }}" ]; then
            echo "âš ï¸ æœªæä¾›å¯åŠ¨å‘½ä»¤ï¼Œè·³è¿‡å¯åŠ¨æ­¥éª¤"
            echo "start_success=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… è¾“å…¥å‚æ•°éªŒè¯é€šè¿‡"

      - name: æ‰§è¡Œå¯åŠ¨å‘½ä»¤å¹¶éªŒè¯
        id: execute-start
        if: inputs.start_cmd != '' && inputs.deploy_type == 'backend'
        run: |
          echo "ðŸš€ æ‰§è¡Œå¯åŠ¨å‘½ä»¤..."
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- å¯åŠ¨å‘½ä»¤: ${{ inputs.start_cmd }}"
          
          # åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
          cd ${{ inputs.apps_root }}/${{ inputs.project }}
          echo "ðŸ“ å½“å‰ç›®å½•: $(pwd)"
          
          # éªŒè¯é¡¹ç›®ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "${{ inputs.apps_root }}/${{ inputs.project }}" ]; then
            echo "ðŸš¨ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: ${{ inputs.apps_root }}/${{ inputs.project }}"
            exit 1
          fi
          
          # éªŒè¯é¡¹ç›®ç›®å½•ä¸ä¸ºç©º
          FILE_COUNT=$(find "${{ inputs.apps_root }}/${{ inputs.project }}" -type f | wc -l)
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "ðŸš¨ é¡¹ç›®ç›®å½•ä¸ºç©º: ${{ inputs.apps_root }}/${{ inputs.project }}"
            exit 1
          fi
          
          echo "âœ… é¡¹ç›®ç›®å½•éªŒè¯é€šè¿‡ï¼Œæ–‡ä»¶æ•°é‡: $FILE_COUNT"
          
          # æ£€æŸ¥å¯åŠ¨å‘½ä»¤æ˜¯å¦å­˜åœ¨
          START_CMD="${{ inputs.start_cmd }}"
          CMD_NAME=$(echo "$START_CMD" | awk '{print $1}')
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ ecosystem.config.js æ–‡ä»¶ï¼ˆPM2 é¡¹ç›®ï¼‰
          if [ -f "ecosystem.config.js" ]; then
            echo "ðŸ“‹ å‘çŽ° PM2 é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨ PM2 å¯åŠ¨..."
            
            # æ£€æŸ¥ PM2 æ˜¯å¦å®‰è£…
            if ! command -v pm2 &> /dev/null; then
              echo "ðŸš¨ PM2 æœªå®‰è£…ï¼Œå°è¯•å®‰è£…..."
              npm install -g pm2 || echo "PM2 å®‰è£…å¤±è´¥"
            fi
            
            # åœæ­¢çŽ°æœ‰è¿›ç¨‹ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
            pm2 stop dashboard-backend 2>/dev/null || echo "æ²¡æœ‰çŽ°æœ‰è¿›ç¨‹éœ€è¦åœæ­¢"
            pm2 delete dashboard-backend 2>/dev/null || echo "æ²¡æœ‰çŽ°æœ‰è¿›ç¨‹éœ€è¦åˆ é™¤"
            
            # ä½¿ç”¨ PM2 å¯åŠ¨
            echo "ðŸ“‹ ä½¿ç”¨ PM2 å¯åŠ¨æœåŠ¡..."
            pm2 start ecosystem.config.js
            
            # ä¿å­˜ PM2 é…ç½®
            pm2 save
            
            echo "âœ… PM2 å¯åŠ¨å‘½ä»¤æ‰§è¡Œå®Œæˆ"
            START_PID=$(pm2 pid dashboard-backend 2>/dev/null || echo "0")
          else
            # ä¼ ç»Ÿå¯åŠ¨æ–¹å¼
            if ! command -v "$CMD_NAME" &> /dev/null; then
              echo "âš ï¸ å¯åŠ¨å‘½ä»¤ä¸å­˜åœ¨: $CMD_NAME"
              echo "ðŸ” å°è¯•æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶..."
              which "$CMD_NAME" || echo "æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
            fi
            
            # æ‰§è¡Œå¯åŠ¨å‘½ä»¤
            echo "ðŸ“‹ æ‰§è¡Œå¯åŠ¨å‘½ä»¤: $START_CMD"
            $START_CMD &
            START_PID=$!
          fi
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 5
          
          # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿˜åœ¨è¿è¡Œ
          if kill -0 $START_PID 2>/dev/null; then
            echo "âœ… å¯åŠ¨å‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼Œè¿›ç¨‹ID: $START_PID"
          else
            echo "âš ï¸ å¯åŠ¨å‘½ä»¤å¯èƒ½å·²ç»“æŸï¼Œæ£€æŸ¥æœåŠ¡çŠ¶æ€..."
          fi
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼ˆå¦‚æžœå¯èƒ½ï¼‰
          echo "ðŸ“‹ æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
          if command -v systemctl &> /dev/null; then
            SERVICE_NAME="${{ inputs.project }}"
            if systemctl is-active --quiet $SERVICE_NAME; then
              echo "âœ… æœåŠ¡ $SERVICE_NAME æ­£åœ¨è¿è¡Œ"
            else
              echo "âš ï¸ æœåŠ¡ $SERVICE_NAME æœªè¿è¡Œæˆ–æ— æ³•æ£€æŸ¥"
              # å°è¯•æ£€æŸ¥è¿›ç¨‹
              if pgrep -f "${{ inputs.project }}" > /dev/null; then
                echo "âœ… æ‰¾åˆ°ç›¸å…³è¿›ç¨‹:"
                pgrep -f "${{ inputs.project }}" | head -5
              else
                echo "âš ï¸ æœªæ‰¾åˆ°ç›¸å…³è¿›ç¨‹"
              fi
            fi
          else
            echo "âš ï¸ æ— æ³•æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼ˆsystemctlä¸å¯ç”¨ï¼‰"
              # å°è¯•æ£€æŸ¥è¿›ç¨‹
              if pgrep -f "${{ inputs.project }}" > /dev/null; then
                echo "âœ… æ‰¾åˆ°ç›¸å…³è¿›ç¨‹:"
                pgrep -f "${{ inputs.project }}" | head -5
              else
                echo "âš ï¸ æœªæ‰¾åˆ°ç›¸å…³è¿›ç¨‹"
              fi
            fi
            
            # æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼ˆå¦‚æžœæ˜¯åŽç«¯æœåŠ¡ï¼‰
            if command -v netstat &> /dev/null; then
              echo "ðŸ” æ£€æŸ¥ç«¯å£å ç”¨æƒ…å†µ..."
              netstat -tlnp | grep -E ":(8080|3000|8000|5000)" | head -5 || echo "æœªæ‰¾åˆ°ç›¸å…³ç«¯å£"
            fi
            
            echo "âœ… å¯åŠ¨å‘½ä»¤æ‰§è¡Œå®Œæˆ"
            
            # ===== æ–°å¢žï¼šæœåŠ¡å¯åŠ¨éªŒè¯ =====
            echo "ðŸ” å¼€å§‹æœåŠ¡å¯åŠ¨éªŒè¯..."
            
            # ç­‰å¾…æ›´é•¿æ—¶é—´ç¡®ä¿æœåŠ¡å®Œå…¨å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨..."
            sleep 10
          max_retries: 2
          retry_delay: 15
          timeout_minutes: 15
          strategy: "exponential"
          continue_on_error: false

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          echo "start_success=true" >> $GITHUB_OUTPUT
          echo "âœ… è¾“å‡ºå·²è®¾ç½®"
          echo "- start_success: true"
