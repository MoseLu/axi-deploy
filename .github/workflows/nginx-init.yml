name: Nginx æœåŠ¡å™¨åˆå§‹åŒ–

on:
  workflow_dispatch:
    inputs:
      server_host:
        description: 'æœåŠ¡å™¨IPåœ°å€'
        required: true
        default: 'your-server-ip'
      server_user:
        description: 'SSHç”¨æˆ·å'
        required: true
        default: 'root'
      domain:
        description: 'åŸŸå'
        required: true
        default: 'redamancy.com.cn'
      run_user:
        description: 'ä¸šåŠ¡è¿è¡Œç”¨æˆ·'
        required: true
        default: 'deploy'
      nginx_conf_dir:
        description: 'Nginxç‰‡æ®µç›®å½•'
        required: true
        default: '/www/server/nginx/conf/conf.d/redamancy'
      apps_root:
        description: 'äºŒè¿›åˆ¶æ ¹ç›®å½•'
        required: true
        default: '/srv/apps'
      static_root:
        description: 'é™æ€æ–‡ä»¶æ ¹ç›®å½•'
        required: true
        default: '/srv/static'
      cert_src:
        description: 'è¯ä¹¦æºç›®å½•ï¼ˆå®å¡”ï¼‰'
        required: true
        default: '/www/server/panel/vhost/cert/redamancy.com.cn'
      cert_dst:
        description: 'è¯ä¹¦ä½¿ç”¨ç›®å½•'
        required: true
        default: '/www/server/nginx/ssl/redamancy'

jobs:
  nginx-init:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å‰ç½®æ£€æŸ¥
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸ” å¼€å§‹NginxæœåŠ¡å™¨åˆå§‹åŒ–..."
            echo "ğŸ“‹ å‰ç½®æ£€æŸ¥..."
            
            # æ£€æŸ¥Nginxæ˜¯å¦å®‰è£…
            if command -v nginx &> /dev/null; then
              echo "âœ… Nginxå·²å®‰è£…: $(nginx -v)"
            else
              echo "âŒ Nginxæœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Nginx"
              exit 1
            fi
            
            # æ£€æŸ¥NginxæœåŠ¡çŠ¶æ€
            if systemctl is-active --quiet nginx; then
              echo "âœ… NginxæœåŠ¡æ­£åœ¨è¿è¡Œ"
            else
              echo "âš ï¸  NginxæœåŠ¡æœªè¿è¡Œï¼Œå°è¯•å¯åŠ¨..."
              systemctl start nginx
            fi
            
            echo "âœ… å‰ç½®æ£€æŸ¥å®Œæˆ"

      - name: åˆ›å»ºä¸šåŠ¡è¿è¡Œç”¨æˆ·
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸ‘¤ åˆ›å»ºä¸šåŠ¡è¿è¡Œç”¨æˆ·..."
            
            # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
            if id "${{ inputs.run_user }}" &>/dev/null; then
              echo "âœ… ç”¨æˆ· ${{ inputs.run_user }} å·²å­˜åœ¨"
            else
              echo "ğŸ†• åˆ›å»ºç”¨æˆ· ${{ inputs.run_user }}..."
              sudo useradd -m -s /bin/bash ${{ inputs.run_user }}
              echo "âœ… ç”¨æˆ· ${{ inputs.run_user }} åˆ›å»ºå®Œæˆ"
            fi
            
            # æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
            id ${{ inputs.run_user }}

      - name: åˆ›å»ºæ‰€éœ€ç›®å½•
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸ“ åˆ›å»ºæ‰€éœ€ç›®å½•..."
            
            # åˆ›å»ºç›®å½•
            sudo mkdir -p \
              ${{ inputs.apps_root }} \
              ${{ inputs.static_root }} \
              ${{ inputs.nginx_conf_dir }} \
              ${{ inputs.cert_dst }}
            
            # è®¾ç½®æƒé™
            sudo chown ${{ inputs.run_user }}:${{ inputs.run_user }} ${{ inputs.apps_root }} ${{ inputs.static_root }}
            sudo chmod 755 ${{ inputs.nginx_conf_dir }} ${{ inputs.cert_dst }}
            
            echo "âœ… ç›®å½•åˆ›å»ºå®Œæˆ:"
            ls -la ${{ inputs.apps_root }}
            ls -la ${{ inputs.static_root }}
            ls -la ${{ inputs.nginx_conf_dir }}

      - name: è½¯é“¾å®å¡”è¯ä¹¦
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸ”— è½¯é“¾å®å¡”è¯ä¹¦..."
            
            DOMAIN=${{ inputs.domain }}
            CERT_SRC=${{ inputs.cert_src }}
            CERT_DST=${{ inputs.cert_dst }}
            
            # æ£€æŸ¥è¯ä¹¦æºç›®å½•æ˜¯å¦å­˜åœ¨
            if [ ! -d "$CERT_SRC" ]; then
              echo "âŒ è¯ä¹¦æºç›®å½•ä¸å­˜åœ¨: $CERT_SRC"
              echo "è¯·ç¡®ä¿å®å¡”é¢æ¿å·²ä¸ºåŸŸå $DOMAIN é…ç½®SSLè¯ä¹¦"
              exit 1
            fi
            
            # åˆ›å»ºç›®æ ‡ç›®å½•
            sudo mkdir -p $CERT_DST
            
            # è½¯é“¾è¯ä¹¦æ–‡ä»¶
            if [ -f "$CERT_SRC/fullchain.pem" ]; then
              sudo ln -sf $CERT_SRC/fullchain.pem $CERT_DST/fullchain.pem
              echo "âœ… è½¯é“¾ fullchain.pem å®Œæˆ"
            else
              echo "âŒ è¯ä¹¦æ–‡ä»¶ä¸å­˜åœ¨: $CERT_SRC/fullchain.pem"
              exit 1
            fi
            
            if [ -f "$CERT_SRC/privkey.pem" ]; then
              sudo ln -sf $CERT_SRC/privkey.pem $CERT_DST/privkey.pem
              echo "âœ… è½¯é“¾ privkey.pem å®Œæˆ"
            else
              echo "âŒ ç§é’¥æ–‡ä»¶ä¸å­˜åœ¨: $CERT_SRC/privkey.pem"
              exit 1
            fi
            
            echo "âœ… è¯ä¹¦è½¯é“¾å®Œæˆ: $CERT_DST â†’ $CERT_SRC"
            ls -la $CERT_DST/

      - name: å†™å…¥å›ºå®šä¸»é…ç½®
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸ“ å†™å…¥å›ºå®šä¸»é…ç½®..."
            
            MAIN=${{ inputs.nginx_conf_dir }}/00-main.conf
            
            sudo tee $MAIN <<'EOF'
            server {
                listen 443 ssl http2;
                server_name ${{ inputs.domain }};
            
                ssl_certificate     ${{ inputs.cert_dst }}/fullchain.pem;
                ssl_certificate_key ${{ inputs.cert_dst }}/privkey.pem;
            
                client_max_body_size 100m;
            
                # è¿™é‡Œè‡ªåŠ¨åŠ è½½ route-*.confï¼ˆé¡¹ç›®è·¯ç”±ï¼‰â€”â€”ä¸»é…ç½®æ°¸è¿œä¸ç”¨å†æ”¹
                include ${{ inputs.nginx_conf_dir }}/route-*.conf;
            }
            
            server {
                listen 80;
                server_name ${{ inputs.domain }};
                return 301 https://$host$request_uri;
            }
            EOF
            
            echo "âœ… å†™å…¥ 00-main.conf å®Œæˆ"
            cat $MAIN

      - name: æ£€æŸ¥å¹¶é‡è½½Nginx
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸ”„ æ£€æŸ¥å¹¶é‡è½½Nginx..."
            
            # æ£€æŸ¥Nginxé…ç½®è¯­æ³•
            if sudo nginx -t; then
              echo "âœ… Nginxé…ç½®è¯­æ³•æ£€æŸ¥é€šè¿‡"
            else
              echo "âŒ Nginxé…ç½®è¯­æ³•é”™è¯¯"
              exit 1
            fi
            
            # é‡è½½Nginxé…ç½®
            if sudo systemctl reload nginx; then
              echo "âœ… Nginxçƒ­åŠ è½½å®Œæˆ"
            else
              echo "âŒ Nginxé‡è½½å¤±è´¥"
              exit 1
            fi

      - name: é˜²ç«å¢™æ£€æŸ¥
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸ”¥ é˜²ç«å¢™è§„åˆ™æ£€æŸ¥..."
            
            # æ£€æŸ¥firewalld
            if command -v firewall-cmd &> /dev/null; then
              echo "æ£€æµ‹åˆ° firewalldï¼Œæ£€æŸ¥HTTP/HTTPSç«¯å£..."
              if sudo firewall-cmd --list-services | grep -q http; then
                echo "âœ… HTTPç«¯å£å·²å¼€æ”¾"
              else
                echo "âš ï¸  HTTPç«¯å£æœªå¼€æ”¾ï¼Œå°è¯•å¼€æ”¾..."
                sudo firewall-cmd --add-service=http --permanent
                sudo firewall-cmd --add-service=https --permanent
                sudo firewall-cmd --reload
                echo "âœ… HTTP/HTTPSç«¯å£å·²å¼€æ”¾"
              fi
            else
              echo "æœªæ£€æµ‹åˆ° firewalldï¼Œè·³è¿‡é˜²ç«å¢™é…ç½®"
            fi
            
            echo "âœ… é˜²ç«å¢™æ£€æŸ¥å®Œæˆ"

      - name: ç»“æœéªŒè¯
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸ” ç»“æœéªŒè¯..."
            
            # æ£€æŸ¥é…ç½®æ–‡ä»¶
            echo "ğŸ“ æ£€æŸ¥é…ç½®æ–‡ä»¶:"
            ls -la ${{ inputs.nginx_conf_dir }}/
            
            # æ£€æŸ¥è¯ä¹¦è½¯é“¾
            echo "ğŸ”— æ£€æŸ¥è¯ä¹¦è½¯é“¾:"
            ls -la ${{ inputs.cert_dst }}/
            
            # æ£€æŸ¥ç›®å½•æƒé™
            echo "ğŸ“‚ æ£€æŸ¥ç›®å½•æƒé™:"
            ls -la ${{ inputs.apps_root }}/
            ls -la ${{ inputs.static_root }}/
            
            # æµ‹è¯•HTTPSè®¿é—®
            echo "ğŸŒ æµ‹è¯•HTTPSè®¿é—®:"
            curl -I https://${{ inputs.domain }} || echo "âš ï¸  HTTPSè®¿é—®æµ‹è¯•å¤±è´¥ï¼ˆå¯èƒ½å°šæœªéƒ¨ç½²é¡¹ç›®ï¼‰"
            
            echo "âœ… åˆå§‹åŒ–å®Œæˆï¼"
            echo ""
            echo "ğŸ“‹ åˆå§‹åŒ–æ‘˜è¦:"
            echo "- åŸŸå: ${{ inputs.domain }}"
            echo "- è¿è¡Œç”¨æˆ·: ${{ inputs.run_user }}"
            echo "- åº”ç”¨ç›®å½•: ${{ inputs.apps_root }}"
            echo "- é™æ€æ–‡ä»¶ç›®å½•: ${{ inputs.static_root }}"
            echo "- Nginxé…ç½®ç›®å½•: ${{ inputs.nginx_conf_dir }}"
            echo "- è¯ä¹¦ç›®å½•: ${{ inputs.cert_dst }}"
            echo ""
            echo "ğŸ‰ æœåŠ¡å™¨å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹éƒ¨ç½²é¡¹ç›®ï¼" 