name: Debug JWT Generation

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: è¯¦ç»†è°ƒè¯• JWT ç”Ÿæˆ
        run: |
          echo "=== è¯¦ç»†è°ƒè¯• JWT ç”Ÿæˆ ==="
          
          APP_ID="${{ secrets.APP_ID }}"
          PRIVATE_KEY="${{ secrets.APP_PRIVATE_KEY }}"
          INSTALLATION_ID="${{ secrets.APP_INSTALLATION_ID }}"
          
          echo "=== 1. æ£€æŸ¥ Secrets ==="
          echo "APP_ID: $APP_ID"
          echo "APP_INSTALLATION_ID: $INSTALLATION_ID"
          echo "PRIVATE_KEY é•¿åº¦: ${#PRIVATE_KEY}"
          
          if [ -z "$APP_ID" ]; then
            echo "âŒ APP_ID ä¸ºç©º"
            exit 1
          fi
          
          if [ -z "$INSTALLATION_ID" ]; then
            echo "âŒ APP_INSTALLATION_ID ä¸ºç©º"
            exit 1
          fi
          
          if [ -z "$PRIVATE_KEY" ]; then
            echo "âŒ PRIVATE_KEY ä¸ºç©º"
            exit 1
          fi
          
          echo "âœ… æ‰€æœ‰ Secrets éƒ½å·²é…ç½®"
          
          echo ""
          echo "=== 2. æ£€æŸ¥ç§é’¥æ ¼å¼ ==="
          echo "ç§é’¥å‰100ä¸ªå­—ç¬¦:"
          echo "${PRIVATE_KEY:0:100}"
          echo ""
          echo "ç§é’¥å100ä¸ªå­—ç¬¦:"
          echo "${PRIVATE_KEY: -100}"
          
          # æ£€æŸ¥ç§é’¥æ˜¯å¦åŒ…å«æ­£ç¡®çš„æ ‡è®°
          if [[ "$PRIVATE_KEY" =~ "-----BEGIN RSA PRIVATE KEY-----" ]]; then
            echo "âœ… ç§é’¥åŒ…å«æ­£ç¡®çš„å¼€å§‹æ ‡è®°"
          else
            echo "âŒ ç§é’¥ç¼ºå°‘å¼€å§‹æ ‡è®°"
          fi
          
          if [[ "$PRIVATE_KEY" =~ "-----END RSA PRIVATE KEY-----" ]]; then
            echo "âœ… ç§é’¥åŒ…å«æ­£ç¡®çš„ç»“æŸæ ‡è®°"
          else
            echo "âŒ ç§é’¥ç¼ºå°‘ç»“æŸæ ‡è®°"
          fi
          
          echo ""
          echo "=== 3. æ¸…ç†ç§é’¥ ==="
          # æ¸…ç†ç§é’¥ - ç§»é™¤å¯èƒ½çš„é¢å¤–å­—ç¬¦
          CLEANED_KEY=$(echo "$PRIVATE_KEY" | sed 's/\\n/\n/g' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
          
          echo "æ¸…ç†åçš„ç§é’¥å‰100ä¸ªå­—ç¬¦:"
          echo "${CLEANED_KEY:0:100}"
          
          echo ""
          echo "=== 4. å†™å…¥ç§é’¥æ–‡ä»¶ ==="
          echo "$CLEANED_KEY" > /tmp/debug_key.pem
          chmod 600 /tmp/debug_key.pem
          
          echo "ç§é’¥æ–‡ä»¶å¤§å°:"
          ls -la /tmp/debug_key.pem
          
          echo "ç§é’¥æ–‡ä»¶å†…å®¹ï¼ˆå‰10è¡Œï¼‰:"
          head -10 /tmp/debug_key.pem
          
          echo ""
          echo "=== 5. éªŒè¯ç§é’¥ ==="
          if openssl rsa -in /tmp/debug_key.pem -check -noout 2>/dev/null; then
            echo "âœ… ç§é’¥æ ¼å¼æœ‰æ•ˆ"
          else
            echo "âŒ ç§é’¥æ ¼å¼æ— æ•ˆ"
            echo "OpenSSL é”™è¯¯ä¿¡æ¯:"
            openssl rsa -in /tmp/debug_key.pem -check -noout 2>&1
            exit 1
          fi
          
          echo ""
          echo "=== 6. ç”Ÿæˆ JWT ==="
          NOW=$(date +%s)
          EXPIRES=$((NOW + 600))
          
          echo "å½“å‰æ—¶é—´æˆ³: $NOW"
          echo "è¿‡æœŸæ—¶é—´æˆ³: $EXPIRES"
          
          # ç”Ÿæˆ header
          HEADER_JSON='{"alg":"RS256","typ":"JWT"}'
          HEADER=$(echo -n "$HEADER_JSON" | base64 -w 0 | tr -d '=' | tr '/+' '_-')
          echo "Header JSON: $HEADER_JSON"
          echo "Header (base64): $HEADER"
          
          # ç”Ÿæˆ payload
          PAYLOAD_JSON="{\"iat\":$NOW,\"exp\":$EXPIRES,\"iss\":\"$APP_ID\"}"
          PAYLOAD=$(echo -n "$PAYLOAD_JSON" | base64 -w 0 | tr -d '=' | tr '/+' '_-')
          echo "Payload JSON: $PAYLOAD_JSON"
          echo "Payload (base64): $PAYLOAD"
          
          # ç”Ÿæˆç­¾å
          SIGNATURE_INPUT="$HEADER.$PAYLOAD"
          echo "ç­¾åè¾“å…¥: $SIGNATURE_INPUT"
          
          SIGNATURE=$(echo -n "$SIGNATURE_INPUT" | openssl dgst -sha256 -sign /tmp/debug_key.pem | base64 -w 0 | tr -d '=' | tr '/+' '_-')
          
          if [ -z "$SIGNATURE" ]; then
            echo "âŒ ç­¾åç”Ÿæˆå¤±è´¥"
            exit 1
          fi
          
          echo "Signature (base64): $SIGNATURE"
          
          # ç»„åˆ JWT
          JWT="$HEADER.$PAYLOAD.$SIGNATURE"
          echo ""
          echo "=== å®Œæ•´ JWT ==="
          echo "JWT: $JWT"
          echo "JWT é•¿åº¦: ${#JWT}"
          
          # éªŒè¯ JWT æ ¼å¼
          JWT_PARTS=$(echo "$JWT" | tr '.' '\n' | wc -l)
          if [ "$JWT_PARTS" -ne 3 ]; then
            echo "âŒ JWT æ ¼å¼é”™è¯¯ï¼Œåº”è¯¥æœ‰3ä¸ªéƒ¨åˆ†ï¼Œå®é™…æœ‰ $JWT_PARTS ä¸ªéƒ¨åˆ†"
            exit 1
          fi
          
          echo "âœ… JWT æ ¼å¼æ­£ç¡®"
          
          echo ""
          echo "=== 7. æµ‹è¯• API è°ƒç”¨ ==="
          echo "æµ‹è¯• JWT æ˜¯å¦æœ‰æ•ˆ..."
          
          # æµ‹è¯• API è°ƒç”¨
          API_RESPONSE=$(curl -s -X GET \
            -H "Authorization: Bearer $JWT" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/app")
          
          echo "API å“åº”: $API_RESPONSE"
          
          # æ£€æŸ¥ API å“åº”
          if echo "$API_RESPONSE" | jq -e '.id' > /dev/null 2>&1; then
            echo "âœ… JWT æœ‰æ•ˆï¼ŒAPI è°ƒç”¨æˆåŠŸ"
          else
            echo "âŒ JWT æ— æ•ˆï¼ŒAPI è°ƒç”¨å¤±è´¥"
            echo "é”™è¯¯è¯¦æƒ…: $API_RESPONSE"
            exit 1
          fi
          
          echo ""
          echo "=== 8. è·å– Installation Token ==="
          TOKEN_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $JWT" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/app/installations/$INSTALLATION_ID/access_tokens")
          
          echo "Token å“åº”: $TOKEN_RESPONSE"
          
          ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.token')
          
          if [ "$ACCESS_TOKEN" = "null" ] || [ -z "$ACCESS_TOKEN" ]; then
            echo "âŒ Installation Token è·å–å¤±è´¥"
            echo "é”™è¯¯è¯¦æƒ…: $TOKEN_RESPONSE"
            exit 1
          fi
          
          echo "âœ… Installation Token è·å–æˆåŠŸ"
          TOKEN_EXPIRES=$(echo "$TOKEN_RESPONSE" | jq -r '.expires_at')
          echo "Token è¿‡æœŸæ—¶é—´: $TOKEN_EXPIRES"
          
          # æ¸…ç†
          rm -f /tmp/debug_key.pem
          
          echo ""
          echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼JWT ç”Ÿæˆå’Œ API è°ƒç”¨éƒ½æ­£å¸¸å·¥ä½œã€‚" 