name: Retry Center Workflow

description: "é‡è¯•ä¸­å¿ƒå¯å¤ç”¨å·¥ä½œæµ - ç»Ÿä¸€ç®¡ç† GitHub Actions å·¥ä½œæµä¸­çš„é‡è¯•æœºåˆ¶"

on:
  workflow_call:
    inputs:
      # é‡è¯•é…ç½®
      max_retries:
        description: 'æœ€å¤§é‡è¯•æ¬¡æ•°'
        required: false
        type: number
        default: 3
      retry_delay:
        description: 'é‡è¯•é—´éš”ï¼ˆç§’ï¼‰'
        required: false
        type: number
        default: 5
      timeout_minutes:
        description: 'å•æ¬¡æ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰'
        required: false
        type: number
        default: 10
      
      # é‡è¯•ç­–ç•¥
      retry_strategy:
        description: 'é‡è¯•ç­–ç•¥ (simple/exponential/adaptive)'
        required: false
        type: string
        default: 'simple'
      
      # æ‰§è¡Œé…ç½®
      step_name:
        description: 'æ­¥éª¤åç§°ï¼ˆç”¨äºŽæ—¥å¿—å’Œè·Ÿè¸ªï¼‰'
        required: true
        type: string
      command:
        description: 'è¦æ‰§è¡Œçš„å‘½ä»¤'
        required: true
        type: string
      
      # é”™è¯¯å¤„ç†
      continue_on_error:
        description: 'é‡è¯•å¤±è´¥åŽæ˜¯å¦ç»§ç»­æ‰§è¡Œ'
        required: false
        type: boolean
        default: false
      
      # é€šçŸ¥é…ç½®
      notify_on_failure:
        description: 'å¤±è´¥æ—¶æ˜¯å¦å‘é€é€šçŸ¥'
        required: false
        type: boolean
        default: true
      
      # æ­¥éª¤ç±»åž‹é…ç½®
      step_type:
        description: 'æ­¥éª¤ç±»åž‹ (network/file_operation/validation/parsing)'
        required: false
        type: string
        default: 'network'
      
      # çŽ¯å¢ƒå˜é‡
      env_vars:
        description: 'çŽ¯å¢ƒå˜é‡ï¼ˆJSONæ ¼å¼ï¼‰'
        required: false
        type: string
        default: '{}'

    outputs:
      success:
        description: 'æ‰§è¡Œæ˜¯å¦æˆåŠŸ'
        value: ${{ jobs.retry-execution.outputs.success }}
      attempts:
        description: 'å®žé™…é‡è¯•æ¬¡æ•°'
        value: ${{ jobs.retry-execution.outputs.attempts }}
      execution_time:
        description: 'æ€»æ‰§è¡Œæ—¶é—´ï¼ˆç§’ï¼‰'
        value: ${{ jobs.retry-execution.outputs.execution_time }}
      error_message:
        description: 'é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æžœå¤±è´¥ï¼‰'
        value: ${{ jobs.retry-execution.outputs.error_message }}
      retry_report:
        description: 'é‡è¯•æŠ¥å‘Šï¼ˆJSONæ ¼å¼ï¼‰'
        value: ${{ jobs.retry-execution.outputs.retry_report }}

jobs:
  retry-execution:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      success: ${{ steps.retry-step.outputs.success }}
      attempts: ${{ steps.retry-step.outputs.attempts }}
      execution_time: ${{ steps.retry-step.outputs.execution_time }}
      error_message: ${{ steps.retry-step.outputs.error_message }}
      retry_report: ${{ steps.retry-step.outputs.retry_report }}
    
    steps:
      - name: æ£€æŸ¥é‡è¯•ä¸­å¿ƒé…ç½®
        run: |
          echo "ðŸ” æ£€æŸ¥é‡è¯•ä¸­å¿ƒé…ç½®..."
          
          # éªŒè¯é‡è¯•ä¸­å¿ƒactionæ˜¯å¦å­˜åœ¨
          if [ ! -f ".github/actions/retry-center/action.yml" ]; then
            echo "âŒ é‡è¯•ä¸­å¿ƒactionä¸å­˜åœ¨"
            exit 1
          fi
          
          if [ ! -f ".github/actions/retry-center/retry-logic.sh" ]; then
            echo "âŒ é‡è¯•ä¸­å¿ƒé€»è¾‘è„šæœ¬ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… é‡è¯•ä¸­å¿ƒé…ç½®å®Œæ•´"

      - name: è§£æžçŽ¯å¢ƒå˜é‡
        id: parse-env
        run: |
          echo "ðŸ” è§£æžçŽ¯å¢ƒå˜é‡..."
          
          # è§£æžJSONæ ¼å¼çš„çŽ¯å¢ƒå˜é‡
          ENV_VARS='${{ inputs.env_vars }}'
          if [ "$ENV_VARS" != "{}" ]; then
            echo "ðŸ“‹ çŽ¯å¢ƒå˜é‡:"
            echo "$ENV_VARS" | jq -r 'to_entries[] | "export \(.key)=\(.value)"'
          else
            echo "ðŸ“‹ æ— è‡ªå®šä¹‰çŽ¯å¢ƒå˜é‡"
          fi
          
          echo "env_vars_parsed=true" >> $GITHUB_OUTPUT

      - name: æ‰§è¡Œé‡è¯•é€»è¾‘
        id: retry-step
        shell: bash
        run: |
          # é‡è¯•ä¸­å¿ƒæ ¸å¿ƒé€»è¾‘
          source .github/actions/retry-center/retry-logic.sh
          
          # æ‰§è¡Œé‡è¯•é€»è¾‘
          execute_with_retry \
            --max-retries "${{ inputs.max_retries }}" \
            --retry-delay "${{ inputs.retry_delay }}" \
            --timeout-minutes "${{ inputs.timeout_minutes }}" \
            --strategy "${{ inputs.retry_strategy }}" \
            --step-name "${{ inputs.step_name }}" \
            --command "${{ inputs.command }}" \
            --continue-on-error "${{ inputs.continue_on_error }}" \
            --notify-on-failure "${{ inputs.notify_on_failure }}"

      - name: ç”Ÿæˆé‡è¯•æŠ¥å‘Š
        if: always()
        run: |
          echo "ðŸ“Š ç”Ÿæˆé‡è¯•æŠ¥å‘Š..."
          
          # åˆ›å»ºæŠ¥å‘Šç›®å½•
          mkdir -p .github/retry-reports
          
          # ç”ŸæˆæŠ¥å‘Šæ–‡ä»¶å
          REPORT_FILE=".github/retry-reports/retry-report-$(date +%Y%m%d_%H%M%S).json"
          
          # æž„å»ºæŠ¥å‘Šå†…å®¹
          cat > "$REPORT_FILE" << EOF
          {
            "step_name": "${{ inputs.step_name }}",
            "workflow_run_id": "${{ github.run_id }}",
            "job_name": "retry-execution",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "success": ${{ steps.retry-step.outputs.success || 'false' }},
            "attempts": ${{ steps.retry-step.outputs.attempts || '0' }},
            "execution_time_seconds": ${{ steps.retry-step.outputs.execution_time || '0' }},
            "error_message": "${{ steps.retry-step.outputs.error_message || '' }}",
            "retry_config": {
              "max_retries": ${{ inputs.max_retries }},
              "retry_delay": ${{ inputs.retry_delay }},
              "timeout_minutes": ${{ inputs.timeout_minutes }},
              "strategy": "${{ inputs.retry_strategy }}",
              "step_type": "${{ inputs.step_type }}"
            },
            "environment": {
              "runner": "${{ runner.os }}",
              "workflow": "${{ github.workflow }}",
              "repository": "${{ github.repository }}"
            }
          }
          EOF
          
          echo "âœ… é‡è¯•æŠ¥å‘Šå·²ç”Ÿæˆ: $REPORT_FILE"
          
          # è¾“å‡ºæŠ¥å‘Šå†…å®¹
          cat "$REPORT_FILE"

      - name: ä¸Šä¼ é‡è¯•æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: retry-reports-${{ github.run_id }}
          path: .github/retry-reports/
          retention-days: 30

      - name: å¤±è´¥é€šçŸ¥
        if: failure() && inputs.notify_on_failure == 'true'
        run: |
          echo "ðŸ“¢ é‡è¯•å¤±è´¥é€šçŸ¥"
          echo "=================="
          echo "æ­¥éª¤åç§°: ${{ inputs.step_name }}"
          echo "å·¥ä½œæµè¿è¡ŒID: ${{ github.run_id }}"
          echo "é‡è¯•æ¬¡æ•°: ${{ steps.retry-step.outputs.attempts || '0' }}"
          echo "æ‰§è¡Œæ—¶é—´: ${{ steps.retry-step.outputs.execution_time || '0' }}ç§’"
          echo "é”™è¯¯ä¿¡æ¯: ${{ steps.retry-step.outputs.error_message || 'æœªçŸ¥é”™è¯¯' }}"
          echo ""
          echo "ðŸ” è¯·æ£€æŸ¥é‡è¯•æŠ¥å‘Šäº†è§£è¯¦ç»†ä¿¡æ¯"
          
          # è¿™é‡Œå¯ä»¥é›†æˆSlackã€Emailç­‰é€šçŸ¥æœåŠ¡
          # ä¾‹å¦‚ï¼šcurl -X POST -H 'Content-type: application/json' --data '{"text":"é‡è¯•å¤±è´¥é€šçŸ¥"}' $SLACK_WEBHOOK_URL
