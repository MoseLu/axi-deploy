name: Retry Center Workflow

description: "é‡è¯•ä¸­å¿ƒå¯å¤ç”¨å·¥ä½œæµ - ç»Ÿä¸€ç®¡ç† GitHub Actions å·¥ä½œæµä¸­çš„é‡è¯•æœºåˆ¶"

on:
  workflow_call:
    inputs:
      # é‡è¯•é…ç½®
      max_retries:
        description: 'æœ€å¤§é‡è¯•æ¬¡æ•°'
        required: false
        type: number
        default: 3
      retry_delay:
        description: 'é‡è¯•é—´éš”ï¼ˆç§’ï¼‰'
        required: false
        type: number
        default: 5
      timeout_minutes:
        description: 'å•æ¬¡æ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰'
        required: false
        type: number
        default: 10
      
      # é‡è¯•ç­–ç•¥
      retry_strategy:
        description: 'é‡è¯•ç­–ç•¥ (simple/exponential/adaptive)'
        required: false
        type: string
        default: 'simple'
      
      # æ‰§è¡Œé…ç½®
      step_name:
        description: 'æ­¥éª¤åç§°ï¼ˆç”¨äºæ—¥å¿—å’Œè·Ÿè¸ªï¼‰'
        required: true
        type: string
      command:
        description: 'è¦æ‰§è¡Œçš„å‘½ä»¤'
        required: true
        type: string
      
      # é”™è¯¯å¤„ç†
      continue_on_error:
        description: 'é‡è¯•å¤±è´¥åæ˜¯å¦ç»§ç»­æ‰§è¡Œ'
        required: false
        type: boolean
        default: false
      
      # é€šçŸ¥é…ç½®
      notify_on_failure:
        description: 'å¤±è´¥æ—¶æ˜¯å¦å‘é€é€šçŸ¥'
        required: false
        type: boolean
        default: true
      
      # æ­¥éª¤ç±»å‹é…ç½®
      step_type:
        description: 'æ­¥éª¤ç±»å‹ (network/file_operation/validation/parsing/backend_service)'
        required: false
        type: string
        default: 'network'
      
      # ç¯å¢ƒå˜é‡
      env_vars:
        description: 'ç¯å¢ƒå˜é‡ï¼ˆJSONæ ¼å¼ï¼‰'
        required: false
        type: string
        default: '{}'
      
      # æ–°å¢ï¼šåç«¯æœåŠ¡è¯Šæ–­é…ç½®
      backend_diagnosis:
        description: 'æ˜¯å¦å¯ç”¨åç«¯æœåŠ¡è¯Šæ–­'
        required: false
        type: boolean
        default: false
      
      # æ–°å¢ï¼šæœåŠ¡é‡å¯é…ç½®
      restart_service:
        description: 'å¤±è´¥æ—¶æ˜¯å¦å°è¯•é‡å¯æœåŠ¡'
        required: false
        type: boolean
        default: false
      
      # æ–°å¢ï¼šæœåŠ¡éªŒè¯é…ç½®
      service_validation:
        description: 'æ˜¯å¦å¯ç”¨æœåŠ¡éªŒè¯'
        required: false
        type: boolean
        default: false
      
      # æ–°å¢ï¼šæœåŠ¡ç«¯å£é…ç½®
      service_port:
        description: 'æœåŠ¡ç«¯å£ï¼ˆç”¨äºéªŒè¯ï¼‰'
        required: false
        type: string
        default: ''
      
      # æ–°å¢ï¼šå¥åº·æ£€æŸ¥ç«¯ç‚¹
      health_endpoint:
        description: 'å¥åº·æ£€æŸ¥ç«¯ç‚¹'
        required: false
        type: string
        default: '/health'
      
      # æ–°å¢ï¼šéªŒè¯è¶…æ—¶æ—¶é—´
      validation_timeout:
        description: 'éªŒè¯è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰'
        required: false
        type: number
        default: 30

    outputs:
      success:
        description: 'æ‰§è¡Œæ˜¯å¦æˆåŠŸ'
        value: ${{ jobs.retry-execution.outputs.success }}
      attempts:
        description: 'å®é™…é‡è¯•æ¬¡æ•°'
        value: ${{ jobs.retry-execution.outputs.attempts }}
      execution_time:
        description: 'æ€»æ‰§è¡Œæ—¶é—´ï¼ˆç§’ï¼‰'
        value: ${{ jobs.retry-execution.outputs.execution_time }}
      error_message:
        description: 'é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœå¤±è´¥ï¼‰'
        value: ${{ jobs.retry-execution.outputs.error_message }}
      retry_report:
        description: 'é‡è¯•æŠ¥å‘Šï¼ˆJSONæ ¼å¼ï¼‰'
        value: ${{ jobs.retry-execution.outputs.retry_report }}

jobs:
  retry-execution:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      success: ${{ steps.retry-step.outputs.success }}
      attempts: ${{ steps.retry-step.outputs.attempts }}
      execution_time: ${{ steps.retry-step.outputs.execution_time }}
      error_message: ${{ steps.retry-step.outputs.error_message }}
      retry_report: ${{ steps.retry-step.outputs.retry_report }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: è§£æç¯å¢ƒå˜é‡
        id: parse-env
        run: |
          echo "ğŸ” è§£æç¯å¢ƒå˜é‡..."
          
          # è§£æJSONæ ¼å¼çš„ç¯å¢ƒå˜é‡
          ENV_VARS='${{ inputs.env_vars }}'
          if [ "$ENV_VARS" != "{}" ]; then
            echo "ğŸ“‹ ç¯å¢ƒå˜é‡:"
            echo "$ENV_VARS" | jq -r 'to_entries[] | "export \(.key)=\(.value)"'
          else
            echo "ğŸ“‹ æ— è‡ªå®šä¹‰ç¯å¢ƒå˜é‡"
          fi
          
          echo "env_vars_parsed=true" >> $GITHUB_OUTPUT

      - name: æ‰§è¡Œé‡è¯•é€»è¾‘
        id: retry-step
        shell: bash
        run: |
          # é‡è¯•ä¸­å¿ƒæ ¸å¿ƒé€»è¾‘
          MAX_RETRIES=${{ inputs.max_retries }}
          RETRY_DELAY=${{ inputs.retry_delay }}
          TIMEOUT_MINUTES=${{ inputs.timeout_minutes }}
          STRATEGY="${{ inputs.retry_strategy }}"
          STEP_NAME="${{ inputs.step_name }}"
          COMMAND="${{ inputs.command }}"
          CONTINUE_ON_ERROR="${{ inputs.continue_on_error }}"
          NOTIFY_ON_FAILURE="${{ inputs.notify_on_failure }}"
          STEP_TYPE="${{ inputs.step_type }}"
          
          # åˆå§‹åŒ–å˜é‡
          ATTEMPTS=0
          SUCCESS=false
          ERROR_MESSAGE=""
          START_TIME=$(date +%s)
          
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œé‡è¯•é€»è¾‘"
          echo "æ­¥éª¤åç§°: $STEP_NAME"
          echo "æœ€å¤§é‡è¯•æ¬¡æ•°: $MAX_RETRIES"
          echo "é‡è¯•é—´éš”: $RETRY_DELAYç§’"
          echo "è¶…æ—¶æ—¶é—´: $TIMEOUT_MINUTESåˆ†é’Ÿ"
          echo "é‡è¯•ç­–ç•¥: $STRATEGY"
          echo "æ­¥éª¤ç±»å‹: $STEP_TYPE"
          
          # é‡è¯•é€»è¾‘
          while [ $ATTEMPTS -le $MAX_RETRIES ]; do
            ATTEMPTS=$((ATTEMPTS + 1))
            echo ""
            echo "ğŸ”„ ç¬¬ $ATTEMPTS æ¬¡å°è¯•æ‰§è¡Œ..."
            
            # è®¾ç½®è¶…æ—¶
            TIMEOUT_CMD="timeout ${TIMEOUT_MINUTES}m"
            
            # æ‰§è¡Œå‘½ä»¤
            if $TIMEOUT_CMD bash -c "$COMMAND"; then
              echo "âœ… å‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼"
              
              # å¦‚æœå¯ç”¨äº†æœåŠ¡éªŒè¯ï¼Œè¿›è¡ŒæœåŠ¡éªŒè¯
              if [ "${{ inputs.service_validation }}" = "true" ] && [ -n "${{ inputs.service_port }}" ]; then
                echo "ğŸ” å¼€å§‹æœåŠ¡éªŒè¯..."
                echo "- æœåŠ¡ç«¯å£: ${{ inputs.service_port }}"
                echo "- å¥åº·æ£€æŸ¥ç«¯ç‚¹: ${{ inputs.health_endpoint }}"
                echo "- éªŒè¯è¶…æ—¶: ${{ inputs.validation_timeout }}ç§’"
                
                # ç­‰å¾…æœåŠ¡å¯åŠ¨
                echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
                sleep 5
                
                # éªŒè¯æœåŠ¡æ˜¯å¦å“åº”
                VALIDATION_SUCCESS=false
                VALIDATION_ATTEMPTS=0
                MAX_VALIDATION_ATTEMPTS=6
                
                while [ $VALIDATION_ATTEMPTS -lt $MAX_VALIDATION_ATTEMPTS ]; do
                  VALIDATION_ATTEMPTS=$((VALIDATION_ATTEMPTS + 1))
                  echo "ğŸ” éªŒè¯å°è¯• $VALIDATION_ATTEMPTS/$MAX_VALIDATION_ATTEMPTS..."
                  
                  # æ£€æŸ¥ç«¯å£æ˜¯å¦ç›‘å¬
                  if netstat -tlnp 2>/dev/null | grep -q ":${{ inputs.service_port }}"; then
                    echo "âœ… ç«¯å£ ${{ inputs.service_port }} æ­£åœ¨ç›‘å¬"
                    
                    # æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹
                    HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:${{ inputs.service_port }}${{ inputs.health_endpoint }}" --connect-timeout 5 --max-time 10 2>/dev/null || echo "connection_failed")
                    
                    if [ "$HEALTH_RESPONSE" = "200" ]; then
                      echo "âœ… å¥åº·æ£€æŸ¥æˆåŠŸ - çŠ¶æ€ç : $HEALTH_RESPONSE"
                      VALIDATION_SUCCESS=true
                      break
                    else
                      echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ - å“åº”: $HEALTH_RESPONSE"
                    fi
                  else
                    echo "âŒ ç«¯å£ ${{ inputs.service_port }} æœªç›‘å¬"
                  fi
                  
                  # å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡éªŒè¯ï¼Œç­‰å¾…åé‡è¯•
                  if [ $VALIDATION_ATTEMPTS -lt $MAX_VALIDATION_ATTEMPTS ]; then
                    echo "â³ ç­‰å¾… 5 ç§’åé‡è¯•éªŒè¯..."
                    sleep 5
                  fi
                done
                
                if [ "$VALIDATION_SUCCESS" = "true" ]; then
                  echo "âœ… æœåŠ¡éªŒè¯æˆåŠŸï¼"
                  SUCCESS=true
                  break
                else
                  echo "âŒ æœåŠ¡éªŒè¯å¤±è´¥"
                  ERROR_MESSAGE="æœåŠ¡å¯åŠ¨æˆåŠŸä½†éªŒè¯å¤±è´¥ - ç«¯å£:${{ inputs.service_port }}, å¥åº·æ£€æŸ¥:${{ inputs.health_endpoint }}"
                  SUCCESS=false
                fi
              else
                # æ²¡æœ‰å¯ç”¨æœåŠ¡éªŒè¯ï¼Œç›´æ¥è®¤ä¸ºæˆåŠŸ
                SUCCESS=true
                break
              fi
            else
              EXIT_CODE=$?
              if [ $EXIT_CODE -eq 124 ]; then
                ERROR_MESSAGE="æ‰§è¡Œè¶…æ—¶ï¼ˆ${TIMEOUT_MINUTES}åˆ†é’Ÿï¼‰"
              else
                ERROR_MESSAGE="æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $EXIT_CODE"
              fi
              
              echo "âŒ æ‰§è¡Œå¤±è´¥: $ERROR_MESSAGE"
              
              # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é‡è¯•æœºä¼š
              if [ $ATTEMPTS -le $MAX_RETRIES ]; then
                # è®¡ç®—é‡è¯•å»¶è¿Ÿ
                if [ "$STRATEGY" = "exponential" ]; then
                  DELAY=$((RETRY_DELAY * (2 ** (ATTEMPTS - 1))))
                elif [ "$STRATEGY" = "adaptive" ]; then
                  DELAY=$((RETRY_DELAY + ATTEMPTS * 2))
                else
                  DELAY=$RETRY_DELAY
                fi
                
                echo "â³ ç­‰å¾… $DELAY ç§’åé‡è¯•..."
                sleep $DELAY
              fi
            fi
          done
          
          # è®¡ç®—æ‰§è¡Œæ—¶é—´
          END_TIME=$(date +%s)
          EXECUTION_TIME=$((END_TIME - START_TIME))
          
          # è®¾ç½®è¾“å‡º
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "attempts=$ATTEMPTS" >> $GITHUB_OUTPUT
          echo "execution_time=$EXECUTION_TIME" >> $GITHUB_OUTPUT
          echo "error_message=$ERROR_MESSAGE" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆé‡è¯•æŠ¥å‘Š
          RETRY_REPORT=$(cat << EOF
          {
            "step_name": "$STEP_NAME",
            "workflow_run_id": "${{ github.run_id }}",
            "job_name": "retry-execution",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "success": $SUCCESS,
            "attempts": $ATTEMPTS,
            "execution_time_seconds": $EXECUTION_TIME,
            "error_message": "$ERROR_MESSAGE",
            "retry_config": {
              "max_retries": $MAX_RETRIES,
              "retry_delay": $RETRY_DELAY,
              "timeout_minutes": $TIMEOUT_MINUTES,
              "strategy": "$STRATEGY",
              "step_type": "$STEP_TYPE"
            },
            "environment": {
              "runner": "${{ runner.os }}",
              "workflow": "${{ github.workflow }}",
              "repository": "${{ github.repository }}"
            }
          }
          EOF
          )
          
          echo "retry_report='$RETRY_REPORT'" >> $GITHUB_OUTPUT
          
          # æœ€ç»ˆç»“æœ
          if [ "$SUCCESS" = "true" ]; then
            echo "ğŸ‰ é‡è¯•é€»è¾‘æ‰§è¡Œå®Œæˆ - æˆåŠŸ"
          else
            echo "ğŸ’¥ é‡è¯•é€»è¾‘æ‰§è¡Œå®Œæˆ - å¤±è´¥"
            if [ "$CONTINUE_ON_ERROR" = "false" ]; then
              exit 1
            fi
          fi

      - name: ç”Ÿæˆé‡è¯•æŠ¥å‘Šæ–‡ä»¶
        if: always()
        run: |
          echo "ğŸ“Š ç”Ÿæˆé‡è¯•æŠ¥å‘Šæ–‡ä»¶..."
          
          # åˆ›å»ºæŠ¥å‘Šç›®å½•
          mkdir -p .github/retry-reports
          
          # ç”ŸæˆæŠ¥å‘Šæ–‡ä»¶å
          REPORT_FILE=".github/retry-reports/retry-report-$(date +%Y%m%d_%H%M%S).json"
          
          # å†™å…¥æŠ¥å‘Šå†…å®¹
          echo '${{ steps.retry-step.outputs.retry_report }}' > "$REPORT_FILE"
          
          echo "âœ… é‡è¯•æŠ¥å‘Šå·²ç”Ÿæˆ: $REPORT_FILE"
          
          # è¾“å‡ºæŠ¥å‘Šå†…å®¹
          cat "$REPORT_FILE"

      - name: ä¸Šä¼ é‡è¯•æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: retry-reports-${{ github.run_id }}
          path: .github/retry-reports/
          retention-days: 30

      - name: å¤±è´¥é€šçŸ¥
        if: failure() && inputs.notify_on_failure == 'true'
        run: |
          echo "ğŸ“¢ é‡è¯•å¤±è´¥é€šçŸ¥"
          echo "=================="
          echo "æ­¥éª¤åç§°: ${{ inputs.step_name }}"
          echo "å·¥ä½œæµè¿è¡ŒID: ${{ github.run_id }}"
          echo "é‡è¯•æ¬¡æ•°: ${{ steps.retry-step.outputs.attempts || '0' }}"
          echo "æ‰§è¡Œæ—¶é—´: ${{ steps.retry-step.outputs.execution_time || '0' }}ç§’"
          echo "é”™è¯¯ä¿¡æ¯: ${{ steps.retry-step.outputs.error_message || 'æœªçŸ¥é”™è¯¯' }}"
          echo ""
          echo "ğŸ” è¯·æ£€æŸ¥é‡è¯•æŠ¥å‘Šäº†è§£è¯¦ç»†ä¿¡æ¯"
          
          # è¿™é‡Œå¯ä»¥é›†æˆSlackã€Emailç­‰é€šçŸ¥æœåŠ¡
          # ä¾‹å¦‚ï¼šcurl -X POST -H 'Content-type: application/json' --data '{"text":"é‡è¯•å¤±è´¥é€šçŸ¥"}' $SLACK_WEBHOOK_URL
