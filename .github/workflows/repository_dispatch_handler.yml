name: Repository Dispatch Handler

on:
  repository_dispatch:
    types: [deploy]

jobs:
  handle-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: éªŒè¯éƒ¨ç½²è¯·æ±‚å‚æ•°
        run: |
          echo "ğŸ” éªŒè¯éƒ¨ç½²è¯·æ±‚å‚æ•°..."
          
          # æ£€æŸ¥å¿…éœ€å‚æ•°
          if [ -z "${{ github.event.client_payload.project }}" ]; then
            echo "ğŸš¨ ç¼ºå°‘å¿…éœ€å‚æ•°: project"
            exit 1
          fi
          
          if [ -z "${{ github.event.client_payload.source_repo }}" ]; then
            echo "ğŸš¨ ç¼ºå°‘å¿…éœ€å‚æ•°: source_repo"
            exit 1
          fi
          
          if [ -z "${{ github.event.client_payload.run_id }}" ]; then
            echo "ğŸš¨ ç¼ºå°‘å¿…éœ€å‚æ•°: run_id"
            exit 1
          fi
          
          if [ -z "${{ github.event.client_payload.server_host }}" ]; then
            echo "ğŸš¨ ç¼ºå°‘å¿…éœ€å‚æ•°: server_host"
            exit 1
          fi
          
          if [ -z "${{ github.event.client_payload.server_user }}" ]; then
            echo "ğŸš¨ ç¼ºå°‘å¿…éœ€å‚æ•°: server_user"
            exit 1
          fi
          
          if [ -z "${{ github.event.client_payload.server_key }}" ]; then
            echo "ğŸš¨ ç¼ºå°‘å¿…éœ€å‚æ•°: server_key"
            exit 1
          fi
          
          if [ -z "${{ github.event.client_payload.server_port }}" ]; then
            echo "ğŸš¨ ç¼ºå°‘å¿…éœ€å‚æ•°: server_port"
            exit 1
          fi
          
          # æ£€æŸ¥DEPLOY_CENTER_PATå‚æ•°ï¼ˆå¿…éœ€ï¼‰
          if [ -z "${{ github.event.client_payload.deploy_center_pat }}" ]; then
            echo "ğŸš¨ ç¼ºå°‘å¿…éœ€å‚æ•°: deploy_center_pat"
            echo "âš ï¸ å¯å¤ç”¨å·¥ä½œæµæ— æ³•è®¿é—®è°ƒç”¨è€…ä»“åº“çš„secretsï¼Œå¿…é¡»é€šè¿‡å‚æ•°ä¼ é€’"
            exit 1
          fi
          
          echo "âœ… æ£€æµ‹åˆ°DEPLOY_CENTER_PATå‚æ•°"
          
          # éªŒè¯å‚æ•°æ ¼å¼
          if [[ ! "${{ github.event.client_payload.source_repo }}" =~ ^[^/]+/[^/]+$ ]]; then
            echo "ğŸš¨ æ— æ•ˆçš„source_repoæ ¼å¼: ${{ github.event.client_payload.source_repo }}"
            echo "æ­£ç¡®æ ¼å¼åº”ä¸º: owner/repo"
            exit 1
          fi
          
          if [[ ! "${{ github.event.client_payload.run_id }}" =~ ^[0-9]+$ ]]; then
            echo "ğŸš¨ æ— æ•ˆçš„run_idæ ¼å¼: ${{ github.event.client_payload.run_id }}"
            echo "run_idåº”ä¸ºæ•°å­—"
            exit 1
          fi
          
          if [[ ! "${{ github.event.client_payload.server_port }}" =~ ^[0-9]+$ ]]; then
            echo "ğŸš¨ æ— æ•ˆçš„server_portæ ¼å¼: ${{ github.event.client_payload.server_port }}"
            echo "server_portåº”ä¸ºæ•°å­—"
            exit 1
          fi
          
          # éªŒè¯éƒ¨ç½²ç±»å‹
          DEPLOY_TYPE="${{ github.event.client_payload.deploy_type || 'static' }}"
          if [[ "$DEPLOY_TYPE" != "static" && "$DEPLOY_TYPE" != "backend" ]]; then
            echo "ğŸš¨ æ— æ•ˆçš„deploy_type: $DEPLOY_TYPE"
            echo "deploy_typeåº”ä¸º 'static' æˆ– 'backend'"
            exit 1
          fi
          
          echo "âœ… éƒ¨ç½²è¯·æ±‚å‚æ•°éªŒè¯é€šè¿‡"
          echo "ğŸ“‹ éƒ¨ç½²è¯·æ±‚è¯¦æƒ…:"
          echo "- é¡¹ç›®: ${{ github.event.client_payload.project }}"
          echo "- éƒ¨ç½²ç±»å‹: $DEPLOY_TYPE"
          echo "- æºä»“åº“: ${{ github.event.client_payload.source_repo }}"
          echo "- æ„å»ºID: ${{ github.event.client_payload.run_id }}"
          echo "- æœåŠ¡å™¨: ${{ github.event.client_payload.server_host }}:${{ github.event.client_payload.server_port }}"
          echo "- ç”¨æˆ·: ${{ github.event.client_payload.server_user }}"
          if [ -n "${{ github.event.client_payload.deploy_center_pat }}" ]; then
            echo "- DEPLOY_CENTER_PAT: å·²æä¾›"
          else
            echo "- DEPLOY_CENTER_PAT: ä½¿ç”¨é»˜è®¤é…ç½®"
          fi

      - name: å¤„ç†éƒ¨ç½²è¯·æ±‚
        run: |
          echo "ğŸ“‹ æ”¶åˆ°éƒ¨ç½²è¯·æ±‚:"
          echo "- é¡¹ç›®: ${{ github.event.client_payload.project }}"
          echo "- éƒ¨ç½²ç±»å‹: ${{ github.event.client_payload.deploy_type || 'static' }}"
          echo "- æºä»“åº“: ${{ github.event.client_payload.source_repo }}"
          echo "- æ„å»ºID: ${{ github.event.client_payload.run_id }}"
          
          # è®°å½•éƒ¨ç½²è¯·æ±‚åˆ°æ—¥å¿—
          echo "ğŸ“ éƒ¨ç½²æ—¥å¿—:"
          echo "æ—¶é—´: $(date)"
          echo "é¡¹ç›®: ${{ github.event.client_payload.project }}"
          echo "ä»“åº“: ${{ github.event.client_payload.source_repo }}"
          echo "æ„å»ºID: ${{ github.event.client_payload.run_id }}"
          echo "éƒ¨ç½²ç±»å‹: ${{ github.event.client_payload.deploy_type || 'static' }}"
          
          echo "âœ… éƒ¨ç½²è¯·æ±‚å·²å¤„ç†"

  trigger-deployment:
    needs: handle-deploy
    runs-on: ubuntu-latest
    steps:
      - name: è§¦å‘ä¸»éƒ¨ç½²å·¥ä½œæµ
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              console.log('ğŸš€ è§¦å‘ä¸»éƒ¨ç½²å·¥ä½œæµ...');
              
              // éªŒè¯å‚æ•°
              const project = '${{ github.event.client_payload.project }}';
              const sourceRepo = '${{ github.event.client_payload.source_repo }}';
              const runId = '${{ github.event.client_payload.run_id }}';
              const serverHost = '${{ github.event.client_payload.server_host }}';
              const serverUser = '${{ github.event.client_payload.server_user }}';
              const serverKey = '${{ github.event.client_payload.server_key }}';
              const serverPort = '${{ github.event.client_payload.server_port }}';
              const deployCenterPat = '${{ github.event.client_payload.deploy_center_pat }}';
              
              if (!project || !sourceRepo || !runId || !serverHost || !serverUser || !serverKey || !serverPort || !deployCenterPat) {
                throw new Error('ç¼ºå°‘å¿…éœ€çš„éƒ¨ç½²å‚æ•°ï¼ŒåŒ…æ‹¬deploy_center_pat');
              }
              
              // æ„å»ºè¾“å…¥å‚æ•°
              const inputs = {
                project: project,
                source_repo: sourceRepo,
                run_id: runId,
                deploy_type: '${{ github.event.client_payload.deploy_type || 'static' }}',
                nginx_config: '${{ github.event.client_payload.nginx_config || '' }}',
                start_cmd: '${{ github.event.client_payload.start_cmd || '' }}',
                server_host: serverHost,
                server_user: serverUser,
                server_key: serverKey,
                server_port: serverPort,
                deploy_center_pat: deployCenterPat
              };
              
              console.log('ğŸ“‹ ä½¿ç”¨ä¸šåŠ¡ä»“åº“æä¾›çš„DEPLOY_CENTER_PAT');
              
              const { data: response } = await github.rest.actions.createWorkflowDispatch({
                owner: 'MoseLu',
                repo: 'axi-deploy',
                workflow_id: 'main-deployment.yml',
                ref: 'master',
                inputs: inputs
              });
              
              console.log('âœ… ä¸»éƒ¨ç½²å·¥ä½œæµå·²æˆåŠŸè§¦å‘!');
              console.log('ğŸ“‹ è§¦å‘è¯¦æƒ…:');
              console.log('- é¡¹ç›®:', project);
              console.log('- æºä»“åº“:', sourceRepo);
              console.log('- æ„å»ºID:', runId);
              console.log('- éƒ¨ç½²ç±»å‹:', '${{ github.event.client_payload.deploy_type || 'static' }}');
              console.log('- DEPLOY_CENTER_PAT: å·²æä¾›');
              
            } catch (error) {
              console.error('ğŸš¨ è§¦å‘ä¸»éƒ¨ç½²å·¥ä½œæµå¤±è´¥:', error.message);
              console.error('é”™è¯¯è¯¦æƒ…:', error);
              throw error;
            } 