name: Repository Dispatch Handler

on:
  repository_dispatch:
    types: [deploy]

jobs:
  handle-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: å¤„ç†éƒ¨ç½²è¯·æ±‚
        run: |
          echo "ğŸ“‹ æ”¶åˆ°éƒ¨ç½²è¯·æ±‚:"
          echo "- é¡¹ç›®: ${{ github.event.client_payload.project }}"
          echo "- éƒ¨ç½²ç±»å‹: ${{ github.event.client_payload.deploy_type || 'static' }}"
          echo "- æºä»“åº“: ${{ github.event.client_payload.source_repo }}"
          echo "- æ„å»ºID: ${{ github.event.client_payload.run_id }}"
          
          # è®°å½•éƒ¨ç½²è¯·æ±‚åˆ°æ—¥å¿—
          echo "ğŸ“ éƒ¨ç½²æ—¥å¿—:"
          echo "æ—¶é—´: $(date)"
          echo "é¡¹ç›®: ${{ github.event.client_payload.project }}"
          echo "ä»“åº“: ${{ github.event.client_payload.source_repo }}"
          echo "æ„å»ºID: ${{ github.event.client_payload.run_id }}"
          echo "éƒ¨ç½²ç±»å‹: ${{ github.event.client_payload.deploy_type || 'static' }}"
          
          echo "âœ… éƒ¨ç½²è¯·æ±‚å·²å¤„ç†"

  trigger-deployment:
    needs: handle-deploy
    runs-on: ubuntu-latest
    steps:
      - name: è§¦å‘ä¸»éƒ¨ç½²å·¥ä½œæµ
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              console.log('ğŸš€ è§¦å‘ä¸»éƒ¨ç½²å·¥ä½œæµ...');
              
              const { data: response } = await github.rest.actions.createWorkflowDispatch({
                owner: 'MoseLu',
                repo: 'axi-deploy',
                workflow_id: 'main-deployment.yml',
                ref: 'master',
                inputs: {
                  project: '${{ github.event.client_payload.project }}',
                  source_repo: '${{ github.event.client_payload.source_repo }}',
                  run_id: '${{ github.event.client_payload.run_id }}',
                  deploy_type: '${{ github.event.client_payload.deploy_type || 'static' }}',
                  nginx_config: '${{ github.event.client_payload.nginx_config || '' }}',
                  test_url: '${{ github.event.client_payload.test_url || '' }}',
                  start_cmd: '${{ github.event.client_payload.start_cmd || '' }}',
                  domain: '${{ github.event.client_payload.domain || 'redamancy.com.cn' }}',
                  apps_root: '${{ github.event.client_payload.apps_root || '/srv/apps' }}',
                  static_root: '${{ github.event.client_payload.static_root || '/srv/static' }}',
                  backup_root: '${{ github.event.client_payload.backup_root || '/srv/backups' }}',
                  run_user: '${{ github.event.client_payload.run_user || 'deploy' }}',
                  nginx_conf_dir: '${{ github.event.client_payload.nginx_conf_dir || '/www/server/nginx/conf/conf.d/redamancy' }}',
                  backend_port: '${{ github.event.client_payload.backend_port || '8080' }}',
                  service_name: '${{ github.event.client_payload.service_name || 'star-cloud' }}',
                  server_host: '${{ github.event.client_payload.server_host }}',
                  server_user: '${{ github.event.client_payload.server_user }}',
                  server_key: '${{ github.event.client_payload.server_key }}',
                  server_port: '${{ github.event.client_payload.server_port }}'
                }
              });
              
              console.log('âœ… ä¸»éƒ¨ç½²å·¥ä½œæµå·²æˆåŠŸè§¦å‘!');
              
            } catch (error) {
              console.error('âŒ è§¦å‘ä¸»éƒ¨ç½²å·¥ä½œæµå¤±è´¥:', error.message);
              throw error;
            } 