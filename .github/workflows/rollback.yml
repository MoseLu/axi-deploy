name: Rollback

description: "å›æ»šå·¥ä½œæµ - å¿«é€Ÿå›æ»šåˆ°ä¹‹å‰çš„éƒ¨ç½²ç‰ˆæœ¬"

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'é¡¹ç›®åç§°'
        required: true
        type: string
      deploy_type:
        description: 'éƒ¨ç½²ç±»å‹'
        required: true
        default: 'static'
        type: choice
        options:
          - static
          - backend
      backup_version:
        description: 'å›æ»šç‰ˆæœ¬ (æ ¼å¼: YYYYMMDD_HHMMSS æˆ– latest)'
        required: false
        default: 'latest'
        type: string
      server_host:
        description: 'æœåŠ¡å™¨åœ°å€'
        required: false
        type: string
      server_user:
        description: 'æœåŠ¡å™¨ç”¨æˆ·'
        required: false
        type: string
      server_key:
        description: 'æœåŠ¡å™¨å¯†é’¥'
        required: false
        type: string
      server_port:
        description: 'æœåŠ¡å™¨ç«¯å£'
        required: false
        default: '22'
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
      - name: è§£ææœåŠ¡å™¨é…ç½®
        id: parse-config
        run: |
          echo "ğŸ” è§£ææœåŠ¡å™¨é…ç½®..."
          
          # ä»è¾“å…¥å‚æ•°æˆ–ç¯å¢ƒå˜é‡è·å–é…ç½®
          SERVER_HOST="${{ inputs.server_host || secrets.SERVER_HOST }}"
          SERVER_USER="${{ inputs.server_user || secrets.SERVER_USER }}"
          SERVER_KEY="${{ inputs.server_key || secrets.SERVER_KEY }}"
          SERVER_PORT="${{ inputs.server_port || secrets.SERVER_PORT || '22' }}"
          
          if [ -z "$SERVER_HOST" ] || [ -z "$SERVER_USER" ] || [ -z "$SERVER_KEY" ]; then
            echo "ğŸš¨ ç¼ºå°‘æœåŠ¡å™¨é…ç½®ä¿¡æ¯"
            exit 1
          fi
          
          echo "âœ… æœåŠ¡å™¨é…ç½®è§£æå®Œæˆ"

      - name: æ£€æŸ¥å¯ç”¨å¤‡ä»½
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.parse-config.outputs.server_host || env.SERVER_HOST }}
          username: ${{ steps.parse-config.outputs.server_user || env.SERVER_USER }}
          key: ${{ steps.parse-config.outputs.server_key || env.SERVER_KEY }}
          port: ${{ steps.parse-config.outputs.server_port || env.SERVER_PORT }}
          script: |
            echo "ğŸ” æ£€æŸ¥å¯ç”¨å¤‡ä»½..."
            
            PROJECT="${{ inputs.project }}"
            DEPLOY_TYPE="${{ inputs.deploy_type }}"
            
            # ç¡®å®šå¤‡ä»½ç›®å½•
            if [[ "$DEPLOY_TYPE" == "backend" ]]; then
              BACKUP_ROOT="/srv/backups/apps"
            else
              BACKUP_ROOT="/srv/backups/static"
            fi
            PROJECT_BACKUP_DIR="$BACKUP_ROOT/$PROJECT"
            
            echo "ğŸ“ å¤‡ä»½ç›®å½•: $PROJECT_BACKUP_DIR"
            
            if [ ! -d "$PROJECT_BACKUP_DIR" ]; then
              echo "âŒ å¤‡ä»½ç›®å½•ä¸å­˜åœ¨: $PROJECT_BACKUP_DIR"
              exit 1
            fi
            
            # åˆ—å‡ºå¯ç”¨å¤‡ä»½
            echo "ğŸ“‹ å¯ç”¨å¤‡ä»½åˆ—è¡¨:"
            if [ -d "$PROJECT_BACKUP_DIR" ]; then
              BACKUP_LIST=$(ls -t "$PROJECT_BACKUP_DIR"/$PROJECT.backup.* 2>/dev/null | head -10)
              if [ -n "$BACKUP_LIST" ]; then
                echo "$BACKUP_LIST" | while read -r backup; do
                  BACKUP_NAME=$(basename "$backup")
                  BACKUP_TIME=$(stat -c %y "$backup" | cut -d' ' -f1,2)
                  BACKUP_SIZE=$(du -sh "$backup" | cut -f1)
                  echo "  ğŸ“¦ $BACKUP_NAME ($BACKUP_TIME, $BACKUP_SIZE)"
                done
              else
                echo "  âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¤‡ä»½æ–‡ä»¶"
                exit 1
              fi
            else
              echo "  âŒ å¤‡ä»½ç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi

      - name: æ‰§è¡Œå›æ»š
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.parse-config.outputs.server_host || env.SERVER_HOST }}
          username: ${{ steps.parse-config.outputs.server_user || env.SERVER_USER }}
          key: ${{ steps.parse-config.outputs.server_key || env.SERVER_KEY }}
          port: ${{ steps.parse-config.outputs.server_port || env.SERVER_PORT }}
          script: |
            echo "ğŸ”„ æ‰§è¡Œå›æ»š..."
            
            PROJECT="${{ inputs.project }}"
            DEPLOY_TYPE="${{ inputs.deploy_type }}"
            BACKUP_VERSION="${{ inputs.backup_version }}"
            
            # ç¡®å®šè·¯å¾„
            if [[ "$DEPLOY_TYPE" == "backend" ]]; then
              DEPLOY_PATH="/srv/apps/$PROJECT"
              BACKUP_ROOT="/srv/backups/apps"
            else
              DEPLOY_PATH="/srv/static/$PROJECT"
              BACKUP_ROOT="/srv/backups/static"
            fi
            PROJECT_BACKUP_DIR="$BACKUP_ROOT/$PROJECT"
            
            echo "ğŸ“ éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"
            echo "ğŸ“ å¤‡ä»½ç›®å½•: $PROJECT_BACKUP_DIR"
            echo "ğŸ”„ å›æ»šç‰ˆæœ¬: $BACKUP_VERSION"
            
            # ç¡®å®šè¦å›æ»šçš„å¤‡ä»½
            if [ "$BACKUP_VERSION" = "latest" ]; then
              # è·å–æœ€æ–°çš„å¤‡ä»½
              LATEST_BACKUP=$(ls -t "$PROJECT_BACKUP_DIR"/$PROJECT.backup.* 2>/dev/null | head -1)
              if [ -z "$LATEST_BACKUP" ]; then
                echo "âŒ æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„å¤‡ä»½"
                exit 1
              fi
              TARGET_BACKUP="$LATEST_BACKUP"
            else
              # æŸ¥æ‰¾æŒ‡å®šç‰ˆæœ¬çš„å¤‡ä»½
              TARGET_BACKUP="$PROJECT_BACKUP_DIR/$PROJECT.backup.$BACKUP_VERSION"
              if [ ! -d "$TARGET_BACKUP" ]; then
                echo "âŒ æŒ‡å®šçš„å¤‡ä»½ç‰ˆæœ¬ä¸å­˜åœ¨: $TARGET_BACKUP"
                echo "ğŸ“‹ å¯ç”¨å¤‡ä»½:"
                ls -la "$PROJECT_BACKUP_DIR"/$PROJECT.backup.* 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°å¤‡ä»½"
                exit 1
              fi
            fi
            
            echo "ğŸ¯ ç›®æ ‡å¤‡ä»½: $TARGET_BACKUP"
            
            # éªŒè¯å¤‡ä»½å†…å®¹
            if [ ! -d "$TARGET_BACKUP" ]; then
              echo "âŒ å¤‡ä»½ç›®å½•ä¸å­˜åœ¨: $TARGET_BACKUP"
              exit 1
            fi
            
            BACKUP_FILE_COUNT=$(find "$TARGET_BACKUP" -type f | wc -l)
            if [ "$BACKUP_FILE_COUNT" -eq 0 ]; then
              echo "âŒ å¤‡ä»½ç›®å½•ä¸ºç©º: $TARGET_BACKUP"
              exit 1
            fi
            
            echo "âœ… å¤‡ä»½éªŒè¯é€šè¿‡ï¼ŒåŒ…å« $BACKUP_FILE_COUNT ä¸ªæ–‡ä»¶"
            
            # åˆ›å»ºå½“å‰éƒ¨ç½²çš„å¤‡ä»½ï¼ˆä»¥é˜²å›æ»šå¤±è´¥ï¼‰
            echo "ğŸ“‹ å¤‡ä»½å½“å‰éƒ¨ç½²..."
            CURRENT_BACKUP="$PROJECT_BACKUP_DIR/$PROJECT.backup.$(date +%Y%m%d_%H%M%S).pre_rollback"
            if [ -d "$DEPLOY_PATH" ]; then
              sudo cp -r "$DEPLOY_PATH" "$CURRENT_BACKUP"
              echo "âœ… å½“å‰éƒ¨ç½²å·²å¤‡ä»½åˆ°: $CURRENT_BACKUP"
            else
              echo "âš ï¸ å½“å‰éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤‡ä»½"
            fi
            
            # åœæ­¢ç›¸å…³æœåŠ¡ï¼ˆå¦‚æœæ˜¯åç«¯é¡¹ç›®ï¼‰
            if [[ "$DEPLOY_TYPE" == "backend" ]]; then
              echo "ğŸ›‘ åœæ­¢åç«¯æœåŠ¡..."
              if systemctl is-active --quiet star-cloud.service; then
                sudo systemctl stop star-cloud.service
                echo "âœ… åç«¯æœåŠ¡å·²åœæ­¢"
              else
                echo "âš ï¸ åç«¯æœåŠ¡æœªè¿è¡Œ"
              fi
            fi
            
            # åˆ é™¤å½“å‰éƒ¨ç½²
            echo "ğŸ—‘ï¸ åˆ é™¤å½“å‰éƒ¨ç½²..."
            if [ -d "$DEPLOY_PATH" ]; then
              sudo rm -rf "$DEPLOY_PATH"
              echo "âœ… å½“å‰éƒ¨ç½²å·²åˆ é™¤"
            else
              echo "âš ï¸ å½“å‰éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨"
            fi
            
            # æ¢å¤å¤‡ä»½
            echo "ğŸ”„ æ¢å¤å¤‡ä»½..."
            sudo cp -r "$TARGET_BACKUP" "$DEPLOY_PATH"
            sudo chown -R deploy:deploy "$DEPLOY_PATH"
            echo "âœ… å¤‡ä»½å·²æ¢å¤åˆ°: $DEPLOY_PATH"
            
            # éªŒè¯æ¢å¤ç»“æœ
            echo "ğŸ” éªŒè¯æ¢å¤ç»“æœ..."
            if [ -d "$DEPLOY_PATH" ]; then
              RESTORED_FILE_COUNT=$(find "$DEPLOY_PATH" -type f | wc -l)
              echo "âœ… æ¢å¤å®Œæˆï¼ŒåŒ…å« $RESTORED_FILE_COUNT ä¸ªæ–‡ä»¶"
              
              # æ˜¾ç¤ºæ¢å¤çš„æ–‡ä»¶
              echo "ğŸ“ æ¢å¤çš„æ–‡ä»¶:"
              ls -la "$DEPLOY_PATH/" | head -10
            else
              echo "âŒ æ¢å¤å¤±è´¥ï¼Œéƒ¨ç½²ç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
            
            # é‡å¯ç›¸å…³æœåŠ¡ï¼ˆå¦‚æœæ˜¯åç«¯é¡¹ç›®ï¼‰
            if [[ "$DEPLOY_TYPE" == "backend" ]]; then
              echo "ğŸš€ é‡å¯åç«¯æœåŠ¡..."
              sudo systemctl daemon-reload
              sudo systemctl start star-cloud.service
              
              # ç­‰å¾…æœåŠ¡å¯åŠ¨
              sleep 5
              
              # æ£€æŸ¥æœåŠ¡çŠ¶æ€
              if systemctl is-active --quiet star-cloud.service; then
                echo "âœ… åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ"
              else
                echo "âŒ åç«¯æœåŠ¡å¯åŠ¨å¤±è´¥"
                systemctl status star-cloud.service --no-pager -l
              fi
            fi
            
            echo "âœ… å›æ»šå®Œæˆï¼"

      - name: éªŒè¯å›æ»šç»“æœ
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.parse-config.outputs.server_host || env.SERVER_HOST }}
          username: ${{ steps.parse-config.outputs.server_user || env.SERVER_USER }}
          key: ${{ steps.parse-config.outputs.server_key || env.SERVER_KEY }}
          port: ${{ steps.parse-config.outputs.server_port || env.SERVER_PORT }}
          script: |
            echo "ğŸ” éªŒè¯å›æ»šç»“æœ..."
            
            PROJECT="${{ inputs.project }}"
            DEPLOY_TYPE="${{ inputs.deploy_type }}"
            
            # ç¡®å®šè·¯å¾„
            if [[ "$DEPLOY_TYPE" == "backend" ]]; then
              DEPLOY_PATH="/srv/apps/$PROJECT"
            else
              DEPLOY_PATH="/srv/static/$PROJECT"
            fi
            
            echo "ğŸ“ éªŒè¯éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"
            
            # æ£€æŸ¥éƒ¨ç½²ç›®å½•
            if [ -d "$DEPLOY_PATH" ]; then
              FILE_COUNT=$(find "$DEPLOY_PATH" -type f | wc -l)
              echo "âœ… éƒ¨ç½²ç›®å½•å­˜åœ¨ï¼ŒåŒ…å« $FILE_COUNT ä¸ªæ–‡ä»¶"
              
              # æ£€æŸ¥å…³é”®æ–‡ä»¶
              if [ -f "$DEPLOY_PATH/index.html" ]; then
                echo "âœ… index.html æ–‡ä»¶å­˜åœ¨"
              else
                echo "âš ï¸ index.html æ–‡ä»¶ä¸å­˜åœ¨"
              fi
            else
              echo "âŒ éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼ˆå¦‚æœæ˜¯åç«¯é¡¹ç›®ï¼‰
            if [[ "$DEPLOY_TYPE" == "backend" ]]; then
              if systemctl is-active --quiet star-cloud.service; then
                echo "âœ… åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ"
              else
                echo "âŒ åç«¯æœåŠ¡å¼‚å¸¸"
                systemctl status star-cloud.service --no-pager -l
              fi
            fi
            
            echo "âœ… å›æ»šéªŒè¯å®Œæˆ"

  notify-rollback:
    needs: rollback
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: å›æ»šé€šçŸ¥
        run: |
          echo "ğŸ“¢ å›æ»šé€šçŸ¥"
          echo "============"
          echo "å›æ»šæ—¶é—´: $(date)"
          echo "é¡¹ç›®åç§°: ${{ inputs.project }}"
          echo "éƒ¨ç½²ç±»å‹: ${{ inputs.deploy_type }}"
          echo "å›æ»šç‰ˆæœ¬: ${{ inputs.backup_version }}"
          
          if [ "${{ needs.rollback.result }}" = "success" ]; then
            echo "âœ… å›æ»šæˆåŠŸ"
          else
            echo "âŒ å›æ»šå¤±è´¥"
          fi
