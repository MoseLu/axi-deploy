name: Test Nginx Retry Mechanism

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æµ‹è¯•ç±»å‹'
        required: true
        default: 'success'
        type: choice
        options:
          - success
          - timeout
          - connection_error

jobs:
  test-nginx-retry:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: æµ‹è¯•Nginxé…ç½®é‡è¯•æœºåˆ¶
        uses: ./.github/workflows/retry-center.yml
        with:
          step_name: "æµ‹è¯•Nginxé…ç½®"
          command: |
            echo "ğŸ§ª æµ‹è¯•Nginxé…ç½®é‡è¯•æœºåˆ¶..."
            echo "æµ‹è¯•ç±»å‹: ${{ github.event.inputs.test_type }}"
            
            # æ¨¡æ‹Ÿä¸åŒçš„æµ‹è¯•åœºæ™¯
            if [ "${{ github.event.inputs.test_type }}" = "timeout" ]; then
              echo "â° æ¨¡æ‹Ÿè¶…æ—¶åœºæ™¯..."
              sleep 30  # æ¨¡æ‹Ÿé•¿æ—¶é—´æ“ä½œ
              echo "âœ… è¶…æ—¶æµ‹è¯•å®Œæˆ"
            elif [ "${{ github.event.inputs.test_type }}" = "connection_error" ]; then
              echo "ğŸ”Œ æ¨¡æ‹Ÿè¿æ¥é”™è¯¯..."
              # å°è¯•è¿æ¥ä¸€ä¸ªä¸å­˜åœ¨çš„æœåŠ¡å™¨
              ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no user@invalid-host.com "echo test" || true
              echo "âŒ è¿æ¥é”™è¯¯æµ‹è¯•å®Œæˆ"
            else
              echo "âœ… æ¨¡æ‹ŸæˆåŠŸåœºæ™¯..."
              echo "Nginxé…ç½®æµ‹è¯•æˆåŠŸ"
            fi
          max_retries: 3
          retry_delay: 5
          timeout_minutes: 10
          retry_strategy: "exponential"
          continue_on_error: true
          notify_on_failure: false
          step_type: "network"
          
      - name: æ˜¾ç¤ºæµ‹è¯•ç»“æœ
        run: |
          echo "ğŸ§ª Nginxé‡è¯•æœºåˆ¶æµ‹è¯•å®Œæˆ"
          echo "æµ‹è¯•ç±»å‹: ${{ github.event.inputs.test_type }}"
          echo "æˆåŠŸçŠ¶æ€: ${{ needs.test-nginx-retry.outputs.success }}"
          echo "é‡è¯•æ¬¡æ•°: ${{ needs.test-nginx-retry.outputs.attempts }}"
          echo "æ‰§è¡Œæ—¶é—´: ${{ needs.test-nginx-retry.outputs.execution_time }}ç§’"
          if [ "${{ needs.test-nginx-retry.outputs.success }}" = "false" ]; then
            echo "é”™è¯¯ä¿¡æ¯: ${{ needs.test-nginx-retry.outputs.error_message }}"
          fi
