name: Diagnose 502 Error

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'é¡¹ç›®åç§°'
        required: true
        default: 'axi-project-dashboard'
      server_host:
        description: 'æœåŠ¡å™¨åœ°å€'
        required: true
        default: 'redamancy.com.cn'
      server_user:
        description: 'æœåŠ¡å™¨ç”¨æˆ·'
        required: true
        default: 'deploy'
      server_key:
        description: 'SSHç§é’¥'
        required: true
      server_port:
        description: 'SSHç«¯å£'
        required: true
        default: '22'

jobs:
  diagnose:
    runs-on: ubuntu-latest
    steps:
      - name: è¯Šæ–­502é”™è¯¯
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ğŸ” å¼€å§‹è¯Šæ–­502é”™è¯¯..."
            echo "é¡¹ç›®: ${{ inputs.project }}"
            echo "æ—¶é—´: $(date)"
            echo "=========================================="
            
            # 1. æ£€æŸ¥ç³»ç»ŸåŸºæœ¬ä¿¡æ¯
            echo "ğŸ“‹ ç³»ç»ŸåŸºæœ¬ä¿¡æ¯:"
            echo "- ä¸»æœºå: $(hostname)"
            echo "- ç³»ç»Ÿç‰ˆæœ¬: $(cat /etc/os-release | grep PRETTY_NAME)"
            echo "- å†…æ ¸ç‰ˆæœ¬: $(uname -r)"
            echo "- å½“å‰ç”¨æˆ·: $(whoami)"
            echo "- å½“å‰ç›®å½•: $(pwd)"
            echo ""
            
            # 2. æ£€æŸ¥ç½‘ç»œè¿æ¥
            echo "ğŸŒ ç½‘ç»œè¿æ¥æ£€æŸ¥:"
            echo "- æœ¬åœ°å›ç¯: $(ping -c 1 127.0.0.1 >/dev/null 2>&1 && echo 'âœ…' || echo 'âŒ')"
            echo "- å¤–ç½‘è¿æ¥: $(ping -c 1 8.8.8.8 >/dev/null 2>&1 && echo 'âœ…' || echo 'âŒ')"
            echo "- åŸŸåè§£æ: $(nslookup redamancy.com.cn >/dev/null 2>&1 && echo 'âœ…' || echo 'âŒ')"
            echo ""
            
            # 3. æ£€æŸ¥ç«¯å£å ç”¨
            echo "ğŸ”Œ ç«¯å£å ç”¨æ£€æŸ¥:"
            echo "- ç«¯å£80: $(netstat -tlnp | grep :80 | head -1 || echo 'æœªå ç”¨')"
            echo "- ç«¯å£443: $(netstat -tlnp | grep :443 | head -1 || echo 'æœªå ç”¨')"
            echo "- ç«¯å£8090: $(netstat -tlnp | grep :8090 | head -1 || echo 'æœªå ç”¨')"
            echo "- ç«¯å£8080: $(netstat -tlnp | grep :8080 | head -1 || echo 'æœªå ç”¨')"
            echo ""
            
            # 4. æ£€æŸ¥NginxçŠ¶æ€
            echo "ğŸŒ NginxçŠ¶æ€æ£€æŸ¥:"
            echo "- Nginxè¿›ç¨‹: $(pgrep nginx | wc -l) ä¸ªè¿›ç¨‹"
            echo "- NginxæœåŠ¡çŠ¶æ€:"
            systemctl status nginx --no-pager -l || echo "æ— æ³•è·å–NginxçŠ¶æ€"
            echo ""
            
            # 5. æ£€æŸ¥Nginxé…ç½®
            echo "ğŸ“ Nginxé…ç½®æ£€æŸ¥:"
            echo "- é…ç½®è¯­æ³•: $(nginx -t 2>&1 | tail -1)"
            echo "- ä¸»é…ç½®æ–‡ä»¶: /etc/nginx/nginx.conf"
            echo "- ç«™ç‚¹é…ç½®ç›®å½•: /www/server/nginx/conf/conf.d/redamancy/"
            echo ""
            
            # 6. æ£€æŸ¥é¡¹ç›®é…ç½®
            echo "ğŸ“ é¡¹ç›®é…ç½®æ£€æŸ¥:"
            PROJECT="${{ inputs.project }}"
            NGINX_CONF_DIR="/www/server/nginx/conf/conf.d/redamancy"
            ROUTE_CONF="$NGINX_CONF_DIR/route-$PROJECT.conf"
            
            echo "- é¡¹ç›®é…ç½®ç›®å½•: $NGINX_CONF_DIR"
            echo "- é¡¹ç›®é…ç½®æ–‡ä»¶: $ROUTE_CONF"
            
            if [ -f "$ROUTE_CONF" ]; then
              echo "âœ… é¡¹ç›®é…ç½®æ–‡ä»¶å­˜åœ¨"
              echo "é…ç½®æ–‡ä»¶å†…å®¹:"
              cat "$ROUTE_CONF"
            else
              echo "âŒ é¡¹ç›®é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
            fi
            echo ""
            
            # 7. æ£€æŸ¥é¡¹ç›®éƒ¨ç½²
            echo "ğŸ“¦ é¡¹ç›®éƒ¨ç½²æ£€æŸ¥:"
            APPS_ROOT="/srv/apps"
            PROJECT_DIR="$APPS_ROOT/$PROJECT"
            
            echo "- åº”ç”¨æ ¹ç›®å½•: $APPS_ROOT"
            echo "- é¡¹ç›®ç›®å½•: $PROJECT_DIR"
            
            if [ -d "$PROJECT_DIR" ]; then
              echo "âœ… é¡¹ç›®ç›®å½•å­˜åœ¨"
              echo "- ç›®å½•å†…å®¹:"
              ls -la "$PROJECT_DIR" | head -10
              echo "- æ–‡ä»¶æ•°é‡: $(find "$PROJECT_DIR" -type f | wc -l)"
            else
              echo "âŒ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨"
            fi
            echo ""
            
            # 8. æ£€æŸ¥åç«¯æœåŠ¡
            echo "ğŸš€ åç«¯æœåŠ¡æ£€æŸ¥:"
            echo "- PM2è¿›ç¨‹:"
            pm2 list 2>/dev/null || echo "PM2æœªå®‰è£…æˆ–æœªè¿è¡Œ"
            
            echo "- ç³»ç»Ÿè¿›ç¨‹:"
            pgrep -f "$PROJECT" || echo "æœªæ‰¾åˆ°ç›¸å…³è¿›ç¨‹"
            
            echo "- ç«¯å£8090è¿›ç¨‹:"
            netstat -tlnp | grep :8090 || echo "ç«¯å£8090æœªè¢«å ç”¨"
            echo ""
            
            # 9. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶
            echo "ğŸ“‹ æ—¥å¿—æ–‡ä»¶æ£€æŸ¥:"
            echo "- Nginxè®¿é—®æ—¥å¿—:"
            tail -n 5 /var/log/nginx/access.log 2>/dev/null || echo "æ— æ³•è¯»å–è®¿é—®æ—¥å¿—"
            
            echo "- Nginxé”™è¯¯æ—¥å¿—:"
            tail -n 10 /var/log/nginx/error.log 2>/dev/null || echo "æ— æ³•è¯»å–é”™è¯¯æ—¥å¿—"
            
            echo "- ç³»ç»Ÿæ—¥å¿—:"
            journalctl -u nginx --no-pager -n 10 2>/dev/null || echo "æ— æ³•è¯»å–ç³»ç»Ÿæ—¥å¿—"
            echo ""
            
            # 10. æµ‹è¯•æœ¬åœ°è¿æ¥
            echo "ğŸ” æœ¬åœ°è¿æ¥æµ‹è¯•:"
            echo "- æµ‹è¯•æœ¬åœ°8090ç«¯å£:"
            curl -f -s http://localhost:8090/health >/dev/null 2>&1 && echo "âœ… æœ¬åœ°8090ç«¯å£å“åº”æ­£å¸¸" || echo "âŒ æœ¬åœ°8090ç«¯å£æ— å“åº”"
            
            echo "- æµ‹è¯•æœ¬åœ°8080ç«¯å£:"
            curl -f -s http://localhost:8080/health >/dev/null 2>&1 && echo "âœ… æœ¬åœ°8080ç«¯å£å“åº”æ­£å¸¸" || echo "âŒ æœ¬åœ°8080ç«¯å£æ— å“åº”"
            echo ""
            
            # 11. æ£€æŸ¥é˜²ç«å¢™
            echo "ğŸ”¥ é˜²ç«å¢™æ£€æŸ¥:"
            echo "- é˜²ç«å¢™çŠ¶æ€:"
            systemctl status firewalld --no-pager -l 2>/dev/null || echo "firewalldæœªè¿è¡Œ"
            
            echo "- iptablesè§„åˆ™:"
            iptables -L -n | grep -E "(80|443|8090)" || echo "æœªæ‰¾åˆ°ç›¸å…³é˜²ç«å¢™è§„åˆ™"
            echo ""
            
            # 12. æ£€æŸ¥SSLè¯ä¹¦
            echo "ğŸ”’ SSLè¯ä¹¦æ£€æŸ¥:"
            echo "- æ£€æŸ¥SSLè¯ä¹¦:"
            openssl s_client -connect redamancy.com.cn:443 -servername redamancy.com.cn < /dev/null 2>/dev/null | openssl x509 -noout -dates || echo "æ— æ³•æ£€æŸ¥SSLè¯ä¹¦"
            echo ""
            
            # 13. æµ‹è¯•ç½‘ç«™è®¿é—®
            echo "ğŸŒ ç½‘ç«™è®¿é—®æµ‹è¯•:"
            echo "- æµ‹è¯•HTTPè®¿é—®:"
            curl -I http://redamancy.com.cn/project-dashboard/api/health --connect-timeout 10 --max-time 30 2>/dev/null || echo "HTTPè®¿é—®å¤±è´¥"
            
            echo "- æµ‹è¯•HTTPSè®¿é—®:"
            curl -I https://redamancy.com.cn/project-dashboard/api/health --connect-timeout 10 --max-time 30 2>/dev/null || echo "HTTPSè®¿é—®å¤±è´¥"
            echo ""
            
            echo "=========================================="
            echo "ğŸ” è¯Šæ–­å®Œæˆ"
            echo "æ—¶é—´: $(date)"
