name: External Deploy Workflow

on:
  repository_dispatch:
    types: [deploy]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: dawidd6/action-download-artifact@v2
        with:
          name: dist-${{ inputs.project }}
          path: ./dist
          repo: ${{ inputs.source_repo }}
          workflow: build
          run_id: ${{ inputs.run_id }}
          github_token: ${{ secrets.DEPLOY_CENTER_PAT }}

      - name: æ˜¾ç¤ºæ„å»ºäº§ç‰©ä¿¡æ¯
        run: |
          echo "ğŸ“¦ æ„å»ºäº§ç‰©ä¿¡æ¯:"
          ls -la ./dist/
          echo "ğŸ“‹ éƒ¨ç½²å‚æ•°:"
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- éƒ¨ç½²è·¯å¾„: ${{ inputs.deploy_path }}"
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- æ„å»ºID: ${{ inputs.run_id }}"

      - name: ä¸Šä¼ åˆ°æœåŠ¡å™¨
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: "./dist/*"
          target: "/tmp/"
          strip_components: 0
          command_timeout: "10m"

      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²é¡¹ç›®: ${{ inputs.project }}"
            
            # æ ‡å‡†åŒ–ç›®å½•ç»“æ„
            APPS_ROOT="/srv/apps"
            STATIC_ROOT="/srv/static"
            NGINX_CONF_DIR="/www/server/nginx/conf/conf.d/redamancy"
            
            # æ ¹æ®é¡¹ç›®ç±»å‹ç¡®å®šéƒ¨ç½²è·¯å¾„
            if [[ "${{ inputs.project }}" == "axi-star-cloud" ]]; then
              # Goé¡¹ç›®éƒ¨ç½²åˆ°åº”ç”¨ç›®å½•
              DEPLOY_PATH="$APPS_ROOT/${{ inputs.project }}"
              echo "ğŸ“ Goé¡¹ç›®éƒ¨ç½²åˆ°: $DEPLOY_PATH"
            else
              # é™æ€é¡¹ç›®éƒ¨ç½²åˆ°é™æ€æ–‡ä»¶ç›®å½•
              DEPLOY_PATH="$STATIC_ROOT/${{ inputs.project }}"
              echo "ğŸ“ é™æ€é¡¹ç›®éƒ¨ç½²åˆ°: $DEPLOY_PATH"
            fi
            
            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            sudo mkdir -p $DEPLOY_PATH
            sudo chown deploy:deploy $DEPLOY_PATH
            
            # è§£å‹å¹¶éƒ¨ç½²æ–‡ä»¶
            echo "ğŸ“¦ è§£å‹éƒ¨ç½²æ–‡ä»¶..."
            cd /tmp
            if [ -f "deployment.tar.gz" ]; then
              # Goé¡¹ç›®éƒ¨ç½²
              echo "ğŸ”§ éƒ¨ç½²Goé¡¹ç›®..."
              sudo tar xzf deployment.tar.gz -C $DEPLOY_PATH
              sudo chown -R deploy:deploy $DEPLOY_PATH
              
              # è®¾ç½®å¯æ‰§è¡Œæƒé™
              if [ -f "$DEPLOY_PATH/backend/star-cloud-linux" ]; then
                sudo chmod +x $DEPLOY_PATH/backend/star-cloud-linux
              fi
              
              # åˆ›å»ºå¿…è¦ç›®å½•
              sudo mkdir -p $DEPLOY_PATH/uploads/{image,document,audio,video,other,avatars}
              sudo mkdir -p $DEPLOY_PATH/logs
              sudo chown -R deploy:deploy $DEPLOY_PATH/uploads $DEPLOY_PATH/logs
              
              # é‡å¯æœåŠ¡
              echo "ğŸ”„ é‡å¯å®å¡”é¢æ¿ç½‘ç«™..."
              bt restart
              
              # ç­‰å¾…æœåŠ¡å¯åŠ¨
              echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
              sleep 5
              
              # å¥åº·æ£€æŸ¥
              echo "ğŸ” æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
              if curl -f -s http://127.0.0.1:8080/health > /dev/null 2>&1; then
                echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ - å¥åº·æ£€æŸ¥é€šè¿‡"
              else
                echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥ - å¥åº·æ£€æŸ¥å¤±è´¥"
                echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
                bt status
                exit 1
              fi
            else
              # é™æ€é¡¹ç›®éƒ¨ç½²
              echo "ğŸ“ éƒ¨ç½²é™æ€é¡¹ç›®..."
              sudo cp -r * $DEPLOY_PATH/
              sudo chown -R deploy:deploy $DEPLOY_PATH
              echo "âœ… é™æ€é¡¹ç›®éƒ¨ç½²å®Œæˆ"
            fi
            
            echo "âœ… é¡¹ç›®éƒ¨ç½²å®Œæˆ: ${{ inputs.project }}"

      - name: é…ç½®Nginxï¼ˆå¦‚æœæä¾›é…ç½®ï¼‰
        if: inputs.nginx_config != ''
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸ”§ é…ç½®Nginx..."
            
            NGINX_CONF_DIR="/www/server/nginx/conf/conf.d/redamancy"
            PROJECT="${{ inputs.project }}"
            
            # ç”Ÿæˆé¡¹ç›®è·¯ç”±é…ç½®
            ROUTE_CONF="$NGINX_CONF_DIR/route-$PROJECT.conf"
            
            # å†™å…¥é¡¹ç›®é…ç½®
            sudo tee $ROUTE_CONF <<'EOF'
            ${{ inputs.nginx_config }}
            EOF
            
            echo "âœ… Nginxé…ç½®å·²å†™å…¥: $ROUTE_CONF"
            
            # æ£€æŸ¥Nginxé…ç½®è¯­æ³•
            if sudo nginx -t; then
              echo "âœ… Nginxé…ç½®è¯­æ³•æ£€æŸ¥é€šè¿‡"
            else
              echo "âŒ Nginxé…ç½®è¯­æ³•é”™è¯¯"
              exit 1
            fi
            
            # é‡è½½Nginxé…ç½®
            if sudo systemctl reload nginx; then
              echo "âœ… Nginxé…ç½®é‡è½½å®Œæˆ"
            else
              echo "âŒ Nginxé‡è½½å¤±è´¥"
              exit 1
            fi

      - name: æµ‹è¯•ç½‘ç«™å¯è®¿é—®æ€§
        if: inputs.test_url != ''
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸŒ æµ‹è¯•ç½‘ç«™å¯è®¿é—®æ€§..."
            æµ‹è¯•URL: ${{ inputs.test_url }}
            
            # ç­‰å¾…ä¸€æ®µæ—¶é—´è®©æœåŠ¡å®Œå…¨å¯åŠ¨
            sleep 10
            
            # æµ‹è¯•ç½‘ç«™è®¿é—®
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ inputs.test_url }})
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… ç½‘ç«™å¯è®¿é—® (HTTP $HTTP_STATUS)"
            elif [ "$HTTP_STATUS" = "404" ]; then
              echo "âš ï¸  ç½‘ç«™è¿”å›404 (å¯èƒ½å°šæœªéƒ¨ç½²é¡¹ç›®)"
            else
              echo "âŒ ç½‘ç«™æ— æ³•è®¿é—® (HTTP $HTTP_STATUS)"
              echo "å¯èƒ½çš„åŸå› :"
              echo "1. åŸŸåè§£æé—®é¢˜"
              echo "2. æœåŠ¡å™¨é˜²ç«å¢™è®¾ç½®"
              echo "3. Nginxé…ç½®é—®é¢˜"
              echo "4. SSLè¯ä¹¦é—®é¢˜"
              
              # æ˜¾ç¤ºç½‘ç«™æ ‡é¢˜
              TITLE=$(curl -s ${{ inputs.test_url }} | grep -o '<title>[^<]*</title>' | sed 's/<title>\(.*\)<\/title>/\1/')
              echo "ç½‘ç«™æ ‡é¢˜: $TITLE"
            fi

      - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
        run: |
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          echo ""
          echo "ğŸ“‹ éƒ¨ç½²æ‘˜è¦:"
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- éƒ¨ç½²è·¯å¾„: ${{ inputs.deploy_path }}"
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- æ„å»ºID: ${{ inputs.run_id }}"
          if [ "${{ inputs.test_url }}" != "" ]; then
            echo "- æµ‹è¯•URL: ${{ inputs.test_url }}"
          fi
          echo ""
          echo "âœ… é¡¹ç›®å·²æˆåŠŸéƒ¨ç½²åˆ°æœåŠ¡å™¨"