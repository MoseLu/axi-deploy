name: External Deploy Handler

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'é¡¹ç›®åç§°'
        required: true
        type: string
      lang:
        description: 'é¡¹ç›®è¯­è¨€'
        required: true
        type: string
        default: 'static'
      artifact_id:
        description: 'æ„å»ºäº§ç‰©ID'
        required: true
        type: string
      deploy_path:
        description: 'éƒ¨ç½²è·¯å¾„'
        required: true
        type: string
      start_cmd:
        description: 'å¯åŠ¨å‘½ä»¤'
        required: false
        type: string
        default: ''
      caller_info:
        description: 'è°ƒç”¨è€…ä¿¡æ¯ (æ ¼å¼: repo/branch/commit)'
        required: true
        type: string
      server_config:
        description: 'æœåŠ¡å™¨é…ç½® (æ ¼å¼: host/port/user/key)'
        required: true
        type: string

permissions:
  contents: read
  actions: read
  id-token: write
  packages: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: è§£æå‚æ•°
        id: parse
        run: |
          # è§£æè°ƒç”¨è€…ä¿¡æ¯
          echo "åŸå§‹caller_info: ${{ github.event.inputs.caller_info }}"
          
          # ä½¿ç”¨æ›´ç²¾ç¡®çš„åˆ†å‰²æ–¹æ³•
          caller_info="${{ github.event.inputs.caller_info }}"
          IFS='/' read -r owner repo branch commit <<< "$caller_info"
          
          # é‡æ–°ç»„åˆcaller_repo
          caller_repo="$owner/$repo"
          
          echo "è§£æç»“æœ:"
          echo "  owner: '$owner'"
          echo "  repo: '$repo'"
          echo "  caller_repo: '$caller_repo'"
          echo "  caller_branch: '$branch'"
          echo "  caller_commit: '$commit'"
          
          # éªŒè¯è§£æç»“æœ
          if [ -z "$owner" ] || [ -z "$repo" ] || [ -z "$branch" ] || [ -z "$commit" ]; then
            echo "âŒ å‚æ•°è§£æå¤±è´¥"
            echo "caller_info æ ¼å¼åº”è¯¥æ˜¯: owner/repo/branch/commit"
            echo "ä¾‹å¦‚: MoseLu/axi-docs/main/117fb57"
            exit 1
          fi
          
          echo "caller_repo=$caller_repo" >> $GITHUB_OUTPUT
          echo "caller_branch=$branch" >> $GITHUB_OUTPUT
          echo "caller_commit=$commit" >> $GITHUB_OUTPUT
          
          # è§£ææœåŠ¡å™¨é…ç½®
          echo "åŸå§‹server_config: ${{ github.event.inputs.server_config }}"
          
          # ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹æ³•è§£æserver_config
          server_config="${{ github.event.inputs.server_config }}"
          
          # ä½¿ç”¨Pythonæ¥æ­£ç¡®è§£æåŒ…å«å¤šè¡Œç§é’¥çš„é…ç½®
          python3 -c "import sys; server_config = '''$server_config'''; parts = server_config.split('/', 3); print('server_host=' + parts[0] if len(parts) >= 4 else 'Error'); print('server_port=' + parts[1] if len(parts) >= 4 else 'Error'); print('server_user=' + parts[2] if len(parts) >= 4 else 'Error'); print('server_key_length=' + str(len(parts[3])) if len(parts) >= 4 else 'Error')" > server_config_parsed.txt
          
          # è¯»å–è§£æç»“æœ
          server_host=$(grep '^server_host=' server_config_parsed.txt | cut -d'=' -f2)
          server_port=$(grep '^server_port=' server_config_parsed.txt | cut -d'=' -f2)
          server_user=$(grep '^server_user=' server_config_parsed.txt | cut -d'=' -f2)
          server_key_length=$(grep '^server_key_length=' server_config_parsed.txt | cut -d'=' -f2)
          
          # æå–å®Œæ•´çš„ç§é’¥å†…å®¹
          server_key=$(python3 -c "server_config = '''$server_config'''; parts = server_config.split('/', 3); print(parts[3] if len(parts) >= 4 else '')")
          
          echo "è§£æç»“æœ:"
          echo "  server_host: '$server_host'"
          echo "  server_port: '$server_port'"
          echo "  server_user: '$server_user'"
          echo "  server_key é•¿åº¦: ${#server_key} å­—ç¬¦"
          
          # éªŒè¯è§£æç»“æœ
          if [ -z "$server_host" ] || [ -z "$server_port" ] || [ -z "$server_user" ]; then
            echo "âŒ æœåŠ¡å™¨é…ç½®è§£æå¤±è´¥"
            echo "server_config æ ¼å¼åº”è¯¥æ˜¯: host/port/user/key"
            echo "å½“å‰å€¼: $server_config"
            exit 1
          fi
          
          # æ£€æŸ¥å¯†é’¥æ˜¯å¦ä¸ºç©º
          if [ -z "$server_key" ]; then
            echo "âŒ æœåŠ¡å™¨å¯†é’¥ä¸ºç©º"
            echo "è¯·æ£€æŸ¥ä»¥ä¸‹é…ç½®:"
            echo "1. axi-docsä»“åº“çš„SERVER_KEY secretæ˜¯å¦å·²è®¾ç½®"
            echo "2. axi-deployä»“åº“çš„SERVER_KEY secretæ˜¯å¦å·²è®¾ç½®"
            echo "3. å¯†é’¥æ ¼å¼æ˜¯å¦æ­£ç¡®"
            exit 1
          fi
          
          echo "server_host=$server_host" >> $GITHUB_OUTPUT
          echo "server_port=$server_port" >> $GITHUB_OUTPUT
          echo "server_user=$server_user" >> $GITHUB_OUTPUT
          
          # å°†å¯†é’¥è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œé¿å…è¾“å‡ºåˆ°æ—¥å¿—
          echo "SSH_KEY<<EOF" >> $GITHUB_ENV
          echo "$server_key" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "âœ… å‚æ•°è§£æå®Œæˆ"
          
      - name: è·å–è°ƒç”¨è€…ä»“åº“çš„æ„å»ºäº§ç‰©
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${{ secrets.DEPLOY_CENTER_PAT }}
        with:
          github-token: ${{ secrets.DEPLOY_CENTER_PAT }}
          script: |
            // è§£æè°ƒç”¨è€…ä»“åº“ä¿¡æ¯
            const [owner, repo] = '${{ steps.parse.outputs.caller_repo }}'.split('/');
            
            // è·å–è°ƒç”¨è€…ä»“åº“çš„æœ€æ–°workflow run
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: owner,
              repo: repo,
              branch: '${{ steps.parse.outputs.caller_branch }}',
              per_page: 1
            });
            
            if (runs.workflow_runs.length === 0) {
              throw new Error('æœªæ‰¾åˆ°è°ƒç”¨è€…ä»“åº“çš„workflow run');
            }
            
            const runId = runs.workflow_runs[0].id;
            console.log(`æ‰¾åˆ°è°ƒç”¨è€…ä»“åº“çš„workflow run: ${runId}`);
            
            // è·å–æ„å»ºäº§ç‰©
            const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: owner,
              repo: repo,
              run_id: runId
            });
            
            console.log('æ‰€æœ‰æ„å»ºäº§ç‰©:', artifacts.artifacts.map(a => ({ name: a.name, id: a.id, size: a.size_in_bytes })));
            
            const artifact = artifacts.artifacts.find(a => a.name === 'dist-${{ github.event.inputs.project }}');
            if (!artifact) {
              throw new Error(`æœªæ‰¾åˆ°æ„å»ºäº§ç‰©: dist-${{ github.event.inputs.project }}ã€‚å¯ç”¨çš„æ„å»ºäº§ç‰©: ${artifacts.artifacts.map(a => a.name).join(', ')}`);
            }
            
            console.log(`æ‰¾åˆ°æ„å»ºäº§ç‰©: ${artifact.name}, ID: ${artifact.id}`);
            
            // ä¸‹è½½æ„å»ºäº§ç‰© - ä½¿ç”¨æ­£ç¡®çš„APIè°ƒç”¨æ–¹å¼
            console.log('å¼€å§‹ä¸‹è½½æ„å»ºäº§ç‰©...');
            
            // é¢„å…ˆåŠ è½½æ‰€éœ€çš„æ¨¡å—
            const fs = require('fs');
            const path = require('path');
            const { exec: execCmd } = require('child_process');
            const { promisify } = require('util');
            const execAsync = promisify(execCmd);
            
            // å®‰è£… jszip æ¨¡å—
            console.log('å®‰è£… jszip æ¨¡å—...');
            await execAsync('npm install jszip');
            const JSZip = require('jszip');
            
            // æ–¹æ³•1: ä½¿ç”¨ GitHub CLI ä¸‹è½½æ„å»ºäº§ç‰©
            console.log('å°è¯•ä½¿ç”¨ GitHub CLI ä¸‹è½½...');
            
            try {
              // ä½¿ç”¨ GitHub CLI ä¸‹è½½æ„å»ºäº§ç‰©
              const downloadCmd = `gh api repos/${owner}/${repo}/actions/artifacts/${artifact.id}/zip --silent > artifact.zip`;
              console.log('æ‰§è¡Œå‘½ä»¤:', downloadCmd);
              
              await execAsync(downloadCmd);
              
              // æ£€æŸ¥æ–‡ä»¶å¤§å°
              const stats = fs.statSync('artifact.zip');
              console.log('ä¸‹è½½æ–‡ä»¶å¤§å°:', stats.size, 'å­—èŠ‚');
              
              if (stats.size === 0) {
                throw new Error('ä¸‹è½½çš„æ–‡ä»¶ä¸ºç©º');
              }
              
              // è§£å‹æ–‡ä»¶
              const zipData = fs.readFileSync('artifact.zip');
              const zip = new JSZip();
              await zip.loadAsync(zipData);
              
              // åˆ›å»ºdistç›®å½•
              fs.mkdirSync('./dist', { recursive: true });
              
              // è§£å‹æ‰€æœ‰æ–‡ä»¶åˆ°distç›®å½•
              for (const [filename, file] of Object.entries(zip.files)) {
                if (!file.dir) {
                  const filePath = path.join('./dist', filename);
                  const dir = path.dirname(filePath);
                  fs.mkdirSync(dir, { recursive: true });
                  fs.writeFileSync(filePath, await file.async('nodebuffer'));
                }
              }
              
              console.log('æ„å»ºäº§ç‰©ä¸‹è½½å¹¶è§£å‹å®Œæˆ');
            } catch (error) {
              console.log('GitHub CLI ä¸‹è½½å¤±è´¥:', error.message);
              
              // æ–¹æ³•2: å°è¯•ä½¿ç”¨ curl ä¸‹è½½
              console.log('å°è¯•ä½¿ç”¨ curl...');
              try {
                // è·å–ä¸‹è½½URL
                const { data: download } = await github.rest.actions.downloadArtifact({
                  owner: owner,
                  repo: repo,
                  artifact_id: artifact.id,
                  archive_format: 'zip'
                });
                
                console.log('ä¸‹è½½å“åº”:', JSON.stringify(download, null, 2));
                
                if (download && download.url) {
                  console.log(`ä¸‹è½½URL: ${download.url}`);
                  
                                     // ä½¿ç”¨ curl ä¸‹è½½æ–‡ä»¶
                   const curlCmd = `curl -L -H "Authorization: token ${{ secrets.DEPLOY_CENTER_PAT }}" "${download.url}" -o artifact.zip`;
                  console.log('æ‰§è¡Œcurlå‘½ä»¤:', curlCmd);
                  
                  await execAsync(curlCmd);
                  
                  // æ£€æŸ¥æ–‡ä»¶å¤§å°
                  const stats = fs.statSync('artifact.zip');
                  console.log('ä¸‹è½½æ–‡ä»¶å¤§å°:', stats.size, 'å­—èŠ‚');
                  
                  if (stats.size === 0) {
                    throw new Error('ä¸‹è½½çš„æ–‡ä»¶ä¸ºç©º');
                  }
                  
                  // è§£å‹æ–‡ä»¶
                  const zipData = fs.readFileSync('artifact.zip');
                  const zip = new JSZip();
                  await zip.loadAsync(zipData);
                  
                  // åˆ›å»ºdistç›®å½•
                  fs.mkdirSync('./dist', { recursive: true });
                  
                  // è§£å‹æ‰€æœ‰æ–‡ä»¶åˆ°distç›®å½•
                  for (const [filename, file] of Object.entries(zip.files)) {
                    if (!file.dir) {
                      const filePath = path.join('./dist', filename);
                      const dir = path.dirname(filePath);
                      fs.mkdirSync(dir, { recursive: true });
                      fs.writeFileSync(filePath, await file.async('nodebuffer'));
                    }
                  }
                  
                  console.log('æ„å»ºäº§ç‰©ä¸‹è½½å¹¶è§£å‹å®Œæˆ');
                } else {
                  throw new Error('æ— æ³•è·å–ä¸‹è½½URL');
                }
              } catch (curlError) {
                console.log('curl ä¸‹è½½å¤±è´¥:', curlError.message);
                
                // æ–¹æ³•3: å°è¯•ä½¿ç”¨ wget ä¸‹è½½
                console.log('å°è¯•ä½¿ç”¨ wget...');
                try {
                                     const wgetCmd = `wget --header="Authorization: token ${{ secrets.DEPLOY_CENTER_PAT }}" "${download.url}" -O artifact.zip`;
                  console.log('æ‰§è¡Œwgetå‘½ä»¤:', wgetCmd);
                  
                  await execAsync(wgetCmd);
                  
                  // æ£€æŸ¥æ–‡ä»¶å¤§å°
                  const stats = fs.statSync('artifact.zip');
                  console.log('ä¸‹è½½æ–‡ä»¶å¤§å°:', stats.size, 'å­—èŠ‚');
                  
                  if (stats.size === 0) {
                    throw new Error('ä¸‹è½½çš„æ–‡ä»¶ä¸ºç©º');
                  }
                  
                  // è§£å‹æ–‡ä»¶
                  const zipData = fs.readFileSync('artifact.zip');
                  const zip = new JSZip();
                  await zip.loadAsync(zipData);
                  
                  // åˆ›å»ºdistç›®å½•
                  fs.mkdirSync('./dist', { recursive: true });
                  
                  // è§£å‹æ‰€æœ‰æ–‡ä»¶åˆ°distç›®å½•
                  for (const [filename, file] of Object.entries(zip.files)) {
                    if (!file.dir) {
                      const filePath = path.join('./dist', filename);
                      const dir = path.dirname(filePath);
                      fs.mkdirSync(dir, { recursive: true });
                      fs.writeFileSync(filePath, await file.async('nodebuffer'));
                    }
                  }
                  
                  console.log('æ„å»ºäº§ç‰©ä¸‹è½½å¹¶è§£å‹å®Œæˆ');
                } catch (wgetError) {
                  console.log('wget ä¸‹è½½å¤±è´¥:', wgetError.message);
                  throw new Error(`æ— æ³•ä¸‹è½½æ„å»ºäº§ç‰©: ${error.message}`);
                }
              }
            }
            
      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.parse.outputs.server_host }}
          port: ${{ steps.parse.outputs.server_port }}
          username: ${{ steps.parse.outputs.server_user }}
          key: ${{ env.SSH_KEY }}
          script: |
            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            mkdir -p ${{ github.event.inputs.deploy_path }}
            
            # åœæ­¢ç°æœ‰æœåŠ¡ï¼ˆå¦‚æœæœ‰ï¼‰
            echo "åœæ­¢ç°æœ‰æœåŠ¡..."
            
            # æ¸…ç†æ—§æ–‡ä»¶
            rm -rf ${{ github.event.inputs.deploy_path }}/*
            
            # éƒ¨ç½²æ–°æ–‡ä»¶
            echo "éƒ¨ç½²æ–°æ–‡ä»¶åˆ° ${{ github.event.inputs.deploy_path }}..."
            
            # æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
            echo "é¡¹ç›®: ${{ github.event.inputs.project }}"
            echo "è¯­è¨€: ${{ github.event.inputs.lang }}"
            echo "è°ƒç”¨è€…: ${{ steps.parse.outputs.caller_repo }}"
            echo "åˆ†æ”¯: ${{ steps.parse.outputs.caller_branch }}"
            echo "æäº¤: ${{ steps.parse.outputs.caller_commit }}"
            
      - name: ä¸Šä¼ éƒ¨ç½²æ–‡ä»¶
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ steps.parse.outputs.server_host }}
          port: ${{ steps.parse.outputs.server_port }}
          username: ${{ steps.parse.outputs.server_user }}
          key: ${{ env.SSH_KEY }}
          source: "./dist/*"
          target: "${{ github.event.inputs.deploy_path }}/"
          strip_components: 0
          
      - name: æ‰§è¡Œå¯åŠ¨å‘½ä»¤
        if: ${{ github.event.inputs.start_cmd != '' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.parse.outputs.server_host }}
          port: ${{ steps.parse.outputs.server_port }}
          username: ${{ steps.parse.outputs.server_user }}
          key: ${{ env.SSH_KEY }}
          script: |
            echo "æ‰§è¡Œå¯åŠ¨å‘½ä»¤: ${{ github.event.inputs.start_cmd }}"
            cd ${{ github.event.inputs.deploy_path }}
            ${{ github.event.inputs.start_cmd }}
            
      - name: éƒ¨ç½²å®Œæˆ
        run: |
          echo "âœ… éƒ¨ç½²å®Œæˆ!"
          echo "é¡¹ç›®: ${{ github.event.inputs.project }}"
          echo "éƒ¨ç½²è·¯å¾„: ${{ github.event.inputs.deploy_path }}"
          echo "è°ƒç”¨è€…: ${{ steps.parse.outputs.caller_repo }}@${{ steps.parse.outputs.caller_branch }}"
          echo "æäº¤: ${{ steps.parse.outputs.caller_commit }}"
          
      - name: éªŒè¯éƒ¨ç½²ç»“æœ
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.parse.outputs.server_host }}
          port: ${{ steps.parse.outputs.server_port }}
          username: ${{ steps.parse.outputs.server_user }}
          key: ${{ env.SSH_KEY }}
          script: |
            echo "ğŸ” éªŒè¯éƒ¨ç½²ç»“æœ..."
            echo "éƒ¨ç½²è·¯å¾„: ${{ github.event.inputs.deploy_path }}"
            
            # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
            if [ -d "${{ github.event.inputs.deploy_path }}" ]; then
              echo "âœ… éƒ¨ç½²ç›®å½•å­˜åœ¨"
              
              # æ˜¾ç¤ºç›®å½•å†…å®¹
              echo "ğŸ“ ç›®å½•å†…å®¹:"
              ls -la "${{ github.event.inputs.deploy_path }}"
              
              # æ˜¾ç¤ºæ–‡ä»¶æ•°é‡
              echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
              find "${{ github.event.inputs.deploy_path }}" -type f | wc -l
              
              # æ˜¾ç¤ºæœ€æ–°ä¿®æ”¹çš„æ–‡ä»¶
              echo "ğŸ•’ æœ€æ–°ä¿®æ”¹çš„æ–‡ä»¶:"
              find "${{ github.event.inputs.deploy_path }}" -type f -exec ls -la {} \; | head -10
              
              # æ£€æŸ¥å…³é”®æ–‡ä»¶
              if [ -f "${{ github.event.inputs.deploy_path }}/index.html" ]; then
                echo "âœ… index.html å­˜åœ¨"
                echo "æ–‡ä»¶å¤§å°: $(du -h "${{ github.event.inputs.deploy_path }}/index.html" | cut -f1)"
              else
                echo "âŒ index.html ä¸å­˜åœ¨"
              fi
              
            else
              echo "âŒ éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨: ${{ github.event.inputs.deploy_path }}"
            fi
            
            # æ˜¾ç¤ºæœåŠ¡å™¨æ—¶é—´
            echo "ğŸ• æœåŠ¡å™¨æ—¶é—´: $(date)"
            
            # æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ
            echo "ğŸ’¾ ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
            df -h "${{ github.event.inputs.deploy_path }}" 