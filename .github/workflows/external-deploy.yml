name: External Deploy Handler

on:
  workflow_call:
    inputs:
      project:      { required: true, type: string }
      deploy_path:  { required: true, type: string }
      start_cmd:    { required: false, type: string, default: '' }
      run_id:       { required: true, type: string }
      source_repo:  { required: true, type: string }
      test_url:     { required: false, type: string, default: '' }
    
    secrets:
      SERVER_HOST:
        required: true
      SERVER_PORT:
        required: true
      SERVER_USER:
        required: true
      SERVER_KEY:
        required: true
      DEPLOY_CENTER_PAT:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. ä¸‹è½½ artifactï¼ˆè·¨ä»“åº“å¿…é¡» PATï¼‰
      - name: Download artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{ secrets.DEPLOY_CENTER_PAT }}
          repo: ${{ inputs.source_repo }}
          run_id: ${{ inputs.run_id }}
          name: dist-${{ inputs.project }}
          path: ./dist

      # 2. ä¸Šä¼ è‡³æœåŠ¡å™¨
      - name: Upload via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host:     ${{ secrets.SERVER_HOST }}
          port:     ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key:      ${{ secrets.SERVER_KEY }}
          source:   "./dist/*"
          target:   "${{ inputs.deploy_path }}/"
          strip_components: 0

      # 3. æ‰§è¡Œå¯åŠ¨å‘½ä»¤ï¼ˆå¯é€‰ï¼‰
      - name: Run start command
        if: ${{ inputs.start_cmd != '' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:     ${{ secrets.SERVER_HOST }}
          port:     ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key:      ${{ secrets.SERVER_KEY }}
          script: |
            cd ${{ inputs.deploy_path }}
            ${{ inputs.start_cmd }}

      # 4. éƒ¨ç½²çŠ¶æ€æ£€æŸ¥
      - name: Check deployment status
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:     ${{ secrets.SERVER_HOST }}
          port:     ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key:      ${{ secrets.SERVER_KEY }}
          script: |
            echo "ğŸ” æ£€æŸ¥éƒ¨ç½²çŠ¶æ€..."
            echo "é¡¹ç›®: ${{ inputs.project }}"
            echo "éƒ¨ç½²è·¯å¾„: ${{ inputs.deploy_path }}"
            echo "æ£€æŸ¥æ—¶é—´: $(date)"
            echo ""
            
            # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
            if [ -d "${{ inputs.deploy_path }}" ]; then
              echo "âœ… éƒ¨ç½²ç›®å½•å­˜åœ¨"
              echo "ğŸ“ ç›®å½•å†…å®¹:"
              ls -la "${{ inputs.deploy_path }}"
              echo ""
              
              # æ£€æŸ¥å…³é”®æ–‡ä»¶
              echo "ğŸ”‘ å…³é”®æ–‡ä»¶æ£€æŸ¥:"
              if [ -f "${{ inputs.deploy_path }}/index.html" ]; then
                echo "âœ… index.html å­˜åœ¨"
                echo "   å¤§å°: $(du -h "${{ inputs.deploy_path }}/index.html" | cut -f1)"
                echo "   ä¿®æ”¹æ—¶é—´: $(stat -c %y "${{ inputs.deploy_path }}/index.html")"
              else
                echo "âŒ index.html ä¸å­˜åœ¨"
              fi
              
              if [ -d "${{ inputs.deploy_path }}/assets" ]; then
                echo "âœ… assets ç›®å½•å­˜åœ¨"
                echo "   æ–‡ä»¶æ•°é‡: $(find "${{ inputs.deploy_path }}/assets" -type f | wc -l)"
              else
                echo "âŒ assets ç›®å½•ä¸å­˜åœ¨"
              fi
              
              echo ""
              
              # æ£€æŸ¥ Nginx é…ç½®
              echo "ğŸŒ Nginx é…ç½®æ£€æŸ¥:"
              if command -v nginx &> /dev/null; then
                echo "âœ… Nginx å·²å®‰è£…"
                nginx -t 2>&1 | head -5
              else
                echo "âŒ Nginx æœªå®‰è£…"
              fi
              
              echo ""
              
              # æ£€æŸ¥ç«¯å£ç›‘å¬
              echo "ğŸ”Œ ç«¯å£ç›‘å¬æ£€æŸ¥:"
              netstat -tlnp | grep :80 || echo "âŒ 80ç«¯å£æœªç›‘å¬"
              
            else
              echo "âŒ éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨: ${{ inputs.deploy_path }}"
            fi

      # 5. ç½‘ç«™å¯è®¿é—®æ€§æµ‹è¯•
      - name: Test website accessibility
        if: ${{ inputs.test_url != '' }}
        run: |
          echo "ğŸŒ æµ‹è¯•ç½‘ç«™å¯è®¿é—®æ€§..."
          echo "æµ‹è¯•URL: ${{ inputs.test_url }}"
          
          # ç­‰å¾…ä¸€ä¸‹è®©éƒ¨ç½²ç”Ÿæ•ˆ
          sleep 5
          
          # ä½¿ç”¨curlæµ‹è¯•ç½‘ç«™å“åº”
          response=$(curl -s -o /dev/null -w "%{http_code}" "${{ inputs.test_url }}" || echo "000")
          
          if [ "$response" = "200" ]; then
            echo "âœ… ç½‘ç«™å¯æ­£å¸¸è®¿é—® (HTTP $response)"
          else
            echo "âŒ ç½‘ç«™æ— æ³•è®¿é—® (HTTP $response)"
            echo "å¯èƒ½çš„åŸå› :"
            echo "1. åŸŸåè§£æé—®é¢˜"
            echo "2. æœåŠ¡å™¨é˜²ç«å¢™è®¾ç½®"
            echo "3. Nginxé…ç½®é—®é¢˜"
            echo "4. SSLè¯ä¹¦é—®é¢˜"
          fi
          
          # è·å–ç½‘ç«™æ ‡é¢˜
          title=$(curl -s "${{ inputs.test_url }}" | grep -o '<title>[^<]*</title>' | sed 's/<title>\(.*\)<\/title>/\1/' || echo "æ— æ³•è·å–æ ‡é¢˜")
          echo "ç½‘ç«™æ ‡é¢˜: $title"

      # 6. æ‰“å°éƒ¨ç½²å®Œæˆä¿¡æ¯
      - run: echo "âœ… ${{ inputs.project }} éƒ¨ç½²å®Œæˆ"