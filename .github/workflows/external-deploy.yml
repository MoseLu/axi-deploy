name: External Deploy Workflow

on:
  repository_dispatch:
    types: [deploy]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: dawidd6/action-download-artifact@v2
        with:
          name: dist-${{ inputs.project }}
          path: ./dist
          repo: ${{ inputs.source_repo }}
          workflow: build
          run_id: ${{ inputs.run_id }}
          github_token: ${{ secrets.DEPLOY_CENTER_PAT }}

      - name: æ˜¾ç¤ºæ„å»ºäº§ç‰©ä¿¡æ¯
        run: |
          echo "ğŸ“¦ æ„å»ºäº§ç‰©ä¿¡æ¯:"
          ls -la ./dist/
          echo "ğŸ“‹ éƒ¨ç½²å‚æ•°:"
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- éƒ¨ç½²è·¯å¾„: ${{ inputs.deploy_path }}"
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- æ„å»ºID: ${{ inputs.run_id }}"

      - name: ä¸Šä¼ åˆ°æœåŠ¡å™¨
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: "./dist/*"
          target: "/tmp/"
          strip_components: 0
          command_timeout: "10m"

      - name: Nginxç¯å¢ƒåˆå§‹åŒ–ï¼ˆç¾åè‡ªæ„ˆ/é…ç½®å˜æ›´/å¥åº·å·¡æ£€ï¼‰
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸ”§ å¼€å§‹Nginxç¯å¢ƒåˆå§‹åŒ–..."
            
            # æ ‡å‡†åŒ–é…ç½®
            DOMAIN="redamancy.com.cn"
            RUN_USER="deploy"
            APPS_ROOT="/srv/apps"
            STATIC_ROOT="/srv/static"
            NGINX_CONF_DIR="/www/server/nginx/conf/conf.d/redamancy"
            CERT_SRC="/www/server/panel/vhost/cert/$DOMAIN"
            CERT_DST="/www/server/nginx/ssl/redamancy"
            
            echo "ğŸ“‹ åˆå§‹åŒ–é…ç½®:"
            echo "- åŸŸå: $DOMAIN"
            echo "- è¿è¡Œç”¨æˆ·: $RUN_USER"
            echo "- åº”ç”¨ç›®å½•: $APPS_ROOT"
            echo "- é™æ€ç›®å½•: $STATIC_ROOT"
            echo "- Nginxé…ç½®: $NGINX_CONF_DIR"
            echo "- è¯ä¹¦æº: $CERT_SRC"
            echo "- è¯ä¹¦ç›®æ ‡: $CERT_DST"
            
            # 1. å‰ç½®æ£€æŸ¥
            echo "ğŸ” å‰ç½®æ£€æŸ¥..."
            if ! command -v nginx &> /dev/null; then
              echo "âŒ Nginxæœªå®‰è£…ï¼Œæ— æ³•ç»§ç»­éƒ¨ç½²"
              exit 1
            fi
            echo "âœ… Nginxå·²å®‰è£…: $(nginx -v)"
            
            if ! systemctl is-active --quiet nginx; then
              echo "âš ï¸  NginxæœåŠ¡æœªè¿è¡Œï¼Œå°è¯•å¯åŠ¨..."
              systemctl start nginx
            fi
            echo "âœ… NginxæœåŠ¡æ­£åœ¨è¿è¡Œ"
            
            # 2. åˆ›å»ºä¸šåŠ¡è¿è¡Œç”¨æˆ·ï¼ˆç¾åè‡ªæ„ˆï¼‰
            echo "ğŸ‘¤ æ£€æŸ¥ä¸šåŠ¡è¿è¡Œç”¨æˆ·..."
            if ! id "$RUN_USER" &>/dev/null; then
              echo "ğŸ†• åˆ›å»ºç”¨æˆ· $RUN_USER..."
              sudo useradd -m -s /bin/bash $RUN_USER
              echo "âœ… ç”¨æˆ· $RUN_USER åˆ›å»ºå®Œæˆ"
            else
              echo "âœ… ç”¨æˆ· $RUN_USER å·²å­˜åœ¨"
            fi
            
            # 3. åˆ›å»ºæ‰€éœ€ç›®å½•ï¼ˆç¾åè‡ªæ„ˆï¼‰
            echo "ğŸ“ æ£€æŸ¥å¹¶åˆ›å»ºç›®å½•..."
            sudo mkdir -p $APPS_ROOT $STATIC_ROOT $NGINX_CONF_DIR $CERT_DST
            sudo chown $RUN_USER:$RUN_USER $APPS_ROOT $STATIC_ROOT
            sudo chmod 755 $NGINX_CONF_DIR $CERT_DST
            echo "âœ… ç›®å½•ç»“æ„æ£€æŸ¥å®Œæˆ"
            
            # 4. è½¯é“¾å®å¡”è¯ä¹¦ï¼ˆå¥åº·å·¡æ£€ï¼‰
            echo "ğŸ”— æ£€æŸ¥è¯ä¹¦è½¯é“¾..."
            if [ ! -d "$CERT_SRC" ]; then
              echo "âŒ è¯ä¹¦æºç›®å½•ä¸å­˜åœ¨: $CERT_SRC"
              echo "è¯·ç¡®ä¿å®å¡”é¢æ¿å·²ä¸ºåŸŸå $DOMAIN é…ç½®SSLè¯ä¹¦"
              exit 1
            fi
            
            # æ£€æŸ¥å¹¶é‡æ–°åˆ›å»ºè½¯é“¾
            if [ -f "$CERT_SRC/fullchain.pem" ]; then
              sudo ln -sf $CERT_SRC/fullchain.pem $CERT_DST/fullchain.pem
              echo "âœ… è½¯é“¾ fullchain.pem å®Œæˆ"
            else
              echo "âŒ è¯ä¹¦æ–‡ä»¶ä¸å­˜åœ¨: $CERT_SRC/fullchain.pem"
              exit 1
            fi
            
            if [ -f "$CERT_SRC/privkey.pem" ]; then
              sudo ln -sf $CERT_SRC/privkey.pem $CERT_DST/privkey.pem
              echo "âœ… è½¯é“¾ privkey.pem å®Œæˆ"
            else
              echo "âŒ ç§é’¥æ–‡ä»¶ä¸å­˜åœ¨: $CERT_SRC/privkey.pem"
              exit 1
            fi
            
            # 5. å†™å…¥/æ›´æ–°ä¸»é…ç½®ï¼ˆé…ç½®å˜æ›´ï¼‰
            echo "ğŸ“ æ›´æ–°ä¸»é…ç½®æ–‡ä»¶..."
            MAIN_CONF="$NGINX_CONF_DIR/00-main.conf"
            
            # æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°ç”Ÿæˆé…ç½®
            if [ ! -f "$MAIN_CONF" ] || [ "$(stat -c %Y $MAIN_CONF)" -lt "$(date -d '1 hour ago' +%s)" ]; then
              echo "ğŸ”„ é‡æ–°ç”Ÿæˆä¸»é…ç½®æ–‡ä»¶..."
              sudo tee $MAIN_CONF <<'EOF'
            server {
                listen 443 ssl http2;
                server_name redamancy.com.cn;
            
                ssl_certificate     /www/server/nginx/ssl/redamancy/fullchain.pem;
                ssl_certificate_key /www/server/nginx/ssl/redamancy/privkey.pem;
            
                client_max_body_size 100m;
            
                # è¿™é‡Œè‡ªåŠ¨åŠ è½½ route-*.confï¼ˆé¡¹ç›®è·¯ç”±ï¼‰â€”â€”ä¸»é…ç½®æ°¸è¿œä¸ç”¨å†æ”¹
                include /www/server/nginx/conf/conf.d/redamancy/route-*.conf;
            }
            
            server {
                listen 80;
                server_name redamancy.com.cn;
                return 301 https://$host$request_uri;
            }
            EOF
              echo "âœ… ä¸»é…ç½®æ–‡ä»¶å·²æ›´æ–°"
            else
              echo "âœ… ä¸»é…ç½®æ–‡ä»¶æ— éœ€æ›´æ–°"
            fi
            
            # 6. æ£€æŸ¥å¹¶é‡è½½Nginxï¼ˆå¥åº·å·¡æ£€ï¼‰
            echo "ğŸ”„ æ£€æŸ¥Nginxé…ç½®..."
            if sudo nginx -t; then
              echo "âœ… Nginxé…ç½®è¯­æ³•æ£€æŸ¥é€šè¿‡"
            else
              echo "âŒ Nginxé…ç½®è¯­æ³•é”™è¯¯"
              exit 1
            fi
            
            if sudo systemctl reload nginx; then
              echo "âœ… Nginxçƒ­åŠ è½½å®Œæˆ"
            else
              echo "âŒ Nginxé‡è½½å¤±è´¥"
              exit 1
            fi
            
            # 7. é˜²ç«å¢™æ£€æŸ¥ï¼ˆå¥åº·å·¡æ£€ï¼‰
            echo "ğŸ”¥ æ£€æŸ¥é˜²ç«å¢™è§„åˆ™..."
            if command -v firewall-cmd &> /dev/null; then
              if ! sudo firewall-cmd --list-services | grep -q http; then
                echo "âš ï¸  HTTPç«¯å£æœªå¼€æ”¾ï¼Œå°è¯•å¼€æ”¾..."
                sudo firewall-cmd --add-service=http --permanent
                sudo firewall-cmd --add-service=https --permanent
                sudo firewall-cmd --reload
                echo "âœ… HTTP/HTTPSç«¯å£å·²å¼€æ”¾"
              else
                echo "âœ… HTTP/HTTPSç«¯å£å·²å¼€æ”¾"
              fi
            else
              echo "æœªæ£€æµ‹åˆ° firewalldï¼Œè·³è¿‡é˜²ç«å¢™é…ç½®"
            fi
            
            # 8. æœ€ç»ˆéªŒè¯
            echo "ğŸ” æœ€ç»ˆéªŒè¯..."
            echo "ğŸ“ é…ç½®æ–‡ä»¶:"
            ls -la $NGINX_CONF_DIR/
            echo "ğŸ”— è¯ä¹¦è½¯é“¾:"
            ls -la $CERT_DST/
            echo "ğŸ“‚ ç›®å½•æƒé™:"
            ls -la $APPS_ROOT/
            ls -la $STATIC_ROOT/
            
            # æµ‹è¯•HTTPSè®¿é—®
            echo "ğŸŒ æµ‹è¯•HTTPSè®¿é—®:"
            if curl -f -s https://$DOMAIN > /dev/null 2>&1; then
              echo "âœ… HTTPSè®¿é—®æ­£å¸¸"
            else
              echo "âš ï¸  HTTPSè®¿é—®æµ‹è¯•å¤±è´¥ï¼ˆå¯èƒ½å°šæœªéƒ¨ç½²é¡¹ç›®ï¼‰"
            fi
            
            echo "âœ… Nginxç¯å¢ƒåˆå§‹åŒ–å®Œæˆï¼"

      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²é¡¹ç›®: ${{ inputs.project }}"
            
            # æ ‡å‡†åŒ–ç›®å½•ç»“æ„
            APPS_ROOT="/srv/apps"
            STATIC_ROOT="/srv/static"
            NGINX_CONF_DIR="/www/server/nginx/conf/conf.d/redamancy"
            
            # æ ¹æ®é¡¹ç›®ç±»å‹ç¡®å®šéƒ¨ç½²è·¯å¾„
            if [[ "${{ inputs.project }}" == "axi-star-cloud" ]]; then
              # Goé¡¹ç›®éƒ¨ç½²åˆ°åº”ç”¨ç›®å½•
              DEPLOY_PATH="$APPS_ROOT/${{ inputs.project }}"
              echo "ğŸ“ Goé¡¹ç›®éƒ¨ç½²åˆ°: $DEPLOY_PATH"
            else
              # é™æ€é¡¹ç›®éƒ¨ç½²åˆ°é™æ€æ–‡ä»¶ç›®å½•
              DEPLOY_PATH="$STATIC_ROOT/${{ inputs.project }}"
              echo "ğŸ“ é™æ€é¡¹ç›®éƒ¨ç½²åˆ°: $DEPLOY_PATH"
            fi
            
            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            sudo mkdir -p $DEPLOY_PATH
            sudo chown deploy:deploy $DEPLOY_PATH
            
            # è§£å‹å¹¶éƒ¨ç½²æ–‡ä»¶
            echo "ğŸ“¦ è§£å‹éƒ¨ç½²æ–‡ä»¶..."
            cd /tmp
            if [ -f "deployment.tar.gz" ]; then
              # Goé¡¹ç›®éƒ¨ç½²
              echo "ğŸ”§ éƒ¨ç½²Goé¡¹ç›®..."
              sudo tar xzf deployment.tar.gz -C $DEPLOY_PATH
              sudo chown -R deploy:deploy $DEPLOY_PATH
              
              # è®¾ç½®å¯æ‰§è¡Œæƒé™
              if [ -f "$DEPLOY_PATH/backend/star-cloud-linux" ]; then
                sudo chmod +x $DEPLOY_PATH/backend/star-cloud-linux
              fi
              
              # åˆ›å»ºå¿…è¦ç›®å½•
              sudo mkdir -p $DEPLOY_PATH/uploads/{image,document,audio,video,other,avatars}
              sudo mkdir -p $DEPLOY_PATH/logs
              sudo chown -R deploy:deploy $DEPLOY_PATH/uploads $DEPLOY_PATH/logs
              
              # é‡å¯æœåŠ¡
              echo "ğŸ”„ é‡å¯å®å¡”é¢æ¿ç½‘ç«™..."
              bt restart
              
              # ç­‰å¾…æœåŠ¡å¯åŠ¨
              echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
              sleep 5
              
              # å¥åº·æ£€æŸ¥
              echo "ğŸ” æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
              if curl -f -s http://127.0.0.1:8080/health > /dev/null 2>&1; then
                echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ - å¥åº·æ£€æŸ¥é€šè¿‡"
              else
                echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥ - å¥åº·æ£€æŸ¥å¤±è´¥"
                echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
                bt status
                exit 1
              fi
            else
              # é™æ€é¡¹ç›®éƒ¨ç½²
              echo "ğŸ“ éƒ¨ç½²é™æ€é¡¹ç›®..."
              sudo cp -r * $DEPLOY_PATH/
              sudo chown -R deploy:deploy $DEPLOY_PATH
              echo "âœ… é™æ€é¡¹ç›®éƒ¨ç½²å®Œæˆ"
            fi
            
            echo "âœ… é¡¹ç›®éƒ¨ç½²å®Œæˆ: ${{ inputs.project }}"

      - name: é…ç½®Nginxï¼ˆå¦‚æœæä¾›é…ç½®ï¼‰
        if: inputs.nginx_config != ''
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸ”§ é…ç½®Nginx..."
            
            NGINX_CONF_DIR="/www/server/nginx/conf/conf.d/redamancy"
            PROJECT="${{ inputs.project }}"
            
            # ç”Ÿæˆé¡¹ç›®è·¯ç”±é…ç½®
            ROUTE_CONF="$NGINX_CONF_DIR/route-$PROJECT.conf"
            
            # å†™å…¥é¡¹ç›®é…ç½®
            sudo tee $ROUTE_CONF <<'EOF'
            ${{ inputs.nginx_config }}
            EOF
            
            echo "âœ… Nginxé…ç½®å·²å†™å…¥: $ROUTE_CONF"
            
            # æ£€æŸ¥Nginxé…ç½®è¯­æ³•
            if sudo nginx -t; then
              echo "âœ… Nginxé…ç½®è¯­æ³•æ£€æŸ¥é€šè¿‡"
            else
              echo "âŒ Nginxé…ç½®è¯­æ³•é”™è¯¯"
              exit 1
            fi
            
            # é‡è½½Nginxé…ç½®
            if sudo systemctl reload nginx; then
              echo "âœ… Nginxé…ç½®é‡è½½å®Œæˆ"
            else
              echo "âŒ Nginxé‡è½½å¤±è´¥"
              exit 1
            fi

      - name: æµ‹è¯•ç½‘ç«™å¯è®¿é—®æ€§
        if: inputs.test_url != ''
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸŒ æµ‹è¯•ç½‘ç«™å¯è®¿é—®æ€§..."
            æµ‹è¯•URL: ${{ inputs.test_url }}
            
            # ç­‰å¾…ä¸€æ®µæ—¶é—´è®©æœåŠ¡å®Œå…¨å¯åŠ¨
            sleep 10
            
            # æµ‹è¯•ç½‘ç«™è®¿é—®
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ inputs.test_url }})
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… ç½‘ç«™å¯è®¿é—® (HTTP $HTTP_STATUS)"
            elif [ "$HTTP_STATUS" = "404" ]; then
              echo "âš ï¸  ç½‘ç«™è¿”å›404 (å¯èƒ½å°šæœªéƒ¨ç½²é¡¹ç›®)"
            else
              echo "âŒ ç½‘ç«™æ— æ³•è®¿é—® (HTTP $HTTP_STATUS)"
              echo "å¯èƒ½çš„åŸå› :"
              echo "1. åŸŸåè§£æé—®é¢˜"
              echo "2. æœåŠ¡å™¨é˜²ç«å¢™è®¾ç½®"
              echo "3. Nginxé…ç½®é—®é¢˜"
              echo "4. SSLè¯ä¹¦é—®é¢˜"
              
              # æ˜¾ç¤ºç½‘ç«™æ ‡é¢˜
              TITLE=$(curl -s ${{ inputs.test_url }} | grep -o '<title>[^<]*</title>' | sed 's/<title>\(.*\)<\/title>/\1/')
              echo "ç½‘ç«™æ ‡é¢˜: $TITLE"
            fi

      - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
        run: |
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          echo ""
          echo "ğŸ“‹ éƒ¨ç½²æ‘˜è¦:"
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- éƒ¨ç½²è·¯å¾„: ${{ inputs.deploy_path }}"
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- æ„å»ºID: ${{ inputs.run_id }}"
          if [ "${{ inputs.test_url }}" != "" ]; then
            echo "- æµ‹è¯•URL: ${{ inputs.test_url }}"
          fi
          echo ""
          echo "âœ… é¡¹ç›®å·²æˆåŠŸéƒ¨ç½²åˆ°æœåŠ¡å™¨"