name: Health Check

description: "å¥åº·æ£€æŸ¥å·¥ä½œæµ - å®šæœŸæ£€æŸ¥æœåŠ¡å™¨å’Œéƒ¨ç½²çŠ¶æ€"

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œå¥åº·æ£€æŸ¥
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      check_type:
        description: 'æ£€æŸ¥ç±»å‹'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - server
          - services
          - nginx
          - deployments
      server_host:
        description: 'æœåŠ¡å™¨åœ°å€'
        required: false
        type: string
      server_user:
        description: 'æœåŠ¡å™¨ç”¨æˆ·'
        required: false
        type: string
      server_key:
        description: 'æœåŠ¡å™¨å¯†é’¥'
        required: false
        type: string
      server_port:
        description: 'æœåŠ¡å™¨ç«¯å£'
        required: false
        default: '22'
        type: string

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: è§£ææœåŠ¡å™¨é…ç½®
        id: parse-config
        run: |
          echo "ğŸ” è§£ææœåŠ¡å™¨é…ç½®..."
          
          # ä»è¾“å…¥å‚æ•°æˆ–ç¯å¢ƒå˜é‡è·å–é…ç½®
          SERVER_HOST="${{ inputs.server_host || secrets.SERVER_HOST }}"
          SERVER_USER="${{ inputs.server_user || secrets.SERVER_USER }}"
          SERVER_KEY="${{ inputs.server_key || secrets.SERVER_KEY }}"
          SERVER_PORT="${{ inputs.server_port || secrets.SERVER_PORT || '22' }}"
          
          if [ -z "$SERVER_HOST" ] || [ -z "$SERVER_USER" ] || [ -z "$SERVER_KEY" ]; then
            echo "ğŸš¨ ç¼ºå°‘æœåŠ¡å™¨é…ç½®ä¿¡æ¯"
            exit 1
          fi
          
          echo "âœ… æœåŠ¡å™¨é…ç½®è§£æå®Œæˆ"
          echo "ğŸ“‹ æœåŠ¡å™¨ä¿¡æ¯:"
          echo "- ä¸»æœº: $SERVER_HOST"
          echo "- ç”¨æˆ·: $SERVER_USER"
          echo "- ç«¯å£: $SERVER_PORT"

      - name: æœåŠ¡å™¨åŸºç¡€æ£€æŸ¥
        if: ${{ inputs.check_type == 'all' || inputs.check_type == 'server' }}
        uses: ./.github/actions/retry-center
        with:
          step_name: "æœåŠ¡å™¨å¥åº·æ£€æŸ¥"
          command: |
            echo "ğŸ” æœåŠ¡å™¨åŸºç¡€æ£€æŸ¥..."
            
            # 1. ç³»ç»Ÿä¿¡æ¯æ£€æŸ¥
            echo "ğŸ“Š ç³»ç»Ÿä¿¡æ¯:"
            echo "- æ“ä½œç³»ç»Ÿ: $(uname -a)"
            echo "- å†…æ ¸ç‰ˆæœ¬: $(uname -r)"
            echo "- ç³»ç»Ÿè´Ÿè½½: $(uptime)"
            echo "- å†…å­˜ä½¿ç”¨: $(free -h)"
            echo "- ç£ç›˜ä½¿ç”¨: $(df -h /)"
            
            # 2. ç½‘ç»œè¿æ¥æ£€æŸ¥
            echo "ğŸŒ ç½‘ç»œè¿æ¥æ£€æŸ¥:"
            if ping -c 1 8.8.8.8 > /dev/null 2>&1; then
              echo "âœ… å¤–ç½‘è¿æ¥æ­£å¸¸"
            else
              echo "âŒ å¤–ç½‘è¿æ¥å¼‚å¸¸"
            fi
            
            # 3. å…³é”®æœåŠ¡æ£€æŸ¥
            echo "ğŸ”§ å…³é”®æœåŠ¡æ£€æŸ¥:"
            
            # æ£€æŸ¥SSHæœåŠ¡
            if systemctl is-active --quiet sshd; then
              echo "âœ… SSHæœåŠ¡æ­£å¸¸è¿è¡Œ"
            else
              echo "âŒ SSHæœåŠ¡å¼‚å¸¸"
            fi
          max_retries: 2
          retry_delay: 10
          timeout_minutes: 10
          strategy: "simple"
          continue_on_error: true
            echo "ğŸ” æœåŠ¡å™¨åŸºç¡€æ£€æŸ¥..."
            
            # 1. ç³»ç»Ÿä¿¡æ¯æ£€æŸ¥
            echo "ğŸ“Š ç³»ç»Ÿä¿¡æ¯:"
            echo "- æ“ä½œç³»ç»Ÿ: $(uname -a)"
            echo "- å†…æ ¸ç‰ˆæœ¬: $(uname -r)"
            echo "- ç³»ç»Ÿè´Ÿè½½: $(uptime)"
            echo "- å†…å­˜ä½¿ç”¨: $(free -h)"
            echo "- ç£ç›˜ä½¿ç”¨: $(df -h /)"
            
            # 2. ç½‘ç»œè¿æ¥æ£€æŸ¥
            echo "ğŸŒ ç½‘ç»œè¿æ¥æ£€æŸ¥:"
            if ping -c 1 8.8.8.8 > /dev/null 2>&1; then
              echo "âœ… å¤–ç½‘è¿æ¥æ­£å¸¸"
            else
              echo "âŒ å¤–ç½‘è¿æ¥å¼‚å¸¸"
            fi
            
            # 3. å…³é”®æœåŠ¡æ£€æŸ¥
            echo "ğŸ”§ å…³é”®æœåŠ¡æ£€æŸ¥:"
            
            # æ£€æŸ¥SSHæœåŠ¡
            if systemctl is-active --quiet sshd; then
              echo "âœ… SSHæœåŠ¡æ­£å¸¸è¿è¡Œ"
            else
              echo "âŒ SSHæœåŠ¡å¼‚å¸¸"
            fi
            
            # æ£€æŸ¥NginxæœåŠ¡
            if systemctl is-active --quiet nginx; then
              echo "âœ… NginxæœåŠ¡æ­£å¸¸è¿è¡Œ"
            else
              echo "âŒ NginxæœåŠ¡å¼‚å¸¸"
            fi
            
            # 4. ç£ç›˜ç©ºé—´æ£€æŸ¥
            echo "ğŸ’¾ ç£ç›˜ç©ºé—´æ£€æŸ¥:"
            DISK_USAGE=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
            if [ "$DISK_USAGE" -gt 90 ]; then
              echo "ğŸš¨ ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: ${DISK_USAGE}%"
            elif [ "$DISK_USAGE" -gt 80 ]; then
              echo "âš ï¸ ç£ç›˜ä½¿ç”¨ç‡è¾ƒé«˜: ${DISK_USAGE}%"
            else
              echo "âœ… ç£ç›˜ä½¿ç”¨ç‡æ­£å¸¸: ${DISK_USAGE}%"
            fi
            
            # 5. å†…å­˜ä½¿ç”¨æ£€æŸ¥
            echo "ğŸ§  å†…å­˜ä½¿ç”¨æ£€æŸ¥:"
            MEMORY_USAGE=$(free | awk 'NR==2{printf "%.2f", $3*100/$2}')
            if (( $(echo "$MEMORY_USAGE > 90" | bc -l) )); then
              echo "ğŸš¨ å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: ${MEMORY_USAGE}%"
            elif (( $(echo "$MEMORY_USAGE > 80" | bc -l) )); then
              echo "âš ï¸ å†…å­˜ä½¿ç”¨ç‡è¾ƒé«˜: ${MEMORY_USAGE}%"
            else
              echo "âœ… å†…å­˜ä½¿ç”¨ç‡æ­£å¸¸: ${MEMORY_USAGE}%"
            fi

      - name: NginxæœåŠ¡æ£€æŸ¥
        if: ${{ inputs.check_type == 'all' || inputs.check_type == 'nginx' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.parse-config.outputs.server_host || env.SERVER_HOST }}
          username: ${{ steps.parse-config.outputs.server_user || env.SERVER_USER }}
          key: ${{ steps.parse-config.outputs.server_key || env.SERVER_KEY }}
          port: ${{ steps.parse-config.outputs.server_port || env.SERVER_PORT }}
          script: |
            echo "ğŸ” NginxæœåŠ¡æ£€æŸ¥..."
            
            # 1. Nginxè¿›ç¨‹æ£€æŸ¥
            echo "ğŸ“Š Nginxè¿›ç¨‹æ£€æŸ¥:"
            if pgrep nginx > /dev/null; then
              echo "âœ… Nginxè¿›ç¨‹æ­£åœ¨è¿è¡Œ"
              NGINX_PIDS=$(pgrep nginx)
              echo "Nginxè¿›ç¨‹ID: $NGINX_PIDS"
            else
              echo "âŒ Nginxè¿›ç¨‹æœªè¿è¡Œ"
            fi
            
            # 2. Nginxé…ç½®æ£€æŸ¥
            echo "ğŸ“‹ Nginxé…ç½®æ£€æŸ¥:"
            if nginx -t > /dev/null 2>&1; then
              echo "âœ… Nginxé…ç½®è¯­æ³•æ­£ç¡®"
            else
              echo "âŒ Nginxé…ç½®è¯­æ³•é”™è¯¯"
              nginx -t
            fi
            
            # 3. Nginxç«¯å£æ£€æŸ¥
            echo "ğŸ”Œ Nginxç«¯å£æ£€æŸ¥:"
            if netstat -tlnp | grep -q ":80 "; then
              echo "âœ… HTTPç«¯å£(80)æ­£å¸¸ç›‘å¬"
            else
              echo "âŒ HTTPç«¯å£(80)æœªç›‘å¬"
            fi
            
            if netstat -tlnp | grep -q ":443 "; then
              echo "âœ… HTTPSç«¯å£(443)æ­£å¸¸ç›‘å¬"
            else
              echo "âŒ HTTPSç«¯å£(443)æœªç›‘å¬"
            fi
            
            # 4. Nginxé”™è¯¯æ—¥å¿—æ£€æŸ¥
            echo "ğŸ“ Nginxé”™è¯¯æ—¥å¿—æ£€æŸ¥:"
            if [ -f "/var/log/nginx/error.log" ]; then
              ERROR_COUNT=$(tail -n 100 /var/log/nginx/error.log | grep -c "error\|ERROR")
              if [ "$ERROR_COUNT" -gt 0 ]; then
                echo "âš ï¸ å‘ç° $ERROR_COUNT ä¸ªé”™è¯¯æ—¥å¿—æ¡ç›®"
                echo "æœ€è¿‘é”™è¯¯æ—¥å¿—:"
                tail -n 5 /var/log/nginx/error.log
              else
                echo "âœ… æ— é”™è¯¯æ—¥å¿—"
              fi
            else
              echo "âš ï¸ é”™è¯¯æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
            fi

      - name: éƒ¨ç½²çŠ¶æ€æ£€æŸ¥
        if: ${{ inputs.check_type == 'all' || inputs.check_type == 'deployments' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.parse-config.outputs.server_host || env.SERVER_HOST }}
          username: ${{ steps.parse-config.outputs.server_user || env.SERVER_USER }}
          key: ${{ steps.parse-config.outputs.server_key || env.SERVER_KEY }}
          port: ${{ steps.parse-config.outputs.server_port || env.SERVER_PORT }}
          script: |
            echo "ğŸ” éƒ¨ç½²çŠ¶æ€æ£€æŸ¥..."
            
            # 1. æ£€æŸ¥éƒ¨ç½²ç›®å½•
            echo "ğŸ“ éƒ¨ç½²ç›®å½•æ£€æŸ¥:"
            
            # æ£€æŸ¥é™æ€é¡¹ç›®
            STATIC_ROOT="/srv/static"
            if [ -d "$STATIC_ROOT" ]; then
              echo "ğŸ“‚ é™æ€é¡¹ç›®ç›®å½•: $STATIC_ROOT"
              for project in "$STATIC_ROOT"/*; do
                if [ -d "$project" ]; then
                  PROJECT_NAME=$(basename "$project")
                  FILE_COUNT=$(find "$project" -type f | wc -l)
                  if [ "$FILE_COUNT" -gt 0 ]; then
                    echo "  âœ… $PROJECT_NAME: $FILE_COUNT ä¸ªæ–‡ä»¶"
                  else
                    echo "  âš ï¸ $PROJECT_NAME: ç›®å½•ä¸ºç©º"
                  fi
                fi
              done
            else
              echo "âš ï¸ é™æ€é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $STATIC_ROOT"
            fi
            
            # æ£€æŸ¥åç«¯é¡¹ç›®
            APPS_ROOT="/srv/apps"
            if [ -d "$APPS_ROOT" ]; then
              echo "ğŸ“‚ åç«¯é¡¹ç›®ç›®å½•: $APPS_ROOT"
              for project in "$APPS_ROOT"/*; do
                if [ -d "$project" ]; then
                  PROJECT_NAME=$(basename "$project")
                  FILE_COUNT=$(find "$project" -type f | wc -l)
                  if [ "$FILE_COUNT" -gt 0 ]; then
                    echo "  âœ… $PROJECT_NAME: $FILE_COUNT ä¸ªæ–‡ä»¶"
                  else
                    echo "  âš ï¸ $PROJECT_NAME: ç›®å½•ä¸ºç©º"
                  fi
                fi
              done
            else
              echo "âš ï¸ åç«¯é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $APPS_ROOT"
            fi
            
            # 2. æ£€æŸ¥æœåŠ¡çŠ¶æ€
            echo "ğŸ”§ æœåŠ¡çŠ¶æ€æ£€æŸ¥:"
            
            # æ£€æŸ¥star-cloudæœåŠ¡
            if systemctl is-active --quiet star-cloud.service; then
              echo "âœ… star-cloudæœåŠ¡æ­£å¸¸è¿è¡Œ"
            else
              echo "âŒ star-cloudæœåŠ¡å¼‚å¸¸"
              systemctl status star-cloud.service --no-pager -l
            fi
            
            # 3. æ£€æŸ¥ç«¯å£ç›‘å¬
            echo "ğŸ”Œ ç«¯å£ç›‘å¬æ£€æŸ¥:"
            
            # æ£€æŸ¥åç«¯æœåŠ¡ç«¯å£
            if netstat -tlnp | grep -q ":8080 "; then
              echo "âœ… åç«¯æœåŠ¡ç«¯å£(8080)æ­£å¸¸ç›‘å¬"
            else
              echo "âŒ åç«¯æœåŠ¡ç«¯å£(8080)æœªç›‘å¬"
            fi

      - name: ç”Ÿæˆå¥åº·æ£€æŸ¥æŠ¥å‘Š
        run: |
          echo "ğŸ“Š å¥åº·æ£€æŸ¥æŠ¥å‘Š"
          echo "=================="
          echo "æ£€æŸ¥æ—¶é—´: $(date)"
          echo "æ£€æŸ¥ç±»å‹: ${{ inputs.check_type || 'all' }}"
          echo "æ£€æŸ¥ç»“æœ: å®Œæˆ"
          echo ""
          echo "âœ… å¥åº·æ£€æŸ¥å·²å®Œæˆï¼Œè¯·æŸ¥çœ‹ä¸Šè¿°æ—¥å¿—äº†è§£è¯¦ç»†ä¿¡æ¯"

  notify-health-status:
    needs: health-check
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: å¥åº·æ£€æŸ¥é€šçŸ¥
        run: |
          echo "ğŸ“¢ å¥åº·æ£€æŸ¥é€šçŸ¥"
          echo "=================="
          echo "æ£€æŸ¥æ—¶é—´: $(date)"
          echo "æ£€æŸ¥ç±»å‹: ${{ inputs.check_type || 'all' }}"
          
          if [ "${{ needs.health-check.result }}" = "success" ]; then
            echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
          fi
