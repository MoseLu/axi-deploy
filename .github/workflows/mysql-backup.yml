name: MySQL Backup

description: "MySQL æ•°æ®åº“å¤‡ä»½ - ä¸ºä½¿ç”¨ MySQL æ•°æ®åº“çš„åŽç«¯é¡¹ç›®æä¾›å¤‡ä»½æœºåˆ¶"

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
        description: "é¡¹ç›®åç§°"
      server_host:
        required: true
        type: string
        description: "æœåŠ¡å™¨åœ°å€"
      server_user:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç”¨æˆ·"
      server_key:
        required: true
        type: string
        description: "æœåŠ¡å™¨å¯†é’¥"
      server_port:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç«¯å£"
      apps_root:
        required: false
        type: string
        description: "åº”ç”¨ç›®å½•è·¯å¾„"
        default: "/srv/apps"
      backup_root:
        required: false
        type: string
        description: "å¤‡ä»½æ ¹ç›®å½•"
        default: "/srv/backups"
      mysql_config:
        required: false
        type: string
        description: "MySQL é…ç½®ï¼ˆbase64 ç¼–ç çš„ JSONï¼‰"
    outputs:
      backup_success:
        description: "å¤‡ä»½æ˜¯å¦æˆåŠŸ"
        value: ${{ jobs.backup.outputs.backup_success }}
      backup_path:
        description: "å¤‡ä»½è·¯å¾„"
        value: ${{ jobs.backup.outputs.backup_path }}

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    outputs:
      backup_success: ${{ steps.set-outputs.outputs.backup_success }}
      backup_path: ${{ steps.set-outputs.outputs.backup_path }}
    
    steps:
      - name: éªŒè¯è¾“å…¥å‚æ•°
        run: |
          echo "ðŸ” éªŒè¯è¾“å…¥å‚æ•°..."
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- æœåŠ¡å™¨: ${{ inputs.server_host }}:${{ inputs.server_port }}"
          echo "- ç”¨æˆ·: ${{ inputs.server_user }}"
          
          if [ -z "${{ inputs.mysql_config }}" ]; then
            echo "ðŸ“‹ æœªæä¾› MySQL é…ç½®ï¼Œè·³è¿‡æ•°æ®åº“å¤‡ä»½"
            echo "backup_success=true" >> $GITHUB_OUTPUT
            echo "backup_path=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… è¾“å…¥å‚æ•°éªŒè¯é€šè¿‡"

      - name: è§£æž MySQL é…ç½®
        id: parse-mysql-config
        run: |
          if [ -n "${{ inputs.mysql_config }}" ]; then
            echo "ðŸ” è§£æž MySQL é…ç½®..."
            MYSQL_CONFIG_JSON=$(echo "${{ inputs.mysql_config }}" | base64 -d)
            echo "ðŸ“„ MySQL é…ç½®: $MYSQL_CONFIG_JSON"
            
            # æå–å„ä¸ªå‚æ•°
            MYSQL_HOST=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.mysql_host // "localhost"')
            MYSQL_PORT=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.mysql_port // "3306"')
            MYSQL_USER=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.mysql_user // "root"')
            MYSQL_PASSWORD=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.mysql_password // ""')
            DATABASE_NAME=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.database_name // ""')
            BACKUP_METHOD=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.backup_method // "mysqldump"')
            BACKUP_RETENTION_DAYS=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.backup_retention_days // "30"')
            
            echo "mysql_host=$MYSQL_HOST" >> $GITHUB_OUTPUT
            echo "mysql_port=$MYSQL_PORT" >> $GITHUB_OUTPUT
            echo "mysql_user=$MYSQL_USER" >> $GITHUB_OUTPUT
            echo "mysql_password=$MYSQL_PASSWORD" >> $GITHUB_OUTPUT
            echo "database_name=$DATABASE_NAME" >> $GITHUB_OUTPUT
            echo "backup_method=$BACKUP_METHOD" >> $GITHUB_OUTPUT
            echo "backup_retention_days=$BACKUP_RETENTION_DAYS" >> $GITHUB_OUTPUT
            
            echo "âœ… MySQL é…ç½®è§£æžå®Œæˆ"
          else
            echo "ðŸ“‹ æœªæä¾› MySQL é…ç½®ï¼Œè·³è¿‡æ•°æ®åº“å¤‡ä»½"
            echo "mysql_host=localhost" >> $GITHUB_OUTPUT
            echo "mysql_port=3306" >> $GITHUB_OUTPUT
            echo "mysql_user=root" >> $GITHUB_OUTPUT
            echo "mysql_password=" >> $GITHUB_OUTPUT
            echo "database_name=" >> $GITHUB_OUTPUT
            echo "backup_method=mysqldump" >> $GITHUB_OUTPUT
            echo "backup_retention_days=30" >> $GITHUB_OUTPUT
          fi

      - name: MySQL æ•°æ®åº“å¤‡ä»½
        if: inputs.mysql_config != ''
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ðŸ—„ï¸ å¼€å§‹ MySQL æ•°æ®åº“å¤‡ä»½..."
            
            # è§£æž MySQL é…ç½®
            MYSQL_HOST="${{ steps.parse-mysql-config.outputs.mysql_host }}"
            MYSQL_PORT="${{ steps.parse-mysql-config.outputs.mysql_port }}"
            MYSQL_USER="${{ steps.parse-mysql-config.outputs.mysql_user }}"
            MYSQL_PASSWORD="${{ steps.parse-mysql-config.outputs.mysql_password }}"
            DATABASE_NAME="${{ steps.parse-mysql-config.outputs.database_name }}"
            BACKUP_METHOD="${{ steps.parse-mysql-config.outputs.backup_method }}"
            BACKUP_RETENTION_DAYS="${{ steps.parse-mysql-config.outputs.backup_retention_days }}"
            PROJECT="${{ inputs.project }}"
            APPS_ROOT="${{ inputs.apps_root }}"
            BACKUP_ROOT="${{ inputs.backup_root }}"
            
            echo "ðŸ“‹ MySQL é…ç½®:"
            echo "- ä¸»æœº: $MYSQL_HOST:$MYSQL_PORT"
            echo "- ç”¨æˆ·: $MYSQL_USER"
            echo "- æ•°æ®åº“: $DATABASE_NAME"
            echo "- å¤‡ä»½æ–¹æ³•: $BACKUP_METHOD"
            echo "- ä¿ç•™å¤©æ•°: $BACKUP_RETENTION_DAYS"
            
            # æ£€æŸ¥ MySQL è¿žæŽ¥
            echo "ðŸ” æ£€æŸ¥ MySQL è¿žæŽ¥..."
            echo "ðŸ” å¯†ç é•¿åº¦: ${#MYSQL_PASSWORD}"
            
            # å°è¯•ä»ŽæœåŠ¡å™¨é…ç½®ä¸­èŽ·å–å¯†ç 
            echo "ðŸ” å°è¯•ä»ŽæœåŠ¡å™¨é…ç½®èŽ·å– MySQL å¯†ç ..."
            SERVER_PASSWORD=""
            
            # æ£€æŸ¥ init-database.sh ä¸­çš„å¯†ç 
            if [ -f "/srv/apps/$PROJECT/scripts/init-database.sh" ]; then
              echo "ðŸ” æ£€æŸ¥ init-database.sh ä¸­çš„å¯†ç é…ç½®..."
              SERVER_PASSWORD=$(grep -o 'DB_PASSWORD="[^"]*"' "/srv/apps/$PROJECT/scripts/init-database.sh" | cut -d'"' -f2)
              if [ -n "$SERVER_PASSWORD" ]; then
                echo "âœ… ä»Ž init-database.sh èŽ·å–åˆ°å¯†ç "
              fi
            fi
            
            # æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„å¯†ç 
            if [ -z "$SERVER_PASSWORD" ] && [ -f "/srv/apps/$PROJECT/config/config.yaml" ]; then
              echo "ðŸ” æ£€æŸ¥ config.yaml ä¸­çš„å¯†ç é…ç½®..."
              SERVER_PASSWORD=$(grep -A5 "database:" "/srv/apps/$PROJECT/config/config.yaml" | grep "password:" | awk '{print $2}' | tr -d "'" | tr -d '"')
              if [ -n "$SERVER_PASSWORD" ]; then
                echo "âœ… ä»Ž config.yaml èŽ·å–åˆ°å¯†ç "
              fi
            fi
            
            # å°è¯•ä¸åŒçš„è¿žæŽ¥æ–¹å¼
            if [ -n "$MYSQL_PASSWORD" ]; then
              echo "ðŸ” å°è¯•ä½¿ç”¨ä¼ é€’çš„å¯†ç è¿žæŽ¥..."
              if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" -e "SELECT 1;" >/dev/null 2>&1; then
                echo "âœ… MySQL è¿žæŽ¥æˆåŠŸï¼ˆä½¿ç”¨ä¼ é€’çš„å¯†ç ï¼‰"
                MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASSWORD"
                MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASSWORD"
              elif [ -n "$SERVER_PASSWORD" ]; then
                echo "ðŸ” å°è¯•ä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç è¿žæŽ¥..."
                if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -p"$SERVER_PASSWORD" -e "SELECT 1;" >/dev/null 2>&1; then
                  echo "âœ… MySQL è¿žæŽ¥æˆåŠŸï¼ˆä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç ï¼‰"
                  MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                  MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                  # åˆ›å»ºä¸´æ—¶å¯†ç æ–‡ä»¶ï¼ˆæ›´å®‰å…¨çš„æ–¹å¼ï¼‰
                  echo "[client]" > /tmp/mysql.cnf
                  echo "password=$SERVER_PASSWORD" >> /tmp/mysql.cnf
                  chmod 600 /tmp/mysql.cnf
                  MYSQL_CMD="mysql --defaults-extra-file=/tmp/mysql.cnf -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                  MYSQLDUMP_CMD="mysqldump --defaults-extra-file=/tmp/mysql.cnf -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                else
                  echo "âŒ ä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç è¿žæŽ¥å¤±è´¥ï¼Œå°è¯•æ— å¯†ç è¿žæŽ¥..."
                  if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -e "SELECT 1;" >/dev/null 2>&1; then
                    echo "âœ… MySQL è¿žæŽ¥æˆåŠŸï¼ˆæ— å¯†ç ï¼‰"
                    MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                    MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                  else
                    echo "âŒ MySQL è¿žæŽ¥å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½"
                    exit 0
                  fi
                fi
              else
                echo "âŒ ä½¿ç”¨ä¼ é€’çš„å¯†ç è¿žæŽ¥å¤±è´¥ï¼Œå°è¯•æ— å¯†ç è¿žæŽ¥..."
                if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -e "SELECT 1;" >/dev/null 2>&1; then
                  echo "âœ… MySQL è¿žæŽ¥æˆåŠŸï¼ˆæ— å¯†ç ï¼‰"
                  MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                  MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                else
                  echo "âŒ MySQL è¿žæŽ¥å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½"
                  exit 0
                fi
              fi
            elif [ -n "$SERVER_PASSWORD" ]; then
              echo "ðŸ” å°è¯•ä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç è¿žæŽ¥..."
              if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -p"$SERVER_PASSWORD" -e "SELECT 1;" >/dev/null 2>&1; then
                echo "âœ… MySQL è¿žæŽ¥æˆåŠŸï¼ˆä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç ï¼‰"
                MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                # åˆ›å»ºä¸´æ—¶å¯†ç æ–‡ä»¶ï¼ˆæ›´å®‰å…¨çš„æ–¹å¼ï¼‰
                echo "[client]" > /tmp/mysql.cnf
                echo "password=$SERVER_PASSWORD" >> /tmp/mysql.cnf
                chmod 600 /tmp/mysql.cnf
                MYSQL_CMD="mysql --defaults-extra-file=/tmp/mysql.cnf -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                MYSQLDUMP_CMD="mysqldump --defaults-extra-file=/tmp/mysql.cnf -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
              else
                echo "âŒ ä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç è¿žæŽ¥å¤±è´¥ï¼Œå°è¯•æ— å¯†ç è¿žæŽ¥..."
                if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -e "SELECT 1;" >/dev/null 2>&1; then
                  echo "âœ… MySQL è¿žæŽ¥æˆåŠŸï¼ˆæ— å¯†ç ï¼‰"
                  MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                  MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                else
                  echo "âŒ MySQL è¿žæŽ¥å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½"
                  exit 0
                fi
              fi
            else
              echo "ðŸ” å°è¯•æ— å¯†ç è¿žæŽ¥..."
              if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -e "SELECT 1;" >/dev/null 2>&1; then
                echo "âœ… MySQL è¿žæŽ¥æˆåŠŸï¼ˆæ— å¯†ç ï¼‰"
                MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
              else
                echo "âŒ MySQL è¿žæŽ¥å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½"
                exit 0
              fi
            fi
            
            # åˆ›å»ºå¤‡ä»½ç›®å½•
            BACKUP_DIR="$BACKUP_ROOT/$PROJECT/mysql"
            sudo mkdir -p "$BACKUP_DIR"
            sudo chown -R $USER:$USER "$BACKUP_DIR"
            
            # æ‰§è¡Œå¤‡ä»½
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_FILE="$BACKUP_DIR/${DATABASE_NAME}_${TIMESTAMP}.sql"
            
            echo "ðŸ“¦ æ‰§è¡Œæ•°æ®åº“å¤‡ä»½..."
            if [ "$BACKUP_METHOD" = "mysqldump" ]; then
              $MYSQLDUMP_CMD \
                --single-transaction --routines --triggers --events \
                "$DATABASE_NAME" > "$BACKUP_FILE"
            else
              echo "âŒ ä¸æ”¯æŒçš„å¤‡ä»½æ–¹æ³•: $BACKUP_METHOD"
              exit 1
            fi
            
            if [ $? -eq 0 ]; then
              echo "âœ… æ•°æ®åº“å¤‡ä»½æˆåŠŸ: $BACKUP_FILE"
              
              # åŽ‹ç¼©å¤‡ä»½æ–‡ä»¶
              gzip "$BACKUP_FILE"
              echo "ðŸ“¦ å¤‡ä»½æ–‡ä»¶å·²åŽ‹ç¼©: ${BACKUP_FILE}.gz"
              
              # æ¸…ç†æ—§å¤‡ä»½
              echo "ðŸ§¹ æ¸…ç†è¿‡æœŸå¤‡ä»½æ–‡ä»¶..."
              find "$BACKUP_DIR" -name "*.sql.gz" -mtime +$BACKUP_RETENTION_DAYS -delete
              echo "âœ… è¿‡æœŸå¤‡ä»½æ–‡ä»¶å·²æ¸…ç†"
              
              # è®¾ç½®å®šæ—¶å¤‡ä»½ä»»åŠ¡
              if [ -n "$MYSQL_PASSWORD" ]; then
                CRON_JOB="0 2 * * * mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASSWORD --single-transaction --routines --triggers --events $DATABASE_NAME | gzip > $BACKUP_DIR/${DATABASE_NAME}_\$(date +\\%Y\\%m\\%d_\\%H\\%M\\%S).sql.gz"
              elif [ -n "$SERVER_PASSWORD" ]; then
                # åˆ›å»ºå®šæ—¶ä»»åŠ¡ä½¿ç”¨çš„å¯†ç æ–‡ä»¶
                echo "[client]" > /tmp/cron_mysql.cnf
                echo "password=$SERVER_PASSWORD" >> /tmp/cron_mysql.cnf
                chmod 600 /tmp/cron_mysql.cnf
                CRON_JOB="0 2 * * * mysqldump --defaults-extra-file=/tmp/cron_mysql.cnf -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER --single-transaction --routines --triggers --events $DATABASE_NAME | gzip > $BACKUP_DIR/${DATABASE_NAME}_\$(date +\\%Y\\%m\\%d_\\%H\\%M\\%S).sql.gz"
              else
                CRON_JOB="0 2 * * * mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER --single-transaction --routines --triggers --events $DATABASE_NAME | gzip > $BACKUP_DIR/${DATABASE_NAME}_\$(date +\\%Y\\%m\\%d_\\%H\\%M\\%S).sql.gz"
              fi
              
              # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å®šæ—¶ä»»åŠ¡
              if ! crontab -l 2>/dev/null | grep -q "$DATABASE_NAME"; then
                echo "â° è®¾ç½®å®šæ—¶å¤‡ä»½ä»»åŠ¡..."
                (crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -
                echo "âœ… å®šæ—¶å¤‡ä»½ä»»åŠ¡å·²è®¾ç½®"
              else
                echo "ðŸ“‹ å®šæ—¶å¤‡ä»½ä»»åŠ¡å·²å­˜åœ¨"
              fi
            else
              echo "âŒ æ•°æ®åº“å¤‡ä»½å¤±è´¥"
              exit 1
            fi

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          if [ -n "${{ inputs.mysql_config }}" ]; then
            echo "backup_success=true" >> $GITHUB_OUTPUT
            echo "backup_path=${{ inputs.backup_root }}/${{ inputs.project }}/mysql" >> $GITHUB_OUTPUT
            echo "âœ… MySQL å¤‡ä»½å®Œæˆ"
            echo "- backup_success: true"
            echo "- backup_path: ${{ inputs.backup_root }}/${{ inputs.project }}/mysql"
          else
            echo "backup_success=true" >> $GITHUB_OUTPUT
            echo "backup_path=" >> $GITHUB_OUTPUT
            echo "âœ… è·³è¿‡ MySQL å¤‡ä»½"
            echo "- backup_success: true"
            echo "- backup_path: (è·³è¿‡)"
          fi
