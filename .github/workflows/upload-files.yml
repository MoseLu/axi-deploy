name: Upload Files

description: "ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨ï¼ŒåŒ…å«é‡è¯•æœºåˆ¶"

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
        description: "é¡¹ç›®åç§°"
      server_host:
        required: true
        type: string
        description: "æœåŠ¡å™¨åœ°å€"
      server_user:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç”¨æˆ·"
      server_key:
        required: true
        type: string
        description: "æœåŠ¡å™¨å¯†é’¥"
      server_port:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç«¯å£"
      artifact_path:
        required: true
        type: string
        description: "æž„å»ºäº§ç‰©è·¯å¾„"
        default: "./dist"
      run_user:
        required: false
        type: string
        description: "è¿è¡Œç”¨æˆ·"
        default: "deploy"
    outputs:
      upload_success:
        description: "ä¸Šä¼ æ˜¯å¦æˆåŠŸ"
        value: ${{ jobs.upload.outputs.upload_success }}
      temp_dir:
        description: "æœåŠ¡å™¨ä¸´æ—¶ç›®å½•"
        value: ${{ jobs.upload.outputs.temp_dir }}

jobs:
  upload:
    runs-on: ubuntu-latest
    outputs:
      upload_success: ${{ steps.set-outputs.outputs.upload_success }}
      temp_dir: ${{ steps.set-outputs.outputs.temp_dir }}
    
    steps:
      - name: éªŒè¯è¾“å…¥å‚æ•°
        run: |
          echo "ðŸ” éªŒè¯è¾“å…¥å‚æ•°..."
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- æœåŠ¡å™¨: ${{ inputs.server_host }}:${{ inputs.server_port }}"
          echo "- ç”¨æˆ·: ${{ inputs.server_user }}"
          echo "- äº§ç‰©è·¯å¾„: ${{ inputs.artifact_path }}"
          
          if [ ! -d "${{ inputs.artifact_path }}" ]; then
            echo "ðŸš¨ æž„å»ºäº§ç‰©è·¯å¾„ä¸å­˜åœ¨: ${{ inputs.artifact_path }}"
            exit 1
          fi
          
          echo "âœ… è¾“å…¥å‚æ•°éªŒè¯é€šè¿‡"
          
          echo "ðŸ“ æž„å»ºäº§ç‰©ç›®å½•å†…å®¹:"
          ls -la "${{ inputs.artifact_path }}/"
          
          echo "ðŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
          FILE_COUNT=$(find "${{ inputs.artifact_path }}" -type f | wc -l)
          echo "æ–‡ä»¶æ•°é‡: $FILE_COUNT"
          
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "ðŸš¨ æž„å»ºäº§ç‰©ç›®å½•ä¸ºç©ºï¼Œç»ˆæ­¢ä¸Šä¼ "
            exit 1
          fi
          
          echo "âœ… æž„å»ºäº§ç‰©éªŒè¯é€šè¿‡ï¼Œæ–‡ä»¶æ•°é‡: $FILE_COUNT"

      - name: åˆ›å»ºä¸´æ—¶ç›®å½•
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ðŸ“ åˆ›å»ºä¸´æ—¶ç›®å½•..."
            
            TEMP_DIR="/tmp/${{ inputs.project }}"
            
            # æ¸…ç†æ—§çš„ä¸´æ—¶ç›®å½•
            if [ -d "$TEMP_DIR" ]; then
              echo "ðŸ§¹ æ¸…ç†æ—§çš„ä¸´æ—¶ç›®å½•: $TEMP_DIR"
              sudo rm -rf "$TEMP_DIR"
            fi
            
            # åˆ›å»ºæ–°çš„ä¸´æ—¶ç›®å½•
            sudo mkdir -p $TEMP_DIR
            sudo chown ${{ inputs.run_user || 'deploy' }}:${{ inputs.run_user || 'deploy' }} $TEMP_DIR
            
            echo "âœ… ä¸´æ—¶ç›®å½•å·²åˆ›å»º: $TEMP_DIR"
            echo "ðŸ“ ä¸´æ—¶ç›®å½•æƒé™:"
            ls -la /tmp/ | grep "${{ inputs.project }}" || echo "ä¸´æ—¶ç›®å½•å°šæœªåˆ›å»º"

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          source: "${{ github.workspace }}/${{ inputs.artifact_path }}"
          target: "/tmp/${{ inputs.project }}/"

      - name: éªŒè¯ä¸Šä¼ ç»“æžœ
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ðŸ” éªŒè¯ä¸Šä¼ æ–‡ä»¶..."
            TEMP_DIR="/tmp/${{ inputs.project }}"
            
            if [ ! -d "$TEMP_DIR" ]; then
              echo "ðŸš¨ ä¸´æ—¶ç›®å½•ä¸å­˜åœ¨: $TEMP_DIR"
              echo "ðŸ“ /tmp ç›®å½•å†…å®¹:"
              ls -la /tmp/
              exit 1
            fi
            
            echo "âœ… ä¸´æ—¶ç›®å½•å­˜åœ¨: $TEMP_DIR"
            echo "ðŸ“ ä¸´æ—¶ç›®å½•å†…å®¹:"
            ls -la $TEMP_DIR/
            
            # æ£€æŸ¥æ–‡ä»¶æ•°é‡
            FILE_COUNT=$(find $TEMP_DIR -type f | wc -l)
            echo "ðŸ“Š æ–‡ä»¶æ•°é‡: $FILE_COUNT"
            
            if [ "$FILE_COUNT" -eq 0 ]; then
              echo "ðŸš¨ ä¸´æ—¶ç›®å½•ä¸ºç©ºï¼Œä¸Šä¼ å¤±è´¥"
              echo "ðŸ” è°ƒè¯•ä¿¡æ¯:"
              echo "ä¸´æ—¶ç›®å½•: $TEMP_DIR"
              echo "ç›®å½•æ˜¯å¦å­˜åœ¨: $(test -d "$TEMP_DIR" && echo 'æ˜¯' || echo 'å¦')"
              echo "ç›®å½•æƒé™: $(ls -ld "$TEMP_DIR" 2>/dev/null || echo 'æ— æ³•èŽ·å–æƒé™')"
              echo "ç›®å½•å†…å®¹:"
              ls -la "$TEMP_DIR/" || echo "æ— æ³•åˆ—å‡ºç›®å½•å†…å®¹"
              exit 1
            fi
            
            echo "âœ… æ–‡ä»¶ä¸Šä¼ éªŒè¯é€šè¿‡ï¼Œæ–‡ä»¶æ•°é‡: $FILE_COUNT"
            
            # æ£€æŸ¥å…³é”®æ–‡ä»¶
            if [ -f "$TEMP_DIR/index.html" ]; then
              echo "âœ… æ‰¾åˆ° index.html æ–‡ä»¶"
            else
              echo "âš ï¸ æœªæ‰¾åˆ° index.html æ–‡ä»¶"
              echo "ðŸ“ ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨:"
              find "$TEMP_DIR" -type f | head -10
            fi

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          echo "upload_success=true" >> $GITHUB_OUTPUT
          echo "temp_dir=/tmp/${{ inputs.project }}" >> $GITHUB_OUTPUT
          echo "âœ… è¾“å‡ºå·²è®¾ç½®"
          echo "- upload_success: true"
          echo "- temp_dir: /tmp/${{ inputs.project }}"
