name: Deployment Summary

description: "éƒ¨ç½²å®Œæˆæ€»ç»“ - æ˜¾ç¤ºéƒ¨ç½²ç»“æœå’ŒçŠ¶æ€ä¿¡æ¯"

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
        description: "é¡¹ç›®åç§°"
      deploy_type:
        required: true
        type: string
        description: "éƒ¨ç½²ç±»å‹"
      source_repo:
        required: true
        type: string
        description: "æºä»“åº“"
      run_id:
        required: true
        type: string
        description: "æ„å»ºè¿è¡ŒID"
      test_url:
        required: false
        type: string
        description: "æµ‹è¯•URL"
        default: ""
      deploy_path:
        required: false
        type: string
        description: "éƒ¨ç½²è·¯å¾„"
        default: ""
      parse_secrets_result:
        required: false
        type: string
        description: "è§£æå¯†é’¥ç»“æœ"
        default: ""
      server_init_result:
        required: false
        type: string
        description: "æœåŠ¡å™¨åˆå§‹åŒ–ç»“æœ"
        default: ""
      validate_artifact_result:
        required: false
        type: string
        description: "éªŒè¯æ„å»ºäº§ç‰©ç»“æœ"
        default: ""
      deploy_project_result:
        required: false
        type: string
        description: "éƒ¨ç½²é¡¹ç›®ç»“æœ"
        default: ""
      configure_nginx_result:
        required: false
        type: string
        description: "é…ç½®Nginxç»“æœ"
        default: ""
      start_service_result:
        required: false
        type: string
        description: "å¯åŠ¨æœåŠ¡ç»“æœ"
        default: ""
      test_website_static_result:
        required: false
        type: string
        description: "æµ‹è¯•ç½‘ç«™(é™æ€)ç»“æœ"
        default: ""
      test_website_backend_result:
        required: false
        type: string
        description: "æµ‹è¯•ç½‘ç«™(åç«¯)ç»“æœ"
        default: ""

jobs:
  summary:
    runs-on: ubuntu-latest
    timeout-minutes: 5  # éƒ¨ç½²æ€»ç»“è¶…æ—¶æ—¶é—´
    steps:
      - name: éƒ¨ç½²å®Œæˆæ€»ç»“
        run: |
          echo "ğŸ‰ éƒ¨ç½²æµç¨‹å®Œæˆ"
          echo "=========================================="
          echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯:"
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- éƒ¨ç½²ç±»å‹: ${{ inputs.deploy_type }}"
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- æ„å»ºID: ${{ inputs.run_id }}"
          echo ""
          echo "ğŸ“Š æ‰§è¡ŒçŠ¶æ€:"
          echo "- è§£æå¯†é’¥: ${{ inputs.parse_secrets_result }}"
          echo "- æœåŠ¡å™¨åˆå§‹åŒ–: ${{ inputs.server_init_result || 'skipped' }}"
          echo "- éªŒè¯æ„å»ºäº§ç‰©: ${{ inputs.validate_artifact_result }}"
          echo "- éƒ¨ç½²é¡¹ç›®: ${{ inputs.deploy_project_result }}"
          echo "- é…ç½®Nginx: ${{ inputs.configure_nginx_result || 'skipped' }}"
          echo "- å¯åŠ¨æœåŠ¡: ${{ inputs.start_service_result || 'skipped' }}"
          echo "- æµ‹è¯•ç½‘ç«™(é™æ€): ${{ inputs.test_website_static_result || 'skipped' }}"
          echo "- æµ‹è¯•ç½‘ç«™(åç«¯): ${{ inputs.test_website_backend_result || 'skipped' }}"
          echo ""
          
          # æ£€æŸ¥å…³é”®æ­¥éª¤æ˜¯å¦æˆåŠŸ
          CRITICAL_FAILURES=()
          
          if [ "${{ inputs.parse_secrets_result }}" = "failure" ]; then
            CRITICAL_FAILURES+=("è§£æå¯†é’¥å¤±è´¥")
          fi
          
          if [ "${{ inputs.validate_artifact_result }}" = "failure" ]; then
            CRITICAL_FAILURES+=("éªŒè¯æ„å»ºäº§ç‰©å¤±è´¥")
          fi
          
          if [ "${{ inputs.deploy_project_result }}" = "failure" ]; then
            CRITICAL_FAILURES+=("éƒ¨ç½²é¡¹ç›®å¤±è´¥")
          fi
          
          if [ "${{ inputs.configure_nginx_result }}" = "failure" ]; then
            CRITICAL_FAILURES+=("é…ç½®Nginxå¤±è´¥")
          fi
          
          if [ "${{ inputs.deploy_type }}" = "backend" ] && [ "${{ inputs.start_service_result }}" = "failure" ]; then
            CRITICAL_FAILURES+=("å¯åŠ¨æœåŠ¡å¤±è´¥")
          fi
          
          # æ£€æŸ¥æµ‹è¯•ç»“æœ
          TEST_FAILURE=""
          if [ "${{ inputs.deploy_type }}" = "backend" ] && [ "${{ inputs.test_website_backend_result }}" = "failure" ]; then
            TEST_FAILURE="åç«¯ç½‘ç«™æµ‹è¯•å¤±è´¥"
          elif [ "${{ inputs.deploy_type }}" = "static" ] && [ "${{ inputs.test_website_static_result }}" = "failure" ]; then
            TEST_FAILURE="é™æ€ç½‘ç«™æµ‹è¯•å¤±è´¥"
          fi
          
          # æ˜¾ç¤ºç»“æœ
          if [ ${#CRITICAL_FAILURES[@]} -gt 0 ]; then
            echo "ğŸš¨ éƒ¨ç½²å¤±è´¥ - å…³é”®æ­¥éª¤å¤±è´¥:"
            for failure in "${CRITICAL_FAILURES[@]}"; do
              echo "  - $failure"
            done
            echo ""
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°é”™è¯¯å¹¶é‡æ–°éƒ¨ç½²"
            exit 1
          elif [ -n "$TEST_FAILURE" ]; then
            echo "âš ï¸ éƒ¨ç½²éƒ¨åˆ†æˆåŠŸ - $TEST_FAILURE"
            echo ""
            echo "ğŸ” å¯èƒ½çš„åŸå› :"
            if [ "${{ inputs.deploy_type }}" = "backend" ]; then
              echo "1. åç«¯æœåŠ¡å¯åŠ¨å¤±è´¥"
              echo "2. ç«¯å£é…ç½®é”™è¯¯"
              echo "3. ä¾èµ–å®‰è£…ä¸å®Œæ•´"
              echo "4. ç¯å¢ƒå˜é‡é…ç½®é”™è¯¯"
              echo "5. PM2è¿›ç¨‹ç®¡ç†é—®é¢˜"
            else
              echo "1. é™æ€æ–‡ä»¶éƒ¨ç½²ä¸å®Œæ•´"
              echo "2. Nginxé…ç½®é”™è¯¯"
              echo "3. åŸŸåè§£æé—®é¢˜"
              echo "4. SSLè¯ä¹¦é—®é¢˜"
            fi
            echo ""
            echo "ğŸ’¡ å»ºè®®:"
            echo "- æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
            echo "- éªŒè¯æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨"
            echo "- ç¡®è®¤ç½‘ç»œå’Œé˜²ç«å¢™é…ç½®"
            echo ""
            echo "âœ… é¡¹ç›®æ–‡ä»¶å·²éƒ¨ç½²ï¼Œä½†æœåŠ¡å¯èƒ½æœªæ­£å¸¸è¿è¡Œ"
          else
            echo "âœ… æ‰€æœ‰æ­¥éª¤æ‰§è¡ŒæˆåŠŸ"
            echo ""
            echo "ğŸ‰ éƒ¨ç½²å®Œå…¨æˆåŠŸï¼"
          fi
          
          echo ""
          echo "ğŸ”— è®¿é—®ä¿¡æ¯:"
          echo "- åŸŸå: redamancy.com.cn"
          if [ "${{ inputs.deploy_path }}" != "" ]; then
            echo "- é¡¹ç›®è·¯å¾„: ${{ inputs.deploy_path }}"
          fi
          if [ "${{ inputs.test_url }}" != "" ]; then
            echo "- æµ‹è¯•URL: ${{ inputs.test_url }}"
          fi
          echo ""
          
          if [ ${#CRITICAL_FAILURES[@]} -gt 0 ]; then
            echo "ğŸ“ éƒ¨ç½²å¤±è´¥é€šçŸ¥:"
            echo "âŒ é¡¹ç›® ${{ inputs.project }} éƒ¨ç½²å¤±è´¥"
            echo "è¯·æ£€æŸ¥ä¸Šè¿°é”™è¯¯ä¿¡æ¯å¹¶é‡æ–°éƒ¨ç½²"
          elif [ -n "$TEST_FAILURE" ]; then
            echo "ğŸ“ éƒ¨ç½²éƒ¨åˆ†æˆåŠŸé€šçŸ¥:"
            echo "âš ï¸ é¡¹ç›® ${{ inputs.project }} å·²éƒ¨ç½²ä½†æµ‹è¯•å¤±è´¥"
            echo "è¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€å’Œé…ç½®"
            if [ "${{ inputs.test_url }}" != "" ]; then
              echo "ğŸŒ æµ‹è¯•URL: ${{ inputs.test_url }}"
            fi
          else
            echo "ğŸ“ éƒ¨ç½²å®Œæˆé€šçŸ¥:"
            echo "âœ… é¡¹ç›® ${{ inputs.project }} å·²æˆåŠŸéƒ¨ç½²åˆ°æœåŠ¡å™¨"
            if [ "${{ inputs.test_url }}" != "" ]; then
              echo "ğŸŒ å¯é€šè¿‡ ${{ inputs.test_url }} è®¿é—®"
            fi
          fi
          echo "=========================================="
