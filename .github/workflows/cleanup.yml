name: Cleanup

description: "æ¸…ç†å·¥ä½œæµ - æ¸…ç†æ—§çš„å¤‡ä»½å’Œæ—¥å¿—æ–‡ä»¶"

on:
  schedule:
    # æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹æ‰§è¡Œæ¸…ç†
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      cleanup_type:
        description: 'æ¸…ç†ç±»å‹'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - backups
          - logs
          - temp
      retention_days:
        description: 'ä¿ç•™å¤©æ•°'
        required: false
        default: '30'
        type: string
      server_host:
        description: 'æœåŠ¡å™¨åœ°å€'
        required: false
        type: string
      server_user:
        description: 'æœåŠ¡å™¨ç”¨æˆ·'
        required: false
        type: string
      server_key:
        description: 'æœåŠ¡å™¨å¯†é’¥'
        required: false
        type: string
      server_port:
        description: 'æœåŠ¡å™¨ç«¯å£'
        required: false
        default: '22'
        type: string

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: è§£ææœåŠ¡å™¨é…ç½®
        id: parse-config
        run: |
          echo "ğŸ” è§£ææœåŠ¡å™¨é…ç½®..."
          
          # ä»è¾“å…¥å‚æ•°æˆ–ç¯å¢ƒå˜é‡è·å–é…ç½®
          SERVER_HOST="${{ inputs.server_host || secrets.SERVER_HOST }}"
          SERVER_USER="${{ inputs.server_user || secrets.SERVER_USER }}"
          SERVER_KEY="${{ inputs.server_key || secrets.SERVER_KEY }}"
          SERVER_PORT="${{ inputs.server_port || secrets.SERVER_PORT || '22' }}"
          
          if [ -z "$SERVER_HOST" ] || [ -z "$SERVER_USER" ] || [ -z "$SERVER_KEY" ]; then
            echo "ğŸš¨ ç¼ºå°‘æœåŠ¡å™¨é…ç½®ä¿¡æ¯"
            exit 1
          fi
          
          echo "âœ… æœåŠ¡å™¨é…ç½®è§£æå®Œæˆ"

      - name: æ¸…ç†æ—§å¤‡ä»½
        if: ${{ inputs.cleanup_type == 'all' || inputs.cleanup_type == 'backups' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.parse-config.outputs.server_host || env.SERVER_HOST }}
          username: ${{ steps.parse-config.outputs.server_user || env.SERVER_USER }}
          key: ${{ steps.parse-config.outputs.server_key || env.SERVER_KEY }}
          port: ${{ steps.parse-config.outputs.server_port || env.SERVER_PORT }}
          script: |
            echo "ğŸ§¹ æ¸…ç†æ—§å¤‡ä»½..."
            
            RETENTION_DAYS="${{ inputs.retention_days || '30' }}"
            CUTOFF_DATE=$(date -d "$RETENTION_DAYS days ago" +%Y%m%d)
            
            echo "ğŸ“… ä¿ç•™å¤©æ•°: $RETENTION_DAYS"
            echo "ğŸ“… æˆªæ­¢æ—¥æœŸ: $CUTOFF_DATE"
            
            # æ¸…ç†åº”ç”¨å¤‡ä»½
            APPS_BACKUP_DIR="/srv/backups/apps"
            if [ -d "$APPS_BACKUP_DIR" ]; then
              echo "ğŸ“ æ¸…ç†åº”ç”¨å¤‡ä»½ç›®å½•: $APPS_BACKUP_DIR"
              
              # æŸ¥æ‰¾éœ€è¦æ¸…ç†çš„å¤‡ä»½
              OLD_BACKUPS=$(find "$APPS_BACKUP_DIR" -type d -name "*.backup.*" -printf "%T@ %p\n" | sort -n | while read timestamp path; do
                BACKUP_DATE=$(echo "$path" | grep -o '[0-9]\{8\}' | head -1)
                if [ -n "$BACKUP_DATE" ] && [ "$BACKUP_DATE" -lt "$CUTOFF_DATE" ]; then
                  echo "$path"
                fi
              done)
              
              if [ -n "$OLD_BACKUPS" ]; then
                echo "ğŸ—‘ï¸ åˆ é™¤æ—§çš„åº”ç”¨å¤‡ä»½:"
                echo "$OLD_BACKUPS" | while read -r backup; do
                  BACKUP_SIZE=$(du -sh "$backup" | cut -f1)
                  echo "  ğŸ“¦ $(basename "$backup") ($BACKUP_SIZE)"
                  sudo rm -rf "$backup"
                done
                echo "âœ… åº”ç”¨å¤‡ä»½æ¸…ç†å®Œæˆ"
              else
                echo "ğŸ“‹ æ²¡æœ‰éœ€è¦æ¸…ç†çš„åº”ç”¨å¤‡ä»½"
              fi
            else
              echo "âš ï¸ åº”ç”¨å¤‡ä»½ç›®å½•ä¸å­˜åœ¨: $APPS_BACKUP_DIR"
            fi
            
            # æ¸…ç†é™æ€æ–‡ä»¶å¤‡ä»½
            STATIC_BACKUP_DIR="/srv/backups/static"
            if [ -d "$STATIC_BACKUP_DIR" ]; then
              echo "ğŸ“ æ¸…ç†é™æ€æ–‡ä»¶å¤‡ä»½ç›®å½•: $STATIC_BACKUP_DIR"
              
              # æŸ¥æ‰¾éœ€è¦æ¸…ç†çš„å¤‡ä»½
              OLD_BACKUPS=$(find "$STATIC_BACKUP_DIR" -type d -name "*.backup.*" -printf "%T@ %p\n" | sort -n | while read timestamp path; do
                BACKUP_DATE=$(echo "$path" | grep -o '[0-9]\{8\}' | head -1)
                if [ -n "$BACKUP_DATE" ] && [ "$BACKUP_DATE" -lt "$CUTOFF_DATE" ]; then
                  echo "$path"
                fi
              done)
              
              if [ -n "$OLD_BACKUPS" ]; then
                echo "ğŸ—‘ï¸ åˆ é™¤æ—§çš„é™æ€æ–‡ä»¶å¤‡ä»½:"
                echo "$OLD_BACKUPS" | while read -r backup; do
                  BACKUP_SIZE=$(du -sh "$backup" | cut -f1)
                  echo "  ğŸ“¦ $(basename "$backup") ($BACKUP_SIZE)"
                  sudo rm -rf "$backup"
                done
                echo "âœ… é™æ€æ–‡ä»¶å¤‡ä»½æ¸…ç†å®Œæˆ"
              else
                echo "ğŸ“‹ æ²¡æœ‰éœ€è¦æ¸…ç†çš„é™æ€æ–‡ä»¶å¤‡ä»½"
              fi
            else
              echo "âš ï¸ é™æ€æ–‡ä»¶å¤‡ä»½ç›®å½•ä¸å­˜åœ¨: $STATIC_BACKUP_DIR"
            fi
            
            # æ¸…ç†Nginxé…ç½®å¤‡ä»½
            NGINX_BACKUP_DIR="/www/server/nginx/conf/conf.d/redamancy/backups"
            if [ -d "$NGINX_BACKUP_DIR" ]; then
              echo "ğŸ“ æ¸…ç†Nginxé…ç½®å¤‡ä»½ç›®å½•: $NGINX_BACKUP_DIR"
              
              # æŸ¥æ‰¾éœ€è¦æ¸…ç†çš„å¤‡ä»½
              OLD_BACKUPS=$(find "$NGINX_BACKUP_DIR" -type f -name "*.backup.*" -printf "%T@ %p\n" | sort -n | while read timestamp path; do
                BACKUP_DATE=$(echo "$path" | grep -o '[0-9]\{8\}' | head -1)
                if [ -n "$BACKUP_DATE" ] && [ "$BACKUP_DATE" -lt "$CUTOFF_DATE" ]; then
                  echo "$path"
                fi
              done)
              
              if [ -n "$OLD_BACKUPS" ]; then
                echo "ğŸ—‘ï¸ åˆ é™¤æ—§çš„Nginxé…ç½®å¤‡ä»½:"
                echo "$OLD_BACKUPS" | while read -r backup; do
                  BACKUP_SIZE=$(du -sh "$backup" | cut -f1)
                  echo "  ğŸ“¦ $(basename "$backup") ($BACKUP_SIZE)"
                  sudo rm -f "$backup"
                done
                echo "âœ… Nginxé…ç½®å¤‡ä»½æ¸…ç†å®Œæˆ"
              else
                echo "ğŸ“‹ æ²¡æœ‰éœ€è¦æ¸…ç†çš„Nginxé…ç½®å¤‡ä»½"
              fi
            else
              echo "âš ï¸ Nginxé…ç½®å¤‡ä»½ç›®å½•ä¸å­˜åœ¨: $NGINX_BACKUP_DIR"
            fi

      - name: æ¸…ç†æ—¥å¿—æ–‡ä»¶
        if: ${{ inputs.cleanup_type == 'all' || inputs.cleanup_type == 'logs' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.parse-config.outputs.server_host || env.SERVER_HOST }}
          username: ${{ steps.parse-config.outputs.server_user || env.SERVER_USER }}
          key: ${{ steps.parse-config.outputs.server_key || env.SERVER_KEY }}
          port: ${{ steps.parse-config.outputs.server_port || env.SERVER_PORT }}
          script: |
            echo "ğŸ§¹ æ¸…ç†æ—¥å¿—æ–‡ä»¶..."
            
            RETENTION_DAYS="${{ inputs.retention_days || '30' }}"
            
            echo "ğŸ“… ä¿ç•™å¤©æ•°: $RETENTION_DAYS"
            
            # æ¸…ç†Nginxæ—¥å¿—
            NGINX_LOG_DIR="/var/log/nginx"
            if [ -d "$NGINX_LOG_DIR" ]; then
              echo "ğŸ“ æ¸…ç†Nginxæ—¥å¿—ç›®å½•: $NGINX_LOG_DIR"
              
              # æŸ¥æ‰¾éœ€è¦æ¸…ç†çš„æ—¥å¿—æ–‡ä»¶
              OLD_LOGS=$(find "$NGINX_LOG_DIR" -type f -name "*.log.*" -mtime +$RETENTION_DAYS)
              
              if [ -n "$OLD_LOGS" ]; then
                echo "ğŸ—‘ï¸ åˆ é™¤æ—§çš„Nginxæ—¥å¿—æ–‡ä»¶:"
                echo "$OLD_LOGS" | while read -r log; do
                  LOG_SIZE=$(du -sh "$log" | cut -f1)
                  echo "  ğŸ“„ $(basename "$log") ($LOG_SIZE)"
                  sudo rm -f "$log"
                done
                echo "âœ… Nginxæ—¥å¿—æ¸…ç†å®Œæˆ"
              else
                echo "ğŸ“‹ æ²¡æœ‰éœ€è¦æ¸…ç†çš„Nginxæ—¥å¿—æ–‡ä»¶"
              fi
            else
              echo "âš ï¸ Nginxæ—¥å¿—ç›®å½•ä¸å­˜åœ¨: $NGINX_LOG_DIR"
            fi
            
            # æ¸…ç†ç³»ç»Ÿæ—¥å¿—
            SYSTEM_LOG_DIR="/var/log"
            if [ -d "$SYSTEM_LOG_DIR" ]; then
              echo "ğŸ“ æ¸…ç†ç³»ç»Ÿæ—¥å¿—ç›®å½•: $SYSTEM_LOG_DIR"
              
              # æŸ¥æ‰¾éœ€è¦æ¸…ç†çš„æ—¥å¿—æ–‡ä»¶
              OLD_LOGS=$(find "$SYSTEM_LOG_DIR" -type f \( -name "*.log.*" -o -name "*.gz" \) -mtime +$RETENTION_DAYS | grep -E "(nginx|apache|system)" | head -20)
              
              if [ -n "$OLD_LOGS" ]; then
                echo "ğŸ—‘ï¸ åˆ é™¤æ—§çš„ç³»ç»Ÿæ—¥å¿—æ–‡ä»¶:"
                echo "$OLD_LOGS" | while read -r log; do
                  LOG_SIZE=$(du -sh "$log" | cut -f1)
                  echo "  ğŸ“„ $(basename "$log") ($LOG_SIZE)"
                  sudo rm -f "$log"
                done
                echo "âœ… ç³»ç»Ÿæ—¥å¿—æ¸…ç†å®Œæˆ"
              else
                echo "ğŸ“‹ æ²¡æœ‰éœ€è¦æ¸…ç†çš„ç³»ç»Ÿæ—¥å¿—æ–‡ä»¶"
              fi
            else
              echo "âš ï¸ ç³»ç»Ÿæ—¥å¿—ç›®å½•ä¸å­˜åœ¨: $SYSTEM_LOG_DIR"
            fi

      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: ${{ inputs.cleanup_type == 'all' || inputs.cleanup_type == 'temp' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.parse-config.outputs.server_host || env.SERVER_HOST }}
          username: ${{ steps.parse-config.outputs.server_user || env.SERVER_USER }}
          key: ${{ steps.parse-config.outputs.server_key || env.SERVER_KEY }}
          port: ${{ steps.parse-config.outputs.server_port || env.SERVER_PORT }}
          script: |
            echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
            
            # æ¸…ç†/tmpç›®å½•
            echo "ğŸ“ æ¸…ç†/tmpç›®å½•..."
            TEMP_FILES=$(find /tmp -type f -mtime +7 -not -path "/tmp/systemd-*" | head -50)
            
            if [ -n "$TEMP_FILES" ]; then
              echo "ğŸ—‘ï¸ åˆ é™¤æ—§çš„ä¸´æ—¶æ–‡ä»¶:"
              echo "$TEMP_FILES" | while read -r file; do
                if [ -f "$file" ]; then
                  FILE_SIZE=$(du -sh "$file" | cut -f1)
                  echo "  ğŸ“„ $(basename "$file") ($FILE_SIZE)"
                  sudo rm -f "$file"
                fi
              done
              echo "âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
            else
              echo "ğŸ“‹ æ²¡æœ‰éœ€è¦æ¸…ç†çš„ä¸´æ—¶æ–‡ä»¶"
            fi
            
            # æ¸…ç†éƒ¨ç½²ç›¸å…³çš„ä¸´æ—¶ç›®å½•
            echo "ğŸ“ æ¸…ç†éƒ¨ç½²ä¸´æ—¶ç›®å½•..."
            DEPLOY_TEMP_DIRS=$(find /tmp -type d -name "*deploy*" -mtime +1 2>/dev/null)
            
            if [ -n "$DEPLOY_TEMP_DIRS" ]; then
              echo "ğŸ—‘ï¸ åˆ é™¤éƒ¨ç½²ä¸´æ—¶ç›®å½•:"
              echo "$DEPLOY_TEMP_DIRS" | while read -r dir; do
                if [ -d "$dir" ]; then
                  DIR_SIZE=$(du -sh "$dir" | cut -f1)
                  echo "  ğŸ“ $(basename "$dir") ($DIR_SIZE)"
                  sudo rm -rf "$dir"
                fi
              done
              echo "âœ… éƒ¨ç½²ä¸´æ—¶ç›®å½•æ¸…ç†å®Œæˆ"
            else
              echo "ğŸ“‹ æ²¡æœ‰éœ€è¦æ¸…ç†çš„éƒ¨ç½²ä¸´æ—¶ç›®å½•"
            fi

      - name: ç”Ÿæˆæ¸…ç†æŠ¥å‘Š
        run: |
          echo "ğŸ“Š æ¸…ç†æŠ¥å‘Š"
          echo "============"
          echo "æ¸…ç†æ—¶é—´: $(date)"
          echo "æ¸…ç†ç±»å‹: ${{ inputs.cleanup_type || 'all' }}"
          echo "ä¿ç•™å¤©æ•°: ${{ inputs.retention_days || '30' }}"
          echo "æ¸…ç†ç»“æœ: å®Œæˆ"
          echo ""
          echo "âœ… æ¸…ç†å·¥ä½œå·²å®Œæˆï¼Œè¯·æŸ¥çœ‹ä¸Šè¿°æ—¥å¿—äº†è§£è¯¦ç»†ä¿¡æ¯"

  notify-cleanup:
    needs: cleanup
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: æ¸…ç†é€šçŸ¥
        run: |
          echo "ğŸ“¢ æ¸…ç†é€šçŸ¥"
          echo "============"
          echo "æ¸…ç†æ—¶é—´: $(date)"
          echo "æ¸…ç†ç±»å‹: ${{ inputs.cleanup_type || 'all' }}"
          echo "ä¿ç•™å¤©æ•°: ${{ inputs.retention_days || '30' }}"
          
          if [ "${{ needs.cleanup.result }}" = "success" ]; then
            echo "âœ… æ¸…ç†æˆåŠŸ"
          else
            echo "âŒ æ¸…ç†å¤±è´¥"
          fi
