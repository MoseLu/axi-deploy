name: Deploy Dispatch

on:
  workflow_dispatch:
    inputs:
      # è°ƒç”¨æ–¹ä¿¡æ¯
      caller_repo:
        description: 'è°ƒç”¨æ–¹ä»“åº“åç§°'
        required: true
        type: string
      caller_branch:
        description: 'è°ƒç”¨æ–¹åˆ†æ”¯åç§°'
        required: true
        type: string
      caller_commit:
        description: 'è°ƒç”¨æ–¹æäº¤å“ˆå¸Œ'
        required: true
        type: string
      
      # éƒ¨ç½²é…ç½®
      source_path:
        description: 'æœ¬åœ°æ–‡ä»¶è·¯å¾„'
        required: false
        type: string
        default: './dist'
      target_path:
        description: 'è¿œç¨‹ç›®æ ‡è·¯å¾„'
        required: false
        type: string
        default: '/www/wwwroot'
      commands:
        description: 'éƒ¨ç½²åŽæ‰§è¡Œçš„å‘½ä»¤'
        required: false
        type: string
      exclude_files:
        description: 'æŽ’é™¤çš„æ–‡ä»¶/ç›®å½•'
        required: false
        type: string
      timeout:
        description: 'SSHè¿žæŽ¥è¶…æ—¶æ—¶é—´(ç§’)'
        required: false
        type: string
        default: '300'
  workflow_call:
    inputs:
      caller_repo:
        description: 'è°ƒç”¨æ–¹ä»“åº“åç§°'
        required: true
        type: string
      caller_branch:
        description: 'è°ƒç”¨æ–¹åˆ†æ”¯åç§°'
        required: true
        type: string
      caller_commit:
        description: 'è°ƒç”¨æ–¹æäº¤å“ˆå¸Œ'
        required: true
        type: string
      source_path:
        description: 'æœ¬åœ°æ–‡ä»¶è·¯å¾„'
        required: false
        type: string
        default: './dist'
      target_path:
        description: 'è¿œç¨‹ç›®æ ‡è·¯å¾„'
        required: false
        type: string
        default: '/www/wwwroot'
      commands:
        description: 'éƒ¨ç½²åŽæ‰§è¡Œçš„å‘½ä»¤'
        required: false
        type: string
      exclude_files:
        description: 'æŽ’é™¤çš„æ–‡ä»¶/ç›®å½•'
        required: false
        type: string
      timeout:
        description: 'SSHè¿žæŽ¥è¶…æ—¶æ—¶é—´(ç§’)'
        required: false
        type: string
        default: '300'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
        run: |
          echo "ðŸš€ å¼€å§‹éƒ¨ç½²"
          echo "è°ƒç”¨æ–¹ä»“åº“: ${{ github.event.inputs.caller_repo }}"
          echo "è°ƒç”¨æ–¹åˆ†æ”¯: ${{ github.event.inputs.caller_branch }}"
          echo "è°ƒç”¨æ–¹æäº¤: ${{ github.event.inputs.caller_commit }}"
          echo "æºè·¯å¾„: ${{ github.event.inputs.source_path }}"
          echo "ç›®æ ‡è·¯å¾„: ${{ github.event.inputs.target_path }}"
          echo "éƒ¨ç½²æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        
      - name: è®¾ç½®SSHçŽ¯å¢ƒ
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # é…ç½®SSHé€‰é¡¹ï¼Œè·³è¿‡ä¸»æœºå¯†é’¥éªŒè¯
          cat > ~/.ssh/config << EOF
          Host ${{ secrets.SERVER_HOST }}
            HostName ${{ secrets.SERVER_HOST }}
            Port ${{ secrets.SERVER_PORT }}
            User ${{ secrets.SERVER_USER }}
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF
          chmod 600 ~/.ssh/config
          
      - name: æµ‹è¯•SSHè¿žæŽ¥
        run: |
          echo "ðŸ” æµ‹è¯•SSHè¿žæŽ¥..."
          echo "æœåŠ¡å™¨: ${{ secrets.SERVER_HOST }}"
          echo "ç«¯å£: ${{ secrets.SERVER_PORT }}"
          echo "ç”¨æˆ·: ${{ secrets.SERVER_USER }}"
          
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo 'âœ… SSHè¿žæŽ¥æµ‹è¯•æˆåŠŸ'"
          
      - name: åˆ›å»ºè¿œç¨‹ç›®å½•
        run: |
          echo "ðŸ“ åˆ›å»ºè¿œç¨‹ç›®å½•: ${{ github.event.inputs.target_path }}"
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "mkdir -p ${{ github.event.inputs.target_path }}"
          
      - name: ä¼ è¾“æ–‡ä»¶
        if: github.event.inputs.source_path != ''
        run: |
          echo "ðŸ“¤ å¼€å§‹ä¼ è¾“æ–‡ä»¶..."
          echo "æºè·¯å¾„: ${{ github.event.inputs.source_path }}"
          echo "ç›®æ ‡è·¯å¾„: ${{ github.event.inputs.target_path }}"
          
          # æž„å»ºrsyncæŽ’é™¤å‚æ•°
          EXCLUDE_PARAMS=""
          if [ -n "${{ github.event.inputs.exclude_files }}" ]; then
            IFS=',' read -ra EXCLUDE_FILES <<< "${{ github.event.inputs.exclude_files }}"
            for file in "${EXCLUDE_FILES[@]}"; do
              EXCLUDE_PARAMS="$EXCLUDE_PARAMS --exclude=$file"
            done
          fi
          
          # ä½¿ç”¨rsyncä¼ è¾“æ–‡ä»¶
          rsync -avz --delete $EXCLUDE_PARAMS \
            -e "ssh -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }}" \
            "${{ github.event.inputs.source_path }}/" \
            "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ github.event.inputs.target_path }}/"
            
          echo "âœ… æ–‡ä»¶ä¼ è¾“å®Œæˆ"
            
      - name: æ‰§è¡Œéƒ¨ç½²å‘½ä»¤
        if: github.event.inputs.commands != ''
        run: |
          echo "âš™ï¸ æ‰§è¡Œéƒ¨ç½²å‘½ä»¤..."
          echo "å‘½ä»¤å†…å®¹:"
          echo "${{ github.event.inputs.commands }}"
          
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e
          ${{ github.event.inputs.commands }}
          EOF
          
          echo "âœ… éƒ¨ç½²å‘½ä»¤æ‰§è¡Œå®Œæˆ"
          
      - name: ä½¿ç”¨éƒ¨ç½²è„šæœ¬
        if: github.event.inputs.commands == ''
        run: |
          echo "ðŸ“œ ä½¿ç”¨é€šç”¨éƒ¨ç½²è„šæœ¬..."
          
          # ä¸Šä¼ éƒ¨ç½²è„šæœ¬åˆ°æœåŠ¡å™¨
          scp -o StrictHostKeyChecking=no -P ${{ secrets.SERVER_PORT }} scripts/deploy.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
          
          # åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²è„šæœ¬
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e
          export TARGET_PATH="${{ github.event.inputs.target_path }}"
          chmod +x /tmp/deploy.sh
          /tmp/deploy.sh
          rm -f /tmp/deploy.sh
          EOF
          
          echo "âœ… éƒ¨ç½²è„šæœ¬æ‰§è¡Œå®Œæˆ"
          
      - name: éªŒè¯éƒ¨ç½²
        run: |
          echo "ðŸ” éªŒè¯éƒ¨ç½²ç»“æžœ..."
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "ls -la ${{ github.event.inputs.target_path }}"
          
      - name: éƒ¨ç½²å®Œæˆ
        run: |
          echo "ðŸŽ‰ éƒ¨ç½²å®Œæˆ!"
          echo "éƒ¨ç½²æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ç›®æ ‡è·¯å¾„: ${{ github.event.inputs.target_path }}"
          
      - name: æ¸…ç†SSHå¯†é’¥
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
          rm -f ~/.ssh/known_hosts
          echo "ðŸ§¹ SSHå¯†é’¥å·²æ¸…ç†" 