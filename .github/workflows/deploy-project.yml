name: Deploy Project (New)

description: "é¡¹ç›®éƒ¨ç½² - ç®€åŒ–çš„é¡¹ç›®éƒ¨ç½²å·¥ä½œæµï¼Œè°ƒç”¨æ‹†åˆ†åçš„å„ä¸ªåŠŸèƒ½æ¨¡å—"

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
        description: "é¡¹ç›®åç§°"
      source_repo:
        required: true
        type: string
        description: "æºä»“åº“ (owner/repo)"
      run_id:
        required: true
        type: string
        description: "æ„å»ºè¿è¡ŒID"
      deploy_type:
        required: true
        type: string
        description: "éƒ¨ç½²ç±»å‹ (backend/static)"
        default: "static"
      server_host:
        required: true
        type: string
        description: "æœåŠ¡å™¨åœ°å€"
      server_user:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç”¨æˆ·"
      server_key:
        required: true
        type: string
        description: "æœåŠ¡å™¨å¯†é’¥"
      server_port:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç«¯å£"
      deploy_center_pat:
        required: false
        type: string
        description: "GitHub Tokenç”¨äºä¸‹è½½æ„å»ºäº§ç‰©ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨GITHUB_TOKENï¼‰"
      apps_root:
        required: false
        type: string
        description: "åº”ç”¨ç›®å½•è·¯å¾„"
        default: "/srv/apps"
      static_root:
        required: false
        type: string
        description: "é™æ€æ–‡ä»¶ç›®å½•è·¯å¾„"
        default: "/srv/static"
      backup_root:
        required: false
        type: string
        description: "å¤‡ä»½æ ¹ç›®å½•"
        default: "/srv/backups"
      mysql_config:
        required: false
        type: string
        description: "MySQL é…ç½®ï¼ˆbase64 ç¼–ç çš„ JSONï¼‰"
      run_user:
        required: false
        type: string
        description: "è¿è¡Œç”¨æˆ·"
        default: "deploy"

    outputs:
      deploy_success:
        description: "éƒ¨ç½²æ˜¯å¦æˆåŠŸ"
        value: ${{ jobs.deploy.outputs.deploy_success }}
      deploy_path:
        description: "éƒ¨ç½²è·¯å¾„"
        value: ${{ jobs.deploy.outputs.deploy_path }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      actions: read
      packages: read
    outputs:
      deploy_success: ${{ steps.set-outputs.outputs.deploy_success }}
      deploy_path: ${{ steps.set-outputs.outputs.deploy_path }}
    
    steps:
      - name: éªŒè¯è¾“å…¥å‚æ•°
        run: |
          echo "ğŸ” éªŒè¯è¾“å…¥å‚æ•°..."
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- è¿è¡ŒID: ${{ inputs.run_id }}"
          echo "- éƒ¨ç½²ç±»å‹: ${{ inputs.deploy_type }}"
          echo "- æœåŠ¡å™¨: ${{ inputs.server_host }}:${{ inputs.server_port }}"
          
          # è®°å½•éƒ¨ç½²å¼€å§‹æ—¶é—´
          echo "DEPLOY_START_TIME=$(date +%s)" >> $GITHUB_ENV
          
          echo "âœ… è¾“å…¥å‚æ•°éªŒè¯é€šè¿‡"

      # æ­¥éª¤1: ä¸‹è½½æ„å»ºäº§ç‰©
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: ./.github/workflows/download-artifact.yml@master
        with:
          project: ${{ inputs.project }}
          source_repo: ${{ inputs.source_repo }}
          run_id: ${{ inputs.run_id }}
          deploy_center_pat: ${{ inputs.deploy_center_pat }}

      # æ­¥éª¤2: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        id: deploy-to-server
        uses: ./.github/workflows/deploy-to-server.yml@master
        with:
          project: ${{ inputs.project }}
          deploy_type: ${{ inputs.deploy_type }}
          server_host: ${{ inputs.server_host }}
          server_user: ${{ inputs.server_user }}
          server_key: ${{ inputs.server_key }}
          server_port: ${{ inputs.server_port }}
          apps_root: ${{ inputs.apps_root }}
          static_root: ${{ inputs.static_root }}
          backup_root: ${{ inputs.backup_root }}
          run_user: ${{ inputs.run_user }}

      # æ­¥éª¤3: MySQL æ•°æ®åº“å¤‡ä»½ï¼ˆä»…åç«¯é¡¹ç›®ï¼‰
      - name: MySQL æ•°æ®åº“å¤‡ä»½
        id: mysql-backup
        if: inputs.deploy_type == 'backend' && inputs.mysql_config != ''
        uses: ./.github/workflows/mysql-backup.yml@master
        with:
          project: ${{ inputs.project }}
          server_host: ${{ inputs.server_host }}
          server_user: ${{ inputs.server_user }}
          server_key: ${{ inputs.server_key }}
          server_port: ${{ inputs.server_port }}
          apps_root: ${{ inputs.apps_root }}
          backup_root: ${{ inputs.backup_root }}
          mysql_config: ${{ inputs.mysql_config }}

      # æ­¥éª¤4: éƒ¨ç½²é€šçŸ¥
      - name: éƒ¨ç½²é€šçŸ¥
        uses: ./.github/workflows/deploy-notification.yml@master
        with:
          project: ${{ inputs.project }}
          source_repo: ${{ inputs.source_repo }}
          run_id: ${{ inputs.run_id }}
          deploy_type: ${{ inputs.deploy_type }}
          server_host: ${{ inputs.server_host }}
          server_port: ${{ inputs.server_port }}
          deploy_success: ${{ steps.deploy-to-server.outputs.deploy_success }}
          deploy_path: ${{ steps.deploy-to-server.outputs.deploy_path }}
          backup_success: ${{ steps.mysql-backup.outputs.backup_success || 'false' }}
          backup_path: ${{ steps.mysql-backup.outputs.backup_path || '' }}

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          echo "deploy_success=${{ steps.deploy-to-server.outputs.deploy_success }}" >> $GITHUB_OUTPUT
          echo "deploy_path=${{ steps.deploy-to-server.outputs.deploy_path }}" >> $GITHUB_OUTPUT
          echo "âœ… éƒ¨ç½²å®Œæˆ"
          echo "- deploy_success: ${{ steps.deploy-to-server.outputs.deploy_success }}"
          echo "- deploy_path: ${{ steps.deploy-to-server.outputs.deploy_path }}"
