name: Deploy Project

description: "项目部署 - 部署项目到目标服务器"

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
        description: "项目名称"
      source_repo:
        required: true
        type: string
        description: "源仓库 (owner/repo)"
      run_id:
        required: true
        type: string
        description: "构建运行ID"
      deploy_type:
        required: true
        type: string
        description: "部署类型 (backend/static)"
        default: "static"
      server_host:
        required: true
        type: string
        description: "服务器地址"
      server_user:
        required: true
        type: string
        description: "服务器用户"
      server_key:
        required: true
        type: string
        description: "服务器密钥"
      server_port:
        required: true
        type: string
        description: "服务器端口"
      deploy_center_pat:
        required: false
        type: string
        description: "GitHub Token用于下载构建产物（可选，默认使用GITHUB_TOKEN）"
      apps_root:
        required: false
        type: string
        description: "应用目录路径"
        default: "/srv/apps"
      static_root:
        required: false
        type: string
        description: "静态文件目录路径"
        default: "/srv/static"
      backup_root:
        required: false
        type: string
        description: "备份根目录"
        default: "/srv/backups"
      mysql_config:
        required: false
        type: string
        description: "MySQL 配置（base64 编码的 JSON）"
      run_user:
        required: false
        type: string
        description: "运行用户"
        default: "deploy"

    outputs:
      deploy_success:
        description: "部署是否成功"
        value: ${{ jobs.deploy.outputs.deploy_success }}
      deploy_path:
        description: "部署路径"
        value: ${{ jobs.deploy.outputs.deploy_path }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      actions: read
      packages: read
    outputs:
      deploy_success: ${{ steps.set-outputs.outputs.deploy_success }}
      deploy_path: ${{ steps.set-outputs.outputs.deploy_path }}
    
    steps:
      - name: 验证输入参数
        run: |
          echo "🔍 验证输入参数..."
          echo "- 项目: ${{ inputs.project }}"
          echo "- 源仓库: ${{ inputs.source_repo }}"
          echo "- 运行ID: ${{ inputs.run_id }}"
          echo "- 部署类型: ${{ inputs.deploy_type }}"
          echo "- 服务器: ${{ inputs.server_host }}:${{ inputs.server_port }}"
          
          # 记录部署开始时间
          echo "DEPLOY_START_TIME=$(date +%s)" >> $GITHUB_ENV
          
          echo "✅ 输入参数验证通过"

      - name: 下载构建产物
        uses: actions/download-artifact@v4
        with:
          name: dist-${{ inputs.project }}
          path: ./artifacts
          github-token: ${{ inputs.deploy_center_pat || github.token }}

      - name: 验证下载结果
        run: |
          echo "🔍 验证下载结果..."
          
          if [ -d "./artifacts" ]; then
            echo "✅ 构建产物目录存在"
            echo "📁 构建产物内容:"
            ls -la ./artifacts/
            
            # 检查是否有文件
            FILE_COUNT=$(find ./artifacts -type f | wc -l)
            echo "📊 文件数量: $FILE_COUNT"
            
            if [ "$FILE_COUNT" -gt 0 ]; then
              echo "✅ 构建产物下载成功"
            else
              echo "❌ 构建产物目录为空"
              exit 1
            fi
          else
            echo "❌ 构建产物目录不存在"
            exit 1
          fi

      - name: 部署到服务器
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "🚀 开始部署 ${{ inputs.project }}..."
            
            PROJECT="${{ inputs.project }}"
            DEPLOY_TYPE="${{ inputs.deploy_type }}"
            APPS_ROOT="${{ inputs.apps_root }}"
            STATIC_ROOT="${{ inputs.static_root }}"
            BACKUP_ROOT="${{ inputs.backup_root }}"
            RUN_USER="${{ inputs.run_user }}"
            
            echo "📋 部署配置:"
            echo "- 项目: $PROJECT"
            echo "- 类型: $DEPLOY_TYPE"
            echo "- 应用目录: $APPS_ROOT"
            echo "- 静态目录: $STATIC_ROOT"
            echo "- 备份目录: $BACKUP_ROOT"
            echo "- 运行用户: $RUN_USER"
            
            # 确定部署路径
            if [ "$DEPLOY_TYPE" = "backend" ]; then
              DEPLOY_PATH="$APPS_ROOT/$PROJECT"
              BACKUP_PATH="$BACKUP_ROOT/$PROJECT"
            else
              DEPLOY_PATH="$STATIC_ROOT/$PROJECT"
              BACKUP_PATH="$BACKUP_ROOT/$PROJECT"
            fi
            
            echo "📁 部署路径: $DEPLOY_PATH"
            echo "📁 备份路径: $BACKUP_PATH"
            
            # 创建必要的目录
            sudo mkdir -p "$APPS_ROOT" "$STATIC_ROOT" "$BACKUP_ROOT"
            sudo chown -R $RUN_USER:$RUN_USER "$APPS_ROOT" "$STATIC_ROOT" "$BACKUP_ROOT"
            
            # 备份现有部署（如果存在）
            if [ -d "$DEPLOY_PATH" ]; then
              echo "📦 备份现有部署..."
              BACKUP_TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              BACKUP_NAME="$PROJECT.backup.$BACKUP_TIMESTAMP"
              sudo cp -r "$DEPLOY_PATH" "$BACKUP_PATH/$BACKUP_NAME"
              sudo chown -R $RUN_USER:$RUN_USER "$BACKUP_PATH/$BACKUP_NAME"
              echo "✅ 现有部署已备份到: $BACKUP_PATH/$BACKUP_NAME"
              
              # 清理旧备份（保留最近5个）
              echo "🧹 清理旧备份..."
              OLD_BACKUPS=$(ls -t "$BACKUP_PATH"/$PROJECT.backup.* 2>/dev/null | tail -n +6)
              if [ -n "$OLD_BACKUPS" ]; then
                echo "🗑️ 删除旧备份:"
                echo "$OLD_BACKUPS" | xargs -r sudo rm -rf
              fi
            else
              echo "📋 没有现有部署需要备份"
            fi
            
            # 清理目标部署目录（避免残留文件）
            echo "🧹 清理目标部署目录..."
            sudo rm -rf "$DEPLOY_PATH"/*
            sudo mkdir -p "$DEPLOY_PATH"
            sudo chown -R $RUN_USER:$RUN_USER "$DEPLOY_PATH"
            
            echo "✅ 目标目录已准备就绪"

      - name: 上传构建产物到部署目录
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          source: "./artifacts/*"
          target: "${{ inputs.deploy_type == 'backend' && inputs.apps_root || inputs.static_root }}/${{ inputs.project }}/"
          strip_components: 0

      - name: 验证部署结果
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "🔍 验证部署结果..."
            
            PROJECT="${{ inputs.project }}"
            DEPLOY_TYPE="${{ inputs.deploy_type }}"
            
            if [ "$DEPLOY_TYPE" = "backend" ]; then
              DEPLOY_PATH="${{ inputs.apps_root }}/$PROJECT"
            else
              DEPLOY_PATH="${{ inputs.static_root }}/$PROJECT"
            fi
            
            echo "📁 最终部署路径: $DEPLOY_PATH"
            
            if [ -d "$DEPLOY_PATH" ]; then
              echo "✅ 部署目录存在"
              echo "📁 部署内容:"
              ls -la "$DEPLOY_PATH"
              
              # 检查是否有 deployment.tar.gz
              if [ -f "$DEPLOY_PATH/deployment.tar.gz" ]; then
                echo "📦 发现 deployment.tar.gz，正在解压..."
                cd "$DEPLOY_PATH"
                tar -xzf deployment.tar.gz
                rm -f deployment.tar.gz
                echo "✅ deployment.tar.gz 已解压"
              fi
              
              # 设置正确的权限
              sudo chown -R ${{ inputs.run_user }}:${{ inputs.run_user }} "$DEPLOY_PATH"
              sudo chmod -R 755 "$DEPLOY_PATH"
              
              # 检查关键文件
              if [ "$DEPLOY_TYPE" = "backend" ]; then
                # 后端项目检查
                if [ -f "$DEPLOY_PATH/star-cloud-linux" ] || [ -f "$DEPLOY_PATH/main" ] || [ -f "$DEPLOY_PATH/package.json" ]; then
                  echo "✅ 后端项目关键文件存在"
                else
                  echo "⚠️ 后端项目关键文件缺失"
                fi
              else
                # 静态项目检查
                if [ -f "$DEPLOY_PATH/index.html" ] || [ -d "$DEPLOY_PATH/dist" ]; then
                  echo "✅ 静态项目关键文件存在"
                else
                  echo "⚠️ 静态项目关键文件缺失"
                fi
              fi
              
              echo "✅ 部署验证完成"
            else
              echo "❌ 部署目录不存在"
              exit 1
            fi

      - name: MySQL 数据库备份
        if: inputs.deploy_type == 'backend' && inputs.mysql_config != ''
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "🗄️ 开始 MySQL 数据库备份..."
            
            # 解析 MySQL 配置
            MYSQL_CONFIG_JSON=$(echo "${{ inputs.mysql_config }}" | base64 -d)
            echo "📄 MySQL 配置: $MYSQL_CONFIG_JSON"
            
            # 提取各个参数
            MYSQL_HOST=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.mysql_host // "localhost"')
            MYSQL_PORT=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.mysql_port // "3306"')
            MYSQL_USER=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.mysql_user // "root"')
            MYSQL_PASSWORD=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.mysql_password // ""')
            DATABASE_NAME=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.database_name // ""')
            BACKUP_METHOD=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.backup_method // "mysqldump"')
            BACKUP_RETENTION_DAYS=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.backup_retention_days // "30"')
            PROJECT="${{ inputs.project }}"
            APPS_ROOT="${{ inputs.apps_root }}"
            BACKUP_ROOT="${{ inputs.backup_root }}"
            
            echo "📋 MySQL 配置:"
            echo "- 主机: $MYSQL_HOST:$MYSQL_PORT"
            echo "- 用户: $MYSQL_USER"
            echo "- 数据库: $DATABASE_NAME"
            echo "- 备份方法: $BACKUP_METHOD"
            echo "- 保留天数: $BACKUP_RETENTION_DAYS"
            
            # 检查 MySQL 连接
            echo "🔍 检查 MySQL 连接..."
            
            # 尝试从服务器配置中获取密码
            echo "🔍 尝试从服务器配置获取 MySQL 密码..."
            SERVER_PASSWORD=""
            
            # 检查 init-database.sh 中的密码
            if [ -f "/srv/apps/$PROJECT/scripts/init-database.sh" ]; then
              echo "🔍 检查 init-database.sh 中的密码配置..."
              SERVER_PASSWORD=$(grep -o 'DB_PASSWORD="[^"]*"' "/srv/apps/$PROJECT/scripts/init-database.sh" | cut -d'"' -f2)
              if [ -n "$SERVER_PASSWORD" ]; then
                echo "✅ 从 init-database.sh 获取到密码"
              fi
            fi
            
            # 检查配置文件中的密码
            if [ -z "$SERVER_PASSWORD" ] && [ -f "/srv/apps/$PROJECT/config/config.yaml" ]; then
              echo "🔍 检查 config.yaml 中的密码配置..."
              SERVER_PASSWORD=$(grep -A5 "database:" "/srv/apps/$PROJECT/config/config.yaml" | grep "password:" | awk '{print $2}' | tr -d "'" | tr -d '"')
              if [ -n "$SERVER_PASSWORD" ]; then
                echo "✅ 从 config.yaml 获取到密码"
              fi
            fi
            
            # 尝试不同的连接方式
            if [ -n "$MYSQL_PASSWORD" ]; then
              echo "🔍 尝试使用传递的密码连接..."
              if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" -e "SELECT 1;" >/dev/null 2>&1; then
                echo "✅ MySQL 连接成功（使用传递的密码）"
                MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASSWORD"
                MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASSWORD"
              elif [ -n "$SERVER_PASSWORD" ]; then
                echo "🔍 尝试使用服务器配置密码连接..."
                if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -p"$SERVER_PASSWORD" -e "SELECT 1;" >/dev/null 2>&1; then
                  echo "✅ MySQL 连接成功（使用服务器配置密码）"
                  # 创建临时密码文件（更安全的方式）
                  echo "[client]" > /tmp/mysql.cnf
                  echo "password=$SERVER_PASSWORD" >> /tmp/mysql.cnf
                  chmod 600 /tmp/mysql.cnf
                  MYSQL_CMD="mysql --defaults-extra-file=/tmp/mysql.cnf -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                  MYSQLDUMP_CMD="mysqldump --defaults-extra-file=/tmp/mysql.cnf -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                else
                  echo "❌ 使用服务器配置密码连接失败，尝试无密码连接..."
                  if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -e "SELECT 1;" >/dev/null 2>&1; then
                    echo "✅ MySQL 连接成功（无密码）"
                    MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                    MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                  else
                    echo "❌ MySQL 连接失败，跳过备份"
                    exit 0
                  fi
                fi
              else
                echo "❌ 使用传递的密码连接失败，尝试无密码连接..."
                if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -e "SELECT 1;" >/dev/null 2>&1; then
                  echo "✅ MySQL 连接成功（无密码）"
                  MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                  MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                else
                  echo "❌ MySQL 连接失败，跳过备份"
                  exit 0
                fi
              fi
            elif [ -n "$SERVER_PASSWORD" ]; then
              echo "🔍 尝试使用服务器配置密码连接..."
              if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -p"$SERVER_PASSWORD" -e "SELECT 1;" >/dev/null 2>&1; then
                echo "✅ MySQL 连接成功（使用服务器配置密码）"
                # 创建临时密码文件（更安全的方式）
                echo "[client]" > /tmp/mysql.cnf
                echo "password=$SERVER_PASSWORD" >> /tmp/mysql.cnf
                chmod 600 /tmp/mysql.cnf
                MYSQL_CMD="mysql --defaults-extra-file=/tmp/mysql.cnf -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                MYSQLDUMP_CMD="mysqldump --defaults-extra-file=/tmp/mysql.cnf -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
              else
                echo "❌ 使用服务器配置密码连接失败，尝试无密码连接..."
                if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -e "SELECT 1;" >/dev/null 2>&1; then
                  echo "✅ MySQL 连接成功（无密码）"
                  MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                  MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                else
                  echo "❌ MySQL 连接失败，跳过备份"
                  exit 0
                fi
              fi
            else
              echo "🔍 尝试无密码连接..."
              if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -e "SELECT 1;" >/dev/null 2>&1; then
                echo "✅ MySQL 连接成功（无密码）"
                MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
              else
                echo "❌ MySQL 连接失败，跳过备份"
                exit 0
              fi
            fi
            
            # 创建备份目录
            BACKUP_DIR="$BACKUP_ROOT/$PROJECT/mysql"
            sudo mkdir -p "$BACKUP_DIR"
            sudo chown -R $USER:$USER "$BACKUP_DIR"
            
            # 执行备份
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_FILE="$BACKUP_DIR/${DATABASE_NAME}_${TIMESTAMP}.sql"
            
            echo "📦 执行数据库备份..."
            if [ "$BACKUP_METHOD" = "mysqldump" ]; then
              $MYSQLDUMP_CMD \
                --single-transaction --routines --triggers --events \
                "$DATABASE_NAME" > "$BACKUP_FILE"
            else
              echo "❌ 不支持的备份方法: $BACKUP_METHOD"
              exit 1
            fi
            
            if [ $? -eq 0 ]; then
              echo "✅ 数据库备份成功: $BACKUP_FILE"
              
              # 压缩备份文件
              gzip "$BACKUP_FILE"
              echo "📦 备份文件已压缩: ${BACKUP_FILE}.gz"
              
              # 清理旧备份
              echo "🧹 清理过期备份文件..."
              find "$BACKUP_DIR" -name "*.sql.gz" -mtime +$BACKUP_RETENTION_DAYS -delete
              echo "✅ 过期备份文件已清理"
              
              # 设置定时备份任务
              if [ -n "$MYSQL_PASSWORD" ]; then
                CRON_JOB="0 2 * * * mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASSWORD --single-transaction --routines --triggers --events $DATABASE_NAME | gzip > $BACKUP_DIR/${DATABASE_NAME}_\$(date +\\%Y\\%m\\%d_\\%H\\%M\\%S).sql.gz"
              elif [ -n "$SERVER_PASSWORD" ]; then
                # 创建定时任务使用的密码文件
                echo "[client]" > /tmp/cron_mysql.cnf
                echo "password=$SERVER_PASSWORD" >> /tmp/cron_mysql.cnf
                chmod 600 /tmp/cron_mysql.cnf
                CRON_JOB="0 2 * * * mysqldump --defaults-extra-file=/tmp/cron_mysql.cnf -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER --single-transaction --routines --triggers --events $DATABASE_NAME | gzip > $BACKUP_DIR/${DATABASE_NAME}_\$(date +\\%Y\\%m\\%d_\\%H\\%M\\%S).sql.gz"
              else
                CRON_JOB="0 2 * * * mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER --single-transaction --routines --triggers --events $DATABASE_NAME | gzip > $BACKUP_DIR/${DATABASE_NAME}_\$(date +\\%Y\\%m\\%d_\\%H\\%M\\%S).sql.gz"
              fi
              
              # 检查是否已存在定时任务
              if ! crontab -l 2>/dev/null | grep -q "$DATABASE_NAME"; then
                echo "⏰ 设置定时备份任务..."
                (crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -
                echo "✅ 定时备份任务已设置"
              else
                echo "📋 定时备份任务已存在"
              fi
            else
              echo "❌ 数据库备份失败"
              exit 1
            fi

      - name: 设置输出
        id: set-outputs
        run: |
          if [[ "${{ inputs.deploy_type }}" == "backend" ]]; then
            DEPLOY_PATH="${{ inputs.apps_root }}/${{ inputs.project }}"
          else
            DEPLOY_PATH="${{ inputs.static_root }}/${{ inputs.project }}"
          fi
          
          echo "deploy_success=true" >> $GITHUB_OUTPUT
          echo "deploy_path=$DEPLOY_PATH" >> $GITHUB_OUTPUT
          echo "✅ 部署完成"
          echo "- deploy_success: true"
          echo "- deploy_path: $DEPLOY_PATH"
