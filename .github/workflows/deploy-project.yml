name: Deploy Project

description: "é¡¹ç›®éƒ¨ç½² - éƒ¨ç½²é¡¹ç›®åˆ°ç›®æ ‡æœåŠ¡å™¨"

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
        description: "é¡¹ç›®åç§°"
      source_repo:
        required: true
        type: string
        description: "æºä»“åº“ (owner/repo)"
      run_id:
        required: true
        type: string
        description: "æ„å»ºè¿è¡ŒID"
      deploy_type:
        required: true
        type: string
        description: "éƒ¨ç½²ç±»å‹ (backend/static)"
        default: "static"
      server_host:
        required: true
        type: string
        description: "æœåŠ¡å™¨åœ°å€"
      server_user:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç”¨æˆ·"
      server_key:
        required: true
        type: string
        description: "æœåŠ¡å™¨å¯†é’¥"
      server_port:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç«¯å£"
      deploy_center_pat:
        required: false
        type: string
        description: "GitHub Tokenç”¨äºä¸‹è½½æ„å»ºäº§ç‰©ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨GITHUB_TOKENï¼‰"
      apps_root:
        required: false
        type: string
        description: "åº”ç”¨ç›®å½•è·¯å¾„"
        default: "/srv/apps"
      static_root:
        required: false
        type: string
        description: "é™æ€æ–‡ä»¶ç›®å½•è·¯å¾„"
        default: "/srv/static"
      backup_root:
        required: false
        type: string
        description: "å¤‡ä»½æ ¹ç›®å½•"
        default: "/srv/backups"
      mysql_config:
        required: false
        type: string
        description: "MySQL é…ç½®ï¼ˆbase64 ç¼–ç çš„ JSONï¼‰"
      run_user:
        required: false
        type: string
        description: "è¿è¡Œç”¨æˆ·"
        default: "deploy"

    outputs:
      deploy_success:
        description: "éƒ¨ç½²æ˜¯å¦æˆåŠŸ"
        value: ${{ jobs.deploy.outputs.deploy_success }}
      deploy_path:
        description: "éƒ¨ç½²è·¯å¾„"
        value: ${{ jobs.deploy.outputs.deploy_path }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      actions: read
      packages: read
    outputs:
      deploy_success: ${{ steps.set-outputs.outputs.deploy_success }}
      deploy_path: ${{ steps.set-outputs.outputs.deploy_path }}
    
    steps:
      - name: éªŒè¯è¾“å…¥å‚æ•°
        run: |
          echo "ğŸ” éªŒè¯è¾“å…¥å‚æ•°..."
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- è¿è¡ŒID: ${{ inputs.run_id }}"
          echo "- éƒ¨ç½²ç±»å‹: ${{ inputs.deploy_type }}"
          echo "- æœåŠ¡å™¨: ${{ inputs.server_host }}:${{ inputs.server_port }}"
          
          # è®°å½•éƒ¨ç½²å¼€å§‹æ—¶é—´
          echo "DEPLOY_START_TIME=$(date +%s)" >> $GITHUB_ENV
          
          echo "âœ… è¾“å…¥å‚æ•°éªŒè¯é€šè¿‡"

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: dist-${{ inputs.project }}
          path: ./artifacts
          github-token: ${{ inputs.deploy_center_pat || github.token }}

      - name: éªŒè¯ä¸‹è½½ç»“æœ
        run: |
          echo "ğŸ” éªŒè¯ä¸‹è½½ç»“æœ..."
          
          if [ -d "./artifacts" ]; then
            echo "âœ… æ„å»ºäº§ç‰©ç›®å½•å­˜åœ¨"
            echo "ğŸ“ æ„å»ºäº§ç‰©å†…å®¹:"
            ls -la ./artifacts/
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
            FILE_COUNT=$(find ./artifacts -type f | wc -l)
            echo "ğŸ“Š æ–‡ä»¶æ•°é‡: $FILE_COUNT"
            
            if [ "$FILE_COUNT" -gt 0 ]; then
              echo "âœ… æ„å»ºäº§ç‰©ä¸‹è½½æˆåŠŸ"
            else
              echo "âŒ æ„å»ºäº§ç‰©ç›®å½•ä¸ºç©º"
              exit 1
            fi
          else
            echo "âŒ æ„å»ºäº§ç‰©ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ğŸš€ å¼€å§‹éƒ¨ç½² ${{ inputs.project }}..."
            
            PROJECT="${{ inputs.project }}"
            DEPLOY_TYPE="${{ inputs.deploy_type }}"
            APPS_ROOT="${{ inputs.apps_root }}"
            STATIC_ROOT="${{ inputs.static_root }}"
            BACKUP_ROOT="${{ inputs.backup_root }}"
            RUN_USER="${{ inputs.run_user }}"
            
            echo "ğŸ“‹ éƒ¨ç½²é…ç½®:"
            echo "- é¡¹ç›®: $PROJECT"
            echo "- ç±»å‹: $DEPLOY_TYPE"
            echo "- åº”ç”¨ç›®å½•: $APPS_ROOT"
            echo "- é™æ€ç›®å½•: $STATIC_ROOT"
            echo "- å¤‡ä»½ç›®å½•: $BACKUP_ROOT"
            echo "- è¿è¡Œç”¨æˆ·: $RUN_USER"
            
            # ç¡®å®šéƒ¨ç½²è·¯å¾„
            if [ "$DEPLOY_TYPE" = "backend" ]; then
              DEPLOY_PATH="$APPS_ROOT/$PROJECT"
              BACKUP_PATH="$BACKUP_ROOT/$PROJECT"
            else
              DEPLOY_PATH="$STATIC_ROOT/$PROJECT"
              BACKUP_PATH="$BACKUP_ROOT/$PROJECT"
            fi
            
            echo "ğŸ“ éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"
            echo "ğŸ“ å¤‡ä»½è·¯å¾„: $BACKUP_PATH"
            
            # åˆ›å»ºå¿…è¦çš„ç›®å½•
            sudo mkdir -p "$APPS_ROOT" "$STATIC_ROOT" "$BACKUP_ROOT"
            sudo chown -R $RUN_USER:$RUN_USER "$APPS_ROOT" "$STATIC_ROOT" "$BACKUP_ROOT"
            
            # å¤‡ä»½ç°æœ‰éƒ¨ç½²ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -d "$DEPLOY_PATH" ]; then
              echo "ğŸ“¦ å¤‡ä»½ç°æœ‰éƒ¨ç½²..."
              BACKUP_TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              BACKUP_NAME="$PROJECT.backup.$BACKUP_TIMESTAMP"
              sudo cp -r "$DEPLOY_PATH" "$BACKUP_PATH/$BACKUP_NAME"
              sudo chown -R $RUN_USER:$RUN_USER "$BACKUP_PATH/$BACKUP_NAME"
              echo "âœ… ç°æœ‰éƒ¨ç½²å·²å¤‡ä»½åˆ°: $BACKUP_PATH/$BACKUP_NAME"
              
              # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰
              echo "ğŸ§¹ æ¸…ç†æ—§å¤‡ä»½..."
              OLD_BACKUPS=$(ls -t "$BACKUP_PATH"/$PROJECT.backup.* 2>/dev/null | tail -n +6)
              if [ -n "$OLD_BACKUPS" ]; then
                echo "ğŸ—‘ï¸ åˆ é™¤æ—§å¤‡ä»½:"
                echo "$OLD_BACKUPS" | xargs -r sudo rm -rf
              fi
            else
              echo "ğŸ“‹ æ²¡æœ‰ç°æœ‰éƒ¨ç½²éœ€è¦å¤‡ä»½"
            fi
            
            # æ¸…ç†ç›®æ ‡éƒ¨ç½²ç›®å½•ï¼ˆé¿å…æ®‹ç•™æ–‡ä»¶ï¼‰
            echo "ğŸ§¹ æ¸…ç†ç›®æ ‡éƒ¨ç½²ç›®å½•..."
            sudo rm -rf "$DEPLOY_PATH"/*
            sudo mkdir -p "$DEPLOY_PATH"
            sudo chown -R $RUN_USER:$RUN_USER "$DEPLOY_PATH"
            
            echo "âœ… ç›®æ ‡ç›®å½•å·²å‡†å¤‡å°±ç»ª"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©åˆ°éƒ¨ç½²ç›®å½•
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          source: "./artifacts/*"
          target: "${{ inputs.deploy_type == 'backend' && inputs.apps_root || inputs.static_root }}/${{ inputs.project }}/"
          strip_components: 0

      - name: éªŒè¯éƒ¨ç½²ç»“æœ
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ğŸ” éªŒè¯éƒ¨ç½²ç»“æœ..."
            
            PROJECT="${{ inputs.project }}"
            DEPLOY_TYPE="${{ inputs.deploy_type }}"
            
            if [ "$DEPLOY_TYPE" = "backend" ]; then
              DEPLOY_PATH="${{ inputs.apps_root }}/$PROJECT"
            else
              DEPLOY_PATH="${{ inputs.static_root }}/$PROJECT"
            fi
            
            echo "ğŸ“ æœ€ç»ˆéƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"
            
            if [ -d "$DEPLOY_PATH" ]; then
              echo "âœ… éƒ¨ç½²ç›®å½•å­˜åœ¨"
              echo "ğŸ“ éƒ¨ç½²å†…å®¹:"
              ls -la "$DEPLOY_PATH"
              
              # æ£€æŸ¥æ˜¯å¦æœ‰ deployment.tar.gz
              if [ -f "$DEPLOY_PATH/deployment.tar.gz" ]; then
                echo "ğŸ“¦ å‘ç° deployment.tar.gzï¼Œæ­£åœ¨è§£å‹..."
                cd "$DEPLOY_PATH"
                tar -xzf deployment.tar.gz
                rm -f deployment.tar.gz
                echo "âœ… deployment.tar.gz å·²è§£å‹"
              fi
              
              # è®¾ç½®æ­£ç¡®çš„æƒé™
              sudo chown -R ${{ inputs.run_user }}:${{ inputs.run_user }} "$DEPLOY_PATH"
              sudo chmod -R 755 "$DEPLOY_PATH"
              
              # æ£€æŸ¥å…³é”®æ–‡ä»¶
              if [ "$DEPLOY_TYPE" = "backend" ]; then
                # åç«¯é¡¹ç›®æ£€æŸ¥
                if [ -f "$DEPLOY_PATH/star-cloud-linux" ] || [ -f "$DEPLOY_PATH/main" ] || [ -f "$DEPLOY_PATH/package.json" ]; then
                  echo "âœ… åç«¯é¡¹ç›®å…³é”®æ–‡ä»¶å­˜åœ¨"
                else
                  echo "âš ï¸ åç«¯é¡¹ç›®å…³é”®æ–‡ä»¶ç¼ºå¤±"
                fi
              else
                # é™æ€é¡¹ç›®æ£€æŸ¥
                if [ -f "$DEPLOY_PATH/index.html" ] || [ -d "$DEPLOY_PATH/dist" ]; then
                  echo "âœ… é™æ€é¡¹ç›®å…³é”®æ–‡ä»¶å­˜åœ¨"
                else
                  echo "âš ï¸ é™æ€é¡¹ç›®å…³é”®æ–‡ä»¶ç¼ºå¤±"
                fi
              fi
              
              echo "âœ… éƒ¨ç½²éªŒè¯å®Œæˆ"
            else
              echo "âŒ éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi

      - name: MySQL æ•°æ®åº“å¤‡ä»½
        if: inputs.deploy_type == 'backend' && inputs.mysql_config != ''
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ğŸ—„ï¸ å¼€å§‹ MySQL æ•°æ®åº“å¤‡ä»½..."
            
            # è§£æ MySQL é…ç½®
            MYSQL_CONFIG_JSON=$(echo "${{ inputs.mysql_config }}" | base64 -d)
            echo "ğŸ“„ MySQL é…ç½®: $MYSQL_CONFIG_JSON"
            
            # æå–å„ä¸ªå‚æ•°
            MYSQL_HOST=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.mysql_host // "localhost"')
            MYSQL_PORT=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.mysql_port // "3306"')
            MYSQL_USER=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.mysql_user // "root"')
            MYSQL_PASSWORD=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.mysql_password // ""')
            DATABASE_NAME=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.database_name // ""')
            BACKUP_METHOD=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.backup_method // "mysqldump"')
            BACKUP_RETENTION_DAYS=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.backup_retention_days // "30"')
            PROJECT="${{ inputs.project }}"
            APPS_ROOT="${{ inputs.apps_root }}"
            BACKUP_ROOT="${{ inputs.backup_root }}"
            
            echo "ğŸ“‹ MySQL é…ç½®:"
            echo "- ä¸»æœº: $MYSQL_HOST:$MYSQL_PORT"
            echo "- ç”¨æˆ·: $MYSQL_USER"
            echo "- æ•°æ®åº“: $DATABASE_NAME"
            echo "- å¤‡ä»½æ–¹æ³•: $BACKUP_METHOD"
            echo "- ä¿ç•™å¤©æ•°: $BACKUP_RETENTION_DAYS"
            
            # æ£€æŸ¥ MySQL è¿æ¥
            echo "ğŸ” æ£€æŸ¥ MySQL è¿æ¥..."
            
            # å°è¯•ä»æœåŠ¡å™¨é…ç½®ä¸­è·å–å¯†ç 
            echo "ğŸ” å°è¯•ä»æœåŠ¡å™¨é…ç½®è·å– MySQL å¯†ç ..."
            SERVER_PASSWORD=""
            
            # æ£€æŸ¥ init-database.sh ä¸­çš„å¯†ç 
            if [ -f "/srv/apps/$PROJECT/scripts/init-database.sh" ]; then
              echo "ğŸ” æ£€æŸ¥ init-database.sh ä¸­çš„å¯†ç é…ç½®..."
              SERVER_PASSWORD=$(grep -o 'DB_PASSWORD="[^"]*"' "/srv/apps/$PROJECT/scripts/init-database.sh" | cut -d'"' -f2)
              if [ -n "$SERVER_PASSWORD" ]; then
                echo "âœ… ä» init-database.sh è·å–åˆ°å¯†ç "
              fi
            fi
            
            # æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„å¯†ç 
            if [ -z "$SERVER_PASSWORD" ] && [ -f "/srv/apps/$PROJECT/config/config.yaml" ]; then
              echo "ğŸ” æ£€æŸ¥ config.yaml ä¸­çš„å¯†ç é…ç½®..."
              SERVER_PASSWORD=$(grep -A5 "database:" "/srv/apps/$PROJECT/config/config.yaml" | grep "password:" | awk '{print $2}' | tr -d "'" | tr -d '"')
              if [ -n "$SERVER_PASSWORD" ]; then
                echo "âœ… ä» config.yaml è·å–åˆ°å¯†ç "
              fi
            fi
            
            # å°è¯•ä¸åŒçš„è¿æ¥æ–¹å¼
            if [ -n "$MYSQL_PASSWORD" ]; then
              echo "ğŸ” å°è¯•ä½¿ç”¨ä¼ é€’çš„å¯†ç è¿æ¥..."
              if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" -e "SELECT 1;" >/dev/null 2>&1; then
                echo "âœ… MySQL è¿æ¥æˆåŠŸï¼ˆä½¿ç”¨ä¼ é€’çš„å¯†ç ï¼‰"
                MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASSWORD"
                MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASSWORD"
              elif [ -n "$SERVER_PASSWORD" ]; then
                echo "ğŸ” å°è¯•ä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç è¿æ¥..."
                if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -p"$SERVER_PASSWORD" -e "SELECT 1;" >/dev/null 2>&1; then
                  echo "âœ… MySQL è¿æ¥æˆåŠŸï¼ˆä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç ï¼‰"
                  # åˆ›å»ºä¸´æ—¶å¯†ç æ–‡ä»¶ï¼ˆæ›´å®‰å…¨çš„æ–¹å¼ï¼‰
                  echo "[client]" > /tmp/mysql.cnf
                  echo "password=$SERVER_PASSWORD" >> /tmp/mysql.cnf
                  chmod 600 /tmp/mysql.cnf
                  MYSQL_CMD="mysql --defaults-extra-file=/tmp/mysql.cnf -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                  MYSQLDUMP_CMD="mysqldump --defaults-extra-file=/tmp/mysql.cnf -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                else
                  echo "âŒ ä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç è¿æ¥å¤±è´¥ï¼Œå°è¯•æ— å¯†ç è¿æ¥..."
                  if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -e "SELECT 1;" >/dev/null 2>&1; then
                    echo "âœ… MySQL è¿æ¥æˆåŠŸï¼ˆæ— å¯†ç ï¼‰"
                    MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                    MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                  else
                    echo "âŒ MySQL è¿æ¥å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½"
                    exit 0
                  fi
                fi
              else
                echo "âŒ ä½¿ç”¨ä¼ é€’çš„å¯†ç è¿æ¥å¤±è´¥ï¼Œå°è¯•æ— å¯†ç è¿æ¥..."
                if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -e "SELECT 1;" >/dev/null 2>&1; then
                  echo "âœ… MySQL è¿æ¥æˆåŠŸï¼ˆæ— å¯†ç ï¼‰"
                  MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                  MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                else
                  echo "âŒ MySQL è¿æ¥å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½"
                  exit 0
                fi
              fi
            elif [ -n "$SERVER_PASSWORD" ]; then
              echo "ğŸ” å°è¯•ä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç è¿æ¥..."
              if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -p"$SERVER_PASSWORD" -e "SELECT 1;" >/dev/null 2>&1; then
                echo "âœ… MySQL è¿æ¥æˆåŠŸï¼ˆä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç ï¼‰"
                # åˆ›å»ºä¸´æ—¶å¯†ç æ–‡ä»¶ï¼ˆæ›´å®‰å…¨çš„æ–¹å¼ï¼‰
                echo "[client]" > /tmp/mysql.cnf
                echo "password=$SERVER_PASSWORD" >> /tmp/mysql.cnf
                chmod 600 /tmp/mysql.cnf
                MYSQL_CMD="mysql --defaults-extra-file=/tmp/mysql.cnf -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                MYSQLDUMP_CMD="mysqldump --defaults-extra-file=/tmp/mysql.cnf -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
              else
                echo "âŒ ä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç è¿æ¥å¤±è´¥ï¼Œå°è¯•æ— å¯†ç è¿æ¥..."
                if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -e "SELECT 1;" >/dev/null 2>&1; then
                  echo "âœ… MySQL è¿æ¥æˆåŠŸï¼ˆæ— å¯†ç ï¼‰"
                  MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                  MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                else
                  echo "âŒ MySQL è¿æ¥å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½"
                  exit 0
                fi
              fi
            else
              echo "ğŸ” å°è¯•æ— å¯†ç è¿æ¥..."
              if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -e "SELECT 1;" >/dev/null 2>&1; then
                echo "âœ… MySQL è¿æ¥æˆåŠŸï¼ˆæ— å¯†ç ï¼‰"
                MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
              else
                echo "âŒ MySQL è¿æ¥å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½"
                exit 0
              fi
            fi
            
            # åˆ›å»ºå¤‡ä»½ç›®å½•
            BACKUP_DIR="$BACKUP_ROOT/$PROJECT/mysql"
            sudo mkdir -p "$BACKUP_DIR"
            sudo chown -R $USER:$USER "$BACKUP_DIR"
            
            # æ‰§è¡Œå¤‡ä»½
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_FILE="$BACKUP_DIR/${DATABASE_NAME}_${TIMESTAMP}.sql"
            
            echo "ğŸ“¦ æ‰§è¡Œæ•°æ®åº“å¤‡ä»½..."
            if [ "$BACKUP_METHOD" = "mysqldump" ]; then
              $MYSQLDUMP_CMD \
                --single-transaction --routines --triggers --events \
                "$DATABASE_NAME" > "$BACKUP_FILE"
            else
              echo "âŒ ä¸æ”¯æŒçš„å¤‡ä»½æ–¹æ³•: $BACKUP_METHOD"
              exit 1
            fi
            
            if [ $? -eq 0 ]; then
              echo "âœ… æ•°æ®åº“å¤‡ä»½æˆåŠŸ: $BACKUP_FILE"
              
              # å‹ç¼©å¤‡ä»½æ–‡ä»¶
              gzip "$BACKUP_FILE"
              echo "ğŸ“¦ å¤‡ä»½æ–‡ä»¶å·²å‹ç¼©: ${BACKUP_FILE}.gz"
              
              # æ¸…ç†æ—§å¤‡ä»½
              echo "ğŸ§¹ æ¸…ç†è¿‡æœŸå¤‡ä»½æ–‡ä»¶..."
              find "$BACKUP_DIR" -name "*.sql.gz" -mtime +$BACKUP_RETENTION_DAYS -delete
              echo "âœ… è¿‡æœŸå¤‡ä»½æ–‡ä»¶å·²æ¸…ç†"
              
              # è®¾ç½®å®šæ—¶å¤‡ä»½ä»»åŠ¡
              if [ -n "$MYSQL_PASSWORD" ]; then
                CRON_JOB="0 2 * * * mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASSWORD --single-transaction --routines --triggers --events $DATABASE_NAME | gzip > $BACKUP_DIR/${DATABASE_NAME}_\$(date +\\%Y\\%m\\%d_\\%H\\%M\\%S).sql.gz"
              elif [ -n "$SERVER_PASSWORD" ]; then
                # åˆ›å»ºå®šæ—¶ä»»åŠ¡ä½¿ç”¨çš„å¯†ç æ–‡ä»¶
                echo "[client]" > /tmp/cron_mysql.cnf
                echo "password=$SERVER_PASSWORD" >> /tmp/cron_mysql.cnf
                chmod 600 /tmp/cron_mysql.cnf
                CRON_JOB="0 2 * * * mysqldump --defaults-extra-file=/tmp/cron_mysql.cnf -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER --single-transaction --routines --triggers --events $DATABASE_NAME | gzip > $BACKUP_DIR/${DATABASE_NAME}_\$(date +\\%Y\\%m\\%d_\\%H\\%M\\%S).sql.gz"
              else
                CRON_JOB="0 2 * * * mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER --single-transaction --routines --triggers --events $DATABASE_NAME | gzip > $BACKUP_DIR/${DATABASE_NAME}_\$(date +\\%Y\\%m\\%d_\\%H\\%M\\%S).sql.gz"
              fi
              
              # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å®šæ—¶ä»»åŠ¡
              if ! crontab -l 2>/dev/null | grep -q "$DATABASE_NAME"; then
                echo "â° è®¾ç½®å®šæ—¶å¤‡ä»½ä»»åŠ¡..."
                (crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -
                echo "âœ… å®šæ—¶å¤‡ä»½ä»»åŠ¡å·²è®¾ç½®"
              else
                echo "ğŸ“‹ å®šæ—¶å¤‡ä»½ä»»åŠ¡å·²å­˜åœ¨"
              fi
            else
              echo "âŒ æ•°æ®åº“å¤‡ä»½å¤±è´¥"
              exit 1
            fi

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          if [[ "${{ inputs.deploy_type }}" == "backend" ]]; then
            DEPLOY_PATH="${{ inputs.apps_root }}/${{ inputs.project }}"
          else
            DEPLOY_PATH="${{ inputs.static_root }}/${{ inputs.project }}"
          fi
          
          echo "deploy_success=true" >> $GITHUB_OUTPUT
          echo "deploy_path=$DEPLOY_PATH" >> $GITHUB_OUTPUT
          echo "âœ… éƒ¨ç½²å®Œæˆ"
          echo "- deploy_success: true"
          echo "- deploy_path: $DEPLOY_PATH"
