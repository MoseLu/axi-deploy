name: Deploy Project

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
        description: "é¡¹ç›®åç§°"
      deploy_type:
        required: true
        type: string
        description: "éƒ¨ç½²ç±»åž‹ (backend/static)"
        default: "static"
      server_host:
        required: true
        type: string
        description: "æœåŠ¡å™¨åœ°å€"
      server_user:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç”¨æˆ·"
      server_key:
        required: true
        type: string
        description: "æœåŠ¡å™¨å¯†é’¥"
      server_port:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç«¯å£"
      apps_root:
        required: false
        type: string
        description: "åº”ç”¨ç›®å½•è·¯å¾„"
        default: "/srv/apps"
      static_root:
        required: false
        type: string
        description: "é™æ€æ–‡ä»¶ç›®å½•è·¯å¾„"
        default: "/srv/static"
      backup_root:
        required: false
        type: string
        description: "å¤‡ä»½æ ¹ç›®å½•"
        default: "/srv/backups"
      run_user:
        required: false
        type: string
        description: "è¿è¡Œç”¨æˆ·"
        default: "deploy"
    outputs:
      deploy_success:
        description: "éƒ¨ç½²æ˜¯å¦æˆåŠŸ"
        value: ${{ jobs.deploy.outputs.deploy_success }}
      deploy_path:
        description: "éƒ¨ç½²è·¯å¾„"
        value: ${{ jobs.deploy.outputs.deploy_path }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      deploy_success: ${{ steps.set-outputs.outputs.deploy_success }}
      deploy_path: ${{ steps.set-outputs.outputs.deploy_path }}
    
    steps:
      - name: éªŒè¯è¾“å…¥å‚æ•°
        run: |
          echo "ðŸ” éªŒè¯è¾“å…¥å‚æ•°..."
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- éƒ¨ç½²ç±»åž‹: ${{ inputs.deploy_type }}"
          echo "- æœåŠ¡å™¨: ${{ inputs.server_host }}:${{ inputs.server_port }}"
          
          if [ "${{ inputs.deploy_type }}" != "backend" ] && [ "${{ inputs.deploy_type }}" != "static" ]; then
            echo "âŒ æ— æ•ˆçš„éƒ¨ç½²ç±»åž‹: ${{ inputs.deploy_type }}"
            exit 1
          fi
          
          echo "âœ… è¾“å…¥å‚æ•°éªŒè¯é€šè¿‡"

      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ðŸš€ å¼€å§‹éƒ¨ç½²é¡¹ç›®: ${{ inputs.project }}"
            
            # æ ‡å‡†åŒ–ç›®å½•ç»“æž„
            APPS_ROOT="${{ inputs.apps_root || '/srv/apps' }}"
            STATIC_ROOT="${{ inputs.static_root || '/srv/static' }}"
            PROJECT="${{ inputs.project }}"
            TEMP_DIR="/tmp/$PROJECT"
            
            echo "ðŸ“ é¡¹ç›®ä¸´æ—¶ç›®å½•: $TEMP_DIR"
            
            # æ ¹æ®éƒ¨ç½²ç±»åž‹ç¡®å®šéƒ¨ç½²è·¯å¾„
            if [[ "${{ inputs.deploy_type }}" == "backend" ]]; then
              # åŽç«¯é¡¹ç›®éƒ¨ç½²åˆ°åº”ç”¨ç›®å½•
              DEPLOY_PATH="$APPS_ROOT/$PROJECT"
              echo "ðŸ“ åŽç«¯é¡¹ç›®éƒ¨ç½²åˆ°: $DEPLOY_PATH"
            else
              # é™æ€é¡¹ç›®éƒ¨ç½²åˆ°é™æ€æ–‡ä»¶ç›®å½•
              DEPLOY_PATH="$STATIC_ROOT/$PROJECT"
              echo "ðŸ“ é™æ€é¡¹ç›®éƒ¨ç½²åˆ°: $DEPLOY_PATH"
            fi
            
            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            sudo mkdir -p $DEPLOY_PATH
            sudo chown ${{ inputs.run_user || 'deploy' }}:${{ inputs.run_user || 'deploy' }} $DEPLOY_PATH
            
            # åˆ›å»ºé¡¹ç›®ä¸“ç”¨å¤‡ä»½ç›®å½•
            if [[ "${{ inputs.deploy_type }}" == "backend" ]]; then
              BACKUP_ROOT="${{ inputs.backup_root || '/srv/backups' }}/apps"
            else
              BACKUP_ROOT="${{ inputs.backup_root || '/srv/backups' }}/static"
            fi
            PROJECT_BACKUP_DIR="$BACKUP_ROOT/$PROJECT"
            echo "ðŸ“ åˆ›å»ºé¡¹ç›®å¤‡ä»½ç›®å½•: $PROJECT_BACKUP_DIR"
            sudo mkdir -p "$PROJECT_BACKUP_DIR"
            sudo chmod 755 "$PROJECT_BACKUP_DIR"
            
            # å¤‡ä»½æ—§éƒ¨ç½²ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
            if [ -d "$DEPLOY_PATH" ] && [ "$(ls -A $DEPLOY_PATH)" ]; then
              echo "ðŸ“‹ å¤‡ä»½æ—§éƒ¨ç½²ç›®å½•: $DEPLOY_PATH"
              BACKUP_NAME="$PROJECT_BACKUP_DIR/$PROJECT.backup.$(date +%Y%m%d_%H%M%S)"
              sudo cp -r $DEPLOY_PATH $BACKUP_NAME
              echo "âœ… æ—§éƒ¨ç½²ç›®å½•å·²å¤‡ä»½åˆ°: $BACKUP_NAME"
              
              # æ¸…ç†æ—§çš„å¤‡ä»½æ–‡ä»¶ï¼Œåªä¿ç•™æœ€è¿‘2ä¸ª
              echo "ðŸ§¹ æ¸…ç†æ—§çš„å¤‡ä»½æ–‡ä»¶..."
              BACKUP_FILES=$(ls -t "$PROJECT_BACKUP_DIR"/$PROJECT.backup.* 2>/dev/null | tail -n +3)
              if [ -n "$BACKUP_FILES" ]; then
                echo "ðŸ—‘ï¸ åˆ é™¤æ—§çš„å¤‡ä»½æ–‡ä»¶:"
                echo "$BACKUP_FILES" | xargs -r sudo rm -rf
                echo "âœ… æ—§å¤‡ä»½æ–‡ä»¶å·²æ¸…ç†ï¼Œä¿ç•™æœ€è¿‘2ä¸ªå¤‡ä»½"
              else
                echo "ðŸ“‹ æ²¡æœ‰éœ€è¦æ¸…ç†çš„æ—§å¤‡ä»½æ–‡ä»¶"
              fi
            else
              echo "ðŸ“‹ æ²¡æœ‰æ—§éƒ¨ç½²éœ€è¦å¤‡ä»½"
            fi
            
            # æ¸…ç†ç›®æ ‡éƒ¨ç½²ç›®å½•ï¼ˆé¿å…æ®‹ç•™æ–‡ä»¶ï¼‰
            echo "ðŸ§¹ æ¸…ç†ç›®æ ‡éƒ¨ç½²ç›®å½•..."
            sudo rm -rf $DEPLOY_PATH/*
            sudo mkdir -p $DEPLOY_PATH
            sudo chown deploy:deploy $DEPLOY_PATH
            echo "âœ… éƒ¨ç½²ç›®å½•å·²æ¸…ç†å¹¶é‡æ–°åˆ›å»º"
            
            # æ£€æŸ¥ä¸´æ—¶ç›®å½•æ˜¯å¦å­˜åœ¨
            if [ ! -d "$TEMP_DIR" ]; then
              echo "ðŸš¨ ä¸´æ—¶ç›®å½•ä¸å­˜åœ¨: $TEMP_DIR"
              echo "ðŸ“ /tmp ç›®å½•å†…å®¹:"
              ls -la /tmp/
              exit 1
            fi
            
            # æ£€æŸ¥ä¸´æ—¶ç›®å½•æ˜¯å¦æœ‰æ–‡ä»¶
            if [ ! "$(ls -A $TEMP_DIR)" ]; then
              echo "ðŸš¨ ä¸´æ—¶ç›®å½•ä¸ºç©º: $TEMP_DIR"
              echo "ðŸ” è°ƒè¯•ä¿¡æ¯:"
              echo "ä¸´æ—¶ç›®å½•: $TEMP_DIR"
              echo "ç›®å½•æ˜¯å¦å­˜åœ¨: $(test -d "$TEMP_DIR" && echo 'æ˜¯' || echo 'å¦')"
              echo "ç›®å½•æƒé™: $(ls -ld "$TEMP_DIR" 2>/dev/null || echo 'æ— æ³•èŽ·å–æƒé™')"
              exit 1
            fi
            
            echo "ðŸ“ ä¸´æ—¶ç›®å½•å†…å®¹:"
            ls -la $TEMP_DIR/
            
            # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
            FILE_COUNT=$(find "$TEMP_DIR" -type f | wc -l)
            echo "ðŸ“Š ä¸´æ—¶ç›®å½•æ–‡ä»¶æ•°é‡: $FILE_COUNT"
            
            if [ "$FILE_COUNT" -eq 0 ]; then
              echo "ðŸš¨ ä¸´æ—¶ç›®å½•ä¸­æ²¡æœ‰æ–‡ä»¶ï¼Œéƒ¨ç½²å¤±è´¥"
              exit 1
            fi
            
            # éƒ¨ç½²æ–‡ä»¶
            echo "ðŸ“¤ å¼€å§‹éƒ¨ç½²æ–‡ä»¶..."
            sudo cp -r $TEMP_DIR/* $DEPLOY_PATH/
            
            # éªŒè¯éƒ¨ç½²ç»“æžœ
            echo "ðŸ” éªŒè¯éƒ¨ç½²ç»“æžœ..."
            if [ ! -d "$DEPLOY_PATH" ]; then
              echo "ðŸš¨ éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨: $DEPLOY_PATH"
              exit 1
            fi
            
            DEPLOYED_FILE_COUNT=$(find "$DEPLOY_PATH" -type f | wc -l)
            echo "ðŸ“Š éƒ¨ç½²åŽæ–‡ä»¶æ•°é‡: $DEPLOYED_FILE_COUNT"
            
            if [ "$DEPLOYED_FILE_COUNT" -eq 0 ]; then
              echo "ðŸš¨ éƒ¨ç½²ç›®å½•ä¸ºç©ºï¼Œéƒ¨ç½²å¤±è´¥"
              echo "ðŸ” è°ƒè¯•ä¿¡æ¯:"
              echo "éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"
              echo "ç›®å½•æ˜¯å¦å­˜åœ¨: $(test -d "$DEPLOY_PATH" && echo 'æ˜¯' || echo 'å¦')"
              echo "ç›®å½•æƒé™: $(ls -ld "$DEPLOY_PATH" 2>/dev/null || echo 'æ— æ³•èŽ·å–æƒé™')"
              echo "ç›®å½•å†…å®¹:"
              ls -la "$DEPLOY_PATH/" || echo "æ— æ³•åˆ—å‡ºç›®å½•å†…å®¹"
              exit 1
            fi
            
            # æ£€æŸ¥å…³é”®æ–‡ä»¶
            if [ -f "$DEPLOY_PATH/index.html" ]; then
              echo "âœ… æ‰¾åˆ° index.html æ–‡ä»¶"
            else
              echo "âš ï¸ æœªæ‰¾åˆ° index.html æ–‡ä»¶"
              echo "ðŸ“ éƒ¨ç½²çš„æ–‡ä»¶åˆ—è¡¨:"
              find "$DEPLOY_PATH" -type f | head -10
            fi
            
            # è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™
            sudo chown -R deploy:deploy $DEPLOY_PATH
            sudo chmod -R 755 $DEPLOY_PATH
            
            echo "âœ… æ–‡ä»¶éƒ¨ç½²å®Œæˆï¼Œæ–‡ä»¶æ•°é‡: $DEPLOYED_FILE_COUNT"
            
            # æœ€ç»ˆéªŒè¯
            echo "ðŸ” æœ€ç»ˆéªŒè¯éƒ¨ç½²ç»“æžœ..."
            if [ -d "$DEPLOY_PATH" ] && [ "$(ls -A $DEPLOY_PATH)" ]; then
              echo "âœ… éƒ¨ç½²éªŒè¯é€šè¿‡"
              echo "ðŸ“ éƒ¨ç½²ç›®å½•å†…å®¹:"
              ls -la $DEPLOY_PATH/
              echo "ðŸ“Š æœ€ç»ˆæ–‡ä»¶æ•°é‡: $DEPLOYED_FILE_COUNT"
            else
              echo "ðŸš¨ éƒ¨ç½²éªŒè¯å¤±è´¥"
              exit 1
            fi
            
            # æ¸…ç†ä¸´æ—¶ç›®å½•
            echo "ðŸ§¹ æ¸…ç†ä¸´æ—¶ç›®å½•..."
            sudo rm -rf $TEMP_DIR
            echo "âœ… ä¸´æ—¶ç›®å½•å·²æ¸…ç†: $TEMP_DIR"
            
            echo "âœ… é¡¹ç›®éƒ¨ç½²å®Œæˆ: ${{ inputs.project }}"

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          if [[ "${{ inputs.deploy_type }}" == "backend" ]]; then
            DEPLOY_PATH="/srv/apps/${{ inputs.project }}"
          else
            DEPLOY_PATH="/srv/static/${{ inputs.project }}"
          fi
          
          echo "deploy_success=true" >> $GITHUB_OUTPUT
          echo "deploy_path=$DEPLOY_PATH" >> $GITHUB_OUTPUT
          echo "âœ… è¾“å‡ºå·²è®¾ç½®"
          echo "- deploy_success: true"
          echo "- deploy_path: $DEPLOY_PATH"
