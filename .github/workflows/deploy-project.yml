name: Deploy Project

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
        description: "é¡¹ç›®åç§°"
      source_repo:
        required: true
        type: string
        description: "æºä»“åº“ (owner/repo)"
      run_id:
        required: true
        type: string
        description: "æ„å»ºè¿è¡ŒID"
      deploy_type:
        required: true
        type: string
        description: "éƒ¨ç½²ç±»å‹ (backend/static)"
        default: "static"
      server_host:
        required: true
        type: string
        description: "æœåŠ¡å™¨åœ°å€"
      server_user:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç”¨æˆ·"
      server_key:
        required: true
        type: string
        description: "æœåŠ¡å™¨å¯†é’¥"
      server_port:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç«¯å£"
      deploy_center_pat:
        required: false
        type: string
        description: "GitHub Tokenç”¨äºä¸‹è½½æ„å»ºäº§ç‰©ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨GITHUB_TOKENï¼‰"
      apps_root:
        required: false
        type: string
        description: "åº”ç”¨ç›®å½•è·¯å¾„"
        default: "/srv/apps"
      static_root:
        required: false
        type: string
        description: "é™æ€æ–‡ä»¶ç›®å½•è·¯å¾„"
        default: "/srv/static"
      backup_root:
        required: false
        type: string
        description: "å¤‡ä»½æ ¹ç›®å½•"
        default: "/srv/backups"

      mysql_config:
        required: false
        type: string
        description: "MySQL é…ç½®ï¼ˆbase64 ç¼–ç çš„ JSONï¼‰"
      run_user:
        required: false
        type: string
        description: "è¿è¡Œç”¨æˆ·"
        default: "deploy"

    outputs:
      deploy_success:
        description: "éƒ¨ç½²æ˜¯å¦æˆåŠŸ"
        value: ${{ jobs.deploy.outputs.deploy_success }}
      deploy_path:
        description: "éƒ¨ç½²è·¯å¾„"
        value: ${{ jobs.deploy.outputs.deploy_path }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20  # éƒ¨ç½²è¶…æ—¶æ—¶é—´
    permissions:
      contents: read
      actions: read
      packages: read
    outputs:
      deploy_success: ${{ steps.set-outputs.outputs.deploy_success }}
      deploy_path: ${{ steps.set-outputs.outputs.deploy_path }}
    
    steps:
      - name: éªŒè¯è¾“å…¥å‚æ•°
        run: |
          echo "ğŸ” éªŒè¯è¾“å…¥å‚æ•°..."
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- è¿è¡ŒID: ${{ inputs.run_id }}"
          echo "- éƒ¨ç½²ç±»å‹: ${{ inputs.deploy_type }}"
          echo "- æœåŠ¡å™¨: ${{ inputs.server_host }}:${{ inputs.server_port }}"
          echo "- é‡è¯•æœºåˆ¶: è‡ªåŠ¨å¯ç”¨ï¼ˆæœ€å¤šé‡è¯•2æ¬¡ï¼‰"
          
          # è®°å½•éƒ¨ç½²å¼€å§‹æ—¶é—´
          echo "DEPLOY_START_TIME=$(date +%s)" >> $GITHUB_ENV
          echo "ğŸš€ éƒ¨ç½²å¼€å§‹æ—¶é—´: $(date)"
          
          # å‘é€éƒ¨ç½²å¼€å§‹é€šçŸ¥åˆ°WebSocket
          echo "ğŸ“¤ å‘é€éƒ¨ç½²å¼€å§‹é€šçŸ¥..."
          NOTIFICATION_DATA=$(cat <<EOF
          {
            "type": "step_started",
            "project": "${{ inputs.project }}",
            "deployment_id": "${{ inputs.run_id }}",
            "step_name": "éƒ¨ç½²éªŒè¯",
            "step_status": "started",
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")",
            "workflow_name": "deploy-project",
            "workflow_id": "${{ github.run_id }}",
            "logs": "å¼€å§‹éªŒè¯éƒ¨ç½²å‚æ•°",
            "duration": 0
          }
          EOF
          )
          
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "User-Agent: axi-deploy-websocket/1.0" \
            -d "$NOTIFICATION_DATA" \
            "https://redamancy.com.cn/project-dashboard/api/webhooks/deployment" || echo "âš ï¸ WebSocketé€šçŸ¥å‘é€å¤±è´¥"
          
          # éªŒè¯éƒ¨ç½²ç±»å‹
          DEPLOY_TYPE="${{ inputs.deploy_type }}"
          if [ "$DEPLOY_TYPE" != "backend" ] && [ "$DEPLOY_TYPE" != "static" ]; then
            echo "âŒ æ— æ•ˆçš„éƒ¨ç½²ç±»å‹: $DEPLOY_TYPE"
            exit 1
          fi
          
          # éªŒè¯æœåŠ¡å™¨å‚æ•°
          SERVER_HOST="${{ inputs.server_host }}"
          SERVER_USER="${{ inputs.server_user }}"
          SERVER_PORT="${{ inputs.server_port }}"
          
          if [ -z "$SERVER_HOST" ]; then
            echo "âŒ æœåŠ¡å™¨ä¸»æœºåœ°å€ä¸ºç©º"
            exit 1
          fi
          if [ -z "$SERVER_USER" ]; then
            echo "âŒ æœåŠ¡å™¨ç”¨æˆ·åä¸ºç©º"
            exit 1
          fi
          if [ -z "$SERVER_PORT" ]; then
            echo "âŒ æœåŠ¡å™¨ç«¯å£ä¸ºç©º"
            exit 1
          fi
          
          echo "ğŸ” æœåŠ¡å™¨å‚æ•°éªŒè¯:"
          echo "- ä¸»æœº: $SERVER_HOST"
          echo "- ç”¨æˆ·: $SERVER_USER"
          echo "- ç«¯å£: $SERVER_PORT"
          
          echo "âœ… è¾“å…¥å‚æ•°éªŒè¯é€šè¿‡"

      - name: è°ƒè¯•è¿è¡ŒID
        run: |
          echo "ğŸ” è°ƒè¯•è¿è¡ŒID..."
          echo "æ¥æ”¶åˆ°çš„è¿è¡ŒID: '${{ inputs.run_id }}'"
          echo "è¿è¡ŒIDé•¿åº¦: $(echo '${{ inputs.run_id }}' | wc -c)"
          echo "è¿è¡ŒIDæ˜¯å¦ä¸ºç©º: ${{ inputs.run_id == '' && 'æ˜¯' || 'å¦' }}"
          
          if [ -z "${{ inputs.run_id }}" ]; then
            echo "ğŸš¨ è¿è¡ŒIDä¸ºç©ºï¼Œè¿™å¯èƒ½æ˜¯é—®é¢˜æ‰€åœ¨"
            exit 1
          fi
          
          echo "âœ… è¿è¡ŒIDéªŒè¯é€šè¿‡"

      - name: è°ƒè¯•ä¸‹è½½å‚æ•°
        run: |
          echo "ğŸ” è°ƒè¯•ä¸‹è½½å‚æ•°..."
          echo "æ„å»ºäº§ç‰©åç§°: dist-${{ inputs.project }}"
          echo "æºä»“åº“: ${{ inputs.source_repo }}"
          echo "è¿è¡ŒID: ${{ inputs.run_id }}"
          
          # ç¡®å®šä½¿ç”¨çš„Token
          if [ -n "${{ inputs.deploy_center_pat }}" ] && [ "${{ inputs.deploy_center_pat }}" != "null" ]; then
            USED_TOKEN="${{ inputs.deploy_center_pat }}"
            TOKEN_SOURCE="å¤–éƒ¨æä¾›çš„PAT"
          else
            USED_TOKEN="${{ github.token }}"
            TOKEN_SOURCE="å†…ç½®GITHUB_TOKEN"
          fi
          
          echo "ğŸ” Tokenè°ƒè¯•ä¿¡æ¯:"
          echo "Tokenæ¥æº: $TOKEN_SOURCE"
          echo "Tokené•¿åº¦: $(echo '$USED_TOKEN' | wc -c)"
          echo "Tokenæ˜¯å¦ä¸ºç©º: $([ -z "$USED_TOKEN" ] && echo 'æ˜¯' || echo 'å¦')"
          echo "Tokenå‰10ä¸ªå­—ç¬¦: ${USED_TOKEN:0:10}..."
          
          echo "âœ… å°†ä½¿ç”¨Token: $TOKEN_SOURCE"

      - name: æµ‹è¯•PATæƒé™
        run: |
          echo "ğŸ” æµ‹è¯•Tokenæƒé™..."
          
          # ç¡®å®šä½¿ç”¨çš„Token
          if [ -n "${{ inputs.deploy_center_pat }}" ] && [ "${{ inputs.deploy_center_pat }}" != "null" ]; then
            USED_TOKEN="${{ inputs.deploy_center_pat }}"
            TOKEN_SOURCE="å¤–éƒ¨æä¾›çš„PAT"
          else
            USED_TOKEN="${{ github.token }}"
            TOKEN_SOURCE="å†…ç½®GITHUB_TOKEN"
          fi
          
          echo "ğŸ” ä½¿ç”¨Tokenæ¥æº: $TOKEN_SOURCE"
          
          # æµ‹è¯•Tokenæ˜¯å¦æœ‰æ•ˆ
          RESPONSE=$(curl -s -H "Authorization: token $USED_TOKEN" \
            "https://api.github.com/user" 2>/dev/null || echo "APIè°ƒç”¨å¤±è´¥")
          
          if echo "$RESPONSE" | grep -q '"login"'; then
            USER_LOGIN=$(echo "$RESPONSE" | jq -r '.login // empty' 2>/dev/null)
            echo "âœ… Tokenæœ‰æ•ˆï¼Œç”¨æˆ·: $USER_LOGIN"
          else
            echo "âš ï¸ Tokenæƒé™æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­å°è¯•ä¸‹è½½æ„å»ºäº§ç‰©"
            echo "APIå“åº”: $RESPONSE"
            echo "ğŸ” è¿™å¯èƒ½æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºå†…ç½®Tokenå¯èƒ½æ— æ³•è®¿é—®ç”¨æˆ·ä¿¡æ¯ï¼Œä½†ä»å¯ä»¥ä¸‹è½½æ„å»ºäº§ç‰©"
          fi
          
          # æµ‹è¯•å¯¹ç›®æ ‡ä»“åº“çš„è®¿é—®æƒé™
          REPO_RESPONSE=$(curl -s -H "Authorization: token $USED_TOKEN" \
            "https://api.github.com/repos/${{ inputs.source_repo }}" 2>/dev/null || echo "APIè°ƒç”¨å¤±è´¥")
          
          if echo "$REPO_RESPONSE" | grep -q '"name"'; then
            REPO_NAME=$(echo "$REPO_RESPONSE" | jq -r '.name // empty' 2>/dev/null)
            echo "âœ… å¯ä»¥è®¿é—®ä»“åº“: $REPO_NAME"
          else
            echo "âš ï¸ ä»“åº“è®¿é—®æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­å°è¯•ä¸‹è½½æ„å»ºäº§ç‰©"
            echo "APIå“åº”: $REPO_RESPONSE"
            echo "ğŸ” è¿™å¯èƒ½æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºå†…ç½®Tokenå¯èƒ½æ— æ³•è®¿é—®æŸäº›ä»“åº“ä¿¡æ¯ï¼Œä½†ä»å¯ä»¥ä¸‹è½½æ„å»ºäº§ç‰©"
          fi
          
          echo "âœ… Tokenæƒé™æµ‹è¯•å®Œæˆï¼Œç»§ç»­ä¸‹è½½æ„å»ºäº§ç‰©"

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        run: |
          # å½»åº•æ¸…ç†æ—§æ–‡ä»¶å’Œç›®å½•
          echo "ğŸ§¹ æ¸…ç†æ—§æ–‡ä»¶..."
          rm -rf dist-${{ inputs.project }}/ || true
          rm -f dist-${{ inputs.project }}.zip || true
          rm -rf backend/ || true
          rm -rf frontend/ || true
          rm -rf node_modules/ || true
          rm -f package*.json || true
          rm -f *.js || true
          rm -f *.ts || true
          rm -f deploy.sh || true
          rm -f start.sh || true
          
          # ç¡®ä¿å·¥ä½œç›®å½•å¹²å‡€
          echo "ğŸ“ å½“å‰å·¥ä½œç›®å½•å†…å®¹:"
          ls -la
          
          # ä¸‹è½½æ„å»ºäº§ç‰©
          echo "â¬‡ï¸ å¼€å§‹ä¸‹è½½æ„å»ºäº§ç‰©..."
          gh run download ${{ inputs.run_id }} \
            --name "dist-${{ inputs.project }}" \
            --dir . \
            --repo ${{ inputs.source_repo }}
          
          # éªŒè¯ä¸‹è½½ç»“æœ
          echo "ğŸ” éªŒè¯ä¸‹è½½ç»“æœ..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ deployment.tar.gz æ–‡ä»¶ï¼ˆaxi-star-cloud ç­‰é¡¹ç›®çš„æ ¼å¼ï¼‰
          if [ -f "deployment.tar.gz" ]; then
            echo "âœ… å‘ç° deployment.tar.gz æ–‡ä»¶ï¼Œè§£å‹åˆ°æ ‡å‡†ç›®å½•..."
            mkdir -p "dist-${{ inputs.project }}"
            tar -xzf deployment.tar.gz -C "dist-${{ inputs.project }}"
            file_count=$(find "dist-${{ inputs.project }}" -type f | wc -l)
            echo "âœ… deployment.tar.gz è§£å‹æˆåŠŸï¼ŒåŒ…å« $file_count ä¸ªæ–‡ä»¶"
            echo "ğŸ“ è§£å‹åå†…å®¹:"
            ls -la "dist-${{ inputs.project }}/"
          elif [ -f "dist-${{ inputs.project }}.tar.gz" ]; then
            echo "âœ… æ„å»ºäº§ç‰©å‹ç¼©åŒ…ä¸‹è½½æˆåŠŸ"
            echo "ğŸ“¦ è§£å‹æ„å»ºäº§ç‰©å‹ç¼©åŒ…..."
            tar -xzf "dist-${{ inputs.project }}.tar.gz"
            
            # æ£€æŸ¥è§£å‹åçš„ç›®å½•ç»“æ„
            if [ -d "dist" ]; then
              echo "âœ… å‹ç¼©åŒ…è§£å‹æˆåŠŸï¼Œé‡å‘½åç›®å½•..."
              mv dist "dist-${{ inputs.project }}"
              file_count=$(find "dist-${{ inputs.project }}" -type f | wc -l)
              echo "âœ… æ„å»ºäº§ç‰©è§£å‹æˆåŠŸï¼ŒåŒ…å« $file_count ä¸ªæ–‡ä»¶"
            else
              echo "âŒ å‹ç¼©åŒ…è§£å‹åæœªæ‰¾åˆ°é¢„æœŸçš„ dist ç›®å½•"
              echo "ğŸ“ è§£å‹åç›®å½•å†…å®¹:"
              ls -la
              exit 1
            fi
          elif [ -d "dist-${{ inputs.project }}" ]; then
            file_count=$(find "dist-${{ inputs.project }}" -type f | wc -l)
            echo "âœ… æ„å»ºäº§ç‰©ä¸‹è½½æˆåŠŸï¼ŒåŒ…å« $file_count ä¸ªæ–‡ä»¶"
          elif [ -f "dist-${{ inputs.project }}.zip" ]; then
            echo "âœ… æ„å»ºäº§ç‰©å‹ç¼©åŒ…ä¸‹è½½æˆåŠŸ"
            unzip -q "dist-${{ inputs.project }}.zip"
            file_count=$(find "dist-${{ inputs.project }}" -type f | wc -l)
            echo "âœ… æ„å»ºäº§ç‰©è§£å‹æˆåŠŸï¼ŒåŒ…å« $file_count ä¸ªæ–‡ä»¶"
          elif [ -d "docs" ] && [ -d "docs/.vitepress" ] && [ -d "docs/.vitepress/dist" ]; then
            echo "âœ… å‘ç° VitePress æ„å»ºäº§ç‰©ç›®å½•ç»“æ„"
            echo "ğŸ“¦ ç§»åŠ¨æ„å»ºäº§ç‰©åˆ°æ ‡å‡†ä½ç½®..."
            mv docs/.vitepress/dist "dist-${{ inputs.project }}"
            file_count=$(find "dist-${{ inputs.project }}" -type f | wc -l)
            echo "âœ… æ„å»ºäº§ç‰©ç§»åŠ¨æˆåŠŸï¼ŒåŒ…å« $file_count ä¸ªæ–‡ä»¶"
          else
            echo "ğŸ“ æœªæ‰¾åˆ°æ ‡å‡†æ„å»ºäº§ç‰©ï¼Œæ£€æŸ¥å½“å‰ç›®å½•å†…å®¹..."
            echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æ„å»ºäº§ç‰©æ–‡ä»¶
            if [ -d "backend" ] || [ -d "frontend" ] || [ -f "package.json" ] || [ -f "index.html" ] || [ -f "star-cloud-linux" ] || [ -d "front" ]; then
              echo "âœ… å‘ç°é¡¹ç›®æ–‡ä»¶ï¼Œåˆ›å»ºæ ‡å‡†æ„å»ºäº§ç‰©ç›®å½•..."
              mkdir -p "dist-${{ inputs.project }}"
              
              # ç§»åŠ¨æ‰€æœ‰é¡¹ç›®æ–‡ä»¶åˆ°æ„å»ºäº§ç‰©ç›®å½•
              if [ -d "backend" ]; then
                mv backend "dist-${{ inputs.project }}/"
              fi
              if [ -d "frontend" ]; then
                mv frontend "dist-${{ inputs.project }}/"
              fi
              if [ -d "front" ]; then
                mv front "dist-${{ inputs.project }}/"
              fi
              if [ -f "package.json" ]; then
                mv package.json "dist-${{ inputs.project }}/"
              fi
              if [ -f "index.html" ]; then
                mv index.html "dist-${{ inputs.project }}/"
              fi
              if [ -f "ecosystem.config.js" ]; then
                mv ecosystem.config.js "dist-${{ inputs.project }}/"
              fi
              if [ -f "deploy.sh" ]; then
                mv deploy.sh "dist-${{ inputs.project }}/"
              fi
              if [ -f "start.sh" ]; then
                mv start.sh "dist-${{ inputs.project }}/"
              fi
              if [ -f "star-cloud-linux" ]; then
                mv star-cloud-linux "dist-${{ inputs.project }}/"
              fi
              if [ -f "star-cloud.service" ]; then
                mv star-cloud.service "dist-${{ inputs.project }}/"
              fi
              if [ -d "config" ]; then
                mv config "dist-${{ inputs.project }}/"
              fi
              
              file_count=$(find "dist-${{ inputs.project }}" -type f | wc -l)
              echo "âœ… æ„å»ºäº§ç‰©é‡æ–°ç»„ç»‡å®Œæˆï¼ŒåŒ…å« $file_count ä¸ªæ–‡ä»¶"
              echo "ğŸ“ æ„å»ºäº§ç‰©å†…å®¹:"
              ls -la "dist-${{ inputs.project }}/"
            else
              echo "âŒ æ„å»ºäº§ç‰©ä¸‹è½½å¤±è´¥ï¼Œæ— æ³•æ‰¾åˆ°æœ‰æ•ˆçš„é¡¹ç›®æ–‡ä»¶"
              echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
              ls -la
              exit 1
            fi
          fi
          
          # æœ€ç»ˆéªŒè¯
          if [ ! -d "dist-${{ inputs.project }}" ] || [ "$(find "dist-${{ inputs.project }}" -type f | wc -l)" -eq 0 ]; then
            echo "âŒ æ„å»ºäº§ç‰©éªŒè¯å¤±è´¥ï¼Œç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
            echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi
          
          echo "âœ… æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡"
        env:
          GH_TOKEN: ${{ inputs.deploy_center_pat || github.token }}



      - name: è°ƒè¯•ä¸‹è½½ç»“æœ
        run: |
          echo "ğŸ” è°ƒè¯•ä¸‹è½½ç»“æœ..."
          echo "ä¸‹è½½æ­¥éª¤é€€å‡ºç : ${{ steps.download-artifact.outcome }}"
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la ./
          echo ""
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å‹ç¼©åŒ…
          if [ -f "dist-${{ inputs.project }}.tar.gz" ]; then
            echo "âœ… æ‰¾åˆ°å‹ç¼©åŒ…: dist-${{ inputs.project }}.tar.gz"
            echo "ğŸ“Š å‹ç¼©åŒ…å¤§å°: $(du -h dist-${{ inputs.project }}.tar.gz | cut -f1)"
            echo "ğŸ“ å‹ç¼©åŒ…å†…å®¹é¢„è§ˆ:"
            tar -tzf "dist-${{ inputs.project }}.tar.gz" | head -20
          fi
          
          if [ -f "deployment.tar.gz" ]; then
            echo "âœ… æ‰¾åˆ°éƒ¨ç½²å‹ç¼©åŒ…: deployment.tar.gz"
            echo "ğŸ“Š å‹ç¼©åŒ…å¤§å°: $(du -h deployment.tar.gz | cut -f1)"
            echo "ğŸ“ å‹ç¼©åŒ…å†…å®¹é¢„è§ˆ:"
            tar -tzf deployment.tar.gz | head -20
          fi
          
          echo ""
          echo "ğŸ” æ£€æŸ¥æ„å»ºäº§ç‰©ç›®å½•..."
          if [ -d "./dist-${{ inputs.project }}" ]; then
            echo "âœ… æ‰¾åˆ°æ„å»ºäº§ç‰©ç›®å½•"
            echo "ğŸ“ æ„å»ºäº§ç‰©å†…å®¹:"
            ls -la "./dist-${{ inputs.project }}/"
            echo "ğŸ“Š æ–‡ä»¶æ•°é‡: $(find "./dist-${{ inputs.project }}" -type f | wc -l)"
          else
            echo "ğŸ“ æ„å»ºäº§ç‰©ç›®å½•ä¸å­˜åœ¨ï¼Œæ£€æŸ¥å½“å‰ç›®å½•å†…å®¹..."
            echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
            ls -la ./
            echo ""
            echo "ğŸ” æ‰€æœ‰æ–‡ä»¶å’Œç›®å½•:"
            find . -type f -maxdepth 2
            find . -type d -maxdepth 2
          fi

      - name: è°ƒè¯•SSHå‚æ•°
        run: |
          echo "ğŸ” è°ƒè¯•SSHè¿æ¥å‚æ•°..."
          echo "æœåŠ¡å™¨ä¸»æœº: '${{ inputs.server_host }}'"
          echo "æœåŠ¡å™¨ç”¨æˆ·: '${{ inputs.server_user }}'"
          echo "æœåŠ¡å™¨ç«¯å£: '${{ inputs.server_port }}'"
          echo "SSHå¯†é’¥é•¿åº¦: $(echo '${{ inputs.server_key }}' | wc -c)"
          echo "SSHå¯†é’¥æ˜¯å¦ä¸ºç©º: $([ -z '${{ inputs.server_key }}' ] && echo 'æ˜¯' || echo 'å¦')"
          
          # éªŒè¯å¿…éœ€å‚æ•°
          if [ -z "${{ inputs.server_host }}" ]; then
            echo "ğŸš¨ æœåŠ¡å™¨ä¸»æœºåœ°å€ä¸ºç©º"
            exit 1
          fi
          if [ -z "${{ inputs.server_user }}" ]; then
            echo "ğŸš¨ æœåŠ¡å™¨ç”¨æˆ·åä¸ºç©º"
            exit 1
          fi
          if [ -z "${{ inputs.server_port }}" ]; then
            echo "ğŸš¨ æœåŠ¡å™¨ç«¯å£ä¸ºç©º"
            exit 1
          fi
          if [ -z "${{ inputs.server_key }}" ]; then
            echo "ğŸš¨ SSHå¯†é’¥ä¸ºç©º"
            exit 1
          fi
          
          echo "âœ… SSHå‚æ•°éªŒè¯é€šè¿‡"

      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²é¡¹ç›®: ${{ inputs.project }}"
            
            # æ ‡å‡†åŒ–ç›®å½•ç»“æ„
            APPS_ROOT="${{ inputs.apps_root || '/srv/apps' }}"
            STATIC_ROOT="${{ inputs.static_root || '/srv/static' }}"
            PROJECT="${{ inputs.project }}"
            DEPLOY_PATH=""
            
            # æ ¹æ®éƒ¨ç½²ç±»å‹ç¡®å®šéƒ¨ç½²è·¯å¾„
            if [[ "${{ inputs.deploy_type }}" == "backend" ]]; then
              # åç«¯é¡¹ç›®éƒ¨ç½²åˆ°åº”ç”¨ç›®å½•
              DEPLOY_PATH="$APPS_ROOT/$PROJECT"
              echo "ğŸ“ åç«¯é¡¹ç›®éƒ¨ç½²åˆ°: $DEPLOY_PATH"
            else
              # é™æ€é¡¹ç›®éƒ¨ç½²åˆ°é™æ€æ–‡ä»¶ç›®å½•
              DEPLOY_PATH="$STATIC_ROOT/$PROJECT"
              echo "ğŸ“ é™æ€é¡¹ç›®éƒ¨ç½²åˆ°: $DEPLOY_PATH"
            fi
            
            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            sudo mkdir -p $DEPLOY_PATH
            sudo chown ${{ inputs.run_user || 'deploy' }}:${{ inputs.run_user || 'deploy' }} $DEPLOY_PATH
            
            # åˆ›å»ºé¡¹ç›®ä¸“ç”¨å¤‡ä»½ç›®å½•
            if [[ "${{ inputs.deploy_type }}" == "backend" ]]; then
              BACKUP_ROOT="${{ inputs.backup_root || '/srv/backups' }}/apps"
            else
              BACKUP_ROOT="${{ inputs.backup_root || '/srv/backups' }}/static"
            fi
            PROJECT_BACKUP_DIR="$BACKUP_ROOT/$PROJECT"
            echo "ğŸ“ åˆ›å»ºé¡¹ç›®å¤‡ä»½ç›®å½•: $PROJECT_BACKUP_DIR"
            sudo mkdir -p "$PROJECT_BACKUP_DIR"
            sudo chmod 755 "$PROJECT_BACKUP_DIR"
            
            # å¤‡ä»½æ—§éƒ¨ç½²ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -d "$DEPLOY_PATH" ] && [ "$(ls -A $DEPLOY_PATH)" ]; then
              echo "ğŸ“‹ å¤‡ä»½æ—§éƒ¨ç½²ç›®å½•: $DEPLOY_PATH"
              BACKUP_NAME="$PROJECT_BACKUP_DIR/$PROJECT.backup.$(date +%Y%m%d_%H%M%S)"
              sudo cp -r $DEPLOY_PATH $BACKUP_NAME
              echo "âœ… æ—§éƒ¨ç½²ç›®å½•å·²å¤‡ä»½åˆ°: $BACKUP_NAME"
              
              # æ¸…ç†æ—§çš„å¤‡ä»½æ–‡ä»¶ï¼Œåªä¿ç•™æœ€è¿‘5ä¸ª
              echo "ğŸ§¹ æ¸…ç†æ—§çš„å¤‡ä»½æ–‡ä»¶..."
              BACKUP_FILES=$(ls -t "$PROJECT_BACKUP_DIR"/$PROJECT.backup.* 2>/dev/null | tail -n +6)
              if [ -n "$BACKUP_FILES" ]; then
                echo "ğŸ—‘ï¸ åˆ é™¤æ—§çš„å¤‡ä»½æ–‡ä»¶:"
                echo "$BACKUP_FILES" | xargs -r sudo rm -rf
                echo "âœ… æ—§å¤‡ä»½æ–‡ä»¶å·²æ¸…ç†ï¼Œä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½"
              else
                echo "ğŸ“‹ æ²¡æœ‰éœ€è¦æ¸…ç†çš„æ—§å¤‡ä»½æ–‡ä»¶"
              fi
            else
              echo "ğŸ“‹ æ²¡æœ‰æ—§éƒ¨ç½²éœ€è¦å¤‡ä»½"
            fi
            
            # MySQL æ•°æ®åº“å¤‡ä»½ï¼ˆä»…å¯¹åç«¯é¡¹ç›®ï¼‰
            if [[ "${{ inputs.deploy_type }}" == "backend" ]]; then
              echo "ğŸ—„ï¸ æ£€æŸ¥ MySQL æ•°æ®åº“å¤‡ä»½éœ€æ±‚..."
              
              # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ MySQL æ•°æ®åº“
              MYSQL_DETECTED=false
              
              # æ£€æŸ¥å¸¸è§çš„é…ç½®æ–‡ä»¶
              CONFIG_FILES=(
                "$DEPLOY_PATH/config/database.yml"
                "$DEPLOY_PATH/config/database.yaml"
                "$DEPLOY_PATH/config/config.yml"
                "$DEPLOY_PATH/config/config.yaml"
                "$DEPLOY_PATH/.env"
                "$DEPLOY_PATH/.env.production"
                "$DEPLOY_PATH/backend/config/database.yml"
                "$DEPLOY_PATH/backend/config/database.yaml"
                "$DEPLOY_PATH/backend/.env"
                "$DEPLOY_PATH/backend/.env.production"
              )
              
              for config_file in "${CONFIG_FILES[@]}"; do
                if [ -f "$config_file" ]; then
                  if grep -qi "mysql\|mariadb" "$config_file" 2>/dev/null; then
                    echo "âœ… å‘ç° MySQL é…ç½®: $config_file"
                    MYSQL_DETECTED=true
                    break
                  fi
                fi
              done
              
              # æ£€æŸ¥ package.json æˆ– go.mod
              if [ -f "$DEPLOY_PATH/package.json" ] && grep -qi "mysql\|mariadb" "$DEPLOY_PATH/package.json" 2>/dev/null; then
                echo "âœ… å‘ç° MySQL ç›¸å…³ä¾èµ–"
                MYSQL_DETECTED=true
              fi
              
              if [ -f "$DEPLOY_PATH/go.mod" ] && grep -qi "mysql\|mariadb" "$DEPLOY_PATH/go.mod" 2>/dev/null; then
                echo "âœ… å‘ç° MySQL ç›¸å…³ä¾èµ–"
                MYSQL_DETECTED=true
              fi
              
              if [ "$MYSQL_DETECTED" = true ]; then
                echo "ğŸ—„ï¸ æ£€æµ‹åˆ° MySQL æ•°æ®åº“ï¼Œå°†åœ¨éƒ¨ç½²åæ‰§è¡Œæ•°æ®åº“å¤‡ä»½"
                echo "mysql_backup_needed=true" > /tmp/mysql_backup_flag
              else
                echo "ğŸ“‹ æœªæ£€æµ‹åˆ° MySQL æ•°æ®åº“ï¼Œè·³è¿‡æ•°æ®åº“å¤‡ä»½"
                echo "mysql_backup_needed=false" > /tmp/mysql_backup_flag
              fi
            fi
            
            # æ¸…ç†ç›®æ ‡éƒ¨ç½²ç›®å½•ï¼ˆé¿å…æ®‹ç•™æ–‡ä»¶ï¼‰
            echo "ğŸ§¹ æ¸…ç†ç›®æ ‡éƒ¨ç½²ç›®å½•..."
            sudo rm -rf $DEPLOY_PATH/*
            sudo mkdir -p $DEPLOY_PATH
            sudo chown deploy:deploy $DEPLOY_PATH
            echo "âœ… éƒ¨ç½²ç›®å½•å·²æ¸…ç†å¹¶é‡æ–°åˆ›å»º"



      - name: æ£€æŸ¥æ„å»ºäº§ç‰©æ˜¯å¦å­˜åœ¨
        run: |
          echo "ğŸ” æ£€æŸ¥æ„å»ºäº§ç‰©æ˜¯å¦å­˜åœ¨..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ„å»ºäº§ç‰©ç›®å½•
          if [ -d "./dist-${{ inputs.project }}" ]; then
            echo "âœ… æ‰¾åˆ°æ„å»ºäº§ç‰©ç›®å½•: ./dist-${{ inputs.project }}"
            echo "ğŸ“ æ„å»ºäº§ç‰©å†…å®¹:"
            ls -la "./dist-${{ inputs.project }}/"
            echo "ğŸ“Š æ–‡ä»¶æ•°é‡: $(find "./dist-${{ inputs.project }}" -type f | wc -l)"
          else
            echo "ğŸ“ æ„å»ºäº§ç‰©ç›®å½•ä¸å­˜åœ¨ï¼Œæ£€æŸ¥å½“å‰ç›®å½•å†…å®¹..."
            echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
            ls -la ./
            echo ""
            echo "ğŸ” æ‰€æœ‰æ–‡ä»¶å’Œç›®å½•:"
            find . -type f -maxdepth 2
            find . -type d -maxdepth 2
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å‹ç¼©åŒ…
            if [ -f "deployment.tar.gz" ]; then
              echo "âœ… å‘ç°éƒ¨ç½²å‹ç¼©åŒ…ï¼Œæ­£åœ¨è§£å‹..."
              mkdir -p "./dist-${{ inputs.project }}"
              tar -xzf deployment.tar.gz -C "./dist-${{ inputs.project }}"
              echo "âœ… éƒ¨ç½²å‹ç¼©åŒ…è§£å‹å®Œæˆ"
              echo "ğŸ“ æ„å»ºäº§ç‰©å†…å®¹:"
              ls -la "./dist-${{ inputs.project }}/"
              echo "ğŸ“Š æ–‡ä»¶æ•°é‡: $(find "./dist-${{ inputs.project }}" -type f | wc -l)"
            # æ£€æŸ¥å½“å‰ç›®å½•æ˜¯å¦åŒ…å«æ„å»ºäº§ç‰©æ–‡ä»¶
            elif [ -f "index.html" ] || [ -f "package.json" ] || [ -d "assets" ]; then
              echo "âœ… å‘ç°æ„å»ºäº§ç‰©æ–‡ä»¶åœ¨å½“å‰ç›®å½•ï¼Œåˆ›å»ºæ ‡å‡†ç›®å½•ç»“æ„..."
              mkdir -p "./dist-${{ inputs.project }}"
              # ç§»åŠ¨æ‰€æœ‰æ–‡ä»¶åˆ°æ„å»ºäº§ç‰©ç›®å½•ï¼ˆé™¤äº†éšè—æ–‡ä»¶ï¼‰
              find . -maxdepth 1 -type f ! -name ".*" -exec mv {} "./dist-${{ inputs.project }}/" \;
              find . -maxdepth 1 -type d ! -name "." ! -name ".*" -exec mv {} "./dist-${{ inputs.project }}/" \;
              echo "âœ… æ„å»ºäº§ç‰©å·²ç§»åŠ¨åˆ°æ ‡å‡†ç›®å½•: ./dist-${{ inputs.project }}"
              echo "ğŸ“ æ„å»ºäº§ç‰©å†…å®¹:"
              ls -la "./dist-${{ inputs.project }}/"
              echo "ğŸ“Š æ–‡ä»¶æ•°é‡: $(find "./dist-${{ inputs.project }}" -type f | wc -l)"
            else
              echo "âŒ æ„å»ºäº§ç‰©ä¸‹è½½å¤±è´¥ï¼Œæ— æ³•ç»§ç»­éƒ¨ç½²"
              echo "ğŸ” æœŸæœ›çš„æ–‡ä»¶:"
              echo "- ./dist-${{ inputs.project }}/ (ç›®å½•)"
              echo "- deployment.tar.gz (å‹ç¼©åŒ…)"
              echo "- index.html, package.json, assets/ (é™æ€æ–‡ä»¶)"
              exit 1
            fi
          fi

      - name: ç›´æ¥éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²é¡¹ç›®: ${{ inputs.project }}"
            
            # æ ‡å‡†åŒ–ç›®å½•ç»“æ„
            APPS_ROOT="${{ inputs.apps_root || '/srv/apps' }}"
            STATIC_ROOT="${{ inputs.static_root || '/srv/static' }}"
            PROJECT="${{ inputs.project }}"
            DEPLOY_PATH=""
            
            # æ ¹æ®éƒ¨ç½²ç±»å‹ç¡®å®šéƒ¨ç½²è·¯å¾„
            if [[ "${{ inputs.deploy_type }}" == "backend" ]]; then
              # åç«¯é¡¹ç›®éƒ¨ç½²åˆ°åº”ç”¨ç›®å½•
              DEPLOY_PATH="$APPS_ROOT/$PROJECT"
              echo "ğŸ“ åç«¯é¡¹ç›®éƒ¨ç½²åˆ°: $DEPLOY_PATH"
            else
              # é™æ€é¡¹ç›®éƒ¨ç½²åˆ°é™æ€æ–‡ä»¶ç›®å½•
              DEPLOY_PATH="$STATIC_ROOT/$PROJECT"
              echo "ğŸ“ é™æ€é¡¹ç›®éƒ¨ç½²åˆ°: $DEPLOY_PATH"
            fi
            
            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            sudo mkdir -p $DEPLOY_PATH
            sudo chown ${{ inputs.run_user || 'deploy' }}:${{ inputs.run_user || 'deploy' }} $DEPLOY_PATH
            
            # åˆ›å»ºé¡¹ç›®ä¸“ç”¨å¤‡ä»½ç›®å½•
            if [[ "${{ inputs.deploy_type }}" == "backend" ]]; then
              BACKUP_ROOT="${{ inputs.backup_root || '/srv/backups' }}/apps"
            else
              BACKUP_ROOT="${{ inputs.backup_root || '/srv/backups' }}/static"
            fi
            PROJECT_BACKUP_DIR="$BACKUP_ROOT/$PROJECT"
            echo "ğŸ“ åˆ›å»ºé¡¹ç›®å¤‡ä»½ç›®å½•: $PROJECT_BACKUP_DIR"
            sudo mkdir -p "$PROJECT_BACKUP_DIR"
            sudo chmod 755 "$PROJECT_BACKUP_DIR"
            
            # å¤‡ä»½æ—§éƒ¨ç½²ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -d "$DEPLOY_PATH" ] && [ "$(ls -A $DEPLOY_PATH)" ]; then
              echo "ğŸ“‹ å¤‡ä»½æ—§éƒ¨ç½²ç›®å½•: $DEPLOY_PATH"
              BACKUP_NAME="$PROJECT_BACKUP_DIR/$PROJECT.backup.$(date +%Y%m%d_%H%M%S)"
              sudo cp -r $DEPLOY_PATH $BACKUP_NAME
              echo "âœ… æ—§éƒ¨ç½²ç›®å½•å·²å¤‡ä»½åˆ°: $BACKUP_NAME"
              
              # æ¸…ç†æ—§çš„å¤‡ä»½æ–‡ä»¶ï¼Œåªä¿ç•™æœ€è¿‘5ä¸ª
              echo "ğŸ§¹ æ¸…ç†æ—§çš„å¤‡ä»½æ–‡ä»¶..."
              BACKUP_FILES=$(ls -t "$PROJECT_BACKUP_DIR"/$PROJECT.backup.* 2>/dev/null | tail -n +6)
              if [ -n "$BACKUP_FILES" ]; then
                echo "ğŸ—‘ï¸ åˆ é™¤æ—§çš„å¤‡ä»½æ–‡ä»¶:"
                echo "$BACKUP_FILES" | xargs -r sudo rm -rf
                echo "âœ… æ—§å¤‡ä»½æ–‡ä»¶å·²æ¸…ç†ï¼Œä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½"
              else
                echo "ğŸ“‹ æ²¡æœ‰éœ€è¦æ¸…ç†çš„æ—§å¤‡ä»½æ–‡ä»¶"
              fi
            else
              echo "ğŸ“‹ æ²¡æœ‰æ—§éƒ¨ç½²éœ€è¦å¤‡ä»½"
            fi
            
            # æ¸…ç†ç›®æ ‡éƒ¨ç½²ç›®å½•ï¼ˆé¿å…æ®‹ç•™æ–‡ä»¶ï¼‰
            echo "ğŸ§¹ æ¸…ç†ç›®æ ‡éƒ¨ç½²ç›®å½•..."
            sudo rm -rf $DEPLOY_PATH/*
            sudo mkdir -p $DEPLOY_PATH
            sudo chown deploy:deploy $DEPLOY_PATH
            echo "âœ… éƒ¨ç½²ç›®å½•å·²æ¸…ç†å¹¶é‡æ–°åˆ›å»º"

      - name: è°ƒè¯•æ„å»ºäº§ç‰©
        run: |
          echo "ğŸ” è°ƒè¯•æ„å»ºäº§ç‰©..."
          echo "ğŸ“ å½“å‰ç›®å½•: $(pwd)"
          echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
          ls -la
          echo ""
          echo "ğŸ” æ£€æŸ¥æ„å»ºäº§ç‰©ç›®å½•: ./dist-${{ inputs.project }}"
          if [ -d "./dist-${{ inputs.project }}" ]; then
            echo "âœ… æ„å»ºäº§ç‰©ç›®å½•å­˜åœ¨"
            echo "ğŸ“ æ„å»ºäº§ç‰©å†…å®¹:"
            ls -la "./dist-${{ inputs.project }}/"
            echo "ğŸ“Š æ–‡ä»¶æ•°é‡: $(find "./dist-${{ inputs.project }}" -type f | wc -l)"
          else
            echo "âŒ æ„å»ºäº§ç‰©ç›®å½•ä¸å­˜åœ¨"
            echo "ğŸ” æŸ¥æ‰¾å¯èƒ½çš„æ„å»ºäº§ç‰©..."
            find . -type d -name "*${{ inputs.project }}*" 2>/dev/null || echo "æœªæ‰¾åˆ°ç›¸å…³ç›®å½•"
          fi

      - name: å‡†å¤‡ç›®æ ‡ç›®å½•
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ğŸ“¤ å‡†å¤‡ç›®æ ‡ç›®å½•..."
            
            # ç¡®å®šéƒ¨ç½²è·¯å¾„
            if [[ "${{ inputs.deploy_type }}" == "backend" ]]; then
              DEPLOY_PATH="${{ inputs.apps_root || '/srv/apps' }}/${{ inputs.project }}"
            else
              DEPLOY_PATH="${{ inputs.static_root || '/srv/static' }}/${{ inputs.project }}"
            fi
            
            echo "ğŸ“ ç›®æ ‡éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"
            
            # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
            sudo mkdir -p "$DEPLOY_PATH"
            sudo chown deploy:deploy "$DEPLOY_PATH"
            
            echo "âœ… ç›®æ ‡ç›®å½•å‡†å¤‡å®Œæˆ"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©åˆ°éƒ¨ç½²ç›®å½•
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          source: "./dist-${{ inputs.project }}/"
          target: "${{ inputs.deploy_type == 'backend' && format('{0}/{1}', inputs.apps_root || '/srv/apps', inputs.project) || format('{0}/{1}', inputs.static_root || '/srv/static', inputs.project) }}"
          strip_components: 0
          overwrite: true

      - name: éªŒè¯ä¸Šä¼ ç»“æœ
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ğŸ” éªŒè¯ä¸Šä¼ ç»“æœ..."
            
            # ç¡®å®šéƒ¨ç½²è·¯å¾„
            if [[ "${{ inputs.deploy_type }}" == "backend" ]]; then
              DEPLOY_PATH="${{ inputs.apps_root || '/srv/apps' }}/${{ inputs.project }}"
            else
              DEPLOY_PATH="${{ inputs.static_root || '/srv/static' }}/${{ inputs.project }}"
            fi
            
            echo "ğŸ“ æ£€æŸ¥éƒ¨ç½²ç›®å½•: $DEPLOY_PATH"
            
            if [ -d "$DEPLOY_PATH" ]; then
              echo "âœ… éƒ¨ç½²ç›®å½•å­˜åœ¨"
              echo "ğŸ“ éƒ¨ç½²ç›®å½•å†…å®¹:"
              ls -la "$DEPLOY_PATH/"
              
              # æ£€æŸ¥å…³é”®æ–‡ä»¶
              if [ -f "$DEPLOY_PATH/index.html" ]; then
                echo "âœ… index.html å­˜åœ¨"
              else
                echo "âŒ index.html ä¸å­˜åœ¨"
              fi
              
              if [ -d "$DEPLOY_PATH/assets" ]; then
                echo "âœ… assets ç›®å½•å­˜åœ¨"
                echo "ğŸ“Š assets ç›®å½•æ–‡ä»¶æ•°é‡: $(find "$DEPLOY_PATH/assets" -type f | wc -l)"
              else
                echo "âŒ assets ç›®å½•ä¸å­˜åœ¨"
              fi
              
              # ç»Ÿè®¡æ€»æ–‡ä»¶æ•°
              total_files=$(find "$DEPLOY_PATH" -type f | wc -l)
              echo "ğŸ“Š æ€»æ–‡ä»¶æ•°é‡: $total_files"
              
              if [ "$total_files" -lt 10 ]; then
                echo "âš ï¸ æ–‡ä»¶æ•°é‡è¿‡å°‘ï¼Œå¯èƒ½å­˜åœ¨ä¸Šä¼ é—®é¢˜"
                exit 1
              else
                echo "âœ… æ–‡ä»¶æ•°é‡æ­£å¸¸"
              fi
            else
              echo "âŒ éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi

      - name: ä¿®å¤ç›®å½•ç»“æ„
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ğŸ”§ ä¿®å¤ç›®å½•ç»“æ„..."
            
            # æ ‡å‡†åŒ–ç›®å½•ç»“æ„
            APPS_ROOT="${{ inputs.apps_root || '/srv/apps' }}"
            STATIC_ROOT="${{ inputs.static_root || '/srv/static' }}"
            PROJECT="${{ inputs.project }}"
            
            # æ ¹æ®éƒ¨ç½²ç±»å‹ç¡®å®šéƒ¨ç½²è·¯å¾„
            if [[ "${{ inputs.deploy_type }}" == "backend" ]]; then
              DEPLOY_PATH="$APPS_ROOT/$PROJECT"
            else
              DEPLOY_PATH="$STATIC_ROOT/$PROJECT"
            fi
            
            echo "ğŸ“ æ£€æŸ¥éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"
            
            # æ£€æŸ¥æ˜¯å¦å­˜åœ¨é¢å¤–çš„dist-ç›®å½•
            DIST_SUBDIR="$DEPLOY_PATH/dist-$PROJECT"
            if [ -d "$DIST_SUBDIR" ]; then
              echo "ğŸ” å‘ç°é¢å¤–çš„dist-ç›®å½•: $DIST_SUBDIR"
              echo "ğŸ“ dist-ç›®å½•å†…å®¹:"
              ls -la "$DIST_SUBDIR/"
              
              # æ£€æŸ¥dist-ç›®å½•ä¸‹æ˜¯å¦æœ‰æ­£ç¡®çš„é¡¹ç›®æ–‡ä»¶
              # å¯¹äºé™æ€é¡¹ç›®ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰index.htmlæˆ–å…¶ä»–é™æ€æ–‡ä»¶
              if [ -f "$DIST_SUBDIR/package.json" ] || [ -f "$DIST_SUBDIR/ecosystem.config.js" ] || [ -d "$DIST_SUBDIR/backend" ] || [ -d "$DIST_SUBDIR/frontend" ] || [ -f "$DIST_SUBDIR/index.html" ] || [ -d "$DIST_SUBDIR/assets" ] || [ -d "$DIST_SUBDIR/_assets" ]; then
                echo "âœ… dist-ç›®å½•åŒ…å«æ­£ç¡®çš„é¡¹ç›®æ–‡ä»¶ï¼Œæ­£åœ¨ä¿®å¤ç›®å½•ç»“æ„..."
                
                # åˆ›å»ºä¸´æ—¶ç›®å½•
                TEMP_DIR="/tmp/fix-$PROJECT-$(date +%s)"
                mkdir -p "$TEMP_DIR"
                
                # ç§»åŠ¨dist-ç›®å½•ä¸‹çš„æ‰€æœ‰å†…å®¹åˆ°ä¸´æ—¶ç›®å½•
                mv "$DIST_SUBDIR"/* "$TEMP_DIR/" 2>/dev/null || true
                mv "$DIST_SUBDIR"/.* "$TEMP_DIR/" 2>/dev/null || true
                
                # åˆ é™¤ç©ºçš„dist-ç›®å½•
                rmdir "$DIST_SUBDIR" 2>/dev/null || true
                
                # ç§»åŠ¨ä¸´æ—¶ç›®å½•çš„å†…å®¹åˆ°é¡¹ç›®æ ¹ç›®å½•
                mv "$TEMP_DIR"/* "$DEPLOY_PATH/" 2>/dev/null || true
                mv "$TEMP_DIR"/.* "$DEPLOY_PATH/" 2>/dev/null || true
                
                # åˆ é™¤ä¸´æ—¶ç›®å½•
                rmdir "$TEMP_DIR" 2>/dev/null || true
                
                echo "âœ… ç›®å½•ç»“æ„ä¿®å¤å®Œæˆ"
              else
                echo "âš ï¸ dist-ç›®å½•ä¸åŒ…å«é¢„æœŸçš„é¡¹ç›®æ–‡ä»¶ï¼Œä¿æŒåŸç»“æ„"
              fi
            else
              echo "âœ… ç›®å½•ç»“æ„æ­£å¸¸ï¼Œæ— éœ€ä¿®å¤"
            fi
            
            # æ˜¾ç¤ºæœ€ç»ˆçš„é¡¹ç›®ç›®å½•ç»“æ„
            echo "ğŸ“ æœ€ç»ˆé¡¹ç›®ç›®å½•ç»“æ„:"
            ls -la "$DEPLOY_PATH/"
            
            # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            echo "ğŸ” æ£€æŸ¥å…³é”®æ–‡ä»¶:"
            if [ -f "$DEPLOY_PATH/package.json" ]; then
              echo "âœ… package.json å­˜åœ¨"
            else
              echo "âŒ package.json ä¸å­˜åœ¨"
            fi
            
            if [ -f "$DEPLOY_PATH/ecosystem.config.js" ]; then
              echo "âœ… ecosystem.config.js å­˜åœ¨"
            else
              echo "âŒ ecosystem.config.js ä¸å­˜åœ¨"
            fi
            
            if [ -d "$DEPLOY_PATH/backend" ]; then
              echo "âœ… backend ç›®å½•å­˜åœ¨"
            else
              echo "âŒ backend ç›®å½•ä¸å­˜åœ¨"
            fi
            
            if [ -d "$DEPLOY_PATH/frontend" ]; then
              echo "âœ… frontend ç›®å½•å­˜åœ¨"
            else
              echo "âŒ frontend ç›®å½•ä¸å­˜åœ¨"
            fi
            
            # æ£€æŸ¥é™æ€é¡¹ç›®æ–‡ä»¶
            if [ -f "$DEPLOY_PATH/index.html" ]; then
              echo "âœ… index.html å­˜åœ¨"
            else
              echo "âŒ index.html ä¸å­˜åœ¨"
            fi
            
            if [ -d "$DEPLOY_PATH/assets" ]; then
              echo "âœ… assets ç›®å½•å­˜åœ¨"
            else
              echo "âŒ assets ç›®å½•ä¸å­˜åœ¨"
            fi
            
            if [ -d "$DEPLOY_PATH/_assets" ]; then
              echo "âœ… _assets ç›®å½•å­˜åœ¨"
            else
              echo "âŒ _assets ç›®å½•ä¸å­˜åœ¨"
            fi
            
            # è®¾ç½®æ­£ç¡®çš„æƒé™
            echo "ğŸ”§ è®¾ç½®æ–‡ä»¶æƒé™..."
            chown -R deploy:deploy "$DEPLOY_PATH"
            chmod -R 755 "$DEPLOY_PATH"
            
            # ç¡®ä¿å¯åŠ¨è„šæœ¬å¯æ‰§è¡Œ
            if [ -f "$DEPLOY_PATH/start.sh" ]; then
              chmod +x "$DEPLOY_PATH/start.sh"
              echo "âœ… start.sh è®¾ç½®ä¸ºå¯æ‰§è¡Œ"
            fi
            
            echo "âœ… ç›®å½•ç»“æ„ä¿®å¤å’Œæƒé™è®¾ç½®å®Œæˆ"

      - name: éªŒè¯éƒ¨ç½²ç»“æœ
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ğŸ” éªŒè¯éƒ¨ç½²ç»“æœ..."
            
            PROJECT="${{ inputs.project }}"
            
            # æ ¹æ®éƒ¨ç½²ç±»å‹ç¡®å®šéƒ¨ç½²è·¯å¾„
            if [[ "${{ inputs.deploy_type }}" == "backend" ]]; then
              DEPLOY_PATH="${{ inputs.apps_root || '/srv/apps' }}/$PROJECT"
            else
              DEPLOY_PATH="${{ inputs.static_root || '/srv/static' }}/$PROJECT"
            fi
            
            echo "ğŸ“ æ£€æŸ¥éƒ¨ç½²ç›®å½•: $DEPLOY_PATH"
            
            if [ -d "$DEPLOY_PATH" ] && [ "$(ls -A $DEPLOY_PATH)" ]; then
              final_file_count=$(find "$DEPLOY_PATH" -type f | wc -l)
              echo "âœ… éƒ¨ç½²éªŒè¯é€šè¿‡"
              echo "ğŸ“ éƒ¨ç½²ç›®å½•å†…å®¹:"
              ls -la $DEPLOY_PATH/
              echo "ğŸ“Š æœ€ç»ˆæ–‡ä»¶æ•°é‡: $final_file_count"
              if [ "$final_file_count" -gt 0 ]; then
                echo "âœ… éƒ¨ç½²æˆåŠŸ"
                exit 0
              else
                echo "âŒ éƒ¨ç½²åç›®å½•ä¸ºç©º"
                exit 1
              fi
            else
              echo "ğŸš¨ éƒ¨ç½²éªŒè¯å¤±è´¥"
              exit 1
            fi



      - name: éƒ¨ç½²å¤±è´¥è‡ªåŠ¨å›æ»š
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹è‡ªåŠ¨å›æ»š..."
          
          # åˆ›å»ºä¸´æ—¶SSHå¯†é’¥æ–‡ä»¶
          echo "${{ inputs.server_key }}" > /tmp/deploy_key
          chmod 600 /tmp/deploy_key
          
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 \
            -i /tmp/deploy_key \
            -p ${{ inputs.server_port }} \
            ${{ inputs.server_user }}@${{ inputs.server_host }} << 'EOF'
            
            PROJECT="${{ inputs.project }}"
            
            if [ "${{ inputs.deploy_type }}" = "static" ]; then
              DEPLOY_PATH="${{ inputs.static_root || '/srv/static' }}/$PROJECT"
              BACKUP_ROOT="${{ inputs.backup_root || '/srv/backups' }}/static"
            else
              DEPLOY_PATH="${{ inputs.apps_root || '/srv/apps' }}/$PROJECT"
              BACKUP_ROOT="${{ inputs.backup_root || '/srv/backups' }}/apps"
            fi
            
            PROJECT_BACKUP_DIR="$BACKUP_ROOT/$PROJECT"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å¤‡ä»½
            echo "ğŸ” æŸ¥æ‰¾æœ€æ–°å¤‡ä»½..."
            echo "ğŸ“ å¤‡ä»½ç›®å½•: $PROJECT_BACKUP_DIR"
            
            if [ -d "$PROJECT_BACKUP_DIR" ]; then
              echo "ğŸ“ å¤‡ä»½ç›®å½•å†…å®¹:"
              ls -la "$PROJECT_BACKUP_DIR"
              
              # æŸ¥æ‰¾æœ€æ–°çš„å¤‡ä»½ç›®å½•
              LATEST_BACKUP=$(find "$PROJECT_BACKUP_DIR" -name "$PROJECT.backup.*" -type d 2>/dev/null | sort -r | head -1)
              
              if [ -n "$LATEST_BACKUP" ] && [ -d "$LATEST_BACKUP" ]; then
                echo "ğŸ“¦ æ‰¾åˆ°æœ€æ–°å¤‡ä»½: $LATEST_BACKUP"
                echo "ğŸ“ å¤‡ä»½å†…å®¹:"
                ls -la "$LATEST_BACKUP"
                
                sudo rm -rf "$DEPLOY_PATH"/*
                sudo cp -r "$LATEST_BACKUP"/* "$DEPLOY_PATH/"
                sudo chown -R ${{ inputs.run_user || 'deploy' }}:${{ inputs.run_user || 'deploy' }} "$DEPLOY_PATH"
                echo "âœ… å›æ»šå®Œæˆï¼Œå·²æ¢å¤åˆ°: $LATEST_BACKUP"
              else
                echo "âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆçš„å¤‡ä»½ç›®å½•"
                echo "ğŸ” å¯ç”¨çš„å¤‡ä»½:"
                find "$PROJECT_BACKUP_DIR" -name "$PROJECT.backup.*" -type d 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°å¤‡ä»½"
              fi
            else
              echo "âš ï¸ å¤‡ä»½ç›®å½•ä¸å­˜åœ¨: $PROJECT_BACKUP_DIR"
            fi
          EOF

      - name: è§£æ MySQL é…ç½®
        if: inputs.deploy_type == 'backend' && inputs.mysql_config != ''
        id: parse-mysql-config
        run: |
          if [ -n "${{ inputs.mysql_config }}" ]; then
            echo "ğŸ” è§£æ MySQL é…ç½®..."
            MYSQL_CONFIG_JSON=$(echo "${{ inputs.mysql_config }}" | base64 -d)
            echo "ğŸ“„ MySQL é…ç½®: $MYSQL_CONFIG_JSON"
            
            # æå–å„ä¸ªå‚æ•°
            MYSQL_HOST=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.mysql_host // "localhost"')
            MYSQL_PORT=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.mysql_port // "3306"')
            MYSQL_USER=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.mysql_user // "root"')
            MYSQL_PASSWORD=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.mysql_password // ""')
            DATABASE_NAME=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.database_name // ""')
            BACKUP_METHOD=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.backup_method // "mysqldump"')
            BACKUP_RETENTION_DAYS=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.backup_retention_days // "30"')
            
            echo "mysql_host=$MYSQL_HOST" >> $GITHUB_OUTPUT
            echo "mysql_port=$MYSQL_PORT" >> $GITHUB_OUTPUT
            echo "mysql_user=$MYSQL_USER" >> $GITHUB_OUTPUT
            echo "mysql_password=$MYSQL_PASSWORD" >> $GITHUB_OUTPUT
            echo "database_name=$DATABASE_NAME" >> $GITHUB_OUTPUT
            echo "backup_method=$BACKUP_METHOD" >> $GITHUB_OUTPUT
            echo "backup_retention_days=$BACKUP_RETENTION_DAYS" >> $GITHUB_OUTPUT
            
            echo "âœ… MySQL é…ç½®è§£æå®Œæˆ"
          else
            echo "ğŸ“‹ æœªæä¾› MySQL é…ç½®ï¼Œè·³è¿‡æ•°æ®åº“å¤‡ä»½"
            echo "mysql_host=localhost" >> $GITHUB_OUTPUT
            echo "mysql_port=3306" >> $GITHUB_OUTPUT
            echo "mysql_user=root" >> $GITHUB_OUTPUT
            echo "mysql_password=" >> $GITHUB_OUTPUT
            echo "database_name=" >> $GITHUB_OUTPUT
            echo "backup_method=mysqldump" >> $GITHUB_OUTPUT
            echo "backup_retention_days=30" >> $GITHUB_OUTPUT
          fi

      - name: MySQL æ•°æ®åº“å¤‡ä»½
        if: inputs.deploy_type == 'backend' && inputs.mysql_config != ''
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ğŸ—„ï¸ å¼€å§‹ MySQL æ•°æ®åº“å¤‡ä»½..."
            
            # è§£æ MySQL é…ç½®
            MYSQL_HOST="${{ steps.parse-mysql-config.outputs.mysql_host }}"
            MYSQL_PORT="${{ steps.parse-mysql-config.outputs.mysql_port }}"
            MYSQL_USER="${{ steps.parse-mysql-config.outputs.mysql_user }}"
            MYSQL_PASSWORD="${{ steps.parse-mysql-config.outputs.mysql_password }}"
            DATABASE_NAME="${{ steps.parse-mysql-config.outputs.database_name }}"
            BACKUP_METHOD="${{ steps.parse-mysql-config.outputs.backup_method }}"
            BACKUP_RETENTION_DAYS="${{ steps.parse-mysql-config.outputs.backup_retention_days }}"
            PROJECT="${{ inputs.project }}"
            APPS_ROOT="${{ inputs.apps_root }}"
            BACKUP_ROOT="${{ inputs.backup_root }}"
            
            echo "ğŸ“‹ MySQL é…ç½®:"
            echo "- ä¸»æœº: $MYSQL_HOST:$MYSQL_PORT"
            echo "- ç”¨æˆ·: $MYSQL_USER"
            echo "- æ•°æ®åº“: $DATABASE_NAME"
            echo "- å¤‡ä»½æ–¹æ³•: $BACKUP_METHOD"
            echo "- ä¿ç•™å¤©æ•°: $BACKUP_RETENTION_DAYS"
            
            # æ£€æŸ¥ MySQL è¿æ¥
            echo "ğŸ” æ£€æŸ¥ MySQL è¿æ¥..."
            echo "ğŸ” å¯†ç é•¿åº¦: ${#MYSQL_PASSWORD}"
            
            # å°è¯•ä»æœåŠ¡å™¨é…ç½®ä¸­è·å–å¯†ç 
            echo "ğŸ” å°è¯•ä»æœåŠ¡å™¨é…ç½®è·å– MySQL å¯†ç ..."
            SERVER_PASSWORD=""
            
            # æ£€æŸ¥ init-database.sh ä¸­çš„å¯†ç 
            if [ -f "/srv/apps/$PROJECT/scripts/init-database.sh" ]; then
              echo "ğŸ” æ£€æŸ¥ init-database.sh ä¸­çš„å¯†ç é…ç½®..."
              SERVER_PASSWORD=$(grep -o 'DB_PASSWORD="[^"]*"' "/srv/apps/$PROJECT/scripts/init-database.sh" | cut -d'"' -f2)
              if [ -n "$SERVER_PASSWORD" ]; then
                echo "âœ… ä» init-database.sh è·å–åˆ°å¯†ç "
              fi
            fi
            
            # æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„å¯†ç 
            if [ -z "$SERVER_PASSWORD" ] && [ -f "/srv/apps/$PROJECT/config/config.yaml" ]; then
              echo "ğŸ” æ£€æŸ¥ config.yaml ä¸­çš„å¯†ç é…ç½®..."
              SERVER_PASSWORD=$(grep -A5 "database:" "/srv/apps/$PROJECT/config/config.yaml" | grep "password:" | awk '{print $2}' | tr -d "'" | tr -d '"')
              if [ -n "$SERVER_PASSWORD" ]; then
                echo "âœ… ä» config.yaml è·å–åˆ°å¯†ç "
              fi
            fi
            
            # å°è¯•ä¸åŒçš„è¿æ¥æ–¹å¼
            if [ -n "$MYSQL_PASSWORD" ]; then
              echo "ğŸ” å°è¯•ä½¿ç”¨ä¼ é€’çš„å¯†ç è¿æ¥..."
              if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" -e "SELECT 1;" >/dev/null 2>&1; then
                echo "âœ… MySQL è¿æ¥æˆåŠŸï¼ˆä½¿ç”¨ä¼ é€’çš„å¯†ç ï¼‰"
                MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASSWORD"
                MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASSWORD"
              elif [ -n "$SERVER_PASSWORD" ]; then
                echo "ğŸ” å°è¯•ä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç è¿æ¥..."
                if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -p"$SERVER_PASSWORD" -e "SELECT 1;" >/dev/null 2>&1; then
                  echo "âœ… MySQL è¿æ¥æˆåŠŸï¼ˆä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç ï¼‰"
                  MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$SERVER_PASSWORD"
                  MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$SERVER_PASSWORD"
                else
                  echo "âŒ ä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç è¿æ¥å¤±è´¥ï¼Œå°è¯•æ— å¯†ç è¿æ¥..."
                  if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -e "SELECT 1;" >/dev/null 2>&1; then
                    echo "âœ… MySQL è¿æ¥æˆåŠŸï¼ˆæ— å¯†ç ï¼‰"
                    MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                    MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                  else
                    echo "âŒ MySQL è¿æ¥å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½"
                    exit 0
                  fi
                fi
              else
                echo "âŒ ä½¿ç”¨ä¼ é€’çš„å¯†ç è¿æ¥å¤±è´¥ï¼Œå°è¯•æ— å¯†ç è¿æ¥..."
                if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -e "SELECT 1;" >/dev/null 2>&1; then
                  echo "âœ… MySQL è¿æ¥æˆåŠŸï¼ˆæ— å¯†ç ï¼‰"
                  MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                  MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                else
                  echo "âŒ MySQL è¿æ¥å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½"
                  exit 0
                fi
              fi
            elif [ -n "$SERVER_PASSWORD" ]; then
              echo "ğŸ” å°è¯•ä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç è¿æ¥..."
              if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -p"$SERVER_PASSWORD" -e "SELECT 1;" >/dev/null 2>&1; then
                echo "âœ… MySQL è¿æ¥æˆåŠŸï¼ˆä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç ï¼‰"
                MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$SERVER_PASSWORD"
                MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$SERVER_PASSWORD"
              else
                echo "âŒ ä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç è¿æ¥å¤±è´¥ï¼Œå°è¯•æ— å¯†ç è¿æ¥..."
                if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -e "SELECT 1;" >/dev/null 2>&1; then
                  echo "âœ… MySQL è¿æ¥æˆåŠŸï¼ˆæ— å¯†ç ï¼‰"
                  MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                  MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                else
                  echo "âŒ MySQL è¿æ¥å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½"
                  exit 0
                fi
              fi
            else
              echo "ğŸ” å°è¯•æ— å¯†ç è¿æ¥..."
              if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -e "SELECT 1;" >/dev/null 2>&1; then
                echo "âœ… MySQL è¿æ¥æˆåŠŸï¼ˆæ— å¯†ç ï¼‰"
                MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
              else
                echo "âŒ MySQL è¿æ¥å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½"
                exit 0
              fi
            fi
            
            # åˆ›å»ºå¤‡ä»½ç›®å½•
            BACKUP_DIR="$BACKUP_ROOT/$PROJECT/mysql"
            sudo mkdir -p "$BACKUP_DIR"
            sudo chown -R $USER:$USER "$BACKUP_DIR"
            
            # æ‰§è¡Œå¤‡ä»½
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_FILE="$BACKUP_DIR/${DATABASE_NAME}_${TIMESTAMP}.sql"
            
            echo "ğŸ“¦ æ‰§è¡Œæ•°æ®åº“å¤‡ä»½..."
            if [ "$BACKUP_METHOD" = "mysqldump" ]; then
              $MYSQLDUMP_CMD \
                --single-transaction --routines --triggers --events \
                "$DATABASE_NAME" > "$BACKUP_FILE"
            else
              echo "âŒ ä¸æ”¯æŒçš„å¤‡ä»½æ–¹æ³•: $BACKUP_METHOD"
              exit 1
            fi
            
            if [ $? -eq 0 ]; then
              echo "âœ… æ•°æ®åº“å¤‡ä»½æˆåŠŸ: $BACKUP_FILE"
              
              # å‹ç¼©å¤‡ä»½æ–‡ä»¶
              gzip "$BACKUP_FILE"
              echo "ğŸ“¦ å¤‡ä»½æ–‡ä»¶å·²å‹ç¼©: ${BACKUP_FILE}.gz"
              
              # æ¸…ç†æ—§å¤‡ä»½
              echo "ğŸ§¹ æ¸…ç†è¿‡æœŸå¤‡ä»½æ–‡ä»¶..."
              find "$BACKUP_DIR" -name "*.sql.gz" -mtime +$BACKUP_RETENTION_DAYS -delete
              echo "âœ… è¿‡æœŸå¤‡ä»½æ–‡ä»¶å·²æ¸…ç†"
              
              # è®¾ç½®å®šæ—¶å¤‡ä»½ä»»åŠ¡
              if [ -n "$MYSQL_PASSWORD" ]; then
                CRON_JOB="0 2 * * * mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASSWORD --single-transaction --routines --triggers --events $DATABASE_NAME | gzip > $BACKUP_DIR/${DATABASE_NAME}_\$(date +\\%Y\\%m\\%d_\\%H\\%M\\%S).sql.gz"
              elif [ -n "$SERVER_PASSWORD" ]; then
                CRON_JOB="0 2 * * * mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$SERVER_PASSWORD --single-transaction --routines --triggers --events $DATABASE_NAME | gzip > $BACKUP_DIR/${DATABASE_NAME}_\$(date +\\%Y\\%m\\%d_\\%H\\%M\\%S).sql.gz"
              else
                CRON_JOB="0 2 * * * mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER --single-transaction --routines --triggers --events $DATABASE_NAME | gzip > $BACKUP_DIR/${DATABASE_NAME}_\$(date +\\%Y\\%m\\%d_\\%H\\%M\\%S).sql.gz"
              fi
              
              # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å®šæ—¶ä»»åŠ¡
              if ! crontab -l 2>/dev/null | grep -q "$DATABASE_NAME"; then
                echo "â° è®¾ç½®å®šæ—¶å¤‡ä»½ä»»åŠ¡..."
                (crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -
                echo "âœ… å®šæ—¶å¤‡ä»½ä»»åŠ¡å·²è®¾ç½®"
              else
                echo "ğŸ“‹ å®šæ—¶å¤‡ä»½ä»»åŠ¡å·²å­˜åœ¨"
              fi
            else
              echo "âŒ æ•°æ®åº“å¤‡ä»½å¤±è´¥"
              exit 1
            fi

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          if [[ "${{ inputs.deploy_type }}" == "backend" ]]; then
            DEPLOY_PATH="/srv/apps/${{ inputs.project }}"
          else
            DEPLOY_PATH="/srv/static/${{ inputs.project }}"
          fi
          
          echo "deploy_success=true" >> $GITHUB_OUTPUT
          echo "deploy_path=$DEPLOY_PATH" >> $GITHUB_OUTPUT
          echo "âœ… è¾“å‡ºå·²è®¾ç½®"
          echo "- deploy_success: true"
          echo "- deploy_path: $DEPLOY_PATH"

      - name: é€šçŸ¥éƒ¨ç½²ä»ªè¡¨æ¿
        if: success()
        run: |
          echo "ğŸ“¤ é€šçŸ¥ axi-project-dashboard éƒ¨ç½²æˆåŠŸ..."
          
          # è®¡ç®—éƒ¨ç½²è€—æ—¶
          DEPLOY_START_TIME="${{ env.DEPLOY_START_TIME }}"
          DEPLOY_END_TIME=$(date +%s)
          DEPLOY_DURATION=$((DEPLOY_END_TIME - DEPLOY_START_TIME))
          
          # æ„å»ºé€šçŸ¥æ•°æ®
          NOTIFICATION_DATA=$(cat <<EOF
          {
            "type": "deployment_completed",
            "project": "${{ inputs.project }}",
            "deployment_id": "${{ inputs.run_id }}",
            "status": "success",
            "duration": $DEPLOY_DURATION,
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")",
            "workflow_name": "deploy-project",
            "workflow_id": "${{ github.run_id }}",
            "sourceRepo": "${{ inputs.source_repo }}",
            "deployType": "${{ inputs.deploy_type }}",
            "serverHost": "${{ inputs.server_host }}",
            "logs": "éƒ¨ç½²æˆåŠŸï¼Œè€—æ—¶ ${DEPLOY_DURATION} ç§’",
            "started_at": "$(date -d @$DEPLOY_START_TIME -u +"%Y-%m-%dT%H:%M:%S.000Z")",
            "completed_at": "$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")"
          }
          EOF
          )
          
          echo "ğŸ“Š éƒ¨ç½²ä¿¡æ¯:"
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- çŠ¶æ€: success"
          echo "- è€—æ—¶: ${DEPLOY_DURATION}ç§’"
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- è¿è¡ŒID: ${{ inputs.run_id }}"
          echo "- éƒ¨ç½²ç±»å‹: ${{ inputs.deploy_type }}"
          
          # å‘é€é€šçŸ¥åˆ° axi-project-dashboard
          DASHBOARD_URL="https://redamancy.com.cn/project-dashboard/api/webhooks/deployment"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "User-Agent: axi-deploy/1.0" \
            -d "$NOTIFICATION_DATA" \
            "$DASHBOARD_URL" \
            2>/dev/null)
          
          # è§£æå“åº”
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… éƒ¨ç½²é€šçŸ¥å‘é€æˆåŠŸ"
            echo "å“åº”: $RESPONSE_BODY"
          else
            echo "âš ï¸ éƒ¨ç½²é€šçŸ¥å‘é€å¤±è´¥ (HTTP $HTTP_CODE)"
            echo "å“åº”: $RESPONSE_BODY"
            # ä¸é€€å‡ºï¼Œå› ä¸ºè¿™åªæ˜¯é€šçŸ¥ï¼Œä¸åº”è¯¥å½±å“éƒ¨ç½²æµç¨‹
          fi

      - name: é€šçŸ¥éƒ¨ç½²å¤±è´¥
        if: failure()
        run: |
          echo "ğŸ“¤ é€šçŸ¥ axi-project-dashboard éƒ¨ç½²å¤±è´¥..."
          
          # è®¡ç®—éƒ¨ç½²è€—æ—¶
          DEPLOY_START_TIME="${{ env.DEPLOY_START_TIME }}"
          DEPLOY_END_TIME=$(date +%s)
          DEPLOY_DURATION=$((DEPLOY_END_TIME - DEPLOY_START_TIME))
          
          # æ„å»ºé€šçŸ¥æ•°æ®
          NOTIFICATION_DATA=$(cat <<EOF
          {
            "type": "deployment_completed",
            "project": "${{ inputs.project }}",
            "deployment_id": "${{ inputs.run_id }}",
            "status": "failed",
            "duration": $DEPLOY_DURATION,
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")",
            "workflow_name": "deploy-project",
            "workflow_id": "${{ github.run_id }}",
            "sourceRepo": "${{ inputs.source_repo }}",
            "deployType": "${{ inputs.deploy_type }}",
            "serverHost": "${{ inputs.server_host }}",
            "errorMessage": "éƒ¨ç½²å¤±è´¥ï¼Œè¯·æŸ¥çœ‹ GitHub Actions æ—¥å¿—",
            "started_at": "$(date -d @$DEPLOY_START_TIME -u +"%Y-%m-%dT%H:%M:%S.000Z")",
            "completed_at": "$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")"
          }
          EOF
          )
          
          echo "ğŸ“Š éƒ¨ç½²ä¿¡æ¯:"
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- çŠ¶æ€: failed"
          echo "- è€—æ—¶: ${DEPLOY_DURATION}ç§’"
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- è¿è¡ŒID: ${{ inputs.run_id }}"
          echo "- éƒ¨ç½²ç±»å‹: ${{ inputs.deploy_type }}"
          
          # å‘é€é€šçŸ¥åˆ° axi-project-dashboard
          DASHBOARD_URL="https://redamancy.com.cn/project-dashboard/api/webhooks/deployment"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "User-Agent: axi-deploy/1.0" \
            -d "$NOTIFICATION_DATA" \
            "$DASHBOARD_URL" \
            2>/dev/null)
          
          # è§£æå“åº”
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… éƒ¨ç½²å¤±è´¥é€šçŸ¥å‘é€æˆåŠŸ"
            echo "å“åº”: $RESPONSE_BODY"
          else
            echo "âš ï¸ éƒ¨ç½²å¤±è´¥é€šçŸ¥å‘é€å¤±è´¥ (HTTP $HTTP_CODE)"
            echo "å“åº”: $RESPONSE_BODY"
            # ä¸é€€å‡ºï¼Œå› ä¸ºè¿™åªæ˜¯é€šçŸ¥ï¼Œä¸åº”è¯¥å½±å“éƒ¨ç½²æµç¨‹
          fi
