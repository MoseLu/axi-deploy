name: Deploy Project

description: "é¡¹ç›®éƒ¨ç½² - éƒ¨ç½²é¡¹ç›®åˆ°ç›®æ ‡æœåŠ¡å™¨"

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
        description: "é¡¹ç›®åç§°"
      source_repo:
        required: true
        type: string
        description: "æºä»“åº“ (owner/repo)"
      run_id:
        required: true
        type: string
        description: "æž„å»ºè¿è¡ŒID"
      deploy_type:
        required: true
        type: string
        description: "éƒ¨ç½²ç±»åž‹ (backend/static)"
        default: "static"
      server_host:
        required: true
        type: string
        description: "æœåŠ¡å™¨åœ°å€"
      server_user:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç”¨æˆ·"
      server_key:
        required: true
        type: string
        description: "æœåŠ¡å™¨å¯†é’¥"
      server_port:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç«¯å£"
      deploy_center_pat:
        required: false
        type: string
        description: "GitHub Tokenç”¨äºŽä¸‹è½½æž„å»ºäº§ç‰©ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨GITHUB_TOKENï¼‰"
      apps_root:
        required: false
        type: string
        description: "åº”ç”¨ç›®å½•è·¯å¾„"
        default: "/srv/apps"
      static_root:
        required: false
        type: string
        description: "é™æ€æ–‡ä»¶ç›®å½•è·¯å¾„"
        default: "/srv/static"
      backup_root:
        required: false
        type: string
        description: "å¤‡ä»½æ ¹ç›®å½•"
        default: "/srv/backups"
      mysql_config:
        required: false
        type: string
        description: "MySQL é…ç½®ï¼ˆbase64 ç¼–ç çš„ JSONï¼‰"
      run_user:
        required: false
        type: string
        description: "è¿è¡Œç”¨æˆ·"
        default: "deploy"

    outputs:
      deploy_success:
        description: "éƒ¨ç½²æ˜¯å¦æˆåŠŸ"
        value: ${{ jobs.deploy.outputs.deploy_success }}
      deploy_path:
        description: "éƒ¨ç½²è·¯å¾„"
        value: ${{ jobs.deploy.outputs.deploy_path }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      actions: read
      packages: read
    outputs:
      deploy_success: ${{ steps.set-outputs.outputs.deploy_success }}
      deploy_path: ${{ steps.set-outputs.outputs.deploy_path }}
    
    steps:
      - name: éªŒè¯è¾“å…¥å‚æ•°
        run: |
          echo "ðŸ” éªŒè¯è¾“å…¥å‚æ•°..."
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- è¿è¡ŒID: ${{ inputs.run_id }}"
          echo "- éƒ¨ç½²ç±»åž‹: ${{ inputs.deploy_type }}"
          echo "- æœåŠ¡å™¨: ${{ inputs.server_host }}:${{ inputs.server_port }}"
          
          # è®°å½•éƒ¨ç½²å¼€å§‹æ—¶é—´
          echo "DEPLOY_START_TIME=$(date +%s)" >> $GITHUB_ENV
          
          echo "âœ… è¾“å…¥å‚æ•°éªŒè¯é€šè¿‡"

      - name: ä¸‹è½½æž„å»ºäº§ç‰©
        run: |
          # å½»åº•æ¸…ç†æ—§æ–‡ä»¶å’Œç›®å½•
          echo "ðŸ§¹ æ¸…ç†æ—§æ–‡ä»¶..."
          rm -rf dist-${{ inputs.project }}/ || true
          rm -f dist-${{ inputs.project }}.zip || true
          rm -rf backend/ || true
          rm -rf frontend/ || true
          rm -rf node_modules/ || true
          rm -f package*.json || true
          rm -f *.js || true
          rm -f *.ts || true
          rm -f deploy.sh || true
          rm -f start.sh || true
          
          # ç¡®ä¿å·¥ä½œç›®å½•å¹²å‡€
          echo "ðŸ“ å½“å‰å·¥ä½œç›®å½•å†…å®¹:"
          ls -la
          
          # ä¸‹è½½æž„å»ºäº§ç‰©
          echo "â¬‡ï¸ å¼€å§‹ä¸‹è½½æž„å»ºäº§ç‰©..."
          gh run download ${{ inputs.run_id }} \
            --name "dist-${{ inputs.project }}" \
            --dir . \
            --repo ${{ inputs.source_repo }}
          
          # éªŒè¯ä¸‹è½½ç»“æžœ
          echo "ðŸ” éªŒè¯ä¸‹è½½ç»“æžœ..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ deployment.tar.gz æ–‡ä»¶ï¼ˆaxi-star-cloud ç­‰é¡¹ç›®çš„æ ¼å¼ï¼‰
          if [ -f "deployment.tar.gz" ]; then
            echo "âœ… å‘çŽ° deployment.tar.gz æ–‡ä»¶ï¼Œè§£åŽ‹åˆ°æ ‡å‡†ç›®å½•..."
            mkdir -p "dist-${{ inputs.project }}"
            tar -xzf deployment.tar.gz -C "dist-${{ inputs.project }}"
            file_count=$(find "dist-${{ inputs.project }}" -type f | wc -l)
            echo "âœ… deployment.tar.gz è§£åŽ‹æˆåŠŸï¼ŒåŒ…å« $file_count ä¸ªæ–‡ä»¶"
            echo "ðŸ“ è§£åŽ‹åŽå†…å®¹:"
            ls -la "dist-${{ inputs.project }}/"
          elif [ -f "dist-${{ inputs.project }}.tar.gz" ]; then
            echo "âœ… æž„å»ºäº§ç‰©åŽ‹ç¼©åŒ…ä¸‹è½½æˆåŠŸ"
            echo "ðŸ“¦ è§£åŽ‹æž„å»ºäº§ç‰©åŽ‹ç¼©åŒ…..."
            tar -xzf "dist-${{ inputs.project }}.tar.gz"
            
            # æ£€æŸ¥è§£åŽ‹åŽçš„ç›®å½•ç»“æž„
            if [ -d "dist" ]; then
              echo "âœ… åŽ‹ç¼©åŒ…è§£åŽ‹æˆåŠŸï¼Œé‡å‘½åç›®å½•..."
              mv dist "dist-${{ inputs.project }}"
              file_count=$(find "dist-${{ inputs.project }}" -type f | wc -l)
              echo "âœ… æž„å»ºäº§ç‰©è§£åŽ‹æˆåŠŸï¼ŒåŒ…å« $file_count ä¸ªæ–‡ä»¶"
            else
              echo "âŒ åŽ‹ç¼©åŒ…è§£åŽ‹åŽæœªæ‰¾åˆ°é¢„æœŸçš„ dist ç›®å½•"
              echo "ðŸ“ è§£åŽ‹åŽç›®å½•å†…å®¹:"
              ls -la
              exit 1
            fi
          elif [ -d "dist-${{ inputs.project }}" ]; then
            file_count=$(find "dist-${{ inputs.project }}" -type f | wc -l)
            echo "âœ… æž„å»ºäº§ç‰©ä¸‹è½½æˆåŠŸï¼ŒåŒ…å« $file_count ä¸ªæ–‡ä»¶"
          elif [ -f "dist-${{ inputs.project }}.zip" ]; then
            echo "âœ… æž„å»ºäº§ç‰©åŽ‹ç¼©åŒ…ä¸‹è½½æˆåŠŸ"
            unzip -q "dist-${{ inputs.project }}.zip"
            file_count=$(find "dist-${{ inputs.project }}" -type f | wc -l)
            echo "âœ… æž„å»ºäº§ç‰©è§£åŽ‹æˆåŠŸï¼ŒåŒ…å« $file_count ä¸ªæ–‡ä»¶"
          elif [ -d "docs" ] && [ -d "docs/.vitepress" ] && [ -d "docs/.vitepress/dist" ]; then
            echo "âœ… å‘çŽ° VitePress æž„å»ºäº§ç‰©ç›®å½•ç»“æž„"
            echo "ðŸ“¦ ç§»åŠ¨æž„å»ºäº§ç‰©åˆ°æ ‡å‡†ä½ç½®..."
            mv docs/.vitepress/dist "dist-${{ inputs.project }}"
            file_count=$(find "dist-${{ inputs.project }}" -type f | wc -l)
            echo "âœ… æž„å»ºäº§ç‰©ç§»åŠ¨æˆåŠŸï¼ŒåŒ…å« $file_count ä¸ªæ–‡ä»¶"
          else
            echo "ðŸ“ æœªæ‰¾åˆ°æ ‡å‡†æž„å»ºäº§ç‰©ï¼Œæ£€æŸ¥å½“å‰ç›®å½•å†…å®¹..."
            echo "ðŸ“ å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æž„å»ºäº§ç‰©æ–‡ä»¶
            if [ -d "backend" ] || [ -d "frontend" ] || [ -f "package.json" ] || [ -f "index.html" ] || [ -f "star-cloud-linux" ] || [ -d "front" ]; then
              echo "âœ… å‘çŽ°é¡¹ç›®æ–‡ä»¶ï¼Œåˆ›å»ºæ ‡å‡†æž„å»ºäº§ç‰©ç›®å½•..."
              mkdir -p "dist-${{ inputs.project }}"
              
              # ç§»åŠ¨æ‰€æœ‰é¡¹ç›®æ–‡ä»¶åˆ°æž„å»ºäº§ç‰©ç›®å½•
              if [ -d "backend" ]; then
                mv backend "dist-${{ inputs.project }}/"
              fi
              if [ -d "frontend" ]; then
                mv frontend "dist-${{ inputs.project }}/"
              fi
              if [ -d "front" ]; then
                mv front "dist-${{ inputs.project }}/"
              fi
              if [ -f "package.json" ]; then
                mv package.json "dist-${{ inputs.project }}/"
              fi
              if [ -f "index.html" ]; then
                mv index.html "dist-${{ inputs.project }}/"
              fi
              if [ -f "ecosystem.config.js" ]; then
                mv ecosystem.config.js "dist-${{ inputs.project }}/"
              fi
              if [ -f "deploy.sh" ]; then
                mv deploy.sh "dist-${{ inputs.project }}/"
              fi
              if [ -f "start.sh" ]; then
                mv start.sh "dist-${{ inputs.project }}/"
              fi
              if [ -f "star-cloud-linux" ]; then
                mv star-cloud-linux "dist-${{ inputs.project }}/"
              fi
              if [ -f "star-cloud.service" ]; then
                mv star-cloud.service "dist-${{ inputs.project }}/"
              fi
              if [ -d "config" ]; then
                mv config "dist-${{ inputs.project }}/"
              fi
              
              file_count=$(find "dist-${{ inputs.project }}" -type f | wc -l)
              echo "âœ… æž„å»ºäº§ç‰©é‡æ–°ç»„ç»‡å®Œæˆï¼ŒåŒ…å« $file_count ä¸ªæ–‡ä»¶"
              echo "ðŸ“ æž„å»ºäº§ç‰©å†…å®¹:"
              ls -la "dist-${{ inputs.project }}/"
            else
              echo "âŒ æž„å»ºäº§ç‰©ä¸‹è½½å¤±è´¥ï¼Œæ— æ³•æ‰¾åˆ°æœ‰æ•ˆçš„é¡¹ç›®æ–‡ä»¶"
              echo "ðŸ“ å½“å‰ç›®å½•å†…å®¹:"
              ls -la
              exit 1
            fi
          fi
          
          # æœ€ç»ˆéªŒè¯
          if [ ! -d "dist-${{ inputs.project }}" ] || [ "$(find "dist-${{ inputs.project }}" -type f | wc -l)" -eq 0 ]; then
            echo "âŒ æž„å»ºäº§ç‰©éªŒè¯å¤±è´¥ï¼Œç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
            echo "ðŸ“ å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi
          
          echo "âœ… æž„å»ºäº§ç‰©éªŒè¯é€šè¿‡"
        env:
          GH_TOKEN: ${{ inputs.deploy_center_pat || github.token }}

      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ðŸš€ å¼€å§‹éƒ¨ç½² ${{ inputs.project }}..."
            
            PROJECT="${{ inputs.project }}"
            DEPLOY_TYPE="${{ inputs.deploy_type }}"
            APPS_ROOT="${{ inputs.apps_root }}"
            STATIC_ROOT="${{ inputs.static_root }}"
            BACKUP_ROOT="${{ inputs.backup_root }}"
            RUN_USER="${{ inputs.run_user }}"
            
            echo "ðŸ“‹ éƒ¨ç½²é…ç½®:"
            echo "- é¡¹ç›®: $PROJECT"
            echo "- ç±»åž‹: $DEPLOY_TYPE"
            echo "- åº”ç”¨ç›®å½•: $APPS_ROOT"
            echo "- é™æ€ç›®å½•: $STATIC_ROOT"
            echo "- å¤‡ä»½ç›®å½•: $BACKUP_ROOT"
            echo "- è¿è¡Œç”¨æˆ·: $RUN_USER"
            
            # ç¡®å®šéƒ¨ç½²è·¯å¾„
            if [ "$DEPLOY_TYPE" = "backend" ]; then
              DEPLOY_PATH="$APPS_ROOT/$PROJECT"
              BACKUP_PATH="$BACKUP_ROOT/$PROJECT"
            else
              DEPLOY_PATH="$STATIC_ROOT/$PROJECT"
              BACKUP_PATH="$BACKUP_ROOT/$PROJECT"
            fi
            
            echo "ðŸ“ éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"
            echo "ðŸ“ å¤‡ä»½è·¯å¾„: $BACKUP_PATH"
            
            # åˆ›å»ºå¿…è¦çš„ç›®å½•
            sudo mkdir -p "$APPS_ROOT" "$STATIC_ROOT" "$BACKUP_ROOT"
            sudo chown -R $RUN_USER:$RUN_USER "$APPS_ROOT" "$STATIC_ROOT" "$BACKUP_ROOT"
            
            # å¤‡ä»½çŽ°æœ‰éƒ¨ç½²ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
            if [ -d "$DEPLOY_PATH" ]; then
              echo "ðŸ“¦ å¤‡ä»½çŽ°æœ‰éƒ¨ç½²..."
              BACKUP_TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              BACKUP_NAME="$PROJECT.backup.$BACKUP_TIMESTAMP"
              sudo cp -r "$DEPLOY_PATH" "$BACKUP_PATH/$BACKUP_NAME"
              sudo chown -R $RUN_USER:$RUN_USER "$BACKUP_PATH/$BACKUP_NAME"
              echo "âœ… çŽ°æœ‰éƒ¨ç½²å·²å¤‡ä»½åˆ°: $BACKUP_PATH/$BACKUP_NAME"
              
              # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰
              echo "ðŸ§¹ æ¸…ç†æ—§å¤‡ä»½..."
              OLD_BACKUPS=$(ls -t "$BACKUP_PATH"/$PROJECT.backup.* 2>/dev/null | tail -n +6)
              if [ -n "$OLD_BACKUPS" ]; then
                echo "ðŸ—‘ï¸ åˆ é™¤æ—§å¤‡ä»½:"
                echo "$OLD_BACKUPS" | xargs -r sudo rm -rf
              fi
            else
              echo "ðŸ“‹ æ²¡æœ‰çŽ°æœ‰éƒ¨ç½²éœ€è¦å¤‡ä»½"
            fi
            
            # æ¸…ç†ç›®æ ‡éƒ¨ç½²ç›®å½•ï¼ˆé¿å…æ®‹ç•™æ–‡ä»¶ï¼‰
            echo "ðŸ§¹ æ¸…ç†ç›®æ ‡éƒ¨ç½²ç›®å½•..."
            sudo rm -rf "$DEPLOY_PATH"/*
            sudo mkdir -p "$DEPLOY_PATH"
            sudo chown -R $RUN_USER:$RUN_USER "$DEPLOY_PATH"
            
            echo "âœ… ç›®æ ‡ç›®å½•å·²å‡†å¤‡å°±ç»ª"

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©åˆ°éƒ¨ç½²ç›®å½•
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          source: "./dist-${{ inputs.project }}/"
          target: "${{ inputs.deploy_type == 'backend' && format('{0}/{1}', inputs.apps_root || '/srv/apps', inputs.project) || format('{0}/{1}', inputs.static_root || '/srv/static', inputs.project) }}"
          strip_components: 0
          overwrite: true

      - name: éªŒè¯éƒ¨ç½²ç»“æžœ
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ðŸ” éªŒè¯éƒ¨ç½²ç»“æžœ..."
            
            PROJECT="${{ inputs.project }}"
            
            # æ ¹æ®éƒ¨ç½²ç±»åž‹ç¡®å®šéƒ¨ç½²è·¯å¾„
            if [[ "${{ inputs.deploy_type }}" == "backend" ]]; then
              DEPLOY_PATH="${{ inputs.apps_root || '/srv/apps' }}/$PROJECT"
            else
              DEPLOY_PATH="${{ inputs.static_root || '/srv/static' }}/$PROJECT"
            fi
            
            echo "ðŸ“ æ£€æŸ¥éƒ¨ç½²ç›®å½•: $DEPLOY_PATH"
            
            if [ -d "$DEPLOY_PATH" ] && [ "$(ls -A $DEPLOY_PATH)" ]; then
              final_file_count=$(find "$DEPLOY_PATH" -type f | wc -l)
              echo "âœ… éƒ¨ç½²éªŒè¯é€šè¿‡"
              echo "ðŸ“ éƒ¨ç½²ç›®å½•å†…å®¹:"
              ls -la $DEPLOY_PATH/
              echo "ðŸ“Š æœ€ç»ˆæ–‡ä»¶æ•°é‡: $final_file_count"
              if [ "$final_file_count" -gt 0 ]; then
                echo "âœ… éƒ¨ç½²æˆåŠŸ"
                exit 0
              else
                echo "âŒ éƒ¨ç½²åŽç›®å½•ä¸ºç©º"
                exit 1
              fi
            else
              echo "ðŸš¨ éƒ¨ç½²éªŒè¯å¤±è´¥"
              exit 1
            fi

      - name: MySQL æ•°æ®åº“å¤‡ä»½
        if: inputs.deploy_type == 'backend' && inputs.mysql_config != ''
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ðŸ—„ï¸ å¼€å§‹ MySQL æ•°æ®åº“å¤‡ä»½..."
            
            # è§£æž MySQL é…ç½®
            MYSQL_CONFIG_JSON=$(echo "${{ inputs.mysql_config }}" | base64 -d)
            echo "ðŸ“„ MySQL é…ç½®: $MYSQL_CONFIG_JSON"
            
            # æå–å„ä¸ªå‚æ•°
            MYSQL_HOST=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.mysql_host // "localhost"')
            MYSQL_PORT=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.mysql_port // "3306"')
            MYSQL_USER=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.mysql_user // "root"')
            MYSQL_PASSWORD=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.mysql_password // ""')
            DATABASE_NAME=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.database_name // ""')
            BACKUP_METHOD=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.backup_method // "mysqldump"')
            BACKUP_RETENTION_DAYS=$(echo "$MYSQL_CONFIG_JSON" | jq -r '.backup_retention_days // "30"')
            PROJECT="${{ inputs.project }}"
            APPS_ROOT="${{ inputs.apps_root }}"
            BACKUP_ROOT="${{ inputs.backup_root }}"
            
            echo "ðŸ“‹ MySQL é…ç½®:"
            echo "- ä¸»æœº: $MYSQL_HOST:$MYSQL_PORT"
            echo "- ç”¨æˆ·: $MYSQL_USER"
            echo "- æ•°æ®åº“: $DATABASE_NAME"
            echo "- å¤‡ä»½æ–¹æ³•: $BACKUP_METHOD"
            echo "- ä¿ç•™å¤©æ•°: $BACKUP_RETENTION_DAYS"
            
            # æ£€æŸ¥ MySQL è¿žæŽ¥
            echo "ðŸ” æ£€æŸ¥ MySQL è¿žæŽ¥..."
            
            # å°è¯•ä»ŽæœåŠ¡å™¨é…ç½®ä¸­èŽ·å–å¯†ç 
            echo "ðŸ” å°è¯•ä»ŽæœåŠ¡å™¨é…ç½®èŽ·å– MySQL å¯†ç ..."
            SERVER_PASSWORD=""
            
            # æ£€æŸ¥ init-database.sh ä¸­çš„å¯†ç 
            if [ -f "/srv/apps/$PROJECT/scripts/init-database.sh" ]; then
              echo "ðŸ” æ£€æŸ¥ init-database.sh ä¸­çš„å¯†ç é…ç½®..."
              SERVER_PASSWORD=$(grep -o 'DB_PASSWORD="[^"]*"' "/srv/apps/$PROJECT/scripts/init-database.sh" | cut -d'"' -f2)
              if [ -n "$SERVER_PASSWORD" ]; then
                echo "âœ… ä»Ž init-database.sh èŽ·å–åˆ°å¯†ç "
              fi
            fi
            
            # æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„å¯†ç 
            if [ -z "$SERVER_PASSWORD" ] && [ -f "/srv/apps/$PROJECT/config/config.yaml" ]; then
              echo "ðŸ” æ£€æŸ¥ config.yaml ä¸­çš„å¯†ç é…ç½®..."
              SERVER_PASSWORD=$(grep -A5 "database:" "/srv/apps/$PROJECT/config/config.yaml" | grep "password:" | awk '{print $2}' | tr -d "'" | tr -d '"')
              if [ -n "$SERVER_PASSWORD" ]; then
                echo "âœ… ä»Ž config.yaml èŽ·å–åˆ°å¯†ç "
              fi
            fi
            
            # å°è¯•ä¸åŒçš„è¿žæŽ¥æ–¹å¼
            if [ -n "$MYSQL_PASSWORD" ]; then
              echo "ðŸ” å°è¯•ä½¿ç”¨ä¼ é€’çš„å¯†ç è¿žæŽ¥..."
              if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" -e "SELECT 1;" >/dev/null 2>&1; then
                echo "âœ… MySQL è¿žæŽ¥æˆåŠŸï¼ˆä½¿ç”¨ä¼ é€’çš„å¯†ç ï¼‰"
                MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASSWORD"
                MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASSWORD"
              elif [ -n "$SERVER_PASSWORD" ]; then
                echo "ðŸ” å°è¯•ä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç è¿žæŽ¥..."
                if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -p"$SERVER_PASSWORD" -e "SELECT 1;" >/dev/null 2>&1; then
                  echo "âœ… MySQL è¿žæŽ¥æˆåŠŸï¼ˆä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç ï¼‰"
                  # åˆ›å»ºä¸´æ—¶å¯†ç æ–‡ä»¶ï¼ˆæ›´å®‰å…¨çš„æ–¹å¼ï¼‰
                  echo "[client]" > /tmp/mysql.cnf
                  echo "password=$SERVER_PASSWORD" >> /tmp/mysql.cnf
                  chmod 600 /tmp/mysql.cnf
                  MYSQL_CMD="mysql --defaults-extra-file=/tmp/mysql.cnf -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                  MYSQLDUMP_CMD="mysqldump --defaults-extra-file=/tmp/mysql.cnf -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                else
                  echo "âŒ ä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç è¿žæŽ¥å¤±è´¥ï¼Œå°è¯•æ— å¯†ç è¿žæŽ¥..."
                  if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -e "SELECT 1;" >/dev/null 2>&1; then
                    echo "âœ… MySQL è¿žæŽ¥æˆåŠŸï¼ˆæ— å¯†ç ï¼‰"
                    MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                    MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                  else
                    echo "âŒ MySQL è¿žæŽ¥å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½"
                    exit 0
                  fi
                fi
              else
                echo "âŒ ä½¿ç”¨ä¼ é€’çš„å¯†ç è¿žæŽ¥å¤±è´¥ï¼Œå°è¯•æ— å¯†ç è¿žæŽ¥..."
                if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -e "SELECT 1;" >/dev/null 2>&1; then
                  echo "âœ… MySQL è¿žæŽ¥æˆåŠŸï¼ˆæ— å¯†ç ï¼‰"
                  MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                  MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                else
                  echo "âŒ MySQL è¿žæŽ¥å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½"
                  exit 0
                fi
              fi
            elif [ -n "$SERVER_PASSWORD" ]; then
              echo "ðŸ” å°è¯•ä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç è¿žæŽ¥..."
              if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -p"$SERVER_PASSWORD" -e "SELECT 1;" >/dev/null 2>&1; then
                echo "âœ… MySQL è¿žæŽ¥æˆåŠŸï¼ˆä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç ï¼‰"
                # åˆ›å»ºä¸´æ—¶å¯†ç æ–‡ä»¶ï¼ˆæ›´å®‰å…¨çš„æ–¹å¼ï¼‰
                echo "[client]" > /tmp/mysql.cnf
                echo "password=$SERVER_PASSWORD" >> /tmp/mysql.cnf
                chmod 600 /tmp/mysql.cnf
                MYSQL_CMD="mysql --defaults-extra-file=/tmp/mysql.cnf -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                MYSQLDUMP_CMD="mysqldump --defaults-extra-file=/tmp/mysql.cnf -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
              else
                echo "âŒ ä½¿ç”¨æœåŠ¡å™¨é…ç½®å¯†ç è¿žæŽ¥å¤±è´¥ï¼Œå°è¯•æ— å¯†ç è¿žæŽ¥..."
                if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -e "SELECT 1;" >/dev/null 2>&1; then
                  echo "âœ… MySQL è¿žæŽ¥æˆåŠŸï¼ˆæ— å¯†ç ï¼‰"
                  MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                  MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                else
                  echo "âŒ MySQL è¿žæŽ¥å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½"
                  exit 0
                fi
              fi
            else
              echo "ðŸ” å°è¯•æ— å¯†ç è¿žæŽ¥..."
              if mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -e "SELECT 1;" >/dev/null 2>&1; then
                echo "âœ… MySQL è¿žæŽ¥æˆåŠŸï¼ˆæ— å¯†ç ï¼‰"
                MYSQL_CMD="mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
                MYSQLDUMP_CMD="mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER"
              else
                echo "âŒ MySQL è¿žæŽ¥å¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½"
                exit 0
              fi
            fi
            
            # åˆ›å»ºå¤‡ä»½ç›®å½•
            BACKUP_DIR="$BACKUP_ROOT/$PROJECT/mysql"
            sudo mkdir -p "$BACKUP_DIR"
            sudo chown -R $USER:$USER "$BACKUP_DIR"
            
            # æ‰§è¡Œå¤‡ä»½
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_FILE="$BACKUP_DIR/${DATABASE_NAME}_${TIMESTAMP}.sql"
            
            echo "ðŸ“¦ æ‰§è¡Œæ•°æ®åº“å¤‡ä»½..."
            if [ "$BACKUP_METHOD" = "mysqldump" ]; then
              $MYSQLDUMP_CMD \
                --single-transaction --routines --triggers --events \
                "$DATABASE_NAME" > "$BACKUP_FILE"
            else
              echo "âŒ ä¸æ”¯æŒçš„å¤‡ä»½æ–¹æ³•: $BACKUP_METHOD"
              exit 1
            fi
            
            if [ $? -eq 0 ]; then
              echo "âœ… æ•°æ®åº“å¤‡ä»½æˆåŠŸ: $BACKUP_FILE"
              
              # åŽ‹ç¼©å¤‡ä»½æ–‡ä»¶
              gzip "$BACKUP_FILE"
              echo "ðŸ“¦ å¤‡ä»½æ–‡ä»¶å·²åŽ‹ç¼©: ${BACKUP_FILE}.gz"
              
              # æ¸…ç†æ—§å¤‡ä»½
              echo "ðŸ§¹ æ¸…ç†è¿‡æœŸå¤‡ä»½æ–‡ä»¶..."
              find "$BACKUP_DIR" -name "*.sql.gz" -mtime +$BACKUP_RETENTION_DAYS -delete
              echo "âœ… è¿‡æœŸå¤‡ä»½æ–‡ä»¶å·²æ¸…ç†"
              
              # è®¾ç½®å®šæ—¶å¤‡ä»½ä»»åŠ¡
              if [ -n "$MYSQL_PASSWORD" ]; then
                CRON_JOB="0 2 * * * mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASSWORD --single-transaction --routines --triggers --events $DATABASE_NAME | gzip > $BACKUP_DIR/${DATABASE_NAME}_\$(date +\\%Y\\%m\\%d_\\%H\\%M\\%S).sql.gz"
              elif [ -n "$SERVER_PASSWORD" ]; then
                # åˆ›å»ºå®šæ—¶ä»»åŠ¡ä½¿ç”¨çš„å¯†ç æ–‡ä»¶
                echo "[client]" > /tmp/cron_mysql.cnf
                echo "password=$SERVER_PASSWORD" >> /tmp/cron_mysql.cnf
                chmod 600 /tmp/cron_mysql.cnf
                CRON_JOB="0 2 * * * mysqldump --defaults-extra-file=/tmp/cron_mysql.cnf -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER --single-transaction --routines --triggers --events $DATABASE_NAME | gzip > $BACKUP_DIR/${DATABASE_NAME}_\$(date +\\%Y\\%m\\%d_\\%H\\%M\\%S).sql.gz"
              else
                CRON_JOB="0 2 * * * mysqldump -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER --single-transaction --routines --triggers --events $DATABASE_NAME | gzip > $BACKUP_DIR/${DATABASE_NAME}_\$(date +\\%Y\\%m\\%d_\\%H\\%M\\%S).sql.gz"
              fi
              
              # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å®šæ—¶ä»»åŠ¡
              if ! crontab -l 2>/dev/null | grep -q "$DATABASE_NAME"; then
                echo "â° è®¾ç½®å®šæ—¶å¤‡ä»½ä»»åŠ¡..."
                (crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -
                echo "âœ… å®šæ—¶å¤‡ä»½ä»»åŠ¡å·²è®¾ç½®"
              else
                echo "ðŸ“‹ å®šæ—¶å¤‡ä»½ä»»åŠ¡å·²å­˜åœ¨"
              fi
            else
              echo "âŒ æ•°æ®åº“å¤‡ä»½å¤±è´¥"
              exit 1
            fi

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          if [[ "${{ inputs.deploy_type }}" == "backend" ]]; then
            DEPLOY_PATH="/srv/apps/${{ inputs.project }}"
          else
            DEPLOY_PATH="/srv/static/${{ inputs.project }}"
          fi
          
          echo "deploy_success=true" >> $GITHUB_OUTPUT
          echo "deploy_path=$DEPLOY_PATH" >> $GITHUB_OUTPUT
          echo "âœ… è¾“å‡ºå·²è®¾ç½®"
          echo "- deploy_success: true"
          echo "- deploy_path: $DEPLOY_PATH"
