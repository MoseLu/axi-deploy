name: Retry Center Example

description: "é‡è¯•ä¸­å¿ƒä½¿ç”¨ç¤ºä¾‹ - å±•ç¤ºå¦‚ä½•åœ¨å…¶ä»–å·¥ä½œæµä¸­ä½¿ç”¨é‡è¯•ä¸­å¿ƒ"

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æµ‹è¯•ç±»å‹'
        required: false
        default: 'network'
        type: choice
        options:
          - network
          - file_operation
          - validation
          - parsing

jobs:
  # ç¤ºä¾‹1ï¼šç½‘ç»œæ“ä½œé‡è¯•
  network-retry-example:
    if: inputs.test_type == 'network'
    uses: ./.github/workflows/retry-center.yml
    with:
      step_name: "ç½‘ç»œè¿æ¥æµ‹è¯•"
      command: |
        echo "ğŸŒ æµ‹è¯•ç½‘ç»œè¿æ¥..."
        # æ¨¡æ‹Ÿç½‘ç»œæ“ä½œ
        curl -f --connect-timeout 10 https://httpbin.org/delay/3
        echo "âœ… ç½‘ç»œè¿æ¥æµ‹è¯•æˆåŠŸ"
      max_retries: 3
      retry_delay: 10
      timeout_minutes: 15
      strategy: "exponential"
      step_type: "network"
      continue_on_error: false
      notify_on_failure: true
      env_vars: '{"CURL_TIMEOUT": "10", "RETRY_ON_TIMEOUT": "true"}'

  # ç¤ºä¾‹2ï¼šæ–‡ä»¶æ“ä½œé‡è¯•
  file-operation-retry-example:
    if: inputs.test_type == 'file_operation'
    uses: ./.github/workflows/retry-center.yml
    with:
      step_name: "æ–‡ä»¶ä¸‹è½½æµ‹è¯•"
      command: |
        echo "ğŸ“ æµ‹è¯•æ–‡ä»¶æ“ä½œ..."
        # æ¨¡æ‹Ÿæ–‡ä»¶ä¸‹è½½
        wget --timeout=10 --tries=1 https://httpbin.org/bytes/1024 -O test-file
        if [ -f test-file ]; then
          echo "âœ… æ–‡ä»¶ä¸‹è½½æˆåŠŸ"
          rm test-file
        else
          echo "âŒ æ–‡ä»¶ä¸‹è½½å¤±è´¥"
          exit 1
        fi
      max_retries: 2
      retry_delay: 5
      timeout_minutes: 10
      strategy: "simple"
      step_type: "file_operation"
      continue_on_error: false
      notify_on_failure: true

  # ç¤ºä¾‹3ï¼šéªŒè¯æ“ä½œé‡è¯•
  validation-retry-example:
    if: inputs.test_type == 'validation'
    uses: ./.github/workflows/retry-center.yml
    with:
      step_name: "æœåŠ¡éªŒè¯æµ‹è¯•"
      command: |
        echo "ğŸ” æµ‹è¯•æœåŠ¡éªŒè¯..."
        # æ¨¡æ‹ŸæœåŠ¡å¥åº·æ£€æŸ¥
        response=$(curl -s -o /dev/null -w "%{http_code}" https://httpbin.org/status/200)
        if [ "$response" = "200" ]; then
          echo "âœ… æœåŠ¡éªŒè¯æˆåŠŸ"
        else
          echo "âŒ æœåŠ¡éªŒè¯å¤±è´¥ï¼ŒçŠ¶æ€ç : $response"
          exit 1
        fi
      max_retries: 1
      retry_delay: 3
      timeout_minutes: 5
      strategy: "simple"
      step_type: "validation"
      continue_on_error: true
      notify_on_failure: false

  # ç¤ºä¾‹4ï¼šè§£ææ“ä½œé‡è¯•
  parsing-retry-example:
    if: inputs.test_type == 'parsing'
    uses: ./.github/workflows/retry-center.yml
    with:
      step_name: "JSONè§£ææµ‹è¯•"
      command: |
        echo "ğŸ“ æµ‹è¯•JSONè§£æ..."
        # æ¨¡æ‹ŸJSONè§£æ
        echo '{"status": "success", "data": "test"}' | jq -r '.status'
        if [ $? -eq 0 ]; then
          echo "âœ… JSONè§£ææˆåŠŸ"
        else
          echo "âŒ JSONè§£æå¤±è´¥"
          exit 1
        fi
      max_retries: 0
      retry_delay: 0
      timeout_minutes: 2
      strategy: "simple"
      step_type: "parsing"
      continue_on_error: false
      notify_on_failure: true

  # ç»“æœæ±‡æ€»
  summarize-results:
    needs: [network-retry-example, file-operation-retry-example, validation-retry-example, parsing-retry-example]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: æ±‡æ€»é‡è¯•ç»“æœ
        run: |
          echo "ğŸ“Š é‡è¯•ä¸­å¿ƒæµ‹è¯•ç»“æœæ±‡æ€»"
          echo "========================"
          echo "æµ‹è¯•æ—¶é—´: $(date)"
          echo "æµ‹è¯•ç±»å‹: ${{ inputs.test_type }}"
          echo ""
          
          # æ£€æŸ¥å„ä¸ªæµ‹è¯•çš„ç»“æœ
          if [ "${{ needs.network-retry-example.result }}" = "success" ]; then
            echo "âœ… ç½‘ç»œæ“ä½œé‡è¯•æµ‹è¯•: æˆåŠŸ"
          else
            echo "âŒ ç½‘ç»œæ“ä½œé‡è¯•æµ‹è¯•: å¤±è´¥"
          fi
          
          if [ "${{ needs.file-operation-retry-example.result }}" = "success" ]; then
            echo "âœ… æ–‡ä»¶æ“ä½œé‡è¯•æµ‹è¯•: æˆåŠŸ"
          else
            echo "âŒ æ–‡ä»¶æ“ä½œé‡è¯•æµ‹è¯•: å¤±è´¥"
          fi
          
          if [ "${{ needs.validation-retry-example.result }}" = "success" ]; then
            echo "âœ… éªŒè¯æ“ä½œé‡è¯•æµ‹è¯•: æˆåŠŸ"
          else
            echo "âŒ éªŒè¯æ“ä½œé‡è¯•æµ‹è¯•: å¤±è´¥"
          fi
          
          if [ "${{ needs.parsing-retry-example.result }}" = "success" ]; then
            echo "âœ… è§£ææ“ä½œé‡è¯•æµ‹è¯•: æˆåŠŸ"
          else
            echo "âŒ è§£ææ“ä½œé‡è¯•æµ‹è¯•: å¤±è´¥"
          fi
          
          echo ""
          echo "ğŸ“‹ é‡è¯•æŠ¥å‘Šå·²ä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©"
          echo "ğŸ” è¯·æŸ¥çœ‹é‡è¯•æŠ¥å‘Šäº†è§£è¯¦ç»†ä¿¡æ¯"
