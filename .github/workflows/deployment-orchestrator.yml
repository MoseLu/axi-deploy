name: Deployment Orchestrator

description: "éƒ¨ç½²æµç¨‹ç¼–æ’å™¨ - åè°ƒæ•´ä¸ªéƒ¨ç½²æµç¨‹"

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
        description: "é¡¹ç›®åç§°"
      source_repo:
        required: true
        type: string
        description: "æºä»“åº“ (owner/repo)"
      run_id:
        required: true
        type: string
        description: "æ„å»ºè¿è¡ŒID"
      deploy_type:
        required: true
        type: string
        description: "éƒ¨ç½²ç±»å‹ (backend/static)"
        default: "static"
      nginx_config:
        required: false
        type: string
        description: "Nginxé…ç½®"
        default: ""
      test_url:
        required: false
        type: string
        description: "æµ‹è¯•URL"
        default: ""
      start_cmd:
        required: false
        type: string
        description: "å¯åŠ¨å‘½ä»¤"
        default: ""
      domain:
        required: false
        type: string
        description: "åŸŸå"
        default: "redamancy.com.cn"
      apps_root:
        required: false
        type: string
        description: "åº”ç”¨ç›®å½•è·¯å¾„"
        default: "/srv/apps"
      static_root:
        required: false
        type: string
        description: "é™æ€æ–‡ä»¶ç›®å½•è·¯å¾„"
        default: "/srv/static"
      backup_root:
        required: false
        type: string
        description: "å¤‡ä»½æ ¹ç›®å½•"
        default: "/srv/backups"
      run_user:
        required: false
        type: string
        description: "è¿è¡Œç”¨æˆ·"
        default: "deploy"
      nginx_conf_dir:
        required: false
        type: string
        description: "Nginxé…ç½®ç›®å½•"
        default: "/www/server/nginx/conf/conf.d/redamancy"
      backend_port:
        required: false
        type: string
        description: "åç«¯æœåŠ¡ç«¯å£"
        default: "8080"
      service_name:
        required: false
        type: string
        description: "æœåŠ¡åç§°"
        default: "star-cloud"
      github_token:
        required: false
        type: string
        description: "GitHub Token"
      server_host:
        required: false
        type: string
        description: "æœåŠ¡å™¨åœ°å€"
      server_user:
        required: false
        type: string
        description: "æœåŠ¡å™¨ç”¨æˆ·"
      server_key:
        required: false
        type: string
        description: "æœåŠ¡å™¨å¯†é’¥"
      server_port:
        required: false
        type: string
        description: "æœåŠ¡å™¨ç«¯å£"
      deploy_center_pat:
        required: true
        type: string
        description: "GitHub Token (ç”¨äºä¸‹è½½æ„å»ºäº§ç‰©)"

jobs:
  download-artifact:
    uses: MoseLu/axi-deploy/.github/workflows/download-artifact.yml@master
    with:
      project: ${{ inputs.project }}
      source_repo: ${{ inputs.source_repo }}
      run_id: ${{ inputs.run_id }}
      github_token: ${{ inputs.deploy_center_pat }}

  upload-files:
    needs: download-artifact
    uses: MoseLu/axi-deploy/.github/workflows/upload-files.yml@master
    with:
      project: ${{ inputs.project }}
      server_host: ${{ inputs.server_host }}
      server_user: ${{ inputs.server_user }}
      server_key: ${{ inputs.server_key }}
      server_port: ${{ inputs.server_port }}
      artifact_path: ${{ needs.download-artifact.outputs.artifact_path }}
      run_user: ${{ inputs.run_user }}

  deploy-project:
    needs: upload-files
    uses: MoseLu/axi-deploy/.github/workflows/deploy-project.yml@master
    with:
      project: ${{ inputs.project }}
      deploy_type: ${{ inputs.deploy_type }}
      server_host: ${{ inputs.server_host }}
      server_user: ${{ inputs.server_user }}
      server_key: ${{ inputs.server_key }}
      server_port: ${{ inputs.server_port }}
      apps_root: ${{ inputs.apps_root }}
      static_root: ${{ inputs.static_root }}
      backup_root: ${{ inputs.backup_root }}
      run_user: ${{ inputs.run_user }}

  configure-nginx:
    needs: deploy-project
    if: ${{ inputs.nginx_config != '' }}
    uses: MoseLu/axi-deploy/.github/workflows/configure-nginx.yml@master
    with:
      project: ${{ inputs.project }}
      nginx_config: ${{ inputs.nginx_config }}
      server_host: ${{ inputs.server_host }}
      server_user: ${{ inputs.server_user }}
      server_key: ${{ inputs.server_key }}
      server_port: ${{ inputs.server_port }}
      domain: ${{ inputs.domain }}
      nginx_conf_dir: ${{ inputs.nginx_conf_dir }}
      apps_root: ${{ inputs.apps_root }}
      static_root: ${{ inputs.static_root }}
      backend_port: ${{ inputs.backend_port }}
      service_name: ${{ inputs.service_name }}
      deploy_type: ${{ inputs.deploy_type }}

  start-service:
    needs: [deploy-project, configure-nginx]
    if: ${{ inputs.start_cmd != '' && inputs.deploy_type == 'backend' }}
    uses: MoseLu/axi-deploy/.github/workflows/start-service.yml@master
    with:
      project: ${{ inputs.project }}
      start_cmd: ${{ inputs.start_cmd }}
      deploy_type: ${{ inputs.deploy_type }}
      server_host: ${{ inputs.server_host }}
      server_user: ${{ inputs.server_user }}
      server_key: ${{ inputs.server_key }}
      server_port: ${{ inputs.server_port }}
      apps_root: ${{ inputs.apps_root }}

  test-website:
    needs: [deploy-project, configure-nginx, start-service]
    if: ${{ inputs.test_url != '' }}
    uses: MoseLu/axi-deploy/.github/workflows/test-website.yml@master
    with:
      project: ${{ inputs.project }}
      test_url: ${{ inputs.test_url }}
      deploy_type: ${{ inputs.deploy_type }}
      server_host: ${{ inputs.server_host }}
      server_user: ${{ inputs.server_user }}
      server_key: ${{ inputs.server_key }}
      server_port: ${{ inputs.server_port }}
      apps_root: ${{ inputs.apps_root }}
      static_root: ${{ inputs.static_root }}
      nginx_conf_dir: ${{ inputs.nginx_conf_dir }}

  deployment-summary:
    needs: [download-artifact, upload-files, deploy-project, configure-nginx, start-service, test-website]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: éƒ¨ç½²å®Œæˆæ€»ç»“
        run: |
          echo "ğŸ‰ éƒ¨ç½²æµç¨‹å®Œæˆ"
          echo "=========================================="
          echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯:"
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- éƒ¨ç½²ç±»å‹: ${{ inputs.deploy_type }}"
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- æ„å»ºID: ${{ inputs.run_id }}"
          echo ""
          echo "ğŸ“Š æ‰§è¡ŒçŠ¶æ€:"
          echo "- ä¸‹è½½æ„å»ºäº§ç‰©: ${{ needs.download-artifact.result }}"
          echo "- ä¸Šä¼ æ–‡ä»¶: ${{ needs.upload-files.result }}"
          echo "- éƒ¨ç½²é¡¹ç›®: ${{ needs.deploy-project.result }}"
          echo "- é…ç½®Nginx: ${{ needs.configure-nginx.result || 'skipped' }}"
          echo "- å¯åŠ¨æœåŠ¡: ${{ needs.start-service.result || 'skipped' }}"
          echo "- ç½‘ç«™æµ‹è¯•: ${{ needs.test-website.result || 'skipped' }}"
          echo ""
          echo "ğŸ”— è®¿é—®ä¿¡æ¯:"
          echo "- åŸŸå: ${{ inputs.domain }}"
          echo "- é¡¹ç›®è·¯å¾„: ${{ inputs.apps_root }}/${{ inputs.project }}"
          if [ "${{ inputs.test_url }}" != "" ]; then
            echo "- æµ‹è¯•URL: ${{ inputs.test_url }}"
          fi
          echo "=========================================="
