name: Download Artifact

description: "ä¸‹è½½æ„å»ºäº§ç‰© - ä» GitHub Actions ä¸‹è½½é¡¹ç›®çš„æ„å»ºäº§ç‰©"

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
        description: "é¡¹ç›®åç§°"
      source_repo:
        required: true
        type: string
        description: "æºä»“åº“ (owner/repo)"
      run_id:
        required: true
        type: string
        description: "æ„å»ºè¿è¡ŒID"
      deploy_center_pat:
        required: false
        type: string
        description: "GitHub Tokenç”¨äºä¸‹è½½æ„å»ºäº§ç‰©ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨GITHUB_TOKENï¼‰"
    outputs:
      download_success:
        description: "ä¸‹è½½æ˜¯å¦æˆåŠŸ"
        value: ${{ jobs.download.outputs.download_success }}
      artifact_path:
        description: "æ„å»ºäº§ç‰©è·¯å¾„"
        value: ${{ jobs.download.outputs.artifact_path }}

jobs:
  download:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      actions: read
      packages: read
    outputs:
      download_success: ${{ steps.set-outputs.outputs.download_success }}
      artifact_path: ${{ steps.set-outputs.outputs.artifact_path }}
    
    steps:
      - name: éªŒè¯è¾“å…¥å‚æ•°
        run: |
          echo "ğŸ” éªŒè¯è¾“å…¥å‚æ•°..."
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- è¿è¡ŒID: ${{ inputs.run_id }}"
          
          # è®°å½•ä¸‹è½½å¼€å§‹æ—¶é—´
          echo "DEPLOY_START_TIME=$(date +%s)" >> $GITHUB_ENV
          
          echo "âœ… è¾“å…¥å‚æ•°éªŒè¯é€šè¿‡"

      - name: è°ƒè¯•è¿è¡ŒID
        run: |
          echo "ğŸ” è°ƒè¯•è¿è¡ŒID..."
          echo "è¿è¡ŒID: ${{ inputs.run_id }}"
          echo "è¿è¡ŒIDé•¿åº¦: ${#{{ inputs.run_id }}}"
          
          # éªŒè¯è¿è¡ŒIDæ ¼å¼
          if [[ ! "${{ inputs.run_id }}" =~ ^[0-9]+$ ]]; then
            echo "âŒ è¿è¡ŒIDæ ¼å¼é”™è¯¯: ${{ inputs.run_id }}"
            exit 1
          fi
          
          echo "âœ… è¿è¡ŒIDæ ¼å¼æ­£ç¡®"

      - name: è°ƒè¯•ä¸‹è½½å‚æ•°
        run: |
          echo "ğŸ” è°ƒè¯•ä¸‹è½½å‚æ•°..."
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- è¿è¡ŒID: ${{ inputs.run_id }}"
          echo "- PATé•¿åº¦: ${#{{ inputs.deploy_center_pat }}}"
          
          # è§£ææºä»“åº“
          REPO_OWNER=$(echo "${{ inputs.source_repo }}" | cut -d'/' -f1)
          REPO_NAME=$(echo "${{ inputs.source_repo }}" | cut -d'/' -f2)
          
          echo "- ä»“åº“æ‰€æœ‰è€…: $REPO_OWNER"
          echo "- ä»“åº“åç§°: $REPO_NAME"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "REPO_OWNER=$REPO_OWNER" >> $GITHUB_ENV
          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV

      - name: æµ‹è¯•PATæƒé™
        run: |
          echo "ğŸ” æµ‹è¯• PAT æƒé™..."
          
          # é€‰æ‹©ä½¿ç”¨çš„ Token
          if [ -n "${{ inputs.deploy_center_pat }}" ]; then
            echo "ğŸ“‹ ä½¿ç”¨æä¾›çš„ PAT"
            TOKEN="${{ inputs.deploy_center_pat }}"
          else
            echo "ğŸ“‹ ä½¿ç”¨é»˜è®¤ GITHUB_TOKEN"
            TOKEN="${{ github.token }}"
          fi
          
          # æµ‹è¯• API è®¿é—®
          echo "ğŸ” æµ‹è¯• GitHub API è®¿é—®..."
          RESPONSE=$(curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/${{ inputs.source_repo }}" 2>/dev/null)
          
          if echo "$RESPONSE" | grep -q '"id"'; then
            echo "âœ… GitHub API è®¿é—®æˆåŠŸ"
          else
            echo "âŒ GitHub API è®¿é—®å¤±è´¥"
            echo "å“åº”: $RESPONSE"
            exit 1
          fi
          
          # æµ‹è¯• Actions API è®¿é—®
          echo "ğŸ” æµ‹è¯• Actions API è®¿é—®..."
          ACTIONS_RESPONSE=$(curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/${{ inputs.source_repo }}/actions/runs/${{ inputs.run_id }}" 2>/dev/null)
          
          if echo "$ACTIONS_RESPONSE" | grep -q '"id"'; then
            echo "âœ… Actions API è®¿é—®æˆåŠŸ"
            RUN_STATUS=$(echo "$ACTIONS_RESPONSE" | jq -r '.status // "unknown"')
            RUN_CONCLUSION=$(echo "$ACTIONS_RESPONSE" | jq -r '.conclusion // "unknown"')
            echo "- è¿è¡ŒçŠ¶æ€: $RUN_STATUS"
            echo "- è¿è¡Œç»“è®º: $RUN_CONCLUSION"
          else
            echo "âŒ Actions API è®¿é—®å¤±è´¥"
            echo "å“åº”: $ACTIONS_RESPONSE"
            exit 1
          fi

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: dist-${{ inputs.project }}
          path: ./artifacts
          github-token: ${{ inputs.deploy_center_pat || github.token }}

      - name: éªŒè¯ä¸‹è½½ç»“æœ
        id: verify-download
        run: |
          echo "ğŸ” éªŒè¯ä¸‹è½½ç»“æœ..."
          
          if [ -d "./artifacts" ]; then
            echo "âœ… æ„å»ºäº§ç‰©ç›®å½•å­˜åœ¨"
            echo "ğŸ“ æ„å»ºäº§ç‰©å†…å®¹:"
            ls -la ./artifacts/
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
            FILE_COUNT=$(find ./artifacts -type f | wc -l)
            echo "ğŸ“Š æ–‡ä»¶æ•°é‡: $FILE_COUNT"
            
            if [ "$FILE_COUNT" -gt 0 ]; then
              echo "âœ… æ„å»ºäº§ç‰©ä¸‹è½½æˆåŠŸ"
              echo "download_success=true" >> $GITHUB_OUTPUT
              echo "artifact_path=./artifacts" >> $GITHUB_OUTPUT
            else
              echo "âŒ æ„å»ºäº§ç‰©ç›®å½•ä¸ºç©º"
              echo "download_success=false" >> $GITHUB_OUTPUT
              echo "artifact_path=" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "âŒ æ„å»ºäº§ç‰©ç›®å½•ä¸å­˜åœ¨"
            echo "download_success=false" >> $GITHUB_OUTPUT
            echo "artifact_path=" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          echo "âœ… æ„å»ºäº§ç‰©ä¸‹è½½å®Œæˆ"
          echo "- ä¸‹è½½æˆåŠŸ: ${{ steps.verify-download.outputs.download_success }}"
          echo "- äº§ç‰©è·¯å¾„: ${{ steps.verify-download.outputs.artifact_path }}"
