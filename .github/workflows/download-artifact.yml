name: Download Artifact

description: "ä¸‹è½½æž„å»ºäº§ç‰©å¹¶éªŒè¯å®Œæ•´æ€§"

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
        description: "é¡¹ç›®åç§°"
      source_repo:
        required: true
        type: string
        description: "æºä»“åº“ (owner/repo)"
      run_id:
        required: true
        type: string
        description: "æž„å»ºè¿è¡ŒID"
      github_token:
        required: true
        type: string
        description: "GitHub Token"
    outputs:
      artifact_path:
        description: "æž„å»ºäº§ç‰©è·¯å¾„"
        value: ${{ jobs.download.outputs.artifact_path }}
      artifact_size:
        description: "æž„å»ºäº§ç‰©å¤§å°"
        value: ${{ jobs.download.outputs.artifact_size }}

jobs:
  download:
    runs-on: ubuntu-latest
    outputs:
      artifact_path: ${{ steps.set-outputs.outputs.artifact_path }}
      artifact_size: ${{ steps.set-outputs.outputs.artifact_size }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æž„å»ºäº§ç‰©
        id: download
        uses: dawidd6/action-download-artifact@v2
        with:
          name: dist-${{ inputs.project }}
          path: ./dist
          repo: ${{ inputs.source_repo }}
          workflow: ${{ inputs.project }}_deploy.yml
          run_id: ${{ inputs.run_id }}
          github_token: ${{ inputs.github_token }}

      - name: éªŒè¯æž„å»ºäº§ç‰©
        run: |
          echo "ðŸ” éªŒè¯æž„å»ºäº§ç‰©..."
          
          if [ ! -d "./dist" ]; then
            echo "ðŸš¨ æž„å»ºäº§ç‰©ç›®å½•ä¸å­˜åœ¨"
            echo "ðŸ” å½“å‰ç›®å½•å†…å®¹:"
            ls -la ./
            exit 1
          fi
          
          echo "ðŸ“ æž„å»ºäº§ç‰©ç›®å½•å†…å®¹:"
          ls -la ./dist/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
          FILE_COUNT=$(find ./dist -type f | wc -l)
          echo "ðŸ“Š æ–‡ä»¶æ•°é‡: $FILE_COUNT"
          
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "ðŸš¨ æž„å»ºäº§ç‰©ç›®å½•ä¸ºç©º"
            echo "ðŸ” è°ƒè¯•ä¿¡æ¯:"
            echo "æž„å»ºäº§ç‰©ç›®å½•: ./dist"
            echo "ç›®å½•æ˜¯å¦å­˜åœ¨: $(test -d "./dist" && echo 'æ˜¯' || echo 'å¦')"
            echo "ç›®å½•æƒé™: $(ls -ld "./dist" 2>/dev/null || echo 'æ— æ³•èŽ·å–æƒé™')"
            echo "ç›®å½•å†…å®¹:"
            ls -la "./dist/" || echo "æ— æ³•åˆ—å‡ºç›®å½•å†…å®¹"
            exit 1
          fi
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          if [ -f "./dist/index.html" ]; then
            echo "âœ… æ‰¾åˆ° index.html æ–‡ä»¶"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° index.html æ–‡ä»¶"
            echo "ðŸ“ æž„å»ºäº§ç‰©ä¸­çš„æ–‡ä»¶:"
            find "./dist" -type f | head -10
          fi
          
          echo "âœ… æž„å»ºäº§ç‰©éªŒè¯é€šè¿‡"
          echo "ðŸ“Š æ–‡ä»¶æ•°é‡: $FILE_COUNT"

      - name: æ˜¾ç¤ºæž„å»ºäº§ç‰©ä¿¡æ¯
        run: |
          echo "ðŸ“¦ æž„å»ºäº§ç‰©è¯¦ç»†ä¿¡æ¯:"
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- æž„å»ºID: ${{ inputs.run_id }}"
          echo "- äº§ç‰©è·¯å¾„: ./dist"
          
          echo "ðŸ“ ç›®å½•ç»“æž„:"
          find ./dist -type f | head -20
          
          echo "ðŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
          echo "- æ€»æ–‡ä»¶æ•°: $(find ./dist -type f | wc -l)"
          echo "- æ€»ç›®å½•æ•°: $(find ./dist -type d | wc -l)"
          echo "- æ€»å¤§å°: $(du -sh ./dist | cut -f1)"

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          echo "artifact_path=./dist" >> $GITHUB_OUTPUT
          echo "artifact_size=$(du -sb ./dist | cut -f1)" >> $GITHUB_OUTPUT
          echo "âœ… è¾“å‡ºå·²è®¾ç½®"
          echo "- artifact_path: ./dist"
          echo "- artifact_size: $(du -sb ./dist | cut -f1) bytes"
