name: Backend Service Diagnosis

description: "åç«¯æœåŠ¡è¯Šæ–­å’Œä¿®å¤ - ä¸“é—¨å¤„ç†åç«¯æœåŠ¡å¯åŠ¨å¤±è´¥å’Œæµ‹è¯•å¤±è´¥çš„é—®é¢˜"

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
        description: "é¡¹ç›®åç§°"
      server_host:
        required: true
        type: string
        description: "æœåŠ¡å™¨åœ°å€"
      server_user:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç”¨æˆ·"
      server_key:
        required: true
        type: string
        description: "æœåŠ¡å™¨å¯†é’¥"
      server_port:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç«¯å£"
      apps_root:
        required: false
        type: string
        description: "åº”ç”¨ç›®å½•è·¯å¾„"
        default: "/srv/apps"
      service_port:
        required: false
        type: string
        description: "æœåŠ¡ç«¯å£"
        default: "8090"
      health_endpoint:
        required: false
        type: string
        description: "å¥åº·æ£€æŸ¥ç«¯ç‚¹"
        default: "/health"
    outputs:
      diagnosis_result:
        description: "è¯Šæ–­ç»“æœ"
        value: ${{ jobs.diagnosis.outputs.result }}
      service_status:
        description: "æœåŠ¡çŠ¶æ€"
        value: ${{ jobs.diagnosis.outputs.service_status }}
      fix_applied:
        description: "æ˜¯å¦åº”ç”¨äº†ä¿®å¤"
        value: ${{ jobs.diagnosis.outputs.fix_applied }}

jobs:
  diagnosis:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      result: ${{ steps.diagnosis-step.outputs.result }}
      service_status: ${{ steps.diagnosis-step.outputs.service_status }}
      fix_applied: ${{ steps.diagnosis-step.outputs.fix_applied }}
    
    steps:
      - name: åç«¯æœåŠ¡è¯Šæ–­
        id: diagnosis-step
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ğŸ” å¼€å§‹åç«¯æœåŠ¡è¯Šæ–­..."
            echo "é¡¹ç›®: ${{ inputs.project }}"
            echo "æœåŠ¡ç«¯å£: ${{ inputs.service_port }}"
            echo "å¥åº·æ£€æŸ¥ç«¯ç‚¹: ${{ inputs.health_endpoint }}"
            
            PROJECT="${{ inputs.project }}"
            SERVICE_PORT="${{ inputs.service_port }}"
            HEALTH_ENDPOINT="${{ inputs.health_endpoint }}"
            APPS_ROOT="${{ inputs.apps_root }}"
            PROJECT_DIR="$APPS_ROOT/$PROJECT"
            
            # åˆå§‹åŒ–çŠ¶æ€å˜é‡
            SERVICE_STATUS="unknown"
            FIX_APPLIED="false"
            DIAGNOSIS_RESULT=""
            
            echo "ğŸ“‹ æ­¥éª¤1: æ£€æŸ¥é¡¹ç›®ç›®å½•..."
            if [ -d "$PROJECT_DIR" ]; then
              echo "âœ… é¡¹ç›®ç›®å½•å­˜åœ¨: $PROJECT_DIR"
              echo "ç›®å½•å†…å®¹:"
              ls -la "$PROJECT_DIR"
            else
              echo "âŒ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $PROJECT_DIR"
              echo "result=project_not_found" >> $GITHUB_OUTPUT
              echo "service_status=not_deployed" >> $GITHUB_OUTPUT
              echo "fix_applied=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            echo ""
            echo "ğŸ“‹ æ­¥éª¤2: æ£€æŸ¥PM2è¿›ç¨‹çŠ¶æ€..."
            PM2_STATUS=$(pm2 list 2>/dev/null | grep -E "$PROJECT|dashboard-backend" || echo "not_found")
            if [ "$PM2_STATUS" != "not_found" ]; then
              echo "ğŸ“Š PM2è¿›ç¨‹çŠ¶æ€:"
              pm2 list
              echo ""
              echo "ğŸ“Š è¯¦ç»†è¿›ç¨‹ä¿¡æ¯:"
              pm2 describe dashboard-backend 2>/dev/null || echo "æ— æ³•è·å–è¿›ç¨‹è¯¦æƒ…"
            else
              echo "âŒ æœªæ‰¾åˆ°PM2è¿›ç¨‹"
            fi
            
            echo ""
            echo "ğŸ“‹ æ­¥éª¤3: æ£€æŸ¥ç«¯å£å ç”¨..."
            PORT_STATUS=$(netstat -tlnp 2>/dev/null | grep ":$SERVICE_PORT" || echo "not_listening")
            if [ "$PORT_STATUS" != "not_listening" ]; then
              echo "âœ… ç«¯å£ $SERVICE_PORT æ­£åœ¨ç›‘å¬:"
              echo "$PORT_STATUS"
              SERVICE_STATUS="listening"
            else
              echo "âŒ ç«¯å£ $SERVICE_PORT æœªç›‘å¬"
              SERVICE_STATUS="not_listening"
            fi
            
            echo ""
            echo "ğŸ“‹ æ­¥éª¤4: æµ‹è¯•æœ¬åœ°å¥åº·æ£€æŸ¥..."
            HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:$SERVICE_PORT$HEALTH_ENDPOINT" --connect-timeout 5 --max-time 10 2>/dev/null || echo "connection_failed")
            if [ "$HEALTH_RESPONSE" = "200" ]; then
              echo "âœ… æœ¬åœ°å¥åº·æ£€æŸ¥æˆåŠŸ - çŠ¶æ€ç : $HEALTH_RESPONSE"
              SERVICE_STATUS="healthy"
            else
              echo "âŒ æœ¬åœ°å¥åº·æ£€æŸ¥å¤±è´¥ - å“åº”: $HEALTH_RESPONSE"
              SERVICE_STATUS="unhealthy"
            fi
            
            echo ""
            echo "ğŸ“‹ æ­¥éª¤5: æ£€æŸ¥æœåŠ¡æ—¥å¿—..."
            echo "ğŸ“‹ PM2æ—¥å¿— (æœ€è¿‘20è¡Œ):"
            pm2 logs dashboard-backend --lines 20 --nostream 2>/dev/null || echo "æ— æ³•è·å–PM2æ—¥å¿—"
            
            echo ""
            echo "ğŸ“‹ ç³»ç»Ÿæ—¥å¿— (æœ€è¿‘10è¡Œ):"
            journalctl -u nginx --no-pager -n 10 2>/dev/null || echo "æ— æ³•è·å–ç³»ç»Ÿæ—¥å¿—"
            
            # æ ¹æ®è¯Šæ–­ç»“æœå†³å®šä¿®å¤ç­–ç•¥
            echo ""
            echo "ğŸ”§ æ­¥éª¤6: åˆ†æé—®é¢˜å¹¶åº”ç”¨ä¿®å¤..."
            
            if [ "$SERVICE_STATUS" = "healthy" ]; then
              echo "âœ… æœåŠ¡çŠ¶æ€æ­£å¸¸ï¼Œæ— éœ€ä¿®å¤"
              DIAGNOSIS_RESULT="service_healthy"
            elif [ "$SERVICE_STATUS" = "not_deployed" ]; then
              echo "âŒ é¡¹ç›®æœªéƒ¨ç½²ï¼Œæ— æ³•ä¿®å¤"
              DIAGNOSIS_RESULT="project_not_deployed"
            else
              echo "ğŸ”§ å°è¯•ä¿®å¤æœåŠ¡..."
              
              # ä¿®å¤ç­–ç•¥1: é‡å¯PM2è¿›ç¨‹
              echo "ğŸ”„ ç­–ç•¥1: é‡å¯PM2è¿›ç¨‹..."
              pm2 restart dashboard-backend 2>/dev/null || echo "PM2é‡å¯å¤±è´¥"
              sleep 5
              
              # æ£€æŸ¥é‡å¯åçŠ¶æ€
              HEALTH_RESPONSE_AFTER=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:$SERVICE_PORT$HEALTH_ENDPOINT" --connect-timeout 5 --max-time 10 2>/dev/null || echo "connection_failed")
              if [ "$HEALTH_RESPONSE_AFTER" = "200" ]; then
                echo "âœ… PM2é‡å¯æˆåŠŸï¼ŒæœåŠ¡æ¢å¤æ­£å¸¸"
                SERVICE_STATUS="healthy"
                FIX_APPLIED="true"
                DIAGNOSIS_RESULT="restart_success"
              else
                echo "âŒ PM2é‡å¯åä»æ— æ³•è®¿é—®"
                
                # ä¿®å¤ç­–ç•¥2: é‡æ–°å¯åŠ¨æœåŠ¡
                echo "ğŸ”„ ç­–ç•¥2: é‡æ–°å¯åŠ¨æœåŠ¡..."
                cd "$PROJECT_DIR"
                
                # åœæ­¢ç°æœ‰æœåŠ¡
                pm2 stop dashboard-backend 2>/dev/null || echo "åœæ­¢æœåŠ¡å¤±è´¥"
                pm2 delete dashboard-backend 2>/dev/null || echo "åˆ é™¤æœåŠ¡å¤±è´¥"
                
                # æ£€æŸ¥é…ç½®æ–‡ä»¶
                if [ -f "ecosystem.config.js" ]; then
                  echo "âœ… æ‰¾åˆ°PM2é…ç½®æ–‡ä»¶"
                  cat ecosystem.config.js
                  
                  # é‡æ–°å¯åŠ¨æœåŠ¡
                  pm2 start ecosystem.config.js --update-env
                  sleep 10
                  
                  # æ£€æŸ¥å¯åŠ¨åçŠ¶æ€
                  HEALTH_RESPONSE_FINAL=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:$SERVICE_PORT$HEALTH_ENDPOINT" --connect-timeout 5 --max-time 10 2>/dev/null || echo "connection_failed")
                  if [ "$HEALTH_RESPONSE_FINAL" = "200" ]; then
                    echo "âœ… æœåŠ¡é‡æ–°å¯åŠ¨æˆåŠŸ"
                    SERVICE_STATUS="healthy"
                    FIX_APPLIED="true"
                    DIAGNOSIS_RESULT="restart_success"
                  else
                    echo "âŒ æœåŠ¡é‡æ–°å¯åŠ¨å¤±è´¥"
                    DIAGNOSIS_RESULT="restart_failed"
                  fi
                else
                  echo "âŒ æœªæ‰¾åˆ°PM2é…ç½®æ–‡ä»¶"
                  DIAGNOSIS_RESULT="config_missing"
                fi
              fi
            fi
            
            echo ""
            echo "ğŸ“Š è¯Šæ–­ç»“æœæ€»ç»“:"
            echo "- æœåŠ¡çŠ¶æ€: $SERVICE_STATUS"
            echo "- æ˜¯å¦åº”ç”¨ä¿®å¤: $FIX_APPLIED"
            echo "- è¯Šæ–­ç»“æœ: $DIAGNOSIS_RESULT"
            
            # è®¾ç½®è¾“å‡º
            echo "result=$DIAGNOSIS_RESULT" >> $GITHUB_OUTPUT
            echo "service_status=$SERVICE_STATUS" >> $GITHUB_OUTPUT
            echo "fix_applied=$FIX_APPLIED" >> $GITHUB_OUTPUT

      - name: è¯Šæ–­ç»“æœå¤„ç†
        run: |
          echo "ğŸ“Š è¯Šæ–­ç»“æœå¤„ç†..."
          echo "- è¯Šæ–­ç»“æœ: ${{ steps.diagnosis-step.outputs.result }}"
          echo "- æœåŠ¡çŠ¶æ€: ${{ steps.diagnosis-step.outputs.service_status }}"
          echo "- ä¿®å¤åº”ç”¨: ${{ steps.diagnosis-step.outputs.fix_applied }}"
          
          case "${{ steps.diagnosis-step.outputs.result }}" in
            "service_healthy")
              echo "âœ… æœåŠ¡çŠ¶æ€æ­£å¸¸"
              ;;
            "restart_success")
              echo "âœ… æœåŠ¡ä¿®å¤æˆåŠŸ"
              ;;
            "project_not_deployed")
              echo "âŒ é¡¹ç›®æœªéƒ¨ç½²"
              exit 1
              ;;
            "restart_failed")
              echo "âŒ æœåŠ¡ä¿®å¤å¤±è´¥"
              exit 1
              ;;
            "config_missing")
              echo "âŒ é…ç½®æ–‡ä»¶ç¼ºå¤±"
              exit 1
              ;;
            *)
              echo "âŒ æœªçŸ¥è¯Šæ–­ç»“æœ"
              exit 1
              ;;
          esac
