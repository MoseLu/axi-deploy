name: Test Dispatch Connection

on:
  workflow_dispatch:
    inputs:
      test_message:
        description: 'æµ‹è¯•æ¶ˆæ¯'
        required: false
        type: string
        default: 'Hello from workflow_dispatch!'
  workflow_call:
    inputs:
      caller_repo:
        description: 'è°ƒç”¨æ–¹ä»“åº“åç§°'
        required: false
        type: string
      caller_branch:
        description: 'è°ƒç”¨æ–¹åˆ†æ”¯åç§°'
        required: false
        type: string
      caller_commit:
        description: 'è°ƒç”¨æ–¹æäº¤å“ˆå¸Œ'
        required: false
        type: string

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ˜¾ç¤ºæµ‹è¯•ä¿¡æ¯
        run: |
          echo "ðŸ§ª å¼€å§‹æµ‹è¯• workflow_dispatch"
          echo "æµ‹è¯•æ¶ˆæ¯: ${{ github.event.inputs.test_message || 'é»˜è®¤æµ‹è¯•æ¶ˆæ¯' }}"
          echo "è°ƒç”¨æ–¹ä»“åº“: ${{ github.event.inputs.caller_repo || 'N/A' }}"
          echo "è°ƒç”¨æ–¹åˆ†æ”¯: ${{ github.event.inputs.caller_branch || 'N/A' }}"
          echo "è°ƒç”¨æ–¹æäº¤: ${{ github.event.inputs.caller_commit || 'N/A' }}"
          echo "è§¦å‘æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "è§¦å‘è€…: ${{ github.actor }}"
          
      - name: è®¾ç½®SSHçŽ¯å¢ƒ
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # é…ç½®SSHé€‰é¡¹
          cat > ~/.ssh/config << EOF
          Host ${{ secrets.SERVER_HOST }}
            HostName ${{ secrets.SERVER_HOST }}
            Port ${{ secrets.SERVER_PORT }}
            User ${{ secrets.SERVER_USER }}
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF
          chmod 600 ~/.ssh/config
          
      - name: æµ‹è¯•SSHè¿žæŽ¥
        run: |
          echo "ðŸ” æµ‹è¯•SSHè¿žæŽ¥..."
          echo "æœåŠ¡å™¨: ${{ secrets.SERVER_HOST }}"
          echo "ç«¯å£: ${{ secrets.SERVER_PORT }}"
          echo "ç”¨æˆ·: ${{ secrets.SERVER_USER }}"
          
          # æµ‹è¯•åŸºæœ¬è¿žæŽ¥
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo 'âœ… SSHè¿žæŽ¥æµ‹è¯•æˆåŠŸ'"
          
      - name: æµ‹è¯•æœåŠ¡å™¨ä¿¡æ¯
        run: |
          echo "ðŸ“Š èŽ·å–æœåŠ¡å™¨ä¿¡æ¯..."
          
          # èŽ·å–ç³»ç»Ÿä¿¡æ¯
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
            echo '=== ç³»ç»Ÿä¿¡æ¯ ==='
            uname -a
            echo '=== ç£ç›˜ç©ºé—´ ==='
            df -h
            echo '=== å†…å­˜ä½¿ç”¨ ==='
            free -h
            echo '=== å½“å‰ç”¨æˆ· ==='
            whoami
            echo '=== å½“å‰ç›®å½• ==='
            pwd
          "
          
      - name: æµ‹è¯•å®Œæˆ
        run: |
          echo "âœ… workflow_dispatch æµ‹è¯•å®Œæˆ!"
          echo "æ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡äº†ï¼Œæ‚¨çš„é…ç½®æ˜¯æ­£ç¡®çš„ã€‚"
          
      - name: æ¸…ç†SSHå¯†é’¥
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
          rm -f ~/.ssh/known_hosts
          echo "ðŸ§¹ SSHå¯†é’¥å·²æ¸…ç†" 