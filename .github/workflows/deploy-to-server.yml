name: Deploy to Server

description: "æœåŠ¡å™¨éƒ¨ç½² - å°†æž„å»ºäº§ç‰©éƒ¨ç½²åˆ°ç›®æ ‡æœåŠ¡å™¨"

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
        description: "é¡¹ç›®åç§°"
      deploy_type:
        required: true
        type: string
        description: "éƒ¨ç½²ç±»åž‹ (backend/static)"
        default: "static"
      server_host:
        required: true
        type: string
        description: "æœåŠ¡å™¨åœ°å€"
      server_user:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç”¨æˆ·"
      server_key:
        required: true
        type: string
        description: "æœåŠ¡å™¨å¯†é’¥"
      server_port:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç«¯å£"
      apps_root:
        required: false
        type: string
        description: "åº”ç”¨ç›®å½•è·¯å¾„"
        default: "/srv/apps"
      static_root:
        required: false
        type: string
        description: "é™æ€æ–‡ä»¶ç›®å½•è·¯å¾„"
        default: "/srv/static"
      backup_root:
        required: false
        type: string
        description: "å¤‡ä»½æ ¹ç›®å½•"
        default: "/srv/backups"
      run_user:
        required: false
        type: string
        description: "è¿è¡Œç”¨æˆ·"
        default: "deploy"
    outputs:
      deploy_success:
        description: "éƒ¨ç½²æ˜¯å¦æˆåŠŸ"
        value: ${{ jobs.deploy.outputs.deploy_success }}
      deploy_path:
        description: "éƒ¨ç½²è·¯å¾„"
        value: ${{ jobs.deploy.outputs.deploy_path }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    outputs:
      deploy_success: ${{ steps.set-outputs.outputs.deploy_success }}
      deploy_path: ${{ steps.set-outputs.outputs.deploy_path }}
    
    steps:
      - name: éªŒè¯è¾“å…¥å‚æ•°
        run: |
          echo "ðŸ” éªŒè¯è¾“å…¥å‚æ•°..."
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- éƒ¨ç½²ç±»åž‹: ${{ inputs.deploy_type }}"
          echo "- æœåŠ¡å™¨: ${{ inputs.server_host }}:${{ inputs.server_port }}"
          echo "- ç”¨æˆ·: ${{ inputs.server_user }}"
          
          echo "âœ… è¾“å…¥å‚æ•°éªŒè¯é€šè¿‡"

      - name: è°ƒè¯•SSHå‚æ•°
        run: |
          echo "ðŸ” è°ƒè¯•SSHå‚æ•°..."
          echo "- æœåŠ¡å™¨: ${{ inputs.server_host }}"
          echo "- ç«¯å£: ${{ inputs.server_port }}"
          echo "- ç”¨æˆ·: ${{ inputs.server_user }}"
          echo "- å¯†é’¥é•¿åº¦: ${#{{ inputs.server_key }}}"

      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ðŸš€ å¼€å§‹éƒ¨ç½² ${{ inputs.project }}..."
            
            PROJECT="${{ inputs.project }}"
            DEPLOY_TYPE="${{ inputs.deploy_type }}"
            APPS_ROOT="${{ inputs.apps_root }}"
            STATIC_ROOT="${{ inputs.static_root }}"
            BACKUP_ROOT="${{ inputs.backup_root }}"
            RUN_USER="${{ inputs.run_user }}"
            
            echo "ðŸ“‹ éƒ¨ç½²é…ç½®:"
            echo "- é¡¹ç›®: $PROJECT"
            echo "- ç±»åž‹: $DEPLOY_TYPE"
            echo "- åº”ç”¨ç›®å½•: $APPS_ROOT"
            echo "- é™æ€ç›®å½•: $STATIC_ROOT"
            echo "- å¤‡ä»½ç›®å½•: $BACKUP_ROOT"
            echo "- è¿è¡Œç”¨æˆ·: $RUN_USER"
            
            # ç¡®å®šéƒ¨ç½²è·¯å¾„
            if [ "$DEPLOY_TYPE" = "backend" ]; then
              DEPLOY_PATH="$APPS_ROOT/$PROJECT"
              BACKUP_PATH="$BACKUP_ROOT/$PROJECT"
            else
              DEPLOY_PATH="$STATIC_ROOT/$PROJECT"
              BACKUP_PATH="$BACKUP_ROOT/$PROJECT"
            fi
            
            echo "ðŸ“ éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"
            echo "ðŸ“ å¤‡ä»½è·¯å¾„: $BACKUP_PATH"
            
            # åˆ›å»ºå¿…è¦çš„ç›®å½•
            sudo mkdir -p "$APPS_ROOT" "$STATIC_ROOT" "$BACKUP_ROOT"
            sudo chown -R $RUN_USER:$RUN_USER "$APPS_ROOT" "$STATIC_ROOT" "$BACKUP_ROOT"
            
            # å¤‡ä»½çŽ°æœ‰éƒ¨ç½²ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
            if [ -d "$DEPLOY_PATH" ]; then
              echo "ðŸ“¦ å¤‡ä»½çŽ°æœ‰éƒ¨ç½²..."
              BACKUP_TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              BACKUP_NAME="$PROJECT.backup.$BACKUP_TIMESTAMP"
              sudo cp -r "$DEPLOY_PATH" "$BACKUP_PATH/$BACKUP_NAME"
              sudo chown -R $RUN_USER:$RUN_USER "$BACKUP_PATH/$BACKUP_NAME"
              echo "âœ… çŽ°æœ‰éƒ¨ç½²å·²å¤‡ä»½åˆ°: $BACKUP_PATH/$BACKUP_NAME"
              
              # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰
              echo "ðŸ§¹ æ¸…ç†æ—§å¤‡ä»½..."
              OLD_BACKUPS=$(ls -t "$BACKUP_PATH"/$PROJECT.backup.* 2>/dev/null | tail -n +6)
              if [ -n "$OLD_BACKUPS" ]; then
                echo "ðŸ—‘ï¸ åˆ é™¤æ—§å¤‡ä»½:"
                echo "$OLD_BACKUPS" | xargs -r sudo rm -rf
              fi
            else
              echo "ðŸ“‹ æ²¡æœ‰çŽ°æœ‰éƒ¨ç½²éœ€è¦å¤‡ä»½"
            fi
            
            # æ¸…ç†ç›®æ ‡éƒ¨ç½²ç›®å½•ï¼ˆé¿å…æ®‹ç•™æ–‡ä»¶ï¼‰
            echo "ðŸ§¹ æ¸…ç†ç›®æ ‡éƒ¨ç½²ç›®å½•..."
            sudo rm -rf "$DEPLOY_PATH"/*
            sudo mkdir -p "$DEPLOY_PATH"
            sudo chown -R $RUN_USER:$RUN_USER "$DEPLOY_PATH"
            
            echo "âœ… ç›®æ ‡ç›®å½•å·²å‡†å¤‡å°±ç»ª"

      - name: æ£€æŸ¥æž„å»ºäº§ç‰©æ˜¯å¦å­˜åœ¨
        run: |
          echo "ðŸ” æ£€æŸ¥æž„å»ºäº§ç‰©..."
          
          if [ -d "./artifacts" ]; then
            echo "âœ… æž„å»ºäº§ç‰©ç›®å½•å­˜åœ¨"
            echo "ðŸ“ æž„å»ºäº§ç‰©å†…å®¹:"
            ls -la ./artifacts/
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
            FILE_COUNT=$(find ./artifacts -type f | wc -l)
            echo "ðŸ“Š æ–‡ä»¶æ•°é‡: $FILE_COUNT"
            
            if [ "$FILE_COUNT" -gt 0 ]; then
              echo "âœ… æž„å»ºäº§ç‰©éªŒè¯é€šè¿‡"
            else
              echo "âŒ æž„å»ºäº§ç‰©ç›®å½•ä¸ºç©º"
              exit 1
            fi
          else
            echo "âŒ æž„å»ºäº§ç‰©ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: ç›´æŽ¥éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ðŸ“¦ å¼€å§‹ä¸Šä¼ æž„å»ºäº§ç‰©..."
            
            PROJECT="${{ inputs.project }}"
            DEPLOY_TYPE="${{ inputs.deploy_type }}"
            
            if [ "$DEPLOY_TYPE" = "backend" ]; then
              DEPLOY_PATH="${{ inputs.apps_root }}/$PROJECT"
            else
              DEPLOY_PATH="${{ inputs.static_root }}/$PROJECT"
            fi
            
            echo "ðŸ“ ç›®æ ‡è·¯å¾„: $DEPLOY_PATH"
            
            # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
            sudo mkdir -p "$DEPLOY_PATH"
            sudo chown -R ${{ inputs.run_user }}:${{ inputs.run_user }} "$DEPLOY_PATH"
            
            echo "âœ… ç›®æ ‡ç›®å½•å·²å‡†å¤‡"

      - name: è°ƒè¯•æž„å»ºäº§ç‰©
        run: |
          echo "ðŸ” è°ƒè¯•æž„å»ºäº§ç‰©..."
          echo "ðŸ“ å½“å‰ç›®å½•: $(pwd)"
          echo "ðŸ“ æž„å»ºäº§ç‰©ç›®å½•:"
          ls -la ./artifacts/
          
          # æ£€æŸ¥æž„å»ºäº§ç‰©ç»“æž„
          if [ -f "./artifacts/deployment.tar.gz" ]; then
            echo "ðŸ“¦ å‘çŽ° deployment.tar.gz"
            echo "ðŸ“Š æ–‡ä»¶å¤§å°: $(stat -c%s ./artifacts/deployment.tar.gz) bytes"
          else
            echo "ðŸ“‹ æž„å»ºäº§ç‰©å†…å®¹:"
            find ./artifacts -type f -exec ls -la {} \;
          fi

      - name: å‡†å¤‡ç›®æ ‡ç›®å½•
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ðŸ“ å‡†å¤‡ç›®æ ‡ç›®å½•..."
            
            PROJECT="${{ inputs.project }}"
            DEPLOY_TYPE="${{ inputs.deploy_type }}"
            
            if [ "$DEPLOY_TYPE" = "backend" ]; then
              DEPLOY_PATH="${{ inputs.apps_root }}/$PROJECT"
            else
              DEPLOY_PATH="${{ inputs.static_root }}/$PROJECT"
            fi
            
            # æ¸…ç†å¹¶åˆ›å»ºç›®æ ‡ç›®å½•
            sudo rm -rf "$DEPLOY_PATH"/*
            sudo mkdir -p "$DEPLOY_PATH"
            sudo chown -R ${{ inputs.run_user }}:${{ inputs.run_user }} "$DEPLOY_PATH"
            
            echo "âœ… ç›®æ ‡ç›®å½•å·²å‡†å¤‡: $DEPLOY_PATH"

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©åˆ°éƒ¨ç½²ç›®å½•
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          source: "./artifacts/*"
          target: "${{ inputs.deploy_type == 'backend' && inputs.apps_root || inputs.static_root }}/${{ inputs.project }}/"
          strip_components: 0

      - name: éªŒè¯ä¸Šä¼ ç»“æžœ
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ðŸ” éªŒè¯ä¸Šä¼ ç»“æžœ..."
            
            PROJECT="${{ inputs.project }}"
            DEPLOY_TYPE="${{ inputs.deploy_type }}"
            
            if [ "$DEPLOY_TYPE" = "backend" ]; then
              DEPLOY_PATH="${{ inputs.apps_root }}/$PROJECT"
            else
              DEPLOY_PATH="${{ inputs.static_root }}/$PROJECT"
            fi
            
            echo "ðŸ“ æ£€æŸ¥éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"
            
            if [ -d "$DEPLOY_PATH" ]; then
              echo "âœ… éƒ¨ç½²ç›®å½•å­˜åœ¨"
              echo "ðŸ“ éƒ¨ç½²å†…å®¹:"
              ls -la "$DEPLOY_PATH"
              
              # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
              FILE_COUNT=$(find "$DEPLOY_PATH" -type f | wc -l)
              echo "ðŸ“Š æ–‡ä»¶æ•°é‡: $FILE_COUNT"
              
              if [ "$FILE_COUNT" -gt 0 ]; then
                echo "âœ… éƒ¨ç½²éªŒè¯æˆåŠŸ"
              else
                echo "âŒ éƒ¨ç½²ç›®å½•ä¸ºç©º"
                exit 1
              fi
            else
              echo "âŒ éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi

      - name: ä¿®å¤ç›®å½•ç»“æž„
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ðŸ”§ ä¿®å¤ç›®å½•ç»“æž„..."
            
            PROJECT="${{ inputs.project }}"
            DEPLOY_TYPE="${{ inputs.deploy_type }}"
            
            if [ "$DEPLOY_TYPE" = "backend" ]; then
              DEPLOY_PATH="${{ inputs.apps_root }}/$PROJECT"
            else
              DEPLOY_PATH="${{ inputs.static_root }}/$PROJECT"
            fi
            
            echo "ðŸ“ éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ deployment.tar.gz
            if [ -f "$DEPLOY_PATH/deployment.tar.gz" ]; then
              echo "ðŸ“¦ å‘çŽ° deployment.tar.gzï¼Œæ­£åœ¨è§£åŽ‹..."
              cd "$DEPLOY_PATH"
              tar -xzf deployment.tar.gz
              rm -f deployment.tar.gz
              echo "âœ… deployment.tar.gz å·²è§£åŽ‹"
            fi
            
            # æ£€æŸ¥ç›®å½•ç»“æž„
            echo "ðŸ“ æœ€ç»ˆç›®å½•ç»“æž„:"
            ls -la "$DEPLOY_PATH"
            
            # è®¾ç½®æ­£ç¡®çš„æƒé™
            sudo chown -R ${{ inputs.run_user }}:${{ inputs.run_user }} "$DEPLOY_PATH"
            sudo chmod -R 755 "$DEPLOY_PATH"
            
            echo "âœ… ç›®å½•ç»“æž„ä¿®å¤å®Œæˆ"

      - name: éªŒè¯éƒ¨ç½²ç»“æžœ
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ðŸ” éªŒè¯éƒ¨ç½²ç»“æžœ..."
            
            PROJECT="${{ inputs.project }}"
            DEPLOY_TYPE="${{ inputs.deploy_type }}"
            
            if [ "$DEPLOY_TYPE" = "backend" ]; then
              DEPLOY_PATH="${{ inputs.apps_root }}/$PROJECT"
            else
              DEPLOY_PATH="${{ inputs.static_root }}/$PROJECT"
            fi
            
            echo "ðŸ“ æœ€ç»ˆéƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"
            
            if [ -d "$DEPLOY_PATH" ]; then
              echo "âœ… éƒ¨ç½²ç›®å½•å­˜åœ¨"
              echo "ðŸ“ éƒ¨ç½²å†…å®¹:"
              ls -la "$DEPLOY_PATH"
              
              # æ£€æŸ¥å…³é”®æ–‡ä»¶
              if [ "$DEPLOY_TYPE" = "backend" ]; then
                # åŽç«¯é¡¹ç›®æ£€æŸ¥
                if [ -f "$DEPLOY_PATH/star-cloud-linux" ] || [ -f "$DEPLOY_PATH/main" ] || [ -f "$DEPLOY_PATH/package.json" ]; then
                  echo "âœ… åŽç«¯é¡¹ç›®å…³é”®æ–‡ä»¶å­˜åœ¨"
                else
                  echo "âš ï¸ åŽç«¯é¡¹ç›®å…³é”®æ–‡ä»¶ç¼ºå¤±"
                fi
              else
                # é™æ€é¡¹ç›®æ£€æŸ¥
                if [ -f "$DEPLOY_PATH/index.html" ] || [ -d "$DEPLOY_PATH/dist" ]; then
                  echo "âœ… é™æ€é¡¹ç›®å…³é”®æ–‡ä»¶å­˜åœ¨"
                else
                  echo "âš ï¸ é™æ€é¡¹ç›®å…³é”®æ–‡ä»¶ç¼ºå¤±"
                fi
              fi
              
              echo "âœ… éƒ¨ç½²éªŒè¯å®Œæˆ"
            else
              echo "âŒ éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi

      - name: éƒ¨ç½²å¤±è´¥è‡ªåŠ¨å›žæ»š
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ inputs.server_host }}
          username: ${{ inputs.server_user }}
          key: ${{ inputs.server_key }}
          port: ${{ inputs.server_port }}
          script: |
            echo "ðŸ”„ éƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹è‡ªåŠ¨å›žæ»š..."
            
            PROJECT="${{ inputs.project }}"
            BACKUP_ROOT="${{ inputs.backup_root }}"
            PROJECT_BACKUP_DIR="$BACKUP_ROOT/$PROJECT"
            
            if [ -d "$PROJECT_BACKUP_DIR" ]; then
              # æŸ¥æ‰¾æœ€æ–°çš„å¤‡ä»½ç›®å½•
              LATEST_BACKUP=$(find "$PROJECT_BACKUP_DIR" -name "$PROJECT.backup.*" -type d 2>/dev/null | sort -r | head -1)
              
              if [ -n "$LATEST_BACKUP" ] && [ -d "$LATEST_BACKUP" ]; then
                echo "ðŸ“¦ æ‰¾åˆ°æœ€æ–°å¤‡ä»½: $LATEST_BACKUP"
                echo "ðŸ“ å¤‡ä»½å†…å®¹:"
                ls -la "$LATEST_BACKUP"
                
                # ç¡®å®šéƒ¨ç½²è·¯å¾„
                if [ "${{ inputs.deploy_type }}" = "backend" ]; then
                  DEPLOY_PATH="${{ inputs.apps_root }}/$PROJECT"
                else
                  DEPLOY_PATH="${{ inputs.static_root }}/$PROJECT"
                fi
                
                sudo rm -rf "$DEPLOY_PATH"/*
                sudo cp -r "$LATEST_BACKUP"/* "$DEPLOY_PATH/"
                sudo chown -R ${{ inputs.run_user }}:${{ inputs.run_user }} "$DEPLOY_PATH"
                echo "âœ… å›žæ»šå®Œæˆï¼Œå·²æ¢å¤åˆ°: $LATEST_BACKUP"
              else
                echo "âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆçš„å¤‡ä»½ç›®å½•"
                echo "ðŸ” å¯ç”¨çš„å¤‡ä»½:"
                find "$PROJECT_BACKUP_DIR" -name "$PROJECT.backup.*" -type d 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°å¤‡ä»½"
              fi
            else
              echo "âš ï¸ å¤‡ä»½ç›®å½•ä¸å­˜åœ¨: $PROJECT_BACKUP_DIR"
            fi

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          if [[ "${{ inputs.deploy_type }}" == "backend" ]]; then
            DEPLOY_PATH="${{ inputs.apps_root }}/${{ inputs.project }}"
          else
            DEPLOY_PATH="${{ inputs.static_root }}/${{ inputs.project }}"
          fi
          
          echo "deploy_success=true" >> $GITHUB_OUTPUT
          echo "deploy_path=$DEPLOY_PATH" >> $GITHUB_OUTPUT
          echo "âœ… è¾“å‡ºå·²è®¾ç½®"
          echo "- deploy_success: true"
          echo "- deploy_path: $DEPLOY_PATH"
