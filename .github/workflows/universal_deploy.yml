name: Universal Deploy

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'é¡¹ç›®åç§°'
        required: true
        type: string
      source_repo:
        description: 'æºä»“åº“ (æ ¼å¼: owner/repo)'
        required: true
        type: string
      run_id:
        description: 'æ„å»ºè¿è¡ŒID'
        required: true
        type: string
      deploy_type:
        description: 'éƒ¨ç½²ç±»å‹'
        required: true
        default: 'static'
        type: choice
        options:
          - static
          - backend
      nginx_config:
        description: 'Nginxé…ç½®ï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      test_url:
        description: 'æµ‹è¯•URLï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      start_cmd:
        description: 'å¯åŠ¨å‘½ä»¤ï¼ˆåç«¯é¡¹ç›®ï¼‰'
        required: false
        type: string
      skip_init:
        description: 'è·³è¿‡æœåŠ¡å™¨åˆå§‹åŒ–'
        required: false
        default: false
        type: boolean

jobs:
  # æ­¥éª¤1: æœåŠ¡å™¨åˆå§‹åŒ–
  server-init:
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_init }}
    steps:
      - name: æœåŠ¡å™¨åˆå§‹åŒ–
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸš€ å¼€å§‹æœåŠ¡å™¨åˆå§‹åŒ–..."
            
            # è·å–è¾“å…¥å‚æ•°
            DOMAIN="redamancy.com.cn"
            RUN_USER="deploy"
            APPS_ROOT="/srv/apps"
            STATIC_ROOT="/srv/static"
            NGINX_CONF_DIR="/www/server/nginx/conf/conf.d/redamancy"
            CERT_SRC="/www/server/panel/vhost/cert/redamancy.com.cn"
            CERT_DST="/www/server/nginx/ssl/redamancy"
            FORCE_REBUILD="false"
            
            echo "ğŸ“‹ åˆå§‹åŒ–é…ç½®:"
            echo "- åŸŸå: $DOMAIN"
            echo "- è¿è¡Œç”¨æˆ·: $RUN_USER"
            echo "- åº”ç”¨ç›®å½•: $APPS_ROOT"
            echo "- é™æ€ç›®å½•: $STATIC_ROOT"
            echo "- Nginxé…ç½®: $NGINX_CONF_DIR"
            echo "- è¯ä¹¦æº: $CERT_SRC"
            echo "- è¯ä¹¦ç›®æ ‡: $CERT_DST"
            echo "- å¼ºåˆ¶é‡å»º: $FORCE_REBUILD"
            
            # 0. å‰ç½®æ£€æŸ¥
            echo "ğŸ” å‰ç½®æ£€æŸ¥..."
            if ! command -v nginx &> /dev/null; then
              echo "âŒ Nginxæœªå®‰è£…ï¼Œæ— æ³•ç»§ç»­åˆå§‹åŒ–"
              exit 1
            fi
            echo "âœ… Nginxå·²å®‰è£…: $(nginx -v)"
            
            # æ£€æŸ¥å¹¶å¯åŠ¨NginxæœåŠ¡
            echo "ğŸ” æ£€æŸ¥Nginxè¿›ç¨‹çŠ¶æ€..."
            if pgrep nginx > /dev/null; then
              echo "âœ… å‘ç°Nginxè¿›ç¨‹æ­£åœ¨è¿è¡Œ"
              NGINX_PIDS=$(pgrep nginx)
              echo "Nginxè¿›ç¨‹ID: $NGINX_PIDS"
              
              # æ£€æŸ¥systemdæœåŠ¡çŠ¶æ€
              if systemctl is-active --quiet nginx; then
                echo "âœ… NginxæœåŠ¡çŠ¶æ€æ­£å¸¸"
              else
                echo "âš ï¸  Nginxè¿›ç¨‹è¿è¡Œä½†systemdçŠ¶æ€å¼‚å¸¸ï¼Œå°è¯•ä¿®å¤..."
                                 # åœæ­¢æ‰€æœ‰Nginxè¿›ç¨‹
                 echo "ğŸ›‘ åœæ­¢æ‰€æœ‰Nginxè¿›ç¨‹..."
                 sudo pkill -f nginx || true
                 sleep 3
                 
                 # ç¡®ä¿è¿›ç¨‹å®Œå…¨åœæ­¢
                 if pgrep nginx > /dev/null; then
                   echo "âš ï¸  å¼ºåˆ¶åœæ­¢æ®‹ç•™çš„Nginxè¿›ç¨‹..."
                   sudo pkill -9 -f nginx || true
                   sleep 2
                 fi
                
                # æ¸…ç†systemdçŠ¶æ€
                echo "ğŸ§¹ æ¸…ç†systemdçŠ¶æ€..."
                sudo systemctl reset-failed nginx
                
                # é‡æ–°å¯åŠ¨æœåŠ¡
                echo "ğŸš€ é‡æ–°å¯åŠ¨NginxæœåŠ¡..."
                if systemctl start nginx; then
                  echo "âœ… NginxæœåŠ¡å¯åŠ¨æˆåŠŸ"
                else
                  echo "âŒ NginxæœåŠ¡å¯åŠ¨å¤±è´¥"
                  systemctl status nginx --no-pager -l
                  exit 1
                fi
              fi
            else
              echo "âš ï¸  Nginxè¿›ç¨‹æœªè¿è¡Œï¼Œå°è¯•å¯åŠ¨æœåŠ¡..."
              if systemctl start nginx; then
                echo "âœ… NginxæœåŠ¡å¯åŠ¨æˆåŠŸ"
              else
                echo "âŒ NginxæœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œå°è¯•è¯Šæ–­..."
                systemctl status nginx --no-pager -l
                echo "å°è¯•é‡æ–°åŠ è½½é…ç½®..."
                if systemctl reload nginx; then
                  echo "âœ… NginxæœåŠ¡é‡è½½æˆåŠŸ"
                else
                  echo "âŒ NginxæœåŠ¡é‡è½½å¤±è´¥ï¼Œå°è¯•é‡å¯..."
                  if systemctl restart nginx; then
                    echo "âœ… NginxæœåŠ¡é‡å¯æˆåŠŸ"
                  else
                    echo "âŒ NginxæœåŠ¡é‡å¯å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
                    systemctl status nginx --no-pager -l
                    exit 1
                  fi
                fi
              fi
            fi
            
            # 1. åˆ›å»ºä¸šåŠ¡è¿è¡Œç”¨æˆ·ï¼ˆç¾åè‡ªæ„ˆï¼‰
            echo "ğŸ‘¤ æ£€æŸ¥ä¸šåŠ¡è¿è¡Œç”¨æˆ·..."
            if ! id "$RUN_USER" &>/dev/null; then
              echo "ğŸ†• åˆ›å»ºç”¨æˆ· $RUN_USER..."
              sudo useradd -m -s /bin/bash $RUN_USER
              echo "âœ… ç”¨æˆ· $RUN_USER åˆ›å»ºå®Œæˆ"
            else
              echo "âœ… ç”¨æˆ· $RUN_USER å·²å­˜åœ¨"
            fi
            
            # 2. åˆ›å»ºæ‰€éœ€ç›®å½•ï¼ˆç¾åè‡ªæ„ˆï¼‰
            echo "ğŸ“ æ£€æŸ¥å¹¶åˆ›å»ºç›®å½•..."
            sudo mkdir -p $APPS_ROOT $STATIC_ROOT $NGINX_CONF_DIR $CERT_DST
            sudo chown $RUN_USER:$RUN_USER $APPS_ROOT $STATIC_ROOT
            sudo chmod 755 $NGINX_CONF_DIR $CERT_DST
            echo "âœ… ç›®å½•ç»“æ„æ£€æŸ¥å®Œæˆ"
            
            # 3. è½¯é“¾å®å¡”è¯ä¹¦ï¼ˆå¥åº·å·¡æ£€ï¼‰
            echo "ğŸ”— æ£€æŸ¥è¯ä¹¦è½¯é“¾..."
            if [ ! -d "$CERT_SRC" ]; then
              echo "âŒ è¯ä¹¦æºç›®å½•ä¸å­˜åœ¨: $CERT_SRC"
              echo "è¯·ç¡®ä¿å®å¡”é¢æ¿å·²ä¸ºåŸŸå $DOMAIN é…ç½®SSLè¯ä¹¦"
              exit 1
            fi
            
            # æ£€æŸ¥å¹¶é‡æ–°åˆ›å»ºè½¯é“¾
            if [ -f "$CERT_SRC/fullchain.pem" ]; then
              sudo ln -sf $CERT_SRC/fullchain.pem $CERT_DST/fullchain.pem
              echo "âœ… è½¯é“¾ fullchain.pem å®Œæˆ"
            else
              echo "âŒ è¯ä¹¦æ–‡ä»¶ä¸å­˜åœ¨: $CERT_SRC/fullchain.pem"
              exit 1
            fi
            
            if [ -f "$CERT_SRC/privkey.pem" ]; then
              sudo ln -sf $CERT_SRC/privkey.pem $CERT_DST/privkey.pem
              echo "âœ… è½¯é“¾ privkey.pem å®Œæˆ"
            else
              echo "âŒ ç§é’¥æ–‡ä»¶ä¸å­˜åœ¨: $CERT_SRC/privkey.pem"
              exit 1
            fi
            
            # 4. å†™å…¥/æ›´æ–°ä¸»é…ç½®ï¼ˆé…ç½®å˜æ›´ï¼‰
            echo "ğŸ“ æ›´æ–°ä¸»é…ç½®æ–‡ä»¶..."
            MAIN_CONF="$NGINX_CONF_DIR/00-main.conf"
            
            # åˆ›å»ºä¸»é…ç½®æ–‡ä»¶å¤‡ä»½ç›®å½•
            MAIN_BACKUP_DIR="$NGINX_CONF_DIR/backups/main"
            echo "ğŸ“ åˆ›å»ºä¸»é…ç½®æ–‡ä»¶å¤‡ä»½ç›®å½•: $MAIN_BACKUP_DIR"
            sudo mkdir -p "$MAIN_BACKUP_DIR"
            sudo chmod 755 "$MAIN_BACKUP_DIR"
            
            # å¤‡ä»½ç°æœ‰ä¸»é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -f "$MAIN_CONF" ]; then
              echo "ğŸ“‹ å¤‡ä»½ç°æœ‰ä¸»é…ç½®æ–‡ä»¶: $MAIN_CONF"
              MAIN_BACKUP_FILE="$MAIN_BACKUP_DIR/00-main.conf.backup.$(date +%Y%m%d_%H%M%S)"
              sudo cp "$MAIN_CONF" "$MAIN_BACKUP_FILE"
              echo "âœ… ä¸»é…ç½®æ–‡ä»¶å·²å¤‡ä»½åˆ°: $MAIN_BACKUP_FILE"
              
              # æ¸…ç†æ—§çš„å¤‡ä»½æ–‡ä»¶ï¼Œåªä¿ç•™æœ€è¿‘3ä¸ª
              echo "ğŸ§¹ æ¸…ç†æ—§çš„ä¸»é…ç½®æ–‡ä»¶å¤‡ä»½..."
              BACKUP_FILES=$(ls -t "$MAIN_BACKUP_DIR"/00-main.conf.backup.* 2>/dev/null | tail -n +4)
              if [ -n "$BACKUP_FILES" ]; then
                echo "ğŸ—‘ï¸ åˆ é™¤æ—§çš„ä¸»é…ç½®æ–‡ä»¶å¤‡ä»½:"
                echo "$BACKUP_FILES" | xargs -r sudo rm -f
                echo "âœ… æ—§ä¸»é…ç½®æ–‡ä»¶å¤‡ä»½å·²æ¸…ç†ï¼Œä¿ç•™æœ€è¿‘3ä¸ªå¤‡ä»½"
              else
                echo "ğŸ“‹ æ²¡æœ‰éœ€è¦æ¸…ç†çš„æ—§ä¸»é…ç½®æ–‡ä»¶å¤‡ä»½"
              fi
            else
              echo "ğŸ“‹ ä¸»é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶"
            fi
            
            # æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°ç”Ÿæˆé…ç½®
            if [ ! -f "$MAIN_CONF" ] || [ "$FORCE_REBUILD" = "true" ] || [ "$(stat -c %Y $MAIN_CONF)" -lt "$(date -d '1 hour ago' +%s)" ] || [ "$(grep -c 'location / {' $MAIN_CONF 2>/dev/null || echo 0)" -gt 0 ]; then
              echo "ğŸ”„ é‡æ–°ç”Ÿæˆä¸»é…ç½®æ–‡ä»¶..."
              sudo tee $MAIN_CONF <<'EOF'
            server {
                listen 443 ssl;
                server_name redamancy.com.cn;
                http2 on;
            
                ssl_certificate     /www/server/nginx/ssl/redamancy/fullchain.pem;
                ssl_certificate_key /www/server/nginx/ssl/redamancy/privkey.pem;
            
                client_max_body_size 100m;
            
                # è¿™é‡Œè‡ªåŠ¨åŠ è½½ route-*.confï¼ˆé¡¹ç›®è·¯ç”±ï¼‰â€”â€”ä¸»é…ç½®æ°¸è¿œä¸ç”¨å†æ”¹
                include /www/server/nginx/conf/conf.d/redamancy/route-*.conf;
            }
            
            server {
                listen 80;
                server_name redamancy.com.cn;
                
                # è‡ªåŠ¨åŠ è½½æ‰€æœ‰é¡¹ç›®è·¯ç”±é…ç½®ï¼ˆHTTPç‰ˆæœ¬ï¼‰
                include /www/server/nginx/conf/conf.d/redamancy/route-*.conf;
                
                # å…¶ä»–è·¯å¾„é‡å®šå‘åˆ° HTTPSï¼ˆæ’é™¤å·²å¤„ç†çš„è·¯ç”±ï¼‰
                location ~ ^/(?!docs|api|health|uploads|static|$) {
                    return 301 https://$host$request_uri;
                }
            }
            EOF
              echo "âœ… ä¸»é…ç½®æ–‡ä»¶å·²æ›´æ–°"
            else
              echo "âœ… ä¸»é…ç½®æ–‡ä»¶æ— éœ€æ›´æ–°"
            fi
            
            # 5. æ£€æŸ¥å¹¶é‡è½½Nginxï¼ˆå¥åº·å·¡æ£€ï¼‰
            echo "ğŸ”„ æ£€æŸ¥Nginxé…ç½®..."
            if sudo nginx -t; then
              echo "âœ… Nginxé…ç½®è¯­æ³•æ£€æŸ¥é€šè¿‡"
            else
              echo "âŒ Nginxé…ç½®è¯­æ³•é”™è¯¯"
              echo "é…ç½®é”™è¯¯è¯¦æƒ…:"
              sudo nginx -t 2>&1
              exit 1
            fi
            
            echo "ğŸ”„ å°è¯•é‡è½½Nginx..."
            # å…ˆæ£€æŸ¥Nginxè¿›ç¨‹æ˜¯å¦æ­£åœ¨è¿è¡Œ
            if pgrep nginx > /dev/null; then
              echo "âœ… Nginxè¿›ç¨‹æ­£åœ¨è¿è¡Œï¼Œå°è¯•é‡è½½..."
              if sudo systemctl reload nginx; then
                echo "âœ… Nginxçƒ­åŠ è½½å®Œæˆ"
              else
                                 echo "âŒ Nginxé‡è½½å¤±è´¥ï¼Œå°è¯•é‡å¯..."
                 # åœæ­¢æ‰€æœ‰Nginxè¿›ç¨‹
                 echo "ğŸ›‘ åœæ­¢æ‰€æœ‰Nginxè¿›ç¨‹..."
                 sudo pkill -f nginx || true
                 sleep 3
                 
                 # ç¡®ä¿è¿›ç¨‹å®Œå…¨åœæ­¢
                 if pgrep nginx > /dev/null; then
                   echo "âš ï¸  å¼ºåˆ¶åœæ­¢æ®‹ç•™çš„Nginxè¿›ç¨‹..."
                   sudo pkill -9 -f nginx || true
                   sleep 2
                 fi
                
                # æ¸…ç†systemdçŠ¶æ€
                sudo systemctl reset-failed nginx
                
                # é‡æ–°å¯åŠ¨
                if sudo systemctl start nginx; then
                  echo "âœ… Nginxé‡å¯æˆåŠŸ"
                else
                  echo "âŒ Nginxé‡å¯å¤±è´¥ï¼Œæ˜¾ç¤ºè¯¦ç»†é”™è¯¯:"
                  sudo systemctl status nginx --no-pager -l
                  echo "Nginxé”™è¯¯æ—¥å¿—:"
                  sudo tail -n 20 /var/log/nginx/error.log 2>/dev/null || echo "æ— æ³•è¯»å–é”™è¯¯æ—¥å¿—"
                  exit 1
                fi
              fi
            else
              echo "âš ï¸  Nginxè¿›ç¨‹æœªè¿è¡Œï¼Œå°è¯•å¯åŠ¨..."
              if sudo systemctl start nginx; then
                echo "âœ… Nginxå¯åŠ¨æˆåŠŸ"
              else
                echo "âŒ Nginxå¯åŠ¨å¤±è´¥ï¼Œæ˜¾ç¤ºè¯¦ç»†é”™è¯¯:"
                sudo systemctl status nginx --no-pager -l
                echo "Nginxé”™è¯¯æ—¥å¿—:"
                sudo tail -n 20 /var/log/nginx/error.log 2>/dev/null || echo "æ— æ³•è¯»å–é”™è¯¯æ—¥å¿—"
                exit 1
              fi
            fi
            
            # 6. é˜²ç«å¢™æ£€æŸ¥ï¼ˆå¥åº·å·¡æ£€ï¼‰
            echo "ğŸ”¥ æ£€æŸ¥é˜²ç«å¢™è§„åˆ™..."
            if command -v firewall-cmd &> /dev/null; then
              if ! sudo firewall-cmd --list-services | grep -q http; then
                echo "âš ï¸  HTTPç«¯å£æœªå¼€æ”¾ï¼Œå°è¯•å¼€æ”¾..."
                sudo firewall-cmd --add-service=http --permanent
                sudo firewall-cmd --add-service=https --permanent
                sudo firewall-cmd --reload
                echo "âœ… HTTP/HTTPSç«¯å£å·²å¼€æ”¾"
              else
                echo "âœ… HTTP/HTTPSç«¯å£å·²å¼€æ”¾"
              fi
            else
              echo "æœªæ£€æµ‹åˆ° firewalldï¼Œè·³è¿‡é˜²ç«å¢™é…ç½®"
            fi
            
            # 7. æœ€ç»ˆéªŒè¯
            echo "ğŸ” æœ€ç»ˆéªŒè¯..."
            echo "ğŸ“ é…ç½®æ–‡ä»¶:"
            ls -la $NGINX_CONF_DIR/
            echo "ğŸ”— è¯ä¹¦è½¯é“¾:"
            ls -la $CERT_DST/
            echo "ğŸ“‚ ç›®å½•æƒé™:"
            ls -la $APPS_ROOT/
            ls -la $STATIC_ROOT/
            
            # æµ‹è¯•HTTPSè®¿é—®
            echo "ğŸŒ æµ‹è¯•HTTPSè®¿é—®:"
            if curl -f -s https://$DOMAIN > /dev/null 2>&1; then
              echo "âœ… HTTPSè®¿é—®æ­£å¸¸"
            else
              echo "âš ï¸  HTTPSè®¿é—®æµ‹è¯•å¤±è´¥ï¼ˆå¯èƒ½å°šæœªéƒ¨ç½²é¡¹ç›®ï¼‰"
            fi
            
            echo "âœ… æœåŠ¡å™¨åˆå§‹åŒ–å®Œæˆï¼"
            echo ""
            echo "ğŸ“‹ åˆå§‹åŒ–æ‘˜è¦:"
            echo "- åŸŸå: $DOMAIN"
            echo "- è¿è¡Œç”¨æˆ·: $RUN_USER"
            echo "- åº”ç”¨ç›®å½•: $APPS_ROOT"
            echo "- é™æ€ç›®å½•: $STATIC_ROOT"
            echo "- Nginxé…ç½®: $NGINX_CONF_DIR"
            echo "- è¯ä¹¦æº: $CERT_SRC"
            echo "- è¯ä¹¦ç›®æ ‡: $CERT_DST"

  # æ­¥éª¤2: é¡¹ç›®éƒ¨ç½²
  deploy:
    runs-on: ubuntu-latest
    needs: [server-init]
    if: ${{ !inputs.skip_init }} || always()
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: dawidd6/action-download-artifact@v2
        with:
          name: dist-${{ inputs.project }}
          path: ./dist
          repo: ${{ inputs.source_repo }}
          workflow: ${{ inputs.project }}_deploy.yml
          run_id: ${{ inputs.run_id }}
          github_token: ${{ secrets.DEPLOY_CENTER_PAT }}

      - name: æ˜¾ç¤ºæ„å»ºäº§ç‰©ä¿¡æ¯
        run: |
          echo "ğŸ“¦ æ„å»ºäº§ç‰©ä¿¡æ¯:"
          ls -la ./dist/
          echo "ğŸ“‹ éƒ¨ç½²å‚æ•°:"
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- éƒ¨ç½²ç±»å‹: ${{ inputs.deploy_type }}"
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- æ„å»ºID: ${{ inputs.run_id }}"

      - name: ä¸Šä¼ åˆ°æœåŠ¡å™¨
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: "./dist/*"
          target: "/tmp/${{ inputs.project }}/"
          command_timeout: "10m"
          
      - name: éªŒè¯ä¸Šä¼ 
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸ” éªŒè¯ä¸Šä¼ æ–‡ä»¶..."
            TEMP_DIR="/tmp/${{ inputs.project }}"
            
            if [ -d "$TEMP_DIR" ]; then
              echo "âœ… ä¸´æ—¶ç›®å½•å­˜åœ¨: $TEMP_DIR"
              echo "ğŸ“ ä¸´æ—¶ç›®å½•å†…å®¹:"
              ls -la $TEMP_DIR/
              
              if [ -f "$TEMP_DIR/deployment.tar.gz" ]; then
                echo "âœ… deployment.tar.gz å­˜åœ¨"
                echo "ğŸ“¦ æ–‡ä»¶å¤§å°: $(ls -lh $TEMP_DIR/deployment.tar.gz | awk '{print $5}')"
                echo "ğŸ“‹ å‹ç¼©åŒ…å†…å®¹é¢„è§ˆ:"
                tar -tzf $TEMP_DIR/deployment.tar.gz | head -10
              else
                echo "âŒ deployment.tar.gz ä¸å­˜åœ¨"
                echo "ğŸ“ æŸ¥æ‰¾æ‰€æœ‰æ–‡ä»¶:"
                find $TEMP_DIR -type f
              fi
            else
              echo "âŒ ä¸´æ—¶ç›®å½•ä¸å­˜åœ¨: $TEMP_DIR"
              echo "ğŸ“ /tmp ç›®å½•å†…å®¹:"
              ls -la /tmp/
            fi

      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²é¡¹ç›®: ${{ inputs.project }}"
            
            # æ ‡å‡†åŒ–ç›®å½•ç»“æ„
            APPS_ROOT="/srv/apps"
            STATIC_ROOT="/srv/static"
            NGINX_CONF_DIR="/www/server/nginx/conf/conf.d/redamancy"
            PROJECT="${{ inputs.project }}"
            TEMP_DIR="/tmp/$PROJECT"
            
            echo "ğŸ“ é¡¹ç›®ä¸´æ—¶ç›®å½•: $TEMP_DIR"
            
            # æ ¹æ®éƒ¨ç½²ç±»å‹ç¡®å®šéƒ¨ç½²è·¯å¾„
            if [[ "${{ inputs.deploy_type }}" == "backend" ]]; then
              # åç«¯é¡¹ç›®éƒ¨ç½²åˆ°åº”ç”¨ç›®å½•
              DEPLOY_PATH="$APPS_ROOT/$PROJECT"
              echo "ğŸ“ åç«¯é¡¹ç›®éƒ¨ç½²åˆ°: $DEPLOY_PATH"
            else
              # é™æ€é¡¹ç›®éƒ¨ç½²åˆ°é™æ€æ–‡ä»¶ç›®å½•
              DEPLOY_PATH="$STATIC_ROOT/$PROJECT"
              echo "ğŸ“ é™æ€é¡¹ç›®éƒ¨ç½²åˆ°: $DEPLOY_PATH"
            fi
            
            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            sudo mkdir -p $DEPLOY_PATH
            sudo chown deploy:deploy $DEPLOY_PATH
            
            # åˆ›å»ºé¡¹ç›®ä¸“ç”¨å¤‡ä»½ç›®å½•
            if [[ "${{ inputs.deploy_type }}" == "backend" ]]; then
              BACKUP_ROOT="/srv/backups/apps"
            else
              BACKUP_ROOT="/srv/backups/static"
            fi
            PROJECT_BACKUP_DIR="$BACKUP_ROOT/$PROJECT"
            echo "ğŸ“ åˆ›å»ºé¡¹ç›®å¤‡ä»½ç›®å½•: $PROJECT_BACKUP_DIR"
            sudo mkdir -p "$PROJECT_BACKUP_DIR"
            sudo chmod 755 "$PROJECT_BACKUP_DIR"
            
            # æ¸…ç†ç›®æ ‡éƒ¨ç½²ç›®å½•ï¼ˆé¿å…æ®‹ç•™æ–‡ä»¶ï¼‰
            echo "ğŸ§¹ æ¸…ç†ç›®æ ‡éƒ¨ç½²ç›®å½•..."
            if [ -d "$DEPLOY_PATH" ]; then
              echo "ğŸ“‹ å¤‡ä»½æ—§éƒ¨ç½²ç›®å½•: $DEPLOY_PATH"
              BACKUP_NAME="$PROJECT_BACKUP_DIR/$PROJECT.backup.$(date +%Y%m%d_%H%M%S)"
              sudo cp -r $DEPLOY_PATH $BACKUP_NAME
              sudo rm -rf $DEPLOY_PATH
              echo "âœ… æ—§éƒ¨ç½²ç›®å½•å·²å¤‡ä»½åˆ°: $BACKUP_NAME"
              
              # æ¸…ç†æ—§çš„å¤‡ä»½æ–‡ä»¶ï¼Œåªä¿ç•™æœ€è¿‘2ä¸ª
              echo "ğŸ§¹ æ¸…ç†æ—§çš„å¤‡ä»½æ–‡ä»¶..."
              BACKUP_FILES=$(ls -t "$PROJECT_BACKUP_DIR"/$PROJECT.backup.* 2>/dev/null | tail -n +3)
              if [ -n "$BACKUP_FILES" ]; then
                echo "ğŸ—‘ï¸ åˆ é™¤æ—§çš„å¤‡ä»½æ–‡ä»¶:"
                echo "$BACKUP_FILES" | xargs -r sudo rm -rf
                echo "âœ… æ—§å¤‡ä»½æ–‡ä»¶å·²æ¸…ç†ï¼Œä¿ç•™æœ€è¿‘2ä¸ªå¤‡ä»½"
              else
                echo "ğŸ“‹ æ²¡æœ‰éœ€è¦æ¸…ç†çš„æ—§å¤‡ä»½æ–‡ä»¶"
              fi
            fi
            sudo mkdir -p $DEPLOY_PATH
            sudo chown deploy:deploy $DEPLOY_PATH
            echo "âœ… éƒ¨ç½²ç›®å½•å·²æ¸…ç†å¹¶é‡æ–°åˆ›å»º"
            
            # æ£€æŸ¥ä¸´æ—¶ç›®å½•æ˜¯å¦å­˜åœ¨
            if [ ! -d "$TEMP_DIR" ]; then
              echo "âŒ ä¸´æ—¶ç›®å½•ä¸å­˜åœ¨: $TEMP_DIR"
              echo "ğŸ“ /tmp ç›®å½•å†…å®¹:"
              ls -la /tmp/
              exit 1
            fi
            
            # è¿›å…¥é¡¹ç›®ä¸´æ—¶ç›®å½•
            cd $TEMP_DIR
            echo "ğŸ“ å½“å‰ä¸´æ—¶ç›®å½•å†…å®¹:"
            ls -la
            
            # æ ¹æ®éƒ¨ç½²ç±»å‹å¤„ç†æ–‡ä»¶
            if [[ "${{ inputs.deploy_type }}" == "backend" ]]; then
              # åç«¯é¡¹ç›®ï¼šæŸ¥æ‰¾ deployment.tar.gz æ–‡ä»¶
              DEPLOYMENT_FILE=""
              if [ -f "deployment.tar.gz" ]; then
                DEPLOYMENT_FILE="deployment.tar.gz"
                echo "âœ… åœ¨æ ¹ç›®å½•æ‰¾åˆ° deployment.tar.gz"
              elif [ -f "dist/deployment.tar.gz" ]; then
                DEPLOYMENT_FILE="dist/deployment.tar.gz"
                echo "âœ… åœ¨ dist ç›®å½•æ‰¾åˆ° deployment.tar.gz"
              else
                echo "âŒ æœªæ‰¾åˆ° deployment.tar.gz"
                echo "ğŸ“ å½“å‰ç›®å½•æ‰€æœ‰æ–‡ä»¶:"
                find . -type f
                exit 1
              fi
              
              echo "ğŸ“¦ æ–‡ä»¶å¤§å°: $(ls -lh $DEPLOYMENT_FILE | awk '{print $5}')"
              echo "ğŸ“‹ å‹ç¼©åŒ…å†…å®¹é¢„è§ˆ:"
              tar -tzf $DEPLOYMENT_FILE | head -10
              
              # è§£å‹å¹¶éƒ¨ç½²æ–‡ä»¶
              echo "ğŸ“¦ è§£å‹éƒ¨ç½²æ–‡ä»¶..."
              if [ -f "$DEPLOYMENT_FILE" ]; then
                # åç«¯é¡¹ç›®éƒ¨ç½²
                echo "ğŸ”§ éƒ¨ç½²åç«¯é¡¹ç›®..."
                sudo tar xzf $DEPLOYMENT_FILE -C $DEPLOY_PATH
                sudo chown -R deploy:deploy $DEPLOY_PATH
                
                # è®¾ç½®å¯æ‰§è¡Œæƒé™
                if [ -f "$DEPLOY_PATH/star-cloud-linux" ]; then
                  sudo chmod +x $DEPLOY_PATH/star-cloud-linux
                  echo "âœ… äºŒè¿›åˆ¶æ–‡ä»¶æƒé™è®¾ç½®å®Œæˆ"
                else
                  echo "âŒ äºŒè¿›åˆ¶æ–‡ä»¶ä¸å­˜åœ¨: $DEPLOY_PATH/star-cloud-linux"
                  echo "ğŸ“ éƒ¨ç½²ç›®å½•å†…å®¹:"
                  ls -la $DEPLOY_PATH/
                  exit 1
                fi
                
                # åˆ›å»ºå¿…è¦ç›®å½•
                sudo mkdir -p $DEPLOY_PATH/uploads/{image,document,audio,video,other,avatars}
                sudo mkdir -p $DEPLOY_PATH/logs
                sudo chown -R deploy:deploy $DEPLOY_PATH/uploads $DEPLOY_PATH/logs
                
                # æ£€æŸ¥æ–‡ä»¶æƒé™å’Œç›®å½•ç»“æ„
                echo "ğŸ” æ£€æŸ¥æ–‡ä»¶æƒé™å’Œç›®å½•ç»“æ„..."
                echo "ğŸ“ éƒ¨ç½²ç›®å½•å†…å®¹:"
                ls -la $DEPLOY_PATH/
                
                if [ -f "$DEPLOY_PATH/star-cloud-linux" ]; then
                  echo "âœ… äºŒè¿›åˆ¶æ–‡ä»¶:"
                  ls -la $DEPLOY_PATH/star-cloud-linux
                else
                  echo "âŒ äºŒè¿›åˆ¶æ–‡ä»¶ä¸å­˜åœ¨"
                  echo "ğŸ“ æŸ¥æ‰¾äºŒè¿›åˆ¶æ–‡ä»¶:"
                  find $DEPLOY_PATH -name "star-cloud-linux" -type f
                fi
                
                if [ -f "$DEPLOY_PATH/star-cloud.service" ]; then
                  echo "âœ… æœåŠ¡æ–‡ä»¶:"
                  ls -la $DEPLOY_PATH/star-cloud.service
                else
                  echo "âŒ æœåŠ¡æ–‡ä»¶ä¸å­˜åœ¨"
                  echo "ğŸ“ æŸ¥æ‰¾æœåŠ¡æ–‡ä»¶:"
                  find $DEPLOY_PATH -name "star-cloud.service" -type f
                fi
                
                if [ -d "$DEPLOY_PATH/backend/config" ]; then
                  echo "âœ… é…ç½®æ–‡ä»¶:"
                  ls -la $DEPLOY_PATH/backend/config/
                else
                  echo "âŒ é…ç½®æ–‡ä»¶ç›®å½•ä¸å­˜åœ¨"
                  echo "ğŸ“ æŸ¥æ‰¾é…ç½®æ–‡ä»¶:"
                  find $DEPLOY_PATH -name "config" -type d
                fi
                 
                 # æ£€æŸ¥æœåŠ¡æ–‡ä»¶å†…å®¹
                 if [ -f "$DEPLOY_PATH/star-cloud.service" ]; then
                   echo "ğŸ“‹ æœåŠ¡æ–‡ä»¶å†…å®¹:"
                   cat $DEPLOY_PATH/star-cloud.service
                 else
                   echo "âŒ æœåŠ¡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•æ˜¾ç¤ºå†…å®¹"
                 fi
                 
                 # å¯åŠ¨æœåŠ¡
                 echo "ğŸš€ å¯åŠ¨åç«¯æœåŠ¡..."
                 sudo systemctl daemon-reload
                 sudo systemctl enable star-cloud.service
                 sudo systemctl restart star-cloud.service
                 
                 # ç­‰å¾…æœåŠ¡å¯åŠ¨
                 echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
                 sleep 10
                 
                 # å¥åº·æ£€æŸ¥
                 echo "ğŸ” æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
                 if curl -f -s http://127.0.0.1:8080/health > /dev/null 2>&1; then
                   echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ - å¥åº·æ£€æŸ¥é€šè¿‡"
                 else
                   echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥ - å¥åº·æ£€æŸ¥å¤±è´¥"
                   echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
                   sudo systemctl status star-cloud.service --no-pager -l
                   echo "ğŸ“‹ æœåŠ¡æ—¥å¿—:"
                   sudo journalctl -u star-cloud.service --no-pager -n 20
                   echo "ğŸ” æ£€æŸ¥ç«¯å£å ç”¨:"
                   sudo netstat -tlnp | grep :8080
                   echo "ğŸ” æ£€æŸ¥è¿›ç¨‹:"
                   ps aux | grep star-cloud
                   exit 1
                 fi
              else
                echo "âŒ deployment.tar.gz æ–‡ä»¶ä¸å­˜åœ¨"
                exit 1
              fi
            else
              # é™æ€é¡¹ç›®ï¼šç›´æ¥å¤åˆ¶æ–‡ä»¶
              echo "ğŸ“ éƒ¨ç½²é™æ€é¡¹ç›®..."
              echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
              ls -la
              
              # æ£€æŸ¥æ˜¯å¦æœ‰ dist ç›®å½•
              if [ -d "dist" ]; then
                echo "âœ… æ‰¾åˆ° dist ç›®å½•ï¼Œå¤åˆ¶å…¶å†…å®¹..."
                sudo cp -r dist/* $DEPLOY_PATH/
              else
                echo "ğŸ“ æ²¡æœ‰ dist ç›®å½•ï¼Œå¤åˆ¶æ‰€æœ‰æ–‡ä»¶..."
                sudo cp -r * $DEPLOY_PATH/
              fi
              
              sudo chown -R deploy:deploy $DEPLOY_PATH
              echo "âœ… é™æ€é¡¹ç›®éƒ¨ç½²å®Œæˆ"
              
              # æ˜¾ç¤ºéƒ¨ç½²ç»“æœ
              echo "ğŸ“ éƒ¨ç½²ç›®å½•å†…å®¹:"
              ls -la $DEPLOY_PATH/
            fi
            
            # æ¸…ç†ä¸´æ—¶ç›®å½•
            echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶ç›®å½•..."
            sudo rm -rf $TEMP_DIR
            echo "âœ… ä¸´æ—¶ç›®å½•å·²æ¸…ç†: $TEMP_DIR"
            
            echo "âœ… é¡¹ç›®éƒ¨ç½²å®Œæˆ: ${{ inputs.project }}"

      - name: é…ç½®Nginxï¼ˆå¦‚æœæä¾›é…ç½®ï¼‰
        if: inputs.nginx_config != ''
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸ”§ é…ç½®Nginx..."
            
            NGINX_CONF_DIR="/www/server/nginx/conf/conf.d/redamancy"
            PROJECT="${{ inputs.project }}"
            
            # ç”Ÿæˆé¡¹ç›®è·¯ç”±é…ç½®
            ROUTE_CONF="$NGINX_CONF_DIR/route-$PROJECT.conf"
            
            # ä¿æŠ¤ä¸»é…ç½®æ–‡ä»¶ - ç¡®ä¿ä¸ä¼šè¢«ä¿®æ”¹
            MAIN_CONF="$NGINX_CONF_DIR/00-main.conf"
            echo "ğŸ›¡ï¸ ä¿æŠ¤ä¸»é…ç½®æ–‡ä»¶: $MAIN_CONF"
            if [ -f "$MAIN_CONF" ]; then
              echo "âœ… ä¸»é…ç½®æ–‡ä»¶å­˜åœ¨ï¼Œè®¾ç½®åªè¯»æƒé™ä¿æŠ¤"
              sudo chmod 444 "$MAIN_CONF"
              echo "ğŸ“‹ ä¸»é…ç½®æ–‡ä»¶æƒé™: $(ls -la $MAIN_CONF)"
              
              # æ˜¾ç¤ºå¤‡ä»½ä¿¡æ¯
              MAIN_BACKUP_DIR="$NGINX_CONF_DIR/backups/main"
              if [ -d "$MAIN_BACKUP_DIR" ]; then
                echo "ğŸ“‹ ä¸»é…ç½®æ–‡ä»¶å¤‡ä»½ç›®å½•: $MAIN_BACKUP_DIR"
                BACKUP_COUNT=$(ls -1 "$MAIN_BACKUP_DIR"/00-main.conf.backup.* 2>/dev/null | wc -l)
                echo "ğŸ“Š å½“å‰å¤‡ä»½æ•°é‡: $BACKUP_COUNT"
                if [ "$BACKUP_COUNT" -gt 0 ]; then
                  echo "ğŸ“‹ æœ€æ–°å¤‡ä»½æ–‡ä»¶:"
                  ls -la "$MAIN_BACKUP_DIR"/00-main.conf.backup.* | tail -1
                fi
              fi
            else
              echo "âš ï¸ ä¸»é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $MAIN_CONF"
            fi
            
            # åˆ›å»ºé¡¹ç›®ä¸“ç”¨å¤‡ä»½ç›®å½•
            BACKUP_DIR="$NGINX_CONF_DIR/backups"
            PROJECT_BACKUP_DIR="$BACKUP_DIR/$PROJECT"
            echo "ğŸ“ åˆ›å»ºé¡¹ç›®å¤‡ä»½ç›®å½•: $PROJECT_BACKUP_DIR"
            sudo mkdir -p "$PROJECT_BACKUP_DIR"
            sudo chmod 755 "$PROJECT_BACKUP_DIR"
            
            # æ¸…ç†æ—§çš„ Nginx é…ç½®æ–‡ä»¶ï¼ˆä»…è·¯ç”±é…ç½®ï¼‰
            echo "ğŸ§¹ æ¸…ç†æ—§çš„è·¯ç”±é…ç½®æ–‡ä»¶..."
            if [ -f "$ROUTE_CONF" ]; then
              echo "ğŸ“‹ å¤‡ä»½æ—§è·¯ç”±é…ç½®æ–‡ä»¶: $ROUTE_CONF"
              BACKUP_FILE="$PROJECT_BACKUP_DIR/route-$PROJECT.conf.backup.$(date +%Y%m%d_%H%M%S)"
              sudo cp "$ROUTE_CONF" "$BACKUP_FILE"
              sudo rm -f "$ROUTE_CONF"
              echo "âœ… æ—§è·¯ç”±é…ç½®æ–‡ä»¶å·²å¤‡ä»½åˆ°: $BACKUP_FILE"
              
              # æ¸…ç†æ—§çš„å¤‡ä»½æ–‡ä»¶ï¼Œåªä¿ç•™æœ€è¿‘2ä¸ª
              echo "ğŸ§¹ æ¸…ç†æ—§çš„å¤‡ä»½æ–‡ä»¶..."
              BACKUP_FILES=$(ls -t "$PROJECT_BACKUP_DIR"/route-$PROJECT.conf.backup.* 2>/dev/null | tail -n +3)
              if [ -n "$BACKUP_FILES" ]; then
                echo "ğŸ—‘ï¸ åˆ é™¤æ—§çš„å¤‡ä»½æ–‡ä»¶:"
                echo "$BACKUP_FILES" | xargs -r sudo rm -f
                echo "âœ… æ—§å¤‡ä»½æ–‡ä»¶å·²æ¸…ç†ï¼Œä¿ç•™æœ€è¿‘2ä¸ªå¤‡ä»½"
              else
                echo "ğŸ“‹ æ²¡æœ‰éœ€è¦æ¸…ç†çš„æ—§å¤‡ä»½æ–‡ä»¶"
              fi
            else
              echo "ğŸ“‹ æ²¡æœ‰æ‰¾åˆ°æ—§çš„è·¯ç”±é…ç½®æ–‡ä»¶: $ROUTE_CONF"
            fi
            
            # æ£€æŸ¥nginx_configæ˜¯å¦åŒ…å«serverå—
            if echo '${{ inputs.nginx_config }}' | grep -q '^server {'; then
              # å¦‚æœåŒ…å«serverå—ï¼Œæå–locationå—
              echo "ğŸ“ æ£€æµ‹åˆ°serverå—é…ç½®ï¼Œæå–locationå—..."
              LOCATION_CONFIG=$(echo '${{ inputs.nginx_config }}' | sed -n '/location /,/}/p' | sed 's/^/    /')
              
              # æ¸…ç†å’Œæ ¼å¼åŒ–locationé…ç½®
              CLEANED_CONFIG=$(echo "$LOCATION_CONFIG" | sed 's/\\\\.html$/\\.html$/g' | sed 's/\\"/"/g')
              
              # ç›´æ¥å†™å…¥é…ç½®
              echo "$CLEANED_CONFIG" | sudo tee $ROUTE_CONF
              echo "âœ… Nginxé…ç½®å·²å†™å…¥: $ROUTE_CONF (æå–çš„locationå—)"
            else
              # å¦‚æœä¸åŒ…å«serverå—ï¼Œç›´æ¥ä½¿ç”¨locationå—
              echo "ğŸ“ æ£€æµ‹åˆ°locationå—é…ç½®ï¼Œç›´æ¥å†™å…¥..."
              
              # æ¸…ç†å’Œæ ¼å¼åŒ–nginx_configï¼Œç¡®ä¿æ­£ç¡®çš„ç¼©è¿›
              CLEANED_CONFIG=$(echo '${{ inputs.nginx_config }}' | sed 's/\\\\.html$/\\.html$/g' | sed 's/\\"/"/g' | sed 's/^/    /')
              
              # æ£€æŸ¥é…ç½®æ˜¯å¦åŒ…å«æ­£ç¡®çš„è·¯å¾„
              if echo "$CLEANED_CONFIG" | grep -q "/srv/static/axi-docs/"; then
                echo "âœ… æ£€æµ‹åˆ°æ­£ç¡®çš„éƒ¨ç½²è·¯å¾„ (/srv/static/axi-docs/)"
              elif echo "$CLEANED_CONFIG" | grep -q "/www/wwwroot/redamancy.com.cn/docs/"; then
                echo "âœ… æ£€æµ‹åˆ°æ­£ç¡®çš„éƒ¨ç½²è·¯å¾„ (/www/wwwroot/redamancy.com.cn/docs/)"
              elif echo "$CLEANED_CONFIG" | grep -q "/srv/apps/axi-star-cloud/"; then
                echo "âœ… æ£€æµ‹åˆ°æ­£ç¡®çš„éƒ¨ç½²è·¯å¾„ (/srv/apps/axi-star-cloud/)"
              else
                echo "âš ï¸ è­¦å‘Š: é…ç½®ä¸­å¯èƒ½ä½¿ç”¨äº†é”™è¯¯çš„è·¯å¾„"
                echo "å½“å‰é…ç½®: $CLEANED_CONFIG"
              fi
              
              # ç›´æ¥å†™å…¥é…ç½®
              echo "$CLEANED_CONFIG" | sudo tee $ROUTE_CONF
              echo "âœ… Nginxé…ç½®å·²å†™å…¥: $ROUTE_CONF (locationå—)"
            fi
            
            # è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
            echo "ğŸ” è°ƒè¯•ä¿¡æ¯å¼€å§‹..."
            echo "ğŸ“ æ£€æŸ¥æ‰€æœ‰ Nginx é…ç½®æ–‡ä»¶:"
            find /www/server/nginx/conf -name "*.conf" -exec echo "æ–‡ä»¶: {}" \; -exec grep -l "docs\|301\|302" {} \;
            
            echo "ğŸ“‹ æ£€æŸ¥ä¸»é…ç½®æ–‡ä»¶:"
            if [ -f "/www/server/nginx/conf/vhost/redamancy.com.cn.conf" ]; then
              echo "ä¸»é…ç½®æ–‡ä»¶å†…å®¹:"
              cat /www/server/nginx/conf/vhost/redamancy.com.cn.conf
            else
              echo "ä¸»é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
            fi
            
            echo "ğŸ“‹ æ£€æŸ¥ç”Ÿæˆçš„é…ç½®æ–‡ä»¶:"
            if [ -f "$ROUTE_CONF" ]; then
              echo "ç”Ÿæˆçš„é…ç½®æ–‡ä»¶å†…å®¹:"
              cat $ROUTE_CONF
            else
              echo "ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
            fi
            
            echo "ğŸ“‹ æ£€æŸ¥æ‰€æœ‰åŒ…å« 'docs' çš„é…ç½®:"
            grep -r "docs" /www/server/nginx/conf/ || echo "æ²¡æœ‰æ‰¾åˆ°åŒ…å« 'docs' çš„é…ç½®"
            
            echo "ğŸ“‹ æ£€æŸ¥æ‰€æœ‰é‡å®šå‘è§„åˆ™:"
            grep -r "301\|302\|redirect" /www/server/nginx/conf/ || echo "æ²¡æœ‰æ‰¾åˆ°é‡å®šå‘è§„åˆ™"
            
            echo "ğŸ“ æ£€æŸ¥éƒ¨ç½²ç›®å½•:"
            ls -la /srv/static/axi-docs/ || echo "éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨"
            
            echo "ğŸ“‹ æ£€æŸ¥ index.html æ˜¯å¦å­˜åœ¨:"
            if [ -f "/srv/static/axi-docs/index.html" ]; then
              echo "âœ… index.html å­˜åœ¨"
              ls -la /srv/static/axi-docs/index.html
            else
              echo "âŒ index.html ä¸å­˜åœ¨"
              echo "éƒ¨ç½²ç›®å½•å†…å®¹:"
              ls -la /srv/static/axi-docs/
            fi
            
            # æ£€æŸ¥Nginxé…ç½®è¯­æ³•
            if sudo nginx -t; then
              echo "âœ… Nginxé…ç½®è¯­æ³•æ£€æŸ¥é€šè¿‡"
            else
              echo "âŒ Nginxé…ç½®è¯­æ³•é”™è¯¯"
              echo "ğŸ“‹ ç”Ÿæˆçš„é…ç½®æ–‡ä»¶å†…å®¹:"
              cat $ROUTE_CONF
              echo "ğŸ“‹ Nginx é”™è¯¯æ—¥å¿—:"
              sudo tail -n 20 /var/log/nginx/error.log
              exit 1
            fi
            
            # æ£€æŸ¥ç”Ÿæˆçš„é…ç½®æ–‡ä»¶
            echo "ğŸ“‹ ç”Ÿæˆçš„ Nginx é…ç½®æ–‡ä»¶å†…å®¹:"
            cat $ROUTE_CONF
            
            # é‡è½½Nginxé…ç½®
            if sudo systemctl reload nginx; then
              echo "âœ… Nginxé…ç½®é‡è½½å®Œæˆ"
            else
              echo "âŒ Nginxé‡è½½å¤±è´¥"
              echo "ğŸ“‹ Nginx é”™è¯¯æ—¥å¿—:"
              sudo tail -n 20 /var/log/nginx/error.log
              exit 1
            fi
            
            # æ¢å¤ä¸»é…ç½®æ–‡ä»¶æƒé™
            echo "ğŸ›¡ï¸ æ¢å¤ä¸»é…ç½®æ–‡ä»¶æƒé™..."
            if [ -f "$MAIN_CONF" ]; then
              sudo chmod 644 "$MAIN_CONF"
              echo "âœ… ä¸»é…ç½®æ–‡ä»¶æƒé™å·²æ¢å¤: $(ls -la $MAIN_CONF)"
            fi
            
            # æµ‹è¯•é…ç½®æ˜¯å¦ç”Ÿæ•ˆ
            echo "ğŸ” æµ‹è¯•é…ç½®æ˜¯å¦ç”Ÿæ•ˆ..."
            sleep 5
            
            # å…ˆæµ‹è¯•HTTP
            echo "ğŸ“‹ æµ‹è¯•HTTPè®¿é—®..."
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://redamancy.com.cn/)
            echo "HTTPæµ‹è¯•ç»“æœ: $HTTP_STATUS"
            
            # å†æµ‹è¯•HTTPS
            echo "ğŸ“‹ æµ‹è¯•HTTPSè®¿é—®..."
            HTTPS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://redamancy.com.cn/)
            echo "HTTPSæµ‹è¯•ç»“æœ: $HTTPS_STATUS"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–é…ç½®æ–‡ä»¶å¹²æ‰°
            echo "ğŸ“‹ æ£€æŸ¥æ‰€æœ‰nginxé…ç½®æ–‡ä»¶..."
            find /www/server/nginx/conf -name "*.conf" -exec echo "æ–‡ä»¶: {}" \; -exec grep -l "redamancy\|location" {} \;
            
            if [ "$HTTPS_STATUS" = "200" ]; then
              echo "âœ… HTTPSé…ç½®ç”Ÿæ•ˆï¼Œè¿”å› 200"
            elif [ "$HTTPS_STATUS" = "301" ]; then
              echo "âŒ HTTPSä»ç„¶è¿”å› 301ï¼Œæ£€æŸ¥å…¶ä»–é…ç½®..."
              echo "ğŸ“‹ æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–é…ç½®æ–‡ä»¶å¤„ç†æ ¹è·¯å¾„:"
              grep -r "location.*/" /www/server/nginx/conf/ | grep -v "route-" || echo "æ²¡æœ‰æ‰¾åˆ°å…¶ä»–æ ¹è·¯å¾„location"
            else
              echo "âš ï¸ HTTPSè¿”å›çŠ¶æ€ç : $HTTPS_STATUS"
            fi

      - name: æ‰§è¡Œå¯åŠ¨å‘½ä»¤ï¼ˆåç«¯é¡¹ç›®ï¼‰
        if: inputs.start_cmd != '' && inputs.deploy_type == 'backend'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸš€ æ‰§è¡Œå¯åŠ¨å‘½ä»¤..."
            cd /srv/apps/${{ inputs.project }}
            ${{ inputs.start_cmd }}

      - name: æµ‹è¯•ç½‘ç«™å¯è®¿é—®æ€§
        if: inputs.test_url != ''
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸŒ æµ‹è¯•ç½‘ç«™å¯è®¿é—®æ€§..."
            echo "æµ‹è¯•URL: ${{ inputs.test_url }}"
            
            # ç­‰å¾…ä¸€æ®µæ—¶é—´è®©æœåŠ¡å®Œå…¨å¯åŠ¨
            sleep 10
            
            # åˆ†åˆ«æµ‹è¯•HTTPå’ŒHTTPS
            echo "ğŸ“‹ æµ‹è¯•HTTPè®¿é—®..."
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://redamancy.com.cn/)
            echo "HTTPæµ‹è¯•ç»“æœ: $HTTP_STATUS"
            
            echo "ğŸ“‹ æµ‹è¯•HTTPSè®¿é—®..."
            HTTPS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-redirs 0 https://redamancy.com.cn/)
            echo "HTTPSæµ‹è¯•ç»“æœ: $HTTPS_STATUS"
            
            # å¦‚æœHTTPSè¿”å›301ï¼Œæ£€æŸ¥é‡å®šå‘ç›®æ ‡
            if [ "$HTTPS_STATUS" = "301" ]; then
              echo "ğŸ“‹ æ£€æŸ¥HTTPSé‡å®šå‘ç›®æ ‡..."
              REDIRECT_URL=$(curl -s -o /dev/null -w "%{redirect_url}" --max-redirs 0 https://redamancy.com.cn/)
              echo "é‡å®šå‘ç›®æ ‡: $REDIRECT_URL"
            fi
            
            # æ£€æŸ¥é…ç½®æ–‡ä»¶
            echo "ğŸ“‹ æ£€æŸ¥nginxé…ç½®æ–‡ä»¶..."
            find /www/server/nginx/conf -name "*.conf" -exec echo "æ–‡ä»¶: {}" \; -exec grep -l "redamancy\|location" {} \;
            
            # æ£€æŸ¥ä¸»é…ç½®æ–‡ä»¶ä¸­çš„é‡å®šå‘è§„åˆ™
            echo "ğŸ“‹ æ£€æŸ¥ä¸»nginx.confä¸­çš„é‡å®šå‘è§„åˆ™..."
            grep -n "301\|302\|redirect" /www/server/nginx/conf/nginx.conf || echo "ä¸»é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰é‡å®šå‘è§„åˆ™"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–serverå—å¤„ç†redamancy.com.cn
            echo "ğŸ“‹ æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–serverå—å¤„ç†redamancy.com.cn..."
            grep -r "server_name.*redamancy" /www/server/nginx/conf/ || echo "æ²¡æœ‰æ‰¾åˆ°å…¶ä»–redamancy serverå—"
            
            # æ£€æŸ¥å®å¡”é¢æ¿çš„é»˜è®¤é…ç½®
            echo "ğŸ“‹ æ£€æŸ¥å®å¡”é¢æ¿é»˜è®¤é…ç½®..."
            if [ -f "/www/server/panel/vhost/nginx/redamancy.com.cn.conf" ]; then
              echo "å‘ç°å®å¡”é¢æ¿é…ç½®æ–‡ä»¶:"
              cat /www/server/panel/vhost/nginx/redamancy.com.cn.conf
            else
              echo "æ²¡æœ‰æ‰¾åˆ°å®å¡”é¢æ¿é…ç½®æ–‡ä»¶"
            fi
            
            # æ£€æŸ¥æ‰€æœ‰includeçš„æ–‡ä»¶
            echo "ğŸ“‹ æ£€æŸ¥æ‰€æœ‰includeçš„æ–‡ä»¶..."
            grep -r "include.*\.conf" /www/server/nginx/conf/ | grep -v "route-" || echo "æ²¡æœ‰æ‰¾åˆ°å…¶ä»–includeæ–‡ä»¶"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–serverå—
            echo "ğŸ“‹ æ£€æŸ¥æ‰€æœ‰serverå—..."
            grep -r "server {" /www/server/nginx/conf/ | grep -v "route-" || echo "æ²¡æœ‰æ‰¾åˆ°å…¶ä»–serverå—"
            
            # æ£€æŸ¥ç½‘ç»œå±‚é¢
            echo "ğŸ“‹ æ£€æŸ¥ç½‘ç»œå±‚é¢..."
            echo "æ£€æŸ¥æ˜¯å¦æœ‰CDNæˆ–ä»£ç†:"
            curl -I -H "Host: redamancy.com.cn" http://127.0.0.1/ 2>/dev/null || echo "æœ¬åœ°è®¿é—®å¤±è´¥"
            
            # æ£€æŸ¥DNSè§£æ
            echo "ğŸ“‹ æ£€æŸ¥DNSè§£æ..."
            nslookup redamancy.com.cn || echo "DNSè§£æå¤±è´¥"
            
            # æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
            echo "ğŸ“‹ æ£€æŸ¥é˜²ç«å¢™è§„åˆ™..."
            iptables -L -n | grep -E "(80|443)" || echo "æ²¡æœ‰æ‰¾åˆ°ç›¸å…³é˜²ç«å¢™è§„åˆ™"
            
            # æ£€æŸ¥éƒ¨ç½²æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            echo "ğŸ“‹ æ£€æŸ¥éƒ¨ç½²æ–‡ä»¶..."
            if [ -f "/srv/apps/axi-star-cloud/front/index.html" ]; then
              echo "âœ… index.html å­˜åœ¨"
              ls -la /srv/apps/axi-star-cloud/front/index.html
            else
              echo "âŒ index.html ä¸å­˜åœ¨"
              echo "éƒ¨ç½²ç›®å½•å†…å®¹:"
              ls -la /srv/apps/axi-star-cloud/front/ || echo "ç›®å½•ä¸å­˜åœ¨"
            fi
            
            # æ£€æŸ¥nginxé…ç½®è¯­æ³•
            echo "ğŸ“‹ æ£€æŸ¥nginxé…ç½®è¯­æ³•..."
            nginx -t 2>&1 || echo "nginxé…ç½®è¯­æ³•é”™è¯¯"
            
            # æ£€æŸ¥nginxé”™è¯¯æ—¥å¿—
            echo "ğŸ“‹ æ£€æŸ¥nginxé”™è¯¯æ—¥å¿—..."
            tail -n 10 /var/log/nginx/error.log 2>/dev/null || echo "æ— æ³•è¯»å–é”™è¯¯æ—¥å¿—"
            
            # æ£€æŸ¥å½“å‰nginxé…ç½®
            echo "ğŸ“‹ æ£€æŸ¥å½“å‰nginxé…ç½®..."
            if [ -f "/www/server/nginx/conf/conf.d/redamancy/route-axi-star-cloud.conf" ]; then
              echo "route-axi-star-cloud.conf å†…å®¹:"
              cat /www/server/nginx/conf/conf.d/redamancy/route-axi-star-cloud.conf
            else
              echo "route-axi-star-cloud.conf ä¸å­˜åœ¨"
            fi
            
            # æµ‹è¯•æœ¬åœ°è®¿é—®
            echo "ğŸ“‹ æµ‹è¯•æœ¬åœ°è®¿é—®..."
            curl -I -H "Host: redamancy.com.cn" http://127.0.0.1/ 2>/dev/null || echo "æœ¬åœ°è®¿é—®å¤±è´¥"
            
            # æ£€æŸ¥nginxè¿›ç¨‹
            echo "ğŸ“‹ æ£€æŸ¥nginxè¿›ç¨‹..."
            ps aux | grep nginx | grep -v grep || echo "æ²¡æœ‰æ‰¾åˆ°nginxè¿›ç¨‹"
            
            if [ "$HTTPS_STATUS" = "200" ]; then
              echo "âœ… HTTPSç½‘ç«™å¯è®¿é—® (HTTP $HTTPS_STATUS)"
            elif [ "$HTTPS_STATUS" = "404" ]; then
              echo "âŒ HTTPSç½‘ç«™è¿”å›404 - éƒ¨ç½²å¤±è´¥"
              echo "å¯èƒ½çš„åŸå› :"
              echo "1. é¡¹ç›®æœªæ­£ç¡®éƒ¨ç½²"
              echo "2. Nginxé…ç½®é—®é¢˜"
              echo "3. æ–‡ä»¶è·¯å¾„é”™è¯¯"
              false
            else
              echo "âŒ HTTPSç½‘ç«™æ— æ³•è®¿é—® (HTTP $HTTPS_STATUS) - éƒ¨ç½²å¤±è´¥"
              echo "å¯èƒ½çš„åŸå› :"
              echo "1. åŸŸåè§£æé—®é¢˜"
              echo "2. æœåŠ¡å™¨é˜²ç«å¢™è®¾ç½®"
              echo "3. Nginxé…ç½®é—®é¢˜"
              echo "4. SSLè¯ä¹¦é—®é¢˜"
              echo "5. åç«¯æœåŠ¡æœªå¯åŠ¨"
              
              # æ˜¾ç¤ºç½‘ç«™æ ‡é¢˜
              TITLE=$(curl -s https://redamancy.com.cn/ | grep -o '<title>[^<]*</title>' | sed 's/<title>\(.*\)<\/title>/\1/')
              echo "ç½‘ç«™æ ‡é¢˜: $TITLE"
              
              # æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€
              echo "ğŸ” æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€..."
              if curl -f -s http://127.0.0.1:8080/health > /dev/null 2>&1; then
                echo "âœ… åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ"
              else
                echo "âŒ åç«¯æœåŠ¡æœªå¯åŠ¨æˆ–æ— æ³•è®¿é—®"
              fi
              
              # æ£€æŸ¥ Nginx çŠ¶æ€
              echo "ğŸ” æ£€æŸ¥ Nginx çŠ¶æ€..."
              if systemctl is-active --quiet nginx; then
                echo "âœ… Nginx æœåŠ¡æ­£å¸¸è¿è¡Œ"
              else
                echo "âŒ Nginx æœåŠ¡æœªè¿è¡Œ"
              fi
              
              false
            fi

      - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
        run: |
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          echo ""
          echo "ğŸ“‹ éƒ¨ç½²æ‘˜è¦:"
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- éƒ¨ç½²ç±»å‹: ${{ inputs.deploy_type }}"
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- æ„å»ºID: ${{ inputs.run_id }}"
          if [ "${{ inputs.test_url }}" != "" ]; then
            echo "- æµ‹è¯•URL: ${{ inputs.test_url }}"
          fi
          echo ""
          echo "âœ… é¡¹ç›®å·²æˆåŠŸéƒ¨ç½²åˆ°æœåŠ¡å™¨" 