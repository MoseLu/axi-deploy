name: Deploy Notification

description: "éƒ¨ç½²é€šçŸ¥ - å‘éƒ¨ç½²ä»ªè¡¨æ¿å‘é€éƒ¨ç½²ç»“æœé€šçŸ¥"

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
        description: "é¡¹ç›®åç§°"
      source_repo:
        required: true
        type: string
        description: "æºä»“åº“ (owner/repo)"
      run_id:
        required: true
        type: string
        description: "æ„å»ºè¿è¡ŒID"
      deploy_type:
        required: true
        type: string
        description: "éƒ¨ç½²ç±»å‹ (backend/static)"
        default: "static"
      server_host:
        required: true
        type: string
        description: "æœåŠ¡å™¨åœ°å€"
      server_port:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç«¯å£"
      deploy_success:
        required: true
        type: boolean
        description: "éƒ¨ç½²æ˜¯å¦æˆåŠŸ"
      deploy_path:
        required: false
        type: string
        description: "éƒ¨ç½²è·¯å¾„"
      backup_success:
        required: false
        type: boolean
        description: "å¤‡ä»½æ˜¯å¦æˆåŠŸ"
      backup_path:
        required: false
        type: string
        description: "å¤‡ä»½è·¯å¾„"

jobs:
  notification:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    steps:
      - name: é€šçŸ¥éƒ¨ç½²ä»ªè¡¨æ¿
        if: success()
        run: |
          echo "ğŸ“¢ é€šçŸ¥éƒ¨ç½²ä»ªè¡¨æ¿..."
          
          PROJECT="${{ inputs.project }}"
          SOURCE_REPO="${{ inputs.source_repo }}"
          RUN_ID="${{ inputs.run_id }}"
          DEPLOY_TYPE="${{ inputs.deploy_type }}"
          SERVER_HOST="${{ inputs.server_host }}"
          SERVER_PORT="${{ inputs.server_port }}"
          DEPLOY_SUCCESS="${{ inputs.deploy_success }}"
          DEPLOY_PATH="${{ inputs.deploy_path }}"
          BACKUP_SUCCESS="${{ inputs.backup_success }}"
          BACKUP_PATH="${{ inputs.backup_path }}"
          
          # è®¡ç®—éƒ¨ç½²æ—¶é—´
          DEPLOY_END_TIME=$(date +%s)
          DEPLOY_DURATION=$((DEPLOY_END_TIME - DEPLOY_START_TIME))
          
          echo "ğŸ“Š éƒ¨ç½²ç»Ÿè®¡:"
          echo "- é¡¹ç›®: $PROJECT"
          echo "- æºä»“åº“: $SOURCE_REPO"
          echo "- è¿è¡ŒID: $RUN_ID"
          echo "- éƒ¨ç½²ç±»å‹: $DEPLOY_TYPE"
          echo "- æœåŠ¡å™¨: $SERVER_HOST:$SERVER_PORT"
          echo "- éƒ¨ç½²æˆåŠŸ: $DEPLOY_SUCCESS"
          echo "- éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"
          echo "- å¤‡ä»½æˆåŠŸ: $BACKUP_SUCCESS"
          echo "- å¤‡ä»½è·¯å¾„: $BACKUP_PATH"
          echo "- éƒ¨ç½²è€—æ—¶: ${DEPLOY_DURATION}ç§’"
          
          # æ„å»ºé€šçŸ¥æ¶ˆæ¯
          if [ "$DEPLOY_SUCCESS" = "true" ]; then
            STATUS="âœ… æˆåŠŸ"
            EMOJI="ğŸ‰"
            COLOR="#28a745"
          else
            STATUS="âŒ å¤±è´¥"
            EMOJI="ğŸ’¥"
            COLOR="#dc3545"
          fi
          
          # æ„å»ºé€šçŸ¥æ•°æ®
          NOTIFICATION_DATA=$(cat <<EOF
          {
            "project": "$PROJECT",
            "source_repo": "$SOURCE_REPO",
            "run_id": "$RUN_ID",
            "deploy_type": "$DEPLOY_TYPE",
            "server_host": "$SERVER_HOST",
            "server_port": "$SERVER_PORT",
            "deploy_success": $DEPLOY_SUCCESS,
            "deploy_path": "$DEPLOY_PATH",
            "backup_success": $BACKUP_SUCCESS,
            "backup_path": "$BACKUP_PATH",
            "deploy_duration": $DEPLOY_DURATION,
            "status": "$STATUS",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "workflow_url": "https://github.com/$SOURCE_REPO/actions/runs/$RUN_ID"
          }
          EOF
          )
          
          echo "ğŸ“¤ å‘é€é€šçŸ¥æ•°æ®:"
          echo "$NOTIFICATION_DATA" | jq .
          
          # å°è¯•å‘é€åˆ°éƒ¨ç½²ä»ªè¡¨æ¿ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
          if [ -n "$DEPLOY_DASHBOARD_URL" ]; then
            echo "ğŸŒ å‘é€åˆ°éƒ¨ç½²ä»ªè¡¨æ¿: $DEPLOY_DASHBOARD_URL"
            curl -X POST "$DEPLOY_DASHBOARD_URL/api/deployments" \
              -H "Content-Type: application/json" \
              -d "$NOTIFICATION_DATA" \
              --max-time 10 \
              --silent \
              --show-error || echo "âš ï¸ å‘é€åˆ°éƒ¨ç½²ä»ªè¡¨æ¿å¤±è´¥"
          else
            echo "ğŸ“‹ æœªé…ç½®éƒ¨ç½²ä»ªè¡¨æ¿ URLï¼Œè·³è¿‡é€šçŸ¥"
          fi
          
          # è¾“å‡ºéƒ¨ç½²ç»“æœæ‘˜è¦
          echo ""
          echo "$EMOJI éƒ¨ç½²ç»“æœæ‘˜è¦ $EMOJI"
          echo "================================"
          echo "é¡¹ç›®: $PROJECT"
          echo "çŠ¶æ€: $STATUS"
          echo "ç±»å‹: $DEPLOY_TYPE"
          echo "æœåŠ¡å™¨: $SERVER_HOST:$SERVER_PORT"
          echo "è·¯å¾„: $DEPLOY_PATH"
          echo "è€—æ—¶: ${DEPLOY_DURATION}ç§’"
          if [ "$BACKUP_SUCCESS" = "true" ]; then
            echo "å¤‡ä»½: âœ… æˆåŠŸ ($BACKUP_PATH)"
          else
            echo "å¤‡ä»½: â­ï¸ è·³è¿‡"
          fi
          echo "================================"

      - name: é€šçŸ¥éƒ¨ç½²å¤±è´¥
        if: failure()
        run: |
          echo "ğŸ“¢ é€šçŸ¥éƒ¨ç½²å¤±è´¥..."
          
          PROJECT="${{ inputs.project }}"
          SOURCE_REPO="${{ inputs.source_repo }}"
          RUN_ID="${{ inputs.run_id }}"
          DEPLOY_TYPE="${{ inputs.deploy_type }}"
          SERVER_HOST="${{ inputs.server_host }}"
          SERVER_PORT="${{ inputs.server_port }}"
          
          # è®¡ç®—éƒ¨ç½²æ—¶é—´
          DEPLOY_END_TIME=$(date +%s)
          DEPLOY_DURATION=$((DEPLOY_END_TIME - DEPLOY_START_TIME))
          
          echo "ğŸ’¥ éƒ¨ç½²å¤±è´¥ç»Ÿè®¡:"
          echo "- é¡¹ç›®: $PROJECT"
          echo "- æºä»“åº“: $SOURCE_REPO"
          echo "- è¿è¡ŒID: $RUN_ID"
          echo "- éƒ¨ç½²ç±»å‹: $DEPLOY_TYPE"
          echo "- æœåŠ¡å™¨: $SERVER_HOST:$SERVER_PORT"
          echo "- éƒ¨ç½²è€—æ—¶: ${DEPLOY_DURATION}ç§’"
          
          # æ„å»ºå¤±è´¥é€šçŸ¥æ•°æ®
          FAILURE_DATA=$(cat <<EOF
          {
            "project": "$PROJECT",
            "source_repo": "$SOURCE_REPO",
            "run_id": "$RUN_ID",
            "deploy_type": "$DEPLOY_TYPE",
            "server_host": "$SERVER_HOST",
            "server_port": "$SERVER_PORT",
            "deploy_success": false,
            "deploy_duration": $DEPLOY_DURATION,
            "status": "âŒ å¤±è´¥",
            "error": "éƒ¨ç½²è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "workflow_url": "https://github.com/$SOURCE_REPO/actions/runs/$RUN_ID"
          }
          EOF
          )
          
          echo "ğŸ“¤ å‘é€å¤±è´¥é€šçŸ¥æ•°æ®:"
          echo "$FAILURE_DATA" | jq .
          
          # å°è¯•å‘é€åˆ°éƒ¨ç½²ä»ªè¡¨æ¿ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
          if [ -n "$DEPLOY_DASHBOARD_URL" ]; then
            echo "ğŸŒ å‘é€å¤±è´¥é€šçŸ¥åˆ°éƒ¨ç½²ä»ªè¡¨æ¿: $DEPLOY_DASHBOARD_URL"
            curl -X POST "$DEPLOY_DASHBOARD_URL/api/deployments" \
              -H "Content-Type: application/json" \
              -d "$FAILURE_DATA" \
              --max-time 10 \
              --silent \
              --show-error || echo "âš ï¸ å‘é€å¤±è´¥é€šçŸ¥åˆ°éƒ¨ç½²ä»ªè¡¨æ¿å¤±è´¥"
          else
            echo "ğŸ“‹ æœªé…ç½®éƒ¨ç½²ä»ªè¡¨æ¿ URLï¼Œè·³è¿‡å¤±è´¥é€šçŸ¥"
          fi
          
          # è¾“å‡ºå¤±è´¥æ‘˜è¦
          echo ""
          echo "ğŸ’¥ éƒ¨ç½²å¤±è´¥æ‘˜è¦ ğŸ’¥"
          echo "================================"
          echo "é¡¹ç›®: $PROJECT"
          echo "çŠ¶æ€: âŒ å¤±è´¥"
          echo "ç±»å‹: $DEPLOY_TYPE"
          echo "æœåŠ¡å™¨: $SERVER_HOST:$SERVER_PORT"
          echo "è€—æ—¶: ${DEPLOY_DURATION}ç§’"
          echo "å·¥ä½œæµ: https://github.com/$SOURCE_REPO/actions/runs/$RUN_ID"
          echo "================================"
