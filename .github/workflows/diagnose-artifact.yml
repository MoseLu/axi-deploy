name: Diagnose Artifact Download

description: "è¯Šæ–­æ„å»ºäº§ç‰©ä¸‹è½½é—®é¢˜"

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'é¡¹ç›®åç§°'
        required: true
        type: string
      source_repo:
        description: 'æºä»“åº“ (æ ¼å¼: owner/repo)'
        required: true
        type: string
      run_id:
        description: 'æ„å»ºè¿è¡ŒID'
        required: true
        type: string
      github_token:
        description: 'GitHub Token'
        required: true
        type: string

jobs:
  diagnose:
    runs-on: ubuntu-latest
    steps:
      - name: è¯Šæ–­æ„å»ºäº§ç‰©ä¸‹è½½é—®é¢˜
        run: |
          echo "ğŸ” è¯Šæ–­æ„å»ºäº§ç‰©ä¸‹è½½é—®é¢˜..."
          echo "=========================================="
          echo "ğŸ“‹ è¾“å…¥å‚æ•°:"
          echo "- é¡¹ç›®åç§°: ${{ inputs.project }}"
          echo "- æºä»“åº“: ${{ inputs.source_repo }}"
          echo "- è¿è¡ŒID: ${{ inputs.run_id }}"
          echo "- GitHub Token: ${{ inputs.github_token != '' && 'å·²æä¾›' || 'æœªæä¾›' }}"
          echo "- æœŸæœ›çš„æ„å»ºäº§ç‰©åç§°: dist-${{ inputs.project }}"
          echo ""
          
          # è§£ææºä»“åº“ä¿¡æ¯
          REPO_OWNER=$(echo "${{ inputs.source_repo }}" | cut -d'/' -f1)
          REPO_NAME=$(echo "${{ inputs.source_repo }}" | cut -d'/' -f2)
          
          echo "ğŸ“‹ è§£æçš„ä»“åº“ä¿¡æ¯:"
          echo "- ä»“åº“æ‰€æœ‰è€…: $REPO_OWNER"
          echo "- ä»“åº“åç§°: $REPO_NAME"
          echo ""
          
          # æ£€æŸ¥GitHub Tokenæƒé™
          echo "ğŸ” æ£€æŸ¥GitHub Tokenæƒé™..."
          if [ -n "${{ inputs.github_token }}" ]; then
            echo "âœ… GitHub Tokenå·²æä¾›"
            # è¿™é‡Œå¯ä»¥æ·»åŠ Tokenæƒé™éªŒè¯
          else
            echo "âŒ GitHub Tokenæœªæä¾›"
          fi
          echo ""
          
          # æ£€æŸ¥æ„å»ºäº§ç‰©åç§°æ ¼å¼
          echo "ğŸ” æ£€æŸ¥æ„å»ºäº§ç‰©åç§°æ ¼å¼..."
          EXPECTED_ARTIFACT="dist-${{ inputs.project }}"
          echo "- æœŸæœ›çš„æ„å»ºäº§ç‰©åç§°: $EXPECTED_ARTIFACT"
          echo ""
          
          # æä¾›å¸¸è§é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ
          echo "ğŸ”§ å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ:"
          echo ""
          echo "1. æ„å»ºäº§ç‰©åç§°ä¸åŒ¹é…:"
          echo "   - æ£€æŸ¥æºä»“åº“çš„æ„å»ºå·¥ä½œæµä¸­upload-artifactçš„nameå‚æ•°"
          echo "   - ç¡®ä¿nameå‚æ•°ä¸º 'dist-${{ inputs.project }}'"
          echo ""
          echo "2. æ„å»ºäº§ç‰©å·²è¿‡æœŸ:"
          echo "   - æ£€æŸ¥æºä»“åº“æ„å»ºå·¥ä½œæµä¸­çš„retention-dayså‚æ•°"
          echo "   - é»˜è®¤ä¿ç•™æœŸä¸º1å¤©ï¼Œå»ºè®®è®¾ç½®ä¸º7å¤©æˆ–æ›´é•¿"
          echo ""
          echo "3. æºä»“åº“æˆ–è¿è¡ŒIDé”™è¯¯:"
          echo "   - ç¡®è®¤æºä»“åº“åç§°æ ¼å¼ä¸º 'owner/repo'"
          echo "   - ç¡®è®¤è¿è¡ŒIDæ˜¯æœ‰æ•ˆçš„æ•°å­—"
          echo "   - æ£€æŸ¥æºä»“åº“çš„æ„å»ºæ˜¯å¦æˆåŠŸå®Œæˆ"
          echo ""
          echo "4. GitHub Tokenæƒé™ä¸è¶³:"
          echo "   - ç¡®ä¿Tokenæœ‰è¶³å¤Ÿçš„æƒé™è®¿é—®æºä»“åº“"
          echo "   - æ£€æŸ¥Tokenæ˜¯å¦å·²è¿‡æœŸ"
          echo ""
          echo "5. æ„å»ºäº§ç‰©ä¸Šä¼ å¤±è´¥:"
          echo "   - æ£€æŸ¥æºä»“åº“çš„æ„å»ºæ—¥å¿—"
          echo "   - ç¡®è®¤æ„å»ºäº§ç‰©ç›®å½•å­˜åœ¨ä¸”ä¸ä¸ºç©º"
          echo ""
          echo "=========================================="
          echo "ğŸ’¡ å»ºè®®æ“ä½œ:"
          echo "1. é‡æ–°è§¦å‘æºä»“åº“çš„æ„å»º"
          echo "2. æ£€æŸ¥æºä»“åº“çš„æ„å»ºæ—¥å¿—"
          echo "3. éªŒè¯æ„å»ºäº§ç‰©åç§°å’Œè·¯å¾„"
          echo "4. ç¡®è®¤GitHub Tokenæƒé™"
          echo "=========================================="

      - name: å°è¯•ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: dist-${{ inputs.project }}
          path: ./
          github-token: ${{ inputs.github_token }}
          repository: ${{ inputs.source_repo }}
          run-id: ${{ inputs.run_id }}
        continue-on-error: true

      - name: åˆ†æä¸‹è½½ç»“æœ
        run: |
          echo "ğŸ” åˆ†æä¸‹è½½ç»“æœ..."
          if [ ${{ steps.download-artifact.outcome }} == 'success' ]; then
            echo "âœ… æ„å»ºäº§ç‰©ä¸‹è½½æˆåŠŸ"
            echo "ğŸ“ ä¸‹è½½çš„æ–‡ä»¶:"
            ls -la ./
            echo ""
            echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
            find . -type f | wc -l
            echo ""
            echo "ğŸ“ ç›®å½•ç»“æ„:"
            find . -type d
          else
            echo "âŒ æ„å»ºäº§ç‰©ä¸‹è½½å¤±è´¥"
            echo "ğŸ” å½“å‰ç›®å½•å†…å®¹:"
            ls -la ./
            echo ""
            echo "ğŸ’¡ å»ºè®®:"
            echo "1. æ£€æŸ¥æ„å»ºäº§ç‰©æ˜¯å¦å·²è¿‡æœŸ"
            echo "2. ç¡®è®¤æ„å»ºäº§ç‰©åç§°æ˜¯å¦æ­£ç¡®"
            echo "3. éªŒè¯GitHub Tokenæƒé™"
            echo "4. é‡æ–°è§¦å‘æºä»“åº“çš„æ„å»º"
          fi
