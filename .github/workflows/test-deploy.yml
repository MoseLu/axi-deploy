name: Test Deployment

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'é¡¹ç›®åç§°'
        required: true
        type: string
        default: 'axi-docs'
      deploy_path:
        description: 'éƒ¨ç½²è·¯å¾„'
        required: true
        type: string
        default: '/www/wwwroot/axi-docs'
      test_url:
        description: 'æµ‹è¯•URL'
        required: false
        type: string
        default: 'https://docs.axiom.top'

jobs:
  test-deployment:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€æŸ¥æœåŠ¡å™¨éƒ¨ç½²çŠ¶æ€
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            echo "ğŸ” æ£€æŸ¥éƒ¨ç½²çŠ¶æ€..."
            echo "é¡¹ç›®: ${{ github.event.inputs.project }}"
            echo "éƒ¨ç½²è·¯å¾„: ${{ github.event.inputs.deploy_path }}"
            echo "æ£€æŸ¥æ—¶é—´: $(date)"
            echo ""
            
            # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
            if [ -d "${{ github.event.inputs.deploy_path }}" ]; then
              echo "âœ… éƒ¨ç½²ç›®å½•å­˜åœ¨"
              echo "ğŸ“ ç›®å½•å†…å®¹:"
              ls -la "${{ github.event.inputs.deploy_path }}"
              echo ""
              
              # æ£€æŸ¥å…³é”®æ–‡ä»¶
              echo "ğŸ”‘ å…³é”®æ–‡ä»¶æ£€æŸ¥:"
              if [ -f "${{ github.event.inputs.deploy_path }}/index.html" ]; then
                echo "âœ… index.html å­˜åœ¨"
                echo "   å¤§å°: $(du -h "${{ github.event.inputs.deploy_path }}/index.html" | cut -f1)"
                echo "   ä¿®æ”¹æ—¶é—´: $(stat -c %y "${{ github.event.inputs.deploy_path }}/index.html")"
              else
                echo "âŒ index.html ä¸å­˜åœ¨"
              fi
              
              if [ -d "${{ github.event.inputs.deploy_path }}/assets" ]; then
                echo "âœ… assets ç›®å½•å­˜åœ¨"
                echo "   æ–‡ä»¶æ•°é‡: $(find "${{ github.event.inputs.deploy_path }}/assets" -type f | wc -l)"
              else
                echo "âŒ assets ç›®å½•ä¸å­˜åœ¨"
              fi
              
              echo ""
              
              # æ£€æŸ¥ Nginx é…ç½®
              echo "ğŸŒ Nginx é…ç½®æ£€æŸ¥:"
              if command -v nginx &> /dev/null; then
                echo "âœ… Nginx å·²å®‰è£…"
                nginx -t 2>&1 | head -5
              else
                echo "âŒ Nginx æœªå®‰è£…"
              fi
              
              echo ""
              
              # æ£€æŸ¥ç«¯å£ç›‘å¬
              echo "ğŸ”Œ ç«¯å£ç›‘å¬æ£€æŸ¥:"
              netstat -tlnp | grep :80 || echo "âŒ 80ç«¯å£æœªç›‘å¬"
              
            else
              echo "âŒ éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨: ${{ github.event.inputs.deploy_path }}"
            fi

      - name: æµ‹è¯•ç½‘ç«™å¯è®¿é—®æ€§
        if: ${{ github.event.inputs.test_url != '' }}
        run: |
          echo "ğŸŒ æµ‹è¯•ç½‘ç«™å¯è®¿é—®æ€§..."
          echo "æµ‹è¯•URL: ${{ github.event.inputs.test_url }}"
          
          # ä½¿ç”¨curlæµ‹è¯•ç½‘ç«™å“åº”
          response=$(curl -s -o /dev/null -w "%{http_code}" "${{ github.event.inputs.test_url }}" || echo "000")
          
          if [ "$response" = "200" ]; then
            echo "âœ… ç½‘ç«™å¯æ­£å¸¸è®¿é—® (HTTP $response)"
          else
            echo "âŒ ç½‘ç«™æ— æ³•è®¿é—® (HTTP $response)"
            echo "å¯èƒ½çš„åŸå› :"
            echo "1. åŸŸåè§£æé—®é¢˜"
            echo "2. æœåŠ¡å™¨é˜²ç«å¢™è®¾ç½®"
            echo "3. Nginxé…ç½®é—®é¢˜"
            echo "4. SSLè¯ä¹¦é—®é¢˜"
          fi
          
          # è·å–ç½‘ç«™æ ‡é¢˜
          title=$(curl -s "${{ github.event.inputs.test_url }}" | grep -o '<title>[^<]*</title>' | sed 's/<title>\(.*\)<\/title>/\1/' || echo "æ— æ³•è·å–æ ‡é¢˜")
          echo "ç½‘ç«™æ ‡é¢˜: $title"

      - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        run: |
          echo "ğŸ“Š éƒ¨ç½²æµ‹è¯•æŠ¥å‘Š"
          echo "=================="
          echo "æµ‹è¯•æ—¶é—´: $(date)"
          echo "é¡¹ç›®åç§°: ${{ github.event.inputs.project }}"
          echo "éƒ¨ç½²è·¯å¾„: ${{ github.event.inputs.deploy_path }}"
          echo "æµ‹è¯•URL: ${{ github.event.inputs.test_url }}"
          echo ""
          echo "âœ… æµ‹è¯•å®Œæˆï¼"
          echo "å¦‚æœçœ‹åˆ°æ­¤æ¶ˆæ¯ï¼Œè¯´æ˜æµ‹è¯•æµç¨‹æ­£å¸¸è¿è¡Œ" 