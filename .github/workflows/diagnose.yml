name: Diagnose

description: "è¯Šæ–­å·¥ä½œæµ - è¯Šæ–­éƒ¨ç½²é—®é¢˜"

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'é¡¹ç›®åç§°'
        required: false
        type: string
      diagnose_type:
        description: 'è¯Šæ–­ç±»å‹'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - network
          - nginx
          - service
          - deployment
          - system
      server_host:
        description: 'æœåŠ¡å™¨åœ°å€'
        required: false
        type: string
      server_user:
        description: 'æœåŠ¡å™¨ç”¨æˆ·'
        required: false
        type: string
      server_key:
        description: 'æœåŠ¡å™¨å¯†é’¥'
        required: false
        type: string
      server_port:
        description: 'æœåŠ¡å™¨ç«¯å£'
        required: false
        default: '22'
        type: string

jobs:
  diagnose:
    runs-on: ubuntu-latest
    steps:
      - name: è§£ææœåŠ¡å™¨é…ç½®
        id: parse-config
        run: |
          echo "ğŸ” è§£ææœåŠ¡å™¨é…ç½®..."
          
          # ä»è¾“å…¥å‚æ•°æˆ–ç¯å¢ƒå˜é‡è·å–é…ç½®
          SERVER_HOST="${{ inputs.server_host || secrets.SERVER_HOST }}"
          SERVER_USER="${{ inputs.server_user || secrets.SERVER_USER }}"
          SERVER_KEY="${{ inputs.server_key || secrets.SERVER_KEY }}"
          SERVER_PORT="${{ inputs.server_port || secrets.SERVER_PORT || '22' }}"
          
          if [ -z "$SERVER_HOST" ] || [ -z "$SERVER_USER" ] || [ -z "$SERVER_KEY" ]; then
            echo "ğŸš¨ ç¼ºå°‘æœåŠ¡å™¨é…ç½®ä¿¡æ¯"
            exit 1
          fi
          
          echo "âœ… æœåŠ¡å™¨é…ç½®è§£æå®Œæˆ"

      - name: ç³»ç»Ÿè¯Šæ–­
        if: ${{ inputs.diagnose_type == 'all' || inputs.diagnose_type == 'system' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.parse-config.outputs.server_host || env.SERVER_HOST }}
          username: ${{ steps.parse-config.outputs.server_user || env.SERVER_USER }}
          key: ${{ steps.parse-config.outputs.server_key || env.SERVER_KEY }}
          port: ${{ steps.parse-config.outputs.server_port || env.SERVER_PORT }}
          script: |
            echo "ğŸ” ç³»ç»Ÿè¯Šæ–­..."
            
            # 1. ç³»ç»ŸåŸºæœ¬ä¿¡æ¯
            echo "ğŸ“Š ç³»ç»ŸåŸºæœ¬ä¿¡æ¯:"
            echo "- æ“ä½œç³»ç»Ÿ: $(uname -a)"
            echo "- å†…æ ¸ç‰ˆæœ¬: $(uname -r)"
            echo "- ç³»ç»Ÿè´Ÿè½½: $(uptime)"
            echo "- è¿è¡Œæ—¶é—´: $(uptime -p)"
            
            # 2. èµ„æºä½¿ç”¨æƒ…å†µ
            echo "ğŸ’¾ èµ„æºä½¿ç”¨æƒ…å†µ:"
            echo "- å†…å­˜ä½¿ç”¨:"
            free -h
            echo "- ç£ç›˜ä½¿ç”¨:"
            df -h
            echo "- è¿›ç¨‹æ•°é‡: $(ps aux | wc -l)"
            
            # 3. ç³»ç»ŸæœåŠ¡çŠ¶æ€
            echo "ğŸ”§ ç³»ç»ŸæœåŠ¡çŠ¶æ€:"
            echo "- SSHæœåŠ¡: $(systemctl is-active sshd)"
            echo "- NginxæœåŠ¡: $(systemctl is-active nginx)"
            echo "- é˜²ç«å¢™çŠ¶æ€: $(systemctl is-active firewalld 2>/dev/null || echo 'æœªå®‰è£…')"
            
            # 4. ç³»ç»Ÿæ—¥å¿—æ£€æŸ¥
            echo "ğŸ“ ç³»ç»Ÿæ—¥å¿—æ£€æŸ¥:"
            echo "- æœ€è¿‘çš„ç³»ç»Ÿé”™è¯¯:"
            journalctl -p err --since "1 hour ago" | tail -5 || echo "æ— é”™è¯¯æ—¥å¿—"
            
            # 5. è¿›ç¨‹æ£€æŸ¥
            echo "ğŸ”„ å…³é”®è¿›ç¨‹æ£€æŸ¥:"
            echo "- Nginxè¿›ç¨‹:"
            ps aux | grep nginx | grep -v grep || echo "æœªæ‰¾åˆ°Nginxè¿›ç¨‹"
            echo "- å…¶ä»–å…³é”®è¿›ç¨‹:"
            ps aux | grep -E "(sshd|systemd)" | head -5

      - name: ç½‘ç»œè¯Šæ–­
        if: ${{ inputs.diagnose_type == 'all' || inputs.diagnose_type == 'network' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.parse-config.outputs.server_host || env.SERVER_HOST }}
          username: ${{ steps.parse-config.outputs.server_user || env.SERVER_USER }}
          key: ${{ steps.parse-config.outputs.server_key || env.SERVER_KEY }}
          port: ${{ steps.parse-config.outputs.server_port || env.SERVER_PORT }}
          script: |
            echo "ğŸ” ç½‘ç»œè¯Šæ–­..."
            
            # 1. ç½‘ç»œæ¥å£çŠ¶æ€
            echo "ğŸŒ ç½‘ç»œæ¥å£çŠ¶æ€:"
            ip addr show | grep -E "inet|UP|DOWN" | head -10
            
            # 2. ç½‘ç»œè¿æ¥æµ‹è¯•
            echo "ğŸ”— ç½‘ç»œè¿æ¥æµ‹è¯•:"
            echo "- æœ¬åœ°å›ç¯: $(ping -c 1 127.0.0.1 > /dev/null 2>&1 && echo 'æ­£å¸¸' || echo 'å¼‚å¸¸')"
            echo "- å¤–ç½‘è¿æ¥: $(ping -c 1 8.8.8.8 > /dev/null 2>&1 && echo 'æ­£å¸¸' || echo 'å¼‚å¸¸')"
            echo "- DNSè§£æ: $(nslookup google.com > /dev/null 2>&1 && echo 'æ­£å¸¸' || echo 'å¼‚å¸¸')"
            
            # 3. ç«¯å£ç›‘å¬çŠ¶æ€
            echo "ğŸ”Œ ç«¯å£ç›‘å¬çŠ¶æ€:"
            echo "- HTTPç«¯å£(80): $(netstat -tlnp | grep ':80 ' && echo 'æ­£å¸¸' || echo 'æœªç›‘å¬')"
            echo "- HTTPSç«¯å£(443): $(netstat -tlnp | grep ':443 ' && echo 'æ­£å¸¸' || echo 'æœªç›‘å¬')"
            echo "- SSHç«¯å£(22): $(netstat -tlnp | grep ':22 ' && echo 'æ­£å¸¸' || echo 'æœªç›‘å¬')"
            echo "- åç«¯ç«¯å£(8080): $(netstat -tlnp | grep ':8080 ' && echo 'æ­£å¸¸' || echo 'æœªç›‘å¬')"
            
            # 4. é˜²ç«å¢™è§„åˆ™
            echo "ğŸ”¥ é˜²ç«å¢™è§„åˆ™:"
            if command -v firewall-cmd &> /dev/null; then
              echo "- é˜²ç«å¢™çŠ¶æ€: $(firewall-cmd --state)"
              echo "- å¼€æ”¾ç«¯å£: $(firewall-cmd --list-ports)"
              echo "- å¼€æ”¾æœåŠ¡: $(firewall-cmd --list-services)"
            else
              echo "- é˜²ç«å¢™: æœªå®‰è£…firewalld"
            fi

      - name: Nginxè¯Šæ–­
        if: ${{ inputs.diagnose_type == 'all' || inputs.diagnose_type == 'nginx' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.parse-config.outputs.server_host || env.SERVER_HOST }}
          username: ${{ steps.parse-config.outputs.server_user || env.SERVER_USER }}
          key: ${{ steps.parse-config.outputs.server_key || env.SERVER_KEY }}
          port: ${{ steps.parse-config.outputs.server_port || env.SERVER_PORT }}
          script: |
            echo "ğŸ” Nginxè¯Šæ–­..."
            
            # 1. Nginxè¿›ç¨‹çŠ¶æ€
            echo "ğŸ“Š Nginxè¿›ç¨‹çŠ¶æ€:"
            if pgrep nginx > /dev/null; then
              echo "âœ… Nginxè¿›ç¨‹æ­£åœ¨è¿è¡Œ"
              NGINX_PIDS=$(pgrep nginx)
              echo "Nginxè¿›ç¨‹ID: $NGINX_PIDS"
            else
              echo "âŒ Nginxè¿›ç¨‹æœªè¿è¡Œ"
            fi
            
            # 2. Nginxé…ç½®æ£€æŸ¥
            echo "ğŸ“‹ Nginxé…ç½®æ£€æŸ¥:"
            if nginx -t > /dev/null 2>&1; then
              echo "âœ… Nginxé…ç½®è¯­æ³•æ­£ç¡®"
            else
              echo "âŒ Nginxé…ç½®è¯­æ³•é”™è¯¯:"
              nginx -t
            fi
            
            # 3. Nginxé…ç½®æ–‡ä»¶
            echo "ğŸ“ Nginxé…ç½®æ–‡ä»¶:"
            echo "- ä¸»é…ç½®æ–‡ä»¶: /etc/nginx/nginx.conf"
            if [ -f "/etc/nginx/nginx.conf" ]; then
              echo "  âœ… ä¸»é…ç½®æ–‡ä»¶å­˜åœ¨"
            else
              echo "  âŒ ä¸»é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
            fi
            
            echo "- ç«™ç‚¹é…ç½®ç›®å½•: /www/server/nginx/conf/conf.d/redamancy"
            if [ -d "/www/server/nginx/conf/conf.d/redamancy" ]; then
              echo "  âœ… ç«™ç‚¹é…ç½®ç›®å½•å­˜åœ¨"
              echo "  ğŸ“‹ é…ç½®æ–‡ä»¶åˆ—è¡¨:"
              ls -la /www/server/nginx/conf/conf.d/redamancy/ | head -10
            else
              echo "  âŒ ç«™ç‚¹é…ç½®ç›®å½•ä¸å­˜åœ¨"
            fi
            
            # 4. Nginxæ—¥å¿—æ£€æŸ¥
            echo "ğŸ“ Nginxæ—¥å¿—æ£€æŸ¥:"
            if [ -f "/var/log/nginx/error.log" ]; then
              echo "âœ… é”™è¯¯æ—¥å¿—æ–‡ä»¶å­˜åœ¨"
              echo "æœ€è¿‘çš„é”™è¯¯æ—¥å¿—:"
              tail -n 10 /var/log/nginx/error.log
            else
              echo "âŒ é”™è¯¯æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
            fi
            
            if [ -f "/var/log/nginx/access.log" ]; then
              echo "âœ… è®¿é—®æ—¥å¿—æ–‡ä»¶å­˜åœ¨"
              echo "æœ€è¿‘çš„è®¿é—®æ—¥å¿—:"
              tail -n 5 /var/log/nginx/access.log
            else
              echo "âŒ è®¿é—®æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
            fi

      - name: æœåŠ¡è¯Šæ–­
        if: ${{ inputs.diagnose_type == 'all' || inputs.diagnose_type == 'service' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.parse-config.outputs.server_host || env.SERVER_HOST }}
          username: ${{ steps.parse-config.outputs.server_user || env.SERVER_USER }}
          key: ${{ steps.parse-config.outputs.server_key || env.SERVER_KEY }}
          port: ${{ steps.parse-config.outputs.server_port || env.SERVER_PORT }}
          script: |
            echo "ğŸ” æœåŠ¡è¯Šæ–­..."
            
            # 1. åç«¯æœåŠ¡çŠ¶æ€
            echo "ğŸ”§ åç«¯æœåŠ¡çŠ¶æ€:"
            if systemctl is-active --quiet star-cloud.service; then
              echo "âœ… star-cloudæœåŠ¡æ­£å¸¸è¿è¡Œ"
              echo "æœåŠ¡çŠ¶æ€è¯¦æƒ…:"
              systemctl status star-cloud.service --no-pager -l
            else
              echo "âŒ star-cloudæœåŠ¡å¼‚å¸¸"
              echo "æœåŠ¡çŠ¶æ€è¯¦æƒ…:"
              systemctl status star-cloud.service --no-pager -l
            fi
            
            # 2. æœåŠ¡æ—¥å¿—æ£€æŸ¥
            echo "ğŸ“ æœåŠ¡æ—¥å¿—æ£€æŸ¥:"
            if [ -f "/var/log/systemd/star-cloud.service.log" ]; then
              echo "âœ… æœåŠ¡æ—¥å¿—æ–‡ä»¶å­˜åœ¨"
              echo "æœ€è¿‘çš„æœåŠ¡æ—¥å¿—:"
              tail -n 10 /var/log/systemd/star-cloud.service.log
            else
              echo "âš ï¸ æœåŠ¡æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨journalctl:"
              journalctl -u star-cloud.service --no-pager -n 10
            fi
            
            # 3. ç«¯å£æ£€æŸ¥
            echo "ğŸ”Œ ç«¯å£æ£€æŸ¥:"
            echo "- 8080ç«¯å£: $(netstat -tlnp | grep ':8080 ' && echo 'æ­£å¸¸' || echo 'æœªç›‘å¬')"
            echo "- 8080ç«¯å£è¿›ç¨‹: $(lsof -i :8080 2>/dev/null || echo 'æ— è¿›ç¨‹ç›‘å¬')"
            
            # 4. è¿›ç¨‹æ£€æŸ¥
            echo "ğŸ”„ è¿›ç¨‹æ£€æŸ¥:"
            echo "- star-cloudè¿›ç¨‹:"
            ps aux | grep star-cloud | grep -v grep || echo "æœªæ‰¾åˆ°star-cloudè¿›ç¨‹"

      - name: éƒ¨ç½²è¯Šæ–­
        if: ${{ inputs.diagnose_type == 'all' || inputs.diagnose_type == 'deployment' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.parse-config.outputs.server_host || env.SERVER_HOST }}
          username: ${{ steps.parse-config.outputs.server_user || env.SERVER_USER }}
          key: ${{ steps.parse-config.outputs.server_key || env.SERVER_KEY }}
          port: ${{ steps.parse-config.outputs.server_port || env.SERVER_PORT }}
          script: |
            echo "ğŸ” éƒ¨ç½²è¯Šæ–­..."
            
            PROJECT="${{ inputs.project }}"
            
            # 1. éƒ¨ç½²ç›®å½•æ£€æŸ¥
            echo "ğŸ“ éƒ¨ç½²ç›®å½•æ£€æŸ¥:"
            
            # æ£€æŸ¥é™æ€é¡¹ç›®
            STATIC_ROOT="/srv/static"
            if [ -d "$STATIC_ROOT" ]; then
              echo "ğŸ“‚ é™æ€é¡¹ç›®ç›®å½•: $STATIC_ROOT"
              for project in "$STATIC_ROOT"/*; do
                if [ -d "$project" ]; then
                  PROJECT_NAME=$(basename "$project")
                  FILE_COUNT=$(find "$project" -type f | wc -l)
                  if [ "$FILE_COUNT" -gt 0 ]; then
                    echo "  âœ… $PROJECT_NAME: $FILE_COUNT ä¸ªæ–‡ä»¶"
                    if [ -f "$project/index.html" ]; then
                      echo "    âœ… index.html å­˜åœ¨"
                    else
                      echo "    âš ï¸ index.html ä¸å­˜åœ¨"
                    fi
                  else
                    echo "  âš ï¸ $PROJECT_NAME: ç›®å½•ä¸ºç©º"
                  fi
                fi
              done
            else
              echo "âš ï¸ é™æ€é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $STATIC_ROOT"
            fi
            
            # æ£€æŸ¥åç«¯é¡¹ç›®
            APPS_ROOT="/srv/apps"
            if [ -d "$APPS_ROOT" ]; then
              echo "ğŸ“‚ åç«¯é¡¹ç›®ç›®å½•: $APPS_ROOT"
              for project in "$APPS_ROOT"/*; do
                if [ -d "$project" ]; then
                  PROJECT_NAME=$(basename "$project")
                  FILE_COUNT=$(find "$project" -type f | wc -l)
                  if [ "$FILE_COUNT" -gt 0 ]; then
                    echo "  âœ… $PROJECT_NAME: $FILE_COUNT ä¸ªæ–‡ä»¶"
                    if [ -f "$project/star-cloud-linux" ]; then
                      echo "    âœ… äºŒè¿›åˆ¶æ–‡ä»¶å­˜åœ¨"
                    else
                      echo "    âš ï¸ äºŒè¿›åˆ¶æ–‡ä»¶ä¸å­˜åœ¨"
                    fi
                  else
                    echo "  âš ï¸ $PROJECT_NAME: ç›®å½•ä¸ºç©º"
                  fi
                fi
              done
            else
              echo "âš ï¸ åç«¯é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $APPS_ROOT"
            fi
            
            # 2. å¤‡ä»½æ£€æŸ¥
            echo "ğŸ“¦ å¤‡ä»½æ£€æŸ¥:"
            BACKUP_ROOTS=("/srv/backups/apps" "/srv/backups/static")
            for backup_root in "${BACKUP_ROOTS[@]}"; do
              if [ -d "$backup_root" ]; then
                echo "ğŸ“‚ å¤‡ä»½ç›®å½•: $backup_root"
                BACKUP_COUNT=$(find "$backup_root" -type d -name "*.backup.*" | wc -l)
                echo "  ğŸ“Š å¤‡ä»½æ•°é‡: $BACKUP_COUNT"
                if [ "$BACKUP_COUNT" -gt 0 ]; then
                  echo "  ğŸ“‹ æœ€æ–°å¤‡ä»½:"
                  find "$backup_root" -type d -name "*.backup.*" -printf "%T@ %p\n" | sort -n | tail -3 | while read timestamp path; do
                    BACKUP_NAME=$(basename "$path")
                    BACKUP_TIME=$(stat -c %y "$path" | cut -d' ' -f1,2)
                    BACKUP_SIZE=$(du -sh "$path" | cut -f1)
                    echo "    ğŸ“¦ $BACKUP_NAME ($BACKUP_TIME, $BACKUP_SIZE)"
                  done
                fi
              else
                echo "âš ï¸ å¤‡ä»½ç›®å½•ä¸å­˜åœ¨: $backup_root"
              fi
            done

      - name: ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
        run: |
          echo "ğŸ“Š è¯Šæ–­æŠ¥å‘Š"
          echo "============"
          echo "è¯Šæ–­æ—¶é—´: $(date)"
          echo "è¯Šæ–­ç±»å‹: ${{ inputs.diagnose_type || 'all' }}"
          echo "é¡¹ç›®åç§°: ${{ inputs.project || 'æ‰€æœ‰é¡¹ç›®' }}"
          echo "è¯Šæ–­ç»“æœ: å®Œæˆ"
          echo ""
          echo "âœ… è¯Šæ–­å·²å®Œæˆï¼Œè¯·æŸ¥çœ‹ä¸Šè¿°æ—¥å¿—äº†è§£è¯¦ç»†ä¿¡æ¯"

  notify-diagnose:
    needs: diagnose
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: è¯Šæ–­é€šçŸ¥
        run: |
          echo "ğŸ“¢ è¯Šæ–­é€šçŸ¥"
          echo "============"
          echo "è¯Šæ–­æ—¶é—´: $(date)"
          echo "è¯Šæ–­ç±»å‹: ${{ inputs.diagnose_type || 'all' }}"
          echo "é¡¹ç›®åç§°: ${{ inputs.project || 'æ‰€æœ‰é¡¹ç›®' }}"
          
          if [ "${{ needs.diagnose.result }}" = "success" ]; then
            echo "âœ… è¯Šæ–­å®Œæˆ"
          else
            echo "âŒ è¯Šæ–­å¤±è´¥"
          fi
