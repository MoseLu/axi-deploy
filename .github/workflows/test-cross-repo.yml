name: Test Cross-Repository Access

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: 测试跨仓库访问
        uses: actions/github-script@v7
        with:
          script: |
            try {
              console.log('🔍 测试跨仓库访问权限...');
              
              // 测试1: 获取当前仓库信息
              const currentRepo = await github.rest.repos.get({
                owner: 'MoseLu',
                repo: 'axi-deploy'
              });
              console.log('✅ 当前仓库访问正常:', currentRepo.data.full_name);
              
              // 测试2: 获取目标仓库信息
              const targetRepo = await github.rest.repos.get({
                owner: 'MoseLu',
                repo: 'axi-docs'
              });
              console.log('✅ 目标仓库访问正常:', targetRepo.data.full_name);
              
              // 测试3: 获取工作流信息
              const workflow = await github.rest.actions.getWorkflow({
                owner: 'MoseLu',
                repo: 'axi-deploy',
                workflow_id: 'deploy.yml'
              });
              console.log('✅ 工作流访问正常:', workflow.data.name);
              
              // 测试4: 尝试触发工作流（模拟）
              console.log('🔄 尝试触发工作流...');
              const dispatch = await github.rest.actions.createWorkflowDispatch({
                owner: 'MoseLu',
                repo: 'axi-deploy',
                workflow_id: 'deploy.yml',
                ref: 'master',
                inputs: {
                  project: 'test',
                  lang: 'test',
                  artifact_id: '0',
                  deploy_path: '/test',
                  start_cmd: 'echo test',
                  caller_repo: 'MoseLu/axi-docs',
                  caller_branch: 'main',
                  caller_commit: 'test'
                }
              });
              console.log('✅ 工作流触发成功:', dispatch.status);
              
            } catch (error) {
              console.error('❌ 权限测试失败:', error.message);
              console.error('错误状态码:', error.status);
              console.error('错误详情:', error);
              
              if (error.status === 403) {
                console.log('💡 建议解决方案:');
                console.log('1. 检查axi-deploy仓库设置 → Actions → General');
                console.log('2. 确保"Allow GitHub Actions to create and approve pull requests"已启用');
                console.log('3. 确保"Allow access to repositories in the MoseLu organization"已启用');
                console.log('4. 考虑使用Personal Access Token');
              }
            } 