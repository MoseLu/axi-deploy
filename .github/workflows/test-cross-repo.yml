name: Test Cross-Repository Access

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: æµ‹è¯•è·¨ä»“åº“è®¿é—®
        uses: actions/github-script@v7
        with:
          script: |
            try {
              console.log('ğŸ” æµ‹è¯•è·¨ä»“åº“è®¿é—®æƒé™...');
              
              // æµ‹è¯•1: è·å–å½“å‰ä»“åº“ä¿¡æ¯
              const currentRepo = await github.rest.repos.get({
                owner: 'MoseLu',
                repo: 'axi-deploy'
              });
              console.log('âœ… å½“å‰ä»“åº“è®¿é—®æ­£å¸¸:', currentRepo.data.full_name);
              
              // æµ‹è¯•2: è·å–ç›®æ ‡ä»“åº“ä¿¡æ¯
              const targetRepo = await github.rest.repos.get({
                owner: 'MoseLu',
                repo: 'axi-docs'
              });
              console.log('âœ… ç›®æ ‡ä»“åº“è®¿é—®æ­£å¸¸:', targetRepo.data.full_name);
              
              // æµ‹è¯•3: è·å–å·¥ä½œæµä¿¡æ¯
              const workflow = await github.rest.actions.getWorkflow({
                owner: 'MoseLu',
                repo: 'axi-deploy',
                workflow_id: 'deploy.yml'
              });
              console.log('âœ… å·¥ä½œæµè®¿é—®æ­£å¸¸:', workflow.data.name);
              
              // æµ‹è¯•4: å°è¯•è§¦å‘å·¥ä½œæµï¼ˆæ¨¡æ‹Ÿï¼‰
              console.log('ğŸ”„ å°è¯•è§¦å‘å·¥ä½œæµ...');
              const dispatch = await github.rest.actions.createWorkflowDispatch({
                owner: 'MoseLu',
                repo: 'axi-deploy',
                workflow_id: 'deploy.yml',
                ref: 'master',
                inputs: {
                  project: 'test',
                  lang: 'test',
                  artifact_id: '0',
                  deploy_path: '/test',
                  start_cmd: 'echo test',
                  caller_repo: 'MoseLu/axi-docs',
                  caller_branch: 'main',
                  caller_commit: 'test'
                }
              });
              console.log('âœ… å·¥ä½œæµè§¦å‘æˆåŠŸ:', dispatch.status);
              
            } catch (error) {
              console.error('âŒ æƒé™æµ‹è¯•å¤±è´¥:', error.message);
              console.error('é”™è¯¯çŠ¶æ€ç :', error.status);
              console.error('é”™è¯¯è¯¦æƒ…:', error);
              
              if (error.status === 403) {
                console.log('ğŸ’¡ å»ºè®®è§£å†³æ–¹æ¡ˆ:');
                console.log('1. æ£€æŸ¥axi-deployä»“åº“è®¾ç½® â†’ Actions â†’ General');
                console.log('2. ç¡®ä¿"Allow GitHub Actions to create and approve pull requests"å·²å¯ç”¨');
                console.log('3. ç¡®ä¿"Allow access to repositories in the MoseLu organization"å·²å¯ç”¨');
                console.log('4. è€ƒè™‘ä½¿ç”¨Personal Access Token');
              }
            } 