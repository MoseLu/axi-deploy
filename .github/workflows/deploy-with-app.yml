name: Deploy with GitHub App

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'é¡¹ç›®æ ‡è¯†'
        required: true
        type: string
      lang:
        description: 'é¡¹ç›®è¯­è¨€ (go|node|python|rust|java)'
        required: true
        type: string
      artifact_id:
        description: 'æž„å»ºäº§ç‰©ID'
        required: true
        type: string
      deploy_path:
        description: 'æœåŠ¡å™¨éƒ¨ç½²è·¯å¾„'
        required: true
        type: string
      start_cmd:
        description: 'å¯åŠ¨/é‡å¯å‘½ä»¤'
        required: true
        type: string
      caller_repo:
        description: 'è°ƒç”¨æ–¹ä»“åº“'
        required: true
        type: string
      caller_branch:
        description: 'è°ƒç”¨æ–¹åˆ†æ”¯'
        required: true
        type: string
      caller_commit:
        description: 'è°ƒç”¨æ–¹æäº¤'
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      id-token: write
    
    steps:
      - name: ç”Ÿæˆ GitHub App Token
        id: generate-token
        run: |
          # ç”Ÿæˆ JWT Token
          APP_ID="${{ secrets.APP_ID }}"
          PRIVATE_KEY="${{ secrets.APP_PRIVATE_KEY }}"
          
          echo "=== è°ƒè¯•ä¿¡æ¯ ==="
          echo "App ID: $APP_ID"
          echo "Private Key length: ${#PRIVATE_KEY}"
          echo "Private Key starts with: ${PRIVATE_KEY:0:50}..."
          
          # æ£€æŸ¥ç§é’¥æ˜¯å¦ä¸ºç©º
          if [ -z "$PRIVATE_KEY" ]; then
            echo "âŒ ç§é’¥ä¸ºç©ºï¼Œè¯·æ£€æŸ¥ APP_PRIVATE_KEY secret é…ç½®"
            exit 1
          fi
          
          # æ£€æŸ¥ç§é’¥æ ¼å¼
          if [[ ! "$PRIVATE_KEY" =~ "-----BEGIN" ]]; then
            echo "âŒ ç§é’¥æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”è¯¥ä»¥ -----BEGIN å¼€å¤´"
            echo "ç§é’¥å‰100ä¸ªå­—ç¬¦: ${PRIVATE_KEY:0:100}"
            exit 1
          fi
          
          # æ¸…ç†ç§é’¥ - ç§»é™¤å¯èƒ½çš„é¢å¤–å­—ç¬¦
          CLEANED_KEY=$(echo "$PRIVATE_KEY" | sed 's/\\n/\n/g' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
          
          # å°†ç§é’¥å†™å…¥ä¸´æ—¶æ–‡ä»¶
          echo "$CLEANED_KEY" > /tmp/jwt_key.pem
          chmod 600 /tmp/jwt_key.pem
          
          # éªŒè¯ç§é’¥æ–‡ä»¶
          echo "=== ç§é’¥æ–‡ä»¶éªŒè¯ ==="
          echo "Private key file content (first 5 lines):"
          head -5 /tmp/jwt_key.pem
          
          echo ""
          echo "Private key file size:"
          ls -la /tmp/jwt_key.pem
          
          # æµ‹è¯•ç§é’¥æ˜¯å¦æœ‰æ•ˆ
          echo ""
          echo "=== ç§é’¥æ ¼å¼éªŒè¯ ==="
          if ! openssl rsa -in /tmp/jwt_key.pem -check -noout 2>/dev/null; then
            echo "âŒ ç§é’¥æ ¼å¼æ— æ•ˆï¼Œè¯·æ£€æŸ¥ç§é’¥å†…å®¹"
            echo "OpenSSL é”™è¯¯ä¿¡æ¯:"
            openssl rsa -in /tmp/jwt_key.pem -check -noout 2>&1
            exit 1
          fi
          
          echo "âœ… ç§é’¥æ ¼å¼éªŒè¯é€šè¿‡"
          
          # åˆ›å»º JWT payload
          NOW=$(date +%s)
          EXPIRES=$((NOW + 600)) # 10 minutes
          
          echo ""
          echo "=== JWT ç”Ÿæˆ ==="
          echo "å½“å‰æ—¶é—´æˆ³: $NOW"
          echo "è¿‡æœŸæ—¶é—´æˆ³: $EXPIRES"
          
          # ç”Ÿæˆ JWT header - ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹æ³•
          HEADER_JSON='{"alg":"RS256","typ":"JWT"}'
          HEADER=$(echo -n "$HEADER_JSON" | base64 -w 0 | tr -d '=' | tr '/+' '_-')
          echo "JWT Header JSON: $HEADER_JSON"
          echo "JWT Header (base64): $HEADER"
          
          # ç”Ÿæˆ JWT payload - ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹æ³•
          PAYLOAD_JSON="{\"iat\":$NOW,\"exp\":$EXPIRES,\"iss\":\"$APP_ID\"}"
          PAYLOAD=$(echo -n "$PAYLOAD_JSON" | base64 -w 0 | tr -d '=' | tr '/+' '_-')
          echo "JWT Payload JSON: $PAYLOAD_JSON"
          echo "JWT Payload (base64): $PAYLOAD"
          
          # ç”Ÿæˆ JWT signature
          echo ""
          echo "=== JWT ç­¾åç”Ÿæˆ ==="
          SIGNATURE_INPUT="$HEADER.$PAYLOAD"
          echo "ç­¾åè¾“å…¥: $SIGNATURE_INPUT"
          
          SIGNATURE=$(echo -n "$SIGNATURE_INPUT" | openssl dgst -sha256 -sign /tmp/jwt_key.pem | base64 -w 0 | tr -d '=' | tr '/+' '_-')
          
          # éªŒè¯ç­¾åæ˜¯å¦ç”ŸæˆæˆåŠŸ
          if [ -z "$SIGNATURE" ]; then
            echo "âŒ JWT ç­¾åç”Ÿæˆå¤±è´¥"
            echo "è¯·æ£€æŸ¥ç§é’¥æ˜¯å¦æ­£ç¡®"
            exit 1
          fi
          
          echo "JWT Signature (base64): $SIGNATURE"
          
          # ç»„åˆ JWT
          JWT="$HEADER.$PAYLOAD.$SIGNATURE"
          echo ""
          echo "=== å®Œæ•´ JWT ==="
          echo "JWT: $JWT"
          
          # éªŒè¯ JWT æ ¼å¼
          JWT_PARTS=$(echo "$JWT" | tr '.' '\n' | wc -l)
          if [ "$JWT_PARTS" -ne 3 ]; then
            echo "âŒ JWT æ ¼å¼é”™è¯¯ï¼Œåº”è¯¥æœ‰3ä¸ªéƒ¨åˆ†ï¼Œå®žé™…æœ‰ $JWT_PARTS ä¸ªéƒ¨åˆ†"
            exit 1
          fi
          
          echo "âœ… JWT æ ¼å¼éªŒè¯é€šè¿‡"
          
          # èŽ·å– Installation Token
          INSTALLATION_ID="${{ secrets.APP_INSTALLATION_ID }}"
          echo ""
          echo "=== èŽ·å– Installation Token ==="
          echo "Installation ID: $INSTALLATION_ID"
          
          TOKEN_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $JWT" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/app/installations/$INSTALLATION_ID/access_tokens")
          
          echo "Token Response: $TOKEN_RESPONSE"
          
          ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.token')
          
          # æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆ
          if [ "$ACCESS_TOKEN" = "null" ] || [ -z "$ACCESS_TOKEN" ]; then
            echo "âŒ GitHub App Token ç”Ÿæˆå¤±è´¥"
            echo "å“åº”å†…å®¹: $TOKEN_RESPONSE"
            echo ""
            echo "=== è°ƒè¯•ä¿¡æ¯ ==="
            echo "JWT é•¿åº¦: ${#JWT}"
            echo "JWT å‰50ä¸ªå­—ç¬¦: ${JWT:0:50}..."
            echo "è¯·æ£€æŸ¥ï¼š"
            echo "1. APP_ID æ˜¯å¦æ­£ç¡®"
            echo "2. APP_PRIVATE_KEY æ ¼å¼æ˜¯å¦æ­£ç¡®"
            echo "3. APP_INSTALLATION_ID æ˜¯å¦æ­£ç¡®"
            exit 1
          fi
          
          echo "token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT
          echo "âœ… GitHub App Token ç”ŸæˆæˆåŠŸ"
          
          # æ˜¾ç¤ºä»¤ç‰Œä¿¡æ¯ï¼ˆä¸åŒ…å«å®žé™…ä»¤ç‰Œï¼‰
          TOKEN_EXPIRES=$(echo "$TOKEN_RESPONSE" | jq -r '.expires_at')
          echo "ä»¤ç‰Œè¿‡æœŸæ—¶é—´: $TOKEN_EXPIRES"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f /tmp/jwt_key.pem
      
      - name: æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
        run: |
          echo "ðŸš€ å¼€å§‹éƒ¨ç½²é¡¹ç›®"
          echo "é¡¹ç›®: ${{ github.event.inputs.project }}"
          echo "è¯­è¨€: ${{ github.event.inputs.lang }}"
          echo "è°ƒç”¨æ–¹: ${{ github.event.inputs.caller_repo }}"
          echo "åˆ†æ”¯: ${{ github.event.inputs.caller_branch }}"
          echo "æäº¤: ${{ github.event.inputs.caller_commit }}"
          echo "éƒ¨ç½²è·¯å¾„: ${{ github.event.inputs.deploy_path }}"
          echo "å¯åŠ¨å‘½ä»¤: ${{ github.event.inputs.start_cmd }}"
          echo "éƒ¨ç½²æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
      
      - name: ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: dist-${{ github.event.inputs.project }}
          github-token: ${{ steps.generate-token.outputs.token }}
          run-id: ${{ github.event.inputs.artifact_id }}
      
      - name: è®¾ç½®SSHçŽ¯å¢ƒ
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # é…ç½®SSHé€‰é¡¹
          cat > ~/.ssh/config << EOF
          Host ${{ secrets.SERVER_HOST }}
            HostName ${{ secrets.SERVER_HOST }}
            Port ${{ secrets.SERVER_PORT }}
            User ${{ secrets.SERVER_USER }}
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF
          chmod 600 ~/.ssh/config
      
      - name: æµ‹è¯•SSHè¿žæŽ¥
        run: |
          echo "ðŸ” æµ‹è¯•SSHè¿žæŽ¥..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo 'âœ… SSHè¿žæŽ¥æµ‹è¯•æˆåŠŸ'"
      
      - name: åˆ›å»ºè¿œç¨‹ç›®å½•
        run: |
          echo "ðŸ“ åˆ›å»ºè¿œç¨‹ç›®å½•: ${{ github.event.inputs.deploy_path }}"
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "mkdir -p ${{ github.event.inputs.deploy_path }}"
      
      - name: ä¼ è¾“æ–‡ä»¶
        run: |
          echo "ðŸ“¤ å¼€å§‹ä¼ è¾“æ–‡ä»¶..."
          echo "æºè·¯å¾„: ./"
          echo "ç›®æ ‡è·¯å¾„: ${{ github.event.inputs.deploy_path }}"
          
          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }}" \
            "./" \
            "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ github.event.inputs.deploy_path }}/"
          
          echo "âœ… æ–‡ä»¶ä¼ è¾“å®Œæˆ"
      
      - name: æ‰§è¡Œå¯åŠ¨å‘½ä»¤
        run: |
          echo "âš™ï¸ æ‰§è¡Œå¯åŠ¨å‘½ä»¤..."
          echo "å‘½ä»¤: ${{ github.event.inputs.start_cmd }}"
          
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e
          ${{ github.event.inputs.start_cmd }}
          EOF
          
          echo "âœ… å¯åŠ¨å‘½ä»¤æ‰§è¡Œå®Œæˆ"
      
      - name: éªŒè¯éƒ¨ç½²
        run: |
          echo "ðŸ” éªŒè¯éƒ¨ç½²ç»“æžœ..."
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "ls -la ${{ github.event.inputs.deploy_path }}"
      
      - name: éƒ¨ç½²å®Œæˆ
        run: |
          echo "ðŸŽ‰ éƒ¨ç½²å®Œæˆ!"
          echo "é¡¹ç›®: ${{ github.event.inputs.project }}"
          echo "è¯­è¨€: ${{ github.event.inputs.lang }}"
          echo "éƒ¨ç½²æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ç›®æ ‡è·¯å¾„: ${{ github.event.inputs.deploy_path }}"
      
      - name: æ¸…ç†SSHå¯†é’¥
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
          rm -f ~/.ssh/known_hosts
          echo "ðŸ§¹ SSHå¯†é’¥å·²æ¸…ç†" 