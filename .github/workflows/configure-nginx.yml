name: Configure Nginx

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
        description: "é¡¹ç›®åç§°"
      nginx_config:
        required: false
        type: string
        description: "Nginxé…ç½®"
        default: ""
      server_host:
        required: true
        type: string
        description: "æœåŠ¡å™¨åœ°å€"
      server_user:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç”¨æˆ·"
      server_key:
        required: true
        type: string
        description: "æœåŠ¡å™¨å¯†é’¥"
      server_port:
        required: true
        type: string
        description: "æœåŠ¡å™¨ç«¯å£"
      domain:
        required: false
        type: string
        description: "åŸŸå"
        default: "redamancy.com.cn"
      nginx_conf_dir:
        required: false
        type: string
        description: "Nginxé…ç½®ç›®å½•"
        default: "/www/server/nginx/conf/conf.d/redamancy"
      apps_root:
        required: false
        type: string
        description: "åº”ç”¨ç›®å½•è·¯å¾„"
        default: "/srv/apps"
      static_root:
        required: false
        type: string
        description: "é™æ€æ–‡ä»¶ç›®å½•è·¯å¾„"
        default: "/srv/static"
      backend_port:
        required: false
        type: string
        description: "åç«¯æœåŠ¡ç«¯å£"
        default: "8080"
      service_name:
        required: false
        type: string
        description: "æœåŠ¡åç§°"
        default: "star-cloud"
      deploy_type:
        required: true
        type: string
        description: "éƒ¨ç½²ç±»å‹"
    outputs:
      config_success:
        description: "é…ç½®æ˜¯å¦æˆåŠŸ"
        value: ${{ jobs.configure.outputs.config_success }}

jobs:
  configure:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # å¢åŠ è¶…æ—¶æ—¶é—´
    outputs:
      config_success: ${{ steps.set-outputs.outputs.config_success }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: éªŒè¯è¾“å…¥å‚æ•°
        run: |
          echo "ğŸ” éªŒè¯è¾“å…¥å‚æ•°..."
          echo "- é¡¹ç›®: ${{ inputs.project }}"
          echo "- æœåŠ¡å™¨: ${{ inputs.server_host }}:${{ inputs.server_port }}"
          echo "- ç”¨æˆ·: ${{ inputs.server_user }}"
          
          if [ -z "${{ inputs.nginx_config }}" ]; then
            echo "ğŸ“ æ²¡æœ‰æä¾›Nginxé…ç½®ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®"
          fi
          
          echo "âœ… è¾“å…¥å‚æ•°éªŒè¯é€šè¿‡"

      - name: ä½¿ç”¨é‡è¯•æœºåˆ¶é…ç½®Nginx
        id: configure-nginx
        run: |
          # é‡è¯•ä¸­å¿ƒæ ¸å¿ƒé€»è¾‘
          MAX_RETRIES=3
          RETRY_DELAY=10
          TIMEOUT_MINUTES=15
          STRATEGY="exponential"
          STEP_NAME="é…ç½®Nginx"
          CONTINUE_ON_ERROR=false
          NOTIFY_ON_FAILURE=true
          STEP_TYPE="network"
          
          # åˆå§‹åŒ–å˜é‡
          ATTEMPTS=0
          SUCCESS=false
          ERROR_MESSAGE=""
          START_TIME=$(date +%s)
          
          echo "ğŸš€ å¼€å§‹æ‰§è¡ŒNginxé…ç½®é‡è¯•é€»è¾‘"
          echo "æ­¥éª¤åç§°: $STEP_NAME"
          echo "æœ€å¤§é‡è¯•æ¬¡æ•°: $MAX_RETRIES"
          echo "é‡è¯•é—´éš”: $RETRY_DELAYç§’"
          echo "è¶…æ—¶æ—¶é—´: $TIMEOUT_MINUTESåˆ†é’Ÿ"
          echo "é‡è¯•ç­–ç•¥: $STRATEGY"
          echo "æ­¥éª¤ç±»å‹: $STEP_TYPE"
          
          # é‡è¯•é€»è¾‘
          while [ $ATTEMPTS -le $MAX_RETRIES ]; do
            ATTEMPTS=$((ATTEMPTS + 1))
            echo ""
            echo "ğŸ”„ ç¬¬ $ATTEMPTS æ¬¡å°è¯•é…ç½®Nginx..."
            
            # è®¾ç½®è¶…æ—¶
            TIMEOUT_CMD="timeout ${TIMEOUT_MINUTES}m"
            
            # æ‰§è¡ŒNginxé…ç½®å‘½ä»¤
            if $TIMEOUT_CMD bash -c "
              # åˆ›å»ºSSHå¯†é’¥æ–‡ä»¶
              echo '${{ inputs.server_key }}' > /tmp/ssh_key
              chmod 600 /tmp/ssh_key
              
              # åˆ›å»ºNginxé…ç½®è„šæœ¬
              cat > /tmp/nginx_config_script.sh << 'EOF'
              #!/bin/bash
              set -e
              
              echo 'ğŸ”§ é…ç½®Nginx...'
              
              NGINX_CONF_DIR='${{ inputs.nginx_conf_dir || '/www/server/nginx/conf/conf.d/redamancy' }}'
              PROJECT='${{ inputs.project }}'
            
            # éªŒè¯Nginxé…ç½®ç›®å½•æ˜¯å¦å­˜åœ¨
              if [ ! -d \"\$NGINX_CONF_DIR\" ]; then
                echo 'ğŸš¨ Nginxé…ç½®ç›®å½•ä¸å­˜åœ¨: \$NGINX_CONF_DIR'
              exit 1
            fi
            
              echo 'âœ… Nginxé…ç½®ç›®å½•å­˜åœ¨: \$NGINX_CONF_DIR'
            
            # ç”Ÿæˆé¡¹ç›®è·¯ç”±é…ç½®
              ROUTE_CONF=\"\$NGINX_CONF_DIR/route-\$PROJECT.conf\"
            
            # ä¿æŠ¤ä¸»é…ç½®æ–‡ä»¶ - ç¡®ä¿ä¸ä¼šè¢«ä¿®æ”¹
              MAIN_CONF=\"\$NGINX_CONF_DIR/00-main.conf\"
              echo 'ğŸ›¡ï¸ ä¿æŠ¤ä¸»é…ç½®æ–‡ä»¶: \$MAIN_CONF'
              if [ -f \"\$MAIN_CONF\" ]; then
                echo 'âœ… ä¸»é…ç½®æ–‡ä»¶å­˜åœ¨ï¼Œè®¾ç½®åªè¯»æƒé™ä¿æŠ¤'
                sudo chmod 444 \"\$MAIN_CONF\"
                echo 'ğŸ“‹ ä¸»é…ç½®æ–‡ä»¶æƒé™: \$(ls -la \$MAIN_CONF)'
              else
                echo 'âš ï¸ ä¸»é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: \$MAIN_CONF'
            fi
            
            # åˆ›å»ºé¡¹ç›®ä¸“ç”¨å¤‡ä»½ç›®å½•
              BACKUP_DIR=\"\$NGINX_CONF_DIR/backups\"
              PROJECT_BACKUP_DIR=\"\$BACKUP_DIR/\$PROJECT\"
              echo 'ğŸ“ åˆ›å»ºé¡¹ç›®å¤‡ä»½ç›®å½•: \$PROJECT_BACKUP_DIR'
              sudo mkdir -p \"\$PROJECT_BACKUP_DIR\"
              sudo chmod 755 \"\$PROJECT_BACKUP_DIR\"
            
            # å¤‡ä»½æ—§çš„è·¯ç”±é…ç½®æ–‡ä»¶
              if [ -f \"\$ROUTE_CONF\" ]; then
                echo 'ğŸ“‹ å¤‡ä»½æ—§è·¯ç”±é…ç½®æ–‡ä»¶: \$ROUTE_CONF'
                BACKUP_FILE=\"\$PROJECT_BACKUP_DIR/route-\$PROJECT.conf.backup.\$(date +%Y%m%d_%H%M%S)\"
                sudo cp \"\$ROUTE_CONF\" \"\$BACKUP_FILE\"
                sudo rm -f \"\$ROUTE_CONF\"
                echo 'âœ… æ—§è·¯ç”±é…ç½®æ–‡ä»¶å·²å¤‡ä»½åˆ°: \$BACKUP_FILE'
              
              # æ¸…ç†æ—§çš„å¤‡ä»½æ–‡ä»¶ï¼Œåªä¿ç•™æœ€è¿‘5ä¸ª
                echo 'ğŸ§¹ æ¸…ç†æ—§çš„å¤‡ä»½æ–‡ä»¶...'
                BACKUP_FILES=\$(ls -t \"\$PROJECT_BACKUP_DIR\"/route-\$PROJECT.conf.backup.* 2>/dev/null | tail -n +6)
                if [ -n \"\$BACKUP_FILES\" ]; then
                  echo 'ğŸ—‘ï¸ åˆ é™¤æ—§çš„å¤‡ä»½æ–‡ä»¶:'
                  echo \"\$BACKUP_FILES\" | xargs -r sudo rm -f
                  echo 'âœ… æ—§å¤‡ä»½æ–‡ä»¶å·²æ¸…ç†ï¼Œä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½'
                else
                  echo 'ğŸ“‹ æ²¡æœ‰éœ€è¦æ¸…ç†çš„æ—§å¤‡ä»½æ–‡ä»¶'
                fi
              else
                echo 'ğŸ“‹ æ²¡æœ‰æ‰¾åˆ°æ—§çš„è·¯ç”±é…ç½®æ–‡ä»¶: \$ROUTE_CONF'
            fi
            
            # ä¸å†åˆ é™¤å…¶ä»–é¡¹ç›®çš„é…ç½®æ–‡ä»¶ï¼Œæ¯ä¸ªé¡¹ç›®éƒ½åº”è¯¥æœ‰è‡ªå·±çš„é…ç½®æ–‡ä»¶
              echo 'ğŸ“‹ ä¿æŒå…¶ä»–é¡¹ç›®çš„é…ç½®æ–‡ä»¶ä¸å˜...'
              echo 'ğŸ“ å½“å‰å­˜åœ¨çš„routeé…ç½®æ–‡ä»¶:'
              ls -la \$NGINX_CONF_DIR/route-*.conf 2>/dev/null || echo 'æ²¡æœ‰æ‰¾åˆ°routeé…ç½®æ–‡ä»¶'
            
            # å¦‚æœæ²¡æœ‰æä¾›nginx_configï¼Œç”Ÿæˆé»˜è®¤é…ç½®
              if [ -z '${{ inputs.nginx_config }}' ]; then
                echo 'ğŸ“ ç”Ÿæˆé»˜è®¤Nginxé…ç½®...'
                DEPLOY_TYPE='${{ inputs.deploy_type }}'
                PROJECT='${{ inputs.project }}'
                
                if [ \"\$DEPLOY_TYPE\" = 'backend' ]; then
                # åç«¯é¡¹ç›®é…ç½®
                  CLEANED_CONFIG='
                location /docs/ {
                    proxy_pass http://localhost:8080/;
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                  }'
              else
                # é™æ€é¡¹ç›®é…ç½® - ä½¿ç”¨aliasè€Œä¸æ˜¯rootï¼Œå¹¶æ·»åŠ ç¼“å­˜æ§åˆ¶
                  CLEANED_CONFIG='
                location /docs/ {
                      alias /srv/static/\$PROJECT/;
                    index index.html;
                    try_files \$uri \$uri/ /docs/index.html;
                    
                    # ç¡®ä¿ä¸ç¼“å­˜HTMLæ–‡ä»¶
                    add_header Cache-Control \"no-cache, no-store, must-revalidate\" always;
                    add_header Pragma \"no-cache\" always;
                    add_header Expires \"0\" always;
                }
                
                  # é™æ€èµ„æºç¼“å­˜
                  location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                      alias /srv/static/\$PROJECT/;
                      expires 1y;
                      add_header Cache-Control \"public, immutable\";
                  }'
                fi
              else
                echo 'ğŸ“ ä½¿ç”¨æä¾›çš„Nginxé…ç½®...'
                CLEANED_CONFIG='${{ inputs.nginx_config }}'
              fi
              
              # ç”Ÿæˆè·¯ç”±é…ç½®æ–‡ä»¶
              echo 'ğŸ“ ç”Ÿæˆè·¯ç”±é…ç½®æ–‡ä»¶: \$ROUTE_CONF'
              sudo tee \"\$ROUTE_CONF\" > /dev/null << 'CONFIG_EOF'
              # é¡¹ç›®: \$PROJECT
              # ç”Ÿæˆæ—¶é—´: \$(date)
              # éƒ¨ç½²ç±»å‹: \$DEPLOY_TYPE
              
              \$CLEANED_CONFIG
              CONFIG_EOF
              
              echo 'âœ… è·¯ç”±é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ'
              echo 'ğŸ“‹ é…ç½®æ–‡ä»¶å†…å®¹:'
              cat \"\$ROUTE_CONF\"
              
              # éªŒè¯Nginxé…ç½®è¯­æ³•
              echo 'ğŸ” éªŒè¯Nginxé…ç½®è¯­æ³•...'
              if sudo nginx -t; then
                echo 'âœ… Nginxé…ç½®è¯­æ³•æ­£ç¡®'
              else
                echo 'âŒ Nginxé…ç½®è¯­æ³•é”™è¯¯'
                echo 'é…ç½®é”™è¯¯è¯¦æƒ…:'
                sudo nginx -t 2>&1
                exit 1
              fi
              
              # é‡è½½Nginxé…ç½®
              echo 'ğŸ”„ é‡è½½Nginxé…ç½®...'
              if sudo systemctl reload nginx; then
                echo 'âœ… Nginxé…ç½®é‡è½½æˆåŠŸ'
              else
                echo 'âŒ Nginxé‡è½½å¤±è´¥ï¼Œå°è¯•é‡å¯...'
                if sudo systemctl restart nginx; then
                  echo 'âœ… Nginxé‡å¯æˆåŠŸ'
                else
                  echo 'âŒ Nginxé‡å¯å¤±è´¥'
                  exit 1
                fi
              fi
              
              echo 'âœ… Nginxé…ç½®å®Œæˆï¼'
              EOF
              
              # ä½¿ç”¨SSHæ‰§è¡Œé…ç½®è„šæœ¬
              ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -i /tmp/ssh_key -p ${{ inputs.server_port }} ${{ inputs.server_user }}@${{ inputs.server_host }} 'bash -s' < /tmp/nginx_config_script.sh
            "; then
              SUCCESS=true
              echo "âœ… Nginxé…ç½®æˆåŠŸï¼"
              break
            else
              EXIT_CODE=$?
              if [ $EXIT_CODE -eq 124 ]; then
                ERROR_MESSAGE="Nginxé…ç½®è¶…æ—¶ï¼ˆ${TIMEOUT_MINUTES}åˆ†é’Ÿï¼‰"
              else
                ERROR_MESSAGE="Nginxé…ç½®å¤±è´¥ï¼Œé€€å‡ºç : $EXIT_CODE"
              fi
              
              echo "âŒ Nginxé…ç½®å¤±è´¥: $ERROR_MESSAGE"
              
              # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é‡è¯•æœºä¼š
              if [ $ATTEMPTS -le $MAX_RETRIES ]; then
                # è®¡ç®—é‡è¯•å»¶è¿Ÿ
                if [ "$STRATEGY" = "exponential" ]; then
                  DELAY=$((RETRY_DELAY * (2 ** (ATTEMPTS - 1))))
                elif [ "$STRATEGY" = "adaptive" ]; then
                  DELAY=$((RETRY_DELAY + ATTEMPTS * 2))
                else
                  DELAY=$RETRY_DELAY
                fi
                
                echo "â³ ç­‰å¾… $DELAY ç§’åé‡è¯•..."
                sleep $DELAY
              fi
            fi
          done
          
          # è®¡ç®—æ‰§è¡Œæ—¶é—´
          END_TIME=$(date +%s)
          EXECUTION_TIME=$((END_TIME - START_TIME))
          
          # è®¾ç½®è¾“å‡º
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "attempts=$ATTEMPTS" >> $GITHUB_OUTPUT
          echo "execution_time=$EXECUTION_TIME" >> $GITHUB_OUTPUT
          echo "error_message=$ERROR_MESSAGE" >> $GITHUB_OUTPUT
          
          # æœ€ç»ˆç»“æœ
          if [ "$SUCCESS" = "true" ]; then
            echo "ğŸ‰ Nginxé…ç½®é‡è¯•é€»è¾‘æ‰§è¡Œå®Œæˆ - æˆåŠŸ"
          else
            echo "ğŸ’¥ Nginxé…ç½®é‡è¯•é€»è¾‘æ‰§è¡Œå®Œæˆ - å¤±è´¥"
            if [ "$CONTINUE_ON_ERROR" = "false" ]; then
              exit 1
            fi
          fi

      - name: è®¾ç½®è¾“å‡º
        id: set-outputs
        run: |
          echo "config_success=true" >> $GITHUB_OUTPUT
          echo "âœ… Nginxé…ç½®å®Œæˆ"
